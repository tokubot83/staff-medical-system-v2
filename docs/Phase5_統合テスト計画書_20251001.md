# Phase 5-3 統合テスト計画書

**作成日**: 2025年10月1日
**作成者**: 医療職員管理システム開発チーム
**対象**: VoiceDriveシステム連携テスト
**テスト期間**: 2025年10月3日～10月4日

---

## 📋 目次

1. [テスト概要](#1-テスト概要)
2. [テスト環境](#2-テスト環境)
3. [事前準備](#3-事前準備)
4. [テストケース](#4-テストケース)
5. [テスト実施手順](#5-テスト実施手順)
6. [エラーハンドリングテスト](#6-エラーハンドリングテスト)
7. [パフォーマンステスト](#7-パフォーマンステスト)
8. [テスト結果記録](#8-テスト結果記録)

---

## 1. テスト概要

### 1.1 テストの目的

Phase 5-3「キャリア選択ステーション」の医療システムとVoiceDriveの統合動作を検証する。

### 1.2 テストスコープ

**対象機能**:
- API連携（4エンドポイント）
- Webhook通知システム
- エンドツーエンドフロー
- エラーハンドリング
- リアルタイム更新

**対象外**:
- 本番データベース接続
- 本番認証システム
- パフォーマンス負荷テスト（100ユーザー以上）

### 1.3 成功基準

- ✅ 全APIエンドポイントが正常に応答
- ✅ Webhook通知が正しく配信される
- ✅ エンドツーエンドフローが完了する
- ✅ エラーが適切にハンドリングされる
- ✅ リアルタイム更新が動作する

---

## 2. テスト環境

### 2.1 医療システム側

| 項目 | 値 |
|------|---|
| 環境 | 開発環境 |
| URL | http://localhost:3000 |
| Node.js | v18.x以上 |
| フレームワーク | Next.js 14 |
| API | REST API（モックデータ） |

**環境変数**:
```env
VOICEDRIVE_WEBHOOK_URL=http://localhost:3001/api/career-course/notify
VOICEDRIVE_API_KEY=ms_prod_key_X1Y2Z3A4B5C6D7E8F9G0H1I2J3K4L5M6
INTERNAL_API_KEY=internal-secret-key-change-in-production
```

### 2.2 VoiceDrive側

| 項目 | 値 |
|------|---|
| 環境 | 開発環境 |
| URL | http://localhost:3001 |
| Node.js | v18.x以上 |
| フレームワーク | Vite + React |
| API | REST API |

**環境変数**:
```env
NEXT_PUBLIC_MEDICAL_SYSTEM_API=http://localhost:3000
MEDICAL_SYSTEM_API_KEY=vd_prod_key_A8B9C2D3E4F5G6H7I8J9K0L1M2N3O4P5
```

---

## 3. 事前準備

### 3.1 医療システム側チェックリスト

- [ ] 開発サーバーが起動している（`npm run dev`）
- [ ] `.env.local` に環境変数が設定されている
- [ ] 以下のAPIエンドポイントが動作している:
  - [ ] `GET /api/my-page`
  - [ ] `GET /api/career-courses/definitions`
  - [ ] `POST /api/career-course/change-request`
  - [ ] `GET /api/career-course/my-requests`
- [ ] Webhook通知エンドポイントが動作している:
  - [ ] `POST /api/career-course/notify-voicedrive`

### 3.2 VoiceDrive側チェックリスト

- [ ] 開発サーバーが起動している（`npm run dev`）
- [ ] `.env` に環境変数が設定されている
- [ ] 以下の画面が表示される:
  - [ ] `/career-selection-station`
  - [ ] `/career-selection-station/change-request`
  - [ ] `/career-selection-station/my-requests`
- [ ] WebhookTestPanelが表示される（開発環境のみ）

### 3.3 ネットワーク確認

```bash
# 医療システム側からVoiceDriveへの接続確認
curl http://localhost:3001/

# VoiceDrive側から医療システムへの接続確認
curl http://localhost:3000/api/my-page
```

---

## 4. テストケース

### 4.1 API接続テスト

#### TC-API-01: マイページデータ取得

**目的**: 職員の基本情報とキャリアコース情報を取得できることを確認

**手順**:
1. VoiceDrive側で `/career-selection-station` を開く
2. マイページデータが表示されることを確認

**期待結果**:
- ✅ 職員名、施設、部署、役職が表示される
- ✅ 現在のキャリアコース情報が表示される
- ✅ 次回変更可能日が表示される

**APIコール**:
```
GET http://localhost:3000/api/my-page
Authorization: Bearer <token>
```

**レスポンス検証**:
- ステータスコード: 200
- `careerCourse.courseCode`: "B"
- `careerCourse.nextChangeAvailableDate`: "2026-03-01"

---

#### TC-API-02: コース定義一覧取得

**目的**: A～Dコースの定義情報を取得できることを確認

**手順**:
1. VoiceDrive側で `/career-selection-station/change-request` を開く
2. コース選択カードが4つ表示されることを確認

**期待結果**:
- ✅ Aコース（全面協力型）が表示される
- ✅ Bコース（施設内協力型）が表示される
- ✅ Cコース（専門職型）が表示される
- ✅ Dコース（時短・制約あり型）が表示される

**APIコール**:
```
GET http://localhost:3000/api/career-courses/definitions
Authorization: Bearer <token>
```

**レスポンス検証**:
- ステータスコード: 200
- 配列要素数: 4
- 各コースに `baseSalaryMultiplier` が含まれる

---

#### TC-API-03: コース変更申請送信

**目的**: 申請データを送信し、正常に受理されることを確認

**手順**:
1. VoiceDrive側で `/career-selection-station/change-request` を開く
2. 希望コース「A」を選択
3. 変更理由「年1回定期変更」を選択
4. 理由詳細を入力
5. 希望適用日を選択
6. 「申請を送信」をクリック

**期待結果**:
- ✅ 確認モーダルが表示される
- ✅ 送信成功メッセージが表示される
- ✅ 申請IDが返却される

**APIコール**:
```
POST http://localhost:3000/api/career-course/change-request
Authorization: Bearer <token>
Content-Type: application/json

{
  "currentCourseCode": "B",
  "requestedCourseCode": "A",
  "changeReason": "annual",
  "reasonDetail": "管理職候補として...",
  "requestedEffectiveDate": "2026-04-01",
  "attachments": []
}
```

**レスポンス検証**:
- ステータスコード: 201
- `id`: 申請ID
- `approvalStatus`: "pending"
- `message`: "申請を受け付けました..."

---

#### TC-API-04: 申請履歴取得

**目的**: 過去の申請履歴を取得できることを確認

**手順**:
1. VoiceDrive側で `/career-selection-station/my-requests` を開く
2. 申請履歴一覧が表示されることを確認

**期待結果**:
- ✅ 申請履歴が最新順で表示される
- ✅ ステータスバッジが正しい色で表示される
- ✅ 詳細モーダルが開ける

**APIコール**:
```
GET http://localhost:3000/api/career-course/my-requests
Authorization: Bearer <token>
```

**レスポンス検証**:
- ステータスコード: 200
- 配列要素数: 3以上
- 最初の要素の `createdAt` が最新

---

### 4.2 Webhook通知テスト

#### TC-WEBHOOK-01: 承認通知受信

**目的**: 医療システムからの承認通知を正しく受信できることを確認

**手順**:
1. VoiceDrive側で `/career-selection-station` を開く
2. WebhookTestPanelで「承認通知」を選択
3. staffId: "OH-NS-2021-001"
4. approvedCourse: "A"
5. effectiveDate: "2026-04-01"
6. reviewComment: "管理職候補として適性を認めます。"
7. 「承認通知を送信」をクリック

**期待結果**:
- ✅ ブラウザ通知が表示される
- ✅ サウンドが再生される
- ✅ 通知センターに追加される
- ✅ `/my-requests` を開くと新しい承認が反映されている

**Webhookペイロード**:
```json
{
  "type": "course_change_approved",
  "staffId": "OH-NS-2021-001",
  "requestId": "req-003",
  "approvedCourse": "A",
  "effectiveDate": "2026-04-01",
  "reviewComment": "管理職候補として適性を認めます。"
}
```

---

#### TC-WEBHOOK-02: 却下通知受信

**目的**: 医療システムからの却下通知を正しく受信できることを確認

**手順**:
1. VoiceDrive側で `/career-selection-station` を開く
2. WebhookTestPanelで「却下通知」を選択
3. staffId: "OH-NS-2021-001"
4. rejectionReason: "現在の勤務状況から、来年度の変更が望ましいと判断しました。"
5. reviewComment: "再度、2027年4月での変更申請をご検討ください。"
6. 「却下通知を送信」をクリック

**期待結果**:
- ✅ ブラウザ通知が表示される
- ✅ サウンドが再生される
- ✅ 通知センターに追加される
- ✅ `/my-requests` を開くと却下理由が表示されている

**Webhookペイロード**:
```json
{
  "type": "course_change_rejected",
  "staffId": "OH-NS-2021-001",
  "requestId": "req-003",
  "rejectionReason": "現在の勤務状況から、来年度の変更が望ましいと判断しました。",
  "reviewComment": "再度、2027年4月での変更申請をご検討ください。"
}
```

---

### 4.3 エンドツーエンドテスト

#### TC-E2E-01: 承認フロー（全体）

**目的**: 申請から承認までの一連の流れが正常に動作することを確認

**手順**:
1. VoiceDrive: `/career-selection-station/change-request` でコース変更申請
2. 医療システム: 申請が `/admin/career-courses` の「変更申請審査」タブに表示されることを確認（※UI未実装のため手動確認）
3. VoiceDrive: WebhookTestPanelで承認通知を送信
4. VoiceDrive: `/career-selection-station/my-requests` で承認が反映されることを確認

**期待結果**:
- ✅ 申請が正常に送信される
- ✅ 承認通知が正しく配信される
- ✅ 申請状況が更新される

---

#### TC-E2E-02: 却下フロー（全体）

**目的**: 申請が却下された場合の流れが正常に動作することを確認

**手順**:
1. VoiceDrive: `/career-selection-station/change-request` でコース変更申請
2. VoiceDrive: WebhookTestPanelで却下通知を送信
3. VoiceDrive: `/career-selection-station/my-requests` で却下理由が表示されることを確認

**期待結果**:
- ✅ 申請が正常に送信される
- ✅ 却下通知が正しく配信される
- ✅ 却下理由が表示される

---

#### TC-E2E-03: 特例変更フロー

**目的**: 特例変更（妊娠・出産）の申請が正常に処理されることを確認

**手順**:
1. VoiceDrive: `/career-selection-station/change-request` を開く
2. 希望コース「D」を選択
3. 変更理由「特例変更（妊娠・出産）」を選択
4. 理由詳細を入力
5. 添付ファイルをアップロード（必須）
6. 「申請を送信」をクリック

**期待結果**:
- ✅ 添付ファイルが必須チェックされる
- ✅ ファイルなしで送信しようとするとエラーが表示される
- ✅ ファイルありで送信すると成功する

---

### 4.4 リアルタイム更新テスト

#### TC-REALTIME-01: 申請状況確認画面の自動更新

**目的**: Webhook通知受信時に申請状況確認画面が自動更新されることを確認

**手順**:
1. VoiceDrive: `/career-selection-station/my-requests` を開く
2. 別タブで `/career-selection-station` を開く
3. WebhookTestPanelで承認通知を送信
4. `/my-requests` タブに戻る

**期待結果**:
- ✅ ページをリロードせずに申請状況が更新される
- ✅ 新しい承認が一覧に表示される

---

## 5. テスト実施手順

### 5.1 準備（5分）

**医療システム側**:
```bash
cd C:\projects\staff-medical-system
npm run dev
```

**VoiceDrive側**:
```bash
cd C:\projects\voicedrive
npm run dev
```

### 5.2 APIテスト（15分）

1. TC-API-01～04を順番に実行
2. 各テストの結果を記録

### 5.3 Webhookテスト（10分）

1. TC-WEBHOOK-01～02を順番に実行
2. ブラウザ通知、サウンド、通知センターを確認

### 5.4 エンドツーエンドテスト（15分）

1. TC-E2E-01～03を順番に実行
2. 全体の流れが正常に動作することを確認

### 5.5 リアルタイム更新テスト（5分）

1. TC-REALTIME-01を実行
2. 自動更新が動作することを確認

---

## 6. エラーハンドリングテスト

### 6.1 認証エラーテスト

**TC-ERROR-01: 無効なトークン**

**手順**:
1. VoiceDrive側で無効なトークンを設定
2. `/career-selection-station` を開く

**期待結果**:
- ❌ 401 Unauthorized
- ✅ エラーメッセージが表示される

---

### 6.2 バリデーションエラーテスト

**TC-ERROR-02: 必須項目未入力**

**手順**:
1. VoiceDrive: `/career-selection-station/change-request` を開く
2. 希望コースを選択せずに「申請を送信」をクリック

**期待結果**:
- ✅ バリデーションエラーが表示される
- ✅ 送信されない

---

**TC-ERROR-03: 特例変更で添付ファイルなし**

**手順**:
1. VoiceDrive: `/career-selection-station/change-request` を開く
2. 変更理由「特例変更（妊娠・出産）」を選択
3. 添付ファイルをアップロードせずに「申請を送信」をクリック

**期待結果**:
- ✅ エラーメッセージ「特例変更の場合は証明書類の添付が必要です」が表示される
- ✅ 送信されない

---

### 6.3 ネットワークエラーテスト

**TC-ERROR-04: APIサーバーが停止**

**手順**:
1. 医療システムの開発サーバーを停止
2. VoiceDrive: `/career-selection-station` を開く

**期待結果**:
- ✅ ネットワークエラーが表示される
- ✅ リトライボタンが表示される（将来実装）

---

## 7. パフォーマンステスト

### 7.1 レスポンス時間測定

| API | 目標 | 測定値 |
|-----|------|--------|
| GET /api/my-page | < 200ms | - |
| GET /api/career-courses/definitions | < 200ms | - |
| POST /api/career-course/change-request | < 500ms | - |
| GET /api/career-course/my-requests | < 300ms | - |

### 7.2 Webhook通知遅延測定

| 項目 | 目標 | 測定値 |
|------|------|--------|
| 通知送信から受信までの時間 | < 1秒 | - |
| ブラウザ通知表示までの時間 | < 2秒 | - |
| 画面自動更新までの時間 | < 3秒 | - |

---

## 8. テスト結果記録

### 8.1 テスト実施記録

| テストID | テスト名 | 実施日時 | 結果 | 備考 |
|----------|---------|---------|------|------|
| TC-API-01 | マイページデータ取得 | - | - | - |
| TC-API-02 | コース定義一覧取得 | - | - | - |
| TC-API-03 | コース変更申請送信 | - | - | - |
| TC-API-04 | 申請履歴取得 | - | - | - |
| TC-WEBHOOK-01 | 承認通知受信 | - | - | - |
| TC-WEBHOOK-02 | 却下通知受信 | - | - | - |
| TC-E2E-01 | 承認フロー | - | - | - |
| TC-E2E-02 | 却下フロー | - | - | - |
| TC-E2E-03 | 特例変更フロー | - | - | - |
| TC-REALTIME-01 | 自動更新 | - | - | - |
| TC-ERROR-01 | 認証エラー | - | - | - |
| TC-ERROR-02 | 必須項目未入力 | - | - | - |
| TC-ERROR-03 | 添付ファイルなし | - | - | - |
| TC-ERROR-04 | ネットワークエラー | - | - | - |

### 8.2 不具合記録

| No | 発見日 | テストID | 不具合内容 | 重要度 | 対応状況 |
|----|--------|----------|-----------|--------|---------|
| 1 | - | - | - | - | - |

### 8.3 テスト完了条件

- [ ] 全テストケースが実行完了
- [ ] 重要度「高」の不具合が0件
- [ ] 重要度「中」の不具合が2件以下
- [ ] レスポンス時間が目標を達成
- [ ] 両チームがテスト結果を承認

---

## 9. 次のステップ

### 9.1 統合テスト後

- [ ] 不具合修正
- [ ] 再テスト
- [ ] テスト完了報告書作成

### 9.2 共通DB構築後

- [ ] 本番データでのテスト
- [ ] 認証システム統合テスト
- [ ] パフォーマンス負荷テスト
- [ ] セキュリティテスト

---

## 10. 連絡先

**医療システムチーム**:
- Slack: #phase5-medical-system
- Email: medical-system-dev@example.com

**VoiceDriveチーム**:
- Slack: #phase5-voicedrive
- Email: voicedrive-dev@example.com

**統合テスト担当**:
- 医療システム側: Claude Code
- VoiceDrive側: Claude Code

---

*本テスト計画書は2025年10月1日に作成されました。*
