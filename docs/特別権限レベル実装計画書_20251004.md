# 特別権限レベル（97-99）実装計画書

**作成日**: 2025年10月4日
**作成者**: 医療システムチーム
**対象**: 健診担当者・産業医・システム管理者の特別権限実装
**優先度**: 🔴 高（法令遵守・個人情報保護のため）

---

## 📋 エグゼクティブサマリー

健康管理ページ（ストレスチェック含む）のアクセス制御を強化し、特別権限レベル（97-99）を新設します。法令遵守（労安法66条の10）と実務の利便性を両立させます。

**新設する権限レベル**:
- **Level 97**: 健診担当者（ストレスチェック実施者）
- **Level 98**: 産業医
- **Level 99**: システム管理者（既存、権限整理）

**最終的な権限レベル構成**:
- 基本18レベル（1-18）
- 看護職専用4レベル（1.5-4.5）
- **特別権限3レベル（97-99）← 新設**
- **合計25種類**

---

## 🎯 実装の目的

### 1. 法令遵守

**労働安全衛生法 第66条の10**:
> 事業者は、本人の同意を得ないで当該労働者の検査の結果を取得してはならない。

**実装で対応**:
- ✅ ストレスチェック結果は産業医・実施者のみアクセス可能
- ✅ 本人同意がある場合のみ人事部が閲覧可能
- ✅ 全アクセスを監査ログに記録

### 2. 個人情報保護

- 健診データと人事データの完全分離
- 産業医の独立性確保
- 最小権限の原則（必要最小限の情報のみアクセス可能）

### 3. 実務の利便性

- 本人同意取得フローの実装
- 人事部による配慮措置の検討を可能に
- 既製品と同等のワークフロー

---

## 📊 実装範囲

### Phase 1: 基盤実装（必須）

| Phase | 作業内容 | 所要時間 | 担当 | ブランチ | 確認者 |
|-------|---------|---------|------|---------|--------|
| **1-1** | アカウントレベル定義の拡張（97-99追加） | 30分 | Claude Code | preview | ユーザー |
| **1-2** | アクセス制御設定の更新 | 30分 | Claude Code | preview | ユーザー |
| **1-3** | 動的アクセス制御ロジックの実装 | 1時間 | Claude Code | preview | ユーザー |
| **1-4** | 本人同意取得UIの実装 | 1.5時間 | Claude Code | preview | ユーザー |
| **1-5** | 人事部向け表示制御の実装 | 1時間 | Claude Code | preview | ユーザー |

**Phase 1合計**: 約4.5時間

### Phase 2: 監査・運用強化（高優先度）

| Phase | 作業内容 | 所要時間 | 担当 | ブランチ | 確認者 |
|-------|---------|---------|------|---------|--------|
| **2-1** | 監査ログ強化の実装 | 1時間 | Claude Code | preview | ユーザー |
| **2-2** | 同意状況ダッシュボードの実装 | 1.5時間 | Claude Code | preview | ユーザー |
| **2-3** | VoiceDrive通知フローの実装 | 1時間 | Claude Code | preview | ユーザー |

**Phase 2合計**: 約3.5時間

### ドキュメント更新

| 作業 | 所要時間 | 担当 | 状態 |
|------|---------|------|------|
| VoiceDrive依頼書の更新 | 30分 | Claude Code | 📋 待機中 |
| 統合テスト計画書作成 | 30分 | Claude Code | 📋 待機中 |

**総所要時間**: 約9時間

---

## 🔧 Phase 1: 基盤実装（詳細）

### Phase 1-1: アカウントレベル定義の拡張

**作業内容**:
1. `accountLevelCalculator.ts`に97-99レベルを追加
2. `positionSeeds.ts`に特別権限役職を追加

**実装ファイル**:
```typescript
// src/services/accountLevelCalculator.ts
export enum AccountLevel {
  // 基本18レベル（既存）
  NEW_STAFF = 1,
  // ... 省略
  BOARD_MEMBER = 18,

  // 看護職専用+0.5レベル（既存）
  NEW_STAFF_LEADER = 1.5,
  // ... 省略
  VETERAN_STAFF_LEADER = 4.5,

  // 🆕 特別権限レベル（新設）
  HEALTH_CHECKUP_STAFF = 97,    // 健診担当者
  OCCUPATIONAL_PHYSICIAN = 98,   // 産業医
  SYSTEM_ADMIN = 99              // システム管理者
}
```

**役職マスター追加**:
```typescript
// src/data/seeds/positionSeeds.ts に追加
{
  id: 'POS_024',
  code: 'HEALTH_CHECKUP_STAFF',
  name: '健診担当者',
  level: 97,
  category: 'medical',
  requiresManagementTraining: false,
  canApproveLeave: false,
  canPerformEvaluation: false,
  displayOrder: 24,
  isActive: true,
},
{
  id: 'POS_025',
  code: 'OCCUPATIONAL_PHYSICIAN',
  name: '産業医',
  level: 98,
  category: 'medical',
  requiresManagementTraining: false,
  canApproveLeave: false,
  canPerformEvaluation: false,
  displayOrder: 25,
  isActive: true,
},
```

**Git操作**:
```bash
# preview/feature-nameブランチで作業
git add src/services/accountLevelCalculator.ts
git add src/data/seeds/positionSeeds.ts
git commit -m "feat: 特別権限レベル97-99を追加（健診担当者・産業医・システム管理者）"
git push origin preview/feature-name
```

**確認事項**:
- [ ] Level 97, 98, 99が正しく定義されているか
- [ ] 役職マスターに追加されているか
- [ ] TypeScriptのビルドエラーがないか

---

### Phase 1-2: アクセス制御設定の更新

**作業内容**:
1. `accessControl.ts`に特別権限設定を追加
2. 健康管理ページへのアクセス権限を定義

**実装ファイル**:
```typescript
// src/config/accessControl.ts に追加

// 特別権限レベルの定義
export const SPECIAL_HEALTH_PERMISSIONS = {
  // Level 97: 健診担当者
  HEALTH_CHECKUP_STAFF: {
    level: 97,
    allowedPaths: [
      '/health/management',          // 健診管理画面
      '/health/staff/:staffId',      // 個別健診データ
      '/stress-check',               // ストレスチェック
      '/health/reexamination',       // 再検査管理
      '/health/reports',             // 健診レポート
    ],
    allowedDataAccess: [
      'healthCheckup',
      'stressCheck',
      'reexamination',
      'basicStaffInfo',  // 氏名・部署のみ
    ],
    deniedDataAccess: [
      'salary',
      'evaluation',
      'interview',
      'disciplinary',
      'masterData',
    ]
  },

  // Level 98: 産業医
  OCCUPATIONAL_PHYSICIAN: {
    level: 98,
    allowedPaths: [
      '/health/management',
      '/health/staff/:staffId',
      '/stress-check',
      '/health/occupational-consultation',  // 産業医面談
      '/health/medical-opinions',           // 医学的意見書
      '/health/work-restrictions',          // 就業制限管理
    ],
    allowedDataAccess: [
      'healthCheckup',
      'stressCheck',
      'occupationalConsultation',
      'workRestrictions',
      'basicStaffInfo',
      'workHistory',      // 健康評価用
      'absenceRecords',   // 健康評価用
    ],
    deniedDataAccess: [
      'salary',
      'evaluation',
      'interview',  // 産業医面談除く
      'disciplinary',
      'masterData',
    ]
  },

  // Level 99: システム管理者
  SYSTEM_ADMIN: {
    level: 99,
    allowedPaths: ['*'],  // 全て許可
    allowedDataAccess: ['*'],
    deniedDataAccess: []
  }
};

// 特別権限チェック関数
export function hasSpecialHealthPermission(
  userLevel: number,
  dataType: string
): boolean {
  if (userLevel === 99) return true;

  if (userLevel === 98) {
    return SPECIAL_HEALTH_PERMISSIONS.OCCUPATIONAL_PHYSICIAN.allowedDataAccess.includes(dataType);
  }

  if (userLevel === 97) {
    return SPECIAL_HEALTH_PERMISSIONS.HEALTH_CHECKUP_STAFF.allowedDataAccess.includes(dataType);
  }

  return false;
}
```

**Git操作**:
```bash
git add src/config/accessControl.ts
git commit -m "feat: 特別権限レベル（97-99）のアクセス制御設定を追加"
git push origin preview/feature-name
```

**確認事項**:
- [ ] 特別権限設定が正しく定義されているか
- [ ] アクセス可能/不可なデータが適切に設定されているか

---

### Phase 1-3: 動的アクセス制御ロジックの実装

**作業内容**:
1. ストレスチェック結果への動的アクセス制御を実装
2. 本人同意状態に基づくアクセス判定

**新規作成ファイル**:
```typescript
// src/lib/stress-check/access-control.ts（新規作成）

export interface StressCheckAccessControl {
  canView: boolean;
  canViewDetails: boolean;
  canEdit: boolean;
  reason: string;
}

/**
 * ストレスチェック結果へのアクセス権限判定
 */
export function checkStressCheckAccess(
  userLevel: number,
  stressCheckResult: {
    staffId: string;
    consentToShare: boolean;
    consentDate: Date | null;
    isHighStress: boolean;
  },
  currentUserId: string
): StressCheckAccessControl {

  // ケース1: 本人自身
  if (stressCheckResult.staffId === currentUserId) {
    return {
      canView: true,
      canViewDetails: true,
      canEdit: false,
      reason: '本人の結果'
    };
  }

  // ケース2: Level 99（システム管理者）
  if (userLevel === 99) {
    return {
      canView: true,
      canViewDetails: true,
      canEdit: true,
      reason: 'システム管理者権限（監査ログ記録）'
    };
  }

  // ケース3: Level 98（産業医）
  if (userLevel === 98) {
    return {
      canView: true,
      canViewDetails: true,  // 常に閲覧可能
      canEdit: true,         // 医学的所見を追記可能
      reason: '産業医権限（労安法66条の10第2項）'
    };
  }

  // ケース4: Level 97（健診担当者）
  if (userLevel === 97) {
    return {
      canView: true,
      canViewDetails: stressCheckResult.consentToShare,
      canEdit: stressCheckResult.consentToShare,
      reason: stressCheckResult.consentToShare
        ? '健診担当者権限（本人同意あり）'
        : '集団分析のみ可能'
    };
  }

  // ケース5: Level 14-17（人事部）
  if (userLevel >= 14 && userLevel <= 17) {
    if (stressCheckResult.consentToShare) {
      return {
        canView: true,
        canViewDetails: true,
        canEdit: false,
        reason: '人事部権限（本人同意あり・配慮義務のため）'
      };
    } else {
      return {
        canView: stressCheckResult.isHighStress,
        canViewDetails: false,
        canEdit: false,
        reason: '本人同意なし（高ストレス者の存在のみ把握可能）'
      };
    }
  }

  // ケース6: その他のレベル
  return {
    canView: false,
    canViewDetails: false,
    canEdit: false,
    reason: 'アクセス権限なし'
  };
}

/**
 * 人事部向けのストレスチェック結果表示情報を取得
 */
export function getHRViewStressCheckInfo(
  stressCheckResult: any,
  userLevel: number,
  currentUserId: string
) {
  const access = checkStressCheckAccess(userLevel, stressCheckResult, currentUserId);

  return {
    staffId: stressCheckResult.staffId,
    staffName: access.canView ? stressCheckResult.staff?.name : '非公開',
    department: access.canView ? stressCheckResult.departmentAtTime : '非公開',
    stressLevel: access.canViewDetails ? stressCheckResult.stressLevel : null,
    isHighStress: access.canView ? stressCheckResult.isHighStress : null,
    consentStatus: stressCheckResult.consentToShare,
    consentDate: stressCheckResult.consentDate,
    canViewDetails: access.canViewDetails,
    accessReason: access.reason
  };
}
```

**Git操作**:
```bash
git add src/lib/stress-check/access-control.ts
git commit -m "feat: ストレスチェック結果への動的アクセス制御ロジックを実装"
git push origin preview/feature-name
```

**確認事項**:
- [ ] 全てのケース（本人・産業医・健診担当者・人事部・その他）が実装されているか
- [ ] 本人同意状態に基づく判定が正しく動作するか
- [ ] TypeScriptの型定義が正しいか

---

### Phase 1-4: 本人同意取得UIの実装

**作業内容**:
1. 本人同意取得モーダルコンポーネント作成
2. 同意APIエンドポイント実装

**新規作成ファイル**:
```typescript
// src/components/stress-check/ConsentFlow.tsx（新規作成）

'use client';

import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { AlertCircle, CheckCircle, X } from 'lucide-react';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';

interface ConsentFlowProps {
  stressCheckResultId: string;
  staffId: string;
  currentUserId: string;
  consentStatus: {
    consentToShare: boolean;
    consentDate: Date | null;
  };
  onConsentUpdate?: () => void;
}

export function ConsentFlow({
  stressCheckResultId,
  staffId,
  currentUserId,
  consentStatus,
  onConsentUpdate
}: ConsentFlowProps) {
  const [showConsentModal, setShowConsentModal] = useState(false);
  const [loading, setLoading] = useState(false);

  const canGiveConsent = staffId === currentUserId;

  const handleConsentSubmit = async (consent: boolean) => {
    setLoading(true);

    try {
      const response = await fetch('/api/stress-check/consent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          resultId: stressCheckResultId,
          consentToShare: consent,
          consentDate: new Date().toISOString()
        })
      });

      if (response.ok) {
        setShowConsentModal(false);

        // 同意した場合は人事部へ通知
        if (consent) {
          await fetch('/api/notifications/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'STRESS_CHECK_CONSENT_GIVEN',
              staffId: staffId,
              message: `ストレスチェック結果の共有に同意がありました`,
              targetLevel: 14  // 人事部門員以上
            })
          });
        }

        onConsentUpdate?.();
      }
    } catch (error) {
      console.error('同意処理エラー:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Card className="mb-6">
      <CardHeader>
        <CardTitle className="text-lg">結果の共有について</CardTitle>
      </CardHeader>
      <CardContent>
        {canGiveConsent ? (
          <>
            <Alert className="mb-4">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>
                ストレスチェックの結果を人事部門と共有することで、
                適切な職場環境改善や配慮措置を受けやすくなります。
                <br />
                <strong>共有は任意であり、不利益な取り扱いは一切ありません。</strong>
              </AlertDescription>
            </Alert>

            {!consentStatus.consentToShare ? (
              <div className="space-y-4">
                <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <h4 className="font-semibold mb-2 text-blue-900">📋 共有する情報</h4>
                  <ul className="list-disc list-inside text-sm space-y-1 text-blue-800">
                    <li>ストレス判定結果（高・中・低）</li>
                    <li>仕事のストレス要因スコア</li>
                    <li>周囲のサポート状況</li>
                  </ul>
                </div>

                <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                  <h4 className="font-semibold mb-2 text-green-900">✅ 共有のメリット</h4>
                  <ul className="list-disc list-inside text-sm space-y-1 text-green-800">
                    <li>労働時間や業務量の調整</li>
                    <li>職場環境の改善提案</li>
                    <li>キャリア相談の優先的な受付</li>
                    <li>産業医面談の調整</li>
                  </ul>
                </div>

                <div className="p-4 bg-amber-50 rounded-lg border border-amber-200">
                  <h4 className="font-semibold mb-2 text-amber-900">⚠️ 重要事項</h4>
                  <ul className="list-disc list-inside text-sm space-y-1 text-amber-800">
                    <li>人事評価には一切使用しません</li>
                    <li>配慮措置の検討目的のみで使用します</li>
                    <li>いつでも同意を撤回できます</li>
                  </ul>
                </div>

                <div className="flex gap-3 pt-2">
                  <Button
                    onClick={() => handleConsentSubmit(true)}
                    disabled={loading}
                    className="flex-1"
                  >
                    {loading ? '処理中...' : '共有に同意する'}
                  </Button>
                  <Button
                    onClick={() => handleConsentSubmit(false)}
                    variant="outline"
                    disabled={loading}
                    className="flex-1"
                  >
                    共有しない
                  </Button>
                </div>
              </div>
            ) : (
              <Alert className="border-green-200 bg-green-50">
                <CheckCircle className="h-4 w-4 text-green-600" />
                <AlertDescription className="text-green-800">
                  <strong>結果の共有に同意済みです</strong>
                  <br />
                  同意日: {consentStatus.consentDate ? format(consentStatus.consentDate, 'yyyy年MM月dd日', { locale: ja }) : '-'}
                  <br />
                  人事部門が適切な配慮措置を検討します。
                </AlertDescription>
              </Alert>
            )}
          </>
        ) : (
          <Alert>
            <X className="h-4 w-4" />
            <AlertDescription>
              この結果の共有設定は本人のみが変更できます。
            </AlertDescription>
          </Alert>
        )}
      </CardContent>
    </Card>
  );
}
```

**APIエンドポイント**:
```typescript
// src/app/api/stress-check/consent/route.ts（新規作成）

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';

export async function POST(req: NextRequest) {
  try {
    const session = await getServerSession();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { resultId, consentToShare, consentDate } = await req.json();

    // ストレスチェック結果を取得
    const result = await prisma.stressCheckResult.findUnique({
      where: { id: resultId }
    });

    if (!result) {
      return NextResponse.json({ error: 'Result not found' }, { status: 404 });
    }

    // 本人のみ同意を変更可能
    if (result.staffId !== session.user.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    // 同意状態を更新
    const updated = await prisma.stressCheckResult.update({
      where: { id: resultId },
      data: {
        consentToShare,
        consentDate: consentToShare ? new Date(consentDate) : null
      }
    });

    // 監査ログ記録
    await prisma.auditLog.create({
      data: {
        userId: session.user.id,
        action: 'STRESS_CHECK_CONSENT_UPDATE',
        category: 'STRESS_CHECK',
        details: JSON.stringify({
          resultId,
          consentToShare,
          consentDate
        }),
        ipAddress: req.headers.get('x-forwarded-for') || 'unknown'
      }
    });

    return NextResponse.json({ success: true, result: updated });
  } catch (error) {
    console.error('同意処理エラー:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

**Git操作**:
```bash
git add src/components/stress-check/ConsentFlow.tsx
git add src/app/api/stress-check/consent/route.ts
git commit -m "feat: ストレスチェック結果の本人同意取得UIとAPIを実装"
git push origin preview/feature-name
```

**確認事項**:
- [ ] 同意取得モーダルが正しく表示されるか
- [ ] 同意/非同意の処理が正常に動作するか
- [ ] 本人以外は変更できないか
- [ ] APIが正しく動作するか

---

### Phase 1-5: 人事部向け表示制御の実装

**作業内容**:
1. 人事部向けのストレスチェック結果表示画面を実装
2. 同意状況に基づく表示制御

**新規作成ファイル**:
```typescript
// src/app/stress-check/hr-view/page.tsx（新規作成）

'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { AlertCircle, Eye, CheckCircle, X } from 'lucide-react';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import { useSession } from 'next-auth/react';
import { checkStressCheckAccess, getHRViewStressCheckInfo } from '@/lib/stress-check/access-control';

interface StressCheckResult {
  id: string;
  staffId: string;
  checkDate: Date;
  stressLevel: 'HIGH' | 'MEDIUM' | 'LOW';
  isHighStress: boolean;
  consentToShare: boolean;
  consentDate: Date | null;
  departmentAtTime: string;
  staff: {
    name: string;
  };
}

export default function HRStressCheckView() {
  const { data: session } = useSession();
  const [results, setResults] = useState<StressCheckResult[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | 'consented' | 'high-stress'>('all');

  const userLevel = session?.user?.accountLevel || 0;

  useEffect(() => {
    fetchResults();
  }, [filter]);

  const fetchResults = async () => {
    setLoading(true);
    try {
      const response = await fetch(`/api/stress-check/hr-results?filter=${filter}`);
      const data = await response.json();
      setResults(data.results || []);
    } catch (error) {
      console.error('データ取得エラー:', error);
    } finally {
      setLoading(false);
    }
  };

  const filteredResults = results.map(result =>
    getHRViewStressCheckInfo(result, userLevel, session?.user?.id || '')
  );

  const consentedCount = results.filter(r => r.consentToShare).length;
  const highStressCount = results.filter(r => r.isHighStress).length;

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">ストレスチェック結果（人事部用）</h1>

      <Alert className="mb-6 border-amber-200 bg-amber-50">
        <AlertCircle className="h-4 w-4 text-amber-600" />
        <AlertDescription className="text-amber-800">
          <strong>重要：</strong>
          本人同意がある結果のみ表示されます。
          配慮措置の検討目的でのみ使用し、<strong>人事評価には一切使用しないでください。</strong>
          <br />
          全てのアクセスは監査ログに記録されます。
        </AlertDescription>
      </Alert>

      {/* 統計カード */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">総受検者数</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{results.length}名</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">同意済み</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{consentedCount}名</div>
            <p className="text-xs text-gray-500 mt-1">
              {results.length > 0 ? Math.round((consentedCount / results.length) * 100) : 0}%
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">高ストレス者</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{highStressCount}名</div>
            <p className="text-xs text-gray-500 mt-1">
              {results.length > 0 ? Math.round((highStressCount / results.length) * 100) : 0}%
            </p>
          </CardContent>
        </Card>
      </div>

      {/* フィルター */}
      <div className="flex gap-2 mb-4">
        <Button
          variant={filter === 'all' ? 'default' : 'outline'}
          onClick={() => setFilter('all')}
          size="sm"
        >
          全て
        </Button>
        <Button
          variant={filter === 'consented' ? 'default' : 'outline'}
          onClick={() => setFilter('consented')}
          size="sm"
        >
          同意済みのみ
        </Button>
        <Button
          variant={filter === 'high-stress' ? 'default' : 'outline'}
          onClick={() => setFilter('high-stress')}
          size="sm"
        >
          高ストレス者
        </Button>
      </div>

      {/* 結果テーブル */}
      <Card>
        <CardContent className="p-0">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>職員名</TableHead>
                <TableHead>部署</TableHead>
                <TableHead>ストレスレベル</TableHead>
                <TableHead>同意状況</TableHead>
                <TableHead>詳細</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={5} className="text-center py-8">
                    読み込み中...
                  </TableCell>
                </TableRow>
              ) : filteredResults.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={5} className="text-center py-8 text-gray-500">
                    データがありません
                  </TableCell>
                </TableRow>
              ) : (
                filteredResults.map(result => (
                  <TableRow key={result.staffId}>
                    <TableCell className="font-medium">
                      {result.staffName}
                    </TableCell>
                    <TableCell>
                      {result.department}
                    </TableCell>
                    <TableCell>
                      {result.stressLevel ? (
                        <Badge variant={
                          result.stressLevel === 'HIGH' ? 'destructive' :
                          result.stressLevel === 'MEDIUM' ? 'warning' :
                          'default'
                        }>
                          {result.stressLevel === 'HIGH' ? '高' :
                           result.stressLevel === 'MEDIUM' ? '中' : '低'}
                        </Badge>
                      ) : (
                        <span className="text-gray-400">非公開</span>
                      )}
                    </TableCell>
                    <TableCell>
                      {result.consentStatus ? (
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-green-600" />
                          <div className="text-sm">
                            <div className="font-medium text-green-700">同意済み</div>
                            {result.consentDate && (
                              <div className="text-xs text-gray-500">
                                {format(new Date(result.consentDate), 'yyyy/MM/dd', { locale: ja })}
                              </div>
                            )}
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center gap-2">
                          <X className="w-4 h-4 text-gray-400" />
                          <span className="text-sm text-gray-500">同意なし</span>
                        </div>
                      )}
                    </TableCell>
                    <TableCell>
                      {result.canViewDetails ? (
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => window.location.href = `/stress-check/detail/${result.staffId}`}
                        >
                          <Eye className="w-4 h-4 mr-1" />
                          詳細
                        </Button>
                      ) : (
                        <span className="text-gray-400 text-sm">閲覧不可</span>
                      )}
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* アクセス理由表示 */}
      {filteredResults.length > 0 && (
        <Alert className="mt-4">
          <AlertDescription className="text-sm">
            <strong>アクセス権限：</strong> {filteredResults[0]?.accessReason || '不明'}
          </AlertDescription>
        </Alert>
      )}
    </div>
  );
}
```

**APIエンドポイント**:
```typescript
// src/app/api/stress-check/hr-results/route.ts（新規作成）

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';

export async function GET(req: NextRequest) {
  try {
    const session = await getServerSession();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const userLevel = session.user.accountLevel || 0;

    // Level 14-17（人事部）のみアクセス可能
    if (userLevel < 14 || userLevel > 17) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    const { searchParams } = new URL(req.url);
    const filter = searchParams.get('filter') || 'all';

    let whereCondition: any = {};

    if (filter === 'consented') {
      whereCondition.consentToShare = true;
    } else if (filter === 'high-stress') {
      whereCondition.isHighStress = true;
    }

    const results = await prisma.stressCheckResult.findMany({
      where: whereCondition,
      include: {
        staff: {
          select: {
            name: true
          }
        }
      },
      orderBy: {
        checkDate: 'desc'
      }
    });

    // 監査ログ記録
    await prisma.auditLog.create({
      data: {
        userId: session.user.id,
        action: 'STRESS_CHECK_HR_VIEW',
        category: 'STRESS_CHECK',
        details: JSON.stringify({
          filter,
          resultCount: results.length
        }),
        ipAddress: req.headers.get('x-forwarded-for') || 'unknown'
      }
    });

    return NextResponse.json({ results });
  } catch (error) {
    console.error('HR結果取得エラー:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

**Git操作**:
```bash
git add src/app/stress-check/hr-view/page.tsx
git add src/app/api/stress-check/hr-results/route.ts
git commit -m "feat: 人事部向けストレスチェック結果表示画面を実装（同意状況制御）"
git push origin preview/feature-name
```

**確認事項**:
- [ ] 人事部（Level 14-17）のみアクセス可能か
- [ ] 同意済み結果のみ詳細が表示されるか
- [ ] 同意なし結果は非公開表示されるか
- [ ] 監査ログが記録されるか

---

## 🔒 Phase 2: 監査・運用強化（詳細）

### Phase 2-1: 監査ログ強化の実装

**作業内容**:
1. ストレスチェックアクセス専用の監査ログ
2. 不正アクセス試行のアラート

**新規作成ファイル**:
```typescript
// src/lib/audit/stress-check-audit.ts（新規作成）

interface StressCheckAccessLog {
  timestamp: Date;
  userId: string;
  userLevel: number;
  userRole: string;
  action: 'view' | 'view_details' | 'edit' | 'consent_update';
  targetStaffId: string;
  targetResultId: string;
  consentStatus: boolean;
  accessGranted: boolean;
  accessReason: string;
  ipAddress: string;
}

export async function logStressCheckAccess(log: StressCheckAccessLog) {
  // 全てのアクセスを記録
  await prisma.auditLog.create({
    data: {
      ...log,
      category: 'STRESS_CHECK_ACCESS',
      // 同意なしでのアクセス試行は要注意
      severity: log.accessGranted && !log.consentStatus && log.userLevel < 98
        ? 'WARNING'
        : 'INFO'
    }
  });

  // 不正アクセス試行のアラート
  if (!log.accessGranted && log.action === 'view_details') {
    await sendSecurityAlert({
      type: 'UNAUTHORIZED_STRESS_CHECK_ACCESS',
      userId: log.userId,
      targetStaffId: log.targetStaffId,
      timestamp: log.timestamp,
      details: `Level ${log.userLevel}のユーザーが同意なしの結果にアクセス試行`
    });
  }
}

async function sendSecurityAlert(alert: any) {
  // VoiceDrive通知またはメール送信
  await fetch('/api/notifications/security-alert', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(alert)
  });
}
```

**Git操作**:
```bash
git add src/lib/audit/stress-check-audit.ts
git commit -m "feat: ストレスチェックアクセス専用の監査ログを実装"
git push origin preview/feature-name
```

---

### Phase 2-2: 同意状況ダッシュボードの実装

**作業内容**:
1. 同意状況の統計・可視化
2. 産業医・健診担当者向けダッシュボード

**新規作成ファイル**:
```typescript
// src/app/stress-check/consent-dashboard/page.tsx（新規作成）

'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

export default function ConsentDashboard() {
  const [stats, setStats] = useState<any>(null);

  useEffect(() => {
    fetchConsentStats();
  }, []);

  const fetchConsentStats = async () => {
    const response = await fetch('/api/stress-check/consent-stats');
    const data = await response.json();
    setStats(data);
  };

  if (!stats) return <div>読み込み中...</div>;

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">ストレスチェック同意状況</h1>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <Card>
          <CardHeader>
            <CardTitle>同意率</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold mb-2">
              {stats.consentRate}%
            </div>
            <Progress value={stats.consentRate} className="mb-2" />
            <p className="text-sm text-gray-500">
              {stats.consentedCount} / {stats.totalCount} 名
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>高ストレス者の同意率</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold mb-2">
              {stats.highStressConsentRate}%
            </div>
            <Progress value={stats.highStressConsentRate} className="mb-2" />
            <p className="text-sm text-gray-500">
              {stats.highStressConsentedCount} / {stats.highStressCount} 名
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>未同意者</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-amber-600 mb-2">
              {stats.notConsentedCount}名
            </div>
            <p className="text-sm text-gray-500">
              フォローアップ対象
            </p>
          </CardContent>
        </Card>
      </div>

      {/* 部署別同意率グラフ */}
      <Card>
        <CardHeader>
          <CardTitle>部署別同意状況</CardTitle>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={stats.departmentStats}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="department" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="consentedCount" fill="#10b981" name="同意済み" />
              <Bar dataKey="notConsentedCount" fill="#f59e0b" name="未同意" />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>
    </div>
  );
}
```

**Git操作**:
```bash
git add src/app/stress-check/consent-dashboard/page.tsx
git commit -m "feat: ストレスチェック同意状況ダッシュボードを実装"
git push origin preview/feature-name
```

---

### Phase 2-3: VoiceDrive通知フローの実装

**作業内容**:
1. 同意取得時の人事部への通知
2. 高ストレス者検出時の産業医への通知

**Git操作**:
```bash
git add src/services/stress-check-notifications.ts
git commit -m "feat: ストレスチェック関連のVoiceDrive通知フローを実装"
git push origin preview/feature-name
```

---

## 📝 VoiceDrive依頼書の更新

Phase 1-5完了後、以下のファイルを更新：

```bash
# 依頼書を更新
git add mcp-shared/docs/Account_Level_Definition_Unification_Request_20251004.md
git commit -m "docs: 特別権限レベル（97-99）をVoiceDrive依頼書に追加"
git push origin preview/feature-name
```

---

## 🧪 テスト計画

### 単体テスト

- [ ] `checkStressCheckAccess`関数のテスト（全ケース）
- [ ] 本人同意API のテスト
- [ ] アクセス制御ロジックのテスト

### 結合テスト

- [ ] 本人による同意取得フロー
- [ ] 人事部の表示制御
- [ ] 産業医・健診担当者のアクセス権限

### E2Eテスト

- [ ] Level 97でログイン → 同意なし結果は集団分析のみ
- [ ] Level 98でログイン → 全結果閲覧可能
- [ ] Level 14でログイン → 同意済み結果のみ閲覧可能

---

## 📊 進捗管理

各Phaseの完了後、以下を実施：

1. **preview/feature-nameにpush**
2. **ユーザーに確認依頼**
3. **確認OK → mainにマージ**
4. **次のPhaseへ進む**

---

## 🎯 成功基準

- [ ] Level 97-99が正しく定義されている
- [ ] 本人同意がない場合、人事部は閲覧不可
- [ ] 本人同意がある場合、人事部は閲覧可能
- [ ] 産業医は常に閲覧可能
- [ ] 全アクセスが監査ログに記録される
- [ ] 法令遵守（労安法66条の10）

---

**次のアクション**: Phase 1-1から順次実装開始

準備完了です！Phase 1-1から始めましょうか？
