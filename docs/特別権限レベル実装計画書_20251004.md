# ç‰¹åˆ¥æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ97-99ï¼‰å®Ÿè£…è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2025å¹´10æœˆ4æ—¥
**ä½œæˆè€…**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 
**å¯¾è±¡**: å¥è¨ºæ‹…å½“è€…ãƒ»ç”£æ¥­åŒ»ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ç‰¹åˆ¥æ¨©é™å®Ÿè£…
**å„ªå…ˆåº¦**: ğŸ”´ é«˜ï¼ˆæ³•ä»¤éµå®ˆãƒ»å€‹äººæƒ…å ±ä¿è­·ã®ãŸã‚ï¼‰

---

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

å¥åº·ç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯å«ã‚€ï¼‰ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å¼·åŒ–ã—ã€ç‰¹åˆ¥æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ97-99ï¼‰ã‚’æ–°è¨­ã—ã¾ã™ã€‚æ³•ä»¤éµå®ˆï¼ˆåŠ´å®‰æ³•66æ¡ã®10ï¼‰ã¨å®Ÿå‹™ã®åˆ©ä¾¿æ€§ã‚’ä¸¡ç«‹ã•ã›ã¾ã™ã€‚

**æ–°è¨­ã™ã‚‹æ¨©é™ãƒ¬ãƒ™ãƒ«**:
- **Level 97**: å¥è¨ºæ‹…å½“è€…ï¼ˆã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿæ–½è€…ï¼‰
- **Level 98**: ç”£æ¥­åŒ»
- **Level 99**: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼ˆæ—¢å­˜ã€æ¨©é™æ•´ç†ï¼‰

**æœ€çµ‚çš„ãªæ¨©é™ãƒ¬ãƒ™ãƒ«æ§‹æˆ**:
- åŸºæœ¬18ãƒ¬ãƒ™ãƒ«ï¼ˆ1-18ï¼‰
- çœ‹è­·è·å°‚ç”¨4ãƒ¬ãƒ™ãƒ«ï¼ˆ1.5-4.5ï¼‰
- **ç‰¹åˆ¥æ¨©é™3ãƒ¬ãƒ™ãƒ«ï¼ˆ97-99ï¼‰â† æ–°è¨­**
- **åˆè¨ˆ25ç¨®é¡**

---

## ğŸ¯ å®Ÿè£…ã®ç›®çš„

### 1. æ³•ä»¤éµå®ˆ

**åŠ´åƒå®‰å…¨è¡›ç”Ÿæ³• ç¬¬66æ¡ã®10**:
> äº‹æ¥­è€…ã¯ã€æœ¬äººã®åŒæ„ã‚’å¾—ãªã„ã§å½“è©²åŠ´åƒè€…ã®æ¤œæŸ»ã®çµæœã‚’å–å¾—ã—ã¦ã¯ãªã‚‰ãªã„ã€‚

**å®Ÿè£…ã§å¯¾å¿œ**:
- âœ… ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã¯ç”£æ¥­åŒ»ãƒ»å®Ÿæ–½è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- âœ… æœ¬äººåŒæ„ãŒã‚ã‚‹å ´åˆã®ã¿äººäº‹éƒ¨ãŒé–²è¦§å¯èƒ½
- âœ… å…¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²

### 2. å€‹äººæƒ…å ±ä¿è­·

- å¥è¨ºãƒ‡ãƒ¼ã‚¿ã¨äººäº‹ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨åˆ†é›¢
- ç”£æ¥­åŒ»ã®ç‹¬ç«‹æ€§ç¢ºä¿
- æœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆå¿…è¦æœ€å°é™ã®æƒ…å ±ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰

### 3. å®Ÿå‹™ã®åˆ©ä¾¿æ€§

- æœ¬äººåŒæ„å–å¾—ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…
- äººäº‹éƒ¨ã«ã‚ˆã‚‹é…æ…®æªç½®ã®æ¤œè¨ã‚’å¯èƒ½ã«
- æ—¢è£½å“ã¨åŒç­‰ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

---

## ğŸ“Š å®Ÿè£…ç¯„å›²

### Phase 1: åŸºç›¤å®Ÿè£…ï¼ˆå¿…é ˆï¼‰

| Phase | ä½œæ¥­å†…å®¹ | æ‰€è¦æ™‚é–“ | æ‹…å½“ | ãƒ–ãƒ©ãƒ³ãƒ | ç¢ºèªè€… |
|-------|---------|---------|------|---------|--------|
| **1-1** | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«å®šç¾©ã®æ‹¡å¼µï¼ˆ97-99è¿½åŠ ï¼‰ | 30åˆ† | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| **1-2** | ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡è¨­å®šã®æ›´æ–° | 30åˆ† | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| **1-3** | å‹•çš„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£… | 1æ™‚é–“ | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| **1-4** | æœ¬äººåŒæ„å–å¾—UIã®å®Ÿè£… | 1.5æ™‚é–“ | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| **1-5** | äººäº‹éƒ¨å‘ã‘è¡¨ç¤ºåˆ¶å¾¡ã®å®Ÿè£… | 1æ™‚é–“ | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |

**Phase 1åˆè¨ˆ**: ç´„4.5æ™‚é–“

### Phase 2: ç›£æŸ»ãƒ»é‹ç”¨å¼·åŒ–ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰

| Phase | ä½œæ¥­å†…å®¹ | æ‰€è¦æ™‚é–“ | æ‹…å½“ | ãƒ–ãƒ©ãƒ³ãƒ | ç¢ºèªè€… |
|-------|---------|---------|------|---------|--------|
| **2-1** | ç›£æŸ»ãƒ­ã‚°å¼·åŒ–ã®å®Ÿè£… | 1æ™‚é–“ | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| **2-2** | åŒæ„çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å®Ÿè£… | 1.5æ™‚é–“ | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| **2-3** | VoiceDriveé€šçŸ¥ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£… | 1æ™‚é–“ | Claude Code | preview | ãƒ¦ãƒ¼ã‚¶ãƒ¼ |

**Phase 2åˆè¨ˆ**: ç´„3.5æ™‚é–“

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

| ä½œæ¥­ | æ‰€è¦æ™‚é–“ | æ‹…å½“ | çŠ¶æ…‹ |
|------|---------|------|------|
| VoiceDriveä¾é ¼æ›¸ã®æ›´æ–° | 30åˆ† | Claude Code | ğŸ“‹ å¾…æ©Ÿä¸­ |
| çµ±åˆãƒ†ã‚¹ãƒˆè¨ˆç”»æ›¸ä½œæˆ | 30åˆ† | Claude Code | ğŸ“‹ å¾…æ©Ÿä¸­ |

**ç·æ‰€è¦æ™‚é–“**: ç´„9æ™‚é–“

---

## ğŸ”§ Phase 1: åŸºç›¤å®Ÿè£…ï¼ˆè©³ç´°ï¼‰

### Phase 1-1: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«å®šç¾©ã®æ‹¡å¼µ

**ä½œæ¥­å†…å®¹**:
1. `accountLevelCalculator.ts`ã«97-99ãƒ¬ãƒ™ãƒ«ã‚’è¿½åŠ 
2. `positionSeeds.ts`ã«ç‰¹åˆ¥æ¨©é™å½¹è·ã‚’è¿½åŠ 

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**:
```typescript
// src/services/accountLevelCalculator.ts
export enum AccountLevel {
  // åŸºæœ¬18ãƒ¬ãƒ™ãƒ«ï¼ˆæ—¢å­˜ï¼‰
  NEW_STAFF = 1,
  // ... çœç•¥
  BOARD_MEMBER = 18,

  // çœ‹è­·è·å°‚ç”¨+0.5ãƒ¬ãƒ™ãƒ«ï¼ˆæ—¢å­˜ï¼‰
  NEW_STAFF_LEADER = 1.5,
  // ... çœç•¥
  VETERAN_STAFF_LEADER = 4.5,

  // ğŸ†• ç‰¹åˆ¥æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆæ–°è¨­ï¼‰
  HEALTH_CHECKUP_STAFF = 97,    // å¥è¨ºæ‹…å½“è€…
  OCCUPATIONAL_PHYSICIAN = 98,   // ç”£æ¥­åŒ»
  SYSTEM_ADMIN = 99              // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…
}
```

**å½¹è·ãƒã‚¹ã‚¿ãƒ¼è¿½åŠ **:
```typescript
// src/data/seeds/positionSeeds.ts ã«è¿½åŠ 
{
  id: 'POS_024',
  code: 'HEALTH_CHECKUP_STAFF',
  name: 'å¥è¨ºæ‹…å½“è€…',
  level: 97,
  category: 'medical',
  requiresManagementTraining: false,
  canApproveLeave: false,
  canPerformEvaluation: false,
  displayOrder: 24,
  isActive: true,
},
{
  id: 'POS_025',
  code: 'OCCUPATIONAL_PHYSICIAN',
  name: 'ç”£æ¥­åŒ»',
  level: 98,
  category: 'medical',
  requiresManagementTraining: false,
  canApproveLeave: false,
  canPerformEvaluation: false,
  displayOrder: 25,
  isActive: true,
},
```

**Gitæ“ä½œ**:
```bash
# preview/feature-nameãƒ–ãƒ©ãƒ³ãƒã§ä½œæ¥­
git add src/services/accountLevelCalculator.ts
git add src/data/seeds/positionSeeds.ts
git commit -m "feat: ç‰¹åˆ¥æ¨©é™ãƒ¬ãƒ™ãƒ«97-99ã‚’è¿½åŠ ï¼ˆå¥è¨ºæ‹…å½“è€…ãƒ»ç”£æ¥­åŒ»ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰"
git push origin preview/feature-name
```

**ç¢ºèªäº‹é …**:
- [ ] Level 97, 98, 99ãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] å½¹è·ãƒã‚¹ã‚¿ãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] TypeScriptã®ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹

---

### Phase 1-2: ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡è¨­å®šã®æ›´æ–°

**ä½œæ¥­å†…å®¹**:
1. `accessControl.ts`ã«ç‰¹åˆ¥æ¨©é™è¨­å®šã‚’è¿½åŠ 
2. å¥åº·ç®¡ç†ãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å®šç¾©

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**:
```typescript
// src/config/accessControl.ts ã«è¿½åŠ 

// ç‰¹åˆ¥æ¨©é™ãƒ¬ãƒ™ãƒ«ã®å®šç¾©
export const SPECIAL_HEALTH_PERMISSIONS = {
  // Level 97: å¥è¨ºæ‹…å½“è€…
  HEALTH_CHECKUP_STAFF: {
    level: 97,
    allowedPaths: [
      '/health/management',          // å¥è¨ºç®¡ç†ç”»é¢
      '/health/staff/:staffId',      // å€‹åˆ¥å¥è¨ºãƒ‡ãƒ¼ã‚¿
      '/stress-check',               // ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯
      '/health/reexamination',       // å†æ¤œæŸ»ç®¡ç†
      '/health/reports',             // å¥è¨ºãƒ¬ãƒãƒ¼ãƒˆ
    ],
    allowedDataAccess: [
      'healthCheckup',
      'stressCheck',
      'reexamination',
      'basicStaffInfo',  // æ°åãƒ»éƒ¨ç½²ã®ã¿
    ],
    deniedDataAccess: [
      'salary',
      'evaluation',
      'interview',
      'disciplinary',
      'masterData',
    ]
  },

  // Level 98: ç”£æ¥­åŒ»
  OCCUPATIONAL_PHYSICIAN: {
    level: 98,
    allowedPaths: [
      '/health/management',
      '/health/staff/:staffId',
      '/stress-check',
      '/health/occupational-consultation',  // ç”£æ¥­åŒ»é¢è«‡
      '/health/medical-opinions',           // åŒ»å­¦çš„æ„è¦‹æ›¸
      '/health/work-restrictions',          // å°±æ¥­åˆ¶é™ç®¡ç†
    ],
    allowedDataAccess: [
      'healthCheckup',
      'stressCheck',
      'occupationalConsultation',
      'workRestrictions',
      'basicStaffInfo',
      'workHistory',      // å¥åº·è©•ä¾¡ç”¨
      'absenceRecords',   // å¥åº·è©•ä¾¡ç”¨
    ],
    deniedDataAccess: [
      'salary',
      'evaluation',
      'interview',  // ç”£æ¥­åŒ»é¢è«‡é™¤ã
      'disciplinary',
      'masterData',
    ]
  },

  // Level 99: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…
  SYSTEM_ADMIN: {
    level: 99,
    allowedPaths: ['*'],  // å…¨ã¦è¨±å¯
    allowedDataAccess: ['*'],
    deniedDataAccess: []
  }
};

// ç‰¹åˆ¥æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
export function hasSpecialHealthPermission(
  userLevel: number,
  dataType: string
): boolean {
  if (userLevel === 99) return true;

  if (userLevel === 98) {
    return SPECIAL_HEALTH_PERMISSIONS.OCCUPATIONAL_PHYSICIAN.allowedDataAccess.includes(dataType);
  }

  if (userLevel === 97) {
    return SPECIAL_HEALTH_PERMISSIONS.HEALTH_CHECKUP_STAFF.allowedDataAccess.includes(dataType);
  }

  return false;
}
```

**Gitæ“ä½œ**:
```bash
git add src/config/accessControl.ts
git commit -m "feat: ç‰¹åˆ¥æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ97-99ï¼‰ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡è¨­å®šã‚’è¿½åŠ "
git push origin preview/feature-name
```

**ç¢ºèªäº‹é …**:
- [ ] ç‰¹åˆ¥æ¨©é™è¨­å®šãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½/ä¸å¯ãªãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

---

### Phase 1-3: å‹•çš„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

**ä½œæ¥­å†…å®¹**:
1. ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã¸ã®å‹•çš„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å®Ÿè£…
2. æœ¬äººåŒæ„çŠ¶æ…‹ã«åŸºã¥ãã‚¢ã‚¯ã‚»ã‚¹åˆ¤å®š

**æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«**:
```typescript
// src/lib/stress-check/access-control.tsï¼ˆæ–°è¦ä½œæˆï¼‰

export interface StressCheckAccessControl {
  canView: boolean;
  canViewDetails: boolean;
  canEdit: boolean;
  reason: string;
}

/**
 * ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™åˆ¤å®š
 */
export function checkStressCheckAccess(
  userLevel: number,
  stressCheckResult: {
    staffId: string;
    consentToShare: boolean;
    consentDate: Date | null;
    isHighStress: boolean;
  },
  currentUserId: string
): StressCheckAccessControl {

  // ã‚±ãƒ¼ã‚¹1: æœ¬äººè‡ªèº«
  if (stressCheckResult.staffId === currentUserId) {
    return {
      canView: true,
      canViewDetails: true,
      canEdit: false,
      reason: 'æœ¬äººã®çµæœ'
    };
  }

  // ã‚±ãƒ¼ã‚¹2: Level 99ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰
  if (userLevel === 99) {
    return {
      canView: true,
      canViewDetails: true,
      canEdit: true,
      reason: 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…æ¨©é™ï¼ˆç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ï¼‰'
    };
  }

  // ã‚±ãƒ¼ã‚¹3: Level 98ï¼ˆç”£æ¥­åŒ»ï¼‰
  if (userLevel === 98) {
    return {
      canView: true,
      canViewDetails: true,  // å¸¸ã«é–²è¦§å¯èƒ½
      canEdit: true,         // åŒ»å­¦çš„æ‰€è¦‹ã‚’è¿½è¨˜å¯èƒ½
      reason: 'ç”£æ¥­åŒ»æ¨©é™ï¼ˆåŠ´å®‰æ³•66æ¡ã®10ç¬¬2é …ï¼‰'
    };
  }

  // ã‚±ãƒ¼ã‚¹4: Level 97ï¼ˆå¥è¨ºæ‹…å½“è€…ï¼‰
  if (userLevel === 97) {
    return {
      canView: true,
      canViewDetails: stressCheckResult.consentToShare,
      canEdit: stressCheckResult.consentToShare,
      reason: stressCheckResult.consentToShare
        ? 'å¥è¨ºæ‹…å½“è€…æ¨©é™ï¼ˆæœ¬äººåŒæ„ã‚ã‚Šï¼‰'
        : 'é›†å›£åˆ†æã®ã¿å¯èƒ½'
    };
  }

  // ã‚±ãƒ¼ã‚¹5: Level 14-17ï¼ˆäººäº‹éƒ¨ï¼‰
  if (userLevel >= 14 && userLevel <= 17) {
    if (stressCheckResult.consentToShare) {
      return {
        canView: true,
        canViewDetails: true,
        canEdit: false,
        reason: 'äººäº‹éƒ¨æ¨©é™ï¼ˆæœ¬äººåŒæ„ã‚ã‚Šãƒ»é…æ…®ç¾©å‹™ã®ãŸã‚ï¼‰'
      };
    } else {
      return {
        canView: stressCheckResult.isHighStress,
        canViewDetails: false,
        canEdit: false,
        reason: 'æœ¬äººåŒæ„ãªã—ï¼ˆé«˜ã‚¹ãƒˆãƒ¬ã‚¹è€…ã®å­˜åœ¨ã®ã¿æŠŠæ¡å¯èƒ½ï¼‰'
      };
    }
  }

  // ã‚±ãƒ¼ã‚¹6: ãã®ä»–ã®ãƒ¬ãƒ™ãƒ«
  return {
    canView: false,
    canViewDetails: false,
    canEdit: false,
    reason: 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãªã—'
  };
}

/**
 * äººäº‹éƒ¨å‘ã‘ã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœè¡¨ç¤ºæƒ…å ±ã‚’å–å¾—
 */
export function getHRViewStressCheckInfo(
  stressCheckResult: any,
  userLevel: number,
  currentUserId: string
) {
  const access = checkStressCheckAccess(userLevel, stressCheckResult, currentUserId);

  return {
    staffId: stressCheckResult.staffId,
    staffName: access.canView ? stressCheckResult.staff?.name : 'éå…¬é–‹',
    department: access.canView ? stressCheckResult.departmentAtTime : 'éå…¬é–‹',
    stressLevel: access.canViewDetails ? stressCheckResult.stressLevel : null,
    isHighStress: access.canView ? stressCheckResult.isHighStress : null,
    consentStatus: stressCheckResult.consentToShare,
    consentDate: stressCheckResult.consentDate,
    canViewDetails: access.canViewDetails,
    accessReason: access.reason
  };
}
```

**Gitæ“ä½œ**:
```bash
git add src/lib/stress-check/access-control.ts
git commit -m "feat: ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã¸ã®å‹•çš„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…"
git push origin preview/feature-name
```

**ç¢ºèªäº‹é …**:
- [ ] å…¨ã¦ã®ã‚±ãƒ¼ã‚¹ï¼ˆæœ¬äººãƒ»ç”£æ¥­åŒ»ãƒ»å¥è¨ºæ‹…å½“è€…ãƒ»äººäº‹éƒ¨ãƒ»ãã®ä»–ï¼‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] æœ¬äººåŒæ„çŠ¶æ…‹ã«åŸºã¥ãåˆ¤å®šãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹
- [ ] TypeScriptã®å‹å®šç¾©ãŒæ­£ã—ã„ã‹

---

### Phase 1-4: æœ¬äººåŒæ„å–å¾—UIã®å®Ÿè£…

**ä½œæ¥­å†…å®¹**:
1. æœ¬äººåŒæ„å–å¾—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
2. åŒæ„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…

**æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«**:
```typescript
// src/components/stress-check/ConsentFlow.tsxï¼ˆæ–°è¦ä½œæˆï¼‰

'use client';

import React, { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { AlertCircle, CheckCircle, X } from 'lucide-react';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';

interface ConsentFlowProps {
  stressCheckResultId: string;
  staffId: string;
  currentUserId: string;
  consentStatus: {
    consentToShare: boolean;
    consentDate: Date | null;
  };
  onConsentUpdate?: () => void;
}

export function ConsentFlow({
  stressCheckResultId,
  staffId,
  currentUserId,
  consentStatus,
  onConsentUpdate
}: ConsentFlowProps) {
  const [showConsentModal, setShowConsentModal] = useState(false);
  const [loading, setLoading] = useState(false);

  const canGiveConsent = staffId === currentUserId;

  const handleConsentSubmit = async (consent: boolean) => {
    setLoading(true);

    try {
      const response = await fetch('/api/stress-check/consent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          resultId: stressCheckResultId,
          consentToShare: consent,
          consentDate: new Date().toISOString()
        })
      });

      if (response.ok) {
        setShowConsentModal(false);

        // åŒæ„ã—ãŸå ´åˆã¯äººäº‹éƒ¨ã¸é€šçŸ¥
        if (consent) {
          await fetch('/api/notifications/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'STRESS_CHECK_CONSENT_GIVEN',
              staffId: staffId,
              message: `ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã®å…±æœ‰ã«åŒæ„ãŒã‚ã‚Šã¾ã—ãŸ`,
              targetLevel: 14  // äººäº‹éƒ¨é–€å“¡ä»¥ä¸Š
            })
          });
        }

        onConsentUpdate?.();
      }
    } catch (error) {
      console.error('åŒæ„å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Card className="mb-6">
      <CardHeader>
        <CardTitle className="text-lg">çµæœã®å…±æœ‰ã«ã¤ã„ã¦</CardTitle>
      </CardHeader>
      <CardContent>
        {canGiveConsent ? (
          <>
            <Alert className="mb-4">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription>
                ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã®çµæœã‚’äººäº‹éƒ¨é–€ã¨å…±æœ‰ã™ã‚‹ã“ã¨ã§ã€
                é©åˆ‡ãªè·å ´ç’°å¢ƒæ”¹å–„ã‚„é…æ…®æªç½®ã‚’å—ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚
                <br />
                <strong>å…±æœ‰ã¯ä»»æ„ã§ã‚ã‚Šã€ä¸åˆ©ç›Šãªå–ã‚Šæ‰±ã„ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚</strong>
              </AlertDescription>
            </Alert>

            {!consentStatus.consentToShare ? (
              <div className="space-y-4">
                <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <h4 className="font-semibold mb-2 text-blue-900">ğŸ“‹ å…±æœ‰ã™ã‚‹æƒ…å ±</h4>
                  <ul className="list-disc list-inside text-sm space-y-1 text-blue-800">
                    <li>ã‚¹ãƒˆãƒ¬ã‚¹åˆ¤å®šçµæœï¼ˆé«˜ãƒ»ä¸­ãƒ»ä½ï¼‰</li>
                    <li>ä»•äº‹ã®ã‚¹ãƒˆãƒ¬ã‚¹è¦å› ã‚¹ã‚³ã‚¢</li>
                    <li>å‘¨å›²ã®ã‚µãƒãƒ¼ãƒˆçŠ¶æ³</li>
                  </ul>
                </div>

                <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                  <h4 className="font-semibold mb-2 text-green-900">âœ… å…±æœ‰ã®ãƒ¡ãƒªãƒƒãƒˆ</h4>
                  <ul className="list-disc list-inside text-sm space-y-1 text-green-800">
                    <li>åŠ´åƒæ™‚é–“ã‚„æ¥­å‹™é‡ã®èª¿æ•´</li>
                    <li>è·å ´ç’°å¢ƒã®æ”¹å–„ææ¡ˆ</li>
                    <li>ã‚­ãƒ£ãƒªã‚¢ç›¸è«‡ã®å„ªå…ˆçš„ãªå—ä»˜</li>
                    <li>ç”£æ¥­åŒ»é¢è«‡ã®èª¿æ•´</li>
                  </ul>
                </div>

                <div className="p-4 bg-amber-50 rounded-lg border border-amber-200">
                  <h4 className="font-semibold mb-2 text-amber-900">âš ï¸ é‡è¦äº‹é …</h4>
                  <ul className="list-disc list-inside text-sm space-y-1 text-amber-800">
                    <li>äººäº‹è©•ä¾¡ã«ã¯ä¸€åˆ‡ä½¿ç”¨ã—ã¾ã›ã‚“</li>
                    <li>é…æ…®æªç½®ã®æ¤œè¨ç›®çš„ã®ã¿ã§ä½¿ç”¨ã—ã¾ã™</li>
                    <li>ã„ã¤ã§ã‚‚åŒæ„ã‚’æ’¤å›ã§ãã¾ã™</li>
                  </ul>
                </div>

                <div className="flex gap-3 pt-2">
                  <Button
                    onClick={() => handleConsentSubmit(true)}
                    disabled={loading}
                    className="flex-1"
                  >
                    {loading ? 'å‡¦ç†ä¸­...' : 'å…±æœ‰ã«åŒæ„ã™ã‚‹'}
                  </Button>
                  <Button
                    onClick={() => handleConsentSubmit(false)}
                    variant="outline"
                    disabled={loading}
                    className="flex-1"
                  >
                    å…±æœ‰ã—ãªã„
                  </Button>
                </div>
              </div>
            ) : (
              <Alert className="border-green-200 bg-green-50">
                <CheckCircle className="h-4 w-4 text-green-600" />
                <AlertDescription className="text-green-800">
                  <strong>çµæœã®å…±æœ‰ã«åŒæ„æ¸ˆã¿ã§ã™</strong>
                  <br />
                  åŒæ„æ—¥: {consentStatus.consentDate ? format(consentStatus.consentDate, 'yyyyå¹´MMæœˆddæ—¥', { locale: ja }) : '-'}
                  <br />
                  äººäº‹éƒ¨é–€ãŒé©åˆ‡ãªé…æ…®æªç½®ã‚’æ¤œè¨ã—ã¾ã™ã€‚
                </AlertDescription>
              </Alert>
            )}
          </>
        ) : (
          <Alert>
            <X className="h-4 w-4" />
            <AlertDescription>
              ã“ã®çµæœã®å…±æœ‰è¨­å®šã¯æœ¬äººã®ã¿ãŒå¤‰æ›´ã§ãã¾ã™ã€‚
            </AlertDescription>
          </Alert>
        )}
      </CardContent>
    </Card>
  );
}
```

**APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```typescript
// src/app/api/stress-check/consent/route.tsï¼ˆæ–°è¦ä½œæˆï¼‰

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';

export async function POST(req: NextRequest) {
  try {
    const session = await getServerSession();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { resultId, consentToShare, consentDate } = await req.json();

    // ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’å–å¾—
    const result = await prisma.stressCheckResult.findUnique({
      where: { id: resultId }
    });

    if (!result) {
      return NextResponse.json({ error: 'Result not found' }, { status: 404 });
    }

    // æœ¬äººã®ã¿åŒæ„ã‚’å¤‰æ›´å¯èƒ½
    if (result.staffId !== session.user.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    // åŒæ„çŠ¶æ…‹ã‚’æ›´æ–°
    const updated = await prisma.stressCheckResult.update({
      where: { id: resultId },
      data: {
        consentToShare,
        consentDate: consentToShare ? new Date(consentDate) : null
      }
    });

    // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    await prisma.auditLog.create({
      data: {
        userId: session.user.id,
        action: 'STRESS_CHECK_CONSENT_UPDATE',
        category: 'STRESS_CHECK',
        details: JSON.stringify({
          resultId,
          consentToShare,
          consentDate
        }),
        ipAddress: req.headers.get('x-forwarded-for') || 'unknown'
      }
    });

    return NextResponse.json({ success: true, result: updated });
  } catch (error) {
    console.error('åŒæ„å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

**Gitæ“ä½œ**:
```bash
git add src/components/stress-check/ConsentFlow.tsx
git add src/app/api/stress-check/consent/route.ts
git commit -m "feat: ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã®æœ¬äººåŒæ„å–å¾—UIã¨APIã‚’å®Ÿè£…"
git push origin preview/feature-name
```

**ç¢ºèªäº‹é …**:
- [ ] åŒæ„å–å¾—ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹
- [ ] åŒæ„/éåŒæ„ã®å‡¦ç†ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
- [ ] æœ¬äººä»¥å¤–ã¯å¤‰æ›´ã§ããªã„ã‹
- [ ] APIãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹

---

### Phase 1-5: äººäº‹éƒ¨å‘ã‘è¡¨ç¤ºåˆ¶å¾¡ã®å®Ÿè£…

**ä½œæ¥­å†…å®¹**:
1. äººäº‹éƒ¨å‘ã‘ã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœè¡¨ç¤ºç”»é¢ã‚’å®Ÿè£…
2. åŒæ„çŠ¶æ³ã«åŸºã¥ãè¡¨ç¤ºåˆ¶å¾¡

**æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«**:
```typescript
// src/app/stress-check/hr-view/page.tsxï¼ˆæ–°è¦ä½œæˆï¼‰

'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { AlertCircle, Eye, CheckCircle, X } from 'lucide-react';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import { useSession } from 'next-auth/react';
import { checkStressCheckAccess, getHRViewStressCheckInfo } from '@/lib/stress-check/access-control';

interface StressCheckResult {
  id: string;
  staffId: string;
  checkDate: Date;
  stressLevel: 'HIGH' | 'MEDIUM' | 'LOW';
  isHighStress: boolean;
  consentToShare: boolean;
  consentDate: Date | null;
  departmentAtTime: string;
  staff: {
    name: string;
  };
}

export default function HRStressCheckView() {
  const { data: session } = useSession();
  const [results, setResults] = useState<StressCheckResult[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | 'consented' | 'high-stress'>('all');

  const userLevel = session?.user?.accountLevel || 0;

  useEffect(() => {
    fetchResults();
  }, [filter]);

  const fetchResults = async () => {
    setLoading(true);
    try {
      const response = await fetch(`/api/stress-check/hr-results?filter=${filter}`);
      const data = await response.json();
      setResults(data.results || []);
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    } finally {
      setLoading(false);
    }
  };

  const filteredResults = results.map(result =>
    getHRViewStressCheckInfo(result, userLevel, session?.user?.id || '')
  );

  const consentedCount = results.filter(r => r.consentToShare).length;
  const highStressCount = results.filter(r => r.isHighStress).length;

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœï¼ˆäººäº‹éƒ¨ç”¨ï¼‰</h1>

      <Alert className="mb-6 border-amber-200 bg-amber-50">
        <AlertCircle className="h-4 w-4 text-amber-600" />
        <AlertDescription className="text-amber-800">
          <strong>é‡è¦ï¼š</strong>
          æœ¬äººåŒæ„ãŒã‚ã‚‹çµæœã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          é…æ…®æªç½®ã®æ¤œè¨ç›®çš„ã§ã®ã¿ä½¿ç”¨ã—ã€<strong>äººäº‹è©•ä¾¡ã«ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚</strong>
          <br />
          å…¨ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
        </AlertDescription>
      </Alert>

      {/* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">ç·å—æ¤œè€…æ•°</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{results.length}å</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">åŒæ„æ¸ˆã¿</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">{consentedCount}å</div>
            <p className="text-xs text-gray-500 mt-1">
              {results.length > 0 ? Math.round((consentedCount / results.length) * 100) : 0}%
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">é«˜ã‚¹ãƒˆãƒ¬ã‚¹è€…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">{highStressCount}å</div>
            <p className="text-xs text-gray-500 mt-1">
              {results.length > 0 ? Math.round((highStressCount / results.length) * 100) : 0}%
            </p>
          </CardContent>
        </Card>
      </div>

      {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <div className="flex gap-2 mb-4">
        <Button
          variant={filter === 'all' ? 'default' : 'outline'}
          onClick={() => setFilter('all')}
          size="sm"
        >
          å…¨ã¦
        </Button>
        <Button
          variant={filter === 'consented' ? 'default' : 'outline'}
          onClick={() => setFilter('consented')}
          size="sm"
        >
          åŒæ„æ¸ˆã¿ã®ã¿
        </Button>
        <Button
          variant={filter === 'high-stress' ? 'default' : 'outline'}
          onClick={() => setFilter('high-stress')}
          size="sm"
        >
          é«˜ã‚¹ãƒˆãƒ¬ã‚¹è€…
        </Button>
      </div>

      {/* çµæœãƒ†ãƒ¼ãƒ–ãƒ« */}
      <Card>
        <CardContent className="p-0">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>è·å“¡å</TableHead>
                <TableHead>éƒ¨ç½²</TableHead>
                <TableHead>ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«</TableHead>
                <TableHead>åŒæ„çŠ¶æ³</TableHead>
                <TableHead>è©³ç´°</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={5} className="text-center py-8">
                    èª­ã¿è¾¼ã¿ä¸­...
                  </TableCell>
                </TableRow>
              ) : filteredResults.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={5} className="text-center py-8 text-gray-500">
                    ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                  </TableCell>
                </TableRow>
              ) : (
                filteredResults.map(result => (
                  <TableRow key={result.staffId}>
                    <TableCell className="font-medium">
                      {result.staffName}
                    </TableCell>
                    <TableCell>
                      {result.department}
                    </TableCell>
                    <TableCell>
                      {result.stressLevel ? (
                        <Badge variant={
                          result.stressLevel === 'HIGH' ? 'destructive' :
                          result.stressLevel === 'MEDIUM' ? 'warning' :
                          'default'
                        }>
                          {result.stressLevel === 'HIGH' ? 'é«˜' :
                           result.stressLevel === 'MEDIUM' ? 'ä¸­' : 'ä½'}
                        </Badge>
                      ) : (
                        <span className="text-gray-400">éå…¬é–‹</span>
                      )}
                    </TableCell>
                    <TableCell>
                      {result.consentStatus ? (
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-green-600" />
                          <div className="text-sm">
                            <div className="font-medium text-green-700">åŒæ„æ¸ˆã¿</div>
                            {result.consentDate && (
                              <div className="text-xs text-gray-500">
                                {format(new Date(result.consentDate), 'yyyy/MM/dd', { locale: ja })}
                              </div>
                            )}
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center gap-2">
                          <X className="w-4 h-4 text-gray-400" />
                          <span className="text-sm text-gray-500">åŒæ„ãªã—</span>
                        </div>
                      )}
                    </TableCell>
                    <TableCell>
                      {result.canViewDetails ? (
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => window.location.href = `/stress-check/detail/${result.staffId}`}
                        >
                          <Eye className="w-4 h-4 mr-1" />
                          è©³ç´°
                        </Button>
                      ) : (
                        <span className="text-gray-400 text-sm">é–²è¦§ä¸å¯</span>
                      )}
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* ã‚¢ã‚¯ã‚»ã‚¹ç†ç”±è¡¨ç¤º */}
      {filteredResults.length > 0 && (
        <Alert className="mt-4">
          <AlertDescription className="text-sm">
            <strong>ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ï¼š</strong> {filteredResults[0]?.accessReason || 'ä¸æ˜'}
          </AlertDescription>
        </Alert>
      )}
    </div>
  );
}
```

**APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```typescript
// src/app/api/stress-check/hr-results/route.tsï¼ˆæ–°è¦ä½œæˆï¼‰

import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { getServerSession } from 'next-auth';

export async function GET(req: NextRequest) {
  try {
    const session = await getServerSession();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const userLevel = session.user.accountLevel || 0;

    // Level 14-17ï¼ˆäººäº‹éƒ¨ï¼‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    if (userLevel < 14 || userLevel > 17) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    const { searchParams } = new URL(req.url);
    const filter = searchParams.get('filter') || 'all';

    let whereCondition: any = {};

    if (filter === 'consented') {
      whereCondition.consentToShare = true;
    } else if (filter === 'high-stress') {
      whereCondition.isHighStress = true;
    }

    const results = await prisma.stressCheckResult.findMany({
      where: whereCondition,
      include: {
        staff: {
          select: {
            name: true
          }
        }
      },
      orderBy: {
        checkDate: 'desc'
      }
    });

    // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    await prisma.auditLog.create({
      data: {
        userId: session.user.id,
        action: 'STRESS_CHECK_HR_VIEW',
        category: 'STRESS_CHECK',
        details: JSON.stringify({
          filter,
          resultCount: results.length
        }),
        ipAddress: req.headers.get('x-forwarded-for') || 'unknown'
      }
    });

    return NextResponse.json({ results });
  } catch (error) {
    console.error('HRçµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

**Gitæ“ä½œ**:
```bash
git add src/app/stress-check/hr-view/page.tsx
git add src/app/api/stress-check/hr-results/route.ts
git commit -m "feat: äººäº‹éƒ¨å‘ã‘ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯çµæœè¡¨ç¤ºç”»é¢ã‚’å®Ÿè£…ï¼ˆåŒæ„çŠ¶æ³åˆ¶å¾¡ï¼‰"
git push origin preview/feature-name
```

**ç¢ºèªäº‹é …**:
- [ ] äººäº‹éƒ¨ï¼ˆLevel 14-17ï¼‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‹
- [ ] åŒæ„æ¸ˆã¿çµæœã®ã¿è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
- [ ] åŒæ„ãªã—çµæœã¯éå…¬é–‹è¡¨ç¤ºã•ã‚Œã‚‹ã‹
- [ ] ç›£æŸ»ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã‹

---

## ğŸ”’ Phase 2: ç›£æŸ»ãƒ»é‹ç”¨å¼·åŒ–ï¼ˆè©³ç´°ï¼‰

### Phase 2-1: ç›£æŸ»ãƒ­ã‚°å¼·åŒ–ã®å®Ÿè£…

**ä½œæ¥­å†…å®¹**:
1. ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹å°‚ç”¨ã®ç›£æŸ»ãƒ­ã‚°
2. ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã®ã‚¢ãƒ©ãƒ¼ãƒˆ

**æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«**:
```typescript
// src/lib/audit/stress-check-audit.tsï¼ˆæ–°è¦ä½œæˆï¼‰

interface StressCheckAccessLog {
  timestamp: Date;
  userId: string;
  userLevel: number;
  userRole: string;
  action: 'view' | 'view_details' | 'edit' | 'consent_update';
  targetStaffId: string;
  targetResultId: string;
  consentStatus: boolean;
  accessGranted: boolean;
  accessReason: string;
  ipAddress: string;
}

export async function logStressCheckAccess(log: StressCheckAccessLog) {
  // å…¨ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨˜éŒ²
  await prisma.auditLog.create({
    data: {
      ...log,
      category: 'STRESS_CHECK_ACCESS',
      // åŒæ„ãªã—ã§ã®ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã¯è¦æ³¨æ„
      severity: log.accessGranted && !log.consentStatus && log.userLevel < 98
        ? 'WARNING'
        : 'INFO'
    }
  });

  // ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã®ã‚¢ãƒ©ãƒ¼ãƒˆ
  if (!log.accessGranted && log.action === 'view_details') {
    await sendSecurityAlert({
      type: 'UNAUTHORIZED_STRESS_CHECK_ACCESS',
      userId: log.userId,
      targetStaffId: log.targetStaffId,
      timestamp: log.timestamp,
      details: `Level ${log.userLevel}ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ„ãªã—ã®çµæœã«ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ`
    });
  }
}

async function sendSecurityAlert(alert: any) {
  // VoiceDriveé€šçŸ¥ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  await fetch('/api/notifications/security-alert', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(alert)
  });
}
```

**Gitæ“ä½œ**:
```bash
git add src/lib/audit/stress-check-audit.ts
git commit -m "feat: ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹å°‚ç”¨ã®ç›£æŸ»ãƒ­ã‚°ã‚’å®Ÿè£…"
git push origin preview/feature-name
```

---

### Phase 2-2: åŒæ„çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å®Ÿè£…

**ä½œæ¥­å†…å®¹**:
1. åŒæ„çŠ¶æ³ã®çµ±è¨ˆãƒ»å¯è¦–åŒ–
2. ç”£æ¥­åŒ»ãƒ»å¥è¨ºæ‹…å½“è€…å‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

**æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«**:
```typescript
// src/app/stress-check/consent-dashboard/page.tsxï¼ˆæ–°è¦ä½œæˆï¼‰

'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

export default function ConsentDashboard() {
  const [stats, setStats] = useState<any>(null);

  useEffect(() => {
    fetchConsentStats();
  }, []);

  const fetchConsentStats = async () => {
    const response = await fetch('/api/stress-check/consent-stats');
    const data = await response.json();
    setStats(data);
  };

  if (!stats) return <div>èª­ã¿è¾¼ã¿ä¸­...</div>;

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯åŒæ„çŠ¶æ³</h1>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <Card>
          <CardHeader>
            <CardTitle>åŒæ„ç‡</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold mb-2">
              {stats.consentRate}%
            </div>
            <Progress value={stats.consentRate} className="mb-2" />
            <p className="text-sm text-gray-500">
              {stats.consentedCount} / {stats.totalCount} å
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>é«˜ã‚¹ãƒˆãƒ¬ã‚¹è€…ã®åŒæ„ç‡</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold mb-2">
              {stats.highStressConsentRate}%
            </div>
            <Progress value={stats.highStressConsentRate} className="mb-2" />
            <p className="text-sm text-gray-500">
              {stats.highStressConsentedCount} / {stats.highStressCount} å
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>æœªåŒæ„è€…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-amber-600 mb-2">
              {stats.notConsentedCount}å
            </div>
            <p className="text-sm text-gray-500">
              ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—å¯¾è±¡
            </p>
          </CardContent>
        </Card>
      </div>

      {/* éƒ¨ç½²åˆ¥åŒæ„ç‡ã‚°ãƒ©ãƒ• */}
      <Card>
        <CardHeader>
          <CardTitle>éƒ¨ç½²åˆ¥åŒæ„çŠ¶æ³</CardTitle>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={stats.departmentStats}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="department" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="consentedCount" fill="#10b981" name="åŒæ„æ¸ˆã¿" />
              <Bar dataKey="notConsentedCount" fill="#f59e0b" name="æœªåŒæ„" />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>
    </div>
  );
}
```

**Gitæ“ä½œ**:
```bash
git add src/app/stress-check/consent-dashboard/page.tsx
git commit -m "feat: ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯åŒæ„çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å®Ÿè£…"
git push origin preview/feature-name
```

---

### Phase 2-3: VoiceDriveé€šçŸ¥ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…

**ä½œæ¥­å†…å®¹**:
1. åŒæ„å–å¾—æ™‚ã®äººäº‹éƒ¨ã¸ã®é€šçŸ¥
2. é«˜ã‚¹ãƒˆãƒ¬ã‚¹è€…æ¤œå‡ºæ™‚ã®ç”£æ¥­åŒ»ã¸ã®é€šçŸ¥

**Gitæ“ä½œ**:
```bash
git add src/services/stress-check-notifications.ts
git commit -m "feat: ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯é–¢é€£ã®VoiceDriveé€šçŸ¥ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…"
git push origin preview/feature-name
```

---

## ğŸ“ VoiceDriveä¾é ¼æ›¸ã®æ›´æ–°

Phase 1-5å®Œäº†å¾Œã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ï¼š

```bash
# ä¾é ¼æ›¸ã‚’æ›´æ–°
git add mcp-shared/docs/Account_Level_Definition_Unification_Request_20251004.md
git commit -m "docs: ç‰¹åˆ¥æ¨©é™ãƒ¬ãƒ™ãƒ«ï¼ˆ97-99ï¼‰ã‚’VoiceDriveä¾é ¼æ›¸ã«è¿½åŠ "
git push origin preview/feature-name
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

### å˜ä½“ãƒ†ã‚¹ãƒˆ

- [ ] `checkStressCheckAccess`é–¢æ•°ã®ãƒ†ã‚¹ãƒˆï¼ˆå…¨ã‚±ãƒ¼ã‚¹ï¼‰
- [ ] æœ¬äººåŒæ„API ã®ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ

### çµåˆãƒ†ã‚¹ãƒˆ

- [ ] æœ¬äººã«ã‚ˆã‚‹åŒæ„å–å¾—ãƒ•ãƒ­ãƒ¼
- [ ] äººäº‹éƒ¨ã®è¡¨ç¤ºåˆ¶å¾¡
- [ ] ç”£æ¥­åŒ»ãƒ»å¥è¨ºæ‹…å½“è€…ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™

### E2Eãƒ†ã‚¹ãƒˆ

- [ ] Level 97ã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ åŒæ„ãªã—çµæœã¯é›†å›£åˆ†æã®ã¿
- [ ] Level 98ã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ å…¨çµæœé–²è¦§å¯èƒ½
- [ ] Level 14ã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ åŒæ„æ¸ˆã¿çµæœã®ã¿é–²è¦§å¯èƒ½

---

## ğŸ“Š é€²æ—ç®¡ç†

å„Phaseã®å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’å®Ÿæ–½ï¼š

1. **preview/feature-nameã«push**
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªä¾é ¼**
3. **ç¢ºèªOK â†’ mainã«ãƒãƒ¼ã‚¸**
4. **æ¬¡ã®Phaseã¸é€²ã‚€**

---

## ğŸ¯ æˆåŠŸåŸºæº–

- [ ] Level 97-99ãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] æœ¬äººåŒæ„ãŒãªã„å ´åˆã€äººäº‹éƒ¨ã¯é–²è¦§ä¸å¯
- [ ] æœ¬äººåŒæ„ãŒã‚ã‚‹å ´åˆã€äººäº‹éƒ¨ã¯é–²è¦§å¯èƒ½
- [ ] ç”£æ¥­åŒ»ã¯å¸¸ã«é–²è¦§å¯èƒ½
- [ ] å…¨ã‚¢ã‚¯ã‚»ã‚¹ãŒç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹
- [ ] æ³•ä»¤éµå®ˆï¼ˆåŠ´å®‰æ³•66æ¡ã®10ï¼‰

---

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: Phase 1-1ã‹ã‚‰é †æ¬¡å®Ÿè£…é–‹å§‹

æº–å‚™å®Œäº†ã§ã™ï¼Phase 1-1ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ã‹ï¼Ÿ
