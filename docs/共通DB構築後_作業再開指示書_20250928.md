# å…±é€šDBæ§‹ç¯‰å¾Œ ä½œæ¥­å†é–‹æŒ‡ç¤ºæ›¸

ä½œæˆæ—¥: 2025å¹´9æœˆ28æ—¥
æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ21æ—¥ï¼ˆPhase 8: æ‰¿èªãƒ»å¯¾å¿œç®¡ç†APIå®Ÿè£… è¿½åŠ  - 6.8ç¯€ï¼‰
å¯¾è±¡: åŒ»ç™‚è·å“¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ 
å‰æ: å…±é€šDBã®æ§‹ç¯‰å®Œäº†å¾Œã«æœ¬æ›¸ã‚’å‚ç…§

---

## 1. ä½œæ¥­å†é–‹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ç’°å¢ƒç¢ºèª
- [ ] å…±é€šDBæ¥ç¶šæƒ…å ±ã®å—é ˜
- [ ] VPNã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ç¢ºèª
- [ ] æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™
- [ ] VoiceDriveãƒãƒ¼ãƒ ã¨ã®é€£æºç¢ºèª

### ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ç¢ºèª
- [ ] æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’pull
- [ ] node_moduleså†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆ`npm ci`ï¼‰
- [ ] TypeScriptãƒ“ãƒ«ãƒ‰ç¢ºèªï¼ˆ`npm run build`ï¼‰

---

## 2. Step 1: ç’°å¢ƒè¨­å®šæ›´æ–°

### 2.1 æœ¬ç•ªç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
```bash
# .env.productionã‚’ä½œæˆ
cp .env.example .env.production
```

### 2.2 ç’°å¢ƒå¤‰æ•°è¨­å®š
```env
# .env.production
DATABASE_URL=postgresql://[ãƒ¦ãƒ¼ã‚¶ãƒ¼å]:[ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰]@[ãƒ›ã‚¹ãƒˆ]:[ãƒãƒ¼ãƒˆ]/[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å]
FACILITY_DB_HOST=[å…±é€šDBãƒ›ã‚¹ãƒˆ]
FACILITY_DB_PORT=5432
FACILITY_DB_NAME=[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å]
FACILITY_DB_USER=[ãƒ¦ãƒ¼ã‚¶ãƒ¼å]
FACILITY_DB_PASSWORD=[ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰]

# æ–½è¨­è­˜åˆ¥
DEFAULT_FACILITY_ID=espoir-tategami
MULTI_FACILITY_MODE=true

# Webhookè¨­å®šï¼ˆVoiceDriveé€£æºç”¨ï¼‰
VOICEDRIVE_WEBHOOK_URL=[VoiceDriveãƒãƒ¼ãƒ ã‹ã‚‰æä¾›ã•ã‚Œã‚‹URL]
WEBHOOK_SECRET=[å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼]
WEBHOOK_RETRY_COUNT=3
WEBHOOK_TIMEOUT=5000
```

---

## 3. Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª

### 3.1 æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# DBæ¥ç¶šãƒ†ã‚¹ãƒˆ
npm run test:db:connection

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ
# âœ… facilityãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
# âœ… positionãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
# âœ… staff_authorityãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
```

### 3.2 æ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®å¯¾å‡¦
```bash
# ãƒ­ã‚°ç¢ºèª
tail -f logs/db-connection.log

# ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼:
# - SSLè¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼ â†’ ssl: { rejectUnauthorized: false }ã‚’ä¸€æ™‚çš„ã«è¿½åŠ 
# - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šç¢ºèª
# - èªè¨¼ã‚¨ãƒ©ãƒ¼ â†’ èªè¨¼æƒ…å ±å†ç¢ºèª
```

---

## 4. Step 3: ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

### 4.1 æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼ç™»éŒ²
```sql
-- å®Ÿè¡Œã™ã‚‹SQLï¼ˆ/sql/master-data/facilities.sqlï¼‰
INSERT INTO facilities (facility_id, facility_name, facility_type, staff_count) VALUES
('obara-hospital', 'åŒ»ç™‚æ³•äºº åšç”Ÿä¼š å°åŸç—…é™¢', 'acute', 420),
('tategami-rehabilitation', 'ç«‹ç¥ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¸©æ³‰ç—…é™¢', 'rehabilitation', 180),
('espoir-tategami', 'ä»‹è­·è€äººä¿å¥æ–½è¨­ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥', 'geriatric_health_facility', 150);
```

### 4.2 å½¹è·ãƒã‚¹ã‚¿ãƒ¼ç™»éŒ²
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
npm run db:migrate:production

# ç¢ºèª
npm run db:verify:positions
```

### 4.3 ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
```bash
# 33å½¹è·ã®ä¸€æ‹¬ç™»éŒ²
node scripts/import-espoir-positions.js

# æ¤œè¨¼
node scripts/verify-espoir-data.js
```

---

## 5. Step 4: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½

### 5.1 Phase 3çµ±åˆãƒ†ã‚¹ãƒˆ
```bash
# å®Ÿç’°å¢ƒã§ã®çµ±åˆãƒ†ã‚¹ãƒˆ
NODE_ENV=production node tests/integration/phase3-integration-test.js

# ç¢ºèªé …ç›®:
# - å°åŸç—…é™¢: 9å½¹è·
# - ç«‹ç¥ãƒªãƒãƒ“ãƒª: 12å½¹è·ï¼ˆçµ±æ‹¬ä¸»ä»»ãƒ¬ãƒ™ãƒ«7ï¼‰
# - ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥: 33å½¹è·
```

### 5.2 ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ç‰¹åŒ–ãƒ†ã‚¹ãƒˆ
```bash
# Day 1-3çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:espoir:complete

# å€‹åˆ¥å®Ÿè¡Œ
node tests/integration/run-integration-test.ts  # Day 1
node tests/integration/day2-approval-flow-test.ts  # Day 2
node tests/integration/day3-load-test.ts  # Day 3ï¼ˆä½œæˆè¦ï¼‰
```

### 5.3 å…¼ä»»è·å“¡æ¨©é™ãƒ†ã‚¹ãƒˆ
```bash
# ç‰¹å®šè·å“¡ã®ãƒ†ã‚¹ãƒˆ
node tests/verify-dual-position.js --staff-id ESP_003
node tests/verify-dual-position.js --staff-id ESP_004
```

---

## 6. Step 5: VoiceDriveé€£æºç¢ºèª

### 6.1 Webhookç–é€šç¢ºèª
```bash
# ãƒ†ã‚¹ãƒˆé€ä¿¡
curl -X POST $VOICEDRIVE_WEBHOOK_URL \
  -H "Content-Type: application/json" \
  -H "X-Webhook-Secret: $WEBHOOK_SECRET" \
  -d '{"test": true, "facility": "espoir-tategami"}'
```

### 6.2 ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ
```bash
# åŒæœŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
node scripts/test-voicedrive-sync.js

# ãƒ­ã‚°ç¢ºèª
tail -f logs/voicedrive-sync.log
```

### 6.3 OrganizationAnalytics APIçµ±åˆãƒ†ã‚¹ãƒˆ

**å‰ææ¡ä»¶**:
- âœ… APIå®Ÿè£…å®Œäº†ï¼ˆ2025å¹´10æœˆ10æ—¥ï¼‰
- âœ… å˜ä½“ãƒ†ã‚¹ãƒˆ30ä»¶å…¨ã¦æˆåŠŸï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰
- âœ… APIä»•æ§˜æ›¸æ‰¿èªæ¸ˆã¿ï¼ˆVD-APPROVAL-2025-1010-001ï¼‰
- âœ… å®Ÿè£…å ±å‘Šæ›¸ä½œæˆæ¸ˆã¿ï¼ˆmcp-shared/docs/organization-analytics_APIå®Ÿè£…å®Œäº†å ±å‘Š_20251010.mdï¼‰

#### 6.3.1 ç’°å¢ƒå¤‰æ•°è¨­å®š
```bash
# .env.productionã«è¿½åŠ 
ORGANIZATION_ANALYTICS_API_KEY=[openssl rand -hex 32ã§ç”Ÿæˆã—ãŸAPI Key]

# VoiceDriveå´ã®è¨­å®šç¢ºèªï¼ˆVoiceDriveãƒãƒ¼ãƒ ã«å…±æœ‰ï¼‰
# MEDICAL_SYSTEM_API_URL=https://medical.example.com/api/v2
# MEDICAL_SYSTEM_API_KEY=[ä¸Šè¨˜ã®ORGANIZATION_ANALYTICS_API_KEYã¨åŒã˜å€¤]
```

**API Keyç”Ÿæˆæ–¹æ³•**:
```bash
# ãƒ©ãƒ³ãƒ€ãƒ ãªAPI Keyã‚’ç”Ÿæˆ
openssl rand -hex 32

# ç”Ÿæˆã•ã‚ŒãŸAPI Keyã‚’.env.productionã¨VoiceDriveãƒãƒ¼ãƒ ã«å…±æœ‰
```

#### 6.3.2 å®Ÿãƒ‡ãƒ¼ã‚¿ã§APIå‹•ä½œç¢ºèª
```bash
# API-1: éƒ¨é–€ãƒã‚¹ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/departments?facilityId=facility-001" \
  -H "X-API-Key: ${ORGANIZATION_ANALYTICS_API_KEY}"

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {
#   "data": [
#     {
#       "departmentId": "dept-001",
#       "departmentCode": "D001",
#       "departmentName": "å†…ç§‘",
#       "facilityId": "facility-001",
#       "facilityCode": "F001",
#       "facilityName": "å°åŸç—…é™¢",
#       "parentDepartmentId": null,
#       "level": 1,
#       "createdAt": "2024-01-01T00:00:00.000Z",
#       "updatedAt": "2024-01-01T00:00:00.000Z"
#     }
#   ],
#   "meta": {
#     "total": 9,
#     "timestamp": "2025-10-10T12:00:00.000Z"
#   }
# }

# API-2: è·å“¡æ•°å–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/employees/count?facilityId=facility-001" \
  -H "X-API-Key: ${ORGANIZATION_ANALYTICS_API_KEY}"

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {
#   "data": {
#     "totalCount": 120,
#     "byDepartment": [
#       {
#         "departmentId": "dept-001",
#         "departmentCode": "D001",
#         "departmentName": "å†…ç§‘",
#         "count": 50
#       },
#       {
#         "departmentId": "dept-002",
#         "departmentCode": "D002",
#         "departmentName": "å¤–ç§‘",
#         "count": 70
#       }
#     ]
#   },
#   "meta": {
#     "timestamp": "2025-10-10T12:00:00.000Z",
#     "filters": {
#       "facilityId": "facility-001",
#       "departmentId": null
#     }
#   }
# }

# æ³¨æ„: Phase 1ã§ã¯é›‡ç”¨å½¢æ…‹åˆ¥ã‚«ã‚¦ãƒ³ãƒˆæœªå¯¾å¿œ
# ç†ç”±: employmentTypeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœªå®Ÿè£…ï¼ˆPhase 2ã§å¯¾å¿œäºˆå®šï¼‰
```

#### 6.3.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
```bash
# 401 Unauthorizedï¼ˆAPI Keyæœªæä¾›ï¼‰
curl -X GET "http://localhost:3000/api/v2/departments"
# æœŸå¾…: {"error":{"code":"UNAUTHORIZED","message":"API Key is required"}}

# 401 Unauthorizedï¼ˆä¸æ­£ãªAPI Keyï¼‰
curl -X GET "http://localhost:3000/api/v2/departments" \
  -H "X-API-Key: invalid-key"
# æœŸå¾…: {"error":{"code":"UNAUTHORIZED","message":"Invalid API Key"}}

# 400 Bad Requestï¼ˆPhase 1æœªå¯¾å¿œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
curl -X GET "http://localhost:3000/api/v2/departments?isActive=true" \
  -H "X-API-Key: ${ORGANIZATION_ANALYTICS_API_KEY}"
# æœŸå¾…: {"error":{"code":"BAD_REQUEST","message":"Invalid query parameter","details":"isActive filter is not supported in Phase 1"}}

# 429 Rate Limitè¶…éãƒ†ã‚¹ãƒˆï¼ˆ100å›è¶…éã§ã‚¨ãƒ©ãƒ¼ï¼‰
for i in {1..105}; do
  curl -X GET "http://localhost:3000/api/v2/departments" \
    -H "X-API-Key: ${ORGANIZATION_ANALYTICS_API_KEY}" \
    -H "X-Forwarded-For: 192.168.1.100"
done
# 101å›ç›®ä»¥é™: {"error":{"code":"RATE_LIMIT_EXCEEDED","message":"Too many requests"}}
```

#### 6.3.4 VoiceDriveãƒãƒ¼ãƒ ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ
```bash
# VoiceDriveãƒãƒ¼ãƒ ã«ä»¥ä¸‹ã‚’å…±æœ‰:
# - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL: https://medical.example.com/api/v2
# - VoiceDriveç”¨APIã‚­ãƒ¼: [Slackã§å…±æœ‰]
# - APIä»•æ§˜æ›¸: mcp-shared/docs/organization-analytics_APIä»•æ§˜æ›¸_20251010.yaml

# VoiceDriveãƒãƒ¼ãƒ å´ã§ã®ç¢ºèªäº‹é …:
# 1. OrganizationAnalyticsServiceã§APIã‚’å‘¼ã³å‡ºã—
# 2. çµ„ç¹”å¥åº·åº¦æŒ‡æ¨™ãŒæ­£å¸¸ã«è¨ˆç®—ã•ã‚Œã‚‹ã‹ç¢ºèª
# 3. éƒ¨é–€åˆ¥æ´»æ€§åº¦ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
```

#### 6.3.5 çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†åŸºæº–
- [ ] API-1ï¼ˆéƒ¨é–€ãƒã‚¹ã‚¿ï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] API-2ï¼ˆè·å“¡ç·æ•°ï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] Rate Limitãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ­£å¸¸ã«è¿”å´ã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä»•æ§˜é€šã‚Š
- [ ] VoiceDrive OrganizationAnalyticsãƒšãƒ¼ã‚¸ã§è¡¨ç¤ºç¢ºèª

**æ¨å®šå·¥æ•°**: 2æ—¥é–“ï¼ˆDBæ§‹ç¯‰å¾Œï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- APIä»•æ§˜æ›¸: `mcp-shared/docs/organization-analytics_APIä»•æ§˜æ›¸_20251010.yaml`
- æ‰¿èªæ›¸: `mcp-shared/docs/organization-analytics_APIä»•æ§˜æ›¸æ‰¿èªæ¸ˆã¿_20251010.md`
- å®Ÿè£…å ±å‘Šæ›¸: `mcp-shared/docs/organization-analytics_APIå®Ÿè£…å®Œäº†å ±å‘Š_20251010.md`ï¼ˆâœ… å®Œæˆï¼‰

**å®Ÿè£…æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/lib/middleware/api-key-auth.ts` - API Keyèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- `src/lib/middleware/rate-limiter.ts` - Rate LimitãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- `src/app/api/v2/departments/route.ts` - éƒ¨é–€ãƒã‚¹ã‚¿API
- `src/app/api/v2/employees/count/route.ts` - è·å“¡æ•°API
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«4ä»¶ï¼ˆ30ãƒ†ã‚¹ãƒˆå…¨ã¦æˆåŠŸï¼‰

---

### 6.3.5 ExecutiveReports APIçµ±åˆãƒ†ã‚¹ãƒˆ

**æ¦‚è¦**:
ExecutiveReportsãƒšãƒ¼ã‚¸ã¯ã€OrganizationAnalyticsã¨åŒã˜APIï¼ˆ`GET /api/v2/employees/count`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€è¿½åŠ ã®APIå®Ÿè£…ã¯ä¸è¦ã€‚VoiceDriveå´ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ›ã‚’å®Ÿè£…ã€‚

**å‰ææ¡ä»¶**:
- âœ… APIå®Ÿè£…å®Œäº†ï¼ˆ2025å¹´10æœˆ10æ—¥ï¼‰- OrganizationAnalyticsç”¨ã¨å…±é€š
- âœ… APIåˆ©ç”¨æ‰¿èªæ¸ˆã¿ï¼ˆMEDICAL-APPROVAL-2025-1011-001ï¼‰
- âœ… çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºå®šï¼ˆ2025å¹´10æœˆ25æ—¥ï¼‰

#### çµ±åˆãƒ†ã‚¹ãƒˆæ—¥ç¨‹

**æ—¥æ™‚**: 2025å¹´10æœˆ25æ—¥ï¼ˆé‡‘ï¼‰14:00-16:00
**æ‰€è¦æ™‚é–“**: 2æ™‚é–“
**å‚åŠ è€…**: VoiceDriveãƒãƒ¼ãƒ é–‹ç™ºæ‹…å½“2å + åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ æ‹…å½“è€…
**å®Ÿæ–½æ–¹æ³•**: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆTeams/Zoomï¼‰

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªï¼ˆ5ã‚·ãƒŠãƒªã‚ªã€20ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰

**ã‚·ãƒŠãƒªã‚ª1: APIèªè¨¼ãƒ†ã‚¹ãƒˆ**ï¼ˆ15åˆ†ï¼‰
- TC-1.1: æ­£å¸¸ãªèªè¨¼ï¼ˆJWT + API Keyï¼‰
- TC-1.2: JWT Tokenç„¡åŠ¹
- TC-1.3: API Keyç„¡åŠ¹
- TC-1.4: èªè¨¼ãƒ˜ãƒƒãƒ€ãªã—

**ã‚·ãƒŠãƒªã‚ª2: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼æ¤œè¨¼**ï¼ˆ20åˆ†ï¼‰
- TC-2.1: å…¨è·å“¡æ•°å–å¾—
- TC-2.2: éƒ¨é–€åˆ¥ã‚«ã‚¦ãƒ³ãƒˆå–å¾—
- TC-2.3: æ–½è¨­çµã‚Šè¾¼ã¿
- TC-2.4: éƒ¨é–€çµã‚Šè¾¼ã¿
- TC-2.5: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼

**ã‚·ãƒŠãƒªã‚ª3: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ¤œè¨¼**ï¼ˆ25åˆ†ï¼‰
- TC-3.1: Rate Limitè¶…é
- TC-3.2: DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆä»»æ„ï¼‰
- TC-3.3: ä¸æ­£ãªã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- TC-3.4: å­˜åœ¨ã—ãªã„æ–½è¨­ID

**ã‚·ãƒŠãƒªã‚ª4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**ï¼ˆ30åˆ†ï¼‰
- TC-4.1: å˜ç™ºãƒªã‚¯ã‚¨ã‚¹ãƒˆå¿œç­”æ™‚é–“ï¼ˆ< 500msï¼‰
- TC-4.2: 50ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€£ç¶šå®Ÿè¡Œ
- TC-4.3: åŒæ™‚æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆ5ä¸¦åˆ—ï¼‰
- TC-4.4: å¤§é‡ãƒ‡ãƒ¼ã‚¿æ™‚ã®å¿œç­”æ™‚é–“ï¼ˆ< 1000msï¼‰

**ã‚·ãƒŠãƒªã‚ª5: VoiceDriveçµ±åˆãƒ†ã‚¹ãƒˆ**ï¼ˆ30åˆ†ï¼‰
- TC-5.1: KPIå‚åŠ ç‡è¨ˆç®—
- TC-5.2: æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
- TC-5.3: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
- TC-5.4: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™

#### åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®æº–å‚™äº‹é …

```bash
# ãƒ†ã‚¹ãƒˆç’°å¢ƒURLç¢ºèª
https://medical-staging.example.com

# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆæ¨å¥¨ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã§ååˆ†ãªå ´åˆã¯ä¸è¦ï¼‰
# - è·å“¡ç·æ•°: 150åç¨‹åº¦
# - éƒ¨é–€: 5éƒ¨é–€ä»¥ä¸Š
# - æ–½è¨­: 2æ–½è¨­ä»¥ä¸Š
```

**åˆæ ¼åŸºæº–**:
- [ ] å…¨20ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æˆåŠŸ
- [ ] APIå¿œç­”æ™‚é–“ < 500msï¼ˆå˜ç™ºï¼‰ã€< 1000msï¼ˆå¤§é‡ãƒ‡ãƒ¼ã‚¿ï¼‰
- [ ] Rate Limitæ­£å¸¸å‹•ä½œç¢ºèª
- [ ] VoiceDrive ExecutiveReportServiceã®æ­£å¸¸å‹•ä½œç¢ºèª

**æ¨å®šå·¥æ•°**: 2æ™‚é–“ï¼ˆ2025å¹´10æœˆ25æ—¥ï¼‰

**å®Ÿè£…çŠ¶æ³**:
- âœ… APIå®Ÿè£…å®Œäº†ï¼ˆ2025-10-10ï¼‰- OrganizationAnalyticsã¨å…±é€š
- âœ… APIåˆ©ç”¨æ‰¿èªï¼ˆ2025-10-11ï¼‰
- âœ… çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºå®šï¼ˆ10æœˆ25æ—¥ï¼‰
- â³ çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½å¾…ã¡ï¼ˆ10æœˆ25æ—¥äºˆå®šï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [executive-reports_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/executive-reports_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)
- [executive-reports_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ æ‰¿èªå›ç­”_20251011.md](../mcp-shared/docs/executive-reports_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ æ‰¿èªå›ç­”_20251011.md)
- VD-SCHEDULE-2025-1011-001ï¼ˆVoiceDriveãƒãƒ¼ãƒ ä½œæˆï¼‰

---

### 6.3.6 BoardPreparation & VoiceDriveå´å®Ÿè£…ã‚¿ã‚¹ã‚¯

**æ¦‚è¦**:
BoardPreparationãƒšãƒ¼ã‚¸ã‚‚ã€OrganizationAnalytics/ExecutiveReportsã¨åŒã˜APIï¼ˆ`GET /api/v2/employees/count`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã§è¿½åŠ ã®APIå®Ÿè£…ã¯ä¸è¦ã€‚VoiceDriveå´ã§ä»¥ä¸‹ã®å®Ÿè£…ãŒå¿…è¦ã€‚

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å¯¾å¿œ**:
- âœ… APIå®Ÿè£…å®Œäº†ï¼ˆ2025å¹´10æœˆ10æ—¥ï¼‰- OrganizationAnalyticsç”¨ã¨å…±é€š
- âœ… ç¢ºèªçµæœãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæ¸ˆã¿ï¼ˆ2025å¹´10æœˆ11æ—¥ï¼‰
- âŒ è¿½åŠ å®Ÿè£…ä¸è¦

**VoiceDriveå´ã®å®Ÿè£…ã‚¿ã‚¹ã‚¯**:

#### ã‚¿ã‚¹ã‚¯1: ExecutiveReports ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ›å®Ÿè£…

```typescript
// VoiceDrive: src/services/MedicalSystemClient.ts
export async function getEmployeeCountForReports() {
  const response = await fetch('/api/v2/employees/count', {
    headers: {
      'Authorization': `Bearer ${JWT_TOKEN}`,
      'X-API-Key': API_KEY
    }
  });

  const data = await response.json();

  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ›
  return {
    totalEmployees: data.data.totalCount,  // â† ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åå¤‰æ›
    byDepartment: data.data.byDepartment.reduce((acc, dept) => {
      acc[dept.departmentName] = dept.count;
      return acc;
    }, {}),
    activeOnly: true,
    calculatedAt: data.meta.timestamp
  };
}
```

**å®Ÿè£…æœŸé–“**: 1æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸ”´ HIGH

---

#### ã‚¿ã‚¹ã‚¯2: ReportDistributionGroup ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```prisma
// VoiceDrive: schema.prisma
model ReportDistributionGroup {
  id          String   @id @default(cuid())
  groupKey    String   @unique              // "board-members", "executives"
  groupName   String                        // "ç†äº‹ä¼šãƒ¡ãƒ³ãƒãƒ¼", "çµŒå–¶å¹¹éƒ¨"
  description String?

  // ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã®Employee IDã‚’æ ¼ç´ï¼‰
  memberIds   Json                           // ["EMP001", "EMP002", ...]

  // é…å¸ƒè¨­å®š
  autoSend    Boolean  @default(false)       // è‡ªå‹•é…å¸ƒON/OFF
  sendTiming  String?                        // "immediately", "scheduled"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("report_distribution_groups")
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
```bash
npx prisma migrate dev --name add_report_distribution_group
```

**åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥**:
```typescript
// VoiceDrive: prisma/seed.ts
await prisma.reportDistributionGroup.createMany({
  data: [
    {
      groupKey: 'board-members',
      groupName: 'ç†äº‹ä¼šãƒ¡ãƒ³ãƒãƒ¼',
      memberIds: ['EMP001', 'EMP002', 'EMP003'],
      autoSend: true,
      sendTiming: 'immediately'
    },
    {
      groupKey: 'executives',
      groupName: 'çµŒå–¶å¹¹éƒ¨',
      memberIds: ['EMP010', 'EMP011', 'EMP012', 'EMP013'],
      autoSend: false
    }
  ]
});
```

**å®Ÿè£…æœŸé–“**: 1æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸ”´ HIGH

---

#### ã‚¿ã‚¹ã‚¯3: S3 Lifecycle Policyè¨­å®šï¼ˆå…¨æœŸé–“ä¿å­˜ï¼‰

```json
// AWS S3ã‚³ãƒ³ã‚½ãƒ¼ãƒ« or AWS CLI
{
  "Rules": [
    {
      "Id": "BoardMeetingDocuments-Lifecycle",
      "Prefix": "board-meetings/",
      "Status": "Enabled",
      "Transitions": [
        { "Days": 1095, "StorageClass": "GLACIER" }
      ]
      // Expirationè¨­å®šãªã— = å…¨æœŸé–“ä¿å­˜
      // ç†ç”±: Phase 18 VoiceAnalyticsã€Phase 19 CultureDevelopmentã¨åŒã˜ãƒãƒªã‚·ãƒ¼
    },
    {
      "Id": "ExecutiveReports-Lifecycle",
      "Prefix": "reports/board/",
      "Status": "Enabled",
      "Transitions": [
        { "Days": 1095, "StorageClass": "GLACIER" }
      ]
      // Expirationè¨­å®šãªã— = å…¨æœŸé–“ä¿å­˜ï¼ˆè·å“¡æƒ…å ±å«ã‚€ï¼‰
    },
    {
      "Id": "ChairmanProposals-Lifecycle",
      "Prefix": "chairman-proposals/",
      "Status": "Enabled",
      "Transitions": [
        { "Days": 365, "StorageClass": "GLACIER" }
      ]
      // Expirationè¨­å®šãªã— = å…¨æœŸé–“ä¿å­˜
    }
  ]
}
```

**è¨­å®šæ–¹æ³•**:
```bash
# AWS CLI
aws s3api put-bucket-lifecycle-configuration \
  --bucket voicedrive-documents \
  --lifecycle-configuration file://lifecycle-policy.json
```

**å®Ÿè£…æœŸé–“**: 0.5æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUM

---

#### ã‚¿ã‚¹ã‚¯4: BoardPreparation çµ±åˆå®Ÿè£…

VoiceDriveå´ã§ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®Ÿè£…ï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã¯é–¢ä¸ãªã—ï¼‰:

```prisma
// VoiceDrive: schema.prisma

model BoardMeeting {
  id                  String    @id @default(cuid())
  meetingDate         DateTime
  meetingType         String    // 'regular' | 'extraordinary'
  fiscalYear          Int
  quarterNumber       Int?
  status              String    @default("planning") // 'planning' | 'confirmed' | 'completed'

  agendas             BoardMeetingAgenda[]

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("board_meetings")
}

model BoardAgendaCandidateSelection {
  id                  String    @id @default(cuid())
  agendaId            String
  selectedBy          String    // User.id
  selectionReason     String?
  priorityScore       Int       @default(5)
  selectedAt          DateTime  @default(now())

  agenda              BoardMeetingAgenda @relation(fields: [agendaId], references: [id])
  selector            User      @relation(fields: [selectedBy], references: [id])

  @@unique([agendaId, selectedBy])
  @@map("board_agenda_candidate_selections")
}

model ChairmanProposal {
  id                  String    @id @default(cuid())
  proposalTitle       String
  proposalType        String    // 'agenda-addition' | 'agenda-removal' | 'priority-change'
  targetAgendaId      String?
  proposalReason      String
  proposedBy          String    // User.id
  proposedAt          DateTime  @default(now())
  status              String    @default("pending") // 'pending' | 'approved' | 'rejected'

  targetAgenda        BoardMeetingAgenda? @relation(fields: [targetAgendaId], references: [id])
  proposer            User      @relation(fields: [proposedBy], references: [id])

  @@map("chairman_proposals")
}

// BoardMeetingAgendaãƒ†ãƒ¼ãƒ–ãƒ«ã«æº–å‚™çŠ¶æ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
model BoardMeetingAgenda {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  // ğŸ†• æº–å‚™çŠ¶æ³ç®¡ç†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  preparationStatus          String?   @default("not-started") // 'not-started' | 'in-progress' | 'review' | 'completed'
  documentDraftStatus        String?   @default("not-started")
  presentationDraftStatus    String?   @default("not-started")
  documentS3Key              String?
  presentationS3Key          String?
  documentUploadedAt         DateTime?
  presentationUploadedAt     DateTime?
  responsibleDepartment      String?
  responsibleUserId          String?
  dueDate                    DateTime?

  candidateSelections        BoardAgendaCandidateSelection[]
  chairmanProposals          ChairmanProposal[]

  @@map("board_meeting_agendas")
}

// Userãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
model User {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  agendaCandidateSelections  BoardAgendaCandidateSelection[]
  chairmanProposals          ChairmanProposal[]

  @@map("users")
}
```

**å®Ÿè£…æœŸé–“**: 5æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUMï¼ˆExecutiveReportsã®å¾Œï¼‰

---

#### VoiceDriveå®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| ã‚¿ã‚¹ã‚¯ | å®Ÿè£…æœŸé–“ | å„ªå…ˆåº¦ | å‚™è€ƒ |
|--------|---------|--------|------|
| **ã‚¿ã‚¹ã‚¯1**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ› | 1æ—¥ | ğŸ”´ HIGH | ExecutiveReports/BoardPreparationå…±é€š |
| **ã‚¿ã‚¹ã‚¯2**: ReportDistributionGroup | 1æ—¥ | ğŸ”´ HIGH | ExecutiveReportsç”¨ |
| **ã‚¿ã‚¹ã‚¯3**: S3 Lifecycle Policy | 0.5æ—¥ | ğŸŸ¡ MEDIUM | ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®š |
| **ã‚¿ã‚¹ã‚¯4**: BoardPreparation DBè¨­è¨ˆ | 5æ—¥ | ğŸŸ¡ MEDIUM | Phase 2ã§å®Ÿè£… |

**åˆè¨ˆ**: 7.5æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œã«å®Ÿæ–½ï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [board-preparation_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/board-preparation_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)
- [executive-reports_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/executive-reports_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)
- Phase 18 VoiceAnalyticsã€Phase 19 CultureDevelopmentï¼ˆå…¨æœŸé–“ä¿å­˜ãƒãƒªã‚·ãƒ¼å‚è€ƒï¼‰

---

### 6.3.7 BoardAgendaReview VoiceDriveå´å®Ÿè£…ã‚¿ã‚¹ã‚¯

**æ¦‚è¦**:
BoardAgendaReviewãƒšãƒ¼ã‚¸ã¯ã€Level 17ï¼ˆæˆ¦ç•¥ä¼ç”»éƒ¨é•·ãƒ»äººäº‹éƒ¨é•·ï¼‰ãŒæº–å‚™ã—ãŸç†äº‹ä¼šè­°é¡Œã‚’Level 18ï¼ˆç†äº‹é•·ãƒ»æ³•äººäº‹å‹™å±€é•·ï¼‰ãŒäº‹å‰ç¢ºèªãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹æ©Ÿèƒ½ã€‚å®Œå…¨ã«VoiceDriveå†…éƒ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã‚ã‚Šã€åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã€‚

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å¯¾å¿œ**:
- âœ… ç¢ºèªçµæœãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæ¸ˆã¿ï¼ˆ2025å¹´10æœˆ11æ—¥ï¼‰
- âŒ è¿½åŠ å®Ÿè£…ä¸è¦ï¼ˆVoiceDriveå†…éƒ¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãŸã‚ï¼‰

**VoiceDriveå´ã®å®Ÿè£…ã‚¿ã‚¹ã‚¯**:

#### ã‚¿ã‚¹ã‚¯1: BoardMeetingAgendaãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µï¼ˆç†äº‹é•·ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰

```sql
-- VoiceDrive: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
ALTER TABLE `board_meeting_agendas`
ADD COLUMN `key_points` JSON NULL AFTER `document_urls`,
ADD COLUMN `expected_discussion` TEXT NULL AFTER `key_points`,
ADD COLUMN `required_decision` TEXT NULL AFTER `expected_discussion`,
ADD COLUMN `chairman_review` VARCHAR(191) NULL DEFAULT 'pending' AFTER `required_decision`,
ADD COLUMN `chairman_comment` TEXT NULL AFTER `chairman_review`,
ADD COLUMN `chairman_reviewed_by` VARCHAR(191) NULL AFTER `chairman_comment`,
ADD COLUMN `chairman_reviewed_at` DATETIME(3) NULL AFTER `chairman_reviewed_by`;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX `idx_bma_chairman_review` ON `board_meeting_agendas`(`chairman_review`);
CREATE INDEX `idx_bma_chairman_reviewed_at` ON `board_meeting_agendas`(`chairman_reviewed_at`);
CREATE INDEX `idx_bma_meeting_review` ON `board_meeting_agendas`(`board_meeting_id`, `chairman_review`);

-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„è¿½åŠ 
ALTER TABLE `board_meeting_agendas`
ADD CONSTRAINT `fk_bma_chairman_reviewed_by`
FOREIGN KEY (`chairman_reviewed_by`) REFERENCES `users`(`id`)
ON DELETE SET NULL ON UPDATE CASCADE;
```

**Prismaã‚¹ã‚­ãƒ¼ãƒ**:
```prisma
// VoiceDrive: schema.prisma
model BoardMeetingAgenda {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆBoardPreparationã§è¿½åŠ æ¸ˆã¿ï¼‰

  // ğŸ†• ç†äº‹é•·ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆBoardAgendaReviewï¼‰
  keyPoints            Json?      // ["ã‚¹ã‚³ã‚¢74ç‚¹(å‰æœŸæ¯”+6ç‚¹)", ...]
  expectedDiscussion   String?    @db.Text
  requiredDecision     String?    @db.Text
  chairmanReview       String?    @default("pending") // 'pending' | 'approved' | 'needs_revision' | 'rejected'
  chairmanComment      String?    @db.Text
  chairmanReviewedBy   String?
  chairmanReviewedAt   DateTime?

  chairmanReviewer     User?      @relation("AgendaChairmanReviewer", fields: [chairmanReviewedBy], references: [id])

  @@map("board_meeting_agendas")
}

model User {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  reviewedAgendas      BoardMeetingAgenda[]  @relation("AgendaChairmanReviewer")

  @@map("users")
}
```

**å®Ÿè£…æœŸé–“**: 1æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œã€BoardPreparationãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUMï¼ˆBoardPreparationã®å¾Œï¼‰

---

#### ã‚¿ã‚¹ã‚¯2: BoardAgendaReviewServiceå®Ÿè£…

```typescript
// VoiceDrive: src/services/BoardAgendaReviewService.ts
class BoardAgendaReviewService {
  // æ¬¡å›ç†äº‹ä¼šã®è­°é¡Œä¸€è¦§ã‚’å–å¾—
  async getAgendasForReview(
    boardMeetingId: string
  ): Promise<BoardMeetingAgenda[]> {
    return await prisma.boardMeetingAgenda.findMany({
      where: { boardMeetingId },
      orderBy: { agendaOrder: 'asc' },
      include: {
        presenter: true,
        chairmanReviewer: true
      }
    });
  }

  // ç†äº‹é•·ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
  async submitChairmanReview(
    agendaId: string,
    reviewData: {
      status: 'approved' | 'needs_revision' | 'rejected';
      comment?: string;
      reviewedBy: string;
    }
  ): Promise<BoardMeetingAgenda> {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³1: ä¿®æ­£ä¾é ¼ãƒ»å´ä¸‹æ™‚ã¯ã‚³ãƒ¡ãƒ³ãƒˆå¿…é ˆ
    if (
      (reviewData.status === 'needs_revision' ||
       reviewData.status === 'rejected') &&
      !reviewData.comment
    ) {
      throw new Error('ä¿®æ­£ä¾é ¼ã¾ãŸã¯å´ä¸‹æ™‚ã¯ã‚³ãƒ¡ãƒ³ãƒˆãŒå¿…é ˆã§ã™');
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³2: ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿è­°é¡Œã¯å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸å¯
    const agenda = await prisma.boardMeetingAgenda.findUnique({
      where: { id: agendaId }
    });

    if (agenda.chairmanReview && agenda.chairmanReview !== 'pending') {
      throw new Error('ã“ã®è­°é¡Œã¯æ—¢ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿ã§ã™');
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³3: Level 18æ¨©é™ãƒã‚§ãƒƒã‚¯
    const reviewer = await prisma.user.findUnique({
      where: { id: reviewData.reviewedBy }
    });

    if (reviewer.permissionLevel < 18) {
      throw new ForbiddenError('ç†äº‹ä¼šè­°é¡Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
    }

    // ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
    const result = await prisma.boardMeetingAgenda.update({
      where: { id: agendaId },
      data: {
        chairmanReview: reviewData.status,
        chairmanComment: reviewData.comment,
        chairmanReviewedBy: reviewData.reviewedBy,
        chairmanReviewedAt: new Date()
      }
    });

    // Level 17ã¸ã®é€šçŸ¥é€ä¿¡
    await this.notifyLevel17(agendaId, reviewData);

    // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    await auditLog.create({
      userId: reviewData.reviewedBy,
      action: 'CHAIRMAN_REVIEW_AGENDA',
      resource: agendaId,
      details: { status: reviewData.status, comment: reviewData.comment }
    });

    return result;
  }

  // Level 17ã¸ã®é€šçŸ¥
  async notifyLevel17(
    agendaId: string,
    reviewResult: { status: string; comment?: string }
  ): Promise<void> {
    const agenda = await prisma.boardMeetingAgenda.findUnique({
      where: { id: agendaId },
      include: { presenter: true }
    });

    const notificationMessage =
      reviewResult.status === 'approved'
        ? `ç†äº‹ä¼šè­°é¡Œã€Œ${agenda.item}ã€ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚`
        : reviewResult.status === 'needs_revision'
        ? `ç†äº‹ä¼šè­°é¡Œã€Œ${agenda.item}ã€ã®ä¿®æ­£ä¾é ¼ãŒã‚ã‚Šã¾ã™ã€‚ç†äº‹é•·ã‚³ãƒ¡ãƒ³ãƒˆ: ${reviewResult.comment}`
        : `ç†äº‹ä¼šè­°é¡Œã€Œ${agenda.item}ã€ãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸã€‚ç†äº‹é•·ã‚³ãƒ¡ãƒ³ãƒˆ: ${reviewResult.comment}`;

    // è­°é¡Œä½œæˆè€…ï¼ˆLevel 17ï¼‰ã«é€šçŸ¥
    await prisma.notification.create({
      data: {
        userId: agenda.presenterId,
        category: 'board_agenda_review',
        title: 'ç†äº‹ä¼šè­°é¡Œãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ',
        message: notificationMessage,
        link: '/board-preparation',
        priority: reviewResult.status === 'approved' ? 'normal' : 'high',
        isRead: false
      }
    });

    // Level 17å…¨å“¡ã«ã‚‚é€šçŸ¥
    const level17Users = await prisma.user.findMany({
      where: { permissionLevel: { gte: 17, lt: 18 } }
    });

    for (const user of level17Users) {
      if (user.id !== agenda.presenterId) {
        await prisma.notification.create({
          data: {
            userId: user.id,
            category: 'board_agenda_review',
            title: 'ç†äº‹ä¼šè­°é¡Œãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼ˆå‚è€ƒï¼‰',
            message: notificationMessage,
            link: '/board-preparation',
            priority: 'normal',
            isRead: false
          }
        });
      }
    }
  }

  // ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ±è¨ˆã‚’å–å¾—
  async getReviewStats(boardMeetingId: string): Promise<ReviewStats> {
    const agendas = await prisma.boardMeetingAgenda.findMany({
      where: { boardMeetingId }
    });

    const totalAgendas = agendas.length;
    const approvedCount = agendas.filter(a => a.chairmanReview === 'approved').length;
    const needsRevisionCount = agendas.filter(a => a.chairmanReview === 'needs_revision').length;
    const rejectedCount = agendas.filter(a => a.chairmanReview === 'rejected').length;
    const pendingCount = agendas.filter(a => !a.chairmanReview || a.chairmanReview === 'pending').length;

    return {
      totalAgendas,
      approvedCount,
      needsRevisionCount,
      rejectedCount,
      pendingCount,
      completionRate: ((approvedCount + needsRevisionCount + rejectedCount) / totalAgendas) * 100
    };
  }
}
```

**å®Ÿè£…æœŸé–“**: 2æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUM

---

#### ã‚¿ã‚¹ã‚¯3: APIå®Ÿè£…ï¼ˆ5ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰

```typescript
// VoiceDrive: src/app/api/board-agenda-review/[...]/route.ts

// 1. GET /api/board-agenda-review/:boardMeetingId/agendas - è­°é¡Œä¸€è¦§å–å¾—
export async function GET(
  req: Request,
  { params }: { params: { boardMeetingId: string } }
) {
  const user = await authenticate(req);
  if (user.permissionLevel < 18) {
    return Response.json({ error: 'Forbidden' }, { status: 403 });
  }

  const agendas = await service.getAgendasForReview(params.boardMeetingId);
  return Response.json(agendas);
}

// 2. GET /api/board-agenda-review/agendas/:agendaId - è­°é¡Œè©³ç´°å–å¾—
// 3. POST /api/board-agenda-review/agendas/:agendaId/review - ç†äº‹é•·ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
// 4. GET /api/board-agenda-review/:boardMeetingId/stats - ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ±è¨ˆå–å¾—
// 5. GET /api/board-agenda-review/next-meeting - æ¬¡å›ç†äº‹ä¼šæƒ…å ±å–å¾—
```

**å®Ÿè£…æœŸé–“**: 1æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUM

---

#### ã‚¿ã‚¹ã‚¯4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

```typescript
// VoiceDrive: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

// 1. AgendaReviewCard - è­°é¡Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰
// 2. ReviewStatusBadge - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
const getStatusStyle = (status: string) => {
  switch (status) {
    case 'pending':
      return { bg: 'yellow-100', text: 'yellow-800', label: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡' };
    case 'approved':
      return { bg: 'green-100', text: 'green-800', label: 'æ‰¿èªæ¸ˆã¿' };
    case 'needs_revision':
      return { bg: 'orange-100', text: 'orange-800', label: 'ä¿®æ­£ä¾é ¼' };
    case 'rejected':
      return { bg: 'red-100', text: 'red-800', label: 'å´ä¸‹' };
  }
};

// 3. ReviewCommentDialog - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
// 4. MeetingSummaryCards - ç†äº‹ä¼šã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰

// 5. useBoardAgendaReview - ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
const useBoardAgendaReview = (boardMeetingId: string) => {
  const { data: agendas, isLoading, error } = useSWR(
    `/api/board-agenda-review/${boardMeetingId}/agendas`,
    fetcher
  );

  const submitReview = async (
    agendaId: string,
    status: 'approved' | 'needs_revision' | 'rejected',
    comment?: string
  ) => {
    await fetch(`/api/board-agenda-review/agendas/${agendaId}/review`, {
      method: 'POST',
      body: JSON.stringify({ status, comment })
    });
    mutate();
  };

  return { agendas, isLoading, error, submitReview };
};
```

**å®Ÿè£…æœŸé–“**: 2æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUM

---

#### ã‚¿ã‚¹ã‚¯5: é‹ç”¨å®Ÿè£…ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æœŸé™ç®¡ç†ãƒ»ç›£è¦–ï¼‰

```typescript
// VoiceDrive: ãƒãƒƒãƒå‡¦ç†å®Ÿè£…

// 1. ç†äº‹ä¼š3æ—¥å‰ã«ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥
async function sendReviewReminder() {
  const threeDaysLater = new Date();
  threeDaysLater.setDate(threeDaysLater.getDate() + 3);

  const upcomingMeetings = await prisma.boardMeeting.findMany({
    where: {
      meetingDate: { gte: new Date(), lte: threeDaysLater },
      status: 'planning'
    },
    include: { agendas: true }
  });

  for (const meeting of upcomingMeetings) {
    const pendingAgendas = meeting.agendas.filter(
      a => a.chairmanReview === 'pending'
    );

    if (pendingAgendas.length > 0) {
      // Level 18ã«é€šçŸ¥
      await notifyLevel18({
        title: 'ç†äº‹ä¼šè­°é¡Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼',
        message: `${meeting.meetingDate.toLocaleDateString('ja-JP')}ã®ç†äº‹ä¼šã¾ã§3æ—¥ã§ã™ã€‚æœªãƒ¬ãƒ“ãƒ¥ãƒ¼è­°é¡ŒãŒ${pendingAgendas.length}ä»¶ã‚ã‚Šã¾ã™ã€‚`,
        priority: 'high'
      });
    }
  }
}

// æ¯æ—¥åˆå‰9æ™‚ã«å®Ÿè¡Œï¼ˆcron: 0 9 * * *ï¼‰

// 2. ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ç‡ã®ç›£è¦–
async function monitorReviewCompletionRate() {
  const upcomingMeetings = await prisma.boardMeeting.findMany({
    where: {
      meetingDate: { gte: new Date() },
      status: 'planning'
    },
    include: { agendas: true }
  });

  for (const meeting of upcomingMeetings) {
    const totalAgendas = meeting.agendas.length;
    const reviewedAgendas = meeting.agendas.filter(
      a => a.chairmanReview && a.chairmanReview !== 'pending'
    ).length;

    const completionRate = reviewedAgendas / totalAgendas;
    const daysUntilMeeting = Math.ceil(
      (meeting.meetingDate.getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)
    );

    // ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶: ç†äº‹ä¼šã¾ã§3æ—¥ã‚’åˆ‡ã‚Šã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ç‡80%æœªæº€
    if (daysUntilMeeting < 3 && completionRate < 0.8) {
      await notifySlack({
        channel: '#board-meeting-alerts',
        message: `:warning: ç†äº‹ä¼šã¾ã§${daysUntilMeeting}æ—¥ã§ã™ãŒã€è­°é¡Œãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ç‡ãŒ${(completionRate * 100).toFixed(1)}%ã§ã™ï¼ˆ${reviewedAgendas}/${totalAgendas}ä»¶ï¼‰`
      });
    }
  }
}

// æ¯æ—¥åˆå‰10æ™‚ã€åˆå¾Œ3æ™‚ã«å®Ÿè¡Œ
```

**å®Ÿè£…æœŸé–“**: 1æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¢ LOWï¼ˆPhase 2ã§å®Ÿè£…ï¼‰

---

#### VoiceDriveå®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆBoardAgendaReviewï¼‰

| ã‚¿ã‚¹ã‚¯ | å®Ÿè£…æœŸé–“ | å„ªå…ˆåº¦ | å‚™è€ƒ |
|--------|---------|--------|------|
| **ã‚¿ã‚¹ã‚¯1**: BoardMeetingAgendaãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ | 1æ—¥ | ğŸŸ¡ MEDIUM | BoardPreparationå¾Œã«å®Ÿè£… |
| **ã‚¿ã‚¹ã‚¯2**: BoardAgendaReviewService | 2æ—¥ | ğŸŸ¡ MEDIUM | ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œãƒ»é€šçŸ¥æ©Ÿèƒ½ |
| **ã‚¿ã‚¹ã‚¯3**: APIå®Ÿè£…ï¼ˆ5ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰ | 1æ—¥ | ğŸŸ¡ MEDIUM | Level 18æ¨©é™ãƒã‚§ãƒƒã‚¯ |
| **ã‚¿ã‚¹ã‚¯4**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£… | 2æ—¥ | ğŸŸ¡ MEDIUM | 4ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ + 1ãƒ•ãƒƒã‚¯ |
| **ã‚¿ã‚¹ã‚¯5**: é‹ç”¨å®Ÿè£…ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ»ç›£è¦–ï¼‰ | 1æ—¥ | ğŸŸ¢ LOW | Phase 2ã§å®Ÿè£… |

**åˆè¨ˆ**: 7æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œã«å®Ÿæ–½ã€BoardPreparationå®Ÿè£…å¾Œï¼‰

**ãƒ†ã‚¹ãƒˆè¦ä»¶**:
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 15ã‚±ãƒ¼ã‚¹ä»¥ä¸Š
- APIçµ±åˆãƒ†ã‚¹ãƒˆ: 10ã‚±ãƒ¼ã‚¹ä»¥ä¸Š
- ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: 1ã‚±ãƒ¼ã‚¹ï¼ˆLevel 17 â†’ Level 18 ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [board-agenda-review_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/board-agenda-review_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)
- [board-preparation_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/board-preparation_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)
- BoardPreparationã¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é€£æºï¼ˆLevel 17 â†’ Level 18ï¼‰

---

### 6.3.8 BoardDecisionFollow VoiceDriveå´å®Ÿè£…ã‚¿ã‚¹ã‚¯

**æ¦‚è¦**:
BoardDecisionFollowãƒšãƒ¼ã‚¸ã¯ã€ç†äº‹ä¼šã§æ±ºå®šã•ã‚ŒãŸäº‹é …ã®å®Ÿæ–½é€²æ—ã‚’è¿½è·¡ãƒ»ç®¡ç†ã™ã‚‹æ©Ÿèƒ½ã€‚VoiceDriveå†…éƒ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†æ©Ÿèƒ½ã§ã‚ã‚Šã€åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢å­˜APIï¼ˆfacilities, departmentsï¼‰ã®ã¿ä½¿ç”¨ã€‚

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å¯¾å¿œ**:
- âœ… ç¢ºèªçµæœãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæ¸ˆã¿ï¼ˆ2025å¹´10æœˆ11æ—¥ï¼‰
- âŒ è¿½åŠ å®Ÿè£…ä¸è¦ï¼ˆVoiceDriveå†…éƒ¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†æ©Ÿèƒ½ã®ãŸã‚ï¼‰
- âœ… æ—¢å­˜APIåˆ©ç”¨ï¼ˆGET /api/v2/facilities, GET /api/v2/departmentsï¼‰

**VoiceDriveå´ã®å®Ÿè£…ã‚¿ã‚¹ã‚¯**:

#### ã‚¿ã‚¹ã‚¯1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼ˆ3ãƒ†ãƒ¼ãƒ–ãƒ«æ–°è¦ä½œæˆï¼‰

```prisma
// VoiceDrive: schema.prisma

// 1. ç†äº‹ä¼šæ±ºå®šäº‹é …ãƒ†ãƒ¼ãƒ–ãƒ«
model BoardDecision {
  id                      String    @id @default(cuid())
  boardMeetingId          String    @map("board_meeting_id")
  meetingDate             DateTime  @map("meeting_date")
  title                   String
  category                String    // "ã‚·ã‚¹ãƒ†ãƒ å°å…¥", "äººäº‹åˆ¶åº¦", "ITãƒ»ã‚·ã‚¹ãƒ†ãƒ ", "äººæè‚²æˆ"
  description             String    @db.Text
  decision                String    @db.Text
  implementationDeadline  DateTime  @map("implementation_deadline")
  responsibleDept         String    @map("responsible_dept")  // æ‹…å½“éƒ¨é–€åï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  responsibleDeptId       String?   @map("responsible_dept_id")  // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ éƒ¨é–€ID
  affectedFacilities      Json      @map("affected_facilities")  // å½±éŸ¿æ–½è¨­IDé…åˆ—
  status                  String    @default("on_track")  // "completed", "on_track", "at_risk", "delayed"
  progress                Int       @default(0)  // 0-100
  lastUpdate              DateTime  @default(now()) @map("last_update")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  boardMeeting            BoardMeeting @relation("BoardDecisions", fields: [boardMeetingId], references: [id], onDelete: Cascade)
  milestones              BoardDecisionMilestone[]
  facilityImplementations BoardDecisionFacilityImplementation[]

  @@index([boardMeetingId])
  @@index([status])
  @@index([implementationDeadline])
  @@index([category])
  @@map("board_decisions")
}

// 2. ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
model BoardDecisionMilestone {
  id                String        @id @default(cuid())
  boardDecisionId   String        @map("board_decision_id")
  title             String
  deadline          DateTime
  status            String        @default("pending")  // "completed", "in_progress", "pending", "delayed"
  assignee          String
  assigneeId        String?       @map("assignee_id")
  sortOrder         Int           @default(0) @map("sort_order")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  completedAt       DateTime?     @map("completed_at")

  boardDecision     BoardDecision @relation(fields: [boardDecisionId], references: [id], onDelete: Cascade)

  @@index([boardDecisionId])
  @@index([status])
  @@index([deadline])
  @@index([sortOrder])
  @@map("board_decision_milestones")
}

// 3. æ–½è¨­åˆ¥å®Ÿæ–½çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«
model BoardDecisionFacilityImplementation {
  id                String        @id @default(cuid())
  boardDecisionId   String        @map("board_decision_id")
  facilityId        String        @map("facility_id")  // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ æ–½è¨­ID
  facilityName      String        @map("facility_name")  // æ–½è¨­åï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  status            String        @default("not_started")  // "completed", "in_progress", "not_started"
  progress          Int           @default(0)  // 0-100
  note              String?
  startedAt         DateTime?     @map("started_at")
  completedAt       DateTime?     @map("completed_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  boardDecision     BoardDecision @relation(fields: [boardDecisionId], references: [id], onDelete: Cascade)

  @@unique([boardDecisionId, facilityId])
  @@index([boardDecisionId])
  @@index([facilityId])
  @@index([status])
  @@map("board_decision_facility_implementations")
}

// 4. BoardMeeting ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
model BoardMeeting {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  decisions           BoardDecision[]      @relation("BoardDecisions")
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**:
```bash
npx prisma migrate dev --name add_board_decision_follow_tables
```

**å®Ÿè£…æœŸé–“**: 2æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUMï¼ˆBoardAgendaReviewã®å¾Œï¼‰

---

#### ã‚¿ã‚¹ã‚¯2: BoardDecisionFollowServiceå®Ÿè£…

```typescript
// VoiceDrive: src/services/BoardDecisionFollowService.ts
class BoardDecisionFollowService {
  // æ±ºå®šäº‹é …ä½œæˆï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‹ã‚‰æ–½è¨­åã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  async createDecision(data: {
    boardMeetingId: string;
    title: string;
    category: string;
    description: string;
    decision: string;
    implementationDeadline: Date;
    responsibleDept: string;
    affectedFacilities: string[];
    milestones: { title: string; deadline: Date; assignee: string; }[];
  }): Promise<BoardDecision> {
    // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ–½è¨­ãƒã‚¹ã‚¿ã‚’å–å¾—
    const facilitiesResponse = await fetch(`${MEDICAL_SYSTEM_URL}/api/v2/facilities`, {
      headers: {
        'Authorization': `Bearer ${JWT_TOKEN}`,
        'X-API-Key': API_KEY
      }
    });
    const facilitiesData = await facilitiesResponse.json();
    const facilitiesMap = new Map(
      facilitiesData.facilities.map(f => [f.facilityId, f.name])
    );

    // ç†äº‹ä¼šæƒ…å ±å–å¾—
    const boardMeeting = await prisma.boardMeeting.findUnique({
      where: { id: data.boardMeetingId }
    });

    // æ±ºå®šäº‹é …ä½œæˆ
    const decision = await prisma.boardDecision.create({
      data: {
        boardMeetingId: data.boardMeetingId,
        meetingDate: boardMeeting!.meetingDate,
        title: data.title,
        category: data.category,
        description: data.description,
        decision: data.decision,
        implementationDeadline: data.implementationDeadline,
        responsibleDept: data.responsibleDept,
        affectedFacilities: data.affectedFacilities,
        status: 'on_track',
        progress: 0
      }
    });

    // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä½œæˆ
    await prisma.boardDecisionMilestone.createMany({
      data: data.milestones.map((m, index) => ({
        boardDecisionId: decision.id,
        title: m.title,
        deadline: m.deadline,
        assignee: m.assignee,
        status: 'pending',
        sortOrder: index
      }))
    });

    // æ–½è¨­åˆ¥å®Ÿæ–½çŠ¶æ³ã‚’åˆæœŸåŒ–
    await prisma.boardDecisionFacilityImplementation.createMany({
      data: data.affectedFacilities.map(facilityId => ({
        boardDecisionId: decision.id,
        facilityId,
        facilityName: facilitiesMap.get(facilityId) || facilityId,
        status: 'not_started',
        progress: 0
      }))
    });

    return decision;
  }

  // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ›´æ–° + é€²æ—è‡ªå‹•å†è¨ˆç®—
  async updateMilestone(milestoneId: string, data: {
    status?: string;
    completedAt?: Date;
  }): Promise<void> {
    await prisma.boardDecisionMilestone.update({
      where: { id: milestoneId },
      data
    });

    // è¦ªã®æ±ºå®šäº‹é …ã®é€²æ—ã‚’å†è¨ˆç®—
    const milestone = await prisma.boardDecisionMilestone.findUnique({
      where: { id: milestoneId },
      include: { boardDecision: true }
    });

    const allMilestones = await prisma.boardDecisionMilestone.findMany({
      where: { boardDecisionId: milestone!.boardDecisionId }
    });

    const completedCount = allMilestones.filter(m => m.status === 'completed').length;
    const progress = Math.round((completedCount / allMilestones.length) * 100);
    const status = this.calculateStatus(allMilestones);

    await prisma.boardDecision.update({
      where: { id: milestone!.boardDecisionId },
      data: { progress, status, lastUpdate: new Date() }
    });
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  private calculateStatus(milestones: BoardDecisionMilestone[]): string {
    const now = new Date();

    const completedCount = milestones.filter(m => m.status === 'completed').length;
    if (completedCount === milestones.length) {
      return 'completed';
    }

    const hasDelayed = milestones.some(m =>
      m.status !== 'completed' && m.deadline < now
    );
    if (hasDelayed) {
      return 'delayed';
    }

    const hasAtRisk = milestones.some(m => {
      const daysToDeadline = Math.floor(
        (m.deadline.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)
      );
      return m.status !== 'completed' && daysToDeadline > 0 && daysToDeadline <= 7;
    });
    if (hasAtRisk) {
      return 'at_risk';
    }

    return 'on_track';
  }

  // æ–½è¨­åˆ¥å®Ÿæ–½çŠ¶æ³æ›´æ–° + å…¨ä½“é€²æ—å†è¨ˆç®—
  async updateFacilityImplementation(
    decisionId: string,
    facilityId: string,
    data: { status?: string; progress?: number; note?: string; }
  ): Promise<void> {
    await prisma.boardDecisionFacilityImplementation.update({
      where: {
        boardDecisionId_facilityId: { boardDecisionId: decisionId, facilityId }
      },
      data
    });

    // å…¨æ–½è¨­ã®å¹³å‡é€²æ—ç‡ã‚’å†è¨ˆç®—
    const implementations = await prisma.boardDecisionFacilityImplementation.findMany({
      where: { boardDecisionId: decisionId }
    });
    const totalProgress = implementations.reduce((sum, impl) => sum + impl.progress, 0);
    const averageProgress = Math.round(totalProgress / implementations.length);

    await prisma.boardDecision.update({
      where: { id: decisionId },
      data: { progress: averageProgress, lastUpdate: new Date() }
    });
  }
}
```

**å®Ÿè£…æœŸé–“**: 3æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUM

---

#### ã‚¿ã‚¹ã‚¯3: APIå®Ÿè£…ï¼ˆ5ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰

```typescript
// VoiceDrive: APIå®Ÿè£…

// 1. GET /api/board-decisions - æ±ºå®šäº‹é …ä¸€è¦§å–å¾—
export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const status = searchParams.get('status') || 'all';
  const category = searchParams.get('category');

  const where: any = {};
  if (status !== 'all') where.status = status;
  if (category) where.category = category;

  const decisions = await prisma.boardDecision.findMany({
    where,
    include: {
      milestones: { orderBy: { sortOrder: 'asc' } },
      facilityImplementations: true,
      boardMeeting: true
    },
    orderBy: { implementationDeadline: 'asc' }
  });

  const summary = {
    completed: decisions.filter(d => d.status === 'completed').length,
    on_track: decisions.filter(d => d.status === 'on_track').length,
    at_risk: decisions.filter(d => d.status === 'at_risk').length,
    delayed: decisions.filter(d => d.status === 'delayed').length
  };

  return NextResponse.json({ decisions, summary });
}

// 2. GET /api/board-decisions/:id/facility-implementations - æ–½è¨­åˆ¥å®Ÿæ–½çŠ¶æ³å–å¾—
// 3. PUT /api/board-decisions/:id/milestones/:milestoneId - ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ›´æ–°
// 4. PUT /api/board-decisions/:id/facility-implementations/:facilityId - æ–½è¨­åˆ¥å®Ÿæ–½çŠ¶æ³æ›´æ–°
// 5. POST /api/board-decisions - æ±ºå®šäº‹é …ä½œæˆ
```

**å®Ÿè£…æœŸé–“**: 2æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUM

---

#### ã‚¿ã‚¹ã‚¯4: ãƒãƒƒãƒå‡¦ç†å®Ÿè£…ï¼ˆ2ã¤ï¼‰

```typescript
// VoiceDrive: ãƒãƒƒãƒå‡¦ç†

// 1. æ–½è¨­åã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒãƒƒãƒï¼ˆæ¯æ—¥åˆå‰2æ™‚å®Ÿè¡Œï¼‰
async function updateFacilityNameCache() {
  const response = await fetch(`${MEDICAL_SYSTEM_URL}/api/v2/facilities`, {
    headers: {
      'Authorization': `Bearer ${JWT_TOKEN}`,
      'X-API-Key': API_KEY
    }
  });

  if (!response.ok) {
    console.error('[Batch] Failed to fetch facilities from medical system');
    return;
  }

  const facilitiesData = await response.json();
  const facilitiesMap = new Map(
    facilitiesData.facilities.map(f => [f.facilityId, f.name])
  );

  const implementations = await prisma.boardDecisionFacilityImplementation.findMany();

  for (const impl of implementations) {
    const latestFacilityName = facilitiesMap.get(impl.facilityId);
    if (latestFacilityName && latestFacilityName !== impl.facilityName) {
      await prisma.boardDecisionFacilityImplementation.update({
        where: { id: impl.id },
        data: { facilityName: latestFacilityName }
      });
    }
  }
}

// 2. é…å»¶ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ãƒãƒƒãƒï¼ˆæ¯æ—¥åˆå‰9æ™‚å®Ÿè¡Œï¼‰
async function sendDelayedAlerts() {
  const now = new Date();

  const alertDecisions = await prisma.boardDecision.findMany({
    where: { status: { in: ['delayed', 'at_risk'] } },
    include: { milestones: true, boardMeeting: true }
  });

  for (const decision of alertDecisions) {
    const delayedMilestones = decision.milestones.filter(m =>
      m.status !== 'completed' && m.deadline < now
    );

    if (delayedMilestones.length > 0) {
      // Level 18ï¼ˆç†äº‹é•·ï¼‰ã«é€šçŸ¥
      await prisma.notification.create({
        data: {
          userId: 'LEVEL18_USER_ID',
          category: 'board_decision_alert',
          title: 'ç†äº‹ä¼šæ±ºå®šäº‹é …ã®å®Ÿæ–½é…å»¶',
          message: `ã€Œ${decision.title}ã€ã®å®Ÿæ–½ãŒé…å»¶ã—ã¦ã„ã¾ã™ã€‚${delayedMilestones.length}ä»¶ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãŒæœŸé™åˆ‡ã‚Œã§ã™ã€‚`,
          link: '/board-decision-follow',
          priority: 'high',
          isRead: false
        }
      });
    }
  }
}
```

**å®Ÿè£…æœŸé–“**: 1æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¢ LOWï¼ˆPhase 2ã§å®Ÿè£…ï¼‰

---

#### ã‚¿ã‚¹ã‚¯5: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

```typescript
// VoiceDrive: ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

// 1. useBoardDecisions ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
const useBoardDecisions = (filter?: { status?: string; category?: string }) => {
  const queryString = new URLSearchParams(filter as any).toString();
  const { data, error, mutate } = useSWR(
    `/api/board-decisions?${queryString}`,
    fetcher,
    { refreshInterval: 60000, revalidateOnFocus: true }
  );

  const updateMilestone = async (decisionId: string, milestoneId: string, status: string) => {
    await fetch(`/api/board-decisions/${decisionId}/milestones/${milestoneId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        status,
        completedAt: status === 'completed' ? new Date().toISOString() : null,
        updatedAt: new Date().toISOString()  // æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ç”¨
      })
    });
    mutate();
  };

  return {
    decisions: data?.decisions || [],
    summary: data?.summary || {},
    isLoading: !error && !data,
    isError: error,
    updateMilestone,
    refresh: mutate
  };
};

// 2. FacilityImplementationProgress ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const FacilityImplementationProgress = ({ implementation }) => {
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-500';
      case 'in_progress': return 'bg-blue-500';
      case 'not_started': return 'bg-gray-300';
    }
  };

  return (
    <div className="flex items-center gap-4">
      <div className="flex-1">
        <div className="flex justify-between text-sm mb-1">
          <span>{implementation.facilityName}</span>
          <span className="text-gray-600">{implementation.progress}%</span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-2">
          <div
            className={`h-2 rounded-full transition-all duration-300 ${getStatusColor(implementation.status)}`}
            style={{ width: `${implementation.progress}%` }}
          />
        </div>
      </div>
    </div>
  );
};
```

**å®Ÿè£…æœŸé–“**: 2æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUM

---

#### VoiceDriveå®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆBoardDecisionFollowï¼‰

| ã‚¿ã‚¹ã‚¯ | å®Ÿè£…æœŸé–“ | å„ªå…ˆåº¦ | å‚™è€ƒ |
|--------|---------|--------|------|
| **ã‚¿ã‚¹ã‚¯1**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼ˆ3ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ | 2æ—¥ | ğŸŸ¡ MEDIUM | BoardAgendaReviewå¾Œã«å®Ÿè£… |
| **ã‚¿ã‚¹ã‚¯2**: BoardDecisionFollowService | 3æ—¥ | ğŸŸ¡ MEDIUM | é€²æ—è‡ªå‹•è¨ˆç®—ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š |
| **ã‚¿ã‚¹ã‚¯3**: APIå®Ÿè£…ï¼ˆ5ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰ | 2æ—¥ | ğŸŸ¡ MEDIUM | Level 18æ¨©é™ãƒã‚§ãƒƒã‚¯ |
| **ã‚¿ã‚¹ã‚¯4**: ãƒãƒƒãƒå‡¦ç†å®Ÿè£… | 1æ—¥ | ğŸŸ¢ LOW | æ–½è¨­åã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»é…å»¶ã‚¢ãƒ©ãƒ¼ãƒˆ |
| **ã‚¿ã‚¹ã‚¯5**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£… | 2æ—¥ | ğŸŸ¡ MEDIUM | ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ + ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ |

**åˆè¨ˆ**: 10æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œã«å®Ÿæ–½ã€BoardAgendaReviewå®Ÿè£…å¾Œï¼‰

**ãƒ†ã‚¹ãƒˆè¦ä»¶**:
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 20ã‚±ãƒ¼ã‚¹ä»¥ä¸Šï¼ˆé€²æ—è¨ˆç®—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šï¼‰
- APIçµ±åˆãƒ†ã‚¹ãƒˆ: 15ã‚±ãƒ¼ã‚¹ä»¥ä¸Š
- ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ: 1ã‚±ãƒ¼ã‚¹ï¼ˆæ±ºå®šäº‹é …ä½œæˆâ†’ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ›´æ–°â†’é€²æ—ç¢ºèªï¼‰

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã®åˆ©ç”¨**:
- GET /api/v2/facilitiesï¼ˆæ–½è¨­ãƒã‚¹ã‚¿å–å¾—ï¼‰- æ±ºå®šäº‹é …ä½œæˆæ™‚ã€æ—¥æ¬¡ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æ™‚
- GET /api/v2/departmentsï¼ˆéƒ¨é–€ãƒã‚¹ã‚¿å–å¾—ï¼‰- æ±ºå®šäº‹é …ä½œæˆæ™‚

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [board-decision-follow_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/board-decision-follow_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)
- [board-decision-follow_DBè¦ä»¶åˆ†æ_20251011.md](../mcp-shared/docs/board-decision-follow_DBè¦ä»¶åˆ†æ_20251011.md)
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ æ—¢å­˜APIï¼ˆfacilities, departmentsï¼‰

---

### 6.3.9 ProjectTracking VoiceDriveå´å®Ÿè£…ã‚¿ã‚¹ã‚¯

**æ¦‚è¦**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½è·¡ãƒšãƒ¼ã‚¸å®Ÿè£…ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ãƒ»æŠ•ç¥¨ãƒ»å‚åŠ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ï¼‰

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIä¾å­˜**: ãªã—ï¼ˆVoiceDriveå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ï¼‰

**å®Ÿè£…å®Œäº†æœŸé™**: BoardDecisionFollowå®Ÿè£…å¾Œ + 4æ—¥

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [project-tracking_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/project-tracking_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)

---

#### ã‚¿ã‚¹ã‚¯1: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰

**å®Ÿè£…æœŸé–“**: 1æ—¥
**å„ªå…ˆåº¦**: ğŸ”´ HIGHï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ç›´æ¥å½±éŸ¿ï¼‰

**å®Ÿè£…å†…å®¹**:

æ—¢å­˜ã®Post/Voteãƒ†ãƒ¼ãƒ–ãƒ«ã«è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã€ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’10-50å€å‘ä¸Šã•ã›ã‚‹ã€‚

##### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1: Postè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
```prisma
// prisma/schema.prisma

model Post {
  id          String   @id @default(cuid())
  authorId    String
  type        String   // 'project', 'discussion', etc.
  title       String
  description String?
  status      String   // 'active', 'completed', 'archived'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  votes    Vote[]
  comments Comment[]

  @@index([authorId, type, createdAt])  // æ–°è¦è¿½åŠ 
}
```

**SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
```sql
-- Migration: 20251011_add_post_author_type_created_index

CREATE INDEX "Post_authorId_type_createdAt_idx"
ON "Post"("authorId", "type", "createdAt" DESC);

-- å®Ÿè¡Œæ™‚é–“: ç´„5-30ç§’ï¼ˆPostãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºã«ä¾å­˜ï¼‰
-- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡å¢—åŠ : Postãƒ¬ã‚³ãƒ¼ãƒ‰æ•° Ã— ç´„50ãƒã‚¤ãƒˆ
```

##### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2: Voteè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
```prisma
// prisma/schema.prisma

model Vote {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  score     Int      @default(1)  // 1-10
  timestamp DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
  @@index([userId, timestamp])  // æ–°è¦è¿½åŠ 
}
```

**SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
```sql
-- Migration: 20251011_add_vote_user_timestamp_index

CREATE INDEX "Vote_userId_timestamp_idx"
ON "Vote"("userId", "timestamp" DESC);

-- å®Ÿè¡Œæ™‚é–“: ç´„3-20ç§’ï¼ˆVoteãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºã«ä¾å­˜ï¼‰
-- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡å¢—åŠ : Voteãƒ¬ã‚³ãƒ¼ãƒ‰æ•° Ã— ç´„50ãƒã‚¤ãƒˆ
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**:
```bash
# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
npx prisma migrate dev --name add_project_tracking_indexes

# æœ¬ç•ªç’°å¢ƒé©ç”¨
npx prisma migrate deploy
```

**æ¤œè¨¼**:
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ç¢ºèª
EXPLAIN ANALYZE
SELECT * FROM "Post"
WHERE "authorId" = 'user-001'
  AND "type" = 'project'
ORDER BY "createdAt" DESC
LIMIT 10;

-- çµæœã«"Index Scan using Post_authorId_type_createdAt_idx"ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

#### ã‚¿ã‚¹ã‚¯2: ProjectTrackingServiceå®Ÿè£…

**å®Ÿè£…æœŸé–“**: 2æ—¥
**å„ªå…ˆåº¦**: ğŸ”´ HIGH

**å®Ÿè£…å†…å®¹**:

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½è·¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚’å®Ÿè£…ã€‚

```typescript
// src/services/ProjectTrackingService.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export class ProjectTrackingService {
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒææ¡ˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
   */
  async getMyProjects(userId: string, options: {
    limit?: number;
    offset?: number;
    status?: 'active' | 'completed' | 'archived';
  }) {
    const { limit = 10, offset = 0, status } = options;

    const where: any = {
      authorId: userId,
      type: 'project'
    };

    if (status) {
      where.status = status;
    }

    const [posts, totalCount] = await Promise.all([
      prisma.post.findMany({
        where,
        orderBy: { createdAt: 'desc' },
        skip: offset,
        take: limit,
        include: {
          _count: {
            select: {
              votes: true,
              comments: true
            }
          }
        }
      }),
      prisma.post.count({ where })
    ]);

    return {
      projects: posts.map(post => ({
        id: post.id,
        title: post.title,
        description: post.description,
        status: post.status,
        createdAt: post.createdAt,
        votesCount: post._count.votes,
        commentsCount: post._count.comments
      })),
      pagination: {
        total: totalCount,
        limit,
        offset,
        hasMore: offset + limit < totalCount
      }
    };
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¥¨ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
   */
  async getVotedProjects(userId: string, options: {
    limit?: number;
    offset?: number;
  }) {
    const { limit = 10, offset = 0 } = options;

    const [votes, totalCount] = await Promise.all([
      prisma.vote.findMany({
        where: { userId },
        orderBy: { timestamp: 'desc' },
        skip: offset,
        take: limit,
        include: {
          post: {
            include: {
              _count: {
                select: {
                  votes: true,
                  comments: true
                }
              }
            }
          }
        }
      }),
      prisma.vote.count({ where: { userId } })
    ]);

    return {
      projects: votes
        .filter(vote => vote.post?.type === 'project')
        .map(vote => ({
          id: vote.post.id,
          title: vote.post.title,
          description: vote.post.description,
          status: vote.post.status,
          votedAt: vote.timestamp,
          myScore: vote.score,
          totalVotesCount: vote.post._count.votes,
          commentsCount: vote.post._count.comments
        })),
      pagination: {
        total: totalCount,
        limit,
        offset,
        hasMore: offset + limit < totalCount
      }
    };
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒ¡ãƒ³ãƒˆå‚åŠ ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
   */
  async getJoinedProjects(userId: string, options: {
    limit?: number;
    offset?: number;
  }) {
    const { limit = 10, offset = 0 } = options;

    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªpostIdã‚’å–å¾—
    const uniquePostIds = await prisma.comment.groupBy({
      by: ['postId'],
      where: {
        authorId: userId,
        post: {
          type: 'project'
        }
      },
      _max: {
        createdAt: true
      },
      orderBy: {
        _max: {
          createdAt: 'desc'
        }
      },
      skip: offset,
      take: limit
    });

    const postIds = uniquePostIds.map(g => g.postId);

    const posts = await prisma.post.findMany({
      where: {
        id: { in: postIds }
      },
      include: {
        _count: {
          select: {
            votes: true,
            comments: true
          }
        }
      }
    });

    const totalCount = await prisma.comment.groupBy({
      by: ['postId'],
      where: {
        authorId: userId,
        post: { type: 'project' }
      }
    }).then(results => results.length);

    return {
      projects: posts.map(post => ({
        id: post.id,
        title: post.title,
        description: post.description,
        status: post.status,
        votesCount: post._count.votes,
        commentsCount: post._count.comments
      })),
      pagination: {
        total: totalCount,
        limit,
        offset,
        hasMore: offset + limit < totalCount
      }
    };
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£çµ±è¨ˆå–å¾—
   */
  async getProjectStats(userId: string) {
    const [
      myPostsCount,
      votedPostsCount,
      commentedProjectsCount,
      achievedCount
    ] = await Promise.all([
      prisma.post.count({
        where: {
          authorId: userId,
          type: 'project'
        }
      }),
      prisma.vote.count({
        where: {
          userId,
          post: { type: 'project' }
        }
      }),
      prisma.comment.groupBy({
        by: ['postId'],
        where: {
          authorId: userId,
          post: { type: 'project' }
        }
      }).then(results => results.length),
      prisma.post.count({
        where: {
          authorId: userId,
          type: 'project',
          status: 'completed'
        }
      })
    ]);

    return {
      myPostsCount,
      votedPostsCount,
      commentedProjectsCount,
      achievedCount
    };
  }
}
```

**ãƒ†ã‚¹ãƒˆ**:
```typescript
// tests/unit/ProjectTrackingService.test.ts

describe('ProjectTrackingService', () => {
  it('getMyProjects - æ­£å¸¸ç³»', async () => {
    const result = await service.getMyProjects('user-001', { limit: 10, offset: 0 });
    expect(result.projects).toBeInstanceOf(Array);
    expect(result.pagination.total).toBeGreaterThanOrEqual(0);
  });

  it('getVotedProjects - æŠ•ç¥¨é †ã§ã‚½ãƒ¼ãƒˆ', async () => {
    const result = await service.getVotedProjects('user-001', { limit: 10, offset: 0 });
    expect(result.projects[0].votedAt >= result.projects[1].votedAt).toBe(true);
  });

  it('getProjectStats - çµ±è¨ˆå–å¾—', async () => {
    const stats = await service.getProjectStats('user-001');
    expect(stats).toHaveProperty('myPostsCount');
    expect(stats).toHaveProperty('votedPostsCount');
    expect(stats).toHaveProperty('commentedProjectsCount');
    expect(stats).toHaveProperty('achievedCount');
  });
});
```

---

#### ã‚¿ã‚¹ã‚¯3: APIå®Ÿè£…ï¼ˆ4ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰

**å®Ÿè£…æœŸé–“**: 1æ—¥
**å„ªå…ˆåº¦**: ğŸ”´ HIGH

**å®Ÿè£…å†…å®¹**:

ProjectTrackingç”¨ã®4ã¤ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã€‚

##### API 1: ææ¡ˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
```typescript
// src/app/api/project-tracking/my-projects/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { ProjectTrackingService } from '@/services/ProjectTrackingService';
import { authenticateUser } from '@/lib/auth';

const service = new ProjectTrackingService();

export async function GET(request: NextRequest) {
  try {
    const user = await authenticateUser(request);
    if (!user) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      );
    }

    const searchParams = request.nextUrl.searchParams;
    const limit = parseInt(searchParams.get('limit') || '10', 10);
    const offset = parseInt(searchParams.get('offset') || '0', 10);
    const status = searchParams.get('status') as 'active' | 'completed' | 'archived' | undefined;

    if (limit < 1 || limit > 100) {
      return NextResponse.json(
        { error: { code: 'INVALID_PARAMETER', message: 'limit must be between 1-100' } },
        { status: 400 }
      );
    }

    const result = await service.getMyProjects(user.id, { limit, offset, status });

    return NextResponse.json({
      data: result.projects,
      pagination: result.pagination,
      meta: {
        timestamp: new Date().toISOString()
      }
    });

  } catch (error: any) {
    console.error('GET /api/project-tracking/my-projects error:', error);
    return NextResponse.json(
      {
        error: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Failed to fetch my projects',
          details: error.message
        }
      },
      { status: 500 }
    );
  }
}
```

##### API 2: æŠ•ç¥¨ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
```typescript
// src/app/api/project-tracking/voted-projects/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { ProjectTrackingService } from '@/services/ProjectTrackingService';
import { authenticateUser } from '@/lib/auth';

const service = new ProjectTrackingService();

export async function GET(request: NextRequest) {
  try {
    const user = await authenticateUser(request);
    if (!user) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      );
    }

    const searchParams = request.nextUrl.searchParams;
    const limit = parseInt(searchParams.get('limit') || '10', 10);
    const offset = parseInt(searchParams.get('offset') || '0', 10);

    const result = await service.getVotedProjects(user.id, { limit, offset });

    return NextResponse.json({
      data: result.projects,
      pagination: result.pagination,
      meta: {
        timestamp: new Date().toISOString()
      }
    });

  } catch (error: any) {
    console.error('GET /api/project-tracking/voted-projects error:', error);
    return NextResponse.json(
      {
        error: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Failed to fetch voted projects',
          details: error.message
        }
      },
      { status: 500 }
    );
  }
}
```

##### API 3: å‚åŠ ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
```typescript
// src/app/api/project-tracking/joined-projects/route.ts
// ï¼ˆAPI 2ã¨åŒæ§˜ã®æ§‹é€ ã€service.getJoinedProjectsã‚’å‘¼ã³å‡ºã—ï¼‰
```

##### API 4: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆ
```typescript
// src/app/api/project-tracking/stats/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { ProjectTrackingService } from '@/services/ProjectTrackingService';
import { authenticateUser } from '@/lib/auth';

const service = new ProjectTrackingService();

export async function GET(request: NextRequest) {
  try {
    const user = await authenticateUser(request);
    if (!user) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      );
    }

    const stats = await service.getProjectStats(user.id);

    return NextResponse.json({
      data: stats,
      meta: {
        timestamp: new Date().toISOString()
      }
    });

  } catch (error: any) {
    console.error('GET /api/project-tracking/stats error:', error);
    return NextResponse.json(
      {
        error: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Failed to fetch project stats',
          details: error.message
        }
      },
      { status: 500 }
    );
  }
}
```

**APIãƒ†ã‚¹ãƒˆ**:
```bash
# ææ¡ˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
curl -X GET "http://localhost:3000/api/project-tracking/my-projects?limit=10" \
  -H "Authorization: Bearer $TOKEN"

# æŠ•ç¥¨ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
curl -X GET "http://localhost:3000/api/project-tracking/voted-projects?limit=10" \
  -H "Authorization: Bearer $TOKEN"

# å‚åŠ ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
curl -X GET "http://localhost:3000/api/project-tracking/joined-projects?limit=10" \
  -H "Authorization: Bearer $TOKEN"

# çµ±è¨ˆå–å¾—
curl -X GET "http://localhost:3000/api/project-tracking/stats" \
  -H "Authorization: Bearer $TOKEN"
```

---

#### VoiceDriveå®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆProjectTrackingï¼‰

| ã‚¿ã‚¹ã‚¯ | å®Ÿè£…æœŸé–“ | å„ªå…ˆåº¦ | å‚™è€ƒ |
|--------|---------|--------|------|
| **ã‚¿ã‚¹ã‚¯1**: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ  | 1æ—¥ | ğŸ”´ HIGH | BoardDecisionFollowå¾Œã«å®Ÿè£…ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¿…é ˆ |
| **ã‚¿ã‚¹ã‚¯2**: ProjectTrackingService | 2æ—¥ | ğŸ”´ HIGH | 4ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…ã€Promise.allä¸¦åˆ—åŒ– |
| **ã‚¿ã‚¹ã‚¯3**: APIå®Ÿè£…ï¼ˆ4ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰ | 1æ—¥ | ğŸ”´ HIGH | èªè¨¼å¿…é ˆã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° |

**åˆè¨ˆ**: 4æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œã«å®Ÿæ–½ã€BoardDecisionFollowå®Ÿè£…å¾Œï¼‰

**ãƒ†ã‚¹ãƒˆè¦ä»¶**:
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 10ã‚±ãƒ¼ã‚¹ä»¥ä¸Šï¼ˆã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ã¿ï¼‰
- APIçµ±åˆãƒ†ã‚¹ãƒˆ: 12ã‚±ãƒ¼ã‚¹ä»¥ä¸Šï¼ˆ4ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ Ã— 3ã‚±ãƒ¼ã‚¹ï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ: 2ã‚±ãƒ¼ã‚¹ï¼ˆè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹æœæ¤œè¨¼ï¼‰
- E2Eãƒ†ã‚¹ãƒˆ: 1ã‚±ãƒ¼ã‚¹ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‹•ä½œç¢ºèªï¼‰

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã®åˆ©ç”¨**: ãªã—ï¼ˆVoiceDriveå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ï¼‰

**ç‰¹è¨˜äº‹é …**:
- âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºä¸è¦ï¼ˆæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ï¼‰
- âœ… æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ä¸è¦ï¼ˆæ—¢å­˜Post/Vote/Commentãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ä½¿ç”¨ï¼‰
- âš ï¸ è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¿…é ˆï¼ˆãƒ‡ãƒ¼ã‚¿å¢—åŠ æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–é˜²æ­¢ï¼‰
- ğŸ“Š ã‚¹ã‚³ã‚¢è¨ˆç®—ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å®Ÿæ–½ï¼ˆDBã«ä¿å­˜ã—ãªã„ï¼‰

---

### 6.3.10 ProgressDashboard VoiceDriveå´å®Ÿè£…ã‚¿ã‚¹ã‚¯

**æ¦‚è¦**: é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å®Ÿè£…ï¼ˆè¤‡æ•°éƒ¨ç½²ãƒ»æ–½è¨­å…¨ä½“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã‚’ä¿¯ç°çš„ã«ç®¡ç†ï¼‰

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIä¾å­˜**: æ—¢å­˜APIã®ã¿ä½¿ç”¨ï¼ˆfacilities/departments/employeesï¼‰

**å®Ÿè£…å®Œäº†æœŸé™**: ProjectTrackingå®Ÿè£…å¾Œ + 9æ—¥

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [progress-dashboard_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md](../mcp-shared/docs/progress-dashboard_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251011.md)

---

#### ã‚¿ã‚¹ã‚¯1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼ˆ2ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ  + Postæ‹¡å¼µï¼‰

**å®Ÿè£…æœŸé–“**: 1.5æ—¥
**å„ªå…ˆåº¦**: ğŸ”´ HIGHï¼ˆã‚³ã‚¢æ©Ÿèƒ½ã®åŸºç›¤ï¼‰

**å®Ÿè£…å†…å®¹**:

æ—¢å­˜Postãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã€ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒ»ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ç”¨ã®æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚

##### Postãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

```prisma
model Post {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  // ProgressDashboardçµ±åˆå®Ÿè£…ï¼ˆ2025-10-11ï¼‰
  projectDueDate      DateTime? @map("project_due_date")      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé™
  projectLevel        String?   @map("project_level")         // 'team' | 'department' | 'facility' | 'organization'
  projectProgress     Int?      @default(0) @map("project_progress")  // é€²æ—ç‡ï¼ˆ0-100ï¼‰

  // Relations
  milestones          ProjectMilestone[]   @relation("ProjectMilestones")
  teamMembers         ProjectTeamMember[]  @relation("ProjectTeamMembers")

  @@index([type, status, createdAt])  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—ç”¨
  @@index([projectDueDate])            // æœŸé™ã‚½ãƒ¼ãƒˆãƒ»é…å»¶åˆ¤å®šç”¨ï¼ˆæ–°è¦ï¼‰
  @@index([projectLevel])              // ãƒ¬ãƒ™ãƒ«åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ï¼ˆæ–°è¦ï¼‰
}
```

##### ProjectMilestoneãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ï¼‰

```prisma
model ProjectMilestone {
  id                String    @id @default(cuid())
  projectId         String    @map("project_id")
  title             String
  description       String?   @db.Text
  dueDate           DateTime  @map("due_date")
  completedAt       DateTime? @map("completed_at")
  completedBy       String?   @map("completed_by")
  status            String    @default("pending") // 'pending' | 'in_progress' | 'completed' | 'cancelled'
  order             Int       @default(0)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  project           Post      @relation("ProjectMilestones", fields: [projectId], references: [id], onDelete: Cascade)
  completedByUser   User?     @relation("MilestoneCompletedBy", fields: [completedBy], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@map("project_milestones")
}
```

##### ProjectTeamMemberãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ï¼‰

```prisma
model ProjectTeamMember {
  id                String    @id @default(cuid())
  projectId         String    @map("project_id")
  userId            String    @map("user_id")
  role              String    @default("member") // 'leader' | 'sub_leader' | 'member' | 'observer'
  joinedAt          DateTime  @default(now()) @map("joined_at")
  leftAt            DateTime? @map("left_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  project           Post      @relation("ProjectTeamMembers", fields: [projectId], references: [id], onDelete: Cascade)
  user              User      @relation("ProjectMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([role])
  @@map("project_team_members")
}
```

##### Userãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

```prisma
model User {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  // ProgressDashboardçµ±åˆå®Ÿè£…ï¼ˆ2025-10-11ï¼‰
  projectMemberships      ProjectTeamMember[]   @relation("ProjectMemberships")
  completedMilestones     ProjectMilestone[]    @relation("MilestoneCompletedBy")
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**:
```bash
# ã‚¹ã‚­ãƒ¼ãƒæ›´æ–°
npx prisma migrate dev --name add_progress_dashboard_tables

# æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
UPDATE "Post"
SET
  "project_due_date" = "createdAt" + INTERVAL '3 months',
  "project_level" = 'team',
  "project_progress" = 0
WHERE "type" = 'project' AND "project_due_date" IS NULL;
```

---

#### ã‚¿ã‚¹ã‚¯2: ProgressDashboardServiceå®Ÿè£…

**å®Ÿè£…æœŸé–“**: 2æ—¥
**å„ªå…ˆåº¦**: ğŸ”´ HIGH

**å®Ÿè£…å†…å®¹**:

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—ãƒ»çµ±è¨ˆè¨ˆç®—ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†ã®ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚’å®Ÿè£…ã€‚

```typescript
// src/services/ProgressDashboardService.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export class ProgressDashboardService {
  /**
   * ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
   */
  async getAccessibleProjects(userId: string, options: {
    filter?: 'all' | 'active' | 'completed' | 'delayed';
    facilityId?: string;
    departmentId?: string;
    limit?: number;
    offset?: number;
  }) {
    const { filter = 'all', limit = 20, offset = 0 } = options;

    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™å–å¾—
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { id: true, level: true, facilityId: true, departmentId: true }
    });

    if (!user) {
      throw new Error('User not found');
    }

    if (user.level < 10) {
      throw new Error('Level 10+ required for ProgressDashboard');
    }

    // 2. WHEREæ¡ä»¶æ§‹ç¯‰
    const where: any = { type: 'project' };

    // 2.1 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (filter === 'active') {
      where.status = 'active';
    } else if (filter === 'completed') {
      where.status = 'completed';
    }

    // 2.2 æ¨©é™ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (user.level < 13) {
      // Level 10-12: è‡ªæ–½è¨­ã®ã¿
      where.author = {
        facilityId: options.facilityId || user.facilityId
      };

      if (user.level === 10) {
        // Level 10 (éƒ¨é•·): è‡ªéƒ¨é–€ã®ã¿
        where.author = {
          ...where.author,
          departmentId: options.departmentId || user.departmentId
        };
      }
    }
    // Level 13+: å…¨æ–½è¨­ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼‰

    // 3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—
    const projects = await prisma.post.findMany({
      where,
      include: {
        author: {
          select: {
            id: true,
            name: true,
            facilityId: true,
            departmentId: true
          }
        },
        milestones: {
          select: {
            id: true,
            status: true
          }
        },
        teamMembers: {
          where: { leftAt: null },
          select: {
            id: true,
            userId: true,
            role: true
          }
        },
        _count: {
          select: {
            milestones: true,
            teamMembers: true
          }
        }
      },
      orderBy: { createdAt: 'desc' },
      skip: offset,
      take: limit
    });

    // 4. ç·ä»¶æ•°å–å¾—
    const totalCount = await prisma.post.count({ where });

    // 5. ãƒ‡ãƒ¼ã‚¿åŠ å·¥ï¼ˆé…å»¶åˆ¤å®šãƒ»é€²æ—è¨ˆç®—ï¼‰
    const now = new Date();
    const result = projects.map(project => {
      const completedMilestones = project.milestones.filter(m => m.status === 'completed').length;
      const totalMilestones = project.milestones.length;

      // é€²æ—è¨ˆç®—
      const progress = totalMilestones > 0
        ? Math.round((completedMilestones / totalMilestones) * 100)
        : project.projectProgress || 0;

      // é…å»¶åˆ¤å®š
      const isDelayed = project.projectDueDate &&
                       project.projectDueDate < now &&
                       project.status !== 'completed';

      return {
        id: project.id,
        title: project.title || 'ç„¡é¡Œã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
        description: project.content,
        status: project.status,
        progress,
        teamSize: project._count.teamMembers,
        completedMilestones,
        totalMilestones,
        dueDate: project.projectDueDate?.toISOString(),
        isDelayed,
        level: project.projectLevel,
        createdAt: project.createdAt.toISOString()
      };
    });

    // 6. é…å»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå¿…è¦ãªå ´åˆï¼‰
    const filteredResult = filter === 'delayed'
      ? result.filter(p => p.isDelayed)
      : result;

    return {
      projects: filteredResult,
      pagination: {
        total: totalCount,
        limit,
        offset,
        hasMore: offset + limit < totalCount
      }
    };
  }

  /**
   * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆå–å¾—
   */
  async getProjectStats(userId: string, options: {
    facilityId?: string;
    departmentId?: string;
  }) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™å–å¾—
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { id: true, level: true, facilityId: true, departmentId: true }
    });

    if (!user || user.level < 10) {
      throw new Error('Insufficient permissions');
    }

    // WHEREæ¡ä»¶æ§‹ç¯‰ï¼ˆgetAccessibleProjectsã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    const where: any = { type: 'project' };

    if (user.level < 13) {
      where.author = {
        facilityId: options.facilityId || user.facilityId
      };
      if (user.level === 10) {
        where.author = {
          ...where.author,
          departmentId: options.departmentId || user.departmentId
        };
      }
    }

    // ä¸¦åˆ—ã‚¯ã‚¨ãƒªã§çµ±è¨ˆå–å¾—
    const [total, active, completed, allProjects] = await Promise.all([
      prisma.post.count({ where }),
      prisma.post.count({ where: { ...where, status: 'active' } }),
      prisma.post.count({ where: { ...where, status: 'completed' } }),
      prisma.post.findMany({
        where,
        include: {
          milestones: {
            select: { status: true }
          }
        }
      })
    ]);

    // é…å»¶åˆ¤å®š
    const now = new Date();
    const delayed = allProjects.filter(p =>
      p.projectDueDate && p.projectDueDate < now && p.status !== 'completed'
    ).length;

    // å¹³å‡é€²æ—è¨ˆç®—
    const avgProgress = allProjects.length > 0
      ? Math.round(
          allProjects.reduce((sum, p) => {
            const completedMilestones = p.milestones.filter(m => m.status === 'completed').length;
            const totalMilestones = p.milestones.length;
            const progress = totalMilestones > 0
              ? (completedMilestones / totalMilestones) * 100
              : p.projectProgress || 0;
            return sum + progress;
          }, 0) / allProjects.length
        )
      : 0;

    return {
      total,
      active,
      completed,
      delayed,
      avgProgress
    };
  }
}
```

**ãƒ†ã‚¹ãƒˆ**:
```typescript
// tests/unit/ProgressDashboardService.test.ts

describe('ProgressDashboardService', () => {
  it('getAccessibleProjects - Level 10ã¯è‡ªéƒ¨é–€ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½', async () => {
    const result = await service.getAccessibleProjects('level10-user-001', {
      filter: 'all',
      limit: 10
    });

    // ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè‡ªéƒ¨é–€ã®ã‚‚ã®
    result.projects.forEach(project => {
      expect(project.author.departmentId).toBe('dept-A');
    });
  });

  it('getProjectStats - çµ±è¨ˆè¨ˆç®—ãŒæ­£ã—ã„', async () => {
    const stats = await service.getProjectStats('level10-user-001', {});

    expect(stats).toHaveProperty('total');
    expect(stats).toHaveProperty('active');
    expect(stats).toHaveProperty('completed');
    expect(stats).toHaveProperty('delayed');
    expect(stats).toHaveProperty('avgProgress');
    expect(stats.avgProgress).toBeGreaterThanOrEqual(0);
    expect(stats.avgProgress).toBeLessThanOrEqual(100);
  });
});
```

---

#### ã‚¿ã‚¹ã‚¯3: APIå®Ÿè£…ï¼ˆ3ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰

**å®Ÿè£…æœŸé–“**: 1.5æ—¥
**å„ªå…ˆåº¦**: ğŸ”´ HIGH

**å®Ÿè£…å†…å®¹**:

ProgressDashboardç”¨ã®3ã¤ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã€‚

##### API 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—

```typescript
// src/app/api/progress-dashboard/projects/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { ProgressDashboardService } from '@/services/ProgressDashboardService';
import { authenticateUser } from '@/lib/auth';

const service = new ProgressDashboardService();

export async function GET(request: NextRequest) {
  try {
    const user = await authenticateUser(request);
    if (!user) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      );
    }

    // Level 10+ãƒã‚§ãƒƒã‚¯
    if (user.level < 10) {
      return NextResponse.json(
        {
          error: {
            code: 'FORBIDDEN',
            message: 'ã“ã®ãƒšãƒ¼ã‚¸ã¯éƒ¨é•·ä»¥ä¸Šã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™',
            details: `User level: ${user.level}, Required: 10+`
          }
        },
        { status: 403 }
      );
    }

    const searchParams = request.nextUrl.searchParams;
    const filter = searchParams.get('filter') as 'all' | 'active' | 'completed' | 'delayed' | undefined;
    const facilityId = searchParams.get('facilityId') || undefined;
    const departmentId = searchParams.get('departmentId') || undefined;
    const limit = parseInt(searchParams.get('limit') || '20', 10);
    const offset = parseInt(searchParams.get('offset') || '0', 10);

    const result = await service.getAccessibleProjects(user.id, {
      filter,
      facilityId,
      departmentId,
      limit,
      offset
    });

    return NextResponse.json({
      data: result.projects,
      pagination: result.pagination,
      meta: {
        timestamp: new Date().toISOString()
      }
    });

  } catch (error: any) {
    console.error('GET /api/progress-dashboard/projects error:', error);
    return NextResponse.json(
      {
        error: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Failed to fetch projects',
          details: error.message
        }
      },
      { status: 500 }
    );
  }
}
```

##### API 2: çµ±è¨ˆã‚µãƒãƒªãƒ¼å–å¾—

```typescript
// src/app/api/progress-dashboard/stats/route.ts
// ï¼ˆAPI 1ã¨åŒæ§˜ã®æ§‹é€ ã€service.getProjectStatsã‚’å‘¼ã³å‡ºã—ï¼‰
```

##### API 3: ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¸€è¦§å–å¾—

```typescript
// src/app/api/progress-dashboard/projects/[projectId]/milestones/route.ts
// ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‹ã‚‰ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¸€è¦§ã‚’å–å¾—ï¼‰
```

**APIãƒ†ã‚¹ãƒˆ**:
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
curl -X GET "http://localhost:3000/api/progress-dashboard/projects?filter=all&limit=10" \
  -H "Authorization: Bearer $LEVEL10_TOKEN"

# çµ±è¨ˆã‚µãƒãƒªãƒ¼å–å¾—
curl -X GET "http://localhost:3000/api/progress-dashboard/stats" \
  -H "Authorization: Bearer $LEVEL10_TOKEN"
```

---

#### ã‚¿ã‚¹ã‚¯4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**å®Ÿè£…æœŸé–“**: 2æ—¥
**å„ªå…ˆåº¦**: ğŸŸ¡ MEDIUMï¼ˆVoiceDriveå´ã§å®Ÿè£…æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰

**å®Ÿè£…å†…å®¹**:

useProgressDashboardãƒ•ãƒƒã‚¯ã¨ProgressDashboardãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚

```typescript
// src/hooks/useProgressDashboard.ts

import useSWR from 'swr';

export function useProgressDashboard(
  filter: 'all' | 'active' | 'completed' | 'delayed',
  options?: {
    facilityId?: string;
    departmentId?: string;
  }
) {
  const queryParams = new URLSearchParams({
    filter,
    ...(options?.facilityId && { facilityId: options.facilityId }),
    ...(options?.departmentId && { departmentId: options.departmentId })
  });

  const { data: projectsData, error: projectsError, isLoading: projectsLoading } = useSWR(
    `/api/progress-dashboard/projects?${queryParams.toString()}`
  );

  const { data: statsData, error: statsError, isLoading: statsLoading } = useSWR(
    `/api/progress-dashboard/stats?${queryParams.toString()}`,
    { refreshInterval: 60000 }
  );

  return {
    projects: projectsData?.data || [],
    pagination: projectsData?.pagination,
    stats: statsData?.data,
    isLoading: projectsLoading || statsLoading,
    error: projectsError || statsError
  };
}
```

---

#### VoiceDriveå®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆProgressDashboardï¼‰

| ã‚¿ã‚¹ã‚¯ | å®Ÿè£…æœŸé–“ | å„ªå…ˆåº¦ | å‚™è€ƒ |
|--------|---------|--------|------|
| **ã‚¿ã‚¹ã‚¯1**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ | 1.5æ—¥ | ğŸ”´ HIGH | ProjectTrackingå¾Œã€2æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ« + Postæ‹¡å¼µ |
| **ã‚¿ã‚¹ã‚¯2**: ProgressDashboardService | 2æ—¥ | ğŸ”´ HIGH | æ¨©é™ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¿…é ˆ |
| **ã‚¿ã‚¹ã‚¯3**: APIå®Ÿè£…ï¼ˆ3ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰ | 1.5æ—¥ | ğŸ”´ HIGH | Level 10+ãƒã‚§ãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° |
| **ã‚¿ã‚¹ã‚¯4**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£… | 2æ—¥ | ğŸŸ¡ MEDIUM | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜å®Ÿè£…ç¢ºèªï¼‰ |
| **ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°** | 2æ—¥ | ğŸ”´ HIGH | æ¨©é™ãƒ†ã‚¹ãƒˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ |

**åˆè¨ˆ**: 9æ—¥ï¼ˆå…±é€šDBæ§‹ç¯‰å¾Œã«å®Ÿæ–½ã€ProjectTrackingå®Ÿè£…å¾Œï¼‰

**ãƒ†ã‚¹ãƒˆè¦ä»¶**:
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 15ã‚±ãƒ¼ã‚¹ä»¥ä¸Šï¼ˆé…å»¶åˆ¤å®šã€é€²æ—è¨ˆç®—ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰
- APIçµ±åˆãƒ†ã‚¹ãƒˆ: 12ã‚±ãƒ¼ã‚¹ä»¥ä¸Šï¼ˆ3ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ Ã— 4ã‚±ãƒ¼ã‚¹ï¼‰
- æ¨©é™ãƒ†ã‚¹ãƒˆ: Level 10/13ã§ã®å‹•ä½œç¢ºèªï¼ˆå¿…é ˆï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ: 1,000ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®ä¸€è¦§å–å¾—é€Ÿåº¦ï¼ˆ< 500msï¼‰

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã®åˆ©ç”¨**: æ—¢å­˜APIã®ã¿ä½¿ç”¨
- GET /api/v2/facilities - æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼å–å¾—
- GET /api/v2/departments - éƒ¨é–€ãƒã‚¹ã‚¿ãƒ¼å–å¾—
- GET /api/v2/employees/{id} - è·å“¡æƒ…å ±å–å¾—

**ç‰¹è¨˜äº‹é …**:
- âš ï¸ Level 10ï¼ˆéƒ¨é•·ï¼‰ã¯è‡ªéƒ¨é–€ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- âš ï¸ Level 13+ï¼ˆç†äº‹ï¼‰ã¯å…¨æ–½è¨­ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- âœ… é€²æ—è¨ˆç®—ã¯ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å®Œäº†ç‡ã‹ã‚‰è‡ªå‹•ç®—å‡º
- ğŸ“Š é…å»¶åˆ¤å®šã¯æœŸé™æ—¥æ™‚ < ç¾åœ¨æ—¥æ™‚ && status !== 'completed'

---

### 6.4 Strategic HR Plan APIçµ±åˆãƒ†ã‚¹ãƒˆ

**å‰ææ¡ä»¶**:
- â³ Phase 1å®Ÿè£…äºˆå®šï¼ˆ2025å¹´10æœˆ21æ—¥ã€œ11æœˆ1æ—¥ï¼‰
- â³ å˜ä½“ãƒ†ã‚¹ãƒˆäºˆå®šï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰
- âœ… å®Ÿè£…æ–¹é‡ç¢ºå®šæ¸ˆã¿ï¼ˆMED-CONF-2025-1010-013ï¼‰
- âœ… VoiceDriveå›ç­”æ›¸å—é ˜æ¸ˆã¿ï¼ˆVD-A-2025-1010-012ï¼‰

#### 6.4.1 Phaseåˆ†å‰²æˆ¦ç•¥

**Phase 1: æˆ¦ç•¥çš„äººäº‹è¨ˆç”»ã‚¿ãƒ–ï¼ˆæ¨å®š6æ—¥ã€10/21-11/1ï¼‰**
- DB: 3ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆStrategicHRGoal, StrategicInitiative, HRStrategyRoadmapï¼‰
- API: 4ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- ã‚¹ã‚³ãƒ¼ãƒ—å¤–: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æã€çµ„ç¹”å¥å…¨æ€§æŒ‡æ¨™ã€é€€è·ç†ç”±åˆ†æ

**Phase 2: çµ„ç¹”é–‹ç™ºãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æï¼ˆæ¨å®š6.5æ—¥ã€12æœˆä¸­æ—¬ã€œ1æœˆä¸Šæ—¬ï¼‰**
- DB: 5ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆOrganizationHealthMetrics, PerformanceAnalytics, ImprovementProposalç­‰ï¼‰
- API: 5ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- VoiceDriveæ´»å‹•ãƒ‡ãƒ¼ã‚¿çµ±åˆé–‹å§‹

**Phase 3: é€€è·ç®¡ç†ãƒ»é«˜åº¦åˆ†æï¼ˆæ¨å®š3.5æ—¥ã€2026å¹´1æœˆä¸‹æ—¬ã€œ2æœˆä¸Šæ—¬ï¼‰**
- DB: 5ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆRetirementProcess, InfluenceAnalysisç­‰ï¼‰
- API: 3ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- å½±éŸ¿åŠ›åˆ†æã®å®Ÿãƒ‡ãƒ¼ã‚¿è¡¨ç¤º

#### 6.4.2 ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# .env.productionã«è¿½åŠ 
STRATEGIC_HR_API_KEY=[openssl rand -hex 32ã§ç”Ÿæˆã—ãŸAPI Key]

# VoiceDriveå´ã®è¨­å®šç¢ºèªï¼ˆVoiceDriveãƒãƒ¼ãƒ ã«å…±æœ‰ï¼‰
# MEDICAL_SYSTEM_STRATEGIC_HR_URL=https://medical.example.com/api/v2/strategic-hr
# MEDICAL_SYSTEM_STRATEGIC_HR_KEY=[ä¸Šè¨˜ã®STRATEGIC_HR_API_KEYã¨åŒã˜å€¤]
```

**API Keyç”Ÿæˆæ–¹æ³•**:
```bash
# ãƒ©ãƒ³ãƒ€ãƒ ãªAPI Keyã‚’ç”Ÿæˆ
openssl rand -hex 32

# ç”Ÿæˆã•ã‚ŒãŸAPI Keyã‚’.env.productionã¨VoiceDriveãƒãƒ¼ãƒ ã«å…±æœ‰
```

#### 6.4.3 Phase 1å®Ÿãƒ‡ãƒ¼ã‚¿ã§APIå‹•ä½œç¢ºèª

```bash
# API-1: æˆ¦ç•¥çš„äººäº‹ç›®æ¨™å–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/strategic-hr/goals?fiscalYear=2024&facilityId=facility-001" \
  -H "X-API-Key: ${STRATEGIC_HR_API_KEY}"

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {
#   "data": {
#     "fiscalYear": 2024,
#     "facilityId": "facility-001",
#     "employeeSatisfactionTarget": 85.0,
#     "employeeSatisfactionCurrent": 82.3,
#     "turnoverRateTarget": 8.5,
#     "turnoverRateCurrent": 9.2,
#     "annualHiringTarget": 15,
#     "annualHiringCurrent": 12
#   },
#   "meta": {
#     "timestamp": "2025-10-21T12:00:00.000Z"
#   }
# }

# API-2: æˆ¦ç•¥çš„ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–å–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/strategic-hr/initiatives?facilityId=facility-001&status=in_progress" \
  -H "X-API-Key: ${STRATEGIC_HR_API_KEY}"

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {
#   "data": [
#     {
#       "id": "init-001",
#       "name": "ãƒ¡ãƒ³ã‚¿ãƒ¼åˆ¶åº¦å°å…¥",
#       "description": "æ–°äººçœ‹è­·å¸«å‘ã‘ãƒ¡ãƒ³ã‚¿ãƒ¼åˆ¶åº¦ã®å°å…¥",
#       "category": "äººæè‚²æˆ",
#       "progressPercent": 65.0,
#       "deadline": "2024-12-31",
#       "priority": "high",
#       "status": "in_progress"
#     }
#   ],
#   "meta": {
#     "total": 5,
#     "timestamp": "2025-10-21T12:00:00.000Z"
#   }
# }

# API-3: äººææˆ¦ç•¥ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—å–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/strategic-hr/roadmap?facilityId=facility-001" \
  -H "X-API-Key: ${STRATEGIC_HR_API_KEY}"

# API-4: é€€è·çµ±è¨ˆå–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/retirement/statistics?facilityId=facility-001&fiscalYear=2024" \
  -H "X-API-Key: ${STRATEGIC_HR_API_KEY}"

# æ³¨æ„: Phase 1ã§ã¯åŸºæœ¬çµ±è¨ˆã®ã¿ã€Phase 3ã§è©³ç´°ãªé€€è·ç†ç”±åˆ†æã‚’å®Ÿè£…
```

#### 6.4.4 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ

```bash
# 401 Unauthorizedï¼ˆAPI Keyæœªæä¾›ï¼‰
curl -X GET "http://localhost:3000/api/v2/strategic-hr/goals?fiscalYear=2024"
# æœŸå¾…: {"error":{"code":"UNAUTHORIZED","message":"API Key is required"}}

# 401 Unauthorizedï¼ˆä¸æ­£ãªAPI Keyï¼‰
curl -X GET "http://localhost:3000/api/v2/strategic-hr/goals?fiscalYear=2024" \
  -H "X-API-Key: invalid-key"
# æœŸå¾…: {"error":{"code":"UNAUTHORIZED","message":"Invalid API Key"}}

# 403 Forbiddenï¼ˆæ¨©é™ä¸è¶³ï¼‰
curl -X GET "http://localhost:3000/api/v2/strategic-hr/goals?fiscalYear=2024" \
  -H "X-API-Key: ${STRATEGIC_HR_API_KEY}" \
  -H "X-User-Permission-Level: 10"
# æœŸå¾…: {"error":{"code":"FORBIDDEN","message":"Level 16+ required"}}

# 429 Rate Limitè¶…éãƒ†ã‚¹ãƒˆï¼ˆ100å›è¶…éã§ã‚¨ãƒ©ãƒ¼ï¼‰
for i in {1..105}; do
  curl -X GET "http://localhost:3000/api/v2/strategic-hr/goals?fiscalYear=2024" \
    -H "X-API-Key: ${STRATEGIC_HR_API_KEY}" \
    -H "X-Forwarded-For: 192.168.1.200"
done
# 101å›ç›®ä»¥é™: {"error":{"code":"RATE_LIMIT_EXCEEDED","message":"Too many requests"}}
```

#### 6.4.5 VoiceDriveãƒãƒ¼ãƒ ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
# VoiceDriveãƒãƒ¼ãƒ ã«ä»¥ä¸‹ã‚’å…±æœ‰:
# - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL: https://medical.example.com/api/v2/strategic-hr
# - VoiceDriveç”¨APIã‚­ãƒ¼: [Slackã§å…±æœ‰]
# - å®Ÿè£…æ–¹é‡ç¢ºå®šæ›¸: mcp-shared/docs/strategic-hr-plan_å®Ÿè£…æ–¹é‡ç¢ºå®šæ›¸_20251010.md

# VoiceDriveãƒãƒ¼ãƒ å´ã§ã®ç¢ºèªäº‹é …:
# 1. StrategicHRServiceã§APIã‚’å‘¼ã³å‡ºã—ï¼ˆPhase 1: 4ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
# 2. StrategicHRPageã®æˆ¦ç•¥çš„äººäº‹è¨ˆç”»ã‚¿ãƒ–ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º
# 3. Level 16æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸å‹•ä½œ
# 4. æ–½è¨­ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆLevel 18ç”¨ï¼‰ãŒå‹•ä½œ
```

#### 6.4.6 Phase 1çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†åŸºæº–
- [ ] API-1ï¼ˆæˆ¦ç•¥çš„äººäº‹ç›®æ¨™ï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] API-2ï¼ˆæˆ¦ç•¥çš„ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–ï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] API-3ï¼ˆäººææˆ¦ç•¥ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] API-4ï¼ˆé€€è·çµ±è¨ˆï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] Rate Limitãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ­£å¸¸ã«è¿”å´ã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä»•æ§˜é€šã‚Š
- [ ] VoiceDrive StrategicHRPageã®æˆ¦ç•¥çš„äººäº‹è¨ˆç”»ã‚¿ãƒ–ã§è¡¨ç¤ºç¢ºèª
- [ ] Level 16æ¨©é™ãƒã‚§ãƒƒã‚¯å‹•ä½œç¢ºèª
- [ ] æ–½è¨­ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‹•ä½œç¢ºèªï¼ˆLevel 18ç”¨ï¼‰

**æ¨å®šå·¥æ•°**: Phase 1çµ±åˆãƒ†ã‚¹ãƒˆ 2æ—¥é–“ï¼ˆDBæ§‹ç¯‰å¾Œï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- å®Ÿè£…æ–¹é‡ç¢ºå®šæ›¸: `mcp-shared/docs/strategic-hr-plan_å®Ÿè£…æ–¹é‡ç¢ºå®šæ›¸_20251010.md`
- VoiceDriveå›ç­”æ›¸: `mcp-shared/docs/strategic-hr-plan_VoiceDriveå›ç­”æ›¸_20251010.md`
- DBè¦ä»¶åˆ†æ: `mcp-shared/docs/strategic-hr-plan_DBè¦ä»¶åˆ†æ_20251010.md`
- ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆæ‰¿èªä¾é ¼: `mcp-shared/docs/strategic-hr-plan_ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆæ‰¿èªä¾é ¼_20251010.md`

**å®Ÿè£…äºˆå®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPhase 1ï¼‰**:
- `src/app/api/v2/strategic-hr/goals/route.ts` - æˆ¦ç•¥çš„äººäº‹ç›®æ¨™API
- `src/app/api/v2/strategic-hr/initiatives/route.ts` - æˆ¦ç•¥çš„ã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–API
- `src/app/api/v2/strategic-hr/roadmap/route.ts` - äººææˆ¦ç•¥ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—API
- `src/app/api/v2/retirement/statistics/route.ts` - é€€è·çµ±è¨ˆAPI
- ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«4ä»¶ï¼ˆPhase 1å˜ä½“ãƒ†ã‚¹ãƒˆï¼‰

#### 6.4.7 Phase 2/3çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå°†æ¥å®Ÿè£…ï¼‰

**Phase 2çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ12æœˆä¸­æ—¬ã€œ1æœˆä¸Šæ—¬äºˆå®šï¼‰**:
- çµ„ç¹”å¥å…¨æ€§æŒ‡æ¨™APIçµ±åˆãƒ†ã‚¹ãƒˆ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æAPIçµ±åˆãƒ†ã‚¹ãƒˆ
- æ”¹å–„ææ¡ˆå®Ÿç¸¾APIçµ±åˆãƒ†ã‚¹ãƒˆ
- VoiceDriveæ´»å‹•ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ†ã‚¹ãƒˆ

**Phase 3çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ2026å¹´1æœˆä¸‹æ—¬ã€œ2æœˆä¸Šæ—¬äºˆå®šï¼‰**:
- é€€è·ãƒ—ãƒ­ã‚»ã‚¹APIçµ±åˆãƒ†ã‚¹ãƒˆ
- é€€è·ç†ç”±åˆ†æAPIçµ±åˆãƒ†ã‚¹ãƒˆ
- å½±éŸ¿åŠ›åˆ†æAPIçµ±åˆãƒ†ã‚¹ãƒˆ

---

## 6.5 Phase X: çµ„ç¹”æ§‹é€ ãƒã‚¹ã‚¿ãƒ¼çµ±åˆå®Ÿè£…

**å®Ÿè£…ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: å…±é€šDBæ§‹ç¯‰å®Œäº†å¾Œ
**å®Ÿè£…æœŸé–“**: 2é€±é–“ï¼ˆ10å–¶æ¥­æ—¥ï¼‰
**æ‹…å½“**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ  + VoiceDriveãƒãƒ¼ãƒ 
**é‡è¦åº¦**: ğŸ”´ HIGH
**æ‰¿èªæ—¥**: 2025å¹´10æœˆ12æ—¥
**æ‰¿èªæ–‡æ›¸**: `mcp-shared/docs/çµ„ç¹”æ§‹é€ æ‹¡å¼µå®Ÿè£…_ãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³çµ±åˆå›ç­”æ›¸_20251012.md`

### 6.5.1 å®Ÿè£…æ¦‚è¦

VoiceDriveã®è­°é¡Œãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã«ãŠã„ã¦ã€ç—…é™¢çµ„ç¹”æ§‹é€ ã«åŸºã¥ãæŸ”è»ŸãªæŠ•ç¥¨ã‚¹ã‚³ãƒ¼ãƒ—ç®¡ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

**å®Ÿè£…æ–¹é‡**:
- çµ„ç¹”ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãŒç®¡ç†ï¼ˆSingle Source of Truthï¼‰
- VoiceDriveã¯APIçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + æŠ•ç¥¨ãƒ«ãƒ¼ãƒ«ç®¡ç†
- ä¸¡ã‚·ã‚¹ãƒ†ãƒ åŒæ™‚å®Ÿè£…ã«ã‚ˆã‚Šæ•´åˆæ€§ç¢ºä¿

### 6.5.2 åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´å®Ÿè£…ï¼ˆ3å–¶æ¥­æ—¥ï¼‰

#### ã‚¿ã‚¹ã‚¯ä¸€è¦§

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° | æ‹…å½“ | å„ªå…ˆåº¦ |
|--------|------|------|--------|
| **çµ„ç¹”ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ** | 0.5æ—¥ | DBãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼APIå®Ÿè£…** | 1æ—¥ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **çµ„ç¹”æ§‹é€ ãƒã‚¹ã‚¿ãƒ¼APIå®Ÿè£…** | 1æ—¥ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **è·ç¨®ãƒã‚¹ã‚¿ãƒ¼APIå®Ÿè£…** | 0.5æ—¥ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒ  | ğŸ”´ HIGH |

#### å®Ÿè£…API

```typescript
// æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼API
GET /api/v2/facilities              // æ–½è¨­ä¸€è¦§
GET /api/v2/facilities/{id}         // æ–½è¨­è©³ç´°

// çµ„ç¹”æ§‹é€ ãƒã‚¹ã‚¿ãƒ¼API
GET /api/v2/departments             // éƒ¨é–€ä¸€è¦§
GET /api/v2/departments/{id}        // éƒ¨é–€è©³ç´°
GET /api/v2/departments/{id}/members // éƒ¨é–€æ‰€å±è·å“¡

// è·ç¨®ãƒã‚¹ã‚¿ãƒ¼API
GET /api/v2/job-categories          // è·ç¨®ãƒã‚¹ã‚¿ãƒ¼ä¸€è¦§
```

#### ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

```sql
-- æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼
CREATE TABLE facilities (
  id VARCHAR(50) PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  facility_type VARCHAR(50),
  staff_count INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- çµ„ç¹”æ§‹é€ ãƒã‚¹ã‚¿ãƒ¼
CREATE TABLE organization_structures (
  id VARCHAR(50) PRIMARY KEY,
  facility_id VARCHAR(50) REFERENCES facilities(id),
  name VARCHAR(200) NOT NULL,
  code VARCHAR(50) NOT NULL,
  type VARCHAR(50),  -- clinical/administrative/support
  parent_id VARCHAR(50),
  staff_count INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(facility_id, code)
);

-- è·ç¨®ãƒã‚¹ã‚¿ãƒ¼
CREATE TABLE job_categories (
  id VARCHAR(50) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  code VARCHAR(50) NOT NULL UNIQUE,
  category VARCHAR(50),  -- nursing/rehabilitation/medical/admin
  requires_license BOOLEAN DEFAULT false,
  license_type VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.5.3 VoiceDriveå´å®Ÿè£…ï¼ˆ5å–¶æ¥­æ—¥ï¼‰

#### ã‚¿ã‚¹ã‚¯ä¸€è¦§

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° | æ‹…å½“ | å„ªå…ˆåº¦ |
|--------|------|------|--------|
| **Prismaã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ** | 0.5æ—¥ | VoiceDriveãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ** | 0.5æ—¥ | VoiceDriveãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥** | 1æ—¥ | VoiceDriveãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **æŠ•ç¥¨ã‚¹ã‚³ãƒ¼ãƒ—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…** | 2æ—¥ | VoiceDriveãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIé€£æº** | 1æ—¥ | VoiceDriveãƒãƒ¼ãƒ  | ğŸ”´ HIGH |

#### å®Ÿè£…å†…å®¹
- VoiceDrive Prismaã‚¹ã‚­ãƒ¼ãƒã«8ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆæº–å‚™æ¸ˆã¿ï¼‰
- æŠ•ç¥¨ã‚¹ã‚³ãƒ¼ãƒ—ãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…ï¼ˆA: location_based, B: profession_based, C: department_basedï¼‰
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…
- æ—¥æ¬¡ãƒãƒƒãƒåŒæœŸæ©Ÿèƒ½å®Ÿè£…

### 6.5.4 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ2å–¶æ¥­æ—¥ï¼‰

| ãƒ†ã‚¹ãƒˆé …ç›® | å·¥æ•° | æ‹…å½“ | å„ªå…ˆåº¦ |
|-----------|------|------|--------|
| **APIé€£æºãƒ†ã‚¹ãƒˆ** | 0.5æ—¥ | ä¸¡ãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ** | 0.5æ—¥ | ä¸¡ãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **æŠ•ç¥¨ã‚¹ã‚³ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ** | 0.5æ—¥ | VoiceDriveãƒãƒ¼ãƒ  | ğŸ”´ HIGH |
| **ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ** | 0.5æ—¥ | ä¸¡ãƒãƒ¼ãƒ  | ğŸ”´ HIGH |

### 6.5.5 å®Ÿè£…ãƒ‡ãƒ¼ã‚¿è©³ç´°

#### æ–½è¨­æƒ…å ±ï¼ˆ3æ–½è¨­ãƒ»ç¢ºå®šï¼‰

| æ–½è¨­ã‚³ãƒ¼ãƒ‰ | æ–½è¨­å | ç¨®åˆ¥ | è·å“¡æ•° | éƒ¨é–€æ•° |
|-----------|--------|------|--------|--------|
| `obara-hospital` | å°åŸç—…é™¢ | æ€¥æ€§æœŸç—…é™¢ | ç´„80å | 10éƒ¨é–€ |
| `tategami-rehabilitation` | ç«‹ç¥ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¸©æ³‰ç—…é™¢ | å›å¾©æœŸãƒªãƒãƒ“ãƒªç—…é™¢ | ç´„100å | 7éƒ¨é–€ |
| `espoir-tategami` | ä»‹è­·è€äººä¿å¥æ–½è¨­ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ | è€å¥æ–½è¨­ | ç´„150å | 6éƒ¨é–€ |

#### æŠ•ç¥¨ã‚¹ã‚³ãƒ¼ãƒ—ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç¢ºå®šï¼‰

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | ã‚³ãƒ¼ãƒ‰ | é©ç”¨éƒ¨é–€ | èª¬æ˜ |
|---------|--------|---------|------|
| **A** | `location_based` | çœ‹è­·éƒ¨é–€ | ç—…æ£Ÿãƒ»å¤–æ¥å˜ä½ã§ã®æŠ•ç¥¨ |
| **B** | `profession_based` | ãƒªãƒãƒ“ãƒªéƒ¨é–€ | è·ç¨®å˜ä½ã§ã®æŠ•ç¥¨ï¼ˆPT/OT/STï¼‰ |
| **C** | `department_based` | å°è¦æ¨¡éƒ¨é–€ | éƒ¨é–€å…¨ä½“ã§ã®æŠ•ç¥¨ |

#### æ–°è¦è·ç¨®ï¼ˆ5è·ç¨®è¿½åŠ ï¼‰

| è·ç¨®ã‚³ãƒ¼ãƒ‰ | è·ç¨®å | è³‡æ ¼è¦å¦ | è©²å½“æ–½è¨­ |
|-----------|--------|---------|---------|
| `care_manager` | ã‚±ã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ | å¿…è¦ï¼ˆä»‹è­·æ”¯æ´å°‚é–€å“¡ï¼‰ | ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ |
| `social_worker` | ç¤¾ä¼šç¦ç¥‰å£« | å¿…è¦ï¼ˆç¤¾ä¼šç¦ç¥‰å£«ï¼‰ | ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ |
| `certified_care_worker` | ä»‹è­·ç¦ç¥‰å£« | å¿…è¦ï¼ˆå›½å®¶è³‡æ ¼ï¼‰ | ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ |
| `registered_dietitian` | ç®¡ç†æ „é¤Šå£« | å¿…è¦ï¼ˆå›½å®¶è³‡æ ¼ï¼‰ | å…¨æ–½è¨­ |
| `dietitian` | æ „é¤Šå£« | å¿…è¦ï¼ˆéƒ½é“åºœçœŒè³‡æ ¼ï¼‰ | å…¨æ–½è¨­ |

### 6.5.6 å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```
Week 1ï¼ˆå…±é€šDBæ§‹ç¯‰å®Œäº†å¾Œï¼‰:
  Day 1-2: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´DBè¨­è¨ˆãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
  Day 3-4: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´APIå®Ÿè£…
  Day 5: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´APIå‹•ä½œç¢ºèª

Week 2:
  Day 1: VoiceDriveå´ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  Day 2: VoiceDriveå´ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
  Day 3-4: VoiceDriveå´æŠ•ç¥¨ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
  Day 5: VoiceDriveå´åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIé€£æºå®Ÿè£…

Week 3ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰:
  Day 1-2: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½
  Day 3: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
  Day 4: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿæ–½
  Day 5: æœ¬ç•ªç’°å¢ƒç›£è¦–ãƒ»èª¿æ•´
```

### 6.5.7 æˆåŠŸåŸºæº–

- [ ] 3æ–½è¨­ï¼ˆå°åŸç—…é™¢ãƒ»ç«‹ç¥ãƒªãƒãƒ“ãƒªãƒ»ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ï¼‰ã®ãƒ‡ãƒ¼ã‚¿æ­£å¸¸ç™»éŒ²
- [ ] 23éƒ¨é–€ã®ãƒ‡ãƒ¼ã‚¿æ­£å¸¸ç™»éŒ²
- [ ] 24è·ç¨®ï¼ˆæ–°è¦5è·ç¨®å«ã‚€ï¼‰ã®ãƒ‡ãƒ¼ã‚¿æ­£å¸¸ç™»éŒ²
- [ ] æŠ•ç¥¨ã‚¹ã‚³ãƒ¼ãƒ—ãƒ‘ã‚¿ãƒ¼ãƒ³A/B/Cå‹•ä½œç¢ºèª
- [ ] åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®çµ„ç¹”å¤‰æ›´åæ˜ ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆWebhookçµŒç”±ï¼‰
- [ ] APIå¿œç­”æ™‚é–“ < 200ms
- [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯æˆåŠŸ

### 6.5.8 ç›£è¦–ãƒ»é‹ç”¨

**ç›£è¦–é …ç›®**:
- APIå¿œç­”æ™‚é–“
- ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼ç‡
- Webhooké€ä¿¡æˆåŠŸç‡
- æŠ•ç¥¨ã‚¹ã‚³ãƒ¼ãƒ—åˆ¤å®šã‚¨ãƒ©ãƒ¼

**é‹ç”¨æ‰‹é †**:
1. æ—¥æ¬¡ãƒãƒƒãƒã«ã‚ˆã‚‹çµ„ç¹”ãƒ‡ãƒ¼ã‚¿åŒæœŸï¼ˆæ·±å¤œ2:00 JSTï¼‰
2. Webhookã«ã‚ˆã‚‹çµ„ç¹”å¤‰æ›´å³æ™‚åæ˜ 
3. é€±æ¬¡ã§ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æ›œæ·±å¤œï¼‰

### 6.5.9 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- çµ„ç¹”æƒ…å ±æä¾›æ›¸: `mcp-shared/docs/çµ„ç¹”æƒ…å ±åé›†ä¾é ¼_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ è¿”ä¿¡æ›¸_20251012.md`
- ãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³çµ±åˆå›ç­”æ›¸: `mcp-shared/docs/çµ„ç¹”æ§‹é€ æ‹¡å¼µå®Ÿè£…_ãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³çµ±åˆå›ç­”æ›¸_20251012.md`
- æŠ•ç¥¨ã‚°ãƒ«ãƒ¼ãƒ—æ‰¿èªè€…æ©Ÿèƒ½ç¢ºèª: `mcp-shared/docs/æŠ•ç¥¨ã‚°ãƒ«ãƒ¼ãƒ—æ‰¿èªè€…æ©Ÿèƒ½_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªå›ç­”_20251012.md`
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ è³ªå•å›ç­”æ›¸: `mcp-shared/docs/åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ è³ªå•_VoiceDriveå›ç­”æ›¸_20251012.md`
- ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸: `mcp-shared/docs/ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md`

---

### 6.6 Phase 3: å§”å“¡ä¼šãƒã‚¹ã‚¿APIå®Ÿè£…ï¼ˆProposalDocumenté€£æºï¼‰

**å®Ÿè£…æ™‚æœŸ**: 2025å¹´11æœˆ8æ—¥ï¼ˆé‡‘ï¼‰ã€œ11æœˆ15æ—¥ï¼ˆé‡‘ï¼‰ï¼ˆ8æ—¥é–“ï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ ä¸­å„ªå…ˆåº¦
**å‚ç…§æ–‡æ›¸**: `mcp-shared/docs/ProposalDocument_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251021.md`

#### 6.6.1 å®Ÿè£…æ¦‚è¦

VoiceDriveå´ã®è­°é¡Œææ¡ˆæ›¸ç·¨é›†ãƒšãƒ¼ã‚¸ï¼ˆProposalDocumentEditorï¼‰ã§å§”å“¡ä¼šä¸€è¦§ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®APIå®Ÿè£…ã€‚

**ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»**:
- å§”å“¡ä¼šãƒã‚¹ã‚¿: âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç®¡è½„
- è­°é¡Œææ¡ˆæ›¸ãƒ‡ãƒ¼ã‚¿: âŒ VoiceDrive 100%ç®¡è½„

#### 6.6.2 DBå®Ÿè£…ï¼ˆDay 1-2ï¼‰

**æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**:

```prisma
// prisma/schema.prisma

// å§”å“¡ä¼šãƒã‚¹ã‚¿
model Committee {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  type            String   // operational, management, corporate
  level           String   // department, facility, corporate
  facilityId      String?  // æ–½è¨­ãƒ¬ãƒ™ãƒ«ã®å ´åˆ
  description     String?
  chairpersonId   String   // å§”å“¡é•·ã®employeeId
  meetingCycle    String   // monthly, quarterly, yearly
  nextMeetingDate DateTime?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  facility        Facility? @relation(fields: [facilityId], references: [id])
  members         CommitteeMember[]

  @@index([facilityId])
  @@index([level])
  @@index([type])
  @@map("committees")
}

// å§”å“¡ä¼šãƒ¡ãƒ³ãƒãƒ¼
model CommitteeMember {
  id          String   @id @default(cuid())
  committeeId String
  employeeId  String
  role        String   // chairperson, vice_chairperson, member, secretary
  joinedDate  DateTime @default(now())
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  committee   Committee @relation(fields: [committeeId], references: [id])

  @@unique([committeeId, employeeId])
  @@index([employeeId])
  @@map("committee_members")
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**:
```bash
# Day 1: ã‚¹ã‚­ãƒ¼ãƒä½œæˆ
npx prisma migrate dev --name add_committee_tables

# Day 2: æœ¬ç•ªç’°å¢ƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npx prisma migrate deploy
```

#### 6.6.3 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆDay 2ï¼‰

**å°åŸç—…é™¢ã®å§”å“¡ä¼šãƒ‡ãƒ¼ã‚¿**:
```javascript
// scripts/seed-committees.ts
const committees = [
  {
    code: 'OH-COM-001',
    name: 'æ¥­å‹™æ”¹å–„å§”å“¡ä¼š',
    type: 'operational',
    level: 'facility',
    facilityId: 'obara-hospital',
    description: 'æ–½è¨­é‹å–¶ã®æ¥­å‹™æ”¹å–„ã«é–¢ã™ã‚‹å¯©è­°',
    chairpersonId: 'OH-NS-2024-030', // å±±ç”°äº‹å‹™é•·
    meetingCycle: 'monthly',
    nextMeetingDate: new Date('2025-11-10T14:00:00Z')
  },
  {
    code: 'OH-COM-002',
    name: 'æ–½è¨­é‹å–¶å§”å“¡ä¼š',
    type: 'management',
    level: 'facility',
    facilityId: 'obara-hospital',
    description: 'æ–½è¨­å…¨ä½“ã®é‹å–¶æ–¹é‡ã«é–¢ã™ã‚‹å¯©è­°',
    chairpersonId: 'OH-NS-2024-040', // ä½è—¤é™¢é•·
    meetingCycle: 'monthly',
    nextMeetingDate: new Date('2025-11-15T10:00:00Z')
  },
  {
    code: 'CORP-COM-001',
    name: 'æ³•äººé‹å–¶å§”å“¡ä¼š',
    type: 'corporate',
    level: 'corporate',
    chairpersonId: 'CORP-2024-001', // ç†äº‹é•·
    meetingCycle: 'quarterly',
    nextMeetingDate: new Date('2025-12-20T13:00:00Z')
  }
];
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
npx tsx scripts/seed-committees.ts
```

#### 6.6.4 APIå®Ÿè£…ï¼ˆDay 3-4ï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v2/committees`

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/api/v2/committees/route.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
// src/app/api/v2/committees/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const level = searchParams.get('level');
    const facilityId = searchParams.get('facilityId');
    const type = searchParams.get('type');
    const userId = searchParams.get('userId');
    const userLevel = parseInt(searchParams.get('userLevel') || '1');

    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (userLevel < 5) {
      return NextResponse.json({
        success: false,
        error: 'å§”å“¡ä¼šæƒ…å ±ã®é–²è¦§ã«ã¯ Level 5 ä»¥ä¸Šã®æ¨©é™ãŒå¿…è¦ã§ã™'
      }, { status: 403 });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿æ§‹ç¯‰
    const where: any = { isActive: true };

    if (level) where.level = level;
    if (type) where.type = type;

    // Levelåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (userLevel >= 14) {
      // Level 14+: æ³•äººå…¨ä½“
      if (facilityId) where.facilityId = facilityId;
    } else if (userLevel >= 10) {
      // Level 10+: æ‰€å±æ–½è¨­ã®ã¿
      const user = await prisma.employee.findUnique({ where: { id: userId } });
      where.facilityId = user?.facilityId;
    } else {
      // Level 5-9: è‡ªåˆ†ãŒæ‰€å±ã™ã‚‹å§”å“¡ä¼šã®ã¿
      where.members = { some: { employeeId: userId, isActive: true } };
    }

    // å§”å“¡ä¼šå–å¾—
    const committees = await prisma.committee.findMany({
      where,
      include: {
        facility: { select: { id: true, name: true, code: true } },
        members: {
          where: { isActive: true },
          include: {
            employee: {
              select: { id: true, name: true, positionId: true }
            }
          }
        }
      },
      orderBy: { level: 'asc' }
    });

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢
    const response = committees.map(c => ({
      id: c.id,
      code: c.code,
      name: c.name,
      type: c.type,
      level: c.level,
      facilityId: c.facilityId,
      facilityName: c.facility?.name,
      description: c.description,
      chairperson: {
        id: c.chairpersonId,
        // å§”å“¡é•·æƒ…å ±ã¯membersã‹ã‚‰å–å¾—
        name: c.members.find(m => m.role === 'chairperson')?.employee.name || '',
        position: c.members.find(m => m.role === 'chairperson')?.employee.positionId || ''
      },
      members: c.members.map(m => ({
        id: m.employee.id,
        name: m.employee.name,
        role: m.role
      })),
      meetingCycle: c.meetingCycle,
      nextMeetingDate: c.nextMeetingDate
    }));

    return NextResponse.json({
      success: true,
      committees: response,
      total: response.length
    });
  } catch (error) {
    console.error('å§”å“¡ä¼šãƒã‚¹ã‚¿API Error:', error);
    return NextResponse.json({
      success: false,
      error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    }, { status: 500 });
  }
}
```

#### 6.6.5 å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆDay 5ï¼‰

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/api/v2/committees.test.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
// tests/api/v2/committees.test.ts
import { describe, it, expect } from '@jest/globals';

describe('GET /api/v2/committees', () => {
  it('æ­£å¸¸ç³»: å…¨å§”å“¡ä¼šå–å¾—ï¼ˆLevel 14+ï¼‰', async () => {
    const response = await fetch('/api/v2/committees?userId=CORP-2024-001&userLevel=14');
    const data = await response.json();

    expect(data.success).toBe(true);
    expect(data.committees).toHaveLength(3);
  });

  it('æ­£å¸¸ç³»: æ–½è¨­åˆ¥ãƒ•ã‚£ãƒ«ã‚¿', async () => {
    const response = await fetch('/api/v2/committees?facilityId=obara-hospital&userId=OH-NS-2024-040&userLevel=12');
    const data = await response.json();

    expect(data.success).toBe(true);
    expect(data.committees).toHaveLength(2); // æ¥­å‹™æ”¹å–„ã€æ–½è¨­é‹å–¶
  });

  it('æ­£å¸¸ç³»: ã‚¿ã‚¤ãƒ—åˆ¥ãƒ•ã‚£ãƒ«ã‚¿', async () => {
    const response = await fetch('/api/v2/committees?type=corporate&userId=CORP-2024-001&userLevel=14');
    const data = await response.json();

    expect(data.success).toBe(true);
    expect(data.committees).toHaveLength(1); // æ³•äººé‹å–¶
  });

  it('æ­£å¸¸ç³»: Level 10-13ã¯æ‰€å±æ–½è¨­ã®ã¿', async () => {
    const response = await fetch('/api/v2/committees?userId=OH-NS-2024-030&userLevel=10');
    const data = await response.json();

    expect(data.success).toBe(true);
    expect(data.committees.every(c => c.facilityId === 'obara-hospital')).toBe(true);
  });

  it('æ­£å¸¸ç³»: Level 5-9ã¯æ‰€å±å§”å“¡ä¼šã®ã¿', async () => {
    const response = await fetch('/api/v2/committees?userId=OH-NS-2024-015&userLevel=7');
    const data = await response.json();

    expect(data.success).toBe(true);
    // ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å§”å“¡ä¼šã®ã¿è¡¨ç¤º
  });

  it('ç•°å¸¸ç³»: Level 4ä»¥ä¸‹ã¯403ã‚¨ãƒ©ãƒ¼', async () => {
    const response = await fetch('/api/v2/committees?userId=OH-NS-2024-005&userLevel=4');

    expect(response.status).toBe(403);
    const data = await response.json();
    expect(data.success).toBe(false);
  });
});
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
npm run test -- tests/api/v2/committees.test.ts
```

#### 6.6.6 VoiceDriveçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆDay 6ï¼‰

**VoiceDriveå´ã®ä½¿ç”¨ä¾‹**:
```typescript
// VoiceDrive: src/services/CommitteeService.ts
async fetchCommittees(userId: string, userLevel: number) {
  const response = await fetch(
    `${MEDICAL_SYSTEM_API_URL}/api/v2/committees?userId=${userId}&userLevel=${userLevel}`
  );
  const data = await response.json();
  return data.committees;
}
```

**çµ±åˆãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª**:
1. VoiceDriveå´ã‹ã‚‰åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‚’å‘¼ã³å‡ºã—
2. å§”å“¡ä¼šä¸€è¦§ã‚’å–å¾—
3. ProposalDocumentEditorã®æå‡ºå…ˆé¸æŠUIã«è¡¨ç¤º
4. å§”å“¡é•·ãƒ»ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®è¡¨ç¤ºç¢ºèª

#### 6.6.7 å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| æ—¥ä»˜ | ä½œæ¥­å†…å®¹ | æ‹…å½“ | çŠ¶æ…‹ |
|------|---------|------|------|
| **11/8ï¼ˆé‡‘ï¼‰** | DBè¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ ææ¡ˆä¸­ |
| **11/11ï¼ˆæœˆï¼‰** | Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿæ–½ | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ ææ¡ˆä¸­ |
| **11/12ï¼ˆç«ï¼‰** | ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥ | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ ææ¡ˆä¸­ |
| **11/13ï¼ˆæ°´ï¼‰** | APIå®Ÿè£… | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ ææ¡ˆä¸­ |
| **11/14ï¼ˆæœ¨ï¼‰** | å˜ä½“ãƒ†ã‚¹ãƒˆ | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ ææ¡ˆä¸­ |
| **11/15ï¼ˆé‡‘ï¼‰** | VoiceDriveçµ±åˆãƒ†ã‚¹ãƒˆ | ä¸¡ãƒãƒ¼ãƒ  | â³ ææ¡ˆä¸­ |

#### 6.6.8 æˆåŠŸåŸºæº–

- âœ… Committeeãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†
- âœ… CommitteeMemberãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†
- âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†ï¼ˆæœ€ä½3å§”å“¡ä¼šï¼‰
- âœ… `GET /api/v2/committees` APIå®Ÿè£…å®Œäº†
- âœ… å˜ä½“ãƒ†ã‚¹ãƒˆ7ä»¶å…¨ã¦æˆåŠŸ
- âœ… VoiceDriveå´ã‹ã‚‰ã®APIå‘¼ã³å‡ºã—æˆåŠŸ
- âœ… ProposalDocumentEditorã§ã®å§”å“¡ä¼šé¸æŠå‹•ä½œç¢ºèª

#### 6.6.9 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ: `mcp-shared/docs/ProposalDocument_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251021.md`
- VoiceDrive DBè¦ä»¶åˆ†æ: æä¾›å¾…ã¡ï¼ˆPDE-DB-2025-1021-001ï¼‰
- ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸: `mcp-shared/docs/ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md`

---

### 6.7 Phase 7: ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹æ©Ÿèƒ½ï¼ˆCareer Course Change Requestï¼‰

**å®Ÿè£…æ™‚æœŸ**: å…±é€šDBæ§‹ç¯‰å¾Œï¼ˆäºˆå®šï¼š2025å¹´12æœˆ-2026å¹´1æœˆï¼‰
**å„ªå…ˆåº¦**: ğŸ”´ **CRITICAL**ï¼ˆäººäº‹åˆ¶åº¦ã®ä¸­æ ¸æ©Ÿèƒ½ï¼‰
**å‚ç…§æ–‡æ›¸**: `mcp-shared/docs/career-course-change_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251021.md`

#### 6.7.1 å®Ÿè£…æ¦‚è¦

VoiceDriveå´ã®ã€Œã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ãƒšãƒ¼ã‚¸ã€ã§ã€è·å“¡ãŒã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ã‚¹ï¼ˆA/B/C/Dï¼‰ã®å¤‰æ›´ã‚’ç”³è«‹ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã€‚

**ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»**:
- ã‚³ãƒ¼ã‚¹å®šç¾©ãƒã‚¹ã‚¿: âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  100%ç®¡è½„
- ç¾åœ¨ã®ã‚³ãƒ¼ã‚¹é¸æŠçŠ¶æ³: âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  100%ç®¡è½„
- ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ãƒ‡ãƒ¼ã‚¿: âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  100%ç®¡è½„
- æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  100%ç®¡è½„ï¼ˆS3/CloudFrontï¼‰
- VoiceDrive: âŒ UIã®ã¿ï¼ˆãƒ‡ãƒ¼ã‚¿ç®¡ç†ãªã—ï¼‰

#### 6.7.2 DBå®Ÿè£…ï¼ˆWeek 1: Day 1-2ï¼‰

**æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆ3ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰**:

```prisma
// prisma/schema.prisma

// ã‚³ãƒ¼ã‚¹å®šç¾©ãƒã‚¹ã‚¿
model CareerCourseDefinition {
  id                           String  @id @default(cuid())
  courseCode                   String  @unique // 'A', 'B', 'C', 'D'
  courseName                   String
  description                  String?
  departmentTransferAvailable  Boolean @default(true)
  facilityTransferAvailable    String  @default("none") // 'none', 'limited', 'full'
  relocationRequired           Boolean @default(false)
  nightShiftAvailable          String  @default("none") // 'none', 'selectable', 'required'
  managementTrack              Boolean @default(false)
  baseSalaryMultiplier         Float   @default(1.0)
  salaryGrade                  Int?
  salaryNotes                  String?
  isActive                     Boolean @default(true)
  displayOrder                 Int     @default(0)
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  selections                   CareerCourseSelection[]
  requestsAsCurrent            CareerCourseChangeRequest[] @relation("CurrentCourse")
  requestsAsRequested          CareerCourseChangeRequest[] @relation("RequestedCourse")

  @@index([courseCode])
  @@index([isActive])
  @@map("career_course_definitions")
}

// ç¾åœ¨ã®ã‚³ãƒ¼ã‚¹é¸æŠçŠ¶æ³
model CareerCourseSelection {
  id                        String    @id @default(cuid())
  employeeId                String
  courseCode                String
  effectiveFrom             DateTime
  effectiveTo               DateTime?
  nextChangeAvailableDate   DateTime?
  specialChangeReason       String?   // 'pregnancy', 'caregiving', 'illness'
  specialChangeNote         String?
  changeRequestedAt         DateTime?
  changeRequestedBy         String?
  approvedAt                DateTime?
  approvedBy                String?
  approvalStatus            String    @default("approved") // 'pending', 'approved', 'rejected', 'withdrawn'
  rejectionReason           String?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  employee        Employee                 @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  courseDefinition CareerCourseDefinition @relation(fields: [courseCode], references: [courseCode])
  approver         Employee?               @relation("CourseApprover", fields: [approvedBy], references: [id])

  @@index([employeeId])
  @@index([courseCode])
  @@index([effectiveFrom, effectiveTo])
  @@index([approvalStatus])
  @@map("career_course_selections")
}

// ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹
model CareerCourseChangeRequest {
  id                       String    @id @default(cuid())
  employeeId               String
  currentCourseCode        String
  requestedCourseCode      String
  changeReason             String    // 'annual', 'special_pregnancy', 'special_caregiving', 'special_illness'
  reasonDetail             String
  requestedEffectiveDate   DateTime
  hrReviewerId             String?
  hrReviewerName           String?
  reviewedAt               DateTime?
  reviewComment            String?
  approvalStatus           String    @default("pending") // 'pending', 'approved', 'rejected', 'withdrawn'
  rejectionReason          String?
  withdrawnAt              DateTime?
  attachments              Json?     // [{"fileUrl": "...", "fileName": "...", "fileSize": 123, "uploadedAt": "..."}]
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  employee          Employee                @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  currentCourse     CareerCourseDefinition  @relation("CurrentCourse", fields: [currentCourseCode], references: [courseCode])
  requestedCourse   CareerCourseDefinition  @relation("RequestedCourse", fields: [requestedCourseCode], references: [courseCode])
  hrReviewer        Employee?               @relation("HRReviewer", fields: [hrReviewerId], references: [id])

  @@index([employeeId])
  @@index([approvalStatus])
  @@index([createdAt(sort: Desc)])
  @@map("career_course_change_requests")
}

// Employeeãƒ¢ãƒ‡ãƒ«ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
model Employee {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ...

  // ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ã‚¹é–¢é€£ï¼ˆè¿½åŠ ï¼‰
  careerCourseSelections    CareerCourseSelection[]
  careerCourseApprovals     CareerCourseSelection[] @relation("CourseApprover")
  careerCourseChangeRequests CareerCourseChangeRequest[]
  careerCourseHRReviews     CareerCourseChangeRequest[] @relation("HRReviewer")
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**:
```bash
# Day 1-2: ã‚¹ã‚­ãƒ¼ãƒä½œæˆ
npx prisma migrate dev --name add_career_course_tables

# æœ¬ç•ªç’°å¢ƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npx prisma migrate deploy
```

#### 6.7.3 åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆWeek 1: Day 2ï¼‰

**A/B/C/Dã‚³ãƒ¼ã‚¹å®šç¾©ãƒ‡ãƒ¼ã‚¿**:

```typescript
// scripts/seed-career-courses.ts
const courseDefinitions = [
  {
    courseCode: 'A',
    courseName: 'Aã‚³ãƒ¼ã‚¹ï¼ˆå…¨é¢å”åŠ›å‹ï¼‰',
    description: 'æ–½è¨­é–“ç•°å‹•ãƒ»è»¢å±…ã‚ã‚Šã€ç®¡ç†è·ç™»ç”¨å¯¾è±¡',
    departmentTransferAvailable: true,
    facilityTransferAvailable: 'full',
    relocationRequired: true,
    nightShiftAvailable: 'required',
    managementTrack: true,
    baseSalaryMultiplier: 1.2,
    salaryGrade: 5,
    salaryNotes: 'åŸºæœ¬çµ¦1.2å€ã€å½¹è·æ‰‹å½“åˆ¥é€”',
    isActive: true,
    displayOrder: 1
  },
  {
    courseCode: 'B',
    courseName: 'Bã‚³ãƒ¼ã‚¹ï¼ˆæ–½è¨­å†…å”åŠ›å‹ï¼‰',
    description: 'æ–½è¨­å†…ç•°å‹•å¯ã€è»¢å±…ãªã—',
    departmentTransferAvailable: true,
    facilityTransferAvailable: 'limited',
    relocationRequired: false,
    nightShiftAvailable: 'selectable',
    managementTrack: true,
    baseSalaryMultiplier: 1.1,
    salaryGrade: 4,
    salaryNotes: 'åŸºæœ¬çµ¦1.1å€',
    isActive: true,
    displayOrder: 2
  },
  {
    courseCode: 'C',
    courseName: 'Cã‚³ãƒ¼ã‚¹ï¼ˆå°‚é–€è·å‹ï¼‰',
    description: 'éƒ¨ç½²å›ºå®šã€å°‚é–€æ€§é‡è¦–',
    departmentTransferAvailable: false,
    facilityTransferAvailable: 'none',
    relocationRequired: false,
    nightShiftAvailable: 'selectable',
    managementTrack: false,
    baseSalaryMultiplier: 1.05,
    salaryGrade: 3,
    salaryNotes: 'åŸºæœ¬çµ¦1.05å€',
    isActive: true,
    displayOrder: 3
  },
  {
    courseCode: 'D',
    courseName: 'Dã‚³ãƒ¼ã‚¹ï¼ˆæ™‚çŸ­ãƒ»åˆ¶ç´„ã‚ã‚Šå‹ï¼‰',
    description: 'æ™‚çŸ­å‹¤å‹™ã€å¤œå‹¤ãªã—',
    departmentTransferAvailable: false,
    facilityTransferAvailable: 'none',
    relocationRequired: false,
    nightShiftAvailable: 'none',
    managementTrack: false,
    baseSalaryMultiplier: 1.0,
    salaryGrade: 2,
    salaryNotes: 'åŸºæœ¬çµ¦é€šå¸¸',
    isActive: true,
    displayOrder: 4
  }
];
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
npx tsx scripts/seed-career-courses.ts
```

#### 6.7.4 APIå®Ÿè£…ï¼ˆWeek 1: Day 3-4ï¼‰

**API-1: ã‚³ãƒ¼ã‚¹å®šç¾©ä¸€è¦§å–å¾—**

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/career-courses/definitions`

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/api/career-courses/definitions/route.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
// src/app/api/career-courses/definitions/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(request: NextRequest) {
  try {
    const courses = await prisma.careerCourseDefinition.findMany({
      where: { isActive: true },
      orderBy: { displayOrder: 'asc' }
    });

    return NextResponse.json({
      success: true,
      courses
    });
  } catch (error) {
    console.error('ã‚³ãƒ¼ã‚¹å®šç¾©å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({
      success: false,
      error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    }, { status: 500 });
  }
}
```

**API-2: ãƒã‚¤ãƒšãƒ¼ã‚¸æƒ…å ±å–å¾—ï¼ˆç¾åœ¨ã®ã‚³ãƒ¼ã‚¹å«ã‚€ï¼‰**

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/my-page`ï¼ˆæ—¢å­˜APIã«æ‹¡å¼µï¼‰

```typescript
// src/app/api/my-page/route.ts ã«è¿½åŠ 
export async function GET(request: NextRequest) {
  try {
    const userId = request.headers.get('x-user-id');

    const employee = await prisma.employee.findUnique({
      where: { id: userId },
      include: {
        department: true,
        position: true,
        facility: true
      }
    });

    // ç¾åœ¨ã®ã‚³ãƒ¼ã‚¹å–å¾—ï¼ˆè¿½åŠ ï¼‰
    const currentCourse = await prisma.careerCourseSelection.findFirst({
      where: {
        employeeId: userId,
        effectiveTo: null  // ç¾åœ¨æœ‰åŠ¹ãªã‚³ãƒ¼ã‚¹
      },
      include: {
        courseDefinition: true
      }
    });

    return NextResponse.json({
      id: employee.id,
      name: employee.name,
      position: employee.position.name,
      department: employee.department.name,
      facility: employee.facility.name,
      employeeId: employee.employeeCode,
      joinDate: employee.hireDate,
      careerCourse: currentCourse ? {
        courseCode: currentCourse.courseCode,
        courseName: currentCourse.courseDefinition.courseName,
        effectiveFrom: currentCourse.effectiveFrom,
        effectiveTo: currentCourse.effectiveTo,
        nextChangeAvailableDate: currentCourse.nextChangeAvailableDate
      } : null
    });
  } catch (error) {
    console.error('ãƒã‚¤ãƒšãƒ¼ã‚¸æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({
      success: false,
      error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    }, { status: 500 });
  }
}
```

**API-3: ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹é€ä¿¡**

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/career-course/change-request`

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/api/career-course/change-request/route.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
// src/app/api/career-course/change-request/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { sendMail } from '@/lib/mail';

export async function POST(request: NextRequest) {
  try {
    const userId = request.headers.get('x-user-id');
    const body = await request.json();

    const {
      currentCourseCode,
      requestedCourseCode,
      changeReason,
      reasonDetail,
      requestedEffectiveDate,
      attachments
    } = body;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (currentCourseCode === requestedCourseCode) {
      return NextResponse.json({
        success: false,
        error: 'ç¾åœ¨ã®ã‚³ãƒ¼ã‚¹ã¨åŒã˜ã‚³ãƒ¼ã‚¹ã¯é¸æŠã§ãã¾ã›ã‚“'
      }, { status: 400 });
    }

    // å¹´1å›åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆç‰¹ä¾‹é™¤ãï¼‰
    if (changeReason === 'annual') {
      const currentSelection = await prisma.careerCourseSelection.findFirst({
        where: { employeeId: userId, effectiveTo: null }
      });

      if (currentSelection?.nextChangeAvailableDate &&
          new Date(currentSelection.nextChangeAvailableDate) > new Date()) {
        return NextResponse.json({
          success: false,
          error: `æ¬¡å›å¤‰æ›´å¯èƒ½æ—¥ã¯${currentSelection.nextChangeAvailableDate}ã§ã™`
        }, { status: 400 });
      }
    }

    // ç‰¹ä¾‹å¤‰æ›´ã®å ´åˆã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å¿…é ˆ
    if (changeReason.startsWith('special_') && (!attachments || attachments.length === 0)) {
      return NextResponse.json({
        success: false,
        error: 'ç‰¹ä¾‹å¤‰æ›´ã«ã¯è¨¼æ˜æ›¸é¡ã®æ·»ä»˜ãŒå¿…è¦ã§ã™'
      }, { status: 400 });
    }

    // ç”³è«‹ä½œæˆ
    const request = await prisma.careerCourseChangeRequest.create({
      data: {
        employeeId: userId,
        currentCourseCode,
        requestedCourseCode,
        changeReason,
        reasonDetail,
        requestedEffectiveDate: new Date(requestedEffectiveDate),
        attachments: JSON.stringify(attachments),
        approvalStatus: 'pending'
      }
    });

    // äººäº‹éƒ¨ã¸ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
    await sendMail({
      to: 'hr@medical-system.local',
      subject: 'ã€æ–°è¦ã€‘ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ï¼ˆè·å“¡åï¼‰',
      body: `ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ãŒã‚ã‚Šã¾ã—ãŸã€‚\n\nç”³è«‹ID: ${request.id}\n...`
    });

    // ç”³è«‹è€…ã¸å—ä»˜ç¢ºèªãƒ¡ãƒ¼ãƒ«
    const employee = await prisma.employee.findUnique({ where: { id: userId } });
    await sendMail({
      to: employee.email,
      subject: 'ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ',
      body: `ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚äººäº‹éƒ¨ã®å¯©æŸ»ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚\n\nç”³è«‹ID: ${request.id}\n...`
    });

    return NextResponse.json({
      success: true,
      id: request.id,
      staffId: userId,
      approvalStatus: 'pending',
      message: 'ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚äººäº‹éƒ¨ã®å¯©æŸ»ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚'
    });
  } catch (error) {
    console.error('ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({
      success: false,
      error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    }, { status: 500 });
  }
}
```

**API-4: æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/career-course/upload-attachment`

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/api/career-course/upload-attachment/route.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
// src/app/api/career-course/upload-attachment/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

const s3Client = new S3Client({
  region: 'ap-northeast-1',
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!
  }
});

export async function POST(request: NextRequest) {
  try {
    const userId = request.headers.get('x-user-id');
    const formData = await request.formData();
    const file = formData.get('file') as File;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
      return NextResponse.json({
        success: false,
        error: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„'
      }, { status: 400 });
    }

    const allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png'];
    const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
    if (!allowedExtensions.includes(ext)) {
      return NextResponse.json({
        success: false,
        error: 'è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ï¼ˆ.pdf, .jpg, .png ã®ã¿ï¼‰'
      }, { status: 400 });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚º
    const timestamp = Date.now();
    const employee = await prisma.employee.findUnique({ where: { id: userId } });
    const sanitizedFileName = `${employee.employeeCode}_${timestamp}_${file.name}`;
    const key = `career-course-attachments/${sanitizedFileName}`;

    // S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const buffer = await file.arrayBuffer();
    await s3Client.send(new PutObjectCommand({
      Bucket: 'medical-system-career-attachments',
      Key: key,
      Body: Buffer.from(buffer),
      ContentType: file.type,
      ServerSideEncryption: 'AES256'
    }));

    // CloudFrontç½²åä»˜ãURLç”Ÿæˆï¼ˆæœ‰åŠ¹æœŸé™30æ—¥ï¼‰
    const signedUrl = await getSignedUrl(s3Client, new GetObjectCommand({
      Bucket: 'medical-system-career-attachments',
      Key: key
    }), { expiresIn: 30 * 24 * 60 * 60 }); // 30æ—¥

    const fileUrl = `https://cdn.medical-system.local/attachments/${sanitizedFileName}`;

    return NextResponse.json({
      success: true,
      fileUrl,
      fileName: file.name,
      fileSize: file.size,
      uploadedAt: new Date().toISOString(),
      signedUrl,
      expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
    });
  } catch (error) {
    console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({
      success: false,
      error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    }, { status: 500 });
  }
}
```

#### 6.7.5 S3/CloudFrontæ§‹ç¯‰ï¼ˆWeek 1: Day 5ï¼‰

**S3ãƒã‚±ãƒƒãƒˆä½œæˆ**:
```bash
# AWS CLI
aws s3 mb s3://medical-system-career-attachments --region ap-northeast-1

# ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼è¨­å®šï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼‰
aws s3api put-bucket-policy \
  --bucket medical-system-career-attachments \
  --policy file://bucket-policy.json

# æš—å·åŒ–è¨­å®š
aws s3api put-bucket-encryption \
  --bucket medical-system-career-attachments \
  --server-side-encryption-configuration '{
    "Rules": [{
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
      }
    }]
  }'

# ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼è¨­å®šï¼ˆ3å¹´å¾Œå‰Šé™¤ï¼‰
aws s3api put-bucket-lifecycle-configuration \
  --bucket medical-system-career-attachments \
  --lifecycle-configuration '{
    "Rules": [{
      "Id": "DeleteAfter3Years",
      "Status": "Enabled",
      "Expiration": { "Days": 1095 }
    }]
  }'

# CORSè¨­å®š
aws s3api put-bucket-cors \
  --bucket medical-system-career-attachments \
  --cors-configuration '{
    "CORSRules": [{
      "AllowedOrigins": ["https://voicedrive-v100.vercel.app"],
      "AllowedMethods": ["POST"],
      "AllowedHeaders": ["*"]
    }]
  }'
```

**CloudFrontè¨­å®š**:
```bash
# CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
aws cloudfront create-distribution \
  --origin-domain-name medical-system-career-attachments.s3.ap-northeast-1.amazonaws.com \
  --default-root-object index.html

# ç½²åä»˜ãURLè¨­å®šæœ‰åŠ¹åŒ–
# AWS CloudFrontã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰è¨­å®š
```

#### 6.7.6 å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆWeek 1: Day 6-7ï¼‰

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/api/career-course/*.test.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```bash
# å…¨APIãƒ†ã‚¹ãƒˆ
npm run test:career-course

# å€‹åˆ¥ãƒ†ã‚¹ãƒˆ
npx jest tests/api/career-course/definitions.test.ts
npx jest tests/api/career-course/change-request.test.ts
npx jest tests/api/career-course/upload-attachment.test.ts
```

#### 6.7.7 VoiceDriveçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆWeek 2: Day 1-2ï¼‰

**VoiceDriveå´ã®TODOå®Ÿè£…**:
```typescript
// VoiceDrive: src/pages/career-selection-station/ChangeRequestPage.tsx
// TODO: æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆ115-117è¡Œç›®ï¼‰

// å®Ÿè£…å¾Œ:
const attachmentUrls = await Promise.all(
  attachments.map(async (file) => {
    const formData = new FormData();
    formData.append('file', file);
    const response = await fetch(`${API_BASE_URL}/api/career-course/upload-attachment`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${getAuthToken()}` },
      body: formData
    });
    const data = await response.json();
    return data.fileUrl;
  })
);
```

**çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```bash
# E2Eãƒ†ã‚¹ãƒˆï¼ˆVoiceDrive UI â†’ åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIï¼‰
npm run test:e2e:career-course
```

#### 6.7.8 äººäº‹éƒ¨ç®¡ç†ç”»é¢å®Ÿè£…ï¼ˆWeek 3: Day 1-5ï¼‰

**å¿…è¦ãªUI**:
1. ç”³è«‹ä¸€è¦§ç”»é¢ï¼ˆ`src/app/hr/career-course/requests/page.tsx`ï¼‰
2. ç”³è«‹è©³ç´°ç”»é¢ï¼ˆ`src/app/hr/career-course/requests/[id]/page.tsx`ï¼‰
3. å¯©æŸ»ãƒ»æ‰¿èªç”»é¢ï¼ˆåŒä¸Šï¼‰

**æ‰¿èªå‡¦ç†API**: `PUT /api/career-course/requests/:id/approve`

```typescript
// src/app/api/career-course/requests/[id]/approve/route.ts
export async function PUT(request: NextRequest, { params }: { params: { id: string } }) {
  try {
    const { reviewComment } = await request.json();
    const reviewerId = request.headers.get('x-user-id');

    // ç”³è«‹å–å¾—
    const changeRequest = await prisma.careerCourseChangeRequest.findUnique({
      where: { id: params.id }
    });

    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
    await prisma.$transaction(async (tx) => {
      // 1. ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      await tx.careerCourseChangeRequest.update({
        where: { id: params.id },
        data: {
          approvalStatus: 'approved',
          reviewedAt: new Date(),
          hrReviewerId: reviewerId,
          reviewComment
        }
      });

      // 2. ç¾åœ¨ã®ã‚³ãƒ¼ã‚¹ã‚’çµ‚äº†
      await tx.careerCourseSelection.updateMany({
        where: {
          employeeId: changeRequest.employeeId,
          effectiveTo: null
        },
        data: {
          effectiveTo: new Date(changeRequest.requestedEffectiveDate)
        }
      });

      // 3. æ–°ã—ã„ã‚³ãƒ¼ã‚¹ã‚’é–‹å§‹
      await tx.careerCourseSelection.create({
        data: {
          employeeId: changeRequest.employeeId,
          courseCode: changeRequest.requestedCourseCode,
          effectiveFrom: new Date(changeRequest.requestedEffectiveDate),
          effectiveTo: null,
          nextChangeAvailableDate: new Date(
            new Date(changeRequest.requestedEffectiveDate).setFullYear(
              new Date(changeRequest.requestedEffectiveDate).getFullYear() + 1
            )
          ),
          approvedBy: reviewerId,
          approvalStatus: 'approved'
        }
      });
    });

    // 4. ç”³è«‹è€…ã¸ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
    const employee = await prisma.employee.findUnique({ where: { id: changeRequest.employeeId } });
    await sendMail({
      to: employee.email,
      subject: 'ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
      body: `${changeRequest.requestedCourseCode}ã‚³ãƒ¼ã‚¹ã¸ã®å¤‰æ›´ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚\n\né©ç”¨æ—¥: ${changeRequest.requestedEffectiveDate}\n\nã‚³ãƒ¡ãƒ³ãƒˆ: ${reviewComment}`
    });

    return NextResponse.json({
      success: true,
      message: 'æ‰¿èªå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ'
    });
  } catch (error) {
    console.error('æ‰¿èªå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({
      success: false,
      error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    }, { status: 500 });
  }
}
```

#### 6.7.9 å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**Week 1: åŸºç›¤æ§‹ç¯‰**
- [ ] DBå®Ÿè£…ï¼ˆ3ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- [ ] åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆA/B/C/Dã‚³ãƒ¼ã‚¹ï¼‰
- [ ] APIå®Ÿè£…ï¼ˆ4ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
- [ ] S3/CloudFrontæ§‹ç¯‰
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆå…¨APIï¼‰

**Week 2: VoiceDriveçµ±åˆ**
- [ ] VoiceDriveå´TODOå®Ÿè£…
- [ ] E2Eãƒ†ã‚¹ãƒˆ

**Week 3: äººäº‹éƒ¨ç®¡ç†ç”»é¢**
- [ ] ç”³è«‹ä¸€è¦§ç”»é¢
- [ ] ç”³è«‹è©³ç´°ç”»é¢
- [ ] å¯©æŸ»ãƒ»æ‰¿èªç”»é¢
- [ ] æ‰¿èªå‡¦ç†API
- [ ] å´ä¸‹å‡¦ç†API

#### 6.7.10 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ: `mcp-shared/docs/career-course-change_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251021.md`
- VoiceDrive æš«å®šãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ: å—é ˜æ¸ˆã¿ï¼ˆ2025å¹´10æœˆ21æ—¥ï¼‰
- ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸: `mcp-shared/docs/ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md`

#### 6.7.11 VoiceDriveãƒãƒ¼ãƒ ã¸ã®ç¢ºèªäº‹é …

ä»¥ä¸‹ã®ç¢ºèªäº‹é …ã‚’VoiceDriveãƒãƒ¼ãƒ ã«ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

1. **ã‚­ãƒ£ãƒªã‚¢é¸æŠåˆ¶åº¦ã®è©³ç´°ä»•æ§˜**
   - ã‚³ãƒ¼ã‚¹å¤‰æ›´ã¯å¹´1å›ã®ã¿ã§ç¢ºå®šã‹ï¼Ÿ
   - ç‰¹ä¾‹å¤‰æ›´ï¼ˆå¦Šå¨ ãƒ»ä»‹è­·ãƒ»ç–¾ç—…ï¼‰ã®å ´åˆã€å¹´1å›åˆ¶é™ã¯é©ç”¨å¤–ã‹ï¼Ÿ
   - æ‰¿èªæ¨©é™ã¯äººäº‹éƒ¨ã®ã¿ã‹ï¼Ÿæ–½è¨­ã”ã¨ã«æ‰¿èªè€…ãŒã„ã‚‹ã‹ï¼Ÿ
   - æ‰¿èªãƒ•ãƒ­ãƒ¼ã¯1æ®µéšï¼ˆäººäº‹éƒ¨ã®ã¿ï¼‰ã‹ï¼Ÿè¤‡æ•°æ®µéšã‹ï¼Ÿ

2. **æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ä»•æ§˜**
   - ä¿å­˜æœŸé–“ã¯ä½•å¹´ã‹ï¼Ÿï¼ˆæ¨å¥¨: 3å¹´ï¼‰
   - ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã¯èª°ã‹ï¼Ÿï¼ˆæ¨å¥¨: æœ¬äºº + äººäº‹éƒ¨ã®ã¿ï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ã¯ï¼Ÿï¼ˆæ¨å¥¨: 10MBï¼‰
   - è¨±å¯ã™ã‚‹æ‹¡å¼µå­ã¯ï¼Ÿï¼ˆæ¨å¥¨: .pdf, .jpg, .pngï¼‰

3. **é€šçŸ¥ãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ä»•æ§˜**
   - ç”³è«‹å—ä»˜æ™‚ã«ç”³è«‹è€…ã¸ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹ã‹ï¼Ÿ
   - æ–°è¦ç”³è«‹æ™‚ã«äººäº‹éƒ¨ã¸ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹ã‹ï¼Ÿ
   - æ‰¿èªãƒ»å´ä¸‹æ™‚ã«ç”³è«‹è€…ã¸ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹ã‹ï¼Ÿ
   - VoiceDriveã¸ã®Webhooké€šçŸ¥ã¯å¿…è¦ã‹ï¼Ÿï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### 6.7.12 Phase 5-4 å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆç¢ºå®šç‰ˆï¼‰

**å®Ÿè£…æœŸé–“**: 2025å¹´10æœˆ28æ—¥ï¼ˆæœˆï¼‰ï½ 11æœˆ8æ—¥ï¼ˆé‡‘ï¼‰ï¼ˆå®Ÿåƒ7æ—¥ï¼‰

**VoiceDriveå´ã¨ã®åˆæ„äº‹é …**:
- âœ… UIå®Ÿè£…: VoiceDriveå´ãŒæä¾›
- âœ… ãƒ†ãƒ¼ãƒ–ãƒ«å: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å‘½åè¦å‰‡ã‚’æ¡ç”¨ï¼ˆ`course_definitions`ç­‰ï¼‰
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: Supabase Storageä½¿ç”¨

**å‚ç…§æ–‡æ›¸**:
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ: `mcp-shared/docs/career-course-change_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251021.md`
- VoiceDriveå›ç­”: `mcp-shared/docs/career-course-change_VoiceDriveå›ç­”_20251021.md`ï¼ˆä»®ï¼‰
- è¿½åŠ è³ªå•å›ç­”: `mcp-shared/docs/career-course-change_è¿½åŠ è³ªå•ã¸ã®å›ç­”_20251021.md`

##### Phase 5-4a: DBæ§‹ç¯‰ï¼ˆ10/28-10/29ã€2æ—¥ï¼‰

**æ‹…å½“**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 
**VoiceDriveå‚åŠ **: âŒ ä¸è¦

**ä½œæ¥­å†…å®¹**:
1. schema.prismaã¸ã®ãƒ¢ãƒ‡ãƒ«è¿½åŠ 
   - `CareerCourseDefinition`
   - `StaffCareerCourse`
   - `CareerCourseChangeRequest`

2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
   ```bash
   npx prisma migrate dev --name add_career_course_tables
   npx prisma migrate deploy
   ```

3. åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
   ```bash
   npx tsx scripts/seed-career-courses.ts
   ```

**å®Œäº†åŸºæº–**:
- [ ] 3ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†
- [ ] A/B/C/D 4ã‚³ãƒ¼ã‚¹å®šç¾©æŠ•å…¥å®Œäº†
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ

**å®Œäº†äºˆå®š**: 10/29ï¼ˆç«ï¼‰17:00

##### Phase 5-4b: APIå®Ÿè£…ï¼ˆ10/30-11/1ã€3æ—¥ï¼‰

**æ‹…å½“**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 
**VoiceDriveå‚åŠ **: âŒ ä¸è¦

**ä½œæ¥­å†…å®¹**:
1. APIå®Ÿè£…ï¼ˆ4ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
   - `GET /api/career-courses/definitions`
   - `GET /api/my-page`ï¼ˆcareerCourseè¿½åŠ ï¼‰
   - `POST /api/career-course/change-request`
   - `GET /api/career-course/my-requests`

2. èªè¨¼å®Ÿè£…
   - Supabase JWTæ¤œè¨¼
   - SystemAccounté€£æº

3. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
   - å¹´1å›åˆ¶é™ãƒã‚§ãƒƒã‚¯
   - ç‰¹ä¾‹å¤‰æ›´ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å¿…é ˆãƒã‚§ãƒƒã‚¯

**å®Œäº†åŸºæº–**:
- [ ] å…¨APIå‹•ä½œç¢ºèªå®Œäº†
- [ ] èªè¨¼ãƒ•ãƒ­ãƒ¼ç¢ºèªå®Œäº†
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿæ–½å®Œäº†

**å®Œäº†äºˆå®š**: 11/1ï¼ˆé‡‘ï¼‰17:00

##### Phase 5-4c: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çµ±åˆï¼ˆ11/4-11/5ã€2æ—¥ï¼‰

**æ‹…å½“**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 
**VoiceDriveå‚åŠ **: âŒ ä¸è¦

**ä½œæ¥­å†…å®¹**:
1. Supabase Storageè¨­å®š
   - ãƒã‚±ãƒƒãƒˆä½œæˆ: `career-course-attachments`
   - RLSï¼ˆRow Level Securityï¼‰è¨­å®š
   - ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨­å®š

2. APIå®Ÿè£…
   - `POST /api/career-course/upload-attachment`

3. ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å®Ÿè£…
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10MBï¼‰
   - æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯ï¼ˆ.pdf, .jpg, .pngï¼‰
   - ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**å®Œäº†åŸºæº–**:
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‹•ä½œç¢ºèª
- [ ] RLSå‹•ä½œç¢ºèª
- [ ] ç½²åä»˜ãURLç”Ÿæˆç¢ºèª

**å®Œäº†äºˆå®š**: 11/5ï¼ˆç«ï¼‰17:00

##### Phase 5-4d: çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ11/6-11/8ã€3æ—¥ï¼‰

**æ‹…å½“**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ  + VoiceDriveãƒãƒ¼ãƒ 
**VoiceDriveå‚åŠ **: âœ… **å‚åŠ å¿…é ˆ**

**11/6ï¼ˆæ°´ï¼‰9:00 - çµ±åˆãƒ†ã‚¹ãƒˆã‚­ãƒƒã‚¯ã‚ªãƒ•**

**å‚åŠ è€…**:
- VoiceDriveãƒãƒ¼ãƒ : ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ‰ã€æŠ€è¡“æ‹…å½“
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ : APIæ‹…å½“ã€ãƒ†ã‚¹ãƒˆæ‹…å½“

**ã‚¢ã‚¸ã‚§ãƒ³ãƒ€**:
1. APIä»•æ§˜ã®æœ€çµ‚ç¢ºèª
2. èªè¨¼ãƒ•ãƒ­ãƒ¼ç¢ºèª
3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
4. ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªå…±æœ‰

**11/7ï¼ˆæœ¨ï¼‰çµ‚æ—¥ - çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½**

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
1. ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ãƒ•ãƒ­ãƒ¼ï¼ˆæ­£å¸¸ç³»ï¼‰
2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
3. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
4. èªè¨¼ã‚¨ãƒ©ãƒ¼
5. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼

**VoiceDriveå´ã®ä½œæ¥­**:
- `ChangeRequestPage.tsx` ã®APIæ¥ç¶š
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®å®Ÿè£…

**11/8ï¼ˆé‡‘ï¼‰15:00 - çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†å ±å‘Š**

**æˆæœç‰©**:
- çµ±åˆãƒ†ã‚¹ãƒˆå ±å‘Šæ›¸
- æ—¢çŸ¥ã®å•é¡Œãƒªã‚¹ãƒˆ
- ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š

**å®Œäº†åŸºæº–**:
- [ ] å…¨ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªå®Ÿæ–½å®Œäº†
- [ ] VoiceDriveå´UIæ¥ç¶šç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†

**å®Œäº†äºˆå®š**: 11/8ï¼ˆé‡‘ï¼‰17:00

##### Phase 5-4 ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´**:
- [ ] Phase 5-4a: DBæ§‹ç¯‰å®Œäº†ï¼ˆ10/29ï¼‰
- [ ] Phase 5-4b: APIå®Ÿè£…å®Œäº†ï¼ˆ11/1ï¼‰
- [ ] Phase 5-4c: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çµ±åˆå®Œäº†ï¼ˆ11/5ï¼‰
- [ ] Phase 5-4d: çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆ11/8ï¼‰
- [ ] APIä»•æ§˜æ›¸ä½œæˆï¼ˆOpenAPI 3.0ï¼‰
- [ ] Devç’°å¢ƒURLæä¾›

**VoiceDriveå´**:
- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèªï¼ˆ11/6-11/8å‚åŠ å¯å¦ï¼‰
- [ ] ãƒ†ãƒ¼ãƒ–ãƒ«åä¿®æ­£ï¼ˆå‹å®šç¾©æ›´æ–°ï¼‰
- [ ] Supabase Storageè¨­å®šç¢ºèª
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆå‚åŠ ï¼ˆ11/6-11/8ï¼‰

---

### 6.8 Phase 8: æ‰¿èªãƒ»å¯¾å¿œç®¡ç†APIå®Ÿè£…ï¼ˆApprovalsé€£æºï¼‰

**å®Ÿè£…æ™‚æœŸ**: å…±é€šDBæ§‹ç¯‰å¾Œï¼ˆVoiceDrive Phase 1-4ã¨ä¸¦è¡Œï¼‰
**å„ªå…ˆåº¦**: ğŸŸ¡ ä¸­å„ªå…ˆåº¦
**å‚ç…§æ–‡æ›¸**: `mcp-shared/docs/approvals_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251021.md`

#### 6.8.1 å®Ÿè£…æ¦‚è¦

VoiceDriveå´ã®æ‰¿èªãƒ»å¯¾å¿œç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆApprovalsPageï¼‰ã§ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãƒ»äºˆç®—æ‰¿èªæ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®APIå®Ÿè£…ã€‚

**ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»**:
- é€šçŸ¥ãƒ»æ‰¿èªã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿: âŒ VoiceDrive 100%ç®¡è½„
- çµ„ç¹”éšå±¤æƒ…å ±: âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç®¡è½„
- äºˆç®—æ‰¿èªé™åº¦é¡: âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç®¡è½„

#### 6.8.2 DBæ‹¡å¼µï¼ˆDay 1ï¼‰

**Employeeãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ **:

```prisma
model Employee {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  budgetApprovalLimit Int? // äºˆç®—æ‰¿èªé™åº¦é¡ï¼ˆå††ï¼‰
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**:
```bash
# schema.prismaã‚’æ›´æ–°
npx prisma format
npx prisma migrate dev --name add_budget_approval_limit

# æœ¬ç•ªç’°å¢ƒ
npx prisma migrate deploy
```

**åˆæœŸå€¤è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
```sql
-- Levelåˆ¥ã®äºˆç®—æ‰¿èªé™åº¦é¡è¨­å®š
UPDATE employees SET budgetApprovalLimit = NULL WHERE permissionLevel <= 5;
UPDATE employees SET budgetApprovalLimit = 100000 WHERE permissionLevel IN (6, 7);
UPDATE employees SET budgetApprovalLimit = 500000 WHERE permissionLevel IN (8, 9);
UPDATE employees SET budgetApprovalLimit = 2000000 WHERE permissionLevel = 10;
UPDATE employees SET budgetApprovalLimit = 5000000 WHERE permissionLevel = 11;
UPDATE employees SET budgetApprovalLimit = 10000000 WHERE permissionLevel >= 12;
```

#### 6.8.3 APIå®Ÿè£…ï¼ˆDay 2-3ï¼‰

**API-1: çµ„ç¹”éšå±¤å–å¾—API**

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v2/employees/:employeeId/hierarchy`

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/api/v2/employees/[employeeId]/hierarchy/route.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
// src/app/api/v2/employees/[employeeId]/hierarchy/route.ts
import { NextRequest, NextResponse } from 'next/server';
import prisma from '@/lib/prisma';

export async function GET(
  request: NextRequest,
  { params }: { params: { employeeId: string } }
) {
  const { employeeId } = params;
  const { searchParams } = new URL(request.url);
  const depth = parseInt(searchParams.get('depth') || '2');

  try {
    // å¯¾è±¡è·å“¡å–å¾—
    const employee = await prisma.employee.findUnique({
      where: { id: employeeId },
      include: {
        position: true,
        department: true,
      },
    });

    if (!employee) {
      return NextResponse.json(
        { error: 'Employee not found' },
        { status: 404 }
      );
    }

    const hierarchy: any = {
      employee: {
        id: employee.id,
        name: employee.name,
        permissionLevel: employee.permissionLevel,
        accountType: employee.position.accountType,
        department: employee.department.name,
        budgetApprovalLimit: employee.budgetApprovalLimit,
      },
    };

    // ä¸Šä½è€…å–å¾—ï¼ˆdepthåˆ†ï¼‰
    let currentSupervisorId = employee.supervisorId;
    let level = 1;

    while (currentSupervisorId && level <= depth) {
      const supervisor = await prisma.employee.findUnique({
        where: { id: currentSupervisorId },
        include: {
          position: true,
          department: true,
        },
      });

      if (!supervisor) break;

      const key = level === 1 ? 'parent' : level === 2 ? 'grandparent' : `level${level}`;
      hierarchy[key] = {
        id: supervisor.id,
        name: supervisor.name,
        permissionLevel: supervisor.permissionLevel,
        accountType: supervisor.position.accountType,
        department: supervisor.department.name,
        budgetApprovalLimit: supervisor.budgetApprovalLimit,
      };

      currentSupervisorId = supervisor.supervisorId;
      level++;
    }

    return NextResponse.json(hierarchy);
  } catch (error) {
    console.error('Error fetching employee hierarchy:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

**Responseä¾‹**:
```json
{
  "employee": {
    "id": "OH-NS-2024-020",
    "name": "ç”°ä¸­çœ‹è­·å¸«é•·",
    "permissionLevel": 8.0,
    "accountType": "DEPARTMENT_HEAD",
    "department": "åŒ»ç™‚ç™‚é¤Šç—…æ£Ÿ",
    "budgetApprovalLimit": 500000
  },
  "parent": {
    "id": "OH-NS-2024-030",
    "name": "å±±ç”°éƒ¨é•·",
    "permissionLevel": 10.0,
    "accountType": "DEPARTMENT_DIRECTOR",
    "department": "çœ‹è­·éƒ¨",
    "budgetApprovalLimit": 2000000
  },
  "grandparent": {
    "id": "OH-NS-2024-040",
    "name": "ä½è—¤äº‹å‹™é•·",
    "permissionLevel": 11.0,
    "accountType": "DIRECTOR",
    "department": "äº‹å‹™éƒ¨",
    "budgetApprovalLimit": 5000000
  }
}
```

#### 6.8.4 å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆDay 4ï¼‰

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/api/v2/employees/hierarchy.test.ts`ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
import { describe, test, expect } from '@jest/globals';

describe('GET /api/v2/employees/:employeeId/hierarchy', () => {
  test('æ­£å¸¸ç³»: çµ„ç¹”éšå±¤ã‚’å–å¾—ã§ãã‚‹', async () => {
    const response = await fetch('/api/v2/employees/OH-NS-2024-020/hierarchy');
    expect(response.status).toBe(200);

    const data = await response.json();
    expect(data.employee).toBeDefined();
    expect(data.parent).toBeDefined();
    expect(data.employee.budgetApprovalLimit).toBe(500000);
  });

  test('æ­£å¸¸ç³»: depth=1ã§ç›´å±ã®ä¸Šå¸ã®ã¿å–å¾—', async () => {
    const response = await fetch('/api/v2/employees/OH-NS-2024-020/hierarchy?depth=1');
    const data = await response.json();
    expect(data.parent).toBeDefined();
    expect(data.grandparent).toBeUndefined();
  });

  test('ç•°å¸¸ç³»: å­˜åœ¨ã—ãªã„è·å“¡IDã§404ã‚¨ãƒ©ãƒ¼', async () => {
    const response = await fetch('/api/v2/employees/invalid-id/hierarchy');
    expect(response.status).toBe(404);
  });

  test('æ­£å¸¸ç³»: budgetApprovalLimitãŒæ­£ã—ãè¿”å´ã•ã‚Œã‚‹', async () => {
    const response = await fetch('/api/v2/employees/OH-NS-2024-020/hierarchy');
    const data = await response.json();
    expect(typeof data.employee.budgetApprovalLimit).toBe('number');
  });
});
```

**å®Ÿè¡Œ**:
```bash
npx jest tests/api/v2/employees/hierarchy.test.ts
```

#### 6.8.5 VoiceDriveçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆDay 5ï¼‰

**VoiceDriveå´ã®ä½¿ç”¨ä¾‹**:
```typescript
// VoiceDriveå´ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
async function escalateApprovalTask(taskId: string) {
  // ç¾åœ¨ã®æ‰¿èªè€…å–å¾—
  const task = await prisma.approvalTask.findUnique({ where: { id: taskId } });

  // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‹ã‚‰çµ„ç¹”éšå±¤å–å¾—
  const hierarchy = await fetch(
    `https://medical.example.com/api/v2/employees/${task.approverId}/hierarchy?depth=1`,
    {
      headers: {
        'X-API-Key': process.env.MEDICAL_SYSTEM_API_KEY!,
      },
    }
  ).then((res) => res.json());

  if (!hierarchy.parent) {
    throw new Error('ä¸Šä½æ‰¿èªè€…ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
  }

  // ä¸Šä½æ‰¿èªè€…ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  await prisma.approvalTask.update({
    where: { id: taskId },
    data: {
      approverId: hierarchy.parent.id,
      escalatedFrom: task.approverId,
      escalatedAt: new Date(),
    },
  });

  // é€šçŸ¥ä½œæˆ
  await createNotification({
    recipientId: hierarchy.parent.id,
    type: 'ESCALATION',
    title: `æ‰¿èªæœŸé™åˆ‡ã‚Œ: ${task.title}`,
    message: `${task.requesterName}ã‹ã‚‰ã®æ‰¿èªä¾é ¼ãŒã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸ`,
  });
}
```

**çµ±åˆãƒ†ã‚¹ãƒˆé …ç›®**:
1. VoiceDriveå´ã‹ã‚‰çµ„ç¹”éšå±¤APIå‘¼ã³å‡ºã—æˆåŠŸ
2. ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã®å‹•ä½œç¢ºèª
3. äºˆç®—æ‰¿èªé™åº¦é¡ã«ã‚ˆã‚‹æ‰¿èªè€…åˆ¤å®šã®å‹•ä½œç¢ºèª

#### 6.8.6 å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| æ—¥ä»˜ | ä½œæ¥­å†…å®¹ | æ‹…å½“ | çŠ¶æ…‹ |
|------|---------|------|------|
| **Day 1** | budgetApprovalLimitãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ VoiceDrive Phase 1å®Œäº†å¾Œ |
| **Day 2** | çµ„ç¹”éšå±¤APIå®Ÿè£… | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ VoiceDrive Phase 1å®Œäº†å¾Œ |
| **Day 3** | APIå®Ÿè£…å®Œäº†ãƒ»å‹•ä½œç¢ºèª | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ VoiceDrive Phase 1å®Œäº†å¾Œ |
| **Day 4** | å˜ä½“ãƒ†ã‚¹ãƒˆ | åŒ»ç™‚ãƒãƒ¼ãƒ  | â³ VoiceDrive Phase 1å®Œäº†å¾Œ |
| **Day 5** | VoiceDriveçµ±åˆãƒ†ã‚¹ãƒˆ | ä¸¡ãƒãƒ¼ãƒ  | â³ VoiceDrive Phase 1å®Œäº†å¾Œ |

**æ¨å®šå·¥æ•°**: 0.8æ—¥ï¼ˆç´„6-7æ™‚é–“ï¼‰

#### 6.8.7 æˆåŠŸåŸºæº–

- âœ… budgetApprovalLimitãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ å®Œäº†
- âœ… åˆæœŸå€¤è¨­å®šå®Œäº†ï¼ˆLevelåˆ¥ï¼‰
- âœ… çµ„ç¹”éšå±¤APIå®Ÿè£…å®Œäº†
- âœ… å˜ä½“ãƒ†ã‚¹ãƒˆå…¨ã¦æˆåŠŸ
- âœ… VoiceDriveå´ã‹ã‚‰ã®APIå‘¼ã³å‡ºã—æˆåŠŸ
- âœ… ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½å‹•ä½œç¢ºèª
- âœ… äºˆç®—æ‰¿èªé™åº¦é¡åˆ¤å®šå‹•ä½œç¢ºèª

#### 6.8.8 VoiceDriveå´ã®å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå‚è€ƒï¼‰

| Phase | æœŸé–“ | å†…å®¹ |
|-------|------|------|
| Phase 1 | 1-2æ—¥ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ‹¡å¼µï¼ˆNotification, NotificationAction, NotificationRecipientï¼‰ |
| Phase 2 | 2-3æ—¥ | NotificationServiceå®Ÿè£… |
| Phase 3 | 2-3æ—¥ | APIå®Ÿè£…ï¼ˆGET /api/notificationsç­‰ï¼‰ |
| Phase 4 | 1-2æ—¥ | çµ±åˆãƒ†ã‚¹ãƒˆ |

**åˆè¨ˆ**: 6-10æ—¥

#### 6.8.9 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ: `mcp-shared/docs/approvals_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251021.md`
- VoiceDrive æš«å®šãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ: `MASTER-APPROVALS-20251013-001`
- ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸: `mcp-shared/docs/ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md`

---

### 6.9 ProfilePage APIçµ±åˆãƒ†ã‚¹ãƒˆ

**æ¦‚è¦**:
ProfilePageã¯ã€PersonalStationã¨åŒæ§˜ã®APIï¼ˆ`GET /api/v2/employees/{employeeId}`, `GET /api/v2/employees/{employeeId}/experience-summary`ï¼‰ã‚’ä½¿ç”¨ã—ã€è¿½åŠ ã§ã‚¹ã‚­ãƒ«æƒ…å ±APIï¼ˆ`GET /api/v2/employees/{employeeId}/skills`ï¼‰ãŒå¿…è¦ã€‚

**å‰ææ¡ä»¶**:
- âœ… API-1, API-2å®Ÿè£…å®Œäº†ï¼ˆPersonalStationå®Ÿè£…æ™‚ã«å®Œäº†æ¸ˆã¿ï¼‰
- â³ API-3ï¼ˆã‚¹ã‚­ãƒ«æƒ…å ±APIï¼‰å®Ÿè£…å¾…ã¡ï¼ˆEmployeeSkillãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªå¾Œï¼‰
- âœ… ç¢ºèªçµæœå ±å‘Šæ›¸ä½œæˆæ¸ˆã¿ï¼ˆmcp-shared/docs/ProfilePage_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251024.mdï¼‰

#### 6.9.1 ç’°å¢ƒå¤‰æ•°è¨­å®š
```bash
# .env.productionã«è¿½åŠ ï¼ˆPersonalStationã¨åŒã˜API Keyã‚’ä½¿ç”¨ï¼‰
PROFILE_PAGE_API_KEY=${PERSONAL_STATION_API_KEY}

# VoiceDriveå´ã®è¨­å®šç¢ºèªï¼ˆVoiceDriveãƒãƒ¼ãƒ ã«å…±æœ‰ï¼‰
# MEDICAL_SYSTEM_API_URL=https://medical.example.com/api/v2
# MEDICAL_SYSTEM_API_KEY=[PersonalStationã¨åŒã˜API Key]
```

#### 6.9.2 å®Ÿãƒ‡ãƒ¼ã‚¿ã§APIå‹•ä½œç¢ºèª
```bash
# API-1: è·å“¡åŸºæœ¬æƒ…å ±å–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/employees/EMP2024001" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "X-API-Key: ${PROFILE_PAGE_API_KEY}"

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {
#   "employeeId": "EMP2024001",
#   "employeeNumber": "EMP-2024-001",
#   "name": "å±±ç”° å¤ªéƒ",
#   "nameKana": "ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦",
#   "email": "yamada.taro@hospital.local",
#   "department": "å¤–ç§‘",
#   "facilityId": "FAC001",
#   "profession": "çœ‹è­·å¸«",
#   "position": "ä¸»ä»»",
#   "hireDate": "2018-04-01",
#   "permissionLevel": 3.5,
#   "avatar": "https://cdn.hospital.local/avatars/emp2024001.jpg",
#   "isRetired": false
# }

# API-2: çµŒé¨“å¹´æ•°ã‚µãƒãƒªãƒ¼å–å¾—ãƒ†ã‚¹ãƒˆ
curl -X GET "http://localhost:3000/api/v2/employees/EMP2024001/experience-summary" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "X-API-Key: ${PROFILE_PAGE_API_KEY}"

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {
#   "employeeId": "EMP2024001",
#   "yearsOfService": 6.0,
#   "totalExperienceYears": 9.0,
#   "previousExperience": 3.0,
#   "currentPositionYears": 2.1,
#   "calculatedAt": "2025-10-24T10:30:00Z"
# }

# API-3: ã‚¹ã‚­ãƒ«æƒ…å ±å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆPhase 2å®Ÿè£…å¾Œï¼‰
curl -X GET "http://localhost:3000/api/v2/employees/EMP2024001/skills" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "X-API-Key: ${PROFILE_PAGE_API_KEY}"

# Phase 1ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆEmployeeSkillãƒ†ãƒ¼ãƒ–ãƒ«æœªå®Ÿè£…æ™‚ï¼‰:
# {
#   "employeeId": "EMP2024001",
#   "skills": [],
#   "totalSkillCount": 0,
#   "averageLevel": 0,
#   "calculatedAt": "2025-10-24T10:30:00Z",
#   "note": "EmployeeSkillãƒ†ãƒ¼ãƒ–ãƒ«å®Ÿè£…å¾…ã¡ï¼ˆPhase 2äºˆå®šï¼‰"
# }

# Phase 2ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆEmployeeSkillãƒ†ãƒ¼ãƒ–ãƒ«å®Ÿè£…å¾Œï¼‰:
# {
#   "employeeId": "EMP2024001",
#   "skills": [
#     {
#       "skillId": "SKL001",
#       "skillName": "è„³è¡€ç®¡ãƒªãƒãƒ“ãƒª",
#       "skillCategory": "rehabilitation",
#       "level": 4,
#       "certificationDate": "2020-03-15"
#     },
#     {
#       "skillId": "SKL002",
#       "skillName": "ãƒãƒ¼ãƒ åŒ»ç™‚",
#       "skillCategory": "teamwork",
#       "level": 5,
#       "certificationDate": "2019-08-20"
#     }
#   ],
#   "totalSkillCount": 2,
#   "averageLevel": 4.5,
#   "calculatedAt": "2025-10-24T10:30:00Z"
# }
```

#### 6.9.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
```bash
# 401 Unauthorizedï¼ˆJWT Tokenæœªæä¾›ï¼‰
curl -X GET "http://localhost:3000/api/v2/employees/EMP2024001" \
  -H "X-API-Key: ${PROFILE_PAGE_API_KEY}"
# æœŸå¾…: {"error":{"code":"UNAUTHORIZED","message":"JWT Token is required"}}

# 403 Forbiddenï¼ˆä»–è·å“¡ã®ã‚¹ã‚­ãƒ«æƒ…å ±å–å¾—ã€Level 1-6ï¼‰
curl -X GET "http://localhost:3000/api/v2/employees/EMP2024002/skills" \
  -H "Authorization: Bearer ${JWT_TOKEN_LEVEL_3}" \
  -H "X-API-Key: ${PROFILE_PAGE_API_KEY}"
# æœŸå¾…: {"error":{"code":"FORBIDDEN","message":"Insufficient permission to view other employee's skills"}}

# 404 Not Foundï¼ˆå­˜åœ¨ã—ãªã„è·å“¡IDï¼‰
curl -X GET "http://localhost:3000/api/v2/employees/INVALID_ID" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "X-API-Key: ${PROFILE_PAGE_API_KEY}"
# æœŸå¾…: {"error":{"code":"NOT_FOUND","message":"Employee not found"}}

# 429 Rate Limitè¶…éãƒ†ã‚¹ãƒˆï¼ˆ100å›è¶…éã§ã‚¨ãƒ©ãƒ¼ï¼‰
for i in {1..105}; do
  curl -X GET "http://localhost:3000/api/v2/employees/EMP2024001" \
    -H "Authorization: Bearer ${JWT_TOKEN}" \
    -H "X-API-Key: ${PROFILE_PAGE_API_KEY}" \
    -H "X-Forwarded-For: 192.168.1.100"
done
# 101å›ç›®ä»¥é™: {"error":{"code":"RATE_LIMIT_EXCEEDED","message":"Too many requests"}}
```

#### 6.9.4 VoiceDriveãƒãƒ¼ãƒ ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ
```bash
# VoiceDriveãƒãƒ¼ãƒ ã«ä»¥ä¸‹ã‚’å…±æœ‰:
# - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL: https://medical.example.com/api/v2
# - ProfilePageç”¨APIã‚­ãƒ¼: [PersonalStationã¨åŒã˜API Key]
# - APIä»•æ§˜æ›¸: mcp-shared/docs/ProfilePage_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251024.md

# VoiceDriveãƒãƒ¼ãƒ å´ã§ã®ç¢ºèªäº‹é …:
# 1. ProfilePageã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
# 2. çµŒé¨“å¹´æ•°ï¼ˆå‹¤ç¶šå¹´æ•°ã€å‰è·çµŒé¨“ã€ç·çµŒé¨“å¹´æ•°ï¼‰ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
# 3. ã‚¹ã‚­ãƒ«æƒ…å ±ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªï¼ˆPhase 2å®Ÿè£…å¾Œï¼‰
# 4. è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿ç·¨é›†å¯èƒ½ã‹ç¢ºèª
```

#### 6.9.5 çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†åŸºæº–
- [ ] API-1ï¼ˆè·å“¡åŸºæœ¬æƒ…å ±ï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] API-2ï¼ˆçµŒé¨“å¹´æ•°ã‚µãƒãƒªãƒ¼ï¼‰ãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§æ­£å¸¸å‹•ä½œ
- [ ] API-3ï¼ˆã‚¹ã‚­ãƒ«æƒ…å ±ï¼‰ãŒPhase 1ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆç©ºé…åˆ—ï¼‰ã‚’è¿”ã™
- [ ] VoiceDrive ProfilePageã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒæ­£å¸¸è¡¨ç¤º
- [ ] æ¨©é™ãƒ¬ãƒ™ãƒ«åˆ¥ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãŒæ­£å¸¸å‹•ä½œ
- [ ] Rate LimitãŒæ­£å¸¸å‹•ä½œ

**æ¨å®šå·¥æ•°**: 1æ—¥é–“ï¼ˆDBæ§‹ç¯‰å¾Œã€Phase 1ã®ã¿ï¼‰
**Phase 2å·¥æ•°**: 0.5æ—¥é–“ï¼ˆEmployeeSkillãƒ†ãƒ¼ãƒ–ãƒ«å®Ÿè£…å¾Œã€API-3å®Ÿè£…ï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- ç¢ºèªçµæœå ±å‘Šæ›¸: `mcp-shared/docs/ProfilePage_åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ_20251024.md`ï¼ˆâœ… å®Œæˆï¼‰
- è¦ä»¶å®šç¾©: `mcp-shared/docs/ProfilePageæš«å®šãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ_20251024.md`ï¼ˆVoiceDriveæä¾›ï¼‰
- DBè¦ä»¶åˆ†æ: `mcp-shared/docs/ProfilePage_DBè¦ä»¶åˆ†æ_20251024.md`ï¼ˆVoiceDriveæä¾›ï¼‰

**å®Ÿè£…æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/app/api/v2/employees/[employeeId]/route.ts` - è·å“¡åŸºæœ¬æƒ…å ±APIï¼ˆPersonalStationå®Ÿè£…æ™‚ã«å®Œäº†ï¼‰
- `src/app/api/v2/employees/[employeeId]/experience-summary/route.ts` - çµŒé¨“å¹´æ•°APIï¼ˆPersonalStationå®Ÿè£…æ™‚ã«å®Œäº†ï¼‰
- `src/app/api/v2/employees/[employeeId]/skills/route.ts` - ã‚¹ã‚­ãƒ«æƒ…å ±APIï¼ˆPhase 2å®Ÿè£…äºˆå®šï¼‰

---

## 7. Step 6: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™

### 7.1 æœ€çµ‚ç¢ºèª
```bash
# å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
npm run test:all:production

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
npm run test:performance
```

### 7.2 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼ï¼ˆ32/32ï¼‰
- [ ] VoiceDriveé€£æºç¢ºèªæ¸ˆã¿
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆæ¸ˆã¿
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ç¢ºèªæ¸ˆã¿
- [ ] ç›£è¦–è¨­å®šå®Œäº†

---

## 8. Step 7: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

### 8.1 ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
```bash
# ãƒ“ãƒ«ãƒ‰
npm run build:production

# ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy:production

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
npm run health:check
```

### 8.2 ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œç¢ºèª
```bash
# ãƒ­ã‚°ç›£è¦–
npm run logs:production

# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
npm run metrics:check
```

---

## 9. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

#### å•é¡Œ1: çµ±æ‹¬ä¸»ä»»ã®ãƒ¬ãƒ™ãƒ«ãŒ6ã«ãªã£ã¦ã„ã‚‹
```javascript
// facility-position-mapping.tsã®63è¡Œç›®ã‚’ç¢ºèª
{ positionName: 'çµ±æ‹¬ä¸»ä»»', baseLevel: 7, ... }  // 7ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
```

#### å•é¡Œ2: å…¼ä»»è·å“¡ã®æ¨©é™ãŒä½ã„æ–¹ã§é©ç”¨ã•ã‚Œã‚‹
```javascript
// æ¨©é™å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¢ºèª
const effectiveLevel = Math.max(position1Level, position2Level);
```

#### å•é¡Œ3: ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥ãŒèªè­˜ã•ã‚Œãªã„
```bash
# æ–½è¨­IDã‚’ç¢ºèª
echo $DEFAULT_FACILITY_ID  # espoir-tategami ã§ã‚ã‚‹ã“ã¨
```

---

## 10. é€£çµ¡å…ˆ

### ç·Šæ€¥æ™‚é€£çµ¡å…ˆ
- ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ : [é€£çµ¡å…ˆ]
- VoiceDriveãƒãƒ¼ãƒ : [é€£çµ¡å…ˆ]
- DBç®¡ç†è€…: [é€£çµ¡å…ˆ]

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§
- ä½œæ¥­å®Œäº†å ±å‘Šæ›¸: `/docs/ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥çµ±åˆ_ä½œæ¥­å®Œäº†å ±å‘Šæ›¸_20250928.md`
- VoiceDriveé€£æºä»•æ§˜: `/docs/20250928_ã‚¨ã‚¹ãƒãƒ¯ãƒ¼ãƒ«ç«‹ç¥çµ±åˆé€£çµ¡æ›¸.md`
- ãƒ†ã‚¹ãƒˆçµæœ: `/docs/çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½è¨˜éŒ²_20250928.md`

---

## 11. ä½œæ¥­å®Œäº†åŸºæº–

ä»¥ä¸‹ãŒå…¨ã¦å®Œäº†ã—ãŸã‚‰ä½œæ¥­å®Œäº†ã¨ã™ã‚‹:

1. âœ… DBæ¥ç¶šç¢ºèª
2. âœ… ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†
3. âœ… çµ±åˆãƒ†ã‚¹ãƒˆå…¨é …ç›®åˆæ ¼
4. âœ… VoiceDriveé€£æºç¢ºèª
   - [ ] Webhookç–é€šç¢ºèª
   - [ ] ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ
   - [ ] OrganizationAnalytics APIçµ±åˆãƒ†ã‚¹ãƒˆ
   - [ ] ExecutiveReports APIçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ2025å¹´10æœˆ25æ—¥äºˆå®šï¼‰
   - [ ] BoardPreparation VoiceDriveå®Ÿè£…ç¢ºèªï¼ˆã‚¿ã‚¹ã‚¯1-4ï¼‰
   - [ ] Strategic HR Plan APIçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆPhase 1ï¼‰
   - [ ] å§”å“¡ä¼šãƒã‚¹ã‚¿APIçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆPhase 3: 2025å¹´11æœˆ15æ—¥äºˆå®šï¼‰
   - [x] **Phase 5-4ï¼ˆã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹ï¼‰DBæ§‹ç¯‰å‰èª¿æ•´å®Œäº†**ï¼ˆ2025å¹´10æœˆ21æ—¥å®Œäº†ï¼‰
5. âœ… æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
6. âœ… 24æ™‚é–“ã®å®‰å®šç¨¼åƒç¢ºèª

---

**é‡è¦**: ä½œæ¥­ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã™ãã«é–¢ä¿‚ãƒãƒ¼ãƒ ã«é€£çµ¡ã—ã€
ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤æ–­ã‚’ä»°ãã“ã¨ã€‚

---

ä½œæˆè€…: åŒ»ç™‚è·å“¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ 
ä½œæˆæ—¥: 2025å¹´9æœˆ28æ—¥
æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ21æ—¥ï¼ˆPhase 7: ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ã‚¹å¤‰æ›´ç”³è«‹æ©Ÿèƒ½ è¿½åŠ  - 6.7ç¯€ï¼‰