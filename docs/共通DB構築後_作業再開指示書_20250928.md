# 共通DB構築後 作業再開指示書

作成日: 2025年9月28日
対象: 医療職員管理システム開発チーム
前提: 共通DBの構築完了後に本書を参照

---

## 1. 作業再開前チェックリスト

### 環境確認
- [ ] 共通DB接続情報の受領
- [ ] VPNアクセス権限の確認
- [ ] 本番環境へのデプロイ権限
- [ ] VoiceDriveチームとの連携確認

### コードベース確認
- [ ] 最新のmainブランチをpull
- [ ] node_modules再インストール（`npm ci`）
- [ ] TypeScriptビルド確認（`npm run build`）

---

## 2. Step 1: 環境設定更新

### 2.1 本番環境設定ファイル作成
```bash
# .env.productionを作成
cp .env.example .env.production
```

### 2.2 環境変数設定
```env
# .env.production
DATABASE_URL=postgresql://[ユーザー名]:[パスワード]@[ホスト]:[ポート]/[データベース名]
FACILITY_DB_HOST=[共通DBホスト]
FACILITY_DB_PORT=5432
FACILITY_DB_NAME=[データベース名]
FACILITY_DB_USER=[ユーザー名]
FACILITY_DB_PASSWORD=[パスワード]

# 施設識別
DEFAULT_FACILITY_ID=espoir-tategami
MULTI_FACILITY_MODE=true

# Webhook設定（VoiceDrive連携用）
VOICEDRIVE_WEBHOOK_URL=[VoiceDriveチームから提供されるURL]
WEBHOOK_SECRET=[共有シークレットキー]
WEBHOOK_RETRY_COUNT=3
WEBHOOK_TIMEOUT=5000
```

---

## 3. Step 2: データベース接続確認

### 3.1 接続テスト実行
```bash
# DB接続テスト
npm run test:db:connection

# 期待される出力:
# ✅ データベース接続成功
# ✅ facilityマスターテーブル確認
# ✅ positionマスターテーブル確認
# ✅ staff_authorityテーブル確認
```

### 3.2 接続エラー時の対処
```bash
# ログ確認
tail -f logs/db-connection.log

# 一般的なエラー:
# - SSL証明書エラー → ssl: { rejectUnauthorized: false }を一時的に追加
# - タイムアウト → ファイアウォール設定確認
# - 認証エラー → 認証情報再確認
```

---

## 4. Step 3: マスターデータ投入

### 4.1 施設マスター登録
```sql
-- 実行するSQL（/sql/master-data/facilities.sql）
INSERT INTO facilities (facility_id, facility_name, facility_type, staff_count) VALUES
('obara-hospital', '医療法人 厚生会 小原病院', 'acute', 420),
('tategami-rehabilitation', '立神リハビリテーション温泉病院', 'rehabilitation', 180),
('espoir-tategami', '介護老人保健施設エスポワール立神', 'geriatric_health_facility', 150);
```

### 4.2 役職マスター登録
```bash
# マイグレーション実行
npm run db:migrate:production

# 確認
npm run db:verify:positions
```

### 4.3 エスポワール立神データ投入
```bash
# 33役職の一括登録
node scripts/import-espoir-positions.js

# 検証
node scripts/verify-espoir-data.js
```

---

## 5. Step 4: 統合テスト実施

### 5.1 Phase 3統合テスト
```bash
# 実環境での統合テスト
NODE_ENV=production node tests/integration/phase3-integration-test.js

# 確認項目:
# - 小原病院: 9役職
# - 立神リハビリ: 12役職（統括主任レベル7）
# - エスポワール立神: 33役職
```

### 5.2 エスポワール立神特化テスト
```bash
# Day 1-3統合テスト実行
npm run test:espoir:complete

# 個別実行
node tests/integration/run-integration-test.ts  # Day 1
node tests/integration/day2-approval-flow-test.ts  # Day 2
node tests/integration/day3-load-test.ts  # Day 3（作成要）
```

### 5.3 兼任職員権限テスト
```bash
# 特定職員のテスト
node tests/verify-dual-position.js --staff-id ESP_003
node tests/verify-dual-position.js --staff-id ESP_004
```

---

## 6. Step 5: VoiceDrive連携確認

### 6.1 Webhook疎通確認
```bash
# テスト送信
curl -X POST $VOICEDRIVE_WEBHOOK_URL \
  -H "Content-Type: application/json" \
  -H "X-Webhook-Secret: $WEBHOOK_SECRET" \
  -d '{"test": true, "facility": "espoir-tategami"}'
```

### 6.2 データ同期テスト
```bash
# 同期テスト実行
node scripts/test-voicedrive-sync.js

# ログ確認
tail -f logs/voicedrive-sync.log
```

---

## 7. Step 6: 本番デプロイ準備

### 7.1 最終確認
```bash
# 全テストスイート実行
npm run test:all:production

# パフォーマンステスト
npm run test:performance
```

### 7.2 デプロイチェックリスト
- [ ] 全テスト合格（32/32）
- [ ] VoiceDrive連携確認済み
- [ ] バックアップ作成済み
- [ ] ロールバック手順確認済み
- [ ] 監視設定完了

---

## 8. Step 7: 本番デプロイ

### 8.1 デプロイコマンド
```bash
# ビルド
npm run build:production

# デプロイ
npm run deploy:production

# ヘルスチェック
npm run health:check
```

### 8.2 デプロイ後確認
```bash
# ログ監視
npm run logs:production

# メトリクス確認
npm run metrics:check
```

---

## 9. トラブルシューティング

### よくある問題と対処法

#### 問題1: 統括主任のレベルが6になっている
```javascript
// facility-position-mapping.tsの63行目を確認
{ positionName: '統括主任', baseLevel: 7, ... }  // 7であることを確認
```

#### 問題2: 兼任職員の権限が低い方で適用される
```javascript
// 権限取得ロジックを確認
const effectiveLevel = Math.max(position1Level, position2Level);
```

#### 問題3: エスポワール立神が認識されない
```bash
# 施設IDを確認
echo $DEFAULT_FACILITY_ID  # espoir-tategami であること
```

---

## 10. 連絡先

### 緊急時連絡先
- インフラチーム: [連絡先]
- VoiceDriveチーム: [連絡先]
- DB管理者: [連絡先]

### ドキュメント参照
- 作業完了報告書: `/docs/エスポワール立神統合_作業完了報告書_20250928.md`
- VoiceDrive連携仕様: `/docs/20250928_エスポワール立神統合連絡書.md`
- テスト結果: `/docs/統合テスト実施記録_20250928.md`

---

## 11. 作業完了基準

以下が全て完了したら作業完了とする:

1. ✅ DB接続確認
2. ✅ マスターデータ投入完了
3. ✅ 統合テスト全項目合格
4. ✅ VoiceDrive連携確認
5. ✅ 本番環境デプロイ完了
6. ✅ 24時間の安定稼働確認

---

**重要**: 作業中に問題が発生した場合は、すぐに関係チームに連絡し、
ロールバック判断を仰ぐこと。

---

作成者: 医療職員管理システム開発チーム
最終更新: 2025年9月28日