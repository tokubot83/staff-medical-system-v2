# 面談サマリ統合テスト 実施手順書

**作成日**: 2025年10月2日
**テスト担当**: 医療システムチーム
**対象機能**: 面談サマリ送信→VoiceDrive受信

---

## 📋 テスト準備チェックリスト

### 医療システム側
- [ ] VoiceDrive受信APIのURL確認
- [ ] Bearer Token確認（`MEDICAL_SYSTEM_API_KEY`）
- [ ] テストデータ準備
- [ ] 送信機能の動作確認

### VoiceDrive側
- [ ] 受信サーバー起動確認（http://localhost:3003）
- [ ] データベース接続確認
- [ ] 認証トークン設定確認

---

## 🚀 Phase 1: 基本疎通テスト（所要時間: 15分）

### Step 1: 最小限のテストデータで送信

**目的**: 送受信の基本動作確認

**テストデータ**:
```json
{
  "requestId": "test-req-001",
  "interviewId": "test-int-001",
  "completedAt": "2025-10-02T10:00:00.000Z",
  "duration": 30,
  "summary": "統合テスト用の面談サマリです",
  "keyPoints": ["テストポイント1", "テストポイント2"],
  "actionItems": [
    {
      "description": "テストアクション",
      "dueDate": "2025-10-09T00:00:00.000Z"
    }
  ],
  "followUpRequired": true,
  "followUpDate": "2025-11-01T00:00:00.000Z",
  "feedbackToEmployee": "テストフィードバック",
  "nextRecommendations": {
    "suggestedNextInterview": "2026-01-01T00:00:00.000Z",
    "suggestedTopics": ["テストトピック1", "テストトピック2"]
  }
}
```

**実施方法**:
```typescript
// src/lib/interview-bank/services/bank-service.ts の sendResultToVoiceDrive() を使用
// または、直接 VoiceDriveIntegrationService.sendInterviewResult() を呼び出し

import { VoiceDriveIntegrationService } from '@/services/voicedriveIntegrationService';

const testData = {
  id: 'test-int-001',
  staffId: 'test-staff-001',
  staffName: 'テスト太郎',
  actualDate: new Date('2025-10-02T10:00:00.000Z'),
  duration: 30,
  summary: '統合テスト用の面談サマリです',
  keyPoints: ['テストポイント1', 'テストポイント2'],
  actionItems: [
    {
      description: 'テストアクション',
      dueDate: new Date('2025-10-09T00:00:00.000Z')
    }
  ],
  followUpRequired: true,
  followUpDate: new Date('2025-11-01T00:00:00.000Z')
};

const result = await VoiceDriveIntegrationService.sendInterviewResult(
  testData,
  'test-req-001'
);

console.log('送信結果:', result);
```

**期待結果**:
- ✅ HTTP 200レスポンス
- ✅ `result = true`
- ✅ VoiceDrive側のコンソールログに受信ログ表示
- ✅ VoiceDrive側のデータベースに保存確認

**確認コマンド（VoiceDrive側）**:
```typescript
// InterviewResultService.getByInterviewId() で確認
const saved = await InterviewResultService.getByInterviewId('test-int-001');
console.log('保存データ:', saved);
```

---

## 🔍 Phase 2: エラーケーステスト（所要時間: 20分）

### Test 2-1: 認証エラー

**目的**: 認証失敗時の適切なエラーハンドリング確認

**実施方法**:
```typescript
// Bearer Tokenを無効なものに変更して送信
// VoiceDriveIntegrationService 内の apiKey を一時的に変更
```

**期待結果**:
- ✅ HTTP 401エラー
- ✅ `result = false`
- ✅ エラーメッセージ: "Unauthorized"

### Test 2-2: バリデーションエラー

**目的**: 必須フィールド欠落時のエラー確認

**テストデータ（summaryを削除）**:
```json
{
  "requestId": "test-req-002",
  "interviewId": "test-int-002",
  "completedAt": "2025-10-02T10:00:00.000Z",
  "duration": 30,
  // "summary": "削除", ← 意図的に削除
  "keyPoints": [],
  "actionItems": [],
  "followUpRequired": false,
  "feedbackToEmployee": "テスト",
  "nextRecommendations": {
    "suggestedTopics": []
  }
}
```

**期待結果**:
- ✅ HTTP 400エラー
- ✅ エラーメッセージ: "Missing required field: summary"

### Test 2-3: データ型エラー

**目的**: 無効なデータ型送信時のエラー確認

**テストデータ（keyPointsを文字列に変更）**:
```json
{
  "requestId": "test-req-003",
  "interviewId": "test-int-003",
  "completedAt": "2025-10-02T10:00:00.000Z",
  "duration": 30,
  "summary": "テスト",
  "keyPoints": "invalid", // ← 配列ではなく文字列
  "actionItems": [],
  "followUpRequired": false,
  "feedbackToEmployee": "テスト",
  "nextRecommendations": {
    "suggestedTopics": []
  }
}
```

**期待結果**:
- ✅ HTTP 400エラー
- ✅ エラーメッセージ: "Invalid field type: keyPoints must be an array"

---

## 🎯 Phase 3: 実運用想定テスト（所要時間: 30分）

### Test 3-1: 複数件連続送信

**目的**: 連続送信の安定性・パフォーマンス確認

**実施方法**:
```typescript
// 5-10件のテストデータを連続送信
for (let i = 1; i <= 5; i++) {
  const testData = {
    id: `test-int-${String(i).padStart(3, '0')}`,
    staffId: `test-staff-${String(i).padStart(3, '0')}`,
    staffName: `テスト太郎${i}`,
    actualDate: new Date(),
    duration: 30 + (i * 5),
    summary: `統合テスト用の面談サマリ ${i}件目`,
    keyPoints: [`ポイント${i}-1`, `ポイント${i}-2`],
    actionItems: [
      {
        description: `アクション${i}`,
        dueDate: new Date(Date.now() + (i * 7 * 24 * 60 * 60 * 1000))
      }
    ],
    followUpRequired: i % 2 === 0, // 偶数のみフォローアップ必要
    followUpDate: i % 2 === 0 ? new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)) : undefined
  };

  const result = await VoiceDriveIntegrationService.sendInterviewResult(
    testData,
    `test-req-${String(i).padStart(3, '0')}`
  );

  console.log(`${i}件目送信結果:`, result);
}
```

**期待結果**:
- ✅ 全件送信成功
- ✅ 各レスポンスタイム < 500ms
- ✅ VoiceDrive側に5件全て保存

**確認コマンド（VoiceDrive側）**:
```typescript
const stats = await InterviewResultService.getStatistics();
console.log('統計:', stats);
// 期待: { total: 5, received: 5, processed: 0, error: 0 }
```

### Test 3-2: 重複送信（更新テスト）

**目的**: 同じinterviewIdで再送信時の更新動作確認

**実施方法**:
```typescript
// 1回目の送信
const testData1 = {
  id: 'test-int-update',
  staffId: 'test-staff-001',
  staffName: 'テスト太郎',
  actualDate: new Date('2025-10-02T10:00:00.000Z'),
  duration: 30,
  summary: '初回の面談サマリ',
  keyPoints: ['初回ポイント'],
  actionItems: [],
  followUpRequired: false
};

await VoiceDriveIntegrationService.sendInterviewResult(testData1, 'test-req-update');

// 2回目の送信（同じinterviewId）
const testData2 = {
  id: 'test-int-update', // 同じID
  staffId: 'test-staff-001',
  staffName: 'テスト太郎',
  actualDate: new Date('2025-10-02T14:00:00.000Z'),
  duration: 45,
  summary: '更新後の面談サマリ', // 変更
  keyPoints: ['更新後ポイント1', '更新後ポイント2'], // 変更
  actionItems: [
    { description: '追加アクション', dueDate: new Date('2025-10-10') }
  ],
  followUpRequired: true // 変更
};

await VoiceDriveIntegrationService.sendInterviewResult(testData2, 'test-req-update');
```

**期待結果**:
- ✅ 1回目: 新規作成
- ✅ 2回目: 既存レコード更新
- ✅ VoiceDrive側のデータが更新後の内容になっている
- ✅ `status = 'processed'`、`processedAt` が設定されている

**確認コマンド（VoiceDrive側）**:
```typescript
const saved = await InterviewResultService.getByInterviewId('test-int-update');
console.log('更新後データ:', saved.data);
// 期待: summary = '更新後の面談サマリ'
```

### Test 3-3: フォローアップパターン

**目的**: フォローアップ要/不要の両パターン確認

**パターンA: フォローアップ必要**:
```json
{
  "requestId": "test-req-followup-yes",
  "interviewId": "test-int-followup-yes",
  "completedAt": "2025-10-02T10:00:00.000Z",
  "duration": 30,
  "summary": "フォローアップが必要な面談",
  "keyPoints": ["要対応事項あり"],
  "actionItems": [
    {
      "description": "1週間後にフォローアップ",
      "dueDate": "2025-10-09T00:00:00.000Z"
    }
  ],
  "followUpRequired": true,
  "followUpDate": "2025-10-09T00:00:00.000Z",
  "feedbackToEmployee": "次回面談で進捗確認します",
  "nextRecommendations": {
    "suggestedNextInterview": "2025-10-09T00:00:00.000Z",
    "suggestedTopics": ["進捗確認", "課題解決"]
  }
}
```

**パターンB: フォローアップ不要**:
```json
{
  "requestId": "test-req-followup-no",
  "interviewId": "test-int-followup-no",
  "completedAt": "2025-10-02T10:00:00.000Z",
  "duration": 30,
  "summary": "フォローアップが不要な面談",
  "keyPoints": ["特に問題なし"],
  "actionItems": [],
  "followUpRequired": false,
  "feedbackToEmployee": "良好な状態です",
  "nextRecommendations": {
    "suggestedNextInterview": "2026-01-01T00:00:00.000Z",
    "suggestedTopics": ["定期面談"]
  }
}
```

**期待結果**:
- ✅ パターンA: `followUpRequired = true`、`followUpDate` が設定
- ✅ パターンB: `followUpRequired = false`、`followUpDate = null`

**確認コマンド（VoiceDrive側）**:
```typescript
const followUpList = await InterviewResultService.list({
  followUpRequired: true
});
console.log('フォローアップ必要件数:', followUpList.count);
// 期待: 1件（パターンAのみ）
```

---

## 📊 テスト結果記録

### Phase 1: 基本疎通テスト

| テスト項目 | 実施日時 | 結果 | レスポンスタイム | 備考 |
|-----------|---------|------|----------------|------|
| 最小限データ送信 | | ⬜ | | |

### Phase 2: エラーケーステスト

| テスト項目 | 実施日時 | 結果 | エラーメッセージ | 備考 |
|-----------|---------|------|-----------------|------|
| 認証エラー | | ⬜ | | |
| バリデーションエラー | | ⬜ | | |
| データ型エラー | | ⬜ | | |

### Phase 3: 実運用想定テスト

| テスト項目 | 実施日時 | 結果 | 送信件数 | 備考 |
|-----------|---------|------|---------|------|
| 複数件連続送信 | | ⬜ | 5件 | |
| 重複送信（更新） | | ⬜ | 2回 | |
| フォローアップパターンA | | ⬜ | 1件 | |
| フォローアップパターンB | | ⬜ | 1件 | |

---

## 🔧 トラブルシューティング

### よくある問題と対処法

#### 問題1: 送信時に401エラー
**原因**: 認証トークンが無効または未設定
**対処法**:
1. `.env` ファイルで `MEDICAL_SYSTEM_API_KEY` を確認
2. VoiceDrive側の環境変数と一致しているか確認
3. Bearer Token形式が正しいか確認（`Bearer {token}`）

#### 問題2: 送信時に接続エラー
**原因**: VoiceDrive受信サーバーが起動していない
**対処法**:
1. VoiceDrive側のサーバー起動確認: `http://localhost:3003/api/health`
2. ポート3003が使用可能か確認
3. ファイアウォール設定確認

#### 問題3: データが保存されない
**原因**: データベース接続エラー
**対処法**:
1. VoiceDrive側のPrismaクライアント初期化確認
2. SQLiteファイル（dev.db）の存在確認
3. マイグレーション実行確認: `npx prisma migrate deploy`

#### 問題4: 日付フィールドがnullになる
**原因**: ISO形式の文字列ではない
**対処法**:
1. 日付は ISO 8601 形式で送信: `"2025-10-02T10:00:00.000Z"`
2. `Date.toISOString()` を使用
3. タイムゾーン設定確認

---

## ✅ テスト完了チェックリスト

### Phase 1
- [ ] 基本的な送受信が成功
- [ ] レスポンスデータが正確
- [ ] データベースに正しく保存

### Phase 2
- [ ] 認証エラーが適切に処理される
- [ ] バリデーションエラーが適切に処理される
- [ ] データ型エラーが適切に処理される

### Phase 3
- [ ] 複数件の連続送信が安定動作
- [ ] 重複送信時の更新が正常動作
- [ ] フォローアップパターンが正しく保存
- [ ] パフォーマンスが許容範囲内（< 500ms）

### 全体
- [ ] 送信側のエラーハンドリングが適切
- [ ] 受信側のログが詳細に記録
- [ ] データ互換性が100%
- [ ] 統合テスト結果を報告書に記録

---

## 📝 次のステップ

### テスト完了後
1. テスト結果を報告書にまとめる
2. 発見された問題があれば修正
3. 本番環境での疎通確認計画
4. 運用マニュアル作成

### 本番環境移行準備
1. VoiceDrive側の本番URL決定
2. 本番用APIキー発行・設定
3. 本番環境での疎通確認
4. 監視・アラート設定

---

*作成: 医療システムチーム*
*ファイル: `docs/面談サマリ統合テスト_実施手順書_20251002.md`*
