# 健康機能実装 作業再開指示書

**作成日**: 2025年9月30日
**対象**: DB構築完了後の実装再開
**前提**: フロントエンドUI実装完了済み

---

## 📋 エグゼクティブサマリー

### 実装状況
- ✅ **UI/フロントエンド**: 100%完了
- ⏳ **バックエンド/API**: 0%（DB構築待ち）
- ⏳ **データベース**: 0%（共通DB構築待ち）

### 完了済み作業（2025-09-30）
1. 健康ページ統合・整理（951行削減）
2. 職員カルテ階層化タブ構造実装（6カテゴリ×17タブ）
3. 健康診断詳細表示コンポーネント作成
4. URLパラメータ連携実装
5. ウェルビーイング⇔健康診断の相互リンク
6. リダイレクト設定

### 残作業（DB構築後）
- **Phase 1 MVP**: CSV取込、CRUD API、結果配信（推定30日）
- **Phase 2 基本**: 管理ダッシュボード、ストレスチェック、病歴管理（推定3ヶ月）
- **Phase 3 拡張**: 産業医機能、統計分析、レポート生成（推定6ヶ月）

---

## ✅ 完了済み実装詳細

### 1. UI/コンポーネント実装

#### ✅ HealthCheckupDetailView コンポーネント
**ファイル**: `src/components/health/HealthCheckupDetailView.tsx`
**行数**: 649行
**機能**:
- 健康診断データの詳細表示
- 5カードサマリー（最新、異常、傾向、再検査、統計）
- 5タブ詳細（概要、検査結果、経年変化、産業医所見、ストレス）
- BMI・血圧自動評価ロジック
- 異常項目ハイライト表示
- トレンドグラフ表示
- リスクアセスメント表示
- VoiceDriveアドバイス表示準備

**現在のデータソース**: ダミーデータ（`generateMockHealthData()`）

#### ✅ 職員カルテ階層化タブ構造
**ファイル**: `src/app/staff-cards/[staffId]/page.tsx`
**変更内容**:
- 6カテゴリ×17タブの2層構造実装
- URLパラメータ対応（`?category=health&tab=health-checkup`）
- カテゴリナビゲーションUI（グラデーション背景）
- `handleTabChange()`関数でURL更新
- HealthCheckupDetailView統合

**タブ構成**:
```typescript
const tabCategories = {
  basic: { label: '基本情報', tabs: ['basic', 'career', 'mindset'] },
  achievements: { label: '資格・実績', tabs: ['licenses', 'skills', 'awards'] },
  health: { label: '健康管理', tabs: ['attendance', 'wellbeing', 'health-checkup'] },
  evaluation: { label: '評価・面談', tabs: ['evaluations', 'interviews', 'disciplinary'] },
  training: { label: '育成', tabs: ['education', 'onboarding', 'goals'] },
  links: { label: '関連情報', tabs: ['reports', 'relations', 'activity'] }
};
```

#### ✅ ページ整理・リダイレクト
- `/health/page.tsx` - 削除（404行）
- `/health/Health.module.css` - 削除（545行）
- `/health/staff/[staffId]/page.tsx` - リダイレクトページに変更（33行）
- `MainLayout.tsx` - ナビゲーションリンク更新

#### ✅ スタイル実装
**ファイル**: `src/app/staff-cards/StaffCards.module.css`
**追加内容**:
- カテゴリナビゲーションCSS
- グラデーション背景
- ホバーエフェクト
- アクティブ状態スタイル

---

## ⏳ 未実装項目（DB構築後の作業）

### Phase 1: MVP機能（推定30日）

#### 1. データベース設計・構築
**優先度**: ★★★
**推定工数**: 5日

##### 必要なテーブル

**① health_checkups（健康診断マスター）**
```sql
CREATE TABLE health_checkups (
  id VARCHAR(50) PRIMARY KEY,
  staff_id VARCHAR(50) NOT NULL,
  checkup_date DATE NOT NULL,
  checkup_type ENUM('定期', '雇入時', '特殊', '海外派遣') DEFAULT '定期',
  facility_name VARCHAR(100),

  -- 基本測定値
  height DECIMAL(4,1),
  weight DECIMAL(4,1),
  bmi DECIMAL(3,1) GENERATED AS (weight / POWER(height/100, 2)),
  waist_circumference DECIMAL(4,1),

  -- 血圧
  systolic_bp INT,
  diastolic_bp INT,

  -- 視力
  vision_left DECIMAL(2,1),
  vision_right DECIMAL(2,1),

  -- 総合判定
  overall_result ENUM('A', 'B', 'C', 'D', 'E'),
  reexamination_required BOOLEAN DEFAULT FALSE,
  reexamination_items JSON,

  -- 管理情報
  data_source ENUM('csv_import', 'manual', 'api') DEFAULT 'csv_import',
  created_by VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (staff_id) REFERENCES staff_master(id),
  INDEX idx_staff_date (staff_id, checkup_date DESC),
  INDEX idx_result (overall_result, reexamination_required)
);
```

**② health_checkup_details（検査結果詳細）**
```sql
CREATE TABLE health_checkup_details (
  id VARCHAR(50) PRIMARY KEY,
  checkup_id VARCHAR(50) NOT NULL,
  category ENUM(
    'vision', 'hearing', 'blood', 'urine',
    'liver', 'lipid', 'kidney', 'ecg', 'xray'
  ),
  item_code VARCHAR(50) NOT NULL,
  item_name VARCHAR(100) NOT NULL,
  value VARCHAR(50),
  unit VARCHAR(20),
  reference_min DECIMAL(10,2),
  reference_max DECIMAL(10,2),
  status ENUM('normal', 'attention', 'abnormal'),

  FOREIGN KEY (checkup_id) REFERENCES health_checkups(id) ON DELETE CASCADE,
  INDEX idx_checkup_category (checkup_id, category),
  INDEX idx_abnormal (status, item_code)
);
```

**③ medical_histories（病歴・既往歴管理）**
```sql
CREATE TABLE medical_histories (
  id VARCHAR(50) PRIMARY KEY,
  staff_id VARCHAR(50) NOT NULL,
  report_date DATE NOT NULL,
  report_type ENUM('入職時', '定期更新', '随時申告') DEFAULT '定期更新',

  -- 病歴情報
  disease_name VARCHAR(200),
  icd10_code VARCHAR(10),
  diagnosis_date DATE,
  treatment_status ENUM('治療中', '経過観察', '完治', '未治療') DEFAULT '治療中',

  -- 治療情報
  medication JSON, -- [{name, dose, frequency}]
  medical_institution VARCHAR(100),
  attending_doctor VARCHAR(50),

  -- 就業への影響
  work_restrictions TEXT,
  accommodation_needed BOOLEAN DEFAULT FALSE,

  -- フォローアップ
  next_checkup_date DATE,
  notes TEXT,

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (staff_id) REFERENCES staff_master(id),
  INDEX idx_staff_status (staff_id, treatment_status),
  INDEX idx_followup (next_checkup_date)
);
```

**④ work_accommodations（就業配慮管理）**
```sql
CREATE TABLE work_accommodations (
  id VARCHAR(50) PRIMARY KEY,
  staff_id VARCHAR(50) NOT NULL,

  -- 配慮内容
  accommodation_type ENUM(
    '就業制限', '配置転換', '時短勤務',
    '在宅勤務', '夜勤免除', 'その他'
  ),
  start_date DATE NOT NULL,
  end_date DATE,
  is_active BOOLEAN DEFAULT TRUE,

  -- 詳細
  reason VARCHAR(200),
  details TEXT,
  doctor_opinion TEXT,

  -- 承認情報
  requested_by VARCHAR(50),
  approved_by VARCHAR(50),
  approved_date DATE,
  status ENUM('申請中', '承認済', '実施中', '終了', '却下') DEFAULT '申請中',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (staff_id) REFERENCES staff_master(id),
  INDEX idx_active (is_active, end_date),
  INDEX idx_staff_accommodation (staff_id, accommodation_type)
);
```

**⑤ health_events（健康イベント履歴）**
```sql
CREATE TABLE health_events (
  id VARCHAR(50) PRIMARY KEY,
  staff_id VARCHAR(50) NOT NULL,
  event_date DATETIME NOT NULL,
  event_type ENUM(
    '健康診断実施', '再検査実施', '産業医面談',
    '保健指導', 'ストレスチェック', '予防接種',
    '病歴更新', '就業制限開始', '就業制限解除',
    '結果通知', 'リマインド送信'
  ),

  -- イベント詳細
  title VARCHAR(200),
  description TEXT,
  related_id VARCHAR(50), -- 関連するレコードID

  -- アクション
  action_required TEXT,
  action_completed BOOLEAN DEFAULT FALSE,
  follow_up_date DATE,

  -- 記録情報
  recorded_by VARCHAR(50),
  department ENUM('人事部', '健診室', '産業医', 'システム'),

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (staff_id) REFERENCES staff_master(id),
  INDEX idx_staff_events (staff_id, event_date DESC),
  INDEX idx_followup_pending (follow_up_date, action_completed)
);
```

##### Prismaスキーマ追加

**ファイル**: `prisma/schema.prisma`

```prisma
// 健康診断マスター
model HealthCheckup {
  id                   String   @id @default(cuid())
  staffId              String   @map("staff_id")
  checkupDate          DateTime @map("checkup_date") @db.Date
  checkupType          String   @default("定期") @map("checkup_type")
  facilityName         String?  @map("facility_name") @db.VarChar(100)

  // 基本測定値
  height               Decimal? @db.Decimal(4,1)
  weight               Decimal? @db.Decimal(4,1)
  bmi                  Decimal? @db.Decimal(3,1)
  waistCircumference   Decimal? @map("waist_circumference") @db.Decimal(4,1)

  // 血圧
  systolicBp           Int?     @map("systolic_bp")
  diastolicBp          Int?     @map("diastolic_bp")

  // 視力
  visionLeft           Decimal? @map("vision_left") @db.Decimal(2,1)
  visionRight          Decimal? @map("vision_right") @db.Decimal(2,1)

  // 総合判定
  overallResult        String?  @map("overall_result")
  reexaminationRequired Boolean @default(false) @map("reexamination_required")
  reexaminationItems   Json?    @map("reexamination_items")

  // 管理情報
  dataSource           String   @default("csv_import") @map("data_source")
  createdBy            String?  @map("created_by") @db.VarChar(50)
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // リレーション
  staff                StaffMaster @relation(fields: [staffId], references: [id])
  details              HealthCheckupDetail[]

  @@map("health_checkups")
  @@index([staffId, checkupDate(sort: Desc)], name: "idx_staff_date")
  @@index([overallResult, reexaminationRequired], name: "idx_result")
}

// 検査結果詳細
model HealthCheckupDetail {
  id           String   @id @default(cuid())
  checkupId    String   @map("checkup_id")
  category     String
  itemCode     String   @map("item_code") @db.VarChar(50)
  itemName     String   @map("item_name") @db.VarChar(100)
  value        String?  @db.VarChar(50)
  unit         String?  @db.VarChar(20)
  referenceMin Decimal? @map("reference_min") @db.Decimal(10,2)
  referenceMax Decimal? @map("reference_max") @db.Decimal(10,2)
  status       String?

  // リレーション
  checkup      HealthCheckup @relation(fields: [checkupId], references: [id], onDelete: Cascade)

  @@map("health_checkup_details")
  @@index([checkupId, category], name: "idx_checkup_category")
  @@index([status, itemCode], name: "idx_abnormal")
}

// 病歴・既往歴管理
model MedicalHistory {
  id                   String   @id @default(cuid())
  staffId              String   @map("staff_id")
  reportDate           DateTime @map("report_date") @db.Date
  reportType           String   @default("定期更新") @map("report_type")

  // 病歴情報
  diseaseName          String?  @map("disease_name") @db.VarChar(200)
  icd10Code            String?  @map("icd10_code") @db.VarChar(10)
  diagnosisDate        DateTime? @map("diagnosis_date") @db.Date
  treatmentStatus      String   @default("治療中") @map("treatment_status")

  // 治療情報
  medication           Json?
  medicalInstitution   String?  @map("medical_institution") @db.VarChar(100)
  attendingDoctor      String?  @map("attending_doctor") @db.VarChar(50)

  // 就業への影響
  workRestrictions     String?  @map("work_restrictions") @db.Text
  accommodationNeeded  Boolean  @default(false) @map("accommodation_needed")

  // フォローアップ
  nextCheckupDate      DateTime? @map("next_checkup_date") @db.Date
  notes                String?  @db.Text

  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // リレーション
  staff                StaffMaster @relation(fields: [staffId], references: [id])

  @@map("medical_histories")
  @@index([staffId, treatmentStatus], name: "idx_staff_status")
  @@index([nextCheckupDate], name: "idx_followup")
}

// 就業配慮管理
model WorkAccommodation {
  id                 String   @id @default(cuid())
  staffId            String   @map("staff_id")

  // 配慮内容
  accommodationType  String   @map("accommodation_type")
  startDate          DateTime @map("start_date") @db.Date
  endDate            DateTime? @map("end_date") @db.Date
  isActive           Boolean  @default(true) @map("is_active")

  // 詳細
  reason             String?  @db.VarChar(200)
  details            String?  @db.Text
  doctorOpinion      String?  @map("doctor_opinion") @db.Text

  // 承認情報
  requestedBy        String?  @map("requested_by") @db.VarChar(50)
  approvedBy         String?  @map("approved_by") @db.VarChar(50)
  approvedDate       DateTime? @map("approved_date") @db.Date
  status             String   @default("申請中")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // リレーション
  staff              StaffMaster @relation(fields: [staffId], references: [id])

  @@map("work_accommodations")
  @@index([isActive, endDate], name: "idx_active")
  @@index([staffId, accommodationType], name: "idx_staff_accommodation")
}

// 健康イベント履歴
model HealthEvent {
  id               String   @id @default(cuid())
  staffId          String   @map("staff_id")
  eventDate        DateTime @map("event_date")
  eventType        String   @map("event_type")

  // イベント詳細
  title            String   @db.VarChar(200)
  description      String?  @db.Text
  relatedId        String?  @map("related_id") @db.VarChar(50)

  // アクション
  actionRequired   String?  @map("action_required") @db.Text
  actionCompleted  Boolean  @default(false) @map("action_completed")
  followUpDate     DateTime? @map("follow_up_date") @db.Date

  // 記録情報
  recordedBy       String?  @map("recorded_by") @db.VarChar(50)
  department       String?

  createdAt        DateTime @default(now()) @map("created_at")

  // リレーション
  staff            StaffMaster @relation(fields: [staffId], references: [id])

  @@map("health_events")
  @@index([staffId, eventDate(sort: Desc)], name: "idx_staff_events")
  @@index([followUpDate, actionCompleted], name: "idx_followup_pending")
}
```

##### マイグレーション実行

```bash
# Prismaスキーマからマイグレーション生成
npx prisma migrate dev --name add_health_tables

# 本番環境へのデプロイ
npx prisma migrate deploy
```

---

#### 2. CSV一括取込機能
**優先度**: ★★★
**推定工数**: 5日

##### API実装

**ファイル**: `src/app/api/health/checkups/import/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { parse } from 'csv-parse/sync';
import { prisma } from '@/lib/prisma';
import { z } from 'zod';

// CSVデータバリデーションスキーマ
const HealthCheckupCSVSchema = z.object({
  職員ID: z.string(),
  氏名: z.string(),
  健診日: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  身長: z.string().transform(Number).pipe(z.number().positive()),
  体重: z.string().transform(Number).pipe(z.number().positive()),
  収縮期血圧: z.string().transform(Number).pipe(z.number().int()),
  拡張期血圧: z.string().transform(Number).pipe(z.number().int()),
  // ... 全15カテゴリーのフィールド
});

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return NextResponse.json(
        { error: 'ファイルが選択されていません' },
        { status: 400 }
      );
    }

    // CSVファイル読み込み
    const text = await file.text();
    const records = parse(text, {
      columns: true,
      skip_empty_lines: true,
      encoding: 'utf-8',
      bom: true // UTF-8 BOM対応
    });

    const results = {
      success: 0,
      failed: 0,
      errors: [] as Array<{ row: number; error: string }>
    };

    // トランザクション処理
    await prisma.$transaction(async (tx) => {
      for (let i = 0; i < records.length; i++) {
        try {
          // バリデーション
          const validated = HealthCheckupCSVSchema.parse(records[i]);

          // BMI自動計算
          const bmi = validated.体重 / Math.pow(validated.身長 / 100, 2);

          // 健診データ作成
          await tx.healthCheckup.create({
            data: {
              staffId: validated.職員ID,
              checkupDate: new Date(validated.健診日),
              checkupType: '定期',
              height: validated.身長,
              weight: validated.体重,
              bmi: Number(bmi.toFixed(1)),
              systolicBp: validated.収縮期血圧,
              diastolicBp: validated.拡張期血圧,
              // ... 他のフィールド
              dataSource: 'csv_import',
              createdBy: 'system'
            }
          });

          // イベント記録
          await tx.healthEvent.create({
            data: {
              staffId: validated.職員ID,
              eventDate: new Date(),
              eventType: '健康診断実施',
              title: `${validated.健診日} 定期健康診断`,
              department: 'システム',
              recordedBy: 'csv_import'
            }
          });

          results.success++;
        } catch (error) {
          results.failed++;
          results.errors.push({
            row: i + 2, // ヘッダー行を考慮
            error: error instanceof Error ? error.message : '不明なエラー'
          });
        }
      }
    });

    return NextResponse.json({
      message: 'インポート完了',
      results
    });

  } catch (error) {
    console.error('CSV import error:', error);
    return NextResponse.json(
      { error: 'インポート処理中にエラーが発生しました' },
      { status: 500 }
    );
  }
}
```

##### フロントエンド修正

**ファイル**: `src/app/health/management/page.tsx` (既存)

ダミーデータの部分を実API呼び出しに置換：

```typescript
// 既存のダミーデータ生成部分を削除し、以下に置換
const [isUploading, setIsUploading] = useState(false);

const handleCSVUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
  const file = event.target.files?.[0];
  if (!file) return;

  setIsUploading(true);
  const formData = new FormData();
  formData.append('file', file);

  try {
    const response = await fetch('/api/health/checkups/import', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (response.ok) {
      alert(`インポート完了\n成功: ${result.results.success}件\n失敗: ${result.results.failed}件`);
      // データ再読み込み
      fetchHealthCheckups();
    } else {
      alert(`エラー: ${result.error}`);
    }
  } catch (error) {
    alert('アップロード中にエラーが発生しました');
  } finally {
    setIsUploading(false);
  }
};
```

---

#### 3. 健診データCRUD API
**優先度**: ★★★
**推定工数**: 5日

##### API実装

**ファイル**: `src/app/api/health/checkups/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

// 一覧取得
export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const staffId = searchParams.get('staffId');
  const startDate = searchParams.get('startDate');
  const endDate = searchParams.get('endDate');
  const reexamOnly = searchParams.get('reexamOnly') === 'true';

  const where: any = {};
  if (staffId) where.staffId = staffId;
  if (startDate && endDate) {
    where.checkupDate = {
      gte: new Date(startDate),
      lte: new Date(endDate)
    };
  }
  if (reexamOnly) where.reexaminationRequired = true;

  const checkups = await prisma.healthCheckup.findMany({
    where,
    include: {
      staff: {
        select: {
          name: true,
          department: true
        }
      },
      details: true
    },
    orderBy: {
      checkupDate: 'desc'
    }
  });

  return NextResponse.json(checkups);
}

// 新規作成
export async function POST(request: NextRequest) {
  const body = await request.json();

  const checkup = await prisma.healthCheckup.create({
    data: {
      ...body,
      dataSource: 'manual'
    }
  });

  return NextResponse.json(checkup, { status: 201 });
}
```

**ファイル**: `src/app/api/health/checkups/[id]/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

// 詳細取得
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const checkup = await prisma.healthCheckup.findUnique({
    where: { id: params.id },
    include: {
      staff: true,
      details: true
    }
  });

  if (!checkup) {
    return NextResponse.json(
      { error: '健診データが見つかりません' },
      { status: 404 }
    );
  }

  return NextResponse.json(checkup);
}

// 更新
export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const body = await request.json();

  const checkup = await prisma.healthCheckup.update({
    where: { id: params.id },
    data: body
  });

  return NextResponse.json(checkup);
}

// 削除
export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  await prisma.healthCheckup.delete({
    where: { id: params.id }
  });

  return NextResponse.json({ message: '削除しました' });
}
```

##### フロントエンド修正

**ファイル**: `src/components/health/HealthCheckupDetailView.tsx`

ダミーデータ生成部分を実API呼び出しに置換：

```typescript
// 既存の generateMockHealthData() を削除し、以下に置換

const [healthData, setHealthData] = useState<HealthData | null>(null);
const [loading, setLoading] = useState(true);

useEffect(() => {
  const fetchHealthData = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/health/checkups?staffId=${staffId}`);
      const data = await response.json();

      if (data.length > 0) {
        // 最新の健診データを使用
        const latest = data[0];
        setHealthData(transformToHealthData(latest));
      }
    } catch (error) {
      console.error('Failed to fetch health data:', error);
    } finally {
      setLoading(false);
    }
  };

  fetchHealthData();
}, [staffId]);

if (loading) {
  return <div>読み込み中...</div>;
}

if (!healthData) {
  return <div>健診データがありません</div>;
}
```

---

#### 4. 結果配信システム
**優先度**: ★★★
**推定工数**: 7日

##### お知らせ配信カテゴリ拡張

**ファイル**: `prisma/schema.prisma` (既存テーブルに追加)

```prisma
// notifications テーブルに category 追加
model Notification {
  // ... 既存フィールド
  category String @default("general") // 'general', 'health_checkup', 'stress_check'
  isConfidential Boolean @default(false) @map("is_confidential") // 機密性フラグ
  expiryDate DateTime? @map("expiry_date") @db.Date // 閲覧期限
  accessToken String? @unique @map("access_token") // セキュアアクセス用トークン
}
```

##### API実装

**ファイル**: `src/app/api/notifications/health/send/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { generateAccessToken, encryptHealthData } from '@/lib/security';

export async function POST(request: NextRequest) {
  const body = await request.json();
  const { checkupIds, templateType, expiryDays = 30 } = body;

  const results = [];

  for (const checkupId of checkupIds) {
    // 健診データ取得
    const checkup = await prisma.healthCheckup.findUnique({
      where: { id: checkupId },
      include: { staff: true }
    });

    if (!checkup) continue;

    // アクセストークン生成（セキュアリンク用）
    const accessToken = generateAccessToken();
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + expiryDays);

    // 通知作成
    const notification = await prisma.notification.create({
      data: {
        type: 'individual',
        category: 'health_checkup',
        title: '【重要】健康診断結果のお知らせ',
        content: generateHealthResultMessage(checkup, accessToken, expiryDate),
        targetStaffIds: [checkup.staffId],
        isConfidential: true,
        accessToken,
        expiryDate,
        createdBy: 'health_system',
        department: '健診室'
      }
    });

    // イベント記録
    await prisma.healthEvent.create({
      data: {
        staffId: checkup.staffId,
        eventDate: new Date(),
        eventType: '結果通知',
        title: '健康診断結果通知送信',
        relatedId: notification.id,
        department: 'システム'
      }
    });

    results.push({ checkupId, notificationId: notification.id });
  }

  return NextResponse.json({
    message: `${results.length}件の通知を送信しました`,
    results
  });
}

function generateHealthResultMessage(checkup: any, token: string, expiry: Date): string {
  return `
${checkup.staff.name} 様

${checkup.checkupDate.toLocaleDateString()}に実施された健康診断の結果をお知らせします。

■総合判定: ${checkup.overallResult}
${checkup.reexaminationRequired ? '⚠️ 再検査が必要です' : '✓ 異常なし'}

詳細は以下のリンクからご確認ください。
${process.env.NEXT_PUBLIC_BASE_URL}/health/secure/${token}

※このリンクは${expiry.toLocaleDateString()}まで有効です。
※結果の閲覧には認証が必要です。
  `.trim();
}
```

##### セキュアアクセスページ

**ファイル**: `src/app/health/secure/[token]/page.tsx` (新規作成)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import HealthCheckupDetailView from '@/components/health/HealthCheckupDetailView';

export default function SecureHealthResultPage() {
  const params = useParams();
  const token = params.token as string;
  const [isValid, setIsValid] = useState(false);
  const [staffId, setStaffId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const verifyToken = async () => {
      try {
        const response = await fetch(`/api/health/secure/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });

        if (response.ok) {
          const data = await response.json();
          setStaffId(data.staffId);
          setIsValid(true);
        } else {
          setError('リンクが無効または期限切れです');
        }
      } catch (err) {
        setError('エラーが発生しました');
      }
    };

    verifyToken();
  }, [token]);

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <p className="text-red-600 text-lg">{error}</p>
          <p className="text-gray-600 mt-2">健診室にお問い合わせください</p>
        </div>
      </div>
    );
  }

  if (!isValid || !staffId) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto">
        <div className="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p className="text-yellow-800 text-sm">
            🔒 この情報は機密性が高い個人情報です。他人に共有しないでください。
          </p>
        </div>
        <HealthCheckupDetailView staffId={staffId} showHeader={false} />
      </div>
    </div>
  );
}
```

---

#### 5. 基本検索・フィルター機能
**優先度**: ★★★
**推定工数**: 3日

**ファイル**: `src/app/health/management/page.tsx` (既存)

既存のフィルターUIを実APIに接続：

```typescript
const [filters, setFilters] = useState({
  department: 'all',
  reexamOnly: false,
  dateRange: { start: '', end: '' }
});

const fetchHealthCheckups = async () => {
  const params = new URLSearchParams();
  if (filters.department !== 'all') params.append('department', filters.department);
  if (filters.reexamOnly) params.append('reexamOnly', 'true');
  if (filters.dateRange.start) params.append('startDate', filters.dateRange.start);
  if (filters.dateRange.end) params.append('endDate', filters.dateRange.end);

  const response = await fetch(`/api/health/checkups?${params}`);
  const data = await response.json();
  setCheckups(data);
};

useEffect(() => {
  fetchHealthCheckups();
}, [filters]);
```

---

### Phase 2: 基本機能（推定3ヶ月）

#### 6. 管理ダッシュボード
**優先度**: ★★★
**推定工数**: 1週間

##### 実装内容
- 健診実施率グラフ
- 要再検査者リスト
- 部署別統計
- 期限切れアラート

**ファイル**: `src/app/health/dashboard/page.tsx` (新規作成)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';

export default function HealthDashboard() {
  const [stats, setStats] = useState<any>(null);

  useEffect(() => {
    const fetchStats = async () => {
      const response = await fetch('/api/analytics/health/summary');
      const data = await response.json();
      setStats(data);
    };

    fetchStats();
  }, []);

  if (!stats) return <div>読み込み中...</div>;

  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold mb-6">健康管理ダッシュボード</h1>

      {/* 実施率 */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <h2 className="text-lg font-semibold mb-4">健診実施率</h2>
        <div className="text-4xl font-bold text-blue-600">
          {stats.implementationRate}%
        </div>
        <p className="text-gray-600 mt-2">
          {stats.completed} / {stats.total} 名
        </p>
      </div>

      {/* 要再検査者 */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <h2 className="text-lg font-semibold mb-4">要再検査者</h2>
        <div className="text-4xl font-bold text-red-600">
          {stats.reexaminationRequired} 名
        </div>
      </div>

      {/* 部署別グラフ */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-lg font-semibold mb-4">部署別実施状況</h2>
        <BarChart width={800} height={400} data={stats.byDepartment}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="department" />
          <YAxis />
          <Tooltip />
          <Legend />
          <Bar dataKey="completed" fill="#3b82f6" name="実施済" />
          <Bar dataKey="pending" fill="#ef4444" name="未実施" />
        </BarChart>
      </div>
    </div>
  );
}
```

**API**: `src/app/api/analytics/health/summary/route.ts`

```typescript
export async function GET() {
  const total = await prisma.staffMaster.count({ where: { status: '在職' } });
  const completed = await prisma.healthCheckup.count({
    where: {
      checkupDate: {
        gte: new Date(new Date().getFullYear(), 0, 1) // 今年度
      }
    }
  });

  const reexaminationRequired = await prisma.healthCheckup.count({
    where: {
      reexaminationRequired: true,
      // 再検査未実施の条件
    }
  });

  // 部署別集計
  const byDepartment = await prisma.$queryRaw`
    SELECT
      s.department,
      COUNT(DISTINCT s.id) as total,
      COUNT(DISTINCT h.staff_id) as completed
    FROM staff_master s
    LEFT JOIN health_checkups h ON s.id = h.staff_id
      AND YEAR(h.checkup_date) = YEAR(NOW())
    WHERE s.status = '在職'
    GROUP BY s.department
  `;

  return NextResponse.json({
    total,
    completed,
    implementationRate: Math.round((completed / total) * 100),
    reexaminationRequired,
    byDepartment
  });
}
```

---

#### 7. ストレスチェック配信
**優先度**: ★★★
**推定工数**: 2週間

##### 実装内容
- 機密性の高い個別配信
- 本人のみアクセス可能
- 産業医面談案内（高ストレス者のみ）
- 集団分析（10名以上の部署のみ）

**重要**: 労働安全衛生法第66条の10に基づく厳格な機密管理が必要

**ファイル**: `src/app/api/notifications/stress-check/send/route.ts`

```typescript
export async function POST(request: NextRequest) {
  const body = await request.json();
  const { stressCheckResults } = body; // [{staffId, score, isHighRisk}]

  for (const result of stressCheckResults) {
    const accessToken = generateSecureToken();

    await prisma.notification.create({
      data: {
        type: 'individual',
        category: 'stress_check',
        title: 'ストレスチェック実施結果について',
        content: generateStressCheckMessage(result, accessToken),
        targetStaffIds: [result.staffId],
        isConfidential: true, // 最高機密
        accessToken,
        expiryDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000), // 90日
        // 管理者・上司には非公開
        excludeManagement: true
      }
    });

    // 高ストレス者への面談案内
    if (result.isHighRisk) {
      await prisma.notification.create({
        data: {
          type: 'individual',
          category: 'stress_check',
          title: '産業医面談のご案内（任意）',
          content: '高ストレスと判定されました。ご希望の方は産業医面談を実施できます...',
          targetStaffIds: [result.staffId],
          isConfidential: true
        }
      });
    }
  }

  return NextResponse.json({ message: '配信完了' });
}
```

---

#### 8-10. その他Phase 2機能
- **8. リマインド機能**: 未確認者への3日後自動リマインド
- **9. 病歴管理**: `medical_histories` テーブルのCRUD実装
- **10. 就業配慮設定**: `work_accommodations` テーブルのCRUD実装

詳細は `docs/健康関連情報実装計画書_統合版.md` 参照

---

### Phase 3: 拡張機能（推定6ヶ月）

#### 11. 産業医機能
- 面談記録入力フォーム
- 就業判定（通常勤務/要観察/要精密検査/就業制限）
- 医学的所見記録

#### 12-13. 統計・トレンド分析
- 部署別・年齢別・性別分析
- 経年変化グラフ（体重、血圧、BMI等）
- 異常値予測アルゴリズム

#### 14. レポート生成
- 労働基準監督署提出用書類自動作成
- 健診結果報告書PDF生成

#### 15. システム連携
- 勤怠データとの連携（残業時間と健康状態の相関分析）
- ストレスチェックシステムとの連携
- VoiceDrive AI アドバイス生成

---

## 🔄 作業再開手順

### ステップ1: 環境確認（1日）

```bash
# 1. リポジトリ最新化
git checkout main
git pull origin main

# 2. 依存関係更新
npm install

# 3. 環境変数確認
cat .env
# DATABASE_URL が設定されていることを確認

# 4. Prismaクライアント生成
npx prisma generate

# 5. 開発サーバー起動確認
npm run dev
```

### ステップ2: DB構築（5日）

```bash
# 1. Prismaスキーマに健康関連テーブル追加
# prisma/schema.prisma を編集（上記参照）

# 2. マイグレーション生成
npx prisma migrate dev --name add_health_tables

# 3. マイグレーション確認
npx prisma studio
# 5つのテーブルが作成されていることを確認

# 4. 初期データ投入（オプション）
npx prisma db seed
```

### ステップ3: CSV取込実装（5日）

```bash
# 1. APIルート作成
mkdir -p src/app/api/health/checkups/import
touch src/app/api/health/checkups/import/route.ts

# 2. 実装（上記コード参照）

# 3. テスト
curl -X POST http://localhost:3000/api/health/checkups/import \
  -F "file=@test-data.csv"

# 4. フロントエンド接続
# src/app/health/management/page.tsx を修正
```

### ステップ4: CRUD API実装（5日）

```bash
# 1. 一覧・作成API
touch src/app/api/health/checkups/route.ts

# 2. 詳細・更新・削除API
mkdir src/app/api/health/checkups/[id]
touch src/app/api/health/checkups/[id]/route.ts

# 3. フロントエンド接続
# src/components/health/HealthCheckupDetailView.tsx を修正
```

### ステップ5: 結果配信実装（7日）

```bash
# 1. 通知API拡張
touch src/app/api/notifications/health/send/route.ts

# 2. セキュアアクセスページ
mkdir -p src/app/health/secure/[token]
touch src/app/health/secure/[token]/page.tsx

# 3. トークン検証API
touch src/app/api/health/secure/verify/route.ts

# 4. 統合テスト
```

### ステップ6: 統合テスト（3日）

```bash
# 1. E2Eテスト
npm run test:e2e

# 2. CSV取込テスト
npm run test:csv-import

# 3. 通知配信テスト
npm run test:notifications

# 4. セキュリティテスト
npm run test:security
```

### ステップ7: 本番デプロイ（2日）

```bash
# 1. 本番環境マイグレーション
npx prisma migrate deploy

# 2. ビルド確認
npm run build

# 3. デプロイ
vercel --prod

# 4. 本番環境動作確認
```

---

## 📊 進捗管理

### チェックリスト

#### Phase 1 MVP（30日）
- [ ] DB設計・テーブル作成
- [ ] Prismaスキーマ追加
- [ ] マイグレーション実行
- [ ] CSV取込API実装
- [ ] CSV取込フロントエンド実装
- [ ] 一覧取得API実装
- [ ] 詳細取得API実装
- [ ] 作成API実装
- [ ] 更新API実装
- [ ] 削除API実装
- [ ] HealthCheckupDetailView API接続
- [ ] 健診結果配信API実装
- [ ] セキュアアクセスページ実装
- [ ] トークン検証API実装
- [ ] 統合テスト実施
- [ ] 本番デプロイ

#### Phase 2 基本機能（3ヶ月）
- [ ] 管理ダッシュボードAPI実装
- [ ] 管理ダッシュボードUI実装
- [ ] ストレスチェック配信API実装
- [ ] ストレスチェックセキュアページ実装
- [ ] リマインド機能実装
- [ ] 病歴管理CRUD実装
- [ ] 就業配慮管理CRUD実装

#### Phase 3 拡張機能（6ヶ月）
- [ ] 産業医機能実装
- [ ] 統計分析API実装
- [ ] トレンド分析実装
- [ ] レポート生成機能実装
- [ ] 外部システム連携実装

---

## 🔗 関連ドキュメント

- [健康関連情報実装計画書（統合版）](./健康関連情報実装計画書_統合版.md) - 詳細仕様
- [開発メモ](../src/app/admin/dev-notes/page.tsx) - 日々の作業記録
- [Phase3実装作業完了報告書](./Phase3_実装作業完了報告書_FINAL.md) - 施設別権限管理の完了報告

---

## ⚠️ 重要な注意事項

### セキュリティ
1. **健康情報は要配慮個人情報** - 最高レベルのセキュリティ対策必須
2. **ストレスチェック結果** - 実施者（産業医）以外は閲覧不可
3. **アクセスログ** - 全ての閲覧・更新を監査ログに記録
4. **データ暗号化** - DB保存時はAES-256で暗号化

### 法令遵守
1. **労働安全衛生法** - 年1回実施、5年間保管
2. **個人情報保護法** - 目的外利用禁止、第三者提供制限
3. **ストレスチェック制度** - 本人同意なしの事業者提供禁止

### パフォーマンス
1. **大量データ対応** - 1,250名×過去5年分 = 6,250件以上
2. **CSV取込** - 1,000件を30秒以内で処理
3. **検索レスポンス** - 500ms以内

---

## 📞 問い合わせ先

### 技術的質問
- VoiceDriveチーム（`mcp-shared/` 経由で連携）
- システム管理者

### 業務的質問
- 健診室長
- 産業保健師

### 法令・コンプライアンス
- 人事部長
- 産業医

---

**文書情報**
- 作成日: 2025年9月30日
- 最終更新: 2025年9月30日
- バージョン: 1.0
- 対象者: 開発者、VoiceDriveチーム
- 機密レベル: 社内限定

---

以上