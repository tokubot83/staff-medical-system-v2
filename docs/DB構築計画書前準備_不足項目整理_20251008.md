# DB構築計画書前準備 - 不足項目整理

**文書番号**: DB-PREP-2025-1008-001
**作成日**: 2025年10月8日
**作成者**: 医療システムチーム
**目的**: DB構築前に不足しているテーブル・カラムを洗い出し、完全なスキーマ設計を行う
**重要度**: 🔴 最重要

---

## 📋 エグゼクティブサマリー

### 背景
- VoiceDriveチームがMySQL移行を実施中
- 医療システム側もMySQL構築を控えている
- **DB構築後のテーブル追加は手間とコスト増**
- **今の段階で可能な限り抜け漏れを洗い出すことが重要**

### 方針
1. ✅ 不足項目をリストアップ
2. ✅ テーブル設計案を作成
3. ✅ フロントエンド実装は後回し（DBに登録可能にしておく）
4. ✅ VoiceDrive実装パターンを参考にする

---

## 🔴 重大な不足項目（Priority 1: 必須）

### 1. 資格管理テーブル ❌ 完全に不足

#### 現状の問題
- `EmployeeSkill`テーブルで代用しているが不十分
- 取得日、更新日、管轄団体が記録できない
- 資格番号が記録できない

#### 必要なテーブル: `Certifications`

```prisma
model Certification {
  id                   String   @id @default(cuid())
  employeeId           String   @map("employee_id")
  certificationType    String   @map("certification_type")    // 看護師、准看護師、介護福祉士等
  certificationNumber  String?  @map("certification_number")  // 資格番号
  issuingAuthority     String   @map("issuing_authority")     // 管轄団体（厚生労働省、看護協会等）
  obtainedDate         DateTime @map("obtained_date")         // 取得日
  issueDate            DateTime? @map("issue_date")            // 交付日
  expiryDate           DateTime? @map("expiry_date")           // 有効期限
  lastRenewalDate      DateTime? @map("last_renewal_date")     // 最終更新日
  renewalCycleYears    Int?     @map("renewal_cycle_years")   // 更新周期（年）
  status               String   @default("active")            // active, expired, suspended, revoked
  documentPath         String?  @map("document_path")         // 資格証明書ファイルパス
  notes                String?                                // 備考
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([certificationType])
  @@index([status])
  @@index([expiryDate])  // 期限管理用
  @@map("certifications")
}
```

#### 影響範囲
- 🔴 看護師免許更新管理に必須
- 🔴 介護福祉士資格管理に必須
- 🔴 医療従事者の資格有効性確認に必須

---

### 2. 給与・報酬情報テーブル ❌ 完全に不足

#### 現状の問題
- 給与情報が一切記録できない
- 昇給履歴が追跡できない
- 手当情報が管理できない

#### 必要なテーブル: `Salaries`（給与マスタ）

```prisma
model Salary {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  effectiveDate   DateTime @map("effective_date")        // 適用開始日
  baseSalary      Decimal  @map("base_salary") @db.Decimal(10, 2)  // 基本給
  positionAllowance Decimal? @map("position_allowance") @db.Decimal(10, 2)  // 役職手当
  qualificationAllowance Decimal? @map("qualification_allowance") @db.Decimal(10, 2)  // 資格手当
  nightShiftAllowance Decimal? @map("night_shift_allowance") @db.Decimal(10, 2)  // 夜勤手当
  housingAllowance Decimal? @map("housing_allowance") @db.Decimal(10, 2)  // 住宅手当
  familyAllowance Decimal? @map("family_allowance") @db.Decimal(10, 2)  // 家族手当
  otherAllowances Decimal? @map("other_allowances") @db.Decimal(10, 2)  // その他手当
  totalMonthlySalary Decimal @map("total_monthly_salary") @db.Decimal(10, 2)  // 月額合計
  raiseReason     String?  @map("raise_reason")          // 昇給理由（定期昇給、昇格等）
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, effectiveDate(sort: Desc)])
  @@map("salaries")
}
```

#### セキュリティ考慮
- 🔒 アクセス権限を厳格に制限（Level 12以上のみ）
- 🔒 監査ログ必須
- 🔒 暗号化検討

---

### 3. 勤怠管理テーブル ❌ 完全に不足

#### 現状の問題
- 出勤・欠勤記録がない
- 休暇取得履歴がない
- 労働時間管理ができない

#### 必要なテーブル: `Attendances`（勤怠記録）

```prisma
model Attendance {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  workDate        DateTime @map("work_date") @db.Date  // 勤務日
  status          String                               // present, absent, leave, holiday
  checkInTime     DateTime? @map("check_in_time")       // 出勤時刻
  checkOutTime    DateTime? @map("check_out_time")      // 退勤時刻
  workHours       Float?   @map("work_hours")          // 実労働時間
  overtimeHours   Float?   @map("overtime_hours")      // 残業時間
  nightShiftHours Float?   @map("night_shift_hours")   // 夜勤時間
  breakHours      Float?   @map("break_hours")         // 休憩時間
  leaveType       String?  @map("leave_type")          // annual, sick, special, maternity等
  notes           String?
  approvedBy      String?  @map("approved_by")         // 承認者ID
  approvedAt      DateTime? @map("approved_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, workDate])
  @@index([employeeId, workDate(sort: Desc)])
  @@index([status])
  @@map("attendances")
}
```

#### 必要なテーブル: `LeaveBalances`（休暇残高）

```prisma
model LeaveBalance {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  fiscalYear      Int      @map("fiscal_year")         // 年度
  leaveType       String   @map("leave_type")          // annual, sick, special
  totalDays       Float    @map("total_days")          // 付与日数
  usedDays        Float    @map("used_days")           // 使用日数
  remainingDays   Float    @map("remaining_days")      // 残日数
  expiryDate      DateTime? @map("expiry_date")         // 有効期限
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, fiscalYear, leaveType])
  @@index([employeeId])
  @@map("leave_balances")
}
```

---

### 3-2. 勤務パターン・ワークライフバランステーブル ❌ 完全に不足

#### 現状の問題
- シフトパターン（日勤/夜勤の割合）が記録できない
- ワークライフバランススコアが算出・記録できない
- 勤務安定性の評価ができない
- 定時退社率、連続勤務日数などの詳細指標がない

#### 必要なテーブル: `WorkPatternAnalyses`（勤務パターン分析）

```prisma
model WorkPatternAnalysis {
  id                    String   @id @default(cuid())
  employeeId            String   @map("employee_id")
  analysisPeriod        String   @map("analysis_period")         // 分析期間（2024-Q1、2024年度等）

  // シフトパターン（割合%）
  dayShiftRatio         Float    @map("day_shift_ratio")         // 日勤割合
  nightShiftRatio       Float    @map("night_shift_ratio")       // 夜勤割合
  holidayWorkRatio      Float    @map("holiday_work_ratio")      // 休日出勤割合

  // ワークライフバランス指標
  workLifeBalanceScore  String   @map("work_life_balance_score") // S, A+, A, B, C等
  onTimeLeaveRate       Float    @map("on_time_leave_rate")      // 定時退社率（%）
  maxConsecutiveWorkDays Int     @map("max_consecutive_work_days") // 最大連続勤務日数
  averageWorkHoursPerDay Float?  @map("average_work_hours_per_day") // 1日平均労働時間

  // 勤務安定性指標
  attendanceReliabilityScore String @map("attendance_reliability_score") // S, A, B, C等
  attendanceRate        Float    @map("attendance_rate")         // 出勤率（%）
  latenessCount         Int      @default(0) @map("lateness_count")      // 遅刻回数
  earlyLeaveCount       Int      @default(0) @map("early_leave_count")   // 早退回数
  absenceCount          Int      @default(0) @map("absence_count")       // 欠勤回数

  // 労働時間関連
  averageOvertimeHours  Float?   @map("average_overtime_hours")  // 月平均残業時間
  totalOvertimeHours    Float?   @map("total_overtime_hours")    // 期間合計残業時間
  holidayWorkDays       Int?     @default(0) @map("holiday_work_days")   // 休日出勤日数

  // 休暇取得関連
  annualLeaveUsageRate  Float?   @map("annual_leave_usage_rate") // 有給取得率（%）
  annualLeaveUsedDays   Float?   @map("annual_leave_used_days")  // 有給使用日数
  annualLeaveTotalDays  Float?   @map("annual_leave_total_days") // 有給付与日数

  // 評価・コメント
  evaluatorComment      String?  @map("evaluator_comment")
  improvementSuggestions String? @map("improvement_suggestions")  // 改善提案

  // メタデータ
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, analysisPeriod])
  @@index([employeeId])
  @@index([analysisPeriod(sort: Desc)])
  @@index([workLifeBalanceScore])
  @@index([attendanceReliabilityScore])
  @@map("work_pattern_analyses")
}
```

#### ワークライフバランススコア基準

| スコア | 基準 |
|--------|------|
| **S** | 定時退社率90%以上、連続勤務5日以下、残業月10時間以下 |
| **A+** | 定時退社率80%以上、連続勤務6日以下、残業月15時間以下 |
| **A** | 定時退社率70%以上、連続勤務7日以下、残業月20時間以下 |
| **B** | 定時退社率60%以上、連続勤務8日以下、残業月30時間以下 |
| **C** | 上記未満 |

#### 勤務安定性スコア基準

| スコア | 基準 |
|--------|------|
| **S** | 出勤率98%以上、遅刻0回、早退2回以下 |
| **A** | 出勤率95%以上、遅刻1回以下、早退3回以下 |
| **B** | 出勤率90%以上、遅刻2回以下、早退5回以下 |
| **C** | 上記未満 |

---

### 3-3. 業務出張履歴テーブル ❌ 完全に不足

#### 現状の問題
- 業務出張の記録ができない
- 研修・会議等の出張目的が管理できない
- 交通費・宿泊費の精算情報が紐付けできない

#### 必要なテーブル: `BusinessTrips`（業務出張履歴）

```prisma
model BusinessTrip {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  tripType        String   @map("trip_type")               // training, conference, meeting, inspection, other
  destination     String                                   // 出張先
  purpose         String                                   // 目的
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime @map("end_date") @db.Date
  durationDays    Int      @map("duration_days")           // 日数

  // 費用関連
  transportationCost Decimal? @map("transportation_cost") @db.Decimal(10, 2)  // 交通費
  accommodationCost  Decimal? @map("accommodation_cost") @db.Decimal(10, 2)   // 宿泊費
  mealAllowance     Decimal? @map("meal_allowance") @db.Decimal(10, 2)        // 日当
  otherExpenses     Decimal? @map("other_expenses") @db.Decimal(10, 2)        // その他経費
  totalCost         Decimal? @map("total_cost") @db.Decimal(10, 2)            // 合計費用

  // 承認・精算
  approvalStatus  String   @default("pending") @map("approval_status")  // pending, approved, rejected
  approvedBy      String?  @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  settlementStatus String  @default("pending") @map("settlement_status") // pending, settled
  settlementDate  DateTime? @map("settlement_date")

  // 報告書
  reportSubmitted Boolean  @default(false) @map("report_submitted")
  reportPath      String?  @map("report_path")              // 出張報告書ファイルパス

  // メタデータ
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([tripType])
  @@index([startDate(sort: Desc)])
  @@index([approvalStatus])
  @@map("business_trips")
}
```

#### 出張タイプ（tripType）定義

| タイプ | 説明 | 例 |
|--------|------|-----|
| `training` | 研修・教育 | 東京研修センター 3日間 |
| `conference` | 学会・会議 | 日本看護協会総会 |
| `meeting` | 会議・打ち合わせ | 大阪本部 経営会議 |
| `inspection` | 視察・見学 | 先進病院視察 |
| `other` | その他 | その他の業務出張 |

---

### 4. 懲戒・表彰履歴テーブル ❌ 完全に不足

#### 必要なテーブル: `DisciplinaryActions`（懲戒記録）

```prisma
model DisciplinaryAction {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  actionDate      DateTime @map("action_date")          // 処分日
  actionType      String   @map("action_type")          // warning, reprimand, suspension, dismissal
  reason          String                                // 理由
  description     String?                               // 詳細
  issuedBy        String   @map("issued_by")            // 発令者ID
  effectivePeriod String?  @map("effective_period")     // 効力期間
  status          String   @default("active")           // active, expired, revoked
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([actionDate(sort: Desc)])
  @@map("disciplinary_actions")
}
```

#### 必要なテーブル: `Awards`（表彰記録）

```prisma
model Award {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  awardDate       DateTime @map("award_date")           // 表彰日
  awardType       String   @map("award_type")           // employee_of_month, outstanding_service, innovation等
  awardName       String   @map("award_name")           // 表彰名
  reason          String                                // 理由
  description     String?                               // 詳細
  issuedBy        String   @map("issued_by")            // 授与者ID
  monetaryReward  Decimal? @map("monetary_reward") @db.Decimal(10, 2)  // 賞金・報奨金
  certificatePath String?  @map("certificate_path")     // 表彰状ファイルパス
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([awardDate(sort: Desc)])
  @@map("awards")
}
```

---

### 5. 家族情報テーブル ❌ 完全に不足

#### 現状の問題
- `Employee.emergencyPhone`のみ
- 扶養家族情報がない
- 緊急連絡先の詳細がない

#### 必要なテーブル: `FamilyMembers`（家族情報）

```prisma
model FamilyMember {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  relationship    String                                // spouse, child, parent, sibling, other
  name            String
  nameKana        String?  @map("name_kana")
  birthDate       DateTime? @map("birth_date")
  gender          String?
  isDependent     Boolean  @default(false) @map("is_dependent")  // 扶養対象
  isEmergencyContact Boolean @default(false) @map("is_emergency_contact")  // 緊急連絡先
  phone           String?
  address         String?
  occupation      String?                               // 職業
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("family_members")
}
```

---

### 6. 退職関連情報テーブル ⚠️ 部分的に不足

#### 現状の問題
- `Employee.retiredAt`はあるが詳細情報がない

#### 必要なテーブル: `RetirementDetails`（退職詳細）

```prisma
model RetirementDetail {
  id                  String   @id @default(cuid())
  employeeId          String   @unique @map("employee_id")  // 1職員1退職記録
  retirementDate      DateTime @map("retirement_date")      // 退職日
  retirementType      String   @map("retirement_type")      // voluntary, mandatory_age, dismissal, health, other
  retirementReason    String   @map("retirement_reason")    // 理由（詳細）
  retirementCategory  String   @map("retirement_category")  // personal, company, health, family, career
  isEligibleForRehire Boolean  @default(true) @map("is_eligible_for_rehire")  // 再雇用可否
  severancePay        Decimal? @map("severance_pay") @db.Decimal(10, 2)  // 退職金
  exitInterviewDate   DateTime? @map("exit_interview_date")  // 退職面談日
  exitInterviewNotes  String?  @map("exit_interview_notes")  // 退職面談メモ
  rehiredDate         DateTime? @map("rehired_date")         // 再雇用日（該当時）
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([retirementDate])
  @@index([retirementType])
  @@map("retirement_details")
}
```

---

### 7. 契約情報テーブル ❌ 完全に不足

#### 現状の問題
- 雇用形態が記録できない
- 契約期間が管理できない
- 契約更新履歴がない

#### 必要なテーブル: `EmploymentContracts`（雇用契約）

```prisma
model EmploymentContract {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  contractType    String   @map("contract_type")        // permanent, contract, part_time, temporary
  contractNumber  String?  @map("contract_number")      // 契約番号
  startDate       DateTime @map("start_date")            // 契約開始日
  endDate         DateTime? @map("end_date")              // 契約終了日（期限付き契約の場合）
  workingHours    Float    @map("working_hours")        // 所定労働時間（週）
  workingDays     Float    @map("working_days")         // 所定労働日数（週）
  probationPeriod Int?     @map("probation_period")     // 試用期間（月数）
  probationEndDate DateTime? @map("probation_end_date")  // 試用期間終了日
  renewalCount    Int      @default(0) @map("renewal_count")  // 更新回数
  isActive        Boolean  @default(true) @map("is_active")
  contractPath    String?  @map("contract_path")        // 契約書ファイルパス
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([contractType])
  @@index([isActive])
  @@index([endDate])  // 契約更新管理用
  @@map("employment_contracts")
}
```

---

### 8. 経歴情報テーブル ❌ 完全に不足

#### 必要なテーブル: `EducationHistories`（学歴）

```prisma
model EducationHistory {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  schoolType      String   @map("school_type")          // high_school, vocational, junior_college, university, graduate
  schoolName      String   @map("school_name")          // 学校名
  major           String?                               // 専攻
  degree          String?                               // 学位
  startDate       DateTime @map("start_date")
  endDate         DateTime? @map("end_date")
  graduationStatus String  @map("graduation_status")    // graduated, dropped_out, in_progress
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("education_histories")
}
```

#### 必要なテーブル: `WorkExperiences`（職歴）

```prisma
model WorkExperience {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  companyName     String   @map("company_name")         // 会社名
  companyType     String?  @map("company_type")         // hospital, clinic, nursing_home, other
  position        String                                // 役職
  department      String?                               // 部署
  jobCategory     String?  @map("job_category")         // nurse, care_worker, admin等
  startDate       DateTime @map("start_date")
  endDate         DateTime? @map("end_date")
  isCurrent       Boolean  @default(false) @map("is_current")  // 現職
  responsibilities String?                              // 職務内容
  achievements    String?                               // 実績
  reasonForLeaving String? @map("reason_for_leaving")   // 退職理由
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([jobCategory])
  @@map("work_experiences")
}
```

---

## 🟡 中程度の不足項目（Priority 2: 重要）

### 9. ウェルビーイング・健康管理テーブル ⚠️ 部分的に不足

#### 現状の問題
- `HealthRecord`テーブルで基本的な健診データは記録可能
- しかし、ウェルビーイング総合評価、ストレス要因詳細、運動習慣等が不足
- メンタルヘルス相談履歴が記録できない

#### 既存テーブルへの追加フィールド: `HealthRecords`

```prisma
model HealthRecord {
  id                  String   @id @default(cuid())
  employeeId          String
  checkupDate         DateTime

  // 既存フィールド
  healthStatus        String   // good, caution, alert
  healthScore         Float    // 0-100
  stressIndex         Float    // 0-100
  bmi                 Float?
  bloodPressure       String?

  // 🆕 追加フィールド
  wellbeingGrade      String?  @map("wellbeing_grade")         // S, A, B, C, D（総合評価）
  exerciseFrequency   String?  @map("exercise_frequency")      // 運動頻度（3回/週等）
  sleepQuality        String?  @map("sleep_quality")           // good, fair, poor
  smokingStatus       String?  @map("smoking_status")          // non_smoker, smoker, ex_smoker
  alcoholConsumption  String?  @map("alcohol_consumption")     // none, moderate, heavy

  // ストレス要因（JSON配列）
  stressFactors       Json?    @map("stress_factors")          // [{factor: "overtime", level: "medium"}, ...]

  // 健康改善ポイント（JSON配列）
  improvementPoints   Json?    @map("improvement_points")      // ["睡眠改善", "運動習慣継続", "ストレス管理"]

  // 既存フィールド
  risks               String?  // 健康リスク項目（JSON形式）
  recommendations     String?  // 推奨事項（JSON形式）
  nextCheckupDate     DateTime
  occupationalDoctor  String?  // 産業医所見
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("health_records")
}
```

#### ストレス要因JSON例

```json
[
  {
    "factor": "overtime",
    "factorName": "残業時間",
    "level": "medium",
    "score": 40
  },
  {
    "factor": "relationships",
    "factorName": "人間関係",
    "level": "low",
    "score": 15
  },
  {
    "factor": "workload",
    "factorName": "業務負荷",
    "level": "medium",
    "score": 35
  }
]
```

---

### 9-2. ストレスチェック詳細テーブル ❌ 完全に不足

#### 現状の問題
- 法定ストレスチェックの詳細結果が記録できない
- 経年変化が追跡できない
- 高ストレス判定者のフォローアップが管理できない

#### 必要なテーブル: `StressCheckResults`（ストレスチェック結果）

```prisma
model StressCheckResult {
  id                    String   @id @default(cuid())
  employeeId            String   @map("employee_id")
  checkDate             DateTime @map("check_date")             // 実施日

  // 総合評価
  overallResult         String   @map("overall_result")         // good, caution, high_stress
  totalScore            Int      @map("total_score")            // 総合点数

  // 3つの領域別スコア（厚労省基準）
  psychologicalBurdenScore Int   @map("psychological_burden_score")  // 心理的な負担
  physicalBurdenScore      Int   @map("physical_burden_score")       // 身体的な負担
  supportScore             Int   @map("support_score")               // 周囲のサポート

  // 高ストレス判定
  isHighStress          Boolean  @default(false) @map("is_high_stress")
  requiresInterview     Boolean  @default(false) @map("requires_interview")  // 面接指導推奨
  interviewRequested    Boolean  @default(false) @map("interview_requested") // 本人が面接希望

  // 産業医面接
  interviewDate         DateTime? @map("interview_date")
  interviewDoctor       String?  @map("interview_doctor")
  interviewNotes        String?  @map("interview_notes")
  followUpRequired      Boolean  @default(false) @map("follow_up_required")

  // フォローアップ
  followUpDate          DateTime? @map("follow_up_date")
  followUpStatus        String?  @map("follow_up_status")        // pending, completed, ongoing
  improvementObserved   Boolean? @map("improvement_observed")

  // メタデータ
  notes                 String?
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([checkDate(sort: Desc)])
  @@index([isHighStress])
  @@map("stress_check_results")
}
```

#### 評価基準（厚生労働省基準準拠）

| 総合評価 | 説明 | 対応 |
|---------|------|------|
| `good` | 良好 | 経過観察不要 |
| `caution` | 注意 | セルフケア推奨 |
| `high_stress` | 高ストレス | 産業医面接推奨 |

---

### 9-3. メンタルヘルス相談履歴テーブル ❌ 完全に不足

#### 現状の問題
- メンタルヘルス相談の記録ができない
- 相談内容の機密性を保ちつつ記録する仕組みが必要
- カウンセリング継続状況が追跡できない

#### 必要なテーブル: `MentalHealthConsultations`（メンタルヘルス相談）

```prisma
model MentalHealthConsultation {
  id                  String   @id @default(cuid())
  employeeId          String   @map("employee_id")
  consultationDate    DateTime @map("consultation_date")       // 相談日
  consultationType    String   @map("consultation_type")       // occupational_doctor, counselor, external_eap

  // 相談内容（プライバシー配慮）
  consultationCategory String  @map("consultation_category")   // work_stress, relationships, health, life, other
  severityLevel       String?  @map("severity_level")          // low, medium, high, urgent

  // 相談対応
  counselorName       String?  @map("counselor_name")
  sessionDuration     Int?     @map("session_duration")        // 相談時間（分）
  followUpRecommended Boolean  @default(false) @map("follow_up_recommended")

  // 次回予約
  nextSessionDate     DateTime? @map("next_session_date")
  isOngoing           Boolean  @default(false) @map("is_ongoing")  // 継続相談中

  // プライバシー保護
  detailedNotes       String?  @map("detailed_notes")          // 詳細記録（アクセス制限）
  accessLevel         String   @default("confidential") @map("access_level")  // public, limited, confidential

  // 改善状況
  improvementStatus   String?  @map("improvement_status")      // improving, stable, declining
  completedDate       DateTime? @map("completed_date")         // 相談完了日

  // メタデータ
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([consultationDate(sort: Desc)])
  @@index([isOngoing])
  @@map("mental_health_consultations")
}
```

#### 相談タイプ（consultationType）

| タイプ | 説明 |
|--------|------|
| `occupational_doctor` | 産業医面談 |
| `counselor` | 社内カウンセラー |
| `external_eap` | 外部EAP（従業員支援プログラム） |
| `peer_support` | ピアサポート |

#### 相談カテゴリ（consultationCategory）

| カテゴリ | 説明 |
|---------|------|
| `work_stress` | 業務ストレス |
| `relationships` | 人間関係 |
| `health` | 健康問題 |
| `life` | 生活・家庭 |
| `career` | キャリア相談 |
| `other` | その他 |

#### プライバシー保護

- **accessLevel**でアクセス制限
  - `public`: 本人・上司・人事が閲覧可能
  - `limited`: 本人・産業医・人事責任者のみ
  - `confidential`: 本人・担当カウンセラーのみ

---

### 9-4. 健康診断詳細検査結果テーブル ❌ 完全に不足

#### 現状の問題
- `HealthRecord`テーブルでは基本情報のみ
- **詳細な検査値**（血液検査、尿検査等）が別テーブルで必要
- 経年変化を追跡するには検査項目ごとのデータ保存が必須

#### 必要なテーブル: `HealthCheckupDetails`（健診詳細検査結果）

```prisma
model HealthCheckupDetail {
  id              String   @id @default(cuid())
  healthRecordId  String   @map("health_record_id")        // HealthRecordとの紐付け
  category        String                                   // blood, urine, xray, ecg, etc
  itemName        String   @map("item_name")               // 検査項目名（AST、ALT、HDL等）
  value           String                                   // 測定値（数値または文字列）
  unit            String?                                  // 単位（mg/dl、IU/l等）
  status          String   @default("normal")              // normal, caution, abnormal
  referenceMin    Float?   @map("reference_min")           // 基準値下限
  referenceMax    Float?   @map("reference_max")           // 基準値上限
  notes           String?                                  // 備考
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  healthRecord HealthRecord @relation(fields: [healthRecordId], references: [id], onDelete: Cascade)

  @@index([healthRecordId])
  @@index([category])
  @@index([itemName])
  @@index([status])
  @@map("health_checkup_details")
}
```

#### 検査カテゴリ（category）

| カテゴリ | 説明 | 含まれる項目例 |
|---------|------|--------------|
| `blood` | 血液検査 | AST、ALT、HDL、LDL、中性脂肪、血糖値、HbA1c等 |
| `urine` | 尿検査 | 尿蛋白、尿糖、潜血等 |
| `xray` | X線検査 | 胸部X線所見 |
| `ecg` | 心電図 | 心電図所見 |
| `physical` | 身体測定 | 視力、聴力、腹囲等 |
| `other` | その他 | 眼底検査等 |

#### 検査ステータス（status）

| ステータス | 説明 |
|-----------|------|
| `normal` | 正常範囲内 |
| `caution` | 要注意（軽度異常） |
| `abnormal` | 異常（要再検査） |

---

### 9-5. 病歴・服薬情報テーブル ❌ 完全に不足

#### 現状の問題
- 既往歴が記録できない
- 現在服用中の薬が管理できない
- アレルギー情報が記録できない
- 就労配慮に必要な医療情報が不足

#### 必要なテーブル: `MedicalHistories`（病歴）

```prisma
model MedicalHistory {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  diseaseCategory String   @map("disease_category")        // chronic, acute, past, family
  diseaseName     String   @map("disease_name")            // 疾患名
  diagnosisDate   DateTime? @map("diagnosis_date")          // 診断日
  isOngoing       Boolean  @default(false) @map("is_ongoing")  // 治療継続中
  treatmentStatus String?  @map("treatment_status")        // ongoing, completed, monitoring
  hospitalName    String?  @map("hospital_name")           // 受診医療機関
  doctorName      String?  @map("doctor_name")             // 主治医名

  // 就労への影響
  workImpact      String?  @map("work_impact")             // none, minor, moderate, significant
  requiredAccommodation String? @map("required_accommodation")  // 必要な配慮

  // メタデータ
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([diseaseCategory])
  @@index([isOngoing])
  @@map("medical_histories")
}
```

#### 必要なテーブル: `Medications`（服薬情報）

```prisma
model Medication {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  medicationName  String   @map("medication_name")         // 薬剤名
  medicationType  String   @map("medication_type")         // chronic, acute, supplement
  purpose         String?                                  // 服用目的・疾患名
  dosage          String?                                  // 用量
  frequency       String?                                  // 服用頻度（1日3回等）
  startDate       DateTime @map("start_date")
  endDate         DateTime? @map("end_date")
  isOngoing       Boolean  @default(true) @map("is_ongoing")
  prescribedBy    String?  @map("prescribed_by")           // 処方医

  // 就労への影響
  sideEffects     String?  @map("side_effects")            // 副作用
  workRestrictions String? @map("work_restrictions")       // 就労制限（運転禁止等）

  // メタデータ
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([isOngoing])
  @@map("medications")
}
```

#### 必要なテーブル: `Allergies`（アレルギー情報）

```prisma
model Allergy {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  allergyType     String   @map("allergy_type")            // food, drug, environmental, other
  allergen        String                                   // アレルゲン名
  severity        String                                   // mild, moderate, severe, life_threatening
  symptoms        String?                                  // 症状
  firstOccurrence DateTime? @map("first_occurrence")        // 初発時期
  lastReaction    DateTime? @map("last_reaction")           // 最終反応日
  treatment       String?                                  // 対処法（エピペン等）

  // 就労への影響
  workplaceRisk   String?  @map("workplace_risk")          // 職場での暴露リスク
  emergencyAction String?  @map("emergency_action")        // 緊急時対応

  // メタデータ
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([allergyType])
  @@index([severity])
  @@map("allergies")
}
```

#### 疾患カテゴリ（diseaseCategory）

| カテゴリ | 説明 |
|---------|------|
| `chronic` | 慢性疾患（高血圧、糖尿病等） |
| `acute` | 急性疾患（現在治療中） |
| `past` | 既往歴（完治済み） |
| `family` | 家族歴 |

#### アレルギータイプ（allergyType）

| タイプ | 説明 | 例 |
|--------|------|-----|
| `food` | 食物アレルギー | 小麦、卵、甲殻類等 |
| `drug` | 薬剤アレルギー | ペニシリン、造影剤等 |
| `environmental` | 環境アレルギー | 花粉、ハウスダスト等 |
| `latex` | ラテックスアレルギー | 医療用手袋等 |
| `other` | その他 | - |

---

### 10. 目標管理（MBO/OKR）テーブル ❌ 完全に不足

```prisma
model Goal {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  goalType        String   @map("goal_type")            // annual, quarterly, monthly
  title           String
  description     String?
  category        String                                // performance, skill, career
  priority        String   @default("medium")           // high, medium, low

  // 目標値
  currentValue    Float?   @map("current_value")        // 現在値
  targetValue     Float?   @map("target_value")         // 目標値
  targetDate      DateTime @map("target_date")

  // 進捗管理
  status          String   @default("in_progress")      // in_progress, achieved, not_achieved, cancelled
  progress        Int      @default(0)                  // 進捗率 0-100

  // 評価
  evaluatorId     String?  @map("evaluator_id")
  evaluationScore Float?   @map("evaluation_score")
  evaluationNotes String?  @map("evaluation_notes")

  // アクション項目（JSON配列）
  actions         Json?                                 // ["法人規模PJ参加", "イノベーション創出"]

  // メタデータ
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([priority])
  @@map("goals")
}
```

---

### 10-2. 能力評価スコアテーブル ❌ 完全に不足

#### 現状の問題
- 総合評価のみで、分野別スコアが記録できない
- 技術力、リーダーシップ、組織貢献等の詳細評価がない
- 経年変化の追跡ができない

#### 必要なテーブル: `CompetencyAssessments`（能力評価）

```prisma
model CompetencyAssessment {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  assessmentDate  DateTime @map("assessment_date")      // 評価日
  assessmentPeriod String  @map("assessment_period")    // 2024-H1、2024年度等

  // 総合評価
  overallGrade    String   @map("overall_grade")        // S, A, B, C, D
  overallScore    Float    @map("overall_score")        // 0-100点
  yearsOfService  Float?   @map("years_of_service")     // 勤続年数

  // 分野別スコア
  technicalSkillScore    Float?  @map("technical_skill_score")     // 技術力スコア
  technicalSkillTrend    Int?    @map("technical_skill_trend")     // 前回比（±点数）
  leadershipScore        Float?  @map("leadership_score")          // リーダーシップスコア
  leadershipTrend        Int?    @map("leadership_trend")          // 前回比
  organizationScore      Float?  @map("organization_score")        // 組織貢献スコア
  organizationTrend      Int?    @map("organization_trend")        // 前回比
  communicationScore     Float?  @map("communication_score")       // コミュニケーションスコア
  communicationTrend     Int?    @map("communication_trend")       // 前回比
  problemSolvingScore    Float?  @map("problem_solving_score")     // 問題解決スコア
  problemSolvingTrend    Int?    @map("problem_solving_trend")     // 前回比

  // 評価コメント
  technicalComments      String? @map("technical_comments")
  leadershipComments     String? @map("leadership_comments")
  organizationComments   String? @map("organization_comments")

  // 評価者情報
  evaluatorId     String?  @map("evaluator_id")
  evaluatorComment String? @map("evaluator_comment")

  // メタデータ
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([assessmentDate(sort: Desc)])
  @@index([overallGrade])
  @@map("competency_assessments")
}
```

#### グレード基準

| グレード | スコア範囲 | 評価 |
|---------|-----------|------|
| S | 95-100点 | 卓越 |
| A | 85-94点 | 優秀 |
| B | 70-84点 | 良好 |
| C | 60-69点 | 標準 |
| D | 0-59点 | 要改善 |

---

### 10-3. V3評価推移テーブル ❌ 完全に不足（🆕 大幅拡張）

#### 現状の問題
- V3評価制度の詳細記録がない（技術評価50点・組織貢献度50点の内訳）
- レーダーチャート用の評価項目別スコアが不足
- 施設内・法人内の順位情報が記録できない
- 夏季・冬季評価の統合管理ができない
- AI指導支援アドバイス用フィールドがない

#### 必要なテーブル: `V3Assessments`（V3評価 - 完全版）

```prisma
model V3Assessment {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  fiscalYear      Int      @map("fiscal_year")           // 評価年度
  assessmentDate  DateTime @map("assessment_date")

  // 🆕 評価期間・確定情報
  evaluationPeriodStart DateTime? @map("evaluation_period_start")  // 2023-04-01
  evaluationPeriodEnd   DateTime? @map("evaluation_period_end")    // 2024-03-31
  confirmedDate         DateTime? @map("confirmed_date")           // 評価確定日
  experienceLevel       String?   @map("experience_level")
  // "new": 新人, "second_year": 2年目, "mid_career": 中堅, "veteran": ベテラン

  // V3評価結果（総合）
  v3Grade         String   @map("v3_grade")              // C, B-, B, B+, A-, A, A+, S (7段階)
  v3Score         Float    @map("v3_score")              // 0-100点（例: 81.25点）
  v3Points        Int      @map("v3_points")             // 獲得ポイント（3-12pt）

  // 成長指標
  growthRate      Float?   @map("growth_rate")           // 成長率（%）
  previousScore   Float?   @map("previous_score")        // 前年スコア
  scoreDifference Float?   @map("score_difference")      // スコア差分

  // ========================================
  // 🆕 技術評価詳細（50点満点）
  // ========================================
  technicalTotal        Float     @map("technical_total")         // 合計（例: 40.0点）
  technicalPercentage   Float     @map("technical_percentage")    // 達成率（例: 80.0%）

  // 法人統一項目（30点満点）
  commonC01Score        Float?    @map("common_c01_score")        // C01: 専門技術・スキル（10点満点）
  commonC01SupervisorScore Float? @map("common_c01_supervisor_score") // 上司評価分
  commonC01SelfScore    Float?    @map("common_c01_self_score")   // 本人評価分

  commonC02Score        Float?    @map("common_c02_score")        // C02: 対人関係・ケア（10点満点）
  commonC02SupervisorScore Float? @map("common_c02_supervisor_score")
  commonC02SelfScore    Float?    @map("common_c02_self_score")

  commonC03Score        Float?    @map("common_c03_score")        // C03: 安全・品質管理（10点満点）
  commonC03SupervisorScore Float? @map("common_c03_supervisor_score")
  commonC03SelfScore    Float?    @map("common_c03_self_score")

  // 施設特化項目（20点満点）
  facilityF01Score      Float?    @map("facility_f01_score")      // F01: 施設専門性（10点満点）
  facilityF01Name       String?   @map("facility_f01_name")       // 項目名（例: 回復期リハビリテーション専門性）
  facilityF02Score      Float?    @map("facility_f02_score")      // F02: 多職種連携・チームケア（10点満点）
  facilityF02Name       String?   @map("facility_f02_name")

  // ========================================
  // 🆕 組織貢献度評価詳細（50点満点）
  // ========================================
  contributionTotal     Float     @map("contribution_total")      // 合計（例: 41.3点）
  contributionPercentage Float    @map("contribution_percentage") // 達成率（例: 82.6%）

  // 施設内貢献度（25点満点）
  facilitySummerScore   Float?    @map("facility_summer_score")   // 夏季評価（12.5点満点）
  facilitySummerGrade   String?   @map("facility_summer_grade")   // A, B, C, D, E (5段階)
  facilityWinterScore   Float?    @map("facility_winter_score")   // 冬季評価（12.5点満点）
  facilityWinterGrade   String?   @map("facility_winter_grade")

  // 法人内貢献度（25点満点）
  corporateSummerScore  Float?    @map("corporate_summer_score")  // 夏季評価（12.5点満点）
  corporateSummerGrade  String?   @map("corporate_summer_grade")  // A, B, C, D, E (5段階)
  corporateWinterScore  Float?    @map("corporate_winter_score")  // 冬季評価（12.5点満点）
  corporateWinterGrade  String?   @map("corporate_winter_grade")

  // ========================================
  // 🆕 順位・パーセンタイル情報
  // ========================================
  facilityRank          Int?      @map("facility_rank")           // 施設内順位（例: 12位）
  facilityTotalCount    Int?      @map("facility_total_count")    // 施設総人数（例: 120人）
  facilityPercentile    Float?    @map("facility_percentile")     // 上位○%（例: 10%）
  facilityGrade         String?   @map("facility_grade")          // 施設内総合評価（A, B, C等）

  corporateRank         Int?      @map("corporate_rank")          // 法人内順位（例: 89位）
  corporateTotalCount   Int?      @map("corporate_total_count")   // 法人総人数（例: 850人）
  corporatePercentile   Float?    @map("corporate_percentile")    // 上位○%（例: 11%）
  corporateGrade        String?   @map("corporate_grade")         // 法人内総合評価

  // ========================================
  // 🆕 レーダーチャート比較データ（JSON）
  // ========================================
  radarChartData        Json?     @map("radar_chart_data")
  // 構造例:
  // {
  //   "technical": {
  //     "c01": { "self": 8.2, "average": 7.0, "target": 9.0 },
  //     "c02": { "self": 8.5, "average": 7.5, "target": 8.5 },
  //     "c03": { "self": 7.3, "average": 7.0, "target": 9.0 },
  //     "f01": { "self": 8.0, "average": 7.5, "target": 9.5 },
  //     "f02": { "self": 8.0, "average": 7.2, "target": 9.0 }
  //   },
  //   "contribution": {
  //     "facility_summer": { "self": 10.3, "average": 9.5, "target": 11.0 },
  //     "facility_winter": { "self": 11.2, "average": 9.5, "target": 11.0 },
  //     "corporate_summer": { "self": 10.0, "average": 9.0, "target": 11.0 },
  //     "corporate_winter": { "self": 10.0, "average": 9.0, "target": 11.0 }
  //   }
  // }

  // ========================================
  // 🆕 AI指導支援アドバイス（将来機能: ローカルLLM統合）
  // ========================================
  aiAnalysisStrengths   String?   @db.Text @map("ai_analysis_strengths")
  // 優秀な領域の解釈（例: 対人関係・ケア能力が施設平均を大幅に上回る）

  aiAnalysisWeaknesses  String?   @db.Text @map("ai_analysis_weaknesses")
  // 重点改善領域（例: 安全・品質管理の向上が優先課題）

  aiGrowthPattern       String?   @db.Text @map("ai_growth_pattern")
  // 成長パターン分析（例: 冬季の施設貢献が夏季を上回る良好な成長パターン）

  aiNextGoals           String?   @db.Text @map("ai_next_goals")
  // 次期目標提案（例: Sグレード到達に向け施設横断プロジェクト参加推奨）

  aiShortTermActions    Json?     @map("ai_short_term_actions")
  // 短期アクション配列（1-3ヶ月）
  // ["安全管理研修の優先受講", "インシデント予防チェックリスト活用"]

  aiLongTermGoals       Json?     @map("ai_long_term_goals")
  // 中長期目標配列（3-12ヶ月）
  // ["新人指導メンター役の任命", "法人内事例発表会での講師役"]

  aiAnalysisDate        DateTime? @map("ai_analysis_date")
  // AI分析実施日

  // ========================================
  // 既存フィールド（統合）
  // ========================================
  performanceScore Float?  @map("performance_score")     // 業績評価
  behaviorScore    Float?  @map("behavior_score")        // 行動評価
  potentialScore   Float?  @map("potential_score")       // ポテンシャル評価

  improvementAreas Json?   @map("improvement_areas")     // 改善領域配列
  strengths        Json?   @map("strengths")             // 強み配列

  // メタデータ
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])
  comments V3AssessmentComment[]  // 🆕 評価コメント（1:N）

  @@unique([employeeId, fiscalYear])
  @@index([employeeId])
  @@index([fiscalYear(sort: Desc)])
  @@index([v3Grade])
  @@index([facilityRank])
  @@index([corporateRank])
  @@map("v3_assessments")
}
```

#### 🆕 V3評価コメントテーブル（新規）

V3評価には複数の評価者（直属上司、部門長、人事部等）からのコメントが付きます。

```prisma
model V3AssessmentComment {
  id              String   @id @default(cuid())
  v3AssessmentId  String   @map("v3_assessment_id")
  evaluatorId     String   @map("evaluator_id")         // 評価者のEmployeeID
  evaluatorRole   String   @map("evaluator_role")
  // "direct_supervisor": 直属上司
  // "department_head": 部門長
  // "hr_manager": 人事部
  // "facility_director": 施設長

  commentDate     DateTime @map("comment_date")         // コメント日付
  commentText     String   @db.Text                     // 評価コメント本文

  // メタデータ
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  v3Assessment    V3Assessment @relation(fields: [v3AssessmentId], references: [id], onDelete: Cascade)
  evaluator       Employee     @relation("V3Evaluator", fields: [evaluatorId], references: [id])

  @@index([v3AssessmentId])
  @@index([evaluatorId])
  @@map("v3_assessment_comments")
}
```

#### V3評価コメント例

```json
{
  "evaluatorRole": "direct_supervisor",
  "commentDate": "2025-01-15",
  "commentText": "V3評価システムにおいて優れた業務遂行力とチーム協調性を発揮。技術評価80点、組織貢献度81.5点という安定した成果を評価します。次期主任候補として期待しています。"
}
```

#### V3グレード定義

| グレード | スコア範囲 | ポイント | 説明 |
|---------|-----------|---------|------|
| S | 95-100 | 12pt | 卓越した成果 |
| A+ | 92-94 | 10pt | 期待を大きく上回る |
| A | 88-91 | 9pt | 期待を上回る |
| A- | 85-87 | 8pt | 期待通り（上位） |
| B+ | 82-84 | 7pt | 期待通り（中上位） |
| B | 78-81 | 6pt | 期待通り |
| B- | 70-77 | 5pt | 期待通り（下位） |
| C | 0-69 | 3pt | 要改善 |

---

### 10-4. メンタリング関係テーブル ❌ 完全に不足

#### 現状の問題
- メンター・メンティーの関係が記録できない
- 指導計画・進捗が管理できない
- メンタリング活動の評価ができない

#### 必要なテーブル: `MentoringRelationships`（メンタリング関係）

```prisma
model MentoringRelationship {
  id              String   @id @default(cuid())
  mentorId        String   @map("mentor_id")             // メンター（指導者）
  menteeId        String   @map("mentee_id")             // メンティー（被指導者）
  relationshipType String  @map("relationship_type")     // formal, informal, peer
  startDate       DateTime @map("start_date")
  endDate         DateTime? @map("end_date")
  status          String   @default("active")            // active, completed, suspended

  // 指導計画
  mentoringGoals  Json?    @map("mentoring_goals")       // 指導目標配列
  meetingFrequency String? @map("meeting_frequency")     // weekly, biweekly, monthly
  plannedSessions Int?     @default(0) @map("planned_sessions")
  completedSessions Int?   @default(0) @map("completed_sessions")

  // 進捗管理
  progress        Int      @default(0)                   // 進捗率 0-100
  milestones      Json?                                  // マイルストーン達成状況

  // 評価
  mentorFeedback  String?  @map("mentor_feedback")       // メンターからのフィードバック
  menteeFeedback  String?  @map("mentee_feedback")       // メンティーからのフィードバック
  overallRating   Float?   @map("overall_rating")        // 総合評価（1-5）

  // メタデータ
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  mentor Employee @relation("MentorRelations", fields: [mentorId], references: [id])
  mentee Employee @relation("MenteeRelations", fields: [menteeId], references: [id])

  @@index([mentorId])
  @@index([menteeId])
  @@index([status])
  @@map("mentoring_relationships")
}
```

#### 関係タイプ（relationshipType）

| タイプ | 説明 |
|--------|------|
| `formal` | 公式メンタリング（会社が設定） |
| `informal` | 非公式メンタリング（自発的） |
| `peer` | ピアメンタリング（同僚間） |
| `reverse` | リバースメンタリング（若手→ベテラン） |

---

### 11. キャリアパス・育成計画テーブル ⚠️ 部分的に不足

現在は面談記録の`developmentPlan`フィールドのみ。体系的な管理が必要。

```prisma
model DevelopmentPlan {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  planType        String   @map("plan_type")            // short_term, mid_term, long_term
  targetPosition  String?  @map("target_position")      // 目標役職（シニア、主任候補等）
  targetLevel     String?  @map("target_level")         // 目標レベル
  targetSkills    Json?    @map("target_skills")        // 習得目標スキル
  planStartDate   DateTime @map("plan_start_date")
  planEndDate     DateTime @map("plan_end_date")

  // 期限管理
  durationMonths  Int?     @map("duration_months")      // 期間（月数）18ヶ月等

  milestones      Json?                                 // マイルストーン
  status          String   @default("active")           // active, achieved, cancelled
  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("development_plans")
}
```

### 11. キャリアコース選択制度テーブル ⚠️ 設計済みだがschema.prisma未反映

#### 現状の問題
- **Phase5実装計画書には詳細設計あり**
- **schema.prismaには未実装**
- APIコードにはTODOコメントで保留中

#### 必要なテーブル群（Phase5設計より）

**1. course_definitions（コース定義マスタ）**
```prisma
model CourseDefinition {
  id                        String   @id @default(cuid())
  courseCode                String   @unique @map("course_code")       // A, B, C, D
  courseName                String   @map("course_name")               // Aコース（総合職）等
  description               String?                                    // 説明
  departmentTransferAvailable Boolean @map("department_transfer_available")  // 部署異動可否
  facilityTransferAvailable String   @map("facility_transfer_available")    // none/limited/full
  relocationRequired        Boolean  @map("relocation_required")       // 転居必要性
  nightShiftAvailable       String   @map("night_shift_available")     // none/selectable/required
  managementTrack           Boolean  @map("management_track")          // 管理職候補
  baseSalaryMultiplier      Decimal  @map("base_salary_multiplier") @db.Decimal(3, 2)  // 給与係数
  isActive                  Boolean  @default(true) @map("is_active")
  displayOrder              Int      @default(0) @map("display_order")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  // Relations
  staffCourses              StaffCareerCourse[]
  changeRequestsCurrent     CareerCourseChangeRequest[] @relation("CurrentCourse")
  changeRequestsRequested   CareerCourseChangeRequest[] @relation("RequestedCourse")
  transferRulesFrom         CourseTransferRule[] @relation("FromCourse")
  transferRulesTo           CourseTransferRule[] @relation("ToCourse")

  @@map("course_definitions")
}
```

**2. staff_career_courses（職員コース情報）**
```prisma
model StaffCareerCourse {
  id                      String   @id @default(cuid())
  staffId                 String   @map("staff_id")
  courseCode              String   @map("course_code")
  effectiveFrom           DateTime @map("effective_from") @db.Date      // 適用開始日
  effectiveTo             DateTime? @map("effective_to") @db.Date       // 適用終了日（現在有効=NULL）
  nextChangeAvailableDate DateTime @map("next_change_available_date") @db.Date  // 次回変更可能日（年1回制限）
  specialChangeReason     String?  @map("special_change_reason")       // 特例事由
  approvedBy              String?  @map("approved_by")
  approvalStatus          String   @default("approved") @map("approval_status")  // approved, pending
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  employee        Employee         @relation(fields: [staffId], references: [id])
  courseDefinition CourseDefinition @relation(fields: [courseCode], references: [courseCode])

  @@index([staffId])
  @@index([courseCode])
  @@index([effectiveTo])  // 現在有効なコース検索用
  @@map("staff_career_courses")
}
```

**3. career_course_change_requests（コース変更申請）**
```prisma
model CareerCourseChangeRequest {
  id                      String   @id @default(cuid())
  staffId                 String   @map("staff_id")
  currentCourseCode       String   @map("current_course_code")
  requestedCourseCode     String   @map("requested_course_code")
  changeReason            String   @map("change_reason")             // life_event, career_change, special_nursing, special_caregiving
  reasonDetail            String?  @map("reason_detail")
  requestedEffectiveDate  DateTime @map("requested_effective_date") @db.Date
  attachments             Json?                                      // ファイルパス配列
  approvalStatus          String   @default("pending") @map("approval_status")  // pending, approved, rejected
  approvedBy              String?  @map("approved_by")
  approvedAt              DateTime? @map("approved_at")
  approvalComment         String?  @map("approval_comment")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  employee          Employee         @relation(fields: [staffId], references: [id])
  currentCourse     CourseDefinition @relation("CurrentCourse", fields: [currentCourseCode], references: [courseCode])
  requestedCourse   CourseDefinition @relation("RequestedCourse", fields: [requestedCourseCode], references: [courseCode])

  @@index([staffId])
  @@index([approvalStatus])
  @@index([createdAt(sort: Desc)])
  @@map("career_course_change_requests")
}
```

**4. course_transfer_rules（コース転換ルール）**
```prisma
model CourseTransferRule {
  id                   String   @id @default(cuid())
  fromCourseCode       String   @map("from_course_code")
  toCourseCode         String   @map("to_course_code")
  isAllowed            Boolean  @map("is_allowed")
  requiresApproval     Boolean  @default(true) @map("requires_approval")
  requiresReason       Boolean  @default(true) @map("requires_reason")
  minimumServiceYears  Decimal? @map("minimum_service_years") @db.Decimal(4, 1)
  notes                String?
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  fromCourse CourseDefinition @relation("FromCourse", fields: [fromCourseCode], references: [courseCode])
  toCourse   CourseDefinition @relation("ToCourse", fields: [toCourseCode], references: [courseCode])

  @@unique([fromCourseCode, toCourseCode])
  @@map("course_transfer_rules")
}
```

#### 影響範囲
- 🔴 職員カルテ個人ページ > キャリア選択コースタブ
- 🔴 マイページ > キャリアコース変更申請
- 🔴 管理画面 > コース変更申請承認

#### 対応方法
Phase5実装計画書の設計をschema.prismaに反映し、MySQL構築時に含める

---

### 12. 実績・成果管理テーブル ❌ 完全に不足

#### 現状の問題
- 表彰以外の実績（リーダーシップ、プロジェクト参加、研究発表等）が記録できない
- staffData.jsにはハードコードされているが、DBテーブルがない

#### 必要なテーブル: `Achievements`（実績・成果）

```prisma
model Achievement {
  id              String   @id @default(cuid())
  employeeId      String   @map("employee_id")
  achievementDate DateTime @map("achievement_date")    // 実績日
  achievementType String   @map("achievement_type")    // leadership, project, research, innovation, committee, other
  title           String                               // タイトル（例: 新人指導担当、病棟改善プロジェクト参加）
  description     String?                              // 詳細説明
  category        String?                              // カテゴリ（自由記述）
  impact          String?                              // 影響・成果
  recognizedBy    String?  @map("recognized_by")       // 認定者ID
  isPublic        Boolean  @default(true) @map("is_public")  // 公開設定
  attachmentPath  String?  @map("attachment_path")     // 関連資料ファイルパス
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([achievementDate(sort: Desc)])
  @@index([achievementType])
  @@map("achievements")
}
```

#### 対象となる実績の例
- **leadership**: 新人指導担当、チームリーダー経験
- **project**: 病棟改善プロジェクト、業務効率化プロジェクト
- **research**: 看護研究発表、学会発表
- **innovation**: 業務改善提案、新しい取り組みの実施
- **committee**: 委員会活動（感染対策委員会等）
- **other**: その他の実績

#### Awardテーブルとの使い分け
- **Award**: 正式な表彰・受賞（表彰状あり、賞金あり）
- **Achievement**: 日常的な実績・成果（表彰にならないが記録すべき貢献）

#### 🆕 業務実績・組織貢献度の記録

Achievementテーブルでプロジェクト参加歴は記録できますが、**数値指標ベースの業務実績**と**組織貢献度スコア**は別途管理が必要です。

---

### 12-2. 業務実績指標テーブル ❌ 完全に不足

#### 現状の問題
- 患者満足度、業務効率、品質指標などの数値実績が記録できない
- 実績の継続性（3年連続達成等）が追跡できない
- VoiceDriveシステムとの連携（プロジェクト化モード）を見据えた設計が必要

#### 必要なテーブル: `PerformanceMetrics`（業務実績指標）

```prisma
model PerformanceMetric {
  id                  String   @id @default(cuid())
  employeeId          String   @map("employee_id")
  metricType          String   @map("metric_type")             // patient_satisfaction, quality, efficiency, safety
  metricName          String   @map("metric_name")             // 指標名（患者満足度、業務効率等）
  period              String                                   // 期間（2024-Q1、2024年度等）
  targetValue         Float?   @map("target_value")            // 目標値
  actualValue         Float    @map("actual_value")            // 実績値
  unit                String                                   // 単位（%、件、時間等）
  achievementRate     Float?   @map("achievement_rate")        // 達成率（%）
  consecutiveYears    Int?     @default(0) @map("consecutive_years")  // 連続達成年数

  // VoiceDrive連携（将来的なプロジェクト化モード対応）
  relatedProjectId    String?  @map("related_project_id")      // 関連プロジェクトID（VoiceDrive側のプロジェクトID）
  voiceDriveSyncStatus String? @default("not_synced") @map("voicedrive_sync_status")  // not_synced, synced, pending

  // メタデータ
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([metricType])
  @@index([period(sort: Desc)])
  @@map("performance_metrics")
}
```

#### 指標タイプ（metricType）定義

| タイプ | 説明 | 例 |
|--------|------|-----|
| `patient_satisfaction` | 患者満足度 | 95%以上を3年連続達成 |
| `quality` | 品質指標 | インシデント発生率、医療安全スコア |
| `efficiency` | 業務効率 | 処理時間短縮率、残業時間削減率 |
| `safety` | 安全指標 | 感染率、転倒転落件数 |
| `education` | 教育実績 | 新人育成成功率、研修実施回数 |
| `project` | プロジェクト成果 | プロジェクト完了率、目標達成率 |

---

### 12-3. 組織貢献度スコアテーブル ❌ 完全に不足

#### 現状の問題
- 組織への貢献度を総合的に評価・数値化できない
- 貢献度の時系列変化が追跡できない

#### 必要なテーブル: `OrganizationContributionScores`（組織貢献度スコア）

```prisma
model OrganizationContributionScore {
  id                      String   @id @default(cuid())
  employeeId              String   @map("employee_id")
  evaluationPeriod        String   @map("evaluation_period")       // 評価期間（2024-H1、2024年度等）

  // 総合スコア
  overallScore            Float    @map("overall_score")           // 総合貢献度スコア（0-100）

  // 分野別スコア
  performanceScore        Float?   @map("performance_score")       // 業務実績スコア
  innovationScore         Float?   @map("innovation_score")        // イノベーション・改善提案スコア
  teamworkScore           Float?   @map("teamwork_score")          // チームワーク・協働スコア
  leadershipScore         Float?   @map("leadership_score")        // リーダーシップスコア
  educationScore          Float?   @map("education_score")         // 教育・育成スコア
  projectScore            Float?   @map("project_score")           // プロジェクト貢献スコア

  // 算出根拠
  calculationMethod       String?  @map("calculation_method")      // 算出方法（自動計算/手動評価/混合）
  calculationDetails      Json?    @map("calculation_details")     // 算出詳細（各要素の内訳）

  // VoiceDrive連携
  voiceDriveActivityScore Float?   @map("voicedrive_activity_score")  // VoiceDrive活動スコア
  voiceDriveProjectCount  Int?     @default(0) @map("voicedrive_project_count")  // 参加プロジェクト数

  // 評価者情報
  evaluatorId             String?  @map("evaluator_id")
  evaluatorComment        String?  @map("evaluator_comment")

  // メタデータ
  status                  String   @default("draft") @map("status")  // draft, finalized
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, evaluationPeriod])
  @@index([employeeId])
  @@index([evaluationPeriod(sort: Desc)])
  @@index([overallScore(sort: Desc)])
  @@map("organization_contribution_scores")
}
```

#### スコア算出方法の例

```json
{
  "calculationMethod": "weighted_average",
  "weights": {
    "performance": 0.30,
    "innovation": 0.15,
    "teamwork": 0.20,
    "leadership": 0.15,
    "education": 0.10,
    "project": 0.10
  },
  "rawScores": {
    "performance": 92,
    "innovation": 85,
    "teamwork": 88,
    "leadership": 80,
    "education": 90,
    "project": 87
  },
  "overallScore": 88
}
```

---

### 12-4. プロジェクト参加履歴テーブル ❌ 完全に不足

#### 現状の問題
- Achievementテーブルでも記録可能だが、プロジェクト専用の管理が望ましい
- VoiceDriveのプロジェクト化モードとの連携を見据えた設計が必要
- プロジェクト内での役割・貢献度が明確に記録できない

#### 必要なテーブル: `ProjectParticipations`（プロジェクト参加履歴）

```prisma
model ProjectParticipation {
  id                  String   @id @default(cuid())
  employeeId          String   @map("employee_id")
  projectName         String   @map("project_name")            // プロジェクト名
  projectType         String   @map("project_type")            // system, improvement, research, education, facility
  role                String                                   // leader, member, supporter, advisor
  startDate           DateTime @map("start_date")
  endDate             DateTime? @map("end_date")
  status              String   @default("in_progress") @map("status")  // in_progress, completed, on_hold, cancelled

  // 貢献度・成果
  contributionLevel   String?  @map("contribution_level")      // high, medium, low
  achievements        String?                                  // プロジェクト内での成果
  skillsGained        Json?    @map("skills_gained")           // 習得スキル配列

  // VoiceDrive連携（プロジェクト化モード対応）
  voiceDriveProjectId String?  @map("voicedrive_project_id")   // VoiceDrive側のプロジェクトID
  isSyncedWithVoiceDrive Boolean @default(false) @map("is_synced_with_voicedrive")
  voiceDriveTaskCount Int?     @default(0) @map("voicedrive_task_count")  // VoiceDrive上のタスク数
  voiceDriveCompletionRate Float? @map("voicedrive_completion_rate")      // VoiceDrive上の完了率

  // メタデータ
  department          String?                                  // 主管部署
  budget              Decimal? @db.Decimal(12, 2)             // プロジェクト予算
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([projectType])
  @@index([status])
  @@index([startDate(sort: Desc)])
  @@index([voiceDriveProjectId])
  @@map("project_participations")
}
```

#### プロジェクトタイプ（projectType）定義

| タイプ | 説明 | 例 |
|--------|------|-----|
| `system` | システム導入・刷新 | 電子カルテ導入プロジェクト |
| `improvement` | 業務改善・効率化 | 患者満足度向上委員会 |
| `research` | 研究・調査 | 看護研究プロジェクト |
| `education` | 教育・育成 | 新人教育プログラム開発 |
| `facility` | 施設・設備 | 病棟リニューアルプロジェクト |
| `quality` | 品質向上 | 医療安全推進プロジェクト |

#### VoiceDrive連携の想定

将来的にVoiceDriveの「プロジェクト化モード」が軌道に乗った際：
- VoiceDrive上のプロジェクトと医療システムのプロジェクト参加履歴を連携
- タスク完了率、アイデア投稿数などをリアルタイム同期
- 組織貢献度スコアの自動算出に活用

---

### 13. クリニカルラダー評価テーブル ❌ 完全に不足

#### 現状の問題
- 看護協会のクリニカルラダーレベルが記録できない
- スキル別の習熟度（%）が記録できない
- 院内認定・専門資格の管理が不十分

#### 必要なテーブル: `ClinicalLadderAssessments`（クリニカルラダー評価）

```prisma
model ClinicalLadderAssessment {
  id                      String   @id @default(cuid())
  employeeId              String   @map("employee_id")
  assessmentDate          DateTime @map("assessment_date")            // 評価日
  jobCategory             String   @map("job_category")               // nurse, care_worker, therapist等

  // クリニカルラダーレベル（看護協会版準拠）
  overallLadderLevel      String?  @map("overall_ladder_level")       // beginner, level1, level2, level3, level4

  // 4つの能力軸別評価（看護協会版）
  needsIdentificationLevel String? @map("needs_identification_level") // ニーズをとらえる力
  careProvidingLevel      String?  @map("care_providing_level")       // ケアする力
  collaborationLevel      String?  @map("collaboration_level")        // 協働する力
  decisionSupportLevel    String?  @map("decision_support_level")     // 意思決定を支える力

  // スキル別習熟度（0-100%）
  nursingSkillProficiency    Float?   @map("nursing_skill_proficiency") @db.Decimal(5, 2)     // 看護技術
  infectionControlProficiency Float?  @map("infection_control_proficiency") @db.Decimal(5, 2) // 感染管理
  educationGuidanceProficiency Float? @map("education_guidance_proficiency") @db.Decimal(5, 2) // 教育指導
  emergencyCareProficiency   Float?   @map("emergency_care_proficiency") @db.Decimal(5, 2)    // 救急対応
  specializedCareProficiency Float?   @map("specialized_care_proficiency") @db.Decimal(5, 2)  // 専門ケア

  // 院内認定・資格
  inHouseCertifications   Json?    @map("in_house_certifications")    // 院内認定配列（感染管理認定、プリセプター等）
  externalCertifications  Json?    @map("external_certifications")    // 外部資格配列（認定看護師等）

  // 評価者情報
  assessorId              String?  @map("assessor_id")                // 評価者ID
  assessorComment         String?  @map("assessor_comment")           // 評価コメント
  nextGoal                String?  @map("next_goal")                  // 次の目標
  nextAssessmentDate      DateTime? @map("next_assessment_date")      // 次回評価予定日

  // メタデータ
  status                  String   @default("active") @map("status")  // active, archived
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, assessmentDate(sort: Desc)])
  @@index([jobCategory])
  @@index([overallLadderLevel])
  @@map("clinical_ladder_assessments")
}
```

#### レベル定義（日本看護協会版準拠）

**overallLadderLevel値**:
- `beginner`: 新人（基本的ケア、助言を得て実践）
- `level1`: レベルⅠ（一般的な看護計画に基づき自立実践）
- `level2`: レベルⅡ（個別的な看護を実践）
- `level3`: レベルⅢ（幅広い視野で予測的判断）
- `level4`: レベルⅣ（複雑な状況でQOLを高める看護）

**4つの能力軸も同じレベル体系**:
- ニーズをとらえる力（needsIdentificationLevel）
- ケアする力（careProvidingLevel）
- 協働する力（collaborationLevel）
- 意思決定を支える力（decisionSupportLevel）

#### 院内認定・外部資格のJSON例

```json
// inHouseCertifications
[
  {
    "name": "院内感染管理認定",
    "certifiedDate": "2023-04-01",
    "expiryDate": "2026-03-31",
    "renewalCycle": 3
  },
  {
    "name": "プリセプター認定",
    "certifiedDate": "2022-10-01",
    "expiryDate": null,
    "renewalCycle": null
  }
]

// externalCertifications
[
  {
    "name": "感染管理認定看護師",
    "organization": "日本看護協会",
    "certifiedDate": "2021-06-01",
    "expiryDate": "2026-05-31"
  }
]
```

#### 影響範囲
- 🔴 職員カルテ個人ページ > 資格・専門性タブ > スキル評価・クリニカルラダーセクション
- 🔴 看護部教育計画（ラダー別研修計画）
- 🔴 人材育成・配置最適化

#### 使い分け
- **ClinicalLadderAssessment**: 定期的な総合評価（年2回等）
- **EmployeeSkill**: 日常的なスキル管理（個別スキル単位）
- **Certification**: 公的資格・免許

---

### 14. 学会・職能団体加入情報テーブル ❌ 完全に不足

#### 現状の問題
- 学会・職能団体への加入情報が記録できない
- 加入日・退会日が管理できない
- 会費支払い状況が追跡できない

#### 必要なテーブル: `ProfessionalAssociations`（学会・職能団体加入情報）

```prisma
model ProfessionalAssociation {
  id                  String   @id @default(cuid())
  employeeId          String   @map("employee_id")
  associationType     String   @map("association_type")        // nursing_association, academic_society, professional_body
  associationName     String   @map("association_name")        // 団体名（日本看護協会、日本感染管理学会等）
  membershipNumber    String?  @map("membership_number")       // 会員番号
  joinDate            DateTime @map("join_date") @db.Date      // 加入日
  withdrawalDate      DateTime? @map("withdrawal_date") @db.Date // 退会日
  status              String   @default("active") @map("status") // active, withdrawn, suspended

  // 会費関連
  annualFee           Decimal? @map("annual_fee") @db.Decimal(10, 2)  // 年会費
  feePaymentMethod    String?  @map("fee_payment_method")      // company_paid, self_paid, partial
  companySupport      Boolean  @default(false) @map("company_support")  // 法人補助あり

  // 役職・役割
  role                String?                                  // member, committee_member, officer, director
  committeeNames      Json?    @map("committee_names")         // 所属委員会リスト

  // メタデータ
  notes               String?                                  // 備考（推薦者、加入理由等）
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([associationType])
  @@index([status])
  @@index([joinDate(sort: Desc)])
  @@map("professional_associations")
}
```

#### 団体タイプ（associationType）定義

| タイプ | 説明 | 例 |
|--------|------|-----|
| `nursing_association` | 看護職能団体 | 日本看護協会、都道府県看護協会 |
| `academic_society` | 学術学会 | 日本感染管理学会、日本看護科学学会 |
| `professional_body` | 専門職団体 | 日本介護福祉士会、日本理学療法士協会 |
| `specialty_society` | 専門領域学会 | 日本救急看護学会、日本老年看護学会 |

#### ステータス（status）定義

| ステータス | 説明 |
|-----------|------|
| `active` | 在籍中 |
| `withdrawn` | 退会済み |
| `suspended` | 一時停止（休会） |

#### 会費支払い方法（feePaymentMethod）

| 方法 | 説明 |
|------|------|
| `company_paid` | 法人全額負担 |
| `self_paid` | 自己負担 |
| `partial` | 法人一部補助 |

#### 役職・役割（role）

| 役職 | 説明 |
|------|------|
| `member` | 一般会員 |
| `committee_member` | 委員会委員 |
| `officer` | 役員 |
| `director` | 理事 |

#### 影響範囲
- 🔴 職員カルテ個人ページ > 資格・専門性タブ > 学会・職能団体セクション
- 🔴 法人補助対象者リスト
- 🔴 学会参加・研究活動の活性度分析

#### メリット
- 専門性の継続的な向上を促進
- 学会活動への参加状況を可視化
- 法人の研究・教育活動への貢献度を測定

---

### 15. 職員マインド・志向性プロファイルテーブル ❌ 完全に不足

#### 現状の問題
- キャリア志向、ワークスタイル、組織貢献意欲等が記録できない
- staffData.jsにはハードコードされているが、DBテーブルがない
- 動機タイプ以外の志向性情報が管理できない

#### 必要なテーブル: `StaffMindsetProfiles`（職員マインド・志向性プロファイル）

```prisma
model StaffMindsetProfile {
  id                      String   @id @default(cuid())
  employeeId              String   @unique @map("employee_id")  // 1職員1プロファイル

  // キャリア志向
  careerOrientationType   String?  @map("career_orientation_type")     // balance, specialist, generalist, leader
  careerVision            String?  @map("career_vision")                // キャリアビジョン（自由記述）
  desiredGrowthAreas      Json?    @map("desired_growth_areas")         // 希望する成長分野（タグ配列）

  // ワークスタイル
  workStyle               String?  @map("work_style")                   // team_oriented, individual, flexible
  workStyleDescription    String?  @map("work_style_description")       // ワークスタイル説明

  // 仕事への向き合い方
  coreValues              Json?    @map("core_values")                  // 重視する価値観（タグ配列）
  motivationSources       Json?    @map("motivation_sources")           // モチベーション源（タグ配列）
  strengths               Json?    @map("strengths")                    // 強み（配列）
  areasForImprovement     Json?    @map("areas_for_improvement")        // 改善したい領域（配列）

  // 働き方の希望
  preferredWorkingHours   String?  @map("preferred_working_hours")      // full_time, part_time, flexible
  nightShiftPreference    String?  @map("night_shift_preference")       // possible, selectable, not_possible
  workLifeBalancePriority String?  @map("work_life_balance_priority")   // high, medium, low
  transferWillingness     String?  @map("transfer_willingness")         // willing, negotiable, not_willing
  preferredDepartments    Json?    @map("preferred_departments")        // 希望部署（配列）

  // 組織への貢献意欲
  organizationCommitment  String?  @map("organization_commitment")      // high, medium, low
  mentorWillingness       String?  @map("mentor_willingness")           // high, medium, low, none
  projectParticipation    String?  @map("project_participation")        // active, selective, limited
  improvementProposal     String?  @map("improvement_proposal")         // frequent, sometimes, rarely
  leadershipAspiration    Boolean? @default(false) @map("leadership_aspiration")  // リーダーシップ志向

  // メタデータ
  lastUpdatedBy           String?  @map("last_updated_by")              // 最終更新者ID
  lastUpdatedAt           DateTime? @map("last_updated_at")              // 最終更新日時
  notes                   String?                                       // 備考
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id])

  @@map("staff_mindset_profiles")
}
```

#### フィールド詳細

**キャリア志向タイプ**:
- `balance`: バランス型（多様な経験を積む）
- `specialist`: スペシャリスト型（専門性追求）
- `generalist`: ゼネラリスト型（幅広いスキル）
- `leader`: リーダー型（管理職志向）

**ワークスタイル**:
- `team_oriented`: チーム重視
- `individual`: 個人作業重視
- `flexible`: 柔軟対応型

**夜勤意向**:
- `possible`: 可能
- `selectable`: 選択可能
- `not_possible`: 不可

**転勤・異動意向**:
- `willing`: 積極的
- `negotiable`: 要相談
- `not_willing`: 希望しない

#### 影響範囲
- 🔴 職員カルテ個人ページ > マインド・志向性タブ（全セクション）
- 🔴 人事配置計画の最適化
- 🔴 エンゲージメント向上施策の立案

#### 使い方の柔軟性
- 全フィールドがOptional（`?`付き）
- 必要な項目だけ入力すればOK
- 未入力の項目は`NULL`として扱われる
- 段階的にデータを充実させることが可能

---

## 🟢 低優先度の不足項目（Priority 3: あれば良い）

### 14. 社内イベント参加記録
### 15. メンター・メンティー関係
### 16. プロジェクト配属履歴
### 17. 福利厚生利用履歴
### 18. アンケート回答履歴

（詳細は後日追加）

---

## 📊 既存テーブルの不足カラム

### Interview テーブルに追加すべきカラム

#### 現状の問題
- NotebookLM等の外部AIツールとの連携機能がない
- 面談シートドキュメントへのリンクが保存できない
- AI分析結果が記録できない
- フィードバックサマリが保存できない

#### 追加すべきフィールド

```prisma
model Interview {
  id                   String                   @id @default(cuid())
  employeeId           String                   @map("employee_id")
  interviewerId        String                   @map("interviewer_id")
  interviewDate        DateTime                 @map("interview_date")
  interviewType        String                   @map("interview_type")
  duration             Int?                     // 面談時間（分）

  // 🆕 AI・外部ツール連携
  notebookLmUrl        String?                  @map("notebook_lm_url")         // NotebookLMリンク
  interviewSheetUrl    String?                  @map("interview_sheet_url")     // 面談シートURL
  aiAnalysisResult     Json?                    @map("ai_analysis_result")      // AI分析結果（JSON）
  aiAnalysisDate       DateTime?                @map("ai_analysis_date")        // AI分析実施日
  feedbackSummary      String?                  @map("feedback_summary")        // フィードバックサマリ
  feedbackSummaryCreatedAt DateTime?            @map("feedback_summary_created_at")

  // 🆕 ドキュメント管理
  attachments          Json?                    // 添付ファイル配列（複数のURLを保存）

  // 🆕 サポート面談専用フィールド (2025-10-08追加)
  interviewerRole          String?  @map("interviewer_role")
  // career_consultant: キャリアコンサルタント
  // counselor: 相談員
  // supervisor: 主任・管理職
  // occupational_doctor: 産業医
  // eap_counselor: EAPカウンセラー
  // mentor: メンター

  interviewerQualification String?  @map("interviewer_qualification")
  // 保有資格（国家資格キャリアコンサルタント、産業カウンセラー、臨床心理士等）

  isExternalInterviewer    Boolean  @default(false) @map("is_external_interviewer")
  // 外部専門家の場合true（EAP、外部カウンセラー等）

  // サポート分野分類（support面談専用）
  supportCategory          String?  @map("support_category")
  // career_development: キャリア開発支援
  // workplace_environment: 職場環境改善支援
  // feedback: フィードバック・指導
  // mental_health: メンタルヘルス支援
  // conflict_resolution: 対人関係・紛争解決
  // skill_improvement: スキル向上支援
  // work_life_balance: ワークライフバランス支援

  supportCategoryDisplay   String?  @map("support_category_display")
  // 表示用（キャリア支援面談、職場環境支援面談等）

  // 既存フィールド
  motivationTypeId     String?                  @map("motivation_type_id")
  motivationConfidence ConfidenceLevel?         @map("motivation_confidence")
  typeSpecificNotes    String?                  @map("type_specific_notes")
  overallEvaluation    String?                  @map("overall_evaluation")
  potentialEvaluation  String?                  @map("potential_evaluation")
  turnoverRisk         String?                  @map("turnover_risk")
  developmentPlan      String?                  @map("development_plan")
  nextActionItems      Json?                    @map("next_action_items")
  notes                String?
  createdAt            DateTime                 @default(now()) @map("created_at")
  updatedAt            DateTime                 @updatedAt @map("updated_at")

  // Relations
  employee           Employee                   @relation(fields: [employeeId], references: [id])
  interviewer        Employee                   @relation("InterviewerRelation", fields: [interviewerId], references: [id])
  motivationType     MotivationType?            @relation(fields: [motivationTypeId], references: [id])
  motivationHistory  StaffMotivationHistory[]

  @@index([employeeId])
  @@index([motivationTypeId])
  @@map("interviews")
}
```

#### AI分析結果のJSON構造例

```json
{
  "analysisVersion": "1.0",
  "analyzedAt": "2024-02-15T10:30:00Z",
  "sentiment": {
    "overall": "positive",
    "score": 0.85
  },
  "keyTopics": [
    {
      "topic": "キャリア成長",
      "importance": "high",
      "sentiment": "positive"
    },
    {
      "topic": "ワークライフバランス",
      "importance": "medium",
      "sentiment": "neutral"
    }
  ],
  "strengths": [
    "業務に対する積極的な姿勢",
    "患者様からの高評価"
  ],
  "concerns": [
    "時間外勤務の増加傾向"
  ],
  "recommendations": [
    "チームリーダー研修の受講を推奨",
    "業務量の調整を検討"
  ],
  "turnoverRiskScore": 15,
  "engagementScore": 82
}
```

#### 添付ファイルのJSON構造例

```json
[
  {
    "type": "interview_sheet",
    "name": "2024年2月度_面談シート.pdf",
    "url": "https://storage.example.com/interviews/2024-02-15-sheet.pdf",
    "uploadedAt": "2024-02-15T09:00:00Z"
  },
  {
    "type": "notebook_lm",
    "name": "NotebookLM分析結果",
    "url": "https://notebooklm.google.com/notebook/abc123",
    "createdAt": "2024-02-15T10:00:00Z"
  },
  {
    "type": "feedback_summary",
    "name": "職員向けフィードバックサマリ.pdf",
    "url": "https://storage.example.com/feedbacks/2024-02-15-summary.pdf",
    "uploadedAt": "2024-02-15T11:00:00Z"
  }
]
```

#### 機能説明

**NotebookLMリンク登録**:
- Google NotebookLMとの連携
- 面談記録をAIで分析・要約
- `notebookLmUrl`フィールドに保存

**AI分析**:
- 面談内容のセンチメント分析
- 離職リスクスコア算出
- エンゲージメントスコア算出
- 結果を`aiAnalysisResult`（JSON）に保存

**サマリ作成**:
- 職員向けフィードバック文書の自動生成
- `feedbackSummary`フィールドに保存
- PDF等のファイルはattachmentsに保存

---

### EmployeeSkill テーブルに追加すべきカラム

#### 現状の問題
- スキルレベル（1-5）はあるが、経験年数が記録できない
- 目標（資格取得予定等）が記録できない
- スキル習得日が記録できない

#### 追加すべきフィールド

```prisma
model EmployeeSkill {
  id           String   @id @default(cuid())
  employeeId   String
  skillId      String
  level        Int      // 1-5（1: 初級、2-3: 中級、4-5: 上級）

  // 🆕 追加フィールド
  experienceYears   Float?   @map("experience_years")      // 経験年数（0.5年単位）
  acquiredDate      DateTime? @map("acquired_date")        // 習得開始日
  goal              String?                                // 目標（例: 認定看護師取得予定、プリセプター認定）
  goalDeadline      DateTime? @map("goal_deadline")        // 目標達成期限
  lastPracticedDate DateTime? @map("last_practiced_date")  // 最終実践日（スキル維持確認用）

  // 既存フィールド
  certifiedAt  DateTime?
  certifiedBy  String?
  expiryDate   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])
  skill    Skill    @relation(fields: [skillId], references: [id])

  @@unique([employeeId, skillId])
  @@map("employee_skills")
}
```

#### レベル定義の標準化

| level値 | 表示ラベル | 説明 |
|---------|-----------|------|
| 1 | 初級 | 基礎知識あり、指導下で実施可能 |
| 2 | 中級（下） | 一人で実施可能、指導は要サポート |
| 3 | 中級（上） | 一人で実施・指導可能 |
| 4 | 上級（下） | 高度な実践・指導可能 |
| 5 | 上級（上） | エキスパートレベル、教育体系構築可能 |

#### 影響範囲
- 🔴 職員カルテ個人ページ > 資格・専門性タブ > 専門分野・スキルセクション
- 🔴 スキルマトリックス（部署別スキル一覧）
- 🔴 育成計画策定

---

### Employee テーブルに追加すべきカラム

```prisma
model Employee {
  // 既存フィールド...

  // 🆕 追加すべきフィールド
  employmentType      String?  @map("employment_type")      // permanent, contract, part_time
  bloodType           String?  @map("blood_type")            // A, B, O, AB
  hometown            String?  @map("hometown")              // 出身地（都道府県または市区町村）
  birthplace          String?  @map("birthplace")            // 出生地（より詳細な場合）
  emergencyContactName String? @map("emergency_contact_name")
  emergencyContactRelation String? @map("emergency_contact_relation")
  bankName            String?  @map("bank_name")             // 給与振込銀行
  bankBranch          String?  @map("bank_branch")           // 支店名
  bankAccountNumber   String?  @map("bank_account_number")   // 口座番号
  taxDependents       Int?     @default(0) @map("tax_dependents")  // 扶養人数
  socialInsuranceNumber String? @map("social_insurance_number")  // 社会保険番号

  // Relations追加
  certifications       Certification[]
  salaries            Salary[]
  attendances         Attendance[]
  leaveBalances       LeaveBalance[]
  disciplinaryActions DisciplinaryAction[]
  awards              Award[]
  achievements        Achievement[]        // 🆕 実績・成果
  familyMembers       FamilyMember[]
  retirementDetail    RetirementDetail?
  employmentContracts EmploymentContract[]
  educationHistories  EducationHistory[]
  workExperiences     WorkExperience[]
  goals               Goal[]
  developmentPlans    DevelopmentPlan[]
  careerCourses       StaffCareerCourse[]  // 🆕 キャリアコース履歴
  courseChangeRequests CareerCourseChangeRequest[]  // 🆕 コース変更申請
  clinicalLadderAssessments ClinicalLadderAssessment[]  // 🆕 クリニカルラダー評価
  professionalAssociations ProfessionalAssociation[]  // 🆕 学会・職能団体加入情報
  performanceMetrics  PerformanceMetric[]  // 🆕 業務実績指標
  contributionScores  OrganizationContributionScore[]  // 🆕 組織貢献度スコア
  projectParticipations ProjectParticipation[]  // 🆕 プロジェクト参加履歴
  workPatternAnalyses WorkPatternAnalysis[]  // 🆕 勤務パターン分析
  businessTrips       BusinessTrip[]       // 🆕 業務出張履歴
  stressCheckResults  StressCheckResult[]  // 🆕 ストレスチェック結果
  mentalHealthConsultations MentalHealthConsultation[]  // 🆕 メンタルヘルス相談履歴
  medicalHistories    MedicalHistory[]     // 🆕 病歴
  medications         Medication[]         // 🆕 服薬情報
  allergies           Allergy[]            // 🆕 アレルギー情報
  competencyAssessments CompetencyAssessment[]  // 🆕 能力評価
  v3Assessments       V3Assessment[]       // 🆕 V3評価推移（大幅拡張版）
  v3EvaluatorComments V3AssessmentComment[] @relation("V3Evaluator")  // 🆕 V3評価コメント（評価者として）
  mentoringAsMentor   MentoringRelationship[] @relation("MentorRelations")  // 🆕 メンターとしての関係
  mentoringAsMentee   MentoringRelationship[] @relation("MenteeRelations")  // 🆕 メンティーとしての関係
  mindsetProfile      StaffMindsetProfile? // 🆕 マインド・志向性プロファイル
}
```

---

## 🎯 Priority 3: 評価分析・研修効果追跡（追加項目）

### 12-1. 研修効果トラッキングテーブル ❌ 完全に不足

#### 現状の問題
- 研修受講履歴はTrainingHistoryで管理しているが、**評価との相関**が記録できない
- 研修前後のスコア比較ができない
- 研修効果（ROI）が測定できない
- どの研修が効果的かの分析ができない

#### 必要なテーブル: `TrainingEffectTrackings`（研修効果測定）

```prisma
model TrainingEffectTracking {
  id                    String   @id @default(cuid())
  employeeId            String   @map("employee_id")
  trainingHistoryId     String   @map("training_history_id")  // TrainingHistory.id

  // 研修情報
  trainingName          String   @map("training_name")
  trainingCategory      String   @map("training_category")
  // "specialized": 専門技術（感染管理研修、医療安全管理等）
  // "management": マネジメント（リーダーシップ研修等）
  // "mandatory": 法定研修（医療安全、感染対策等）
  // "soft_skill": ソフトスキル（コミュニケーション技法等）

  trainingDate          DateTime @map("training_date")
  trainingHours         Float    @map("training_hours")

  // 🆕 研修前評価
  preTrainingScore      Float?   @map("pre_training_score")     // 受講前スコア（0-100点）
  preTrainingDate       DateTime? @map("pre_training_date")      // 事前評価実施日

  // 🆕 研修後評価
  postTrainingScore     Float?   @map("post_training_score")    // 受講後スコア（0-100点）
  postTrainingDate      DateTime? @map("post_training_date")     // 事後評価実施日

  // 🆕 効果測定
  scoreImprovement      Float?   @map("score_improvement")      // スコア向上量（+13点等）
  improvementRate       Float?   @map("improvement_rate")       // 向上率（%）
  impactLevel           String?  @map("impact_level")
  // "very_high": 非常に高い（90%以上）
  // "high": 高い（70-89%）
  // "moderate": 中程度（50-69%）
  // "low": 低い（50%未満）

  // 🆕 測定対象領域
  targetSkillArea       String?  @map("target_skill_area")      // 対象スキル領域
  // "infection_control": 感染管理
  // "safety_management": 安全管理
  // "leadership": リーダーシップ
  // "communication": コミュニケーション
  // "specialized_nursing": 専門看護技術
  // "medical_knowledge": 医療知識
  // "team_work": チームワーク
  // "problem_solving": 問題解決

  // 🆕 投資対効果（ROI）
  trainingCost          Decimal? @map("training_cost") @db.Decimal(10, 2)  // 研修費用（円）
  roi                   Float?                                  // ROI = (効果 / コスト) × 100
  // 効果 = スコア向上 × 想定年間効果額

  // 🆕 研修効果の持続性
  threeMonthScore       Float?   @map("three_month_score")      // 3ヶ月後スコア
  sixMonthScore         Float?   @map("six_month_score")        // 6ヶ月後スコア
  retentionRate         Float?   @map("retention_rate")         // 効果保持率（%）

  // メタデータ
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  employee              Employee @relation(fields: [employeeId], references: [id])
  trainingHistory       TrainingHistory @relation(fields: [trainingHistoryId], references: [id])

  @@index([employeeId])
  @@index([trainingCategory])
  @@index([impactLevel])
  @@index([trainingDate(sort: Desc)])
  @@map("training_effect_trackings")
}
```

#### 使用例

**感染管理研修の効果測定:**
```json
{
  "trainingName": "感染管理研修",
  "trainingCategory": "specialized",
  "trainingDate": "2023-06-15",
  "trainingHours": 8,
  "preTrainingScore": 65,
  "postTrainingScore": 78,
  "scoreImprovement": 13,
  "improvementRate": 20.0,
  "impactLevel": "very_high",
  "targetSkillArea": "infection_control",
  "trainingCost": 15000,
  "roi": 230
}
```

#### 集計・分析クエリ例

**研修カテゴリ別平均効果:**
```sql
SELECT
  training_category,
  COUNT(*) as training_count,
  AVG(score_improvement) as avg_improvement,
  AVG(roi) as avg_roi
FROM training_effect_trackings
WHERE post_training_score IS NOT NULL
GROUP BY training_category
ORDER BY avg_improvement DESC;
```

**効果的な研修トップ5:**
```sql
SELECT
  training_name,
  AVG(score_improvement) as avg_improvement,
  COUNT(*) as participant_count
FROM training_effect_trackings
GROUP BY training_name
HAVING COUNT(*) >= 5
ORDER BY avg_improvement DESC
LIMIT 5;
```

---

### 12-2. スキル評価レーダーチャートテーブル ❌ 完全に不足

#### 現状の問題
- CompetencyAssessmentはあるが、**8軸レーダーチャート**用の詳細評価がない
- 専門知識、実務スキル、コミュニケーション等の個別評価ができない
- 部門平均との比較データがない
- 強み・改善点の自動判定ができない

#### 必要なテーブル: `SkillRadarAssessments`（8軸スキル評価）

```prisma
model SkillRadarAssessment {
  id                      String   @id @default(cuid())
  employeeId              String   @map("employee_id")
  assessmentDate          DateTime @map("assessment_date")
  assessmentPeriod        String?  @map("assessment_period")  // "2023年度"

  // 🆕 8軸評価（0-100点）
  specializedKnowledge    Float    @map("specialized_knowledge")    // 専門知識
  practicalSkills         Float    @map("practical_skills")         // 実務スキル
  communication           Float                                     // コミュニケーション
  leadership              Float                                     // リーダーシップ
  problemSolving          Float    @map("problem_solving")          // 問題解決力
  teamwork                Float                                     // 協調性
  innovation              Float                                     // 革新性
  responsibility          Float                                     // 責任感

  // 🆕 統計値
  overallAverage          Float    @map("overall_average")          // 8軸の平均値
  standardDeviation       Float?   @map("standard_deviation")       // 標準偏差（バランス指標）

  // 🆕 部門平均との比較
  departmentAverage       Float?   @map("department_average")       // 部門平均スコア
  differenceFromDeptAvg   Float?   @map("difference_from_dept_avg") // 部門平均との差分

  // 🆕 同職種平均との比較
  positionAverage         Float?   @map("position_average")         // 同職種平均
  differenceFromPosAvg    Float?   @map("difference_from_pos_avg")  // 同職種平均との差分

  // 🆕 同年代平均との比較
  ageGroupAverage         Float?   @map("age_group_average")        // 同年代平均
  differenceFromAgeAvg    Float?   @map("difference_from_age_avg")  // 同年代平均との差分

  // 🆕 強み・改善点の自動判定（JSON配列）
  topStrengths            Json?    @map("top_strengths")
  // [
  //   { "skill": "協調性", "score": 95, "rank": 1, "vsAverage": +18 },
  //   { "skill": "実務スキル", "score": 90, "rank": 2, "vsAverage": +12 },
  //   { "skill": "責任感", "score": 88, "rank": 3, "vsAverage": +10 }
  // ]

  improvementAreas        Json?    @map("improvement_areas")
  // [
  //   { "skill": "革新性", "score": 55, "rank": 8, "vsAverage": -8 },
  //   { "skill": "リーダーシップ", "score": 60, "rank": 7, "vsAverage": -5 },
  //   { "skill": "コミュニケーション", "score": 75, "rank": 6, "vsAverage": +2 }
  // ]

  // 🆕 評価者情報
  assessorId              String?  @map("assessor_id")              // 評価者のEmployeeID
  assessmentMethod        String?  @map("assessment_method")
  // "self": 自己評価
  // "supervisor": 上司評価
  // "360": 360度評価
  // "combined": 複合評価

  // メタデータ
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  employee                Employee @relation(fields: [employeeId], references: [id])
  assessor                Employee? @relation("SkillAssessor", fields: [assessorId], references: [id])

  @@index([employeeId])
  @@index([assessmentDate(sort: Desc)])
  @@index([assessmentPeriod])
  @@map("skill_radar_assessments")
}
```

#### 8軸評価の定義

| 軸 | 説明 | 測定項目例 |
|----|------|-----------|
| 専門知識 | 職種に必要な専門的知識 | 医療知識、看護理論、最新技術の理解度 |
| 実務スキル | 実際の業務遂行能力 | 技術の正確性、処理速度、ミスの少なさ |
| コミュニケーション | 対人コミュニケーション | 患者対応、報連相、多職種連携 |
| リーダーシップ | 指導力・統率力 | 後輩指導、チーム牽引、意思決定 |
| 問題解決力 | 課題発見・解決能力 | トラブル対応、改善提案、分析力 |
| 協調性 | チームワーク | 協力姿勢、相互支援、柔軟性 |
| 革新性 | 新しい取り組み | 改善活動、新技術導入、創意工夫 |
| 責任感 | 業務への責任意識 | 業務完遂、時間管理、規律遵守 |

#### レーダーチャート描画クエリ

```sql
SELECT
  specialized_knowledge,
  practical_skills,
  communication,
  leadership,
  problem_solving,
  teamwork,
  innovation,
  responsibility,
  department_average
FROM skill_radar_assessments
WHERE employee_id = 'xxx'
ORDER BY assessment_date DESC
LIMIT 1;
```

#### 部門平均計算クエリ

```sql
SELECT
  e.department_id,
  AVG(s.specialized_knowledge) as avg_specialized_knowledge,
  AVG(s.practical_skills) as avg_practical_skills,
  AVG(s.communication) as avg_communication,
  AVG(s.leadership) as avg_leadership,
  AVG(s.problem_solving) as avg_problem_solving,
  AVG(s.teamwork) as avg_teamwork,
  AVG(s.innovation) as avg_innovation,
  AVG(s.responsibility) as avg_responsibility
FROM skill_radar_assessments s
JOIN employees e ON s.employee_id = e.id
WHERE s.assessment_period = '2023年度'
GROUP BY e.department_id;
```

---

### 12-3. Employeeテーブルへの関連追加

```prisma
model Employee {
  // ... 既存フィールド

  // 🆕 研修効果追跡
  trainingEffects       TrainingEffectTracking[]  // 🆕 研修効果履歴

  // 🆕 スキル評価
  skillRadarAssessments SkillRadarAssessment[]    // 🆕 8軸スキル評価履歴
  assessedSkills        SkillRadarAssessment[] @relation("SkillAssessor")  // 🆕 評価者として

  // 既存Relations
  v3Assessments       V3Assessment[]
  v3EvaluatorComments V3AssessmentComment[] @relation("V3Evaluator")
  mentoringAsMentor   MentoringRelationship[] @relation("MentorRelations")
  mentoringAsMentee   MentoringRelationship[] @relation("MenteeRelations")
  mindsetProfile      StaffMindsetProfile?
}
```

---

## 13. ⚡ 横断的統合分析・成長ストーリー（Priority 1）

### 背景
個人ページの「横断的統合分析・成長ストーリー」タブでは、以下の高度な統合分析が表示されています：

1. **統合分析タイムライン** - 評価、面談、研修、実績など全システムの出来事を統一タイムラインで表示
2. **成長トレンド分析** - V1/V2/V3評価、面談、研修スコアの時系列推移と相関分析
3. **タレントポートフォリオ** - スキル×パフォーマンスの9マスマトリクス分析
4. **強み・課題の横断分析** - 全システムから導出された総合的な強み・課題
5. **AI成長予測** - 機械学習による将来のスコア予測・昇進可能性分析

これらの機能を実現するために、以下の3テーブルが必要です。

---

### 13-1. IntegratedGrowthTimeline（統合成長タイムライン）

#### 目的
評価、面談、研修、実績、資格取得など、全システムの重要イベントを統一タイムライン上で管理・可視化するためのテーブル。

#### テーブル設計

```prisma
model IntegratedGrowthTimeline {
  id                    String   @id @default(cuid())
  employeeId            String   @map("employee_id")

  // イベント基本情報
  eventDate             DateTime @map("event_date")
  eventType             String   @map("event_type")
  // hiring, promotion, evaluation_v1, evaluation_v2, evaluation_v3,
  // interview_regular, interview_special, interview_support,
  // training_internal, training_external, achievement, certification,
  // career_path_selection, mentoring_start, mentoring_end
  eventTitle            String   @map("event_title")
  eventDescription      String?  @db.Text @map("event_description")

  // イベントの重要度・影響度
  impactLevel           String?  @map("impact_level")
  // critical, high, medium, low
  isPositive            Boolean  @default(true) @map("is_positive")
  isMilestone           Boolean  @default(false) @map("is_milestone")

  // 関連データへの参照（任意）
  relatedAssessmentId   String?  @map("related_assessment_id")
  relatedInterviewId    String?  @map("related_interview_id")
  relatedTrainingId     String?  @map("related_training_id")
  relatedAchievementId  String?  @map("related_achievement_id")

  // スコア・評価（該当する場合）
  scoreValue            Float?   @map("score_value")
  scoreType             String?  @map("score_type")
  // v1_score, v2_score, v3_total, training_score, interview_rating

  // タグ付け
  tags                  Json?    // ["leadership", "skill_improvement", "promotion"]
  category              String?  // evaluation, development, achievement, career

  // AI分析
  aiGeneratedSummary    String?  @db.Text @map("ai_generated_summary")
  relatedStrengths      Json?    @map("related_strengths")
  // ["communication", "technical_skill"]
  relatedWeaknesses     Json?    @map("related_weaknesses")

  // メタ情報
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String?  @map("created_by")
  dataSource            String?  @map("data_source")
  // auto_generated, manual_entry, imported

  // Relations
  employee              Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, eventDate])
  @@index([eventType])
  @@index([impactLevel])
  @@index([isMilestone])
  @@map("integrated_growth_timelines")
}
```

#### 使用例

**タイムライン表示クエリ**
```sql
SELECT
  event_date,
  event_type,
  event_title,
  event_description,
  impact_level,
  is_milestone,
  score_value,
  tags
FROM integrated_growth_timelines
WHERE employee_id = 'emp123'
ORDER BY event_date DESC
LIMIT 20;
```

**マイルストーンのみ抽出**
```sql
SELECT * FROM integrated_growth_timelines
WHERE employee_id = 'emp123'
  AND is_milestone = true
ORDER BY event_date DESC;
```

**特定カテゴリのイベント推移**
```sql
SELECT
  DATE_FORMAT(event_date, '%Y-%m') as month,
  COUNT(*) as event_count,
  AVG(score_value) as avg_score
FROM integrated_growth_timelines
WHERE employee_id = 'emp123'
  AND event_type IN ('evaluation_v3', 'training_internal', 'training_external')
  AND score_value IS NOT NULL
GROUP BY month
ORDER BY month;
```

---

### 13-2. TalentPortfolioAnalysis（タレントポートフォリオ分析）

#### 目的
スキル（能力）× パフォーマンス（実績）の9マスマトリクスによるタレント分類を管理。将来のハイパフォーマー候補の特定や育成戦略立案に活用。

#### テーブル設計

```prisma
model TalentPortfolioAnalysis {
  id                    String   @id @default(cuid())
  employeeId            String   @map("employee_id")

  // 分析期間
  analysisPeriod        String   @map("analysis_period") // "2023年度"
  analysisDate          DateTime @map("analysis_date")

  // スキル軸（能力）0-100点
  skillScore            Float    @map("skill_score")
  skillLevel            String   @map("skill_level")
  // high (67-100), medium (34-66), low (0-33)
  skillDataSources      Json?    @map("skill_data_sources")
  // ["v3_technical_score", "radar_chart", "training_results"]

  // パフォーマンス軸（実績）0-100点
  performanceScore      Float    @map("performance_score")
  performanceLevel      String   @map("performance_level")
  // high, medium, low
  performanceDataSources Json?   @map("performance_data_sources")
  // ["v3_contribution_score", "achievements", "project_results"]

  // 9マスマトリクス分類
  matrixPosition        String   @map("matrix_position")
  // high_potential (スキル高×パフォーマンス高)
  // consistent_performer (スキル中×パフォーマンス高)
  // future_star (スキル高×パフォーマンス中)
  // core_performer (スキル中×パフォーマンス中)
  // growth_needed (スキル低×パフォーマンス中)
  // inconsistent (スキル高×パフォーマンス低)
  // solid_contributor (スキル中×パフォーマンス低)
  // underperformer (スキル低×パフォーマンス低)
  // developing (スキル低×パフォーマンス高 - 伸び盛り)

  // 座標（可視化用）
  xCoordinate           Float    @map("x_coordinate") // パフォーマンス軸
  yCoordinate           Float    @map("y_coordinate") // スキル軸

  // ポジション変化追跡
  previousPosition      String?  @map("previous_position")
  positionChangeDate    DateTime? @map("position_change_date")
  isImproved            Boolean  @default(false) @map("is_improved")

  // 部門・法人内比較
  departmentRank        Int?     @map("department_rank")
  departmentPercentile  Float?   @map("department_percentile")
  corporateRank         Int?     @map("corporate_rank")
  corporatePercentile   Float?   @map("corporate_percentile")

  // AI推奨アクション
  recommendedActions    Json?    @map("recommended_actions")
  // [
  //   {action: "leadership_training", priority: "high"},
  //   {action: "project_lead_opportunity", priority: "medium"}
  // ]
  potentialRoles        Json?    @map("potential_roles")
  // ["team_leader", "specialist", "manager_candidate"]

  // リスク・機会分析
  retentionRisk         String?  @map("retention_risk")
  // high, medium, low
  promotionReadiness    String?  @map("promotion_readiness")
  // ready, almost_ready, not_ready

  // メタ情報
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  calculatedBy          String?  @map("calculated_by")
  // system_auto, hr_manual

  // Relations
  employee              Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, analysisPeriod])
  @@index([matrixPosition])
  @@index([skillLevel, performanceLevel])
  @@index([analysisDate])
  @@map("talent_portfolio_analyses")
}
```

#### 9マスマトリクス定義

| パフォーマンス＼スキル | 低 (0-33) | 中 (34-66) | 高 (67-100) |
|---------------------|----------|-----------|------------|
| **高 (67-100)** | Developing<br>伸び盛り | Consistent Performer<br>安定成果 | High Potential<br>ハイポテンシャル⭐ |
| **中 (34-66)** | Growth Needed<br>育成要 | Core Performer<br>コア人材 | Future Star<br>将来の星 |
| **低 (0-33)** | Underperformer<br>要支援 | Solid Contributor<br>堅実型 | Inconsistent<br>不安定 |

#### 使用例

**最新のポートフォリオポジション取得**
```sql
SELECT
  e.name,
  t.skill_score,
  t.performance_score,
  t.matrix_position,
  t.department_percentile,
  t.recommended_actions
FROM talent_portfolio_analyses t
JOIN employees e ON t.employee_id = e.id
WHERE t.analysis_period = '2023年度'
  AND t.matrix_position = 'high_potential'
ORDER BY t.corporate_percentile DESC;
```

**ポジション変遷の追跡**
```sql
SELECT
  analysis_period,
  matrix_position,
  skill_score,
  performance_score,
  department_rank
FROM talent_portfolio_analyses
WHERE employee_id = 'emp123'
ORDER BY analysis_date;
```

---

### 13-3. GrowthPrediction（AI成長予測）

#### 目的
機械学習モデルによる将来のスコア予測、昇進可能性、成長軌道の予測データを保存。データドリブンな人材育成計画の立案に活用。

#### テーブル設計

```prisma
model GrowthPrediction {
  id                    String   @id @default(cuid())
  employeeId            String   @map("employee_id")

  // 予測基準日
  predictionDate        DateTime @map("prediction_date")
  basedOnDataUntil      DateTime @map("based_on_data_until")

  // モデル情報
  modelVersion          String   @map("model_version") // "v1.2.3"
  modelType             String   @map("model_type")
  // regression, time_series, ensemble, neural_network
  confidenceLevel       Float    @map("confidence_level") // 0-1

  // 将来スコア予測（時系列）
  predictedScores       Json     @map("predicted_scores")
  // [
  //   {period: "2024-Q1", v3_total: 85.5, confidence: 0.82},
  //   {period: "2024-Q2", v3_total: 87.2, confidence: 0.75},
  //   {period: "2024-Q3", v3_total: 88.9, confidence: 0.68}
  // ]

  // 成長速度予測
  predictedGrowthRate   Float?   @map("predicted_growth_rate")
  // 年間成長率（%）
  growthTrajectory      String?  @map("growth_trajectory")
  // rapid, steady, plateau, declining

  // 昇進可能性予測
  promotionProbability  Json?    @map("promotion_probability")
  // {
  //   "next_level": "主任",
  //   "1year": 0.15,
  //   "2year": 0.45,
  //   "3year": 0.72
  // }
  expectedPromotionDate DateTime? @map("expected_promotion_date")

  // スキル発展予測
  skillDevelopment      Json?    @map("skill_development")
  // [
  //   {skill: "leadership", current: 65, predicted_1y: 72, predicted_2y: 80},
  //   {skill: "technical", current: 85, predicted_1y: 88, predicted_2y: 90}
  // ]

  // リスク予測
  turnoverRisk          Float?   @map("turnover_risk") // 0-1
  burnoutRisk           Float?   @map("burnout_risk")  // 0-1
  performanceRisk       String?  @map("performance_risk")
  // low, medium, high

  // 推奨施策
  recommendedInterventions Json? @map("recommended_interventions")
  // [
  //   {type: "training", topic: "リーダーシップ研修", impact: "high"},
  //   {type: "mentoring", duration: "6months", impact: "medium"}
  // ]

  // 特徴量の重要度
  topInfluencingFactors Json?    @map("top_influencing_factors")
  // [
  //   {factor: "v3_technical_score", weight: 0.35},
  //   {factor: "training_completion_rate", weight: 0.22},
  //   {factor: "interview_positive_trend", weight: 0.18}
  // ]

  // 予測精度評価（実績との比較）
  actualVsPredicted     Json?    @map("actual_vs_predicted")
  // {period: "2023-Q4", predicted: 85.5, actual: 84.2, error: -1.3}
  predictionAccuracy    Float?   @map("prediction_accuracy") // 0-1

  // メタ情報
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  isActive              Boolean  @default(true) @map("is_active")
  supersededBy          String?  @map("superseded_by")
  // 新しい予測が作成された場合、古い予測のID

  // Relations
  employee              Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, predictionDate])
  @@index([isActive])
  @@index([growthTrajectory])
  @@map("growth_predictions")
}
```

#### 使用例

**最新の成長予測取得**
```sql
SELECT
  e.name,
  g.predicted_scores,
  g.predicted_growth_rate,
  g.promotion_probability,
  g.confidence_level,
  g.recommended_interventions
FROM growth_predictions g
JOIN employees e ON g.employee_id = e.id
WHERE g.is_active = true
  AND g.confidence_level >= 0.7
ORDER BY g.prediction_date DESC;
```

**ハイポテンシャル人材の予測抽出**
```sql
SELECT
  employee_id,
  predicted_growth_rate,
  promotion_probability,
  growth_trajectory
FROM growth_predictions
WHERE is_active = true
  AND predicted_growth_rate > 10.0  -- 年間10%以上成長予測
  AND growth_trajectory = 'rapid'
ORDER BY predicted_growth_rate DESC;
```

**予測精度の検証**
```sql
SELECT
  model_version,
  AVG(prediction_accuracy) as avg_accuracy,
  AVG(confidence_level) as avg_confidence,
  COUNT(*) as prediction_count
FROM growth_predictions
WHERE actual_vs_predicted IS NOT NULL
GROUP BY model_version
ORDER BY avg_accuracy DESC;
```

---

### 13-4. Employeeテーブルへの関連追加

```prisma
model Employee {
  // ... 既存フィールド

  // 🆕 統合分析
  growthTimeline           IntegratedGrowthTimeline[]   // 🆕 統合成長タイムライン
  talentPortfolio          TalentPortfolioAnalysis[]    // 🆕 タレントポートフォリオ
  growthPredictions        GrowthPrediction[]           // 🆕 AI成長予測

  // 既存Relations
  trainingEffects          TrainingEffectTracking[]
  skillRadarAssessments    SkillRadarAssessment[]
  v3Assessments            V3Assessment[]
  v3EvaluatorComments      V3AssessmentComment[] @relation("V3Evaluator")
  mentoringAsMentor        MentoringRelationship[] @relation("MentorRelations")
  mentoringAsMentee        MentoringRelationship[] @relation("MenteeRelations")
  mindsetProfile           StaffMindsetProfile?
}
```

---

### 13-5. データフロー

#### 統合タイムライン自動生成
```typescript
// 評価確定時に自動追加
async function onV3AssessmentConfirmed(assessment: V3Assessment) {
  await prisma.integratedGrowthTimeline.create({
    data: {
      employeeId: assessment.employeeId,
      eventDate: assessment.confirmedDate,
      eventType: 'evaluation_v3',
      eventTitle: `${assessment.evaluationPeriod} V3評価確定`,
      impactLevel: 'high',
      isMilestone: true,
      relatedAssessmentId: assessment.id,
      scoreValue: assessment.totalScore,
      scoreType: 'v3_total',
      category: 'evaluation',
      dataSource: 'auto_generated'
    }
  });
}
```

#### タレントポートフォリオ計算
```typescript
async function calculateTalentPortfolio(employeeId: string, period: string) {
  // スキルスコア算出（V3技術評価 + レーダーチャート）
  const skillScore = await calculateSkillScore(employeeId, period);

  // パフォーマンススコア算出（V3貢献度 + 実績）
  const performanceScore = await calculatePerformanceScore(employeeId, period);

  // 9マスマトリクス分類
  const position = classifyMatrixPosition(skillScore, performanceScore);

  await prisma.talentPortfolioAnalysis.create({
    data: {
      employeeId,
      analysisPeriod: period,
      analysisDate: new Date(),
      skillScore,
      skillLevel: getLevel(skillScore),
      performanceScore,
      performanceLevel: getLevel(performanceScore),
      matrixPosition: position,
      xCoordinate: performanceScore,
      yCoordinate: skillScore,
      calculatedBy: 'system_auto'
    }
  });
}
```

#### AI予測モデル実行
```typescript
async function runGrowthPrediction(employeeId: string) {
  // 過去データ取得
  const historicalData = await getEmployeeHistoricalData(employeeId);

  // ML予測実行
  const prediction = await mlModel.predict(historicalData);

  // 予測結果保存
  await prisma.growthPrediction.create({
    data: {
      employeeId,
      predictionDate: new Date(),
      basedOnDataUntil: new Date(),
      modelVersion: 'v1.2.3',
      modelType: 'ensemble',
      confidenceLevel: prediction.confidence,
      predictedScores: prediction.futureScores,
      predictedGrowthRate: prediction.growthRate,
      growthTrajectory: prediction.trajectory,
      promotionProbability: prediction.promotionProb,
      recommendedInterventions: prediction.recommendations,
      isActive: true
    }
  });
}
```

---

## 14. 🎓 採用・オンボーディング・配属履歴・適性評価（Priority 1）

### 背景
個人ページの「採用から現在までの統合分析」セクションでは、以下の重要な情報が表示されています：

1. **採用・オンボーディング概要** - 採用区分、試用期間、オンボーディング進捗（4ステップ）
2. **配属履歴・キャリアパス** - 過去の全配属情報、各配属での評価、異動理由
3. **適性評価・職務適合度** - 総合適性スコア、5軸評価（コミュニケーション、チームワーク、技術適性、適応性、リーダーシップ）
4. **キャリア開発計画** - 希望専門分野、キャリア目標、メンターシップニーズ、次期配属推奨

これらの機能を実現するために、以下の4テーブル追加 + Employeeテーブル拡張が必要です。

---

### 14-1. OnboardingProgress（オンボーディング進捗管理）

#### 目的
新入職員のオンボーディングプロセス全体を管理。オリエンテーション、メンター配置、スキル評価、試用期間評価の4ステップの進捗を追跡。

#### テーブル設計

```prisma
model OnboardingProgress {
  id                    String    @id @default(cuid())
  employeeId            String    @unique @map("employee_id")

  // 全体進捗
  overallProgress       Float     @map("overall_progress") // 0-100%
  status                String    @map("status")
  // in_progress, completed, delayed, suspended
  startDate             DateTime  @map("start_date")
  completionDate        DateTime? @map("completion_date")
  expectedCompletionDate DateTime? @map("expected_completion_date")

  // 各ステップの完了状況
  orientationCompleted  Boolean   @default(false) @map("orientation_completed")
  orientationDate       DateTime? @map("orientation_date")

  mentorAssigned        Boolean   @default(false) @map("mentor_assigned")
  mentorId              String?   @map("mentor_id")
  mentorAssignedDate    DateTime? @map("mentor_assigned_date")

  skillAssessmentDone   Boolean   @default(false) @map("skill_assessment_done")
  skillAssessmentDate   DateTime? @map("skill_assessment_date")

  probationEvaluated    Boolean   @default(false) @map("probation_evaluated")
  probationEvalDate     DateTime? @map("probation_eval_date")

  // 詳細チェックリスト（JSON）
  checklistItems        Json?     @map("checklist_items")
  // [
  //   {item: "入社手続き", completed: true, completedDate: "2024-04-01"},
  //   {item: "システムアカウント作成", completed: true, completedDate: "2024-04-02"},
  //   {item: "安全衛生教育", completed: false, dueDate: "2024-04-10"}
  // ]

  // 進捗メモ
  progressNotes         String?   @db.Text @map("progress_notes")
  blockers              Json?     @map("blockers")
  // [{issue: "メンター調整中", date: "2024-04-05"}]

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")
  lastUpdatedBy         String?   @map("last_updated_by")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@index([status])
  @@index([overallProgress])
  @@map("onboarding_progress")
}
```

#### 使用例

**オンボーディング中の職員一覧**
```sql
SELECT
  e.name,
  o.overall_progress,
  o.status,
  o.orientation_completed,
  o.mentor_assigned,
  o.skill_assessment_done,
  o.probation_evaluated
FROM onboarding_progress o
JOIN employees e ON o.employee_id = e.id
WHERE o.status = 'in_progress'
ORDER BY o.start_date DESC;
```

**完了率の計算**
```typescript
function calculateProgress(onboarding: OnboardingProgress): number {
  const steps = [
    onboarding.orientationCompleted,
    onboarding.mentorAssigned,
    onboarding.skillAssessmentDone,
    onboarding.probationEvaluated
  ];
  const completedCount = steps.filter(Boolean).length;
  return (completedCount / steps.length) * 100;
}
```

---

### 14-2. AssignmentHistory（配属履歴）

#### 目的
職員の全配属履歴を時系列で管理。各配属での評価、異動理由、獲得スキルを記録し、キャリアパスの可視化に活用。

#### テーブル設計

```prisma
model AssignmentHistory {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 配属先情報
  departmentId          String?   @map("department_id")
  departmentName        String    @map("department_name")
  facilityId            String?   @map("facility_id")
  facilityName          String    @map("facility_name")

  // 役職・職種
  positionTitle         String    @map("position_title")
  // "看護師（新人）", "看護師", "主任", "看護師長"
  employmentType        String?   @map("employment_type")
  // full_time, part_time, contract

  // 配属期間
  startDate             DateTime  @map("start_date")
  endDate               DateTime? @map("end_date")
  isCurrent             Boolean   @default(false) @map("is_current")
  durationMonths        Int?      @map("duration_months") // 在籍月数

  // 異動理由・種類
  assignmentReason      String?   @map("assignment_reason")
  // new_hire (新人配属), rotation (ローテーション),
  // promotion (昇進), transfer (異動),
  // skill_development (経験年数による配置転換),
  // organizational_change (組織改編)
  assignmentReasonDisplay String? @map("assignment_reason_display")
  // "新人配属", "ローテーション", "経験年数による配置転換"

  // 配属での評価
  performanceRating     String?   @map("performance_rating")
  // A, B+, B, C, D
  performanceComment    String?   @db.Text @map("performance_comment")

  // 成果・経験
  keyAchievements       Json?     @map("key_achievements")
  // ["新人教育担当", "感染対策委員", "業務改善プロジェクト参加"]
  skillsAcquired        Json?     @map("skills_acquired")
  // ["急性期看護", "チームマネジメント", "電子カルテ運用"]

  // 上長評価
  supervisorId          String?   @map("supervisor_id")
  supervisorFeedback    String?   @db.Text @map("supervisor_feedback")

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  recordedBy            String?   @map("recorded_by")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@index([employeeId, startDate])
  @@index([isCurrent])
  @@index([facilityId])
  @@index([departmentId])
  @@map("assignment_history")
}
```

#### 使用例

**配属履歴の取得（時系列）**
```sql
SELECT
  department_name,
  facility_name,
  position_title,
  start_date,
  end_date,
  duration_months,
  assignment_reason_display,
  performance_rating
FROM assignment_history
WHERE employee_id = 'emp123'
ORDER BY start_date DESC;
```

**現在の配属情報**
```sql
SELECT * FROM assignment_history
WHERE employee_id = 'emp123'
  AND is_current = true;
```

**部署経験数のカウント**
```sql
SELECT
  employee_id,
  COUNT(DISTINCT department_id) as department_count,
  COUNT(DISTINCT facility_id) as facility_count
FROM assignment_history
GROUP BY employee_id;
```

---

### 14-3. FitnessAssessment（適性評価）

#### 目的
職員の職務適性を多面的に評価。コミュニケーション、チームワーク、技術適性、適応性、リーダーシップなどの軸で0-100点評価を実施。

#### テーブル設計

```prisma
model FitnessAssessment {
  id                    String   @id @default(cuid())
  employeeId            String   @map("employee_id")

  // 評価日
  assessmentDate        DateTime @map("assessment_date")
  assessmentPeriod      String?  @map("assessment_period")
  // "2023年度", "入職時", "試用期間終了時"

  // 総合適性スコア（0-100点）
  totalFitnessScore     Float    @map("total_fitness_score")
  fitnessLevel          String?  @map("fitness_level")
  // excellent (90-100), good (75-89), average (60-74), needs_improvement (<60)

  // 各項目スコア（0-100点）
  communicationScore    Float?   @map("communication_score")
  teamworkScore         Float?   @map("teamwork_score")
  technicalAptitudeScore Float?  @map("technical_aptitude_score")
  adaptabilityScore     Float?   @map("adaptability_score")
  leadershipScore       Float?   @map("leadership_score")
  problemSolvingScore   Float?   @map("problem_solving_score")
  stressToleranceScore  Float?   @map("stress_tolerance_score")
  learningAgilityScore  Float?   @map("learning_agility_score")

  // 強み・改善点の特定
  topStrength           String?  @map("top_strength")
  // "communication", "teamwork", "technical_aptitude"
  topStrengthScore      Float?   @map("top_strength_score")

  secondStrength        String?  @map("second_strength")
  secondStrengthScore   Float?   @map("second_strength_score")

  improvementArea       String?  @map("improvement_area")
  improvementAreaScore  Float?   @map("improvement_area_score")

  // 職務適合度分析
  currentRoleFitScore   Float?   @map("current_role_fit_score")
  // 現在の役割への適合度
  potentialScore        Float?   @map("potential_score")
  // 将来の成長ポテンシャル

  // 総合評価コメント
  overallComment        String?  @db.Text @map("overall_comment")
  strengthsComment      String?  @db.Text @map("strengths_comment")
  developmentComment    String?  @db.Text @map("development_comment")

  // 評価者情報
  assessorId            String?  @map("assessor_id")
  assessorRole          String?  @map("assessor_role")
  // direct_supervisor, hr_manager, external_consultant

  // 推奨アクション
  recommendedActions    Json?    @map("recommended_actions")
  // [
  //   {action: "リーダーシップ研修受講", priority: "high"},
  //   {action: "プロジェクトリーダー経験", priority: "medium"}
  // ]

  // メタ情報
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  employee              Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, assessmentDate])
  @@index([totalFitnessScore])
  @@index([assessmentPeriod])
  @@map("fitness_assessments")
}
```

#### 評価項目の定義

| 評価項目 | 説明 | 測定内容 |
|---------|------|---------|
| コミュニケーション | 対人コミュニケーション能力 | 患者・家族対応、報連相、多職種連携 |
| チームワーク | チームでの協働能力 | 協力姿勢、相互支援、柔軟性 |
| 技術適性 | 職種に必要な技術・知識 | 専門知識、実務スキル、正確性 |
| 適応性 | 変化への適応力 | 新環境適応、柔軟な対応、学習意欲 |
| リーダーシップ | 指導力・統率力 | 後輩指導、チーム牽引、意思決定 |
| 問題解決力 | 課題発見・解決能力 | トラブル対応、改善提案、分析力 |
| ストレス耐性 | 高負荷環境での対応力 | 冷静な判断、感情コントロール |
| 学習敏捷性 | 新しいスキル習得速度 | 学習意欲、知識応用力、成長速度 |

#### 使用例

**最新の適性評価取得**
```sql
SELECT
  e.name,
  f.total_fitness_score,
  f.top_strength,
  f.top_strength_score,
  f.improvement_area,
  f.assessment_date
FROM fitness_assessments f
JOIN employees e ON f.employee_id = e.id
WHERE f.employee_id = 'emp123'
ORDER BY f.assessment_date DESC
LIMIT 1;
```

**高適性人材の抽出**
```sql
SELECT
  employee_id,
  total_fitness_score,
  communication_score,
  leadership_score,
  potential_score
FROM fitness_assessments
WHERE total_fitness_score >= 85
  AND assessment_period = '2024年度'
ORDER BY total_fitness_score DESC;
```

---

### 14-4. CareerDevelopmentPlan（キャリア開発計画）

#### 目的
職員の中長期的なキャリア開発計画を管理。希望専門分野、キャリア目標、メンターシップニーズ、次期配属推奨などを体系的に記録。

#### テーブル設計

```prisma
model CareerDevelopmentPlan {
  id                    String    @id @default(cuid())
  employeeId            String    @unique @map("employee_id")

  // 計画期間
  planCreatedDate       DateTime  @map("plan_created_date")
  planVersion           Int       @default(1) @map("plan_version")
  targetPeriod          String?   @map("target_period")
  // "2年以内", "3-5年計画", "10年ビジョン"
  lastReviewedDate      DateTime? @map("last_reviewed_date")
  nextReviewDate        DateTime? @map("next_review_date")

  // 希望専門分野
  preferredSpecialty    String?   @map("preferred_specialty")
  // "内科・慢性期ケア", "外科・急性期", "精神科",
  // "訪問看護", "管理職", "教育・指導"
  specialtyReason       String?   @db.Text @map("specialty_reason")
  // なぜその専門分野を選んだか

  // キャリア目標（JSON配列）
  careerGoals           Json?     @map("career_goals")
  // [
  //   {
  //     goal: "主任昇進",
  //     timeframe: "2年以内",
  //     priority: "high",
  //     status: "on_track",
  //     progressPercent: 60
  //   },
  //   {
  //     goal: "専門資格取得",
  //     detail: "感染管理認定看護師",
  //     timeframe: "3年以内",
  //     priority: "high",
  //     status: "planning"
  //   },
  //   {
  //     goal: "部署横断プロジェクトリーダー",
  //     timeframe: "1年以内",
  //     priority: "medium",
  //     status: "achieved"
  //   }
  // ]

  // メンターシップニーズ
  mentorshipNeeds       Json?     @map("mentorship_needs")
  // [
  //   {need: "リーダーシップ開発", priority: "high"},
  //   {need: "法人規模プロジェクト経験", priority: "high"},
  //   {need: "管理業務スキル習得", priority: "medium"}
  // ]
  currentMentorId       String?   @map("current_mentor_id")
  mentorAssignedDate    DateTime? @map("mentor_assigned_date")

  // 次期配属推奨
  recommendedNextAssignment String? @map("recommended_next_assignment")
  // "内科系主任候補ポジション", "ICU配属", "訪問看護ステーション"
  recommendedPosition   String?   @map("recommended_position")
  // "主任", "副師長", "専門看護師"
  recommendationReason  String?   @db.Text @map("recommendation_reason")

  // 昇進準備状況
  promotionReadiness    String?   @map("promotion_readiness")
  // ready (準備完了), almost_ready (ほぼ準備完了),
  // needs_development (育成必要), not_applicable (該当なし)
  promotionTargetDate   DateTime? @map("promotion_target_date")
  promotionRequirements Json?     @map("promotion_requirements")
  // [
  //   {requirement: "主任資格要件", status: "achieved"},
  //   {requirement: "リーダー経験3年以上", status: "in_progress", current: "2年"}
  // ]

  // スキル開発計画
  skillGaps             Json?     @map("skill_gaps")
  // ["リーダーシップ", "予算管理", "多職種連携"]
  trainingPlan          Json?     @map("training_plan")
  // [
  //   {training: "リーダーシップ研修", status: "scheduled", date: "2024-06"},
  //   {training: "管理者養成講座", status: "planned", target: "2024年度"}
  // ]

  // 進捗状況
  planStatus            String?   @map("plan_status")
  // on_track (順調), delayed (遅延), needs_revision (要見直し),
  // on_hold (保留), completed (完了)
  progressNotes         String?   @db.Text @map("progress_notes")
  achievementHighlights Json?     @map("achievement_highlights")
  // 達成した主要マイルストーン

  // 本人の意向・コメント
  employeeComments      String?   @db.Text @map("employee_comments")
  lastEmployeeInput     DateTime? @map("last_employee_input")

  // HR/上長のコメント
  hrComments            String?   @db.Text @map("hr_comments")
  supervisorComments    String?   @db.Text @map("supervisor_comments")
  supervisorId          String?   @map("supervisor_id")

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")
  lastUpdatedBy         String?   @map("last_updated_by")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@index([planStatus])
  @@index([promotionReadiness])
  @@index([nextReviewDate])
  @@map("career_development_plans")
}
```

#### 使用例

**キャリア開発計画の取得**
```sql
SELECT
  e.name,
  c.preferred_specialty,
  c.career_goals,
  c.mentorship_needs,
  c.recommended_next_assignment,
  c.promotion_readiness,
  c.plan_status
FROM career_development_plans c
JOIN employees e ON c.employee_id = e.id
WHERE c.employee_id = 'emp123';
```

**昇進準備完了者の抽出**
```sql
SELECT
  e.name,
  e.position,
  c.promotion_readiness,
  c.promotion_target_date,
  c.recommended_position
FROM career_development_plans c
JOIN employees e ON c.employee_id = e.id
WHERE c.promotion_readiness IN ('ready', 'almost_ready')
  AND c.promotion_target_date <= DATE_ADD(NOW(), INTERVAL 6 MONTH)
ORDER BY c.promotion_target_date;
```

**レビュー期限が近い計画**
```sql
SELECT
  employee_id,
  next_review_date,
  plan_status,
  DATEDIFF(next_review_date, NOW()) as days_until_review
FROM career_development_plans
WHERE next_review_date <= DATE_ADD(NOW(), INTERVAL 30 DAY)
ORDER BY next_review_date;
```

---

### 14-5. Employeeテーブル拡張（採用情報）

```prisma
model Employee {
  // ... 既存フィールド

  // 🆕 採用情報
  hireDate              DateTime?  @map("hire_date")
  employmentType        String?    @map("employment_type")
  // new_graduate (新卒), mid_career (中途),
  // contract_to_permanent (契約→正社員), rehire (再雇用)

  probationPeriodMonths Int?       @map("probation_period_months")
  probationEndDate      DateTime?  @map("probation_end_date")
  probationResult       String?    @map("probation_result")
  // passed (合格), passed_with_conditions (条件付き合格),
  // extended (延長), failed (不合格)

  yearsOfService        Float?     @map("years_of_service")
  // 勤続年数（年単位、小数点含む）例: 4.5
  monthsOfService       Int?       @map("months_of_service")
  // 勤続月数 例: 54ヶ月

  // 🆕 Relations
  onboardingProgress    OnboardingProgress?      // オンボーディング進捗
  assignmentHistory     AssignmentHistory[]      // 配属履歴
  fitnessAssessments    FitnessAssessment[]      // 適性評価履歴
  careerPlan            CareerDevelopmentPlan?   // キャリア開発計画

  // 既存Relations
  growthTimeline        IntegratedGrowthTimeline[]
  talentPortfolio       TalentPortfolioAnalysis[]
  growthPredictions     GrowthPrediction[]
  trainingEffects       TrainingEffectTracking[]
  skillRadarAssessments SkillRadarAssessment[]
  v3Assessments         V3Assessment[]
  v3EvaluatorComments   V3AssessmentComment[] @relation("V3Evaluator")
  mentoringAsMentor     MentoringRelationship[] @relation("MentorRelations")
  mentoringAsMentee     MentoringRelationship[] @relation("MenteeRelations")
  mindsetProfile        StaffMindsetProfile?
}
```

---

### 14-6. データフロー

#### 採用時のデータ作成
```typescript
async function onEmployeeHired(employeeId: string, hireData: HireData) {
  // 1. Employee基本情報更新
  await prisma.employee.update({
    where: { id: employeeId },
    data: {
      hireDate: hireData.hireDate,
      employmentType: hireData.employmentType,
      probationPeriodMonths: 6,
      probationEndDate: addMonths(hireData.hireDate, 6)
    }
  });

  // 2. オンボーディング進捗作成
  await prisma.onboardingProgress.create({
    data: {
      employeeId,
      startDate: hireData.hireDate,
      status: 'in_progress',
      overallProgress: 0
    }
  });

  // 3. 初回配属履歴作成
  await prisma.assignmentHistory.create({
    data: {
      employeeId,
      departmentName: hireData.initialDepartment,
      positionTitle: hireData.initialPosition,
      startDate: hireData.hireDate,
      isCurrent: true,
      assignmentReason: 'new_hire',
      assignmentReasonDisplay: '新人配属'
    }
  });

  // 4. キャリア開発計画テンプレート作成
  await prisma.careerDevelopmentPlan.create({
    data: {
      employeeId,
      planCreatedDate: new Date(),
      planStatus: 'on_track'
    }
  });
}
```

#### 配属異動時の処理
```typescript
async function onAssignmentChange(
  employeeId: string,
  newAssignment: AssignmentData
) {
  // 1. 現在の配属を終了
  await prisma.assignmentHistory.updateMany({
    where: { employeeId, isCurrent: true },
    data: {
      endDate: newAssignment.startDate,
      isCurrent: false,
      durationMonths: calculateMonths(startDate, newAssignment.startDate)
    }
  });

  // 2. 新しい配属を作成
  await prisma.assignmentHistory.create({
    data: {
      employeeId,
      ...newAssignment,
      isCurrent: true
    }
  });

  // 3. 統合タイムラインにイベント追加
  await prisma.integratedGrowthTimeline.create({
    data: {
      employeeId,
      eventDate: newAssignment.startDate,
      eventType: 'assignment_change',
      eventTitle: `${newAssignment.departmentName}へ異動`,
      impactLevel: 'high',
      isMilestone: true
    }
  });
}
```

---

## 15. 📈 スキル育成計画（Priority 1）

### 背景
個人ページの「キャリア開発計画」内に、スキル単位での育成計画が表示されています：

```
リーダーシップ: 75点 → 85点（目標）
  期間: 6ヶ月
  方法: 管理職研修 + OJT
  進捗: 88.2%

法人貢献度: 78点 → 88点（目標）
  期間: 12ヶ月
  方法: クロスファンクショナルプロジェクト参加
  進捗: 88.6%
```

これは**スキル単位の育成進捗管理**であり、以下の情報が必要：
- 現在スコア・目標スコア
- 育成期間・方法
- 進捗率の自動計算
- マイルストーン管理

既存のCareerDevelopmentPlanはキャリア全体の計画であり、**スキル単位の詳細な育成計画**を管理する専用テーブルが必要です。

---

### 15-1. SkillDevelopmentPlan（スキル育成計画）

#### 目的
職員の個別スキルごとに育成計画を立て、進捗を追跡。現在スコアから目標スコアへの成長プロセスを可視化し、育成方法・マイルストーンを管理。

#### テーブル設計

```prisma
model SkillDevelopmentPlan {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // スキル情報
  skillName             String    @map("skill_name")
  // "リーダーシップ", "法人貢献度", "専門技術", "コミュニケーション",
  // "感染管理", "チームマネジメント", "予算管理"
  skillCategory         String?   @map("skill_category")
  // leadership, technical, communication, organizational,
  // management, specialized

  // 現在値・目標値（0-100点）
  currentScore          Float     @map("current_score")
  targetScore           Float     @map("target_score")
  improvementGap        Float     @map("improvement_gap")
  // targetScore - currentScore

  // 進捗状況
  latestScore           Float?    @map("latest_score")
  progressPercent       Float?    @map("progress_percent")
  // (latestScore - currentScore) / (targetScore - currentScore) * 100
  lastMeasurementDate   DateTime? @map("last_measurement_date")

  // 計画期間
  planStartDate         DateTime  @map("plan_start_date")
  planEndDate           DateTime  @map("plan_end_date")
  durationMonths        Int       @map("duration_months")
  // 3ヶ月, 6ヶ月, 12ヶ月

  // 育成方法
  developmentMethod     String    @map("development_method")
  // "管理職研修 + OJT", "クロスファンクショナルプロジェクト参加",
  // "専門資格取得", "メンタリング", "現場実践"
  developmentActions    Json?     @map("development_actions")
  // [
  //   {action: "リーダーシップ研修受講", status: "completed", date: "2024-01"},
  //   {action: "チームリーダー経験", status: "in_progress", startDate: "2024-02"},
  //   {action: "プロジェクトマネジメント実践", status: "planned", targetDate: "2024-06"}
  // ]

  // ステータス
  status                String    @map("status")
  // not_started (未開始), in_progress (進行中),
  // on_track (順調), delayed (遅延),
  // completed (完了), cancelled (中止)

  // マイルストーン
  milestones            Json?     @map("milestones")
  // [
  //   {
  //     month: 3,
  //     targetScore: 80,
  //     status: "achieved",
  //     actualScore: 81,
  //     achievedDate: "2024-03-15"
  //   },
  //   {
  //     month: 6,
  //     targetScore: 85,
  //     status: "pending",
  //     dueDate: "2024-06-15"
  //   }
  // ]

  // 関連情報
  relatedTrainings      Json?     @map("related_trainings")
  // ["training_id_123", "training_id_456"] 関連する研修のID
  relatedAssessments    Json?     @map("related_assessments")
  // 関連するV3評価やスキル評価のID
  mentorId              String?   @map("mentor_id")
  supervisorId          String?   @map("supervisor_id")

  // 評価・フィードバック
  lastEvaluationDate    DateTime? @map("last_evaluation_date")
  supervisorFeedback    String?   @db.Text @map("supervisor_feedback")
  employeeReflection    String?   @db.Text @map("employee_reflection")
  // 本人の振り返り・自己評価

  // 課題・障壁
  challenges            Json?     @map("challenges")
  // [
  //   {issue: "業務多忙で研修時間確保困難", date: "2024-03", status: "resolved"},
  //   {issue: "実践機会の不足", date: "2024-04", status: "ongoing"}
  // ]

  // 優先度
  priority              String?   @map("priority")
  // critical, high, medium, low
  isLinkedToPromotion   Boolean   @default(false) @map("is_linked_to_promotion")
  // 昇進要件に関連するか

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")
  approvedBy            String?   @map("approved_by")
  approvedDate          DateTime? @map("approved_date")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@index([employeeId, status])
  @@index([planEndDate])
  @@index([skillCategory])
  @@index([priority])
  @@index([isLinkedToPromotion])
  @@map("skill_development_plans")
}
```

---

### 15-2. Employeeテーブルへの関連追加

```prisma
model Employee {
  // ... 既存フィールド

  // 🆕 スキル育成計画
  skillDevelopmentPlans SkillDevelopmentPlan[]  // スキル単位の育成計画

  // 既存Relations
  onboardingProgress    OnboardingProgress?
  assignmentHistory     AssignmentHistory[]
  fitnessAssessments    FitnessAssessment[]
  careerPlan            CareerDevelopmentPlan?
  growthTimeline        IntegratedGrowthTimeline[]
  talentPortfolio       TalentPortfolioAnalysis[]
  growthPredictions     GrowthPrediction[]
  trainingEffects       TrainingEffectTracking[]
  skillRadarAssessments SkillRadarAssessment[]
  v3Assessments         V3Assessment[]
  v3EvaluatorComments   V3AssessmentComment[] @relation("V3Evaluator")
  mentoringAsMentor     MentoringRelationship[] @relation("MentorRelations")
  mentoringAsMentee     MentoringRelationship[] @relation("MenteeRelations")
  mindsetProfile        StaffMindsetProfile?
}
```

---

### 15-3. 使用例

#### スキル育成計画の取得

```typescript
// 進行中のスキル育成計画を取得
const activeSkillPlans = await prisma.skillDevelopmentPlan.findMany({
  where: {
    employeeId: 'emp123',
    status: { in: ['in_progress', 'on_track'] }
  },
  orderBy: { planEndDate: 'asc' }
});

// UIレンダリング
activeSkillPlans.map(plan => ({
  skillName: plan.skillName,
  timeline: `${plan.durationMonths}ヶ月`,
  currentScore: plan.currentScore,
  targetScore: plan.targetScore,
  latestScore: plan.latestScore,
  progressPercent: plan.progressPercent,
  method: plan.developmentMethod,
  status: plan.status
}));
```

**出力例：**
```json
[
  {
    "skillName": "リーダーシップ",
    "timeline": "6ヶ月",
    "currentScore": 75,
    "targetScore": 85,
    "latestScore": 83.8,
    "progressPercent": 88.2,
    "method": "管理職研修 + OJT",
    "status": "on_track"
  },
  {
    "skillName": "法人貢献度",
    "timeline": "12ヶ月",
    "currentScore": 78,
    "targetScore": 88,
    "latestScore": 86.86,
    "progressPercent": 88.6,
    "method": "クロスファンクショナルプロジェクト参加",
    "status": "on_track"
  }
]
```

---

#### 進捗率の自動計算

```typescript
async function updateSkillProgress(
  planId: string,
  newScore: number
) {
  const plan = await prisma.skillDevelopmentPlan.findUnique({
    where: { id: planId }
  });

  if (!plan) throw new Error('Plan not found');

  // 進捗率計算
  const progressPercent =
    ((newScore - plan.currentScore) /
     (plan.targetScore - plan.currentScore)) * 100;

  // ステータス自動判定
  let newStatus = plan.status;
  if (progressPercent >= 100) {
    newStatus = 'completed';
  } else if (progressPercent >= 75) {
    newStatus = 'on_track';
  } else if (new Date() > plan.planEndDate && progressPercent < 100) {
    newStatus = 'delayed';
  }

  // 更新
  await prisma.skillDevelopmentPlan.update({
    where: { id: planId },
    data: {
      latestScore: newScore,
      progressPercent,
      lastMeasurementDate: new Date(),
      status: newStatus
    }
  });
}
```

---

#### マイルストーン達成チェック

```typescript
async function checkMilestones(planId: string) {
  const plan = await prisma.skillDevelopmentPlan.findUnique({
    where: { id: planId }
  });

  const milestones = plan.milestones as any[];
  const today = new Date();

  milestones.forEach(milestone => {
    const monthsElapsed = differenceInMonths(today, plan.planStartDate);

    if (monthsElapsed >= milestone.month && milestone.status === 'pending') {
      // マイルストーン到達時の評価
      if (plan.latestScore >= milestone.targetScore) {
        milestone.status = 'achieved';
        milestone.actualScore = plan.latestScore;
        milestone.achievedDate = today;
      } else {
        milestone.status = 'missed';
        milestone.actualScore = plan.latestScore;
      }
    }
  });

  await prisma.skillDevelopmentPlan.update({
    where: { id: planId },
    data: { milestones }
  });
}
```

---

#### 昇進関連スキルの進捗サマリー

```typescript
// 昇進に必要なスキル育成の進捗を取得
const promotionSkills = await prisma.skillDevelopmentPlan.findMany({
  where: {
    employeeId: 'emp123',
    isLinkedToPromotion: true
  },
  orderBy: { priority: 'desc' }
});

const summary = {
  totalSkills: promotionSkills.length,
  completedSkills: promotionSkills.filter(s => s.status === 'completed').length,
  averageProgress: promotionSkills.reduce((sum, s) => sum + (s.progressPercent || 0), 0) / promotionSkills.length,
  onTrack: promotionSkills.filter(s => s.status === 'on_track').length,
  delayed: promotionSkills.filter(s => s.status === 'delayed').length
};

console.log(`昇進準備度: ${summary.averageProgress.toFixed(1)}%`);
```

---

#### CareerDevelopmentPlanとの連携

```typescript
// キャリア開発計画からスキル育成計画を自動生成
async function generateSkillPlansFromCareer(employeeId: string) {
  const careerPlan = await prisma.careerDevelopmentPlan.findUnique({
    where: { employeeId }
  });

  const skillGaps = careerPlan.skillGaps as string[];

  for (const skill of skillGaps) {
    await prisma.skillDevelopmentPlan.create({
      data: {
        employeeId,
        skillName: skill,
        currentScore: await getCurrentSkillScore(employeeId, skill),
        targetScore: 85, // デフォルト目標
        planStartDate: new Date(),
        planEndDate: addMonths(new Date(), 6),
        durationMonths: 6,
        status: 'not_started',
        isLinkedToPromotion: careerPlan.promotionReadiness === 'almost_ready'
      }
    });
  }
}
```

---

#### 育成計画完了時の統合タイムライン追加

```typescript
async function onSkillPlanCompleted(planId: string) {
  const plan = await prisma.skillDevelopmentPlan.findUnique({
    where: { id: planId },
    include: { employee: true }
  });

  // 統合タイムラインにイベント追加
  await prisma.integratedGrowthTimeline.create({
    data: {
      employeeId: plan.employeeId,
      eventDate: new Date(),
      eventType: 'skill_development_completed',
      eventTitle: `${plan.skillName}スキル育成完了`,
      eventDescription: `${plan.currentScore}点 → ${plan.latestScore}点（目標${plan.targetScore}点）達成`,
      impactLevel: plan.isLinkedToPromotion ? 'high' : 'medium',
      isMilestone: plan.isLinkedToPromotion,
      scoreValue: plan.latestScore,
      scoreType: 'skill_score',
      category: 'development'
    }
  });
}
```

---

### 15-4. CareerDevelopmentPlanとの違い

| 項目 | CareerDevelopmentPlan | SkillDevelopmentPlan |
|-----|----------------------|---------------------|
| スコープ | キャリア全体の計画 | 個別スキル単位の計画 |
| 管理単位 | 職員1人につき1レコード | スキルごとに複数レコード |
| 内容 | 希望専門分野、キャリア目標、メンターシップニーズ | 現在スコア→目標スコア、育成方法、進捗率 |
| 進捗管理 | 定性的（on_track/delayed） | 定量的（進捗率％） |
| マイルストーン | 全体的な達成項目 | スキル単位の中間目標 |
| 関連性 | 職員のキャリアビジョン | 具体的な育成アクション |

両テーブルは連携して使用：
- **CareerDevelopmentPlan** → 「リーダーシップが必要」（skillGaps）
- **SkillDevelopmentPlan** → 「リーダーシップを75→85点に6ヶ月で育成」（具体的計画）

---

---

## 16. 📚 教育研修管理システム（Priority 1）

### 背景
教育管理ページ（/education）では、評価システムと連動した高度な研修管理機能が実装されています。ユーザーからの要望：

> 個人レベルで誰がどのような研修を受講したか、全ての履歴を把握したい。法定研修、企画研修（ハラスメント研修など）、全ての履歴を管理。個人単位・施設単位・部署単位での把握も必要。

**現在のシステム機能（フロントエンド実装済み）:**
1. 評価連動型年間研修スケジュール
2. 個人別研修履歴と進捗管理
3. 研修ROI分析・効果測定
4. 施設別・部署別の研修進捗
5. 未受講者アラート
6. 修了証発行
7. 研修と評価スコアの相関分析
8. 研修効果予測シミュレーション

**現在のDBテーブル:**
- **Training**テーブル（基本的な研修履歴のみ）
  - 研修名、カテゴリ、日付、時間数、スコア、修了証の有無

**問題点:**
- 研修プログラム（カリキュラム）の定義がない
- 研修の種別（法定研修・企画研修・必須研修）の区別がない
- 受講状況（申込→受講中→完了）の管理がない
- 施設・部署単位の受講状況集計ができない
- 研修効果測定（受講前後のスコア）の管理がない
- 評価システムとの連携データがない
- 研修計画（年間スケジュール）の管理がない
- 研修カテゴリの詳細分類がない

---

### 16-1. TrainingProgram（研修プログラム・カリキュラム）

#### 目的
全ての研修プログラム（カリキュラム）を定義・管理。法定研修、企画研修、必須研修など全ての研修の「型」を管理。

#### テーブル設計

```prisma
model TrainingProgram {
  id                    String    @id @default(cuid())

  // プログラム基本情報
  programCode           String    @unique @map("program_code")
  // "LEGAL-001", "PLAN-HARASSMENT-2024", "REQUIRED-SAFETY-001"
  programName           String    @map("program_name")
  programNameEn         String?   @map("program_name_en")

  // 研修種別
  trainingType          String    @map("training_type")
  // legal (法定研修), planned (企画研修), required (必須研修),
  // optional (任意研修), external (外部研修), certification (資格研修)

  trainingCategory      String    @map("training_category")
  // medical_safety (医療安全), infection_control (感染対策),
  // harassment (ハラスメント), compliance (コンプライアンス),
  // leadership (リーダーシップ), specialized_skill (専門技術),
  // new_employee (新人研修), legal_required (法定義務)

  // 対象者条件
  targetFacilities      Json?     @map("target_facilities")
  // ["obara-hospital", "tategami-rehabilitation"] or null (全施設対象)
  targetDepartments     Json?     @map("target_departments")
  // ["nursing", "rehabilitation"] or null (全部署対象)
  targetJobCategories   Json?     @map("target_job_categories")
  // ["nurse", "care_worker"]
  targetExperienceLevels Json?    @map("target_experience_levels")
  // ["new", "junior"] or null (全レベル対象)

  // 必須・任意設定
  isRequired            Boolean   @default(false) @map("is_required")
  isLegalRequired       Boolean   @default(false) @map("is_legal_required")
  // 法定義務研修かどうか
  requirementConditions Json?     @map("requirement_conditions")
  // 必須となる条件の詳細定義

  // 研修内容
  description           String?   @db.Text @map("description")
  objectives            Json?     @map("objectives")
  // ["医療安全の基本理解", "インシデント対応手順習得"]
  syllabusUrl           String?   @map("syllabus_url")
  materialsUrl          String?   @map("materials_url")

  // 実施形式
  deliveryMethod        String    @map("delivery_method")
  // onsite (集合研修), online (オンライン), elearning (e-ラーニング),
  // ojt (OJT), hybrid (ハイブリッド)
  durationHours         Float     @map("duration_hours")
  maxParticipants       Int?      @map("max_participants")

  // 評価・テスト
  hasExam               Boolean   @default(false) @map("has_exam")
  passingScore          Float?    @map("passing_score")
  // 合格基準点
  certificateIssued     Boolean   @default(false) @map("certificate_issued")
  certificateValidYears Int?      @map("certificate_valid_years")
  // 修了証の有効年数

  // 実施頻度・スケジュール
  frequency             String?   @map("frequency")
  // annual (年1回), biannual (年2回), quarterly (四半期), monthly,
  // ondemand (随時), onetime (1回のみ)
  scheduledMonths       Json?     @map("scheduled_months")
  // [4, 10] 4月と10月に実施

  // 評価システム連動
  linkedToEvaluation    Boolean   @default(false) @map("linked_to_evaluation")
  evaluationImpact      String?   @map("evaluation_impact")
  // "評価スコア+2点加算", "必須研修未完了で減点"
  relatedEvaluationItems Json?    @map("related_evaluation_items")
  // ["C03_safety", "F01_specialized"]

  // コスト
  costPerPerson         Float?    @map("cost_per_person")
  totalBudget           Float?    @map("total_budget")

  // ステータス
  isActive              Boolean   @default(true) @map("is_active")
  startDate             DateTime? @map("start_date")
  endDate               DateTime? @map("end_date")

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  // Relations
  trainingSessions      TrainingSession[]   // 実施セッション
  trainingHistories     TrainingHistory[]   // 受講履歴

  @@index([trainingType])
  @@index([trainingCategory])
  @@index([isRequired])
  @@index([isLegalRequired])
  @@index([isActive])
  @@map("training_programs")
}
```

---

### 16-2. TrainingSession（研修実施セッション）

#### 目的
研修プログラムの具体的な実施日程・会場を管理。1つのプログラムが複数回実施される場合、それぞれがセッションとなる。

#### テーブル設計

```prisma
model TrainingSession {
  id                    String    @id @default(cuid())
  trainingProgramId     String    @map("training_program_id")

  // セッション情報
  sessionCode           String    @unique @map("session_code")
  // "LEGAL-001-2024-04-15"
  sessionName           String?   @map("session_name")
  // "2024年度第1回医療安全研修"

  // 実施日時・場所
  sessionDate           DateTime  @map("session_date")
  sessionTime           String?   @map("session_time")
  // "14:00-16:00"
  facilityId            String?   @map("facility_id")
  venue                 String?   @map("venue")
  // "小原病院 3階会議室", "オンライン（Zoom）"
  isOnline              Boolean   @default(false) @map("is_online")
  meetingUrl            String?   @map("meeting_url")

  // 講師情報
  instructorName        String?   @map("instructor_name")
  instructorOrg         String?   @map("instructor_org")
  // 外部講師の場合の所属
  isExternalInstructor  Boolean   @default(false) @map("is_external_instructor")

  // 定員・申込状況
  capacity              Int?      @map("capacity")
  registeredCount       Int       @default(0) @map("registered_count")
  attendedCount         Int       @default(0) @map("attended_count")
  completedCount        Int       @default(0) @map("completed_count")

  // ステータス
  status                String    @map("status")
  // planned (計画中), open_for_registration (申込受付中),
  // closed_for_registration (申込締切), in_progress (実施中),
  // completed (完了), cancelled (中止)

  registrationDeadline  DateTime? @map("registration_deadline")
  cancellationDeadline  DateTime? @map("cancellation_deadline")

  // 実施結果
  actualDurationHours   Float?    @map("actual_duration_hours")
  feedbackSummary       String?   @db.Text @map("feedback_summary")
  averageSatisfaction   Float?    @map("average_satisfaction")
  // 満足度 0-5
  averageScore          Float?    @map("average_score")
  // テスト平均点

  // コスト実績
  actualCost            Float?    @map("actual_cost")
  costPerAttendee       Float?    @map("cost_per_attendee")

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  // Relations
  trainingProgram       TrainingProgram  @relation(fields: [trainingProgramId], references: [id])
  trainingHistories     TrainingHistory[]

  @@index([sessionDate])
  @@index([status])
  @@index([facilityId])
  @@map("training_sessions")
}
```

---

### 16-3. TrainingHistory（研修受講履歴）- 既存Training拡張

#### 目的
個人レベルの研修受講履歴を詳細に管理。申込から完了までの全ステータスを追跡。

#### テーブル設計

```prisma
model TrainingHistory {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")
  trainingProgramId     String    @map("training_program_id")
  trainingSessionId     String?   @map("training_session_id")

  // 受講状況
  registrationStatus    String    @map("registration_status")
  // registered (申込済), waitlisted (キャンセル待ち),
  // confirmed (確定), attended (出席), absent (欠席),
  // cancelled (キャンセル), completed (完了), failed (不合格)

  registrationDate      DateTime? @map("registration_date")
  attendanceDate        DateTime? @map("attendance_date")
  completionDate        DateTime? @map("completion_date")

  // 出席確認
  checkInTime           DateTime? @map("check_in_time")
  checkOutTime          DateTime? @map("check_out_time")
  attendanceRate        Float?    @map("attendance_rate")
  // 出席率（途中退席などを考慮）

  // 評価・テスト結果
  examScore             Float?    @map("exam_score")
  examPassed            Boolean?  @map("exam_passed")
  preTestScore          Float?    @map("pre_test_score")
  // 受講前テスト
  postTestScore         Float?    @map("post_test_score")
  // 受講後テスト
  scoreImprovement      Float?    @map("score_improvement")
  // 向上スコア

  // 満足度・フィードバック
  satisfactionRating    Float?    @map("satisfaction_rating")
  // 0-5
  feedbackComment       String?   @db.Text @map("feedback_comment")
  improvementSuggestions String?  @db.Text @map("improvement_suggestions")

  // 修了証
  certificateIssued     Boolean   @default(false) @map("certificate_issued")
  certificateNumber     String?   @map("certificate_number")
  certificateIssuedDate DateTime? @map("certificate_issued_date")
  certificateExpiryDate DateTime? @map("certificate_expiry_date")
  certificateFileUrl    String?   @map("certificate_file_url")

  // 効果測定
  effectiveness         Float?    @map("effectiveness")
  // 研修効果スコア（3ヶ月後などに評価）
  effectMeasurementDate DateTime? @map("effect_measurement_date")
  behaviorChange        String?   @db.Text @map("behavior_change")
  // 行動変容の記録

  // 評価システム連携
  impactOnEvaluation    Float?    @map("impact_on_evaluation")
  // この研修による評価スコアへの影響
  relatedAssessmentId   String?   @map("related_assessment_id")

  // 承認フロー
  approvalRequired      Boolean   @default(false) @map("approval_required")
  approvedBy            String?   @map("approved_by")
  approvedDate          DateTime? @map("approved_date")
  approvalComment       String?   @map("approval_comment")

  // コスト
  participationCost     Float?    @map("participation_cost")
  travelCost            Float?    @map("travel_cost")
  totalCost             Float?    @map("total_cost")

  // 備考
  notes                 String?   @db.Text @map("notes")
  cancellationReason    String?   @map("cancellation_reason")

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  recordedBy            String?   @map("recorded_by")

  // Relations
  employee              Employee         @relation(fields: [employeeId], references: [id])
  trainingProgram       TrainingProgram  @relation(fields: [trainingProgramId], references: [id])
  trainingSession       TrainingSession? @relation(fields: [trainingSessionId], references: [id])

  @@index([employeeId, completionDate])
  @@index([trainingProgramId])
  @@index([trainingSessionId])
  @@index([registrationStatus])
  @@index([completionDate])
  @@map("training_histories")
}
```

---

### 16-4. TrainingPlan（年間研修計画）

#### 目的
年間・四半期・月次の研修計画を管理。評価システムとの連動スケジュールを定義。

#### テーブル設計

```prisma
model TrainingPlan {
  id                    String    @id @default(cuid())

  // 計画期間
  planYear              Int       @map("plan_year") // 2024
  planPeriod            String    @map("plan_period")
  // annual (年間), quarterly (四半期), monthly (月次)
  planName              String    @map("plan_name")
  // "2024年度年間研修計画", "2024年第2四半期計画"

  // 対象範囲
  targetFacilities      Json?     @map("target_facilities")
  targetDepartments     Json?     @map("target_departments")

  // 計画内容
  trainingPrograms      Json      @map("training_programs")
  // [
  //   {
  //     programId: "xxx",
  //     scheduledMonth: 4,
  //     targetParticipants: 50,
  //     budget: 200000,
  //     evaluationLink: "3月技術評価結果連動"
  //   }
  // ]

  // 目標設定
  targetCompletionRate  Float?    @map("target_completion_rate")
  // 目標完了率 (%)
  targetAverageScore    Float?    @map("target_average_score")
  targetROI             Float?    @map("target_roi")

  // 予算
  totalBudget           Float?    @map("total_budget")
  allocatedBudget       Float?    @map("allocated_budget")
  actualSpending        Float?    @map("actual_spending")

  // 評価連携
  linkedEvaluationSchedule Json?  @map("linked_evaluation_schedule")
  // {
  //   "3月": "技術評価実施前に医療安全研修必須",
  //   "6月": "夏季貢献度評価と研修効果測定連携"
  // }

  // 実績
  actualCompletionRate  Float?    @map("actual_completion_rate")
  actualAverageScore    Float?    @map("actual_average_score")
  actualROI             Float?    @map("actual_roi")
  achievementRate       Float?    @map("achievement_rate")
  // 目標達成率

  // ステータス
  status                String    @map("status")
  // draft (草案), approved (承認済), in_progress (実施中),
  // completed (完了), archived (アーカイブ)

  approvedBy            String?   @map("approved_by")
  approvedDate          DateTime? @map("approved_date")

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([planYear, planPeriod])
  @@index([status])
  @@map("training_plans")
}
```

---

### 16-5. TrainingEffectAnalysis（研修効果分析）

#### 目的
研修の効果を定量的に測定・分析。評価スコアとの相関、ROI計算、施設・部署別の効果比較。

#### テーブル設計

```prisma
model TrainingEffectAnalysis {
  id                    String    @id @default(cuid())
  trainingProgramId     String    @map("training_program_id")

  // 分析期間
  analysisDate          DateTime  @map("analysis_date")
  analysisPeriod        String    @map("analysis_period")
  // "2024-Q1", "2024年度"

  // 対象範囲
  targetScope           String    @map("target_scope")
  // all (全体), facility (施設別), department (部署別),
  // job_category (職種別), experience_level (経験レベル別)
  scopeIdentifier       String?   @map("scope_identifier")
  // 施設ID、部署IDなど

  // 受講者データ
  totalParticipants     Int       @map("total_participants")
  completedParticipants Int       @map("completed_participants")
  completionRate        Float     @map("completion_rate")

  // スコアデータ
  averagePreScore       Float?    @map("average_pre_score")
  averagePostScore      Float?    @map("average_post_score")
  averageImprovement    Float?    @map("average_improvement")
  averageExamScore      Float?    @map("average_exam_score")
  passRate              Float?    @map("pass_rate")

  // 評価システム連携データ
  evaluationScoreBefore Float?    @map("evaluation_score_before")
  // 研修前の評価スコア平均
  evaluationScoreAfter  Float?    @map("evaluation_score_after")
  // 研修後の評価スコア平均
  evaluationImprovement Float?    @map("evaluation_improvement")
  correlationCoefficient Float?   @map("correlation_coefficient")
  // 研修スコアと評価スコアの相関係数

  // ROI分析
  totalCost             Float?    @map("total_cost")
  costPerPerson         Float?    @map("cost_per_person")
  estimatedValue        Float?    @map("estimated_value")
  // 評価向上による価値算出
  roi                   Float?    @map("roi")
  // ROI = (価値 - コスト) / コスト * 100

  // 満足度
  averageSatisfaction   Float?    @map("average_satisfaction")
  recommendationRate    Float?    @map("recommendation_rate")

  // 効果持続性
  threeMonthRetention   Float?    @map("three_month_retention")
  // 3ヶ月後の効果持続率
  sixMonthRetention     Float?    @map("six_month_retention")

  // 分析結果サマリー
  effectLevel           String?   @map("effect_level")
  // very_high, high, moderate, low, very_low
  keyFindings           Json?     @map("key_findings")
  // 主要な発見事項
  recommendations       Json?     @map("recommendations")
  // 改善提案

  // 比較データ
  comparisonData        Json?     @map("comparison_data")
  // 他施設・他部署との比較

  // メタ情報
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  analyzedBy            String?   @map("analyzed_by")

  @@index([trainingProgramId, analysisDate])
  @@index([analysisPeriod])
  @@index([targetScope])
  @@map("training_effect_analyses")
}
```

---

### 16-6. Employeeテーブルへの関連追加

```prisma
model Employee {
  // ... 既存フィールド

  // 🆕 研修管理
  trainingHistories     TrainingHistory[]    // 研修受講履歴

  // 既存Relations
  skillDevelopmentPlans SkillDevelopmentPlan[]
  onboardingProgress    OnboardingProgress?
  assignmentHistory     AssignmentHistory[]
  fitnessAssessments    FitnessAssessment[]
  careerPlan            CareerDevelopmentPlan?
  growthTimeline        IntegratedGrowthTimeline[]
  talentPortfolio       TalentPortfolioAnalysis[]
  growthPredictions     GrowthPrediction[]
  // ...
}
```

---

### 16-7. 使用例

#### 個人レベル：全研修履歴の取得

```typescript
// 職員の全研修履歴を取得（法定研修・企画研修含む）
const trainingHistory = await prisma.trainingHistory.findMany({
  where: { employeeId: 'emp123' },
  include: {
    trainingProgram: {
      select: {
        programName: true,
        trainingType: true,
        trainingCategory: true,
        isLegalRequired: true
      }
    },
    trainingSession: {
      select: {
        sessionDate: true,
        venue: true,
        instructorName: true
      }
    }
  },
  orderBy: { completionDate: 'desc' }
});

// グループ化して表示
const grouped = {
  legal: trainingHistory.filter(t => t.trainingProgram.isLegalRequired),
  planned: trainingHistory.filter(t => t.trainingProgram.trainingType === 'planned'),
  required: trainingHistory.filter(t => t.trainingProgram.isRequired),
  optional: trainingHistory.filter(t => !t.trainingProgram.isRequired)
};
```

#### 施設単位：研修進捗状況

```typescript
// 施設別の研修進捗を取得
const facilityProgress = await prisma.$queryRaw`
  SELECT
    tp.training_type,
    tp.program_name,
    COUNT(DISTINCT th.employee_id) as total_registered,
    SUM(CASE WHEN th.registration_status = 'completed' THEN 1 ELSE 0 END) as completed_count,
    (SUM(CASE WHEN th.registration_status = 'completed' THEN 1 ELSE 0 END) * 100.0 / COUNT(DISTINCT th.employee_id)) as completion_rate
  FROM training_histories th
  JOIN training_programs tp ON th.training_program_id = tp.id
  JOIN employees e ON th.employee_id = e.id
  WHERE e.facility_id = 'obara-hospital'
    AND YEAR(th.created_at) = 2024
  GROUP BY tp.id, tp.training_type, tp.program_name
  ORDER BY tp.training_type, completion_rate DESC
`;
```

#### 部署単位：未受講者リスト

```typescript
// 部署別の必須研修未受講者を抽出
const uncompletedByDepartment = await prisma.employee.findMany({
  where: {
    departmentId: 'nursing-dept',
    trainingHistories: {
      none: {
        trainingProgram: {
          isRequired: true,
          trainingCategory: 'medical_safety'
        },
        registrationStatus: 'completed'
      }
    }
  },
  select: {
    id: true,
    name: true,
    position: true,
    department: true
  }
});
```

#### 法定研修の管理

```typescript
// 法定研修の受講状況確認
const legalTrainingStatus = await prisma.trainingHistory.findMany({
  where: {
    trainingProgram: {
      isLegalRequired: true
    },
    completionDate: {
      gte: new Date(new Date().getFullYear(), 0, 1) // 今年度
    }
  },
  include: {
    employee: {
      select: { id: true, name: true, departmentId: true }
    },
    trainingProgram: {
      select: { programName: true, trainingCategory: true }
    }
  }
});

// 期限切れ間近の修了証をチェック
const expiringCertificates = await prisma.trainingHistory.findMany({
  where: {
    certificateExpiryDate: {
      lte: addMonths(new Date(), 3), // 3ヶ月以内に期限切れ
      gte: new Date()
    },
    registrationStatus: 'completed'
  },
  include: {
    employee: true,
    trainingProgram: true
  }
});
```

---

### 16-8. 既存Trainingテーブルとの関係

**既存Trainingテーブル（181-200行）:**
- 基本的な研修履歴のみ
- プログラム定義なし
- 受講状況管理なし

**移行方針:**
1. 既存Trainingテーブルは**TrainingHistory**に統合
2. 既存データをTrainingHistoryに移行し、対応するTrainingProgramを作成
3. TrainingProgramでカリキュラムを一元管理
4. TrainingSessionで実施スケジュールを管理
5. TrainingHistoryで個人の受講履歴を詳細追跡

---

## 17. 目標管理システム・等級制度・コンピテンシー評価（将来対応）

### 背景と要件
- 現在は基本的なOKR機能のみ（目標設定・進捗管理・評価）
- **第2段階（2026年10月）**: 共通50等級制度導入予定
- **第3段階（2027年4月）**: 100点満点評価制度 + コンピテンシー評価完成
- 等級制度の詳細は未定だが、**今の段階であらゆる目標管理に対応できる設計**が必要

### 人事制度の段階的導入計画（参照: hr-station）
```
第1段階（2026年4月〜）
└─ キャリアコース制度導入（評価・等級なし）

第2段階（2026年10月〜）
└─ 共通50等級制度導入
   ├─ Aコース: 1-50級（係数1.2）
   ├─ Bコース: 1-40級（係数1.1）
   ├─ Cコース: 1-30級（係数1.0）
   └─ Dコース: 1-20級（係数0.9）

第3段階（2027年4月〜）- 完成形
└─ 100点満点評価制度 + コンピテンシー評価
   ├─ 7段階評価（S+/S/A+/A/B/C/D）
   ├─ パフォーマンス層別（上位20%/中間60%/要支援20%）
   └─ コンピテンシー評価（行動特性・能力評価）
```

### 必要なテーブル設計

#### 17-1. GradeSystem（等級制度マスタ）

**目的**: 将来の等級制度導入に対応。50等級制度×4コースの定義。

```prisma
model GradeSystem {
  id                    String    @id @default(cuid())
  systemCode            String    @unique @map("system_code")
  // 例: "GRADE-50-2026" （50等級制度2026年版）
  systemName            String    @map("system_name")
  // 例: "共通50等級制度"
  effectiveDate         DateTime  @map("effective_date")
  // 適用開始日（2026-10-01）
  endDate               DateTime? @map("end_date")
  // 適用終了日
  totalGrades           Int       @map("total_grades")
  // 等級数（50）
  isActive              Boolean   @default(true) @map("is_active")

  // コース別上限定義（JSON配列）
  courseGradeLimits     Json?     @map("course_grade_limits")
  // [
  //   { "course": "A", "ceiling": 50, "coefficient": 1.2, "label": "全範囲（1-50級）" },
  //   { "course": "B", "ceiling": 40, "coefficient": 1.1, "label": "上限40級" },
  //   { "course": "C", "ceiling": 30, "coefficient": 1.0, "label": "上限30級" },
  //   { "course": "D", "ceiling": 20, "coefficient": 0.9, "label": "上限20級" }
  // ]

  // 等級別詳細定義（JSON配列）
  gradeDefinitions      Json?     @map("grade_definitions")
  // [
  //   { "grade": 1, "minSalary": 180000, "maxSalary": 200000, "title": "初級職員" },
  //   { "grade": 25, "minSalary": 350000, "maxSalary": 400000, "title": "中堅職員" },
  //   { "grade": 50, "minSalary": 800000, "maxSalary": 1000000, "title": "最上級職員" }
  // ]

  description           String?   @map("description")
  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  gradeHistories        EmployeeGradeHistory[]
  competencyTemplates   CompetencyTemplate[]

  @@index([systemCode])
  @@index([isActive])
  @@index([effectiveDate])
  @@map("grade_systems")
}
```

#### 17-2. EmployeeGradeHistory（職員等級履歴）

**目的**: 個人の等級変遷を完全追跡。昇格・降格の理由と評価連動を記録。

```prisma
model EmployeeGradeHistory {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")
  gradeSystemId         String    @map("grade_system_id")

  // 等級情報
  currentGrade          Int       @map("current_grade")
  // 1-50の等級
  previousGrade         Int?      @map("previous_grade")
  // 前回の等級
  gradeChangeType       String?   @map("grade_change_type")
  // promotion（昇格）, demotion（降格）, initial（初回付与）, adjustment（調整）

  // コース情報
  currentCourse         String    @map("current_course")
  // A, B, C, D
  gradeCeiling          Int?      @map("grade_ceiling")
  // 選択コースの上限等級（Aコース=50, Bコース=40等）

  // 日付管理
  effectiveDate         DateTime  @map("effective_date")
  // 適用開始日
  endDate               DateTime? @map("end_date")
  // 適用終了日
  isCurrent             Boolean   @default(true) @map("is_current")

  // 昇格理由・評価連動
  changeReason          String?   @map("change_reason")
  // 定期昇格、特別昇格、評価昇格、試用期間終了等
  linkedEvaluationId    String?   @map("linked_evaluation_id")
  // 評価制度連動（V3Assessment等のID）
  linkedGoalId          String?   @map("linked_goal_id")
  // 目標達成による昇格の場合
  evaluationScore       Float?    @map("evaluation_score")
  // 昇格時の評価点（100点満点等）

  // 給与連動
  estimatedSalaryImpact Float?    @map("estimated_salary_impact")
  // 昇格による給与影響額（円）
  coefficientApplied    Float?    @map("coefficient_applied")
  // 適用された係数（1.2, 1.1, 1.0, 0.9）

  approvedBy            String?   @map("approved_by")
  // 承認者ID
  approvalDate          DateTime? @map("approval_date")
  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])
  gradeSystem           GradeSystem @relation(fields: [gradeSystemId], references: [id])

  @@index([employeeId])
  @@index([gradeSystemId])
  @@index([currentGrade])
  @@index([currentCourse])
  @@index([isCurrent])
  @@index([effectiveDate])
  @@map("employee_grade_histories")
}
```

#### 17-3. CompetencyTemplate（コンピテンシー評価テンプレート）

**目的**: 行動特性・能力評価の項目定義。職種別・等級別のコンピテンシー要件を管理。

```prisma
model CompetencyTemplate {
  id                    String    @id @default(cuid())
  templateCode          String    @unique @map("template_code")
  // 例: "COMP-NURSE-2027" （看護師用2027年版）
  templateName          String    @map("template_name")
  // 例: "看護師コンピテンシー評価（第3段階）"

  // 適用範囲
  targetJobCategory     String?   @map("target_job_category")
  // nurse, doctor, therapist, clerk 等
  targetGradeRange      Json?     @map("target_grade_range")
  // { "min": 1, "max": 50 } または特定等級
  targetCourse          String?   @map("target_course")
  // A, B, C, D のいずれか（null=全コース対象）
  gradeSystemId         String?   @map("grade_system_id")
  // 紐付く等級制度

  // コンピテンシー項目定義（JSON配列）
  competencyItems       Json      @map("competency_items")
  // [
  //   {
  //     "id": "COMP-001",
  //     "category": "対人関係能力",
  //     "itemName": "コミュニケーション",
  //     "description": "患者・家族・多職種と適切に対話できる",
  //     "gradeLevels": {
  //       "1-10": "基本的な挨拶・報告ができる",
  //       "11-25": "状況に応じた説明・調整ができる",
  //       "26-40": "困難な交渉・調整をリードできる",
  //       "41-50": "組織全体のコミュニケーション戦略を立案できる"
  //     },
  //     "weight": 15
  //   },
  //   {
  //     "id": "COMP-002",
  //     "category": "業務遂行能力",
  //     "itemName": "問題解決力",
  //     "description": "課題を発見し、適切な解決策を実行できる",
  //     "gradeLevels": { ... },
  //     "weight": 20
  //   },
  //   ... 他の項目
  // ]

  // 評価基準
  evaluationScale       String?   @map("evaluation_scale")
  // 5段階評価、7段階評価等
  totalWeight           Int?      @map("total_weight")
  // 合計ウェイト（通常100%）
  passingScore          Float?    @map("passing_score")
  // 合格基準点

  effectiveDate         DateTime  @map("effective_date")
  endDate               DateTime? @map("end_date")
  isActive              Boolean   @default(true) @map("is_active")

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  gradeSystem           GradeSystem? @relation(fields: [gradeSystemId], references: [id])
  competencyEvaluations CompetencyEvaluation[]

  @@index([templateCode])
  @@index([targetJobCategory])
  @@index([isActive])
  @@index([effectiveDate])
  @@map("competency_templates")
}
```

#### 17-4. CompetencyEvaluation（コンピテンシー評価記録）

**目的**: 個人のコンピテンシー評価結果を記録。等級昇格判定・育成計画の根拠データ。

```prisma
model CompetencyEvaluation {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")
  competencyTemplateId  String    @map("competency_template_id")

  evaluationPeriod      String    @map("evaluation_period")
  // 2027-Q1, 2027-H1, 2027-Annual等
  evaluationDate        DateTime  @map("evaluation_date")
  evaluatorId           String?   @map("evaluator_id")
  // 評価者ID

  // 評価結果（JSON配列）
  evaluationResults     Json      @map("evaluation_results")
  // [
  //   {
  //     "competencyId": "COMP-001",
  //     "itemName": "コミュニケーション",
  //     "score": 4.5,
  //     "maxScore": 5,
  //     "weight": 15,
  //     "weightedScore": 13.5,
  //     "evaluatorComment": "多職種カンファレンスで積極的に発言し、調整役を担っている",
  //     "behaviorExamples": ["〇〇の場面でリーダーシップを発揮", "△△の困難事例を解決"]
  //   },
  //   { ... 他の項目 }
  // ]

  // 総合評価
  totalScore            Float     @map("total_score")
  // 合計点（100点満点等）
  totalWeightedScore    Float     @map("total_weighted_score")
  // 加重合計点
  competencyGrade       String?   @map("competency_grade")
  // S+, S, A+, A, B, C, D 等
  overallRanking        String?   @map("overall_ranking")
  // top20%, middle60%, support20%

  // 強み・弱み分析
  topStrengths          Json?     @map("top_strengths")
  // [{ "item": "コミュニケーション", "score": 4.8 }, ...]
  improvementAreas      Json?     @map("improvement_areas")
  // [{ "item": "リーダーシップ", "score": 2.5, "action": "研修受講推奨" }, ...]

  // 昇格判定
  isPromotionRecommended Boolean? @default(false) @map("is_promotion_recommended")
  recommendedNextGrade  Int?      @map("recommended_next_grade")
  promotionReadiness    String?   @map("promotion_readiness")
  // ready（準備完了）, developing（育成中）, needs_support（支援必要）

  // 育成計画連携
  developmentPriorities Json?     @map("development_priorities")
  // [
  //   { "competency": "問題解決力", "priority": "high", "targetScore": 4.0, "method": "OJT + 研修" },
  //   ...
  // ]
  linkedGoalIds         Json?     @map("linked_goal_ids")
  // 連動する目標管理のID配列

  evaluatorComment      String?   @map("evaluator_comment")
  selfAssessmentComment String?   @map("self_assessment_comment")
  // 本人の自己評価コメント

  status                String    @default("draft") @map("status")
  // draft, submitted, approved, finalized
  approvedBy            String?   @map("approved_by")
  approvalDate          DateTime? @map("approval_date")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])
  competencyTemplate    CompetencyTemplate @relation(fields: [competencyTemplateId], references: [id])

  @@index([employeeId])
  @@index([competencyTemplateId])
  @@index([evaluationPeriod])
  @@index([competencyGrade])
  @@index([isPromotionRecommended])
  @@map("competency_evaluations")
}
```

#### 17-5. Goal（目標管理・OKR）- 既存拡張

**目的**: 既存の目標管理を等級制度・コンピテンシー評価と完全連動させる。

```prisma
model Goal {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 基本情報（既存）
  goalTitle             String    @map("goal_title")
  goalDescription       String?   @map("goal_description")
  goalCategory          String    @map("goal_category")
  // スキル開発、キャリア開発、業務改善、組織貢献等

  // OKR（Objectives & Key Results）
  keyResults            Json?     @map("key_results")
  // [
  //   { "id": "kr1", "title": "静脈注射成功率", "targetValue": 95, "currentValue": 88, "unit": "%" },
  //   { "id": "kr2", "title": "研修時間", "targetValue": 40, "currentValue": 26, "unit": "時間" }
  // ]

  // 期間管理
  fiscalYear            Int?      @map("fiscal_year")
  // 年度（2027）
  period                String?   @map("period")
  // annual, semi-annual, quarterly, monthly
  startDate             DateTime  @map("start_date")
  targetDate            DateTime  @map("target_date")
  completionDate        DateTime? @map("completion_date")

  // 進捗管理
  status                String    @default("active") @map("status")
  // active, completed, paused, cancelled
  progressPercent       Float     @default(0) @map("progress_percent")
  // 0-100%
  lastUpdatedProgress   DateTime? @map("last_updated_progress")

  // 🆕 等級制度連動
  linkedGradeHistoryId  String?   @map("linked_grade_history_id")
  // 昇格に紐づく目標の場合
  targetGrade           Int?      @map("target_grade")
  // この目標達成で到達したい等級
  isPromotionLinked     Boolean   @default(false) @map("is_promotion_linked")
  // 昇格要件に含まれるか

  // 🆕 コンピテンシー連動
  linkedCompetencyIds   Json?     @map("linked_competency_ids")
  // この目標が育成対象とするコンピテンシー項目ID配列
  // ["COMP-001", "COMP-003"] 等
  targetCompetencyScore Float?    @map("target_competency_score")
  // 目標達成時に期待されるコンピテンシースコア

  // 🆕 100点満点評価連動
  evaluationWeight      Float?    @map("evaluation_weight")
  // この目標の評価全体への寄与度（%）
  achievementScore      Float?    @map("achievement_score")
  // 達成度に基づく評価点（100点満点）
  evaluationGrade       String?   @map("evaluation_grade")
  // S+, S, A+, A, B, C, D

  // 評価・レビュー
  reviewerId            String?   @map("reviewer_id")
  reviewDate            DateTime? @map("review_date")
  reviewComment         String?   @map("review_comment")
  nextTermSuggestion    String?   @map("next_term_suggestion")
  // 次期目標への提言

  // 承認フロー
  submittedDate         DateTime? @map("submitted_date")
  approvedBy            String?   @map("approved_by")
  approvalDate          DateTime? @map("approval_date")

  priority              String?   @default("medium") @map("priority")
  // high, medium, low
  isPublic              Boolean   @default(false) @map("is_public")
  // 他職員への公開可否

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([fiscalYear])
  @@index([status])
  @@index([isPromotionLinked])
  @@index([targetDate])
  @@map("goals")
}
```

---

### Employeeテーブルへの拡張フィールド

既存のEmployeeテーブルに以下を追加：

```prisma
model Employee {
  // ... 既存フィールド ...

  // 🆕 等級情報
  currentGrade          Int?      @map("current_grade")
  // 現在の等級（1-50）
  currentCourse         String?   @map("current_course")
  // 現在のコース（A/B/C/D）
  gradeCeiling          Int?      @map("grade_ceiling")
  // コース上限等級
  gradeCoefficient      Float?    @map("grade_coefficient")
  // 給与係数（1.2/1.1/1.0/0.9）

  // 🆕 評価・パフォーマンス層
  currentEvaluationGrade String?  @map("current_evaluation_grade")
  // 最新の評価グレード（S+/S/A+/A/B/C/D）
  performanceLayer      String?   @map("performance_layer")
  // top20%, middle60%, support20%
  lastEvaluationDate    DateTime? @map("last_evaluation_date")

  // 🆕 コンピテンシー総合スコア
  latestCompetencyScore Float?    @map("latest_competency_score")
  // 最新のコンピテンシー総合点
  competencyGrade       String?   @map("competency_grade")
  // コンピテンシー評価グレード

  // Relations
  gradeHistories        EmployeeGradeHistory[]
  competencyEvaluations CompetencyEvaluation[]
  goals                 Goal[]

  // ... 既存Relations ...
}
```

---

### 設計のポイント

#### 1. **段階的導入への完全対応**
- 第1段階（2026年4月）: Goalテーブルのみ使用（OKR機能）
- 第2段階（2026年10月）: GradeSystem + EmployeeGradeHistory追加
- 第3段階（2027年4月）: CompetencyTemplate + CompetencyEvaluation追加

#### 2. **柔軟な等級制度定義**
```json
// 50等級以外も対応可能（例: 100等級制度）
{
  "systemCode": "GRADE-100-2028",
  "totalGrades": 100,
  "courseGradeLimits": [
    { "course": "A", "ceiling": 100 },
    { "course": "B", "ceiling": 80 }
  ]
}
```

#### 3. **あらゆる目標管理に対応**
- ✅ 基本的なOKR（現在）
- ✅ 等級昇格目標（第2段階）
- ✅ コンピテンシー育成目標（第3段階）
- ✅ 100点満点評価連動（第3段階）

#### 4. **コンピテンシー項目の完全カスタマイズ**
```json
// 職種別・等級別に異なるコンピテンシー定義が可能
{
  "templateCode": "COMP-DOCTOR-HIGH",
  "targetJobCategory": "doctor",
  "targetGradeRange": { "min": 41, "max": 50 },
  "competencyItems": [
    {
      "itemName": "診療方針決定",
      "description": "複雑な症例の治療方針を独自に判断できる",
      "weight": 25
    }
  ]
}
```

---

### 実装パターン例

#### パターン1: 基本的な目標設定（第1段階）
```typescript
// 2026年4月 - OKRのみ
const goal = await prisma.goal.create({
  data: {
    employeeId: "emp-001",
    goalTitle: "看護技術向上計画",
    goalCategory: "スキル開発",
    keyResults: [
      { title: "静脈注射成功率", targetValue: 95, currentValue: 88, unit: "%" }
    ],
    startDate: new Date("2026-04-01"),
    targetDate: new Date("2026-09-30")
  }
});
```

#### パターン2: 等級昇格目標（第2段階）
```typescript
// 2026年10月 - 等級連動
const promotionGoal = await prisma.goal.create({
  data: {
    employeeId: "emp-001",
    goalTitle: "25級昇格のための専門性強化",
    isPromotionLinked: true,
    targetGrade: 25,
    linkedGradeHistoryId: "grade-hist-123",
    keyResults: [...],
    startDate: new Date("2026-10-01"),
    targetDate: new Date("2027-03-31")
  }
});
```

#### パターン3: コンピテンシー育成目標（第3段階）
```typescript
// 2027年4月 - コンピテンシー連動
const competencyGoal = await prisma.goal.create({
  data: {
    employeeId: "emp-001",
    goalTitle: "リーダーシップコンピテンシー向上",
    linkedCompetencyIds: ["COMP-005", "COMP-008"],
    targetCompetencyScore: 4.5,
    evaluationWeight: 30, // 評価全体の30%を占める
    keyResults: [...],
    startDate: new Date("2027-04-01"),
    targetDate: new Date("2027-09-30")
  }
});
```

---

### まとめ

この設計により、以下が実現できます：

✅ **現在（基本的OKR）から第3段階（完成形）まで完全対応**
✅ **50等級制度×4コース×7段階評価の複雑な組み合わせを管理**
✅ **職種別・等級別のコンピテンシー評価を柔軟に定義**
✅ **目標管理と昇格判定を完全連動**
✅ **100点満点評価制度への対応**
✅ **上位20%/中間60%/要支援20%の層別管理**

**等級制度の詳細が決まっていなくても、この設計があればあらゆるパターンに対応可能です。**

---

## 📝 更新履歴

| 日付 | 更新内容 | 更新者 |
|------|---------|--------|
| 2025-10-08 14:00 | 初版作成（15項目の不足項目を洗い出し） | 医療システムチーム |
| 2025-10-08 14:30 | Employeeテーブルに出身地フィールド追加（hometown, birthplace） | 医療システムチーム |
| 2025-10-08 15:00 | 実績・成果管理テーブル（Achievement）を追加（Priority 2） | 医療システムチーム |
| 2025-10-08 15:15 | キャリアコース選択制度テーブル4種追加（Phase5設計を反映）| 医療システムチーム |
| 2025-10-08 15:30 | 職員マインド・志向性プロファイルテーブル追加（全フィールドOptional） | 医療システムチーム |
| 2025-10-08 16:00 | EmployeeSkillテーブルに経験年数・目標・習得日フィールド追加 | 医療システムチーム |
| 2025-10-08 16:15 | クリニカルラダー評価テーブル追加（日本看護協会版準拠、5段階・4能力軸） | 医療システムチーム |
| 2025-10-08 16:30 | 学会・職能団体加入情報テーブル追加（会費支払い・役職管理含む） | 医療システムチーム |
| 2025-10-08 16:45 | 業務実績指標・組織貢献度・プロジェクト参加履歴テーブル追加（VoiceDrive連携対応） | 医療システムチーム |
| 2025-10-08 17:00 | 勤務パターン分析・業務出張履歴テーブル追加（WLBスコア・勤務安定性評価含む） | 医療システムチーム |
| 2025-10-08 17:15 | HealthRecordテーブル拡張・ストレスチェック・メンタルヘルス相談テーブル追加 | 医療システムチーム |
| 2025-10-08 17:30 | 健診詳細検査結果・病歴・服薬・アレルギー情報テーブル追加（就労配慮対応） | 医療システムチーム |
| 2025-10-08 17:45 | 能力評価・V3評価・メンタリング関係テーブル追加（評価育成体系完備） | 医療システムチーム |
| 2025-10-08 18:00 | Interviewテーブル拡張（NotebookLM連携・AI分析・サマリ作成機能追加） | 医療システムチーム |
| 2025-10-08 18:15 | Interviewテーブルにサポート面談専用フィールド追加（担当者役割・資格・サポート分野分類） | 医療システムチーム |
| 2025-10-08 18:30 | V3Assessmentテーブル大幅拡張（技術評価・組織貢献度詳細、レーダーチャート、順位情報、AI指導支援） + V3AssessmentCommentテーブル新規追加 | 医療システムチーム |
| 2025-10-08 18:45 | TrainingEffectTrackingテーブル新規追加（研修前後スコア比較・ROI測定・効果持続性）+ SkillRadarAssessmentテーブル新規追加（8軸スキル評価・部門平均比較・強み自動判定） | 医療システムチーム |
| 2025-10-08 19:00 | IntegratedGrowthTimelineテーブル新規追加（全システム統合タイムライン・マイルストーン管理・AI分析）+ TalentPortfolioAnalysisテーブル新規追加（9マス人材マトリクス・スキル×パフォーマンス分析）+ GrowthPredictionテーブル新規追加（ML成長予測・昇進可能性・リスク予測） | 医療システムチーム |
| 2025-10-08 19:15 | OnboardingProgressテーブル新規追加（4ステップ進捗管理・チェックリスト）+ AssignmentHistoryテーブル新規追加（配属履歴・評価・異動理由・獲得スキル）+ FitnessAssessmentテーブル新規追加（8軸適性評価・強み特定）+ CareerDevelopmentPlanテーブル新規追加（希望専門分野・キャリア目標・メンターシップ・昇進準備）+ Employeeテーブル採用情報拡張（採用区分・試用期間・勤続年数） | 医療システムチーム |
| 2025-10-08 19:30 | SkillDevelopmentPlanテーブル新規追加（スキル単位育成計画・現在→目標スコア・進捗率自動計算・マイルストーン・昇進連携） | 医療システムチーム |
| 2025-10-08 20:00 | TrainingProgram（研修プログラム・法定/企画/必須研修の定義）+ TrainingSession（実施セッション・日程管理）+ TrainingHistory（詳細受講履歴・申込→完了ステータス・効果測定）+ TrainingPlan（年間研修計画・評価連動）+ TrainingEffectAnalysis（ROI分析・施設部署別効果測定）テーブル新規追加 - 既存Trainingテーブルを大幅拡張した教育研修管理システム完全対応 | 医療システムチーム |
| 2025-10-08 20:30 | GradeSystem（等級制度マスタ・50等級×4コース定義）+ EmployeeGradeHistory（等級履歴・昇格降格理由・給与連動）+ CompetencyTemplate（コンピテンシーテンプレート・職種別等級別行動特性評価）+ CompetencyEvaluation（コンピテンシー評価記録・強み弱み分析・昇格判定）+ Goal拡張（OKR・等級連動・コンピテンシー連動・100点満点評価対応）+ Employee拡張（等級情報・評価グレード・パフォーマンス層）テーブル追加 - 第1段階（OKR）→第2段階（50等級制度）→第3段階（100点満点評価+コンピテンシー）の段階的導入に完全対応 | 医療システムチーム |
| 2025-10-08 21:00 | StressCheckRecord（57項目詳細記録・経年変化自動比較・高ストレス判定）+ InterviewGuidance（医師面接指導・就業措置記録・VoiceDrive連携）+ HealthRiskAssessment（健診×ストレス×メンタル統合評価・総合リスク自動判定）+ HealthGuidance（保健指導記録・生活習慣改善支援・効果測定）+ GroupStressAnalysis（集団分析・職場環境改善策・衛生委員会報告）+ Employee拡張（ストレスレベル・健診結果・健康リスク）テーブル追加 - 労働安全衛生法完全準拠・個人レベル完全追跡・予防的介入対応 | 医療システムチーム |
| 2025-10-08 21:30 | AttendanceRecord拡張（VoiceDriveシフトID連携・予定実績差異自動計算・遅刻早退判定）+ LeaveApplication（休暇申請承認ワークフロー・VoiceDrive通知・代替要員手配）+ PaidLeaveBalance（有給残高自動計算・法定5日義務管理・失効アラート）+ OvertimeManagement（36協定完全管理・月45h年360h上限・特別条項・複数月平均80h・産業医面接自動設定）+ WorkScheduleVariation（1ヶ月単位変形労働時間制・夜勤日勤パターン管理）+ Employee拡張（残業時間・有給残日数・各種アラート）テーブル追加 - 労働基準法完全準拠・VoiceDrive完全連携・医療機関特有勤務形態対応 | 医療システムチーム |

---

## 19. 勤怠管理システム・VoiceDrive連携（シフト実績統合）

### 背景と要件
- 現在の実装: 基本的な出退勤記録のみ（サンプルデータ）
- **VoiceDrive**: シフト管理システム（予定）を既に稼働中
- **不足項目**: 予定シフト vs 実績勤怠の差異管理、休暇申請承認、36協定管理
- **法令要件**: 労働基準法、36協定、年次有給休暇管理義務

### 現状の問題点
```
❌ VoiceDrive（シフト予定）と勤怠実績が分離
❌ 予定 vs 実績の差異分析ができない
❌ 休暇申請・承認ワークフローが未整備
❌ 36協定の上限管理（月45h/年360h）が未対応
❌ 有給休暇の自動付与・残日数管理が未対応
❌ 変形労働時間制（医療機関特有）への対応なし
```

### 必要なテーブル設計

#### 19-1. AttendanceRecord（勤怠実績記録）- 既存拡張

**目的**: VoiceDriveのシフト予定と連携し、実績勤怠を記録。予定との差異を管理。

```prisma
model AttendanceRecord {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 勤務日情報
  workDate              DateTime  @map("work_date")
  // 勤務日
  fiscalYear            Int?      @map("fiscal_year")
  fiscalMonth           Int?      @map("fiscal_month")
  dayOfWeek             String?   @map("day_of_week")
  // 月, 火, 水, 木, 金, 土, 日

  // 🆕 VoiceDrive連携（シフト予定との紐付け）
  voicedriveShiftId     String?   @map("voicedrive_shift_id")
  // VoiceDriveシフトID
  scheduledShiftType    String?   @map("scheduled_shift_type")
  // day（日勤）, night（夜勤）, evening（準夜勤）, off（休み）
  scheduledStartTime    String?   @map("scheduled_start_time")
  // 予定出勤時刻
  scheduledEndTime      String?   @map("scheduled_end_time")
  // 予定退勤時刻

  // 実績打刻
  actualCheckIn         DateTime? @map("actual_check_in")
  // 実際の出勤打刻
  actualCheckOut        DateTime? @map("actual_check_out")
  // 実際の退勤打刻
  actualShiftType       String?   @map("actual_shift_type")
  // 実際のシフト種別

  // 🆕 予定との差異分析
  startTimeDifference   Int?      @map("start_time_difference")
  // 出勤時刻差（分）※正=遅刻、負=早出
  endTimeDifference     Int?      @map("end_time_difference")
  // 退勤時刻差（分）※正=早退、負=残業
  isLate                Boolean   @default(false) @map("is_late")
  // 遅刻フラグ
  isEarlyLeave          Boolean   @default(false) @map("is_early_leave")
  // 早退フラグ

  // 勤務時間計算
  breakTime             Int?      @map("break_time")
  // 休憩時間（分）
  actualWorkingMinutes  Int?      @map("actual_working_minutes")
  // 実労働時間（分）
  scheduledWorkingMinutes Int?    @map("scheduled_working_minutes")
  // 予定労働時間（分）

  // 残業管理
  overtimeMinutes       Int?      @map("overtime_minutes")
  // 残業時間（分）
  overtimeApproved      Boolean   @default(false) @map("overtime_approved")
  // 残業承認済み
  overtimeApprovalId    String?   @map("overtime_approval_id")
  // 残業申請ID
  isExcessiveOvertime   Boolean   @default(false) @map("is_excessive_overtime")
  // 過重労働フラグ（月45h超え）

  // 夜勤・深夜勤務
  nightShiftMinutes     Int?      @map("night_shift_minutes")
  // 夜勤時間（22:00-5:00の分数）
  midnightWorkMinutes   Int?      @map("midnight_work_minutes")
  // 深夜勤務時間（分）

  // 勤怠ステータス
  attendanceStatus      String    @map("attendance_status")
  // normal（正常）, late（遅刻）, early_leave（早退）, absent（欠勤）,
  // paid_leave（有給）, sick_leave（病欠）, special_leave（特別休暇）

  // 欠勤・休暇
  isAbsent              Boolean   @default(false) @map("is_absent")
  absentReason          String?   @map("absent_reason")
  leaveApplicationId    String?   @map("leave_application_id")
  // 休暇申請ID

  // 備考・修正
  remarks               String?   @map("remarks")
  isCorrected           Boolean   @default(false) @map("is_corrected")
  // 打刻修正有無
  correctionReason      String?   @map("correction_reason")
  correctedBy           String?   @map("corrected_by")
  correctionDate        DateTime? @map("correction_date")

  // 承認
  approvedBy            String?   @map("approved_by")
  approvalDate          DateTime? @map("approval_date")
  approvalStatus        String    @default("pending") @map("approval_status")
  // pending, approved, rejected

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])
  leaveApplication      LeaveApplication? @relation(fields: [leaveApplicationId], references: [id])

  @@index([employeeId])
  @@index([workDate])
  @@index([fiscalYear, fiscalMonth])
  @@index([voicedriveShiftId])
  @@index([attendanceStatus])
  @@index([approvalStatus])
  @@map("attendance_records")
}
```

#### 19-2. LeaveApplication（休暇申請）

**目的**: 年次有給休暇、特別休暇、病気休暇などの申請・承認ワークフローを管理。

```prisma
model LeaveApplication {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 申請情報
  leaveType             String    @map("leave_type")
  // paid_leave（年休）, sick_leave（病欠）, special_leave（特別休暇）,
  // maternity_leave（産休）, childcare_leave（育休）, condolence_leave（忌引）

  leaveCategory         String?   @map("leave_category")
  // full_day（全日）, half_day_am（午前半休）, half_day_pm（午後半休）, hourly（時間休）

  // 期間
  startDate             DateTime  @map("start_date")
  endDate               DateTime  @map("end_date")
  totalDays             Float     @map("total_days")
  // 0.5（半日）, 1.0（全日）, 複数日の場合は合計
  totalHours            Float?    @map("total_hours")
  // 時間休の場合

  // 理由
  reason                String    @map("reason")
  // 申請理由
  isEmergency           Boolean   @default(false) @map("is_emergency")
  // 緊急休暇フラグ

  // 🆕 有給休暇計算
  paidLeaveBalance      Float?    @map("paid_leave_balance")
  // 申請時点の有給残日数
  paidLeaveAfter        Float?    @map("paid_leave_after")
  // 申請後の有給残日数

  // 🆕 VoiceDrive連携
  affectedShiftIds      Json?     @map("affected_shift_ids")
  // 影響を受けるVoiceDriveシフトID配列
  // ["shift-001", "shift-002"]
  voicedriveNotified    Boolean   @default(false) @map("voicedrive_notified")
  // VoiceDriveへの通知済みフラグ

  // 代替要員手配
  substituteRequired    Boolean   @default(false) @map("substitute_required")
  // 代替要員必要
  substituteEmployeeId  String?   @map("substitute_employee_id")
  substituteArranged    Boolean   @default(false) @map("substitute_arranged")

  // 承認ワークフロー
  approvalStatus        String    @default("pending") @map("approval_status")
  // pending（申請中）, approved（承認）, rejected（却下）, cancelled（取消）

  approverLevel1Id      String?   @map("approver_level1_id")
  // 第1承認者（直属上司）
  approvalDate1         DateTime? @map("approval_date1")
  approvalComment1      String?   @map("approval_comment1")

  approverLevel2Id      String?   @map("approver_level2_id")
  // 第2承認者（部門長）
  approvalDate2         DateTime? @map("approval_date2")
  approvalComment2      String?   @map("approval_comment2")

  finalApprover         String?   @map("final_approver")
  finalApprovalDate     DateTime? @map("final_approval_date")

  rejectionReason       String?   @map("rejection_reason")
  cancelReason          String?   @map("cancel_reason")
  cancelledBy           String?   @map("cancelled_by")
  cancellationDate      DateTime? @map("cancellation_date")

  // 申請メタ情報
  applicationDate       DateTime  @default(now()) @map("application_date")
  isRetroactive         Boolean   @default(false) @map("is_retroactive")
  // 事後申請フラグ

  attachments           Json?     @map("attachments")
  // 添付ファイル（診断書等）
  // [{ "type": "medical_certificate", "url": "...", "filename": "..." }]

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])
  attendanceRecords     AttendanceRecord[]

  @@index([employeeId])
  @@index([leaveType])
  @@index([approvalStatus])
  @@index([startDate])
  @@index([applicationDate])
  @@map("leave_applications")
}
```

#### 19-3. PaidLeaveBalance（有給休暇残高管理）

**目的**: 職員ごとの有給休暇の付与・消化・残高を自動計算・管理。

```prisma
model PaidLeaveBalance {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 年度管理
  fiscalYear            Int       @map("fiscal_year")
  // 年度（2024, 2025...）
  grantDate             DateTime  @map("grant_date")
  // 付与日（入社日 or 基準日）

  // 付与日数
  grantedDays           Float     @map("granted_days")
  // 付与日数（入社年数により10-20日）
  carryOverDays         Float     @default(0) @map("carry_over_days")
  // 前年繰越日数（最大20日）
  totalAvailableDays    Float     @map("total_available_days")
  // 利用可能合計（付与+繰越）

  // 消化実績
  usedDays              Float     @default(0) @map("used_days")
  // 使用済み日数
  remainingDays         Float     @map("remaining_days")
  // 残日数
  expiringDays          Float?    @map("expiring_days")
  // 年度末失効予定日数

  // 🆕 半日・時間休対応
  usedHalfDays          Float     @default(0) @map("used_half_days")
  // 半日休使用回数
  usedHourlyLeave       Float     @default(0) @map("used_hourly_leave")
  // 時間休使用時間

  // 法定取得義務（年5日）
  mandatoryUseDays      Int       @default(5) @map("mandatory_use_days")
  // 法定取得義務日数
  mandatoryUsed         Float     @default(0) @map("mandatory_used")
  // 義務取得済み日数
  mandatoryRemaining    Int       @map("mandatory_remaining")
  // 義務取得残日数（自動計算: 5 - mandatoryUsed）

  // アラート
  isLowBalance          Boolean   @default(false) @map("is_low_balance")
  // 残日数少（5日以下）
  isMandatoryAlert      Boolean   @default(false) @map("is_mandatory_alert")
  // 義務取得未達成アラート（年度末3ヶ月前）
  isExpiryAlert         Boolean   @default(false) @map("is_expiry_alert")
  // 失効警告（年度末1ヶ月前）

  // 次年度繰越計算
  nextYearCarryOver     Float?    @map("next_year_carry_over")
  // 次年度繰越予定（最大20日）
  nextYearExpiry        Float?    @map("next_year_expiry")
  // 次年度失効予定

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, fiscalYear])
  @@index([employeeId])
  @@index([fiscalYear])
  @@index([isMandatoryAlert])
  @@index([isExpiryAlert])
  @@map("paid_leave_balances")
}
```

#### 19-4. OvertimeManagement（残業管理・36協定）

**目的**: 36協定の上限管理（月45h/年360h）、特別条項の適用を完全管理。

```prisma
model OvertimeManagement {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 期間管理
  fiscalYear            Int       @map("fiscal_year")
  fiscalMonth           Int       @map("fiscal_month")
  targetMonth           String    @map("target_month")
  // 2025-10

  // 🆕 36協定基準
  standardLimitMonthly  Int       @default(45) @map("standard_limit_monthly")
  // 月45時間（原則）
  standardLimitYearly   Int       @default(360) @map("standard_limit_yearly")
  // 年360時間（原則）

  // 🆕 特別条項
  specialClauseLimitMonthly Int?   @map("special_clause_limit_monthly")
  // 特別条項上限（月100時間未満）
  specialClauseLimitYearly  Int?   @map("special_clause_limit_yearly")
  // 特別条項上限（年720時間）
  specialClauseApplied  Boolean   @default(false) @map("special_clause_applied")
  specialClauseReason   String?   @map("special_clause_reason")
  // 特別条項適用理由

  // 実績集計
  totalOvertimeMinutes  Int       @default(0) @map("total_overtime_minutes")
  // 月間残業時間（分）
  totalOvertimeHours    Float     @map("total_overtime_hours")
  // 月間残業時間（時間）※自動計算
  yearlyOvertimeHours   Float?    @map("yearly_overtime_hours")
  // 年間累計残業時間

  // 🆕 複数月平均（2-6ヶ月平均80h制限）
  average2Months        Float?    @map("average_2_months")
  average3Months        Float?    @map("average_3_months")
  average4Months        Float?    @map("average_4_months")
  average5Months        Float?    @map("average_5_months")
  average6Months        Float?    @map("average_6_months")

  // アラート管理
  isOver45Hours         Boolean   @default(false) @map("is_over_45_hours")
  // 月45h超過
  isOver80Hours         Boolean   @default(false) @map("is_over_80_hours")
  // 月80h超過（過労死ライン）
  isOver100Hours        Boolean   @default(false) @map("is_over_100_hours")
  // 月100h超過（違法）
  isAverageViolation    Boolean   @default(false) @map("is_average_violation")
  // 複数月平均80h違反

  alertLevel            String?   @map("alert_level")
  // safe（安全）, warning（警告）, danger（危険）, critical（違法）
  alertMessage          String?   @map("alert_message")

  // 🆕 医師面接指導（月80h超過時の義務）
  requiresDoctorInterview Boolean @default(false) @map("requires_doctor_interview")
  // 産業医面接必要フラグ
  doctorInterviewCompleted Boolean @default(false) @map("doctor_interview_completed")
  interviewDate         DateTime? @map("interview_date")

  // 承認管理
  monthlyApprovalStatus String    @default("pending") @map("monthly_approval_status")
  // pending, approved, rejected
  approvedBy            String?   @map("approved_by")
  approvalDate          DateTime? @map("approval_date")

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, fiscalYear, fiscalMonth])
  @@index([employeeId])
  @@index([fiscalYear])
  @@index([isOver45Hours])
  @@index([isOver80Hours])
  @@index([requiresDoctorInterview])
  @@map("overtime_managements")
}
```

#### 19-5. WorkScheduleVariation（変形労働時間制管理）

**目的**: 医療機関特有の1ヶ月単位変形労働時間制に対応。夜勤・日勤の組み合わせ管理。

```prisma
model WorkScheduleVariation {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 適用期間
  fiscalYear            Int       @map("fiscal_year")
  fiscalMonth           Int       @map("fiscal_month")
  variationPeriod       String    @map("variation_period")
  // 2025-10 (1ヶ月単位)

  // 変形労働時間制の種類
  variationType         String    @map("variation_type")
  // one_month（1ヶ月単位）, one_year（1年単位）, flex_time（フレックスタイム）

  // 所定労働時間設定
  totalScheduledHours   Float     @map("total_scheduled_hours")
  // 期間内総所定労働時間
  averageDailyHours     Float?    @map("average_daily_hours")
  // 1日平均所定労働時間
  totalWorkingDays      Int       @map("total_working_days")
  // 期間内所定労働日数

  // 🆕 シフトパターン管理
  shiftPattern          Json      @map("shift_pattern")
  // {
  //   "week1": ["day", "day", "night", "night", "off", "off", "off"],
  //   "week2": ["day", "day", "day", "night", "night", "off", "off"],
  //   ...
  // }

  dayShiftCount         Int?      @map("day_shift_count")
  // 日勤回数
  nightShiftCount       Int?      @map("night_shift_count")
  // 夜勤回数
  eveningShiftCount     Int?      @map("evening_shift_count")
  // 準夜勤回数

  // 法定労働時間との比較
  legalWorkingHours     Float     @map("legal_working_hours")
  // 法定労働時間（週40h × 期間の週数 ÷ 7 × 総日数）
  excessHours           Float?    @map("excess_hours")
  // 超過時間（総所定 - 法定）

  // 実績集計
  actualWorkedHours     Float?    @map("actual_worked_hours")
  // 実労働時間
  actualOvertimeHours   Float?    @map("actual_overtime_hours")
  // 実残業時間（実労働 - 総所定）

  // 休日・休暇
  totalRestDays         Int       @map("total_rest_days")
  // 休日日数
  legalHolidays         Int?      @map("legal_holidays")
  // 法定休日日数
  statutoryHolidays     Int?      @map("statutory_holidays")
  // 法定外休日日数

  // 承認
  approvalStatus        String    @default("pending") @map("approval_status")
  approvedBy            String?   @map("approved_by")
  approvalDate          DateTime? @map("approval_date")

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, variationPeriod])
  @@index([employeeId])
  @@index([fiscalYear, fiscalMonth])
  @@index([variationType])
  @@map("work_schedule_variations")
}
```

---

### Employeeテーブルへの拡張フィールド

既存のEmployeeテーブルに以下を追加：

```prisma
model Employee {
  // ... 既存フィールド ...

  // 🆕 勤怠管理情報
  currentOvertimeHours  Float?    @default(0) @map("current_overtime_hours")
  // 今月の残業時間
  yearlyOvertimeHours   Float?    @default(0) @map("yearly_overtime_hours")
  // 年間累計残業時間
  paidLeaveRemaining    Float?    @map("paid_leave_remaining")
  // 有給残日数
  mandatoryLeaveRemaining Int?    @map("mandatory_leave_remaining")
  // 法定取得義務残日数

  isOvertimeAlert       Boolean   @default(false) @map("is_overtime_alert")
  // 残業アラート（45h超え）
  isPaidLeaveAlert      Boolean   @default(false) @map("is_paid_leave_alert")
  // 有給取得義務アラート

  // Relations
  attendanceRecords     AttendanceRecord[]
  leaveApplications     LeaveApplication[]
  paidLeaveBalances     PaidLeaveBalance[]
  overtimeManagements   OvertimeManagement[]
  workScheduleVariations WorkScheduleVariation[]

  // ... 既存Relations ...
}
```

---

### 設計のポイント

#### 1. **VoiceDrive完全連携**
```typescript
// シフト予定 vs 勤怠実績の差異を自動計算
const attendance = await prisma.attendanceRecord.create({
  data: {
    employeeId: "emp-001",
    voicedriveShiftId: "shift-12345",
    scheduledStartTime: "09:00",
    actualCheckIn: "09:15",  // 15分遅刻
    startTimeDifference: 15,
    isLate: true
  }
});
```

#### 2. **36協定自動管理**
```typescript
// 月45h超過で自動アラート
const overtime = await calculateMonthlyOvertime(employeeId, "2025-10");
if (overtime.totalOvertimeHours > 45) {
  await prisma.overtimeManagement.update({
    where: { id: overtime.id },
    data: {
      isOver45Hours: true,
      alertLevel: "warning",
      specialClauseApplied: true,  // 特別条項適用
      specialClauseReason: "業務繁忙期"
    }
  });
}
```

#### 3. **有給休暇自動管理**
```typescript
// 有給申請で残日数を自動更新
const leave = await prisma.leaveApplication.create({
  data: {
    employeeId: "emp-001",
    leaveType: "paid_leave",
    totalDays: 1.0,
    paidLeaveBalance: 15.0,      // 申請前
    paidLeaveAfter: 14.0         // 申請後（自動計算）
  }
});

// PaidLeaveBalanceも自動更新
await updatePaidLeaveBalance(employeeId, -1.0);
```

#### 4. **法定取得義務（年5日）アラート**
```typescript
// 年度末3ヶ月前にアラート
const balance = await prisma.paidLeaveBalance.findUnique({
  where: { employeeId_fiscalYear: { employeeId: "emp-001", fiscalYear: 2025 } }
});

if (balance.mandatoryRemaining > 0 && isWithin3MonthsOfYearEnd()) {
  await sendMandatoryLeaveAlert(employeeId);
}
```

---

### 実装パターン例

#### パターン1: 休暇申請とVoiceDrive連携
```typescript
// 休暇申請 → 承認 → VoiceDriveシフト削除
const leaveApp = await prisma.leaveApplication.create({
  data: {
    employeeId: "emp-001",
    leaveType: "paid_leave",
    startDate: "2025-11-10",
    endDate: "2025-11-12",
    totalDays: 3.0,
    affectedShiftIds: ["shift-100", "shift-101", "shift-102"],
    approvalStatus: "approved"
  }
});

// VoiceDriveに通知 → シフト削除
await notifyVoiceDrive({
  type: "leave_approved",
  employeeId: "emp-001",
  shiftIds: leaveApp.affectedShiftIds,
  action: "delete_shifts"
});
```

#### パターン2: 残業80h超過で産業医面接自動設定
```typescript
// 月80h超過を検知
if (overtime.totalOvertimeHours >= 80) {
  await prisma.overtimeManagement.update({
    where: { id: overtime.id },
    data: {
      isOver80Hours: true,
      requiresDoctorInterview: true,
      alertLevel: "danger"
    }
  });

  // 産業医面接を自動予約
  await scheduleOccupationalDoctorInterview(employeeId);
}
```

#### パターン3: 変形労働時間制の適用
```typescript
// 1ヶ月単位変形労働時間制
const variation = await prisma.workScheduleVariation.create({
  data: {
    employeeId: "emp-001",
    variationType: "one_month",
    variationPeriod: "2025-11",
    shiftPattern: {
      week1: ["day", "day", "night", "night", "off", "off", "off"],
      week2: ["day", "day", "day", "night", "night", "off", "off"]
    },
    dayShiftCount: 10,
    nightShiftCount: 6,
    totalScheduledHours: 160.0
  }
});
```

---

### まとめ

この設計により、以下が実現できます：

✅ **VoiceDrive完全連携**
- シフト予定 vs 勤怠実績の差異管理
- 休暇申請時の自動シフト調整

✅ **36協定完全遵守**
- 月45h/年360h上限管理
- 特別条項適用管理
- 複数月平均80h制限

✅ **有給休暇自動管理**
- 残日数自動計算
- 法定取得義務（年5日）アラート
- 繰越・失効管理

✅ **医療機関特有の勤務形態対応**
- 1ヶ月単位変形労働時間制
- 夜勤・日勤組み合わせ管理
- 月80h超過時の産業医面接自動設定

**法令遵守しながら、VoiceDriveと完全連携した勤怠管理が可能になります！**

---

## 20. キャリアコース選択制度管理システム（Phase 5実装済み・将来拡張対応）

### 背景と要件
- 現在の実装: **Phase 5-2完全実装済み** - A～D 4コースの定義・職員割り当て・変更申請審査機能
- TypeScript型定義: 完全実装済み（CourseDefinition, CareerCourseSelection, CareerCourseChangeRequest等）
- **不足している項目**:
  - コース変更履歴の完全トレーサビリティ（変更理由・承認者・添付ファイル保管）
  - コース間転換ルールの詳細定義（現在は型定義のみ、DBテーブル未設定）
  - 将来のE/Fコース追加対応（現在A～Dの4コースのみ）
  - VoiceDriveからの申請データの正式な保管テーブル
  - 統計分析用の集計テーブル（月次・年次のコース別人員推移）

### キャリアコース選択制度の概要
```
✅ Aコース（全面協力型）: 基本給係数1.2倍、管理職候補、転居を伴う転勤OK、夜勤必須
✅ Bコース（施設内協力型）: 基本給係数1.1倍、施設内部署異動のみ、夜勤必須
✅ Cコース（専門職型）: 基本給係数1.0倍、異動なし、夜勤選択可、プライベート優先
✅ Dコース（時短・制約あり型）: 基本給係数0.9倍、育児・介護等配慮、夜勤なし、異動なし
```

### 必要なテーブル設計

#### 20-1. CareerCourseDefinition（キャリアコース定義マスター）

**目的**: A～D（将来的にE/F等追加可能）のコース定義を管理。給与係数・異動条件・夜勤要件等を一元管理。

```prisma
model CareerCourseDefinition {
  id                    String    @id @default(cuid())

  // コース基本情報
  courseCode            String    @unique @map("course_code")
  // A, B, C, D, E, F...（将来拡張可能）
  courseName            String    @map("course_name")
  // Aコース（全面協力型）
  description           String?   @db.Text
  // 詳細説明

  // 異動・転勤条件
  departmentTransferAvailable Boolean @default(false) @map("department_transfer_available")
  // 部署異動可否
  facilityTransferAvailable   String  @map("facility_transfer_available")
  // none, limited, full
  relocationRequired          Boolean @default(false) @map("relocation_required")
  // 転居を伴う転勤

  // 勤務条件
  nightShiftAvailable   String    @map("night_shift_available")
  // none, selectable, required

  // キャリアパス
  managementTrack       Boolean   @default(false) @map("management_track")
  // 管理職登用対象

  // 給与設定（3パターン対応: 係数のみ/等級のみ/両方）
  baseSalaryMultiplier  Float     @map("base_salary_multiplier")
  // 基本給係数（例: 1.2）
  salaryGrade           Int?      @map("salary_grade")
  // 給与等級（オプション）
  salaryNotes           String?   @db.Text @map("salary_notes")
  // 給与計算に関するメモ

  // 将来拡張: 等級制度との連携
  maxGradeLimit         Int?      @map("max_grade_limit")
  // このコースの最大到達可能等級（将来のPhase 2対応）
  gradeCoefficient      Float?    @default(1.0) @map("grade_coefficient")
  // 等級昇給時の係数（Aコース: 1.2, Bコース: 1.1等）

  // メタデータ
  isActive              Boolean   @default(true) @map("is_active")
  displayOrder          Int       @map("display_order")
  effectiveFrom         DateTime? @map("effective_from")
  // この定義の有効開始日
  effectiveTo           DateTime? @map("effective_to")
  // NULL = 現在有効

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([courseCode])
  @@index([isActive])
  @@map("career_course_definitions")
}
```

#### 20-2. EmployeeCareerCourse（職員のコース選択・変更履歴）

**目的**: 各職員の現在のコース・過去の変更履歴を完全記録。年1回制限・特例変更の管理。

```prisma
model EmployeeCareerCourse {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // コース情報
  courseCode            String    @map("course_code")
  // A, B, C, D

  // 適用期間
  effectiveFrom         DateTime  @map("effective_from")
  // YYYY-MM-DD
  effectiveTo           DateTime? @map("effective_to")
  // NULL = 現在有効

  // 次回変更可能日（年1回制限）
  nextChangeAvailableDate DateTime? @map("next_change_available_date")
  // 定期変更の場合、次回変更可能日を記録

  // 特例変更事由
  specialChangeReason   String?   @map("special_change_reason")
  // pregnancy, caregiving, illness, null
  specialChangeNote     String?   @db.Text @map("special_change_note")
  // 特例事由の詳細（診断書内容等）
  specialChangeAttachments Json?  @map("special_change_attachments")
  // [
  //   { "fileName": "妊娠診断書.pdf", "fileUrl": "https://...", "uploadedAt": "2025-10-01T10:00:00Z" },
  //   { "fileName": "母子健康手帳.pdf", "fileUrl": "https://...", "uploadedAt": "2025-10-01T10:05:00Z" }
  // ]

  // 承認情報
  changeRequestId       String?   @map("change_request_id")
  // CareerCourseChangeRequestとの紐付け
  changeRequestedAt     DateTime? @map("change_requested_at")
  changeRequestedBy     String?   @map("change_requested_by")
  // VoiceDriveのユーザーID

  approvedAt            DateTime? @map("approved_at")
  approvedBy            String?   @map("approved_by")
  // 人事部のユーザーID
  approvedByName        String?   @map("approved_by_name")
  approvalStatus        String    @default("approved") @map("approval_status")
  // approved, pending, rejected, withdrawn
  rejectionReason       String?   @db.Text @map("rejection_reason")

  // VoiceDrive連携
  syncedToVoiceDrive    Boolean   @default(false) @map("synced_to_voicedrive")
  voicedriveSyncedAt    DateTime? @map("voicedrive_synced_at")
  voicedriveRecordId    String?   @map("voicedrive_record_id")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([employeeId])
  @@index([courseCode])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@index([approvalStatus])
  @@map("employee_career_courses")
}
```

#### 20-3. CareerCourseChangeRequest（コース変更申請）

**目的**: VoiceDriveから送信される変更申請を管理。承認フロー・添付ファイル・審査コメント保管。

```prisma
model CareerCourseChangeRequest {
  id                    String    @id @default(cuid())

  // 申請職員情報
  employeeId            String    @map("employee_id")
  staffId               String    @map("staff_id")
  // OH-NS-2023-005等
  staffName             String?   @map("staff_name")
  facility              String?
  department            String?
  position              String?

  // 変更内容
  currentCourseCode     String    @map("current_course_code")
  requestedCourseCode   String    @map("requested_course_code")
  requestedEffectiveDate DateTime @map("requested_effective_date")
  // 希望適用日

  // 変更理由
  changeReason          String    @map("change_reason")
  // annual, special_pregnancy, special_caregiving, special_illness, special_other
  reasonDetail          String?   @db.Text @map("reason_detail")
  // 申請者が入力した理由詳細

  // 添付ファイル
  attachments           Json?
  // [
  //   { "fileName": "妊娠診断書.pdf", "fileUrl": "https://...", "uploadedAt": "2025-10-01T10:00:00Z" }
  // ]

  // VoiceDrive連携情報
  voicedriveRequestId   String?   @map("voicedrive_request_id")
  submittedFromVoiceDrive Boolean @default(true) @map("submitted_from_voicedrive")
  submittedAt           DateTime  @default(now()) @map("submitted_at")
  submittedBy           String    @map("submitted_by")
  // VoiceDriveのユーザーID

  // 承認フロー
  approvalStatus        String    @default("pending") @map("approval_status")
  // pending, approved, rejected, withdrawn

  hrReviewerId          String?   @map("hr_reviewer_id")
  // 人事部審査者ID
  hrReviewerName        String?   @map("hr_reviewer_name")
  reviewedAt            DateTime? @map("reviewed_at")
  reviewComment         String?   @db.Text @map("review_comment")
  // 承認・却下時のコメント

  rejectionReason       String?   @db.Text @map("rejection_reason")
  withdrawnAt           DateTime? @map("withdrawn_at")
  withdrawnReason       String?   @db.Text @map("withdrawn_reason")

  // 反映状態
  appliedToRecord       Boolean   @default(false) @map("applied_to_record")
  // EmployeeCareerCourseに反映済みか
  appliedAt             DateTime? @map("applied_at")
  appliedRecordId       String?   @map("applied_record_id")
  // EmployeeCareerCourse.id

  // 通知管理
  hrNotificationSent    Boolean   @default(false) @map("hr_notification_sent")
  // 人事部への通知送信済み
  applicantNotificationSent Boolean @default(false) @map("applicant_notification_sent")
  // 申請者への結果通知送信済み

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([employeeId])
  @@index([approvalStatus])
  @@index([submittedAt])
  @@index([requestedEffectiveDate])
  @@index([voicedriveRequestId])
  @@map("career_course_change_requests")
}
```

#### 20-4. CourseTransferRule（コース間転換ルール）

**目的**: A→B、C→D等のコース間転換の可否・条件を定義。転換時の訓練要件・承認プロセス管理。

```prisma
model CourseTransferRule {
  id                    String    @id @default(cuid())

  // 転換元・転換先
  fromCourseCode        String    @map("from_course_code")
  toCourseCode          String    @map("to_course_code")

  // 転換条件
  isAllowed             Boolean   @default(true) @map("is_allowed")
  // この転換を許可するか
  requiresApproval      Boolean   @default(true) @map("requires_approval")
  // 承認必須か（通常はtrue）

  // 訓練・研修要件
  requiresTraining      Boolean   @default(false) @map("requires_training")
  // キャリアルートの違いを考慮した訓練が必要か
  trainingProgramId     String?   @map("training_program_id")
  // EducationTrainingProgram.id（セクション16で定義）
  trainingProgramName   String?   @map("training_program_name")
  trainingDurationDays  Int?      @map("training_duration_days")

  // 制約条件
  minimumServiceYears   Int?      @map("minimum_service_years")
  // 最低勤続年数
  requiresManagerRecommendation Boolean @default(false) @map("requires_manager_recommendation")
  // 上司推薦が必要か
  requiresInterviewWithHR Boolean @default(false) @map("requires_interview_with_hr")
  // 人事部との面談が必要か

  // 特別条件
  allowedOnlyForSpecialReasons Boolean @default(false) @map("allowed_only_for_special_reasons")
  // 特例のみ許可（例: C→D、妊娠・育児のみ）
  specialReasonsAllowed Json?     @map("special_reasons_allowed")
  // ["pregnancy", "caregiving", "illness"]

  // 説明・注意事項
  ruleDescription       String?   @db.Text @map("rule_description")
  // このルールの説明
  notes                 String?   @db.Text
  // 注意事項

  // 有効期間
  effectiveFrom         DateTime? @map("effective_from")
  effectiveTo           DateTime? @map("effective_to")
  isActive              Boolean   @default(true) @map("is_active")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([fromCourseCode, toCourseCode])
  @@index([fromCourseCode])
  @@index([toCourseCode])
  @@index([isActive])
  @@map("course_transfer_rules")
}
```

#### 20-5. CareerCourseStatistics（月次コース別統計）

**目的**: 毎月のコース別人員数・変更件数を集計。経営層・人事部への報告用データ。

```prisma
model CareerCourseStatistics {
  id                    String    @id @default(cuid())

  // 集計期間
  fiscalYear            Int       @map("fiscal_year")
  // 年度
  month                 Int
  // 1-12
  snapshotDate          DateTime  @map("snapshot_date")
  // 集計日（通常は月末日）

  // コース別集計
  courseCode            String    @map("course_code")
  totalStaffCount       Int       @map("total_staff_count")
  // このコースの職員数
  percentageOfTotal     Float     @map("percentage_of_total")
  // 全体に対する割合（%）

  // 施設別内訳
  byFacility            Json?     @map("by_facility")
  // [
  //   { "facilityId": "obara-hospital", "facilityName": "小原病院", "count": 45, "percentage": 62.5 },
  //   { "facilityId": "tategami-rehabilitation", "facilityName": "立神リハビリテーション温泉病院", "count": 27, "percentage": 37.5 }
  // ]

  // 職種別内訳
  byPosition            Json?     @map("by_position")
  // [
  //   { "position": "看護師", "count": 30 },
  //   { "position": "理学療法士", "count": 15 }
  // ]

  // 変更統計
  newAssignments        Int       @default(0) @map("new_assignments")
  // 当月の新規割り当て（新入職等）
  changesFromOtherCourse Int      @default(0) @map("changes_from_other_course")
  // 他コースから変更してきた人数
  changesToOtherCourse   Int      @default(0) @map("changes_to_other_course")
  // 他コースへ変更した人数

  // 特例変更の内訳
  specialChangeBreakdown Json?    @map("special_change_breakdown")
  // {
  //   "pregnancy": 2,
  //   "caregiving": 1,
  //   "illness": 0
  // }

  // 前月比較
  previousMonthCount    Int?      @map("previous_month_count")
  countChange           Int?      @map("count_change")
  // プラス/マイナス

  // 自動集計情報
  calculatedAt          DateTime  @default(now()) @map("calculated_at")
  calculatedBy          String?   @map("calculated_by")
  // system, batch-job等

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([fiscalYear, month, courseCode])
  @@index([fiscalYear])
  @@index([courseCode])
  @@index([snapshotDate])
  @@map("career_course_statistics")
}
```

### Employeeテーブルへの追加フィールド

```prisma
// 既存のEmployeeモデルに追加
model Employee {
  // ... 既存フィールド

  // キャリアコース関連（Phase 5）
  currentCareerCourse   String?   @map("current_career_course")
  // A, B, C, D - 最新のコース（キャッシュ）
  careerCourseChangedAt DateTime? @map("career_course_changed_at")
  // 最後にコースを変更した日時
  nextCourseChangeAvailableDate DateTime? @map("next_course_change_available_date")
  // 次回変更可能日（年1回制限）

  // ... 既存フィールド
}
```

### 実装による効果

✅ **完全な変更履歴管理**
- 全ての変更履歴を保管（理由・承認者・添付ファイル）
- 特例変更の監査証跡
- VoiceDrive連携の完全トレーサビリティ

✅ **将来拡張対応**
- E/Fコース等の追加が容易
- 等級制度（Phase 2）との連携準備完了
- maxGradeLimit、gradeCoefficient追加済み

✅ **コース間転換ルール定義**
- A→B、C→D等の転換条件を明確化
- 訓練要件・承認プロセスの標準化
- 特例変更のルール管理

✅ **統計分析と経営報告**
- 月次のコース別人員推移
- 施設別・職種別の内訳自動集計
- 特例変更の傾向分析

✅ **VoiceDriveとの完全連携**
- 申請データの正式保管
- 承認結果の自動同期
- 添付ファイルの安全な保管

**Phase 5実装済み機能に対して、将来の等級制度導入（Phase 2）とデータ分析強化に対応した設計完了！**

---

## 18. ストレスチェック・健康管理統合システム（個人レベル完全対応）

### 背景と要件
- 現在の実装: 基本的な健診データ入力、産業医診断、ストレスチェック集団分析
- **不足している項目**: 個人レベルのストレスチェック詳細履歴、経年変化追跡、面接指導管理
- 健診とストレスチェックの**統合的な健康リスク評価**が必要
- 保健師・産業医の**介入履歴と効果測定**が不足

### 法令要件（労働安全衛生法）
```
✅ ストレスチェック年1回実施義務（50人以上事業場）
✅ 高ストレス者への医師面接指導
✅ 集団分析の実施と結果活用
✅ 5年間の記録保存義務
✅ 個人情報保護（本人同意なしの人事利用禁止）
```

### 必要なテーブル設計

#### 18-1. StressCheckRecord（ストレスチェック実施記録）

**目的**: 個人のストレスチェック受検履歴を完全管理。57項目の詳細スコア・経年変化を追跡。

```prisma
model StressCheckRecord {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 実施情報
  fiscalYear            Int       @map("fiscal_year")
  // 年度（2024, 2025...）
  implementationDate    DateTime  @map("implementation_date")
  // 実施日
  implementationMethod  String?   @map("implementation_method")
  // online, paper, hybrid

  // 57項目調査結果（JSON配列）
  questionnaireResults  Json      @map("questionnaire_results")
  // [
  //   { "questionNo": 1, "dimension": "仕事の負担", "question": "非常にたくさんの仕事をしなければならない", "answer": 4 },
  //   { "questionNo": 2, "dimension": "仕事の負担", "question": "時間内に仕事が処理しきれない", "answer": 3 },
  //   ... 57項目
  // ]

  // 3尺度評価スコア
  stressFactorScore     Int?      @map("stress_factor_score")
  // 仕事のストレス要因（29項目、29-116点）
  physicalMentalScore   Int?      @map("physical_mental_score")
  // 心身のストレス反応（29項目、29-116点）
  supportFactorScore    Int?      @map("support_factor_score")
  // 周囲のサポート（9項目、9-36点）

  // 総合評価
  totalStressScore      Int?      @map("total_stress_score")
  // 合計点
  stressLevel           String?   @map("stress_level")
  // low（低）, moderate（中）, high（高）, very_high（最高）
  isHighStress          Boolean   @default(false) @map("is_high_stress")
  // 高ストレス判定

  // 高ストレス判定基準
  highStressReason      String?   @map("high_stress_reason")
  // physical_mental_high（心身反応高）, total_high（総合点高）, both（両方）

  // 面接指導申出
  interviewRequested    Boolean   @default(false) @map("interview_requested")
  // 医師面接指導の申出有無
  interviewRequestDate  DateTime? @map("interview_request_date")
  interviewCompleted    Boolean   @default(false) @map("interview_completed")
  interviewCompletedDate DateTime? @map("interview_completed_date")

  // 個人へのフィードバック
  feedbackProvided      Boolean   @default(false) @map("feedback_provided")
  feedbackDate          DateTime? @map("feedback_date")
  feedbackComment       String?   @map("feedback_comment")
  // 本人へのアドバイス

  // 🆕 VoiceDrive配信管理
  voicedriveNotificationSent Boolean @default(false) @map("voicedrive_notification_sent")
  // VoiceDriveへの結果通知送信済み
  voicedriveNotificationId String? @map("voicedrive_notification_id")
  // StaffNotification.id（Section 27連携）
  voicedriveNotificationDate DateTime? @map("voicedrive_notification_date")
  // 通知送信日時
  voicedriveNotificationStatus String? @map("voicedrive_notification_status")
  // pending, sent, delivered, opened, failed
  personalResultUrl     String?   @map("personal_result_url")
  // 個人結果ページURL（VoiceDrive内）

  // 前回との比較（自動計算）
  previousRecordId      String?   @map("previous_record_id")
  stressChangePercent   Float?    @map("stress_change_percent")
  // 前回比変化率（%）
  isImproving           Boolean?  @map("is_improving")
  // 改善傾向かどうか

  // 同意・個人情報管理
  consentToShare        Boolean   @default(false) @map("consent_to_share")
  // 結果の事業者への提供同意
  consentDate           DateTime? @map("consent_date")

  // 実施者情報
  conductedBy           String?   @map("conducted_by")
  // 実施者（医師・保健師）

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])
  interviewGuidance     InterviewGuidance?
  healthRiskAssessment  HealthRiskAssessment?

  @@index([employeeId])
  @@index([fiscalYear])
  @@index([isHighStress])
  @@index([interviewRequested])
  @@index([implementationDate])
  @@map("stress_check_records")
}
```

#### 18-2. InterviewGuidance（医師面接指導記録）

**目的**: 高ストレス者への医師面接指導の実施内容・就業上の措置を記録。

```prisma
model InterviewGuidance {
  id                    String    @id @default(cuid())
  stressCheckRecordId   String    @unique @map("stress_check_record_id")
  employeeId            String    @map("employee_id")

  // 面接実施情報
  interviewDate         DateTime  @map("interview_date")
  doctorId              String?   @map("doctor_id")
  // 実施医師ID
  doctorName            String    @map("doctor_name")
  interviewDuration     Int?      @map("interview_duration")
  // 面接時間（分）
  interviewLocation     String?   @map("interview_location")
  // オンライン/対面

  // 医師の意見（法定項目）
  workloadAssessment    String?   @map("workload_assessment")
  // 勤務状況の評価
  healthStatus          String?   @map("health_status")
  // 心身の状況
  medicalOpinion        String    @map("medical_opinion")
  // 医師の意見（自由記述）

  // 就業上の措置（法定項目）
  workMeasuresRequired  Boolean   @default(false) @map("work_measures_required")
  // 就業上の措置の必要性
  workMeasures          Json?     @map("work_measures")
  // [
  //   { "measure": "労働時間の短縮", "duration": "3ヶ月", "detail": "1日8時間以内" },
  //   { "measure": "夜勤・交代勤務の制限", "duration": "1ヶ月", "detail": "日勤のみ" },
  //   { "measure": "出張の制限", "duration": "2ヶ月" }
  // ]

  // 勤務制限
  overtimeRestriction   Boolean   @default(false) @map("overtime_restriction")
  // 残業制限
  nightShiftRestriction Boolean   @default(false) @map("night_shift_restriction")
  // 夜勤制限
  businessTripRestriction Boolean @default(false) @map("business_trip_restriction")
  // 出張制限
  workloadReduction     Boolean   @default(false) @map("workload_reduction")
  // 作業量の軽減

  // 措置期間
  measureStartDate      DateTime? @map("measure_start_date")
  measureEndDate        DateTime? @map("measure_end_date")
  measureDurationMonths Int?      @map("measure_duration_months")

  // 治療・通院
  medicalTreatmentRecommended Boolean @default(false) @map("medical_treatment_recommended")
  // 治療勧奨
  referredToSpecialist  Boolean   @default(false) @map("referred_to_specialist")
  // 専門医紹介
  specialistType        String?   @map("specialist_type")
  // 精神科、心療内科等

  // フォローアップ
  followUpRequired      Boolean   @default(false) @map("follow_up_required")
  followUpSchedule      Json?     @map("follow_up_schedule")
  // [{ "date": "2025-11-01", "type": "面談", "status": "scheduled" }, ...]
  nextInterviewDate     DateTime? @map("next_interview_date")

  // 事業者への意見書提出
  reportSubmittedToEmployer Boolean @default(false) @map("report_submitted_to_employer")
  reportSubmissionDate  DateTime? @map("report_submission_date")

  // VoiceDrive連携（就業措置の自動反映）
  sentToVoiceDrive      Boolean   @default(false) @map("sent_to_voicedrive")
  voicedriveSentDate    DateTime? @map("voicedrive_sent_date")

  status                String    @default("completed") @map("status")
  // scheduled, in_progress, completed
  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  stressCheckRecord     StressCheckRecord @relation(fields: [stressCheckRecordId], references: [id])
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([interviewDate])
  @@index([workMeasuresRequired])
  @@index([followUpRequired])
  @@map("interview_guidances")
}
```

#### 18-3. HealthRiskAssessment（総合健康リスク評価）

**目的**: 健診結果 × ストレスチェック × メンタルヘルス相談を統合し、総合的な健康リスクを評価。

```prisma
model HealthRiskAssessment {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  assessmentDate        DateTime  @map("assessment_date")
  assessmentPeriod      String    @map("assessment_period")
  // 2024-Q4, 2025-H1 等

  // 健診データ連携
  healthCheckupId       String?   @map("health_checkup_id")
  checkupResult         String?   @map("checkup_result")
  // A, B, C, D, E
  hasAbnormalFindings   Boolean   @default(false) @map("has_abnormal_findings")
  abnormalItems         Json?     @map("abnormal_items")
  // [{ "item": "血圧", "value": "150/95", "status": "high" }, ...]

  // ストレスチェック連携
  stressCheckRecordId   String?   @unique @map("stress_check_record_id")
  stressLevel           String?   @map("stress_level")
  // low, moderate, high, very_high
  isHighStress          Boolean   @default(false) @map("is_high_stress")

  // メンタルヘルス相談連携
  recentMentalHealthConsultation Boolean @default(false) @map("recent_mental_health_consultation")
  // 直近3ヶ月以内の相談有無
  consultationCount     Int?      @map("consultation_count")
  // 直近1年間の相談回数

  // 総合リスク評価（自動計算）
  overallRiskLevel      String    @map("overall_risk_level")
  // low（低リスク）, moderate（中リスク）, high（高リスク）, critical（最高リスク）

  riskFactors           Json      @map("risk_factors")
  // [
  //   { "factor": "高血圧 + 高ストレス", "riskLevel": "high", "weight": 0.8 },
  //   { "factor": "長時間労働", "riskLevel": "moderate", "weight": 0.5 },
  //   { "factor": "メンタル不調の兆候", "riskLevel": "high", "weight": 0.7 }
  // ]

  riskScore             Float?    @map("risk_score")
  // 0-100点のリスクスコア

  // 推奨アクション
  recommendedActions    Json?     @map("recommended_actions")
  // [
  //   { "priority": "high", "action": "産業医面談の実施", "deadline": "2週間以内" },
  //   { "priority": "high", "action": "勤務時間の制限", "deadline": "即時" },
  //   { "priority": "medium", "action": "保健師フォロー", "deadline": "1ヶ月以内" }
  // ]

  // プレゼンティーズム評価
  presenteeismScore     Float?    @map("presenteeism_score")
  // 0-100（健康問題による生産性低下度）
  absenteeismRisk       String?   @map("absenteeism_risk")
  // low, moderate, high（欠勤リスク）

  // 職場環境要因
  workloadStatus        String?   @map("workload_status")
  // normal, moderate_overtime, excessive_overtime
  overtimeHours         Float?    @map("overtime_hours")
  // 直近3ヶ月平均残業時間
  nightShiftFrequency   String?   @map("night_shift_frequency")
  // none, occasional, frequent

  // 介入実施状況
  interventionRequired  Boolean   @default(false) @map("intervention_required")
  interventionStatus    String?   @map("intervention_status")
  // not_started, in_progress, completed
  interventionStartDate DateTime? @map("intervention_start_date")

  // 評価者
  assessedBy            String?   @map("assessed_by")
  // 保健師・産業医ID
  assessorRole          String?   @map("assessor_role")
  // occupational_physician, public_health_nurse

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])
  stressCheckRecord     StressCheckRecord? @relation(fields: [stressCheckRecordId], references: [id])

  @@index([employeeId])
  @@index([overallRiskLevel])
  @@index([assessmentDate])
  @@index([interventionRequired])
  @@map("health_risk_assessments")
}
```

#### 18-4. HealthGuidance（保健指導記録）

**目的**: 保健師による個別保健指導・生活習慣改善支援の実施記録。

```prisma
model HealthGuidance {
  id                    String    @id @default(cuid())
  employeeId            String    @map("employee_id")

  // 指導情報
  guidanceType          String    @map("guidance_type")
  // specific（特定保健指導）, motivational（動機付け支援）, active（積極的支援）, general（一般保健指導）
  triggerReason         String    @map("trigger_reason")
  // health_checkup（健診）, stress_check（ストレスチェック）, high_risk（高リスク）, self_request（本人希望）

  guidanceDate          DateTime  @map("guidance_date")
  nurseId               String?   @map("nurse_id")
  // 保健師ID
  nurseName             String    @map("nurse_name")
  guidanceDuration      Int?      @map("guidance_duration")
  // 指導時間（分）
  guidanceMethod        String?   @map("guidance_method")
  // face_to_face, online, phone

  // 指導内容（法定項目）
  currentHealthStatus   String?   @map("current_health_status")
  // 現在の健康状態評価
  lifestyleAssessment   Json?     @map("lifestyle_assessment")
  // { "diet": "不規則", "exercise": "不足", "sleep": "不十分", "alcohol": "適量", "smoking": "なし" }

  healthRisks           Json?     @map("health_risks")
  // [{ "risk": "メタボリックシンドローム", "level": "high" }, ...]

  improvementGoals      Json      @map("improvement_goals")
  // [
  //   { "goal": "体重5kg減", "target": "3ヶ月", "method": "食事管理 + 運動" },
  //   { "goal": "残業時間削減", "target": "1ヶ月", "method": "業務効率化" }
  // ]

  actionPlan            Json?     @map("action_plan")
  // [
  //   { "action": "週3回30分ウォーキング", "frequency": "週3回", "startDate": "2025-11-01" },
  //   { "action": "野菜摂取量増加", "target": "1日350g", "method": "毎食サラダ追加" }
  // ]

  // 生活習慣改善支援
  dietGuidance          String?   @map("diet_guidance")
  exerciseGuidance      String?   @map("exercise_guidance")
  sleepGuidance         String?   @map("sleep_guidance")
  stressManagementGuidance String? @map("stress_management_guidance")

  // フォローアップ計画
  followUpSchedule      Json?     @map("follow_up_schedule")
  // [
  //   { "date": "2025-12-01", "type": "電話フォロー", "status": "scheduled" },
  //   { "date": "2026-01-01", "type": "対面面談", "status": "scheduled" }
  // ]

  nextGuidanceDate      DateTime? @map("next_guidance_date")

  // 効果測定
  initialWeight         Float?    @map("initial_weight")
  initialBMI            Float?    @map("initial_bmi")
  initialWaist          Float?    @map("initial_waist")
  targetWeight          Float?    @map("target_weight")
  targetWaist           Float?    @map("target_waist")

  currentWeight         Float?    @map("current_weight")
  currentBMI            Float?    @map("current_bmi")
  currentWaist          Float?    @map("current_waist")

  improvementRate       Float?    @map("improvement_rate")
  // 改善率（%）
  goalAchievement       String?   @map("goal_achievement")
  // not_achieved, partially_achieved, fully_achieved

  // 治療勧奨
  medicalReferralRequired Boolean @default(false) @map("medical_referral_required")
  referralReason        String?   @map("referral_reason")
  referredDate          DateTime? @map("referred_date")

  status                String    @default("active") @map("status")
  // active, completed, discontinued
  completionDate        DateTime? @map("completion_date")

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  employee              Employee  @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([guidanceType])
  @@index([guidanceDate])
  @@index([status])
  @@map("health_guidances")
}
```

#### 18-5. GroupStressAnalysis（集団分析結果）

**目的**: 部署・施設別のストレスチェック集団分析結果を記録。職場環境改善に活用。

```prisma
model GroupStressAnalysis {
  id                    String    @id @default(cuid())

  // 分析対象
  fiscalYear            Int       @map("fiscal_year")
  analysisDate          DateTime  @map("analysis_date")
  analysisLevel         String    @map("analysis_level")
  // facility（施設）, department（部署）, team（チーム）
  targetFacilityId      String?   @map("target_facility_id")
  targetDepartmentId    String?   @map("target_department_id")
  targetGroupName       String    @map("target_group_name")

  // 対象人数
  totalEmployees        Int       @map("total_employees")
  // 対象職員数
  respondents           Int       @map("respondents")
  // 回答者数
  responseRate          Float     @map("response_rate")
  // 回答率（%）

  // 集団分析結果（法定項目）
  avgStressFactorScore  Float     @map("avg_stress_factor_score")
  // 仕事のストレス要因平均
  avgPhysicalMentalScore Float    @map("avg_physical_mental_score")
  // 心身のストレス反応平均
  avgSupportFactorScore Float     @map("avg_support_factor_score")
  // 周囲のサポート平均

  // 高ストレス者割合
  highStressCount       Int       @map("high_stress_count")
  highStressRate        Float     @map("high_stress_rate")
  // 高ストレス者率（%）

  // 仕事の負担評価
  quantitativeWorkload  Float?    @map("quantitative_workload")
  // 量的負担スコア
  qualitativeWorkload   Float?    @map("qualitative_workload")
  // 質的負担スコア
  physicalWorkload      Float?    @map("physical_workload")
  // 身体的負担スコア

  // 職場環境評価
  workControl           Float?    @map("work_control")
  // 仕事のコントロールスコア
  skillUtilization      Float?    @map("skill_utilization")
  // 技能の活用度
  interpersonalRelations Float?   @map("interpersonal_relations")
  // 対人関係スコア
  workplaceSupport      Float?    @map("workplace_support")
  // 職場の支援スコア

  // 全国平均・法人平均との比較
  comparisonToNational  Json?     @map("comparison_to_national")
  // { "stressFactor": "+15%", "physicalMental": "+8%", ... }
  comparisonToCorporate Json?     @map("comparison_to_corporate")
  // 法人全体平均との比較

  // リスク評価
  overallRiskLevel      String    @map("overall_risk_level")
  // low, moderate, high, critical
  riskFactors           Json?     @map("risk_factors")
  // [{ "factor": "長時間労働", "severity": "high" }, ...]

  // 推奨される職場環境改善策
  recommendedImprovements Json?   @map("recommended_improvements")
  // [
  //   { "priority": "high", "area": "業務量の適正化", "action": "業務分担の見直し" },
  //   { "priority": "medium", "area": "コミュニケーション", "action": "定期ミーティング実施" }
  // ]

  // 衛生委員会報告
  reportedToCommittee   Boolean   @default(false) @map("reported_to_committee")
  reportDate            DateTime? @map("report_date")

  // 改善措置の実施状況
  improvementMeasures   Json?     @map("improvement_measures")
  // [
  //   { "measure": "残業削減施策", "startDate": "2025-11-01", "status": "in_progress" },
  //   ...
  // ]

  // 次回分析予定
  nextAnalysisDate      DateTime? @map("next_analysis_date")

  notes                 String?   @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([fiscalYear])
  @@index([analysisLevel])
  @@index([targetFacilityId])
  @@index([targetDepartmentId])
  @@index([overallRiskLevel])
  @@map("group_stress_analyses")
}
```

---

### Employeeテーブルへの拡張フィールド

既存のEmployeeテーブルに以下を追加：

```prisma
model Employee {
  // ... 既存フィールド ...

  // 🆕 ストレスチェック・健康管理情報
  latestStressCheckDate DateTime? @map("latest_stress_check_date")
  // 最新ストレスチェック実施日
  latestStressLevel     String?   @map("latest_stress_level")
  // 最新ストレスレベル（low/moderate/high/very_high）
  isCurrentHighStress   Boolean   @default(false) @map("is_current_high_stress")
  // 現在高ストレス状態か

  latestHealthCheckupDate DateTime? @map("latest_health_checkup_date")
  // 最新健診日
  latestCheckupResult   String?   @map("latest_checkup_result")
  // 最新健診結果（A/B/C/D/E）

  healthRiskLevel       String?   @map("health_risk_level")
  // 総合健康リスクレベル（low/moderate/high/critical）
  requiresIntervention  Boolean   @default(false) @map("requires_intervention")
  // 介入必要フラグ

  // Relations
  stressCheckRecords    StressCheckRecord[]
  interviewGuidances    InterviewGuidance[]
  healthRiskAssessments HealthRiskAssessment[]
  healthGuidances       HealthGuidance[]

  // ... 既存Relations ...
}
```

---

### 設計のポイント

#### 1. **個人レベルの完全追跡**
- ✅ 57項目の詳細ストレスチェック結果を記録
- ✅ 経年変化を自動計算（前回比較）
- ✅ 高ストレス判定 → 面接指導 → フォローアップの完全フロー

#### 2. **健診×ストレス×メンタルの統合評価**
```typescript
// 総合リスク自動評価の例
const riskScore = calculateOverallRisk({
  checkupResult: 'D',           // 健診: 要精密検査
  stressLevel: 'very_high',     // ストレス: 最高レベル
  consultationCount: 3,         // メンタル相談: 3回/年
  overtimeHours: 80             // 残業: 80時間/月
});
// → overallRiskLevel: 'critical' （最高リスク）
```

#### 3. **法令遵守の完全対応**
- ✅ 高ストレス者への医師面接指導（義務）
- ✅ 就業上の措置の記録（義務）
- ✅ 集団分析の実施と活用（義務）
- ✅ 5年間の記録保存（保存期間フィールド追加可能）
- ✅ 個人情報保護（consentToShare フラグ）

#### 4. **VoiceDrive連携による就業措置の自動反映**
```typescript
// 医師面接指導で「夜勤制限」が決定
const interview = await prisma.interviewGuidance.create({
  data: {
    nightShiftRestriction: true,
    measureStartDate: '2025-11-01',
    measureEndDate: '2026-01-31',
    sentToVoiceDrive: true
  }
});

// → VoiceDriveシフト管理システムに自動送信
// → 該当職員の夜勤シフトが自動制限される
```

---

### 実装パターン例

#### パターン1: ストレスチェック実施と高ストレス判定 + VoiceDrive配信
```typescript
// ストレスチェック結果登録
const stressCheck = await prisma.stressCheckRecord.create({
  data: {
    employeeId: "emp-001",
    fiscalYear: 2025,
    implementationDate: new Date("2025-10-15"),
    questionnaireResults: [...], // 57項目
    stressFactorScore: 85,
    physicalMentalScore: 95,     // ← 基準値77以上で高ストレス
    supportFactorScore: 20,
    isHighStress: true,          // 自動判定
    highStressReason: "physical_mental_high",
    feedbackProvided: true,
    feedbackComment: "ストレス反応が高い状態です。必要に応じて医師面接指導を受けることができます。"
  }
});

// 🆕 VoiceDriveへストレスチェック結果を配信
const notification = await prisma.staffNotification.create({
  data: {
    notificationNumber: "STRESS-2025-001",
    title: "【重要】2025年度ストレスチェック結果のお知らせ",
    content: `
      2025年度のストレスチェックを受検いただきありがとうございました。
      あなたの結果をお知らせします。

      【結果概要】
      - ストレス要因: 85点
      - 心身の反応: 95点（高ストレス判定）
      - 周囲のサポート: 20点

      【アドバイス】
      ${stressCheck.feedbackComment}

      詳細結果は以下のリンクからご確認ください。
      医師面接指導をご希望の方は、人事部までご連絡ください。
    `,
    category: "survey",
    priority: "high",
    targetType: "individuals",
    targetEmployeeIds: ["emp-001"],
    status: "approved",
    hasResponseForm: true,
    responseFormData: {
      questions: [
        {
          id: "interview_request",
          type: "choice",
          question: "医師面接指導を希望しますか？",
          options: ["希望する", "希望しない"]
        }
      ]
    },
    createdBy: "system",
    approvedBy: "system",
    approvedAt: new Date()
  }
});

// StressCheckRecordにVoiceDrive配信情報を記録
await prisma.stressCheckRecord.update({
  where: { id: stressCheck.id },
  data: {
    voicedriveNotificationSent: true,
    voicedriveNotificationId: notification.id,
    voicedriveNotificationDate: new Date(),
    voicedriveNotificationStatus: "sent",
    personalResultUrl: `https://voicedrive.app/stress-check/${stressCheck.id}`
  }
});

// StaffNotificationDeliveryで個別配信を追跡
await prisma.staffNotificationDelivery.create({
  data: {
    notificationId: notification.id,
    employeeId: "emp-001",
    deliveryChannel: "voicedrive",
    deliveryStatus: "sent",
    sentAt: new Date()
  }
});
```

#### パターン2: 総合健康リスク評価
```typescript
// 健診 + ストレスチェック + メンタル相談を統合評価
const riskAssessment = await prisma.healthRiskAssessment.create({
  data: {
    employeeId: "emp-001",
    healthCheckupId: "checkup-123",
    checkupResult: "D",           // 要精密検査
    stressCheckRecordId: "stress-456",
    isHighStress: true,
    recentMentalHealthConsultation: true,
    consultationCount: 3,
    overallRiskLevel: "critical", // 自動判定: 最高リスク
    riskFactors: [
      { factor: "高血圧 + 高ストレス", riskLevel: "high", weight: 0.8 },
      { factor: "メンタル不調の兆候", riskLevel: "high", weight: 0.7 }
    ],
    recommendedActions: [
      { priority: "high", action: "産業医面談の実施", deadline: "2週間以内" },
      { priority: "high", action: "勤務時間の制限", deadline: "即時" }
    ],
    interventionRequired: true
  }
});
```

#### パターン3: 集団分析と職場環境改善
```typescript
// 部署別ストレスチェック集団分析
const groupAnalysis = await prisma.groupStressAnalysis.create({
  data: {
    fiscalYear: 2025,
    analysisLevel: "department",
    targetDepartmentId: "dept-nursing",
    targetGroupName: "看護部",
    totalEmployees: 50,
    respondents: 48,
    responseRate: 96.0,
    avgStressFactorScore: 78.5,  // 全国平均より+15%高い
    avgPhysicalMentalScore: 72.3,
    highStressRate: 28.0,        // 高ストレス者率28% (全国平均10%)
    overallRiskLevel: "high",
    recommendedImprovements: [
      { priority: "high", area: "業務量の適正化", action: "夜勤人員の増員" },
      { priority: "high", area: "職場の支援", action: "メンター制度の導入" }
    ]
  }
});

// 衛生委員会に報告
await reportToSafetyCommittee(groupAnalysis.id);
```

---

### まとめ

この設計により、以下が実現できます：

✅ **個人レベルの完全追跡**
- 57項目ストレスチェック詳細記録
- 経年変化の自動比較
- 高ストレス → 面接指導 → フォローアップの完全管理

✅ **健診×ストレス×メンタルの統合評価**
- 総合健康リスクの自動評価
- 複合的なリスク因子の可視化
- データドリブンな介入判断

✅ **法令完全遵守**
- 労働安全衛生法の全要件対応
- 5年間の記録保存
- 個人情報保護（同意管理）

✅ **VoiceDrive連携による就業措置の自動化**
- 夜勤制限・残業制限の自動反映
- シフト管理システムとの連動

**個人の健康状態を多角的に把握し、予防的介入が可能になります！**

---

## 21. ダッシュボード統合管理システム（評価進捗・システム連携・アラート管理）

### 背景と要件
- 現在の実装: **包括的なダッシュボード実装済み** - 評価進捗、システム連携、緊急タスク表示
- 表示データ:
  - 評価進捗（125名中78名完了、62%完了率）
  - 総合同期率98.5%、研修完了率89.2%
  - AI動的設問数248問
  - 緊急タスク（外科病棟5名締切、看護部評価項目未設定）
- **不足している項目**:
  - ダッシュボードデータの履歴保管（日次スナップショット）
  - システム連携率の詳細記録（各システムごとの同期状態）
  - アラート管理の完全トレーサビリティ
  - 評価制度バージョン管理の詳細履歴
  - AI動的設問の生成履歴・効果測定

### 必要なテーブル設計

#### 21-1. DashboardSnapshot（ダッシュボード日次スナップショット）

**目的**: ダッシュボードに表示される主要指標を日次で記録。経年変化・傾向分析が可能に。

```prisma
model DashboardSnapshot {
  id                    String    @id @default(cuid())

  // スナップショット情報
  snapshotDate          DateTime  @map("snapshot_date")
  // 日次スナップショット日時
  fiscalYear            Int       @map("fiscal_year")
  month                 Int
  // 1-12

  // 評価進捗サマリー
  totalStaff            Int       @map("total_staff")
  // 評価対象者総数
  completedEvaluations  Int       @map("completed_evaluations")
  // 評価完了数
  inProgressEvaluations Int       @map("in_progress_evaluations")
  // 評価中
  notStartedEvaluations Int       @map("not_started_evaluations")
  // 未着手
  completionRate        Float     @map("completion_rate")
  // 完了率（%）

  // システム連携状態
  overallSyncRate       Float     @map("overall_sync_rate")
  // 総合同期率（%）
  trainingSyncRate      Float?    @map("training_sync_rate")
  // 研修システム同期率
  attendanceSyncRate    Float?    @map("attendance_sync_rate")
  // 勤怠システム同期率
  healthSyncRate        Float?    @map("health_sync_rate")
  // 健康管理システム同期率
  voicedriveSyncRate    Float?    @map("voicedrive_sync_rate")
  // VoiceDrive同期率

  // 研修・教育統計
  trainingCompletionRate Float?   @map("training_completion_rate")
  // 研修完了率（%）
  activeTrainingPrograms Int?     @map("active_training_programs")
  // アクティブな研修プログラム数

  // AI動的設問統計
  totalDynamicQuestions  Int?     @map("total_dynamic_questions")
  // AI動的設問数
  questionsAddedToday    Int?     @default(0) @map("questions_added_today")
  // 当日追加設問数
  questionsRetiredToday  Int?     @default(0) @map("questions_retired_today")
  // 当日削除設問数

  // アラート統計
  activeAlerts          Int       @default(0) @map("active_alerts")
  // アクティブアラート数
  criticalAlerts        Int       @default(0) @map("critical_alerts")
  // 緊急アラート数
  warningAlerts         Int       @default(0) @map("warning_alerts")
  // 警告アラート数

  // 施設別内訳
  byFacility            Json?     @map("by_facility")
  // [
  //   {
  //     "facilityId": "obara-hospital",
  //     "facilityName": "小原病院",
  //     "totalStaff": 75,
  //     "completedEvaluations": 48,
  //     "completionRate": 64.0
  //   },
  //   {
  //     "facilityId": "tategami-rehabilitation",
  //     "facilityName": "立神リハビリテーション温泉病院",
  //     "totalStaff": 50,
  //     "completedEvaluations": 30,
  //     "completionRate": 60.0
  //   }
  // ]

  // 部署別内訳
  byDepartment          Json?     @map("by_department")
  // [
  //   { "department": "外科病棟", "totalStaff": 20, "completedEvaluations": 15, "urgentTasks": 5 },
  //   { "department": "看護部", "totalStaff": 45, "completedEvaluations": 28, "urgentTasks": 0 }
  // ]

  // スナップショット取得情報
  capturedAt            DateTime  @default(now()) @map("captured_at")
  capturedBy            String?   @map("captured_by")
  // system, batch-job等

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([snapshotDate])
  @@index([fiscalYear])
  @@index([month])
  @@index([snapshotDate])
  @@map("dashboard_snapshots")
}
```

#### 21-2. SystemIntegrationStatus（システム連携状態詳細記録）

**目的**: 各外部システムとの連携状態を詳細記録。同期エラー・再試行履歴を管理。

```prisma
model SystemIntegrationStatus {
  id                    String    @id @default(cuid())

  // システム識別
  systemName            String    @map("system_name")
  // VoiceDrive, TrainingSystem, HealthManagement, AttendanceSystem等
  systemType            String    @map("system_type")
  // external, internal, mcp-server

  // 連携状態
  syncStatus            String    @map("sync_status")
  // active（正常同期中）, degraded（一部エラー）, failed（同期失敗）, maintenance（メンテナンス中）
  lastSyncAt            DateTime? @map("last_sync_at")
  // 最終同期日時
  nextScheduledSync     DateTime? @map("next_scheduled_sync")
  // 次回同期予定日時

  // 同期率
  syncSuccessRate       Float?    @map("sync_success_rate")
  // 同期成功率（%）
  totalRecordsSynced    Int?      @default(0) @map("total_records_synced")
  // 総同期レコード数
  failedRecords         Int?      @default(0) @map("failed_records")
  // 失敗レコード数

  // エラー情報
  lastErrorMessage      String?   @db.Text @map("last_error_message")
  lastErrorAt           DateTime? @map("last_error_at")
  errorCount            Int       @default(0) @map("error_count")
  // 連続エラー回数
  retryCount            Int       @default(0) @map("retry_count")
  // リトライ回数

  // 接続情報
  apiEndpoint           String?   @map("api_endpoint")
  // API エンドポイント
  apiVersion            String?   @map("api_version")
  // APIバージョン
  authenticationMethod  String?   @map("authentication_method")
  // JWT, OAuth2, API-Key等

  // パフォーマンス
  averageResponseTime   Int?      @map("average_response_time")
  // 平均応答時間（ミリ秒）
  timeoutCount          Int?      @default(0) @map("timeout_count")
  // タイムアウト発生回数

  // データ量統計
  dataVolumeToday       Int?      @map("data_volume_today")
  // 本日の同期データ量（レコード数）
  dataVolumeThisMonth   Int?      @map("data_volume_this_month")
  // 今月の同期データ量

  // アラート設定
  alertEnabled          Boolean   @default(true) @map("alert_enabled")
  alertThreshold        Float?    @default(90.0) @map("alert_threshold")
  // 同期率がこの値を下回るとアラート（%）

  // 管理者情報
  responsibleUserId     String?   @map("responsible_user_id")
  // 担当者ID
  responsibleUserName   String?   @map("responsible_user_name")
  notificationEmail     String?   @map("notification_email")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([systemName])
  @@index([syncStatus])
  @@index([lastSyncAt])
  @@map("system_integration_statuses")
}
```

#### 21-3. DashboardAlert（ダッシュボードアラート管理）

**目的**: ダッシュボードに表示される緊急タスク・警告を完全管理。対応履歴・解決状況を追跡。

```prisma
model DashboardAlert {
  id                    String    @id @default(cuid())

  // アラート基本情報
  alertType             String    @map("alert_type")
  // urgent（緊急）, important（重要）, warning（警告）, info（情報）
  severity              String    @map("severity")
  // critical, high, medium, low
  category              String    @map("category")
  // evaluation_deadline（評価締切）, missing_config（設定不備）, sync_error（同期エラー）, training_overdue（研修遅延）等

  // アラート内容
  title                 String
  // 「本日締切の評価」
  description           String?   @db.Text
  // 「外科病棟 5名分の評価が未完了」
  detailUrl             String?   @map("detail_url")
  // /evaluation-execution/urgent

  // 関連情報
  relatedEntityType     String?   @map("related_entity_type")
  // department, employee, system, evaluation等
  relatedEntityId       String?   @map("related_entity_id")
  relatedEntityName     String?   @map("related_entity_name")
  // 「外科病棟」「看護部」等

  // 数値情報
  affectedCount         Int?      @map("affected_count")
  // 影響を受ける人数・件数（5名、等）
  thresholdValue        Float?    @map("threshold_value")
  // 閾値
  currentValue          Float?    @map("current_value")
  // 現在値

  // 期限情報
  deadline              DateTime? @map("deadline")
  // アラートに関連する期限
  daysUntilDeadline     Int?      @map("days_until_deadline")
  isOverdue             Boolean   @default(false) @map("is_overdue")

  // アラート状態
  status                String    @default("active") @map("status")
  // active（表示中）, acknowledged（確認済み）, resolved（解決済み）, dismissed（却下）
  acknowledgedAt        DateTime? @map("acknowledged_at")
  acknowledgedBy        String?   @map("acknowledged_by")
  resolvedAt            DateTime? @map("resolved_at")
  resolvedBy            String?   @map("resolved_by")
  resolutionNote        String?   @db.Text @map("resolution_note")

  // 優先度・表示制御
  priority              Int       @default(5) @map("priority")
  // 1-10（小さいほど優先度高）
  displayOnDashboard    Boolean   @default(true) @map("display_on_dashboard")
  dismissible           Boolean   @default(true) @map("dismissible")
  // ユーザーが却下可能か

  // 通知管理
  notificationSent      Boolean   @default(false) @map("notification_sent")
  notificationSentAt    DateTime? @map("notification_sent_at")
  notificationRecipients Json?    @map("notification_recipients")
  // ["user-123", "user-456"]

  // 自動生成情報
  autoGenerated         Boolean   @default(false) @map("auto_generated")
  // システムが自動生成したアラートか
  generationRule        String?   @map("generation_rule")
  // 「評価締切日の3日前」等のルール

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([alertType])
  @@index([severity])
  @@index([category])
  @@index([status])
  @@index([deadline])
  @@index([createdAt])
  @@map("dashboard_alerts")
}
```

#### 21-4. EvaluationSystemVersion（評価制度バージョン管理）

**目的**: 評価制度のバージョン（1.0.0現行、2.0.0準備中等）を完全管理。移行履歴・テスト運用記録。

```prisma
model EvaluationSystemVersion {
  id                    String    @id @default(cuid())

  // バージョン情報
  systemCode            String    @unique @map("system_code")
  // SYS_2024_001, SYS_2025_001等
  version               String
  // 1.0.0, 2.0.0-beta等
  versionName           String    @map("version_name")
  // 2024年度評価制度（現行）

  // 状態
  status                String    @map("status")
  // active（運用中）, preparing（準備中）, testing（テスト中）, archived（アーカイブ）
  effectiveFrom         DateTime  @map("effective_from")
  effectiveTo           DateTime? @map("effective_to")
  // NULL = 無期限

  // 制度説明
  description           String?   @db.Text
  // 「施設内×法人内の2軸マトリックス評価」
  features              Json?
  // [
  //   "技術評価50点・組織貢献50点",
  //   "5×5マトリックスから7段階評価",
  //   "相対評価による順位付け",
  //   "部署別カスタマイズ対応"
  // ]

  // 評価項目設定
  technicalEvaluationPoints     Int?      @map("technical_evaluation_points")
  // 技術評価配点
  contributionEvaluationPoints  Int?      @map("contribution_evaluation_points")
  // 貢献度評価配点
  competencyEvaluationPoints    Int?      @map("competency_evaluation_points")
  // コンピテンシー評価配点（2.0.0以降）
  totalPoints                   Int       @default(100) @map("total_points")
  // 総配点

  // 評価方法
  evaluationMethod      String?   @map("evaluation_method")
  // relative（相対評価）, absolute（絶対評価）, hybrid（混合）
  matrixSize            String?   @map("matrix_size")
  // 5x5, 7x7等
  finalGradeScale       String?   @map("final_grade_scale")
  // 7段階（S+, S, A+, A, B, C, D）等

  // テスト運用情報
  isTestVersion         Boolean   @default(false) @map("is_test_version")
  testDepartments       Json?     @map("test_departments")
  // テスト対象部署
  // ["リハビリテーション科", "外科病棟"]
  testStartDate         DateTime? @map("test_start_date")
  testEndDate           DateTime? @map("test_end_date")
  testParticipantCount  Int?      @map("test_participant_count")

  // 移行情報
  previousVersionId     String?   @map("previous_version_id")
  migrationNotes        String?   @db.Text @map("migration_notes")
  // 「移行期間中は両制度で並行評価を実施」
  migrationStartDate    DateTime? @map("migration_start_date")
  migrationEndDate      DateTime? @map("migration_end_date")

  // 承認情報
  approvedBy            String?   @map("approved_by")
  approvedAt            DateTime? @map("approved_at")
  approvalStatus        String?   @default("draft") @map("approval_status")
  // draft（草案）, approved（承認済み）, rejected（却下）

  // 利用統計
  activeUserCount       Int?      @default(0) @map("active_user_count")
  // このバージョンを使用中の職員数
  totalEvaluationsCompleted Int?  @default(0) @map("total_evaluations_completed")
  // このバージョンで完了した評価数

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@map("evaluation_system_versions")
}
```

#### 21-5. AIDynamicQuestionLog（AI動的設問生成ログ）

**目的**: AI動的設問の生成・削除・効果を記録。設問の有効性を評価し、継続的改善に活用。

```prisma
model AIDynamicQuestionLog {
  id                    String    @id @default(cuid())

  // 設問情報
  questionId            String    @map("question_id")
  // DynamicQuestionテーブルのID（Section 3で定義済み）
  questionText          String    @db.Text @map("question_text")
  // 設問文
  questionCategory      String    @map("question_category")
  // technical（技術）, contribution（貢献）, competency（コンピテンシー）

  // AI生成情報
  generatedBy           String    @map("generated_by")
  // AI, manual（手動）
  aiModel               String?   @map("ai_model")
  // gpt-4, claude-3等
  generationPrompt      String?   @db.Text @map("generation_prompt")
  // AI生成時のプロンプト
  generatedAt           DateTime  @default(now()) @map("generated_at")

  // 対象部署・職種
  targetDepartment      String?   @map("target_department")
  targetPosition        String?   @map("target_position")
  // 看護師、理学療法士等

  // 設問の状態
  status                String    @default("active") @map("status")
  // active（使用中）, retired（削除）, draft（草案）
  activatedAt           DateTime? @map("activated_at")
  retiredAt             DateTime? @map("retired_at")
  retiredReason         String?   @db.Text @map("retired_reason")
  // 「回答率が低い」「評価に寄与しない」等

  // 使用統計
  timesUsed             Int       @default(0) @map("times_used")
  // この設問が使用された回数
  averageScore          Float?    @map("average_score")
  // 平均スコア
  responseRate          Float?    @map("response_rate")
  // 回答率（%）

  // 効果測定
  correlationWithFinalGrade Float? @map("correlation_with_final_grade")
  // 最終評価との相関係数（-1 ~ 1）
  discriminationIndex   Float?    @map("discrimination_index")
  // 識別指数（この設問が評価の差を識別できるか）
  reliability           Float?    @map("reliability")
  // 信頼性係数（Cronbach's α等）

  // フィードバック
  positiveFeeback       Int       @default(0) @map("positive_feedback")
  // 良い評価を受けた回数
  negativeFeedback      Int       @default(0) @map("negative_feedback")
  // 悪い評価を受けた回数
  feedbackComments      Json?     @map("feedback_comments")
  // [
  //   { "userId": "user-123", "comment": "この設問は適切", "timestamp": "2025-10-01T10:00:00Z" }
  // ]

  // 改訂履歴
  originalQuestionId    String?   @map("original_question_id")
  // 元の設問ID（改訂版の場合）
  revisionNumber        Int       @default(1) @map("revision_number")
  // 改訂バージョン番号
  revisionReason        String?   @db.Text @map("revision_reason")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([questionId])
  @@index([status])
  @@index([generatedAt])
  @@index([targetDepartment])
  @@index([correlationWithFinalGrade])
  @@map("ai_dynamic_question_logs")
}
```

### 実装による効果

✅ **ダッシュボードデータの完全履歴化**
- 日次スナップショットで経年変化を追跡
- 評価進捗・同期率の傾向分析
- 施設別・部署別の詳細内訳保管

✅ **システム連携の可視化と管理**
- 各外部システムの同期状態をリアルタイム監視
- エラー・リトライの完全トレーサビリティ
- 同期率低下時の自動アラート

✅ **アラート管理の体系化**
- 緊急タスクの対応履歴を完全記録
- 優先度・期限に基づく自動アラート生成
- 解決状況の追跡と効果測定

✅ **評価制度バージョンの完全管理**
- 複数バージョンの並行運用対応
- テスト運用から本番移行までの履歴
- 移行計画・承認プロセスの記録

✅ **AI動的設問の継続的改善**
- 設問の有効性を統計的に評価
- 効果の低い設問の自動検出
- フィードバックに基づく設問改訂

**ダッシュボードを単なる表示ツールから、データドリブンな意思決定基盤へと進化させます！**

---

## 22. レポート・分析システム（100ページ超の包括的分析基盤）

### 背景と要件
- 現在の実装: **11カテゴリー、100ページ以上の包括的レポートシステム実装済み**
- 主要カテゴリー:
  1. **基本指標**: 職員数、構成比、採用・離職統計（15サブレポート）
  2. **戦略分析**: 人材戦略立案のための高度分析
  3. **定着分析**: 定着率向上のための詳細分析
  4. **離職分析**: AI離職リスク予測、要因分析、シミュレーション（12サブレポート）
  5. **タレントマッピング**: 人材の可視化と戦略的配置
  6. **人材フロー**: 組織内人材の動き分析
  7. **コホート分析**: 世代・入社年次別傾向分析（12サブレポート）
  8. **シミュレーション**: What-if分析と将来予測（5サブレポート）
  9. **ウェルビーイング**: 心身健康・幸福度の多角的分析（5サブレポート）
  10. **VoiceDrive分析**: K-匿名性（K≥5）保護下での集団分析・感情分析
  11. **人事評価分析**: スキル×成果の2軸評価分析（8サブレポート）

- **不足している項目**:
  - VoiceDrive投稿データの同意管理・K-匿名性チェック・感情分析結果保管
  - AI離職リスク予測モデルの学習データ・予測結果保管
  - コホート分析の世代定義・追跡データ
  - ウェルビーイング総合指標の計算結果保管
  - タレントマッピングのスキルマトリックス・後継者計画
  - シミュレーション結果の保管・比較分析

### 必要なテーブル設計

#### 22-1. VoiceDriveConsentManagement（VoiceDrive同意管理）

**目的**: 職員ごとのVoiceDrive投稿データ利用同意を管理。K-匿名性チェックの基盤データ。

```prisma
model VoiceDriveConsentManagement {
  id                    String    @id @default(cuid())

  // 職員情報
  employeeId            String    @unique @map("employee_id")

  // 同意状態
  consentStatus         String    @default("not_requested") @map("consent_status")
  // not_requested（未依頼）, requested（依頼済み）, consented（同意済み）, declined（拒否）, revoked（同意撤回）
  consentDate           DateTime? @map("consent_date")
  // 同意日時
  revokedDate           DateTime? @map("revoked_date")
  // 同意撤回日時

  // 同意内容
  consentVersion        String?   @map("consent_version")
  // 同意書バージョン（v1.0, v2.0等）
  consentedDataTypes    Json?     @map("consented_data_types")
  // [
  //   "voice_posts",       // 音声投稿
  //   "text_transcripts",  // テキスト化データ
  //   "sentiment_scores",  // 感情スコア
  //   "topic_tags"         // トピックタグ
  // ]

  // データ利用範囲
  allowGroupAnalysis    Boolean   @default(false) @map("allow_group_analysis")
  // 集団分析への利用許可
  allowSentimentAnalysis Boolean  @default(false) @map("allow_sentiment_analysis")
  // 感情分析への利用許可
  allowTopicAnalysis    Boolean   @default(false) @map("allow_topic_analysis")
  // トピック分析への利用許可

  // K-匿名性保護設定
  minimumGroupSize      Int       @default(5) @map("minimum_group_size")
  // 最小グループサイズ（K値）
  participateInKCheck   Boolean   @default(true) @map("participate_in_k_check")
  // K-匿名性チェックに参加するか

  // データ削除リクエスト（GDPR対応）
  deletionRequested     Boolean   @default(false) @map("deletion_requested")
  deletionRequestDate   DateTime? @map("deletion_request_date")
  deletionCompletedDate DateTime? @map("deletion_completed_date")
  deletionReason        String?   @db.Text @map("deletion_reason")

  // VoiceDrive連携
  voicedriveUserId      String?   @map("voicedrive_user_id")
  voicedriveSyncStatus  String?   @default("pending") @map("voicedrive_sync_status")
  // pending, synced, failed
  lastSyncedAt          DateTime? @map("last_synced_at")

  // 通知管理
  consentRequestSent    Boolean   @default(false) @map("consent_request_sent")
  consentRequestSentAt  DateTime? @map("consent_request_sent_at")
  reminderSentCount     Int       @default(0) @map("reminder_sent_count")
  lastReminderSentAt    DateTime? @map("last_reminder_sent_at")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([consentStatus])
  @@index([consentDate])
  @@index([deletionRequested])
  @@map("voicedrive_consent_management")
}
```

#### 22-2. VoiceDriveSentimentAnalysis（VoiceDrive感情分析結果）

**目的**: VoiceDrive投稿の感情分析結果を保管。K-匿名性保護下での集団分析に使用。

```prisma
model VoiceDriveSentimentAnalysis {
  id                    String    @id @default(cuid())

  // 分析対象期間
  analysisDate          DateTime  @map("analysis_date")
  analysisPeriod        String    @map("analysis_period")
  // daily, weekly, monthly, quarterly

  // 対象範囲
  facilityId            String?   @map("facility_id")
  // NULL = 全施設
  departmentId          String?   @map("department_id")
  // NULL = 全部署

  // K-匿名性チェック
  participantCount      Int       @map("participant_count")
  // 分析対象人数
  kValue                Int       @map("k_value")
  // K-匿名性値
  kAnonymityPassed      Boolean   @map("k_anonymity_passed")
  // K≥5を満たすか

  // 感情分析結果（集団統計）
  averageSentimentScore Float?    @map("average_sentiment_score")
  // 平均感情スコア（-1.0 ~ 1.0）
  positivePercentage    Float?    @map("positive_percentage")
  // ポジティブ投稿の割合（%）
  neutralPercentage     Float?    @map("neutral_percentage")
  negativePercentage    Float?    @map("negative_percentage")

  // 感情分布
  sentimentDistribution Json?     @map("sentiment_distribution")
  // {
  //   "very_positive": 15,  // 非常にポジティブ
  //   "positive": 30,
  //   "neutral": 40,
  //   "negative": 12,
  //   "very_negative": 3
  // }

  // トピック分析
  topTopics             Json?     @map("top_topics")
  // [
  //   { "topic": "業務負担", "count": 25, "averageSentiment": -0.3 },
  //   { "topic": "チームワーク", "count": 18, "averageSentiment": 0.6 },
  //   { "topic": "職場環境", "count": 15, "averageSentiment": 0.2 }
  // ]

  // ワードクラウドデータ
  frequentWords         Json?     @map("frequent_words")
  // [
  //   { "word": "忙しい", "count": 45, "sentiment": -0.4 },
  //   { "word": "やりがい", "count": 32, "sentiment": 0.7 }
  // ]

  // 時系列比較
  previousPeriodId      String?   @map("previous_period_id")
  // 前回分析のID
  sentimentChange       Float?    @map("sentiment_change")
  // 前回比の変化率（%）

  // アラート情報
  hasNegativeTrend      Boolean   @default(false) @map("has_negative_trend")
  // ネガティブトレンド検出
  alertGenerated        Boolean   @default(false) @map("alert_generated")
  alertReason           String?   @db.Text @map("alert_reason")

  // 分析メタデータ
  totalPostsAnalyzed    Int       @map("total_posts_analyzed")
  // 分析した投稿数
  aiModel               String?   @map("ai_model")
  // 使用したAIモデル（GPT-4, Claude等）
  analysisQuality       String?   @map("analysis_quality")
  // high, medium, low

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([analysisDate, analysisPeriod, facilityId, departmentId])
  @@index([analysisDate])
  @@index([facilityId])
  @@index([departmentId])
  @@index([kAnonymityPassed])
  @@map("voicedrive_sentiment_analysis")
}
```

#### 22-3. TurnoverRiskPrediction（離職リスク予測）

**目的**: AI機械学習による個人別離職リスク予測結果を保管。早期警告システムの基盤。

```prisma
model TurnoverRiskPrediction {
  id                    String    @id @default(cuid())

  // 予測対象
  employeeId            String    @map("employee_id")
  predictionDate        DateTime  @default(now()) @map("prediction_date")
  // 予測実施日

  // リスクスコア
  riskScore             Float     @map("risk_score")
  // 0.0-1.0（1.0 = 100%離職リスク）
  riskLevel             String    @map("risk_level")
  // low（低）, medium（中）, high（高）, critical（緊急）
  riskPercentile        Int?      @map("risk_percentile")
  // 全職員中の順位（%）

  // 予測期間
  predictionHorizon     String    @map("prediction_horizon")
  // 3_months, 6_months, 12_months
  predictedTurnoverDate DateTime? @map("predicted_turnover_date")
  // 離職予測日

  // 主要リスク要因（上位5つ）
  topRiskFactors        Json      @map("top_risk_factors")
  // [
  //   { "factor": "勤続年数", "weight": 0.25, "value": "1.2年", "impact": "high" },
  //   { "factor": "残業時間", "weight": 0.18, "value": "月80時間", "impact": "high" },
  //   { "factor": "評価スコア", "weight": 0.15, "value": "B評価", "impact": "medium" },
  //   { "factor": "ストレススコア", "weight": 0.12, "value": "高ストレス", "impact": "medium" },
  //   { "factor": "有給取得率", "weight": 0.10, "value": "20%", "impact": "low" }
  // ]

  // 入力特徴量
  inputFeatures         Json?     @map("input_features")
  // {
  //   "tenure_months": 14,
  //   "avg_overtime_hours": 78.5,
  //   "evaluation_score": 65,
  //   "stress_score": 85,
  //   "paid_leave_usage_rate": 0.2,
  //   "training_hours": 12,
  //   "department_turnover_rate": 0.15
  // }

  // モデル情報
  modelVersion          String    @map("model_version")
  // v1.0, v2.0等
  modelType             String    @map("model_type")
  // random_forest, gradient_boosting, neural_network等
  modelAccuracy         Float?    @map("model_accuracy")
  // モデル精度（0.0-1.0）
  confidenceLevel       Float?    @map("confidence_level")
  // 予測の信頼度（0.0-1.0）

  // 推奨アクション
  recommendedActions    Json?     @map("recommended_actions")
  // [
  //   {
  //     "action": "上司との1on1面談実施",
  //     "priority": "high",
  //     "deadline": "2025-11-01",
  //     "expectedImpact": "リスク20%低減"
  //   },
  //   {
  //     "action": "残業時間削減計画",
  //     "priority": "high",
  //     "deadline": "2025-10-15",
  //     "expectedImpact": "リスク15%低減"
  //   }
  // ]

  // 追跡情報
  actualTurnover        Boolean?  @map("actual_turnover")
  // 実際に離職したか
  actualTurnoverDate    DateTime? @map("actual_turnover_date")
  predictionAccurate    Boolean?  @map("prediction_accurate")
  // 予測が正確だったか

  // 介入記録
  interventionTaken     Boolean   @default(false) @map("intervention_taken")
  interventionDate      DateTime? @map("intervention_date")
  interventionType      String?   @map("intervention_type")
  // one_on_one, workload_adjustment, salary_review等
  interventionNotes     String?   @db.Text @map("intervention_notes")

  // アラート管理
  alertSent             Boolean   @default(false) @map("alert_sent")
  alertSentTo           Json?     @map("alert_sent_to")
  // ["direct_manager", "hr_dept", "facility_manager"]
  alertSentAt           DateTime? @map("alert_sent_at")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([employeeId])
  @@index([predictionDate])
  @@index([riskLevel])
  @@index([riskScore])
  @@index([actualTurnover])
  @@map("turnover_risk_predictions")
}
```

#### 22-4. CohortDefinition（コホート定義）

**目的**: 入社年次、世代、部署等のコホート（集団）を定義。長期的な追跡分析の基盤。

```prisma
model CohortDefinition {
  id                    String    @id @default(cuid())

  // コホート基本情報
  cohortCode            String    @unique @map("cohort_code")
  // 2020_cohort, gen_z_cohort, nursing_2019等
  cohortName            String    @map("cohort_name")
  // 2020年度入社コホート、Z世代コホート等
  cohortType            String    @map("cohort_type")
  // entry_year（入社年次）, generation（世代）, department（部署）, position（職種）, recruitment_type（採用形態）

  // コホート定義条件
  definitionCriteria    Json      @map("definition_criteria")
  // {
  //   "entry_year": 2020,
  //   "entry_month_from": 4,
  //   "entry_month_to": 3
  // }
  // または
  // {
  //   "birth_year_from": 1997,
  //   "birth_year_to": 2012,
  //   "generation_name": "Z世代"
  // }

  // メンバー情報
  currentMemberCount    Int       @default(0) @map("current_member_count")
  initialMemberCount    Int       @map("initial_member_count")
  // 開始時点のメンバー数
  retentionRate         Float?    @map("retention_rate")
  // 定着率（%）

  // 追跡期間
  trackingStartDate     DateTime  @map("tracking_start_date")
  trackingEndDate       DateTime? @map("tracking_end_date")
  // NULL = 継続追跡中
  trackingStatus        String    @default("active") @map("tracking_status")
  // active（追跡中）, completed（完了）, paused（一時停止）

  // 分析設定
  analysisFrequency     String    @default("quarterly") @map("analysis_frequency")
  // monthly, quarterly, yearly
  lastAnalysisDate      DateTime? @map("last_analysis_date")
  nextScheduledAnalysis DateTime? @map("next_scheduled_analysis")

  // ベンチマークデータ
  industryBenchmark     Json?     @map("industry_benchmark")
  // {
  //   "3_year_retention": 0.65,
  //   "avg_promotion_years": 4.2
  // }

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([cohortType])
  @@index([trackingStatus])
  @@index([trackingStartDate])
  @@map("cohort_definitions")
}
```

#### 22-5. CohortTrackingSnapshot（コホート追跡スナップショット）

**目的**: コホートごとの定期スナップショットを保管。経年変化・施策効果測定に使用。

```prisma
model CohortTrackingSnapshot {
  id                    String    @id @default(cuid())

  // コホート識別
  cohortId              String    @map("cohort_id")
  // CohortDefinition.id
  cohortCode            String    @map("cohort_code")

  // スナップショット情報
  snapshotDate          DateTime  @map("snapshot_date")
  periodsSinceStart     Int       @map("periods_since_start")
  // 追跡開始からの経過期間数（四半期数、年数等）

  // メンバー統計
  currentMemberCount    Int       @map("current_member_count")
  activeMembers         Int       @map("active_members")
  turnedOverMembers     Int       @map("turned_over_members")
  cumulativeTurnover    Int       @map("cumulative_turnover")
  // 累積離職者数
  retentionRate         Float     @map("retention_rate")
  // 定着率（%）
  survivalRate          Float     @map("survival_rate")
  // 生存率（%）

  // 離職分析
  turnoverThisPeriod    Int       @map("turnover_this_period")
  // 今期の離職者数
  turnoverRate          Float     @map("turnover_rate")
  // 今期の離職率（%）
  hazardRate            Float?    @map("hazard_rate")
  // ハザード率（離職リスク率）

  // パフォーマンス統計
  avgEvaluationScore    Float?    @map("avg_evaluation_score")
  avgPromotionCount     Float?    @map("avg_promotion_count")
  promotedCount         Int?      @default(0) @map("promoted_count")
  // 昇進者数

  // エンゲージメント統計
  avgEngagementScore    Float?    @map("avg_engagement_score")
  highEngagementPercent Float?    @map("high_engagement_percent")
  // 高エンゲージメント者の割合（%）

  // 研修・育成統計
  avgTrainingHours      Float?    @map("avg_training_hours")
  certificationRate     Float?    @map("certification_rate")
  // 資格取得率（%）

  // 部署別分布
  departmentDistribution Json?    @map("department_distribution")
  // [
  //   { "department": "内科病棟", "count": 12, "percentage": 30.0 },
  //   { "department": "外科病棟", "count": 8, "percentage": 20.0 }
  // ]

  // 前回比較
  previousSnapshotId    String?   @map("previous_snapshot_id")
  memberCountChange     Int?      @map("member_count_change")
  retentionRateChange   Float?    @map("retention_rate_change")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([cohortId, snapshotDate])
  @@index([cohortId])
  @@index([cohortCode])
  @@index([snapshotDate])
  @@index([periodsSinceStart])
  @@map("cohort_tracking_snapshots")
}
```

### Employeeテーブルへの追加フィールド

```prisma
// 既存のEmployeeモデルに追加
model Employee {
  // ... 既存フィールド

  // VoiceDrive分析関連
  voicedriveConsentStatus String?   @map("voicedrive_consent_status")
  // consented, declined, not_requested
  voicedriveConsentDate   DateTime? @map("voicedrive_consent_date")

  // 離職リスク関連（キャッシュ）
  latestTurnoverRiskScore Float?    @map("latest_turnover_risk_score")
  latestTurnoverRiskLevel String?   @map("latest_turnover_risk_level")
  // low, medium, high, critical
  turnoverRiskUpdatedAt   DateTime? @map("turnover_risk_updated_at")

  // コホート関連
  entryCohortId           String?   @map("entry_cohort_id")
  // 入社年次コホートID
  generationCohortId      String?   @map("generation_cohort_id")
  // 世代コホートID

  // ... 既存フィールド
}
```

### 実装による効果

✅ **VoiceDrive分析の完全対応**
- K-匿名性（K≥5）保護下での集団分析
- 同意管理・データ削除リクエスト（GDPR対応）
- 感情分析・トピック分析・ワードクラウド
- 施設別・部署別の感情トレンド追跡

✅ **AI離職リスク予測の実装基盤**
- 個人別リスクスコアのリアルタイム計算
- 主要リスク要因の特定と重み付け
- 推奨アクションの自動提案
- 予測精度の継続的検証

✅ **コホート分析の完全実装**
- 入社年次・世代・部署別の長期追跡
- 定着率・生存率の経年変化
- 施策効果の測定と比較
- 業界ベンチマークとの比較

✅ **100ページ超のレポート機能を支える基盤**
- 11カテゴリー全てのデータソース確保
- 施設単位・部署単位・個人単位の集計対応
- 時系列分析・トレンド予測のデータ蓄積
- シミュレーション・What-if分析の実行基盤

**人事部が必要とする全ての分析を、個人のプライバシーを保護しながら実現できます！**

---

## 23. 面談制度統合管理システム（10種類面談・質問バンク・AI分析）

### 背景と要件
- 現在の実装: **10種類の面談体系、質問バンクシステム、AI分析機能実装済み**
- 面談体系:
  - **定期面談（3種類）**: 新入職員月次、一般職員年次、管理職半年
  - **特別面談（3種類）**: 復職、インシデント後、退職
  - **サポート面談（4種類）**: フィードバック、キャリア系、職場環境系、個別相談
- 主要機能:
  - 面談ステーション（予約・実施管理）
  - 質問バンク（892問の定期面談質問、168問のサポート面談質問、187問の特別面談質問）
  - セクション定義システム（経験年数別・職種別カスタマイズ）
  - AI動的質問生成
  - 面談シミュレーター
  - 統合分析・履歴追跡

- **不足している項目**:
  - 質問バンクの完全管理（カテゴリ・タグ・優先度・使用頻度）
  - セクション定義の動的生成履歴
  - 経験年数別・職種別・管理職別のテンプレート管理
  - 面談結果の詳細分析データ（AI解釈コメント、セクション相関分析）
  - VoiceDrive連携による自動面談トリガー記録

### 必要なテーブル設計

#### 23-1. InterviewQuestionBank（面談質問バンク）

**目的**: 全ての面談質問を一元管理。経験年数・職種・面談種類別に分類し、AI生成質問も含む。

```prisma
model InterviewQuestionBank {
  id                    String    @id @default(cuid())

  // 質問基本情報
  questionCode          String    @unique @map("question_code")
  // Q_NEW_001, Q_ANNUAL_050, Q_EXIT_012等
  questionText          String    @db.Text @map("question_text")
  questionType          String    @map("question_type")
  // textarea, radio, checkbox, rating, scale

  // 分類
  interviewClassification String  @map("interview_classification")
  // regular（定期）, special（特別）, support（サポート）
  interviewType         String    @map("interview_type")
  // new_employee_monthly, regular_annual, exit_interview等
  category              String    @map("category")
  // work_adaptation, skill_assessment, career_aspiration等

  // タグ・キーワード
  tags                  Json?     @map("tags")
  // ["新人", "適応状況", "必須質問"]
  keywords              Json?     @map("keywords")
  // 検索用キーワード

  // 優先度・重要度
  priority              Int       @default(3) @map("priority")
  // 1（必須）, 2（推奨）, 3（オプション）
  importanceScore       Float?    @map("importance_score")
  // AI計算による重要度スコア（0.0-1.0）

  // 対象条件
  targetExperienceYears Json?     @map("target_experience_years")
  // { "min": 0, "max": 1 }（新人向け）、{ "min": 2 }（2年目以降）
  targetPositions       Json?     @map("target_positions")
  // ["看護師", "理学療法士"]
  targetManagementLevel String?   @map("target_management_level")
  // staff（一般）, leader（主任）, manager（管理職）

  // AI生成情報
  isAIGenerated         Boolean   @default(false) @map("is_ai_generated")
  aiModel               String?   @map("ai_model")
  // GPT-4, Claude等
  aiGenerationPrompt    String?   @db.Text @map("ai_generation_prompt")
  humanReviewed         Boolean   @default(false) @map("human_reviewed")
  // 人間による確認済み

  // 使用統計
  usageCount            Int       @default(0) @map("usage_count")
  // この質問が使用された回数
  lastUsedAt            DateTime? @map("last_used_at")
  avgResponseTime       Int?      @map("avg_response_time")
  // 平均回答時間（秒）
  skipRate              Float?    @map("skip_rate")
  // スキップ率（%）

  // 効果測定
  satisfactionScore     Float?    @map("satisfaction_score")
  // 面談者からの質問評価（1-5）
  insightfulness        Float?    @map("insightfulness")
  // 洞察力スコア（AI計算）
  correlationWithOutcome Float?   @map("correlation_with_outcome")
  // 面談成果との相関

  // 状態管理
  status                String    @default("active") @map("status")
  // active, draft, archived, deprecated
  version               Int       @default(1) @map("version")
  // バージョン管理
  previousVersionId     String?   @map("previous_version_id")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([interviewType])
  @@index([category])
  @@index([priority])
  @@index([status])
  @@index([isAIGenerated])
  @@map("interview_question_bank")
}
```

#### 23-2. InterviewSectionTemplate（面談セクションテンプレート）

**目的**: 面談シートのセクション構成を定義。経験年数・職種別に異なるセクションを動的生成。

```prisma
model InterviewSectionTemplate {
  id                    String    @id @default(cuid())

  // テンプレート基本情報
  templateCode          String    @unique @map("template_code")
  // TMPL_NEW_NURSE_3M, TMPL_ANNUAL_PT_5Y等
  templateName          String    @map("template_name")
  // 「新人看護師3ヶ月面談テンプレート」

  // 対象条件
  interviewType         String    @map("interview_type")
  targetExperienceYears Json?     @map("target_experience_years")
  // { "min": 0, "max": 3 }
  targetPosition        String?   @map("target_position")
  targetManagementLevel String?   @map("target_management_level")

  // セクション構成
  sectionDefinitions    Json      @map("section_definitions")
  // [
  //   {
  //     "sectionId": "work_adaptation",
  //     "sectionTitle": "業務適応状況",
  //     "displayOrder": 1,
  //     "isRequired": true,
  //     "estimatedMinutes": 10,
  //     "questions": ["Q_NEW_001", "Q_NEW_002", "Q_NEW_003"]
  //   },
  //   {
  //     "sectionId": "skill_assessment",
  //     "sectionTitle": "技術習得状況",
  //     "displayOrder": 2,
  //     "isRequired": true,
  //     "estimatedMinutes": 15,
  //     "questions": ["Q_NEW_010", "Q_NEW_011"]
  //   }
  // ]

  totalEstimatedMinutes Int?      @map("total_estimated_minutes")
  // セクション合計の推定時間

  // 使用統計
  usageCount            Int       @default(0) @map("usage_count")
  lastUsedAt            DateTime? @map("last_used_at")
  avgCompletionRate     Float?    @map("avg_completion_rate")
  // 平均完了率（%）

  // 状態管理
  status                String    @default("active") @map("status")
  version               Int       @default(1) @map("version")
  approvedBy            String?   @map("approved_by")
  approvedAt            DateTime? @map("approved_at")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([interviewType])
  @@index([targetPosition])
  @@index([status])
  @@map("interview_section_templates")
}
```

#### 23-3. InterviewSheetInstance（面談シート実施インスタンス）

**目的**: 実際に実施された面談の質問・回答を完全記録。個別カスタマイズの履歴も保管。

```prisma
model InterviewSheetInstance {
  id                    String    @id @default(cuid())

  // 面談基本情報
  interviewId           String    @unique @map("interview_id")
  // Interviewテーブル（セクション1で定義済み）との紐付け
  employeeId            String    @map("employee_id")

  // テンプレート情報
  templateId            String?   @map("template_id")
  // InterviewSectionTemplate.id
  templateCode          String?   @map("template_code")
  // 使用したテンプレート

  // 実施情報
  conductedAt           DateTime  @map("conducted_at")
  conductedBy           String    @map("conducted_by")
  // 面談者ID
  duration              Int?      @map("duration")
  // 実際の面談時間（分）

  // セクション・質問構成
  sheetStructure        Json      @map("sheet_structure")
  // [
  //   {
  //     "sectionId": "work_adaptation",
  //     "sectionTitle": "業務適応状況",
  //     "questions": [
  //       {
  //         "questionId": "Q_NEW_001",
  //         "questionText": "現在の業務に慣れてきましたか？",
  //         "questionType": "rating",
  //         "answer": "4",
  //         "answerText": "かなり慣れてきた",
  //         "responseTime": 120,
  //         "skipped": false
  //       }
  //     ]
  //   }
  // ]

  // カスタマイズ履歴
  customQuestions       Json?     @map("custom_questions")
  // 面談者が追加した独自質問
  removedQuestions      Json?     @map("removed_questions")
  // テンプレートから削除した質問

  // 全体サマリー
  completionRate        Float     @map("completion_rate")
  // 完了率（%）
  totalQuestions        Int       @map("total_questions")
  answeredQuestions     Int       @map("answered_questions")
  skippedQuestions      Int       @map("skipped_questions")

  // AI分析結果（後述のInterviewAIAnalysisと連携）
  aiAnalysisId          String?   @map("ai_analysis_id")
  hasAIAnalysis         Boolean   @default(false) @map("has_ai_analysis")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([employeeId])
  @@index([templateId])
  @@index([conductedAt])
  @@map("interview_sheet_instances")
}
```

#### 23-4. InterviewAIAnalysis（面談AI分析結果）

**目的**: AI分析による洞察、セクション相関、改善提案を保管。継続的な質の向上に活用。

```prisma
model InterviewAIAnalysis {
  id                    String    @id @default(cuid())

  // 分析対象
  interviewId           String    @unique @map("interview_id")
  sheetInstanceId       String    @map("sheet_instance_id")
  employeeId            String    @map("employee_id")

  // AI分析サマリー
  overallSentiment      String?   @map("overall_sentiment")
  // positive, neutral, negative, mixed
  sentimentScore        Float?    @map("sentiment_score")
  // -1.0（非常にネガティブ）〜 1.0（非常にポジティブ）

  // セクション別分析
  sectionAnalysis       Json      @map("section_analysis")
  // [
  //   {
  //     "sectionId": "work_adaptation",
  //     "sentiment": "positive",
  //     "score": 0.75,
  //     "keyFindings": ["職場環境に良好に適応", "チームとの関係良好"],
  //     "concerns": []
  //   },
  //   {
  //     "sectionId": "skill_assessment",
  //     "sentiment": "neutral",
  //     "score": 0.2,
  //     "keyFindings": ["基本技術は習得中"],
  //     "concerns": ["夜勤業務への不安あり"]
  //   }
  // ]

  // AI解釈コメント
  interpretationComments Json     @map("interpretation_comments")
  // [
  //   {
  //     "category": "strength",
  //     "comment": "チームワークと適応力に優れている",
  //     "confidence": 0.85
  //   },
  //   {
  //     "category": "concern",
  //     "comment": "夜勤業務への不安が高い。追加研修が必要",
  //     "confidence": 0.78
  //   }
  // ]

  // リスク評価
  turnoverRisk          String?   @map("turnover_risk")
  // low, medium, high, critical
  turnoverRiskScore     Float?    @map("turnover_risk_score")
  // 0.0-1.0
  riskFactors           Json?     @map("risk_factors")
  // ["夜勤負担", "スキル不安"]

  // 推奨アクション
  recommendedActions    Json?     @map("recommended_actions")
  // [
  //   {
  //     "action": "夜勤トレーニングプログラム実施",
  //     "priority": "high",
  //     "deadline": "2025-11-30",
  //     "assignedTo": "先輩看護師"
  //   }
  // ]

  // セクション相関分析
  sectionCorrelations   Json?     @map("section_correlations")
  // {
  //   "work_adaptation_vs_skill_assessment": 0.65,
  //   "skill_assessment_vs_career_aspiration": 0.42
  // }

  // 前回比較
  previousAnalysisId    String?   @map("previous_analysis_id")
  improvementAreas      Json?     @map("improvement_areas")
  // 前回と比較して改善した領域
  deteriorationAreas    Json?     @map("deterioration_areas")
  // 前回と比較して悪化した領域

  // AI情報
  aiModel               String    @map("ai_model")
  // GPT-4, Claude-3等
  modelVersion          String    @map("model_version")
  analysisConfidence    Float     @map("analysis_confidence")
  // 分析の信頼度（0.0-1.0）
  analysisQuality       String    @map("analysis_quality")
  // high, medium, low

  // メタデータ
  analyzedAt            DateTime  @default(now()) @map("analyzed_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([employeeId])
  @@index([turnoverRisk])
  @@index([analyzedAt])
  @@map("interview_ai_analyses")
}
```

#### 23-5. InterviewAutomationTrigger（面談自動トリガー記録）

**目的**: VoiceDrive連携やシステムイベントによる自動面談トリガーを記録。

```prisma
model InterviewAutomationTrigger {
  id                    String    @id @default(cuid())

  // トリガー情報
  triggerType           String    @map("trigger_type")
  // voicedrive_sentiment, stress_check_alert, overtime_threshold, absence_pattern等
  triggerSource         String    @map("trigger_source")
  // VoiceDrive, HealthManagement, AttendanceSystem等

  // 対象職員
  employeeId            String    @map("employee_id")
  employeeName          String?   @map("employee_name")

  // トリガー条件
  triggerCondition      Json      @map("trigger_condition")
  // {
  //   "condition_type": "negative_sentiment_streak",
  //   "threshold": 3,
  //   "actual_value": 5,
  //   "sentiment_scores": [-0.6, -0.4, -0.7, -0.5, -0.8]
  // }

  // 推奨面談
  recommendedInterviewType String @map("recommended_interview_type")
  // workplace_support, individual_consultation等
  urgencyLevel          String    @map("urgency_level")
  // low, medium, high, urgent
  recommendedWithin     Int?      @map("recommended_within")
  // 推奨実施期限（日数）

  // 実施状況
  interviewScheduled    Boolean   @default(false) @map("interview_scheduled")
  scheduledInterviewId  String?   @map("scheduled_interview_id")
  scheduledAt           DateTime? @map("scheduled_at")
  interviewCompleted    Boolean   @default(false) @map("interview_completed")
  completedAt           DateTime? @map("completed_at")

  // 通知管理
  notificationSent      Boolean   @default(false) @map("notification_sent")
  notificationSentTo    Json?     @map("notification_sent_to")
  // ["direct_manager", "hr_dept"]
  notificationSentAt    DateTime? @map("notification_sent_at")

  // 効果測定
  triggerResolved       Boolean   @default(false) @map("trigger_resolved")
  // トリガー条件が解消されたか
  resolvedAt            DateTime? @map("resolved_at")
  resolutionNotes       String?   @db.Text @map("resolution_notes")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([employeeId])
  @@index([triggerType])
  @@index([urgencyLevel])
  @@index([interviewScheduled])
  @@index([interviewCompleted])
  @@map("interview_automation_triggers")
}
```

### 実装による効果

✅ **質問バンクの完全管理**
- 892問の定期面談、168問のサポート面談、187問の特別面談を一元管理
- AI生成質問と人間作成質問の混在管理
- 使用頻度・効果測定による継続的改善

✅ **経験年数別・職種別・管理職別の柔軟対応**
- テンプレートによる動的セクション生成
- 新人1ヶ月目、3ヶ月目、6ヶ月目で異なる質問
- 看護師・理学療法士・医事課職員ごとのカスタマイズ

✅ **AI分析による洞察の蓄積**
- セクション相関分析
- 離職リスク自動検出
- 前回比較による成長・悪化領域の特定

✅ **VoiceDrive連携による予防的面談**
- ネガティブ感情が続いたら自動面談提案
- 残業・ストレス閾値超過時の自動アラート
- システム全体の統合的な職員支援

**10種類の面談体系を、将来の変更にも柔軟に対応できる設計で完全実装！**

---

## 24. 面談日程調整・予約管理システム（ローカルLLM自動マッチング）

### 背景と要件
- **実務で最も大変な日程調整を自動化**: 面談希望者と面談担当者の制約を考慮し、ローカルLLMで最適マッチング
- 主要機能:
  - VoiceDriveシフト連携による自動制約生成
  - ローカルLLM（Ollama, LlamaCpp等）による最適候補提案
  - 過去の成功パターンからの学習
  - 複雑な制約条件の自動解決
  - 予約変更の完全履歴管理

- **不足している項目**:
  - 職員・面談担当者の日程制約の体系的管理
  - LLMマッチングの試行ログと学習データ
  - 面談担当者の可用性スケジュール
  - 予約変更の監査証跡
  - マッチングアルゴリズムの設定管理

### 必要なテーブル設計

#### 24-1. InterviewSchedulingConstraint（日程制約管理）

**目的**: 職員・面談担当者の日程制約を体系的に管理。VoiceDriveシフトとの自動連携。

```prisma
model InterviewSchedulingConstraint {
  id                    String    @id @default(cuid())

  // 制約の主体
  employeeId            String?   @map("employee_id")
  // NULL = 面談担当者の制約
  interviewerId         String?   @map("interviewer_id")
  // NULL = 職員の制約
  constraintOwner       String    @map("constraint_owner")
  // employee, interviewer（どちらの制約か明示）

  // 制約タイプ
  constraintType        String    @map("constraint_type")
  // available（可能）, unavailable（不可）, preferred（希望）, avoid（避けたい）

  // 時間制約
  dayOfWeek             Int?      @map("day_of_week")
  // 0=日曜、1=月曜...6=土曜、NULL=特定日指定
  startTime             String?   @map("start_time")
  // "09:00"
  endTime               String?   @map("end_time")
  // "17:00"
  specificDate          DateTime? @map("specific_date")
  // 特定日の制約（年休、研修等）

  // 繰り返しパターン
  isRecurring           Boolean   @default(false) @map("is_recurring")
  recurrencePattern     String?   @map("recurrence_pattern")
  // weekly, biweekly, monthly, first_monday等
  recurringUntil        DateTime? @map("recurring_until")
  // 繰り返し終了日

  // VoiceDriveシフト連携
  voicedriveShiftId     String?   @map("voicedrive_shift_id")
  // VoiceDriveのシフトIDと紐付け
  shiftType             String?   @map("shift_type")
  // day_shift, night_shift, off_day, night_shift_recovery（夜勤明け）
  autoGeneratedFromShift Boolean  @default(false) @map("auto_generated_from_shift")
  // シフトから自動生成された制約か

  // 理由・メモ
  reason                String?   @db.Text
  // "夜勤明けで疲労"、"定例会議"、"研修参加"等
  internalNote          String?   @db.Text @map("internal_note")
  // 人事部用メモ

  // 優先度
  priority              Int       @default(5) @map("priority")
  // 1-10（数字が小さいほど重要）
  // 1: 絶対不可（夜勤明け）
  // 3: 強く避けたい（会議予定）
  // 5: やや避けたい
  // 7: できれば希望（好きな時間帯）
  // 10: 軽い希望
  isHardConstraint      Boolean   @default(false) @map("is_hard_constraint")
  // true = 絶対に違反できない制約
  // false = LLMが柔軟に判断可能

  // 有効期間
  validFrom             DateTime  @default(now()) @map("valid_from")
  validUntil            DateTime? @map("valid_until")
  isActive              Boolean   @default(true) @map("is_active")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([employeeId])
  @@index([interviewerId])
  @@index([dayOfWeek])
  @@index([specificDate])
  @@index([isActive])
  @@index([voicedriveShiftId])
  @@map("interview_scheduling_constraints")
}
```

#### 24-2. InterviewSchedulingAttempt（LLMマッチング試行ログ）

**目的**: ローカルLLMによる自動マッチングの試行を完全記録。学習データとして活用。

```prisma
model InterviewSchedulingAttempt {
  id                    String    @id @default(cuid())

  // マッチング対象
  employeeId            String    @map("employee_id")
  employeeName          String?   @map("employee_name")
  interviewType         String    @map("interview_type")
  // new_employee_monthly, regular_annual等
  urgencyLevel          String    @map("urgency_level")
  // low, medium, high, urgent
  requestedBy           String?   @map("requested_by")
  // 職員本人、上司、人事部等

  // LLMマッチング情報
  matchingEngine        String    @map("matching_engine")
  // local_llm_ollama, local_llm_llamacpp, local_llm_gemma, rule_based, hybrid
  llmModel              String?   @map("llm_model")
  // llama3.2, mistral, gemma2, qwen2.5等
  llmModelVersion       String?   @map("llm_model_version")
  // 3b, 7b, 14b等
  matchingPrompt        String?   @db.Text @map("matching_prompt")
  // LLMに送信したプロンプト（デバッグ用）

  // 入力データ
  inputConstraints      Json      @map("input_constraints")
  // {
  //   "employee": [...制約リスト],
  //   "interviewers": {...面談担当者候補と制約}
  // }
  availableTimeSlots    Json?     @map("available_time_slots")
  // マッチング前の利用可能時間帯

  // 候補日時（LLM出力）
  proposedSlots         Json      @map("proposed_slots")
  // [
  //   {
  //     "rank": 1,
  //     "date": "2025-10-15",
  //     "startTime": "10:00",
  //     "endTime": "11:00",
  //     "interviewerId": "INT_001",
  //     "interviewerName": "田中管理者",
  //     "interviewerDepartment": "看護部",
  //     "matchScore": 0.95,
  //     "reasons": [
  //       "職員希望時間帯に完全一致",
  //       "面談者の専門分野（新人教育）が適合",
  //       "過去の面談実績良好（満足度4.5/5）",
  //       "VoiceDriveシフトと競合なし"
  //     ],
  //     "conflicts": [],
  //     "constraintsSatisfied": 8,
  //     "constraintsViolated": 0
  //   },
  //   {
  //     "rank": 2,
  //     "date": "2025-10-16",
  //     "startTime": "14:00",
  //     "endTime": "15:00",
  //     "interviewerId": "INT_002",
  //     "interviewerName": "佐藤課長",
  //     "interviewerDepartment": "人事部",
  //     "matchScore": 0.87,
  //     "reasons": [
  //       "キャリア相談の専門家",
  //       "空き時間が確実"
  //     ],
  //     "conflicts": [
  //       "職員希望時間より2時間遅い"
  //     ],
  //     "constraintsSatisfied": 6,
  //     "constraintsViolated": 1
  //   },
  //   {
  //     "rank": 3,
  //     "date": "2025-10-17",
  //     "startTime": "09:00",
  //     "endTime": "10:00",
  //     "interviewerId": "INT_001",
  //     "interviewerName": "田中管理者",
  //     "matchScore": 0.82,
  //     "reasons": ["次善の候補"],
  //     "conflicts": ["職員の第2希望日"],
  //     "constraintsSatisfied": 7,
  //     "constraintsViolated": 1
  //   }
  // ]

  // マッチング品質
  totalCandidates       Int       @map("total_candidates")
  // 提案候補数
  bestMatchScore        Float     @map("best_match_score")
  // 最高マッチスコア（0.0-1.0）
  avgMatchScore         Float?    @map("avg_match_score")
  // 平均マッチスコア
  worstMatchScore       Float?    @map("worst_match_score")
  // 最低マッチスコア

  // 制約充足度
  totalConstraints      Int       @map("total_constraints")
  // 総制約数
  hardConstraintsSatisfied Int    @map("hard_constraints_satisfied")
  // 満たしたハード制約数
  hardConstraintsViolated  Int    @map("hard_constraints_violated")
  // 違反したハード制約数
  softConstraintsSatisfied Int    @map("soft_constraints_satisfied")
  // 満たしたソフト制約数

  // 結果
  attemptStatus         String    @map("attempt_status")
  // success（成功）, partial（部分成功）, failed（候補なし）, error（システムエラー）
  selectedSlotRank      Int?      @map("selected_slot_rank")
  // 職員が選択した候補のランク（1, 2, 3...）
  selectedSlot          Json?     @map("selected_slot")
  // 最終的に選択されたスロット
  selectedAt            DateTime? @map("selected_at")
  bookingCreated        Boolean   @default(false) @map("booking_created")
  bookingId             String?   @map("booking_id")
  // Interviewテーブルのレコード

  // パフォーマンス
  processingTimeMs      Int?      @map("processing_time_ms")
  // LLM処理時間（ミリ秒）
  llmTokensUsed         Int?      @map("llm_tokens_used")
  // 使用トークン数（コスト計算用、ローカルLLMでも記録）
  llmResponseTime       Int?      @map("llm_response_time")
  // LLMレスポンス時間（ミリ秒）

  // フィードバック
  userFeedback          String?   @map("user_feedback")
  // accepted（承認）, rejected（全拒否）, modified（修正依頼）, alternative_selected（代替案選択）
  feedbackComment       String?   @db.Text @map("feedback_comment")
  // 職員からのコメント
  feedbackScore         Int?      @map("feedback_score")
  // 1-5（満足度）
  feedbackAt            DateTime? @map("feedback_at")

  // 学習用データ
  wasSuccessful         Boolean?  @map("was_successful")
  // 最終的に予約成立したか
  learningWeight        Float?    @default(1.0) @map("learning_weight")
  // このデータの学習重み（成功例は高く）

  // エラー情報
  errorMessage          String?   @db.Text @map("error_message")
  errorStack            String?   @db.Text @map("error_stack")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([employeeId])
  @@index([attemptStatus])
  @@index([bestMatchScore])
  @@index([wasSuccessful])
  @@index([createdAt])
  @@index([llmModel])
  @@map("interview_scheduling_attempts")
}
```

#### 24-3. InterviewerAvailability（面談担当者可用性）

**目的**: 面談担当者の週次・月次スケジュールを管理。LLMマッチングの基礎データ。

```prisma
model InterviewerAvailability {
  id                    String    @id @default(cuid())

  // 面談担当者情報
  interviewerId         String    @map("interviewer_id")
  interviewerName       String    @map("interviewer_name")
  department            String?   @map("department")
  position              String?   @map("position")
  permissionLevel       Int?      @map("permission_level")
  // 6-13（人財統括本部の権限レベル）

  // 専門分野
  specializations       Json?     @map("specializations")
  // ["新人教育", "キャリア相談", "メンタルヘルス"]
  interviewTypes        Json      @map("interview_types")
  // ["new_employee_monthly", "career_support"]（対応可能な面談種類）

  // 基本可用性（繰り返しパターン）
  defaultAvailability   Json      @map("default_availability")
  // {
  //   "monday": [{ "start": "09:00", "end": "12:00" }, { "start": "14:00", "end": "17:00" }],
  //   "tuesday": [{ "start": "10:00", "end": "16:00" }],
  //   "wednesday": "unavailable",
  //   "thursday": [{ "start": "09:00", "end": "17:00" }],
  //   "friday": [{ "start": "13:00", "end": "17:00" }]
  // }

  // 月次容量
  maxInterviewsPerWeek  Int?      @default(10) @map("max_interviews_per_week")
  maxInterviewsPerMonth Int?      @default(40) @map("max_interviews_per_month")
  currentWeekCount      Int       @default(0) @map("current_week_count")
  // 今週の予約数
  currentMonthCount     Int       @default(0) @map("current_month_count")
  // 今月の予約数

  // 特別な期間の可用性（上書き）
  overrideAvailability  Json?     @map("override_availability")
  // [
  //   {
  //     "date": "2025-10-15",
  //     "status": "unavailable",
  //     "reason": "出張"
  //   },
  //   {
  //     "date": "2025-10-20",
  //     "slots": [{ "start": "10:00", "end": "12:00" }],
  //     "reason": "午後のみ不在"
  //   }
  // ]

  // 過去の実績
  totalInterviewsConducted Int    @default(0) @map("total_interviews_conducted")
  avgSatisfactionScore     Float? @map("avg_satisfaction_score")
  // 平均満足度（1-5）
  successRate              Float? @map("success_rate")
  // 予約→実施の成功率（%）

  // マッチング優先度
  preferredBy           Json?     @map("preferred_by")
  // ["EMP_001", "EMP_050"]（この面談者を希望する職員リスト）
  matchingPriority      Int       @default(5) @map("matching_priority")
  // 1-10（LLMマッチング時の優先度）

  // 状態管理
  isActive              Boolean   @default(true) @map("is_active")
  // 面談担当者として活動中か
  suspendedUntil        DateTime? @map("suspended_until")
  // 一時停止期間
  suspensionReason      String?   @db.Text @map("suspension_reason")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([interviewerId])
  @@index([isActive])
  @@index([department])
  @@map("interviewer_availability")
}
```

#### 24-4. InterviewBookingHistory（予約変更履歴）

**目的**: 予約の作成・変更・キャンセルの完全な監査証跡。「なぜこの日程になったか」を追跡。

**予約ステータスフロー**:
1. **tentative** (仮予約受付) → LLMが候補を提示、職員が選択待ち
2. **pending_confirmation** (承認待ち) → 職員が選択、面談者・人事部の承認待ち
3. **confirmed** (本予約確定) → 全員が承認、確定通知送信
4. **rescheduled** (日程変更) → 予約後に日程変更が発生
5. **cancelled** (キャンセル) → 予約がキャンセルされた
6. **completed** (実施済み) → 面談が完了
7. **no_show** (不参加) → 予約時間に不参加

```prisma
model InterviewBookingHistory {
  id                    String    @id @default(cuid())

  // 予約情報
  bookingId             String    @map("booking_id")
  // Interviewテーブルのレコード
  employeeId            String    @map("employee_id")
  interviewerId         String?   @map("interviewer_id")

  // 変更タイプ
  actionType            String    @map("action_type")
  // tentative, pending_confirmation, confirmed, rescheduled, cancelled, completed, no_show
  actionReason          String?   @db.Text @map("action_reason")
  // "職員の都合", "面談者の急用", "システム自動調整"等

  // 変更前の状態
  previousState         Json?     @map("previous_state")
  // {
  //   "date": "2025-10-15",
  //   "startTime": "10:00",
  //   "endTime": "11:00",
  //   "interviewerId": "INT_001",
  //   "status": "scheduled"
  // }

  // 変更後の状態
  newState              Json      @map("new_state")
  // {
  //   "date": "2025-10-17",
  //   "startTime": "14:00",
  //   "endTime": "15:00",
  //   "interviewerId": "INT_002",
  //   "status": "rescheduled"
  // }

  // 変更の詳細
  changedFields         Json?     @map("changed_fields")
  // ["date", "startTime", "interviewerId"]
  rescheduleCount       Int?      @map("reschedule_count")
  // この予約の累計変更回数

  // LLM再マッチング情報
  triggeredRematching   Boolean   @default(false) @map("triggered_rematching")
  // 変更によりLLM再マッチングが実行されたか
  rematchingAttemptId   String?   @map("rematching_attempt_id")
  // InterviewSchedulingAttempt.id

  // 通知情報
  notificationSent      Boolean   @default(false) @map("notification_sent")
  notificationSentTo    Json?     @map("notification_sent_to")
  // {
  //   "employee": true,
  //   "interviewer": true,
  //   "hr_dept": false
  // }
  notificationSentAt    DateTime? @map("notification_sent_at")

  // 変更実施者
  actionPerformedBy     String    @map("action_performed_by")
  // 職員本人、面談者、人事部、システム（自動）
  performedByUserId     String?   @map("performed_by_user_id")
  performedByName       String?   @map("performed_by_name")

  // コスト・影響分析
  impactScore           Float?    @map("impact_score")
  // 変更の影響度（0.0-1.0、直前変更は1.0）
  relatedChanges        Int?      @default(0) @map("related_changes")
  // この変更により発生した関連変更数

  // メタデータ
  actionTimestamp       DateTime  @default(now()) @map("action_timestamp")
  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([bookingId])
  @@index([employeeId])
  @@index([actionType])
  @@index([actionTimestamp])
  @@map("interview_booking_history")
}
```

#### 24-5. SchedulingOptimizationConfig（最適化設定管理）

**目的**: LLMマッチングのパラメータ、重み付け、モデル設定を一元管理。実験的な調整も記録。

```prisma
model SchedulingOptimizationConfig {
  id                    String    @id @default(cuid())

  // 設定名
  configName            String    @unique @map("config_name")
  // "default", "high_urgency", "new_employee_priority"等
  configDescription     String?   @db.Text @map("config_description")

  // LLMモデル設定
  defaultLlmEngine      String    @map("default_llm_engine")
  // local_llm_ollama, local_llm_llamacpp
  defaultLlmModel       String    @map("default_llm_model")
  // llama3.2, mistral, gemma2
  llmTemperature        Float?    @default(0.7) @map("llm_temperature")
  // 0.0-1.0（創造性）
  llmMaxTokens          Int?      @default(2000) @map("llm_max_tokens")

  // マッチング重み付け
  matchingWeights       Json      @map("matching_weights")
  // {
  //   "time_preference": 0.35,        // 時間希望の重み
  //   "interviewer_expertise": 0.25,  // 専門性の重み
  //   "past_performance": 0.20,       // 過去実績の重み
  //   "availability": 0.15,           // 空き状況の重み
  //   "workload_balance": 0.05        // 負荷分散の重み
  // }

  // 制約処理設定
  hardConstraintPenalty Float     @default(1000.0) @map("hard_constraint_penalty")
  // ハード制約違反時のペナルティ
  softConstraintPenalty Float     @default(10.0) @map("soft_constraint_penalty")
  // ソフト制約違反時のペナルティ

  // 候補生成設定
  maxCandidates         Int       @default(5) @map("max_candidates")
  // 提案する候補数（通常3-5）
  minMatchScore         Float     @default(0.5) @map("min_match_score")
  // 最低マッチスコア閾値
  diversityBonus        Float?    @default(0.1) @map("diversity_bonus")
  // 候補の多様性ボーナス

  // 時間枠設定
  defaultInterviewDuration Int    @default(60) @map("default_interview_duration")
  // デフォルト面談時間（分）
  bufferTimeBefore      Int       @default(15) @map("buffer_time_before")
  // 面談前バッファ（分）
  bufferTimeAfter       Int       @default(15) @map("buffer_time_after")
  // 面談後バッファ（分）

  // 優先度設定
  urgencyMultipliers    Json?     @map("urgency_multipliers")
  // {
  //   "urgent": 2.0,
  //   "high": 1.5,
  //   "medium": 1.0,
  //   "low": 0.7
  // }

  // VoiceDrive連携設定
  voicedriveIntegration Boolean   @default(true) @map("voicedrive_integration")
  // VoiceDriveシフト連携を有効化
  shiftBufferHours      Int?      @default(8) @map("shift_buffer_hours")
  // 夜勤明けからのバッファ時間

  // 学習設定
  enableLearning        Boolean   @default(true) @map("enable_learning")
  // 過去データからの学習を有効化
  learningDecayRate     Float?    @default(0.95) @map("learning_decay_rate")
  // 古いデータの重み減衰率
  minLearningDataPoints Int?      @default(10) @map("min_learning_data_points")
  // 学習に必要な最小データ数

  // A/Bテスト
  isExperimental        Boolean   @default(false) @map("is_experimental")
  experimentName        String?   @map("experiment_name")
  controlGroupRatio     Float?    @map("control_group_ratio")
  // 対照群の割合（0.0-1.0）

  // 状態管理
  isActive              Boolean   @default(true) @map("is_active")
  // 現在使用中の設定か
  activatedAt           DateTime? @map("activated_at")
  deactivatedAt         DateTime? @map("deactivated_at")

  // パフォーマンス統計
  totalAttempts         Int       @default(0) @map("total_attempts")
  successRate           Float?    @map("success_rate")
  avgMatchScore         Float?    @map("avg_match_score")
  avgProcessingTime     Int?      @map("avg_processing_time")
  // ミリ秒

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([isActive])
  @@index([configName])
  @@map("scheduling_optimization_configs")
}
```

### 予約承認フローの詳細

#### フロー1: 仮予約受付 → 本予約確定（通常フロー）

```
1. [tentative] 仮予約受付
   - LLMが最適候補を3-5案生成
   - 職員に選択肢を提示
   - InterviewSchedulingAttempt.proposedSlotsに候補記録

2. [pending_confirmation] 承認待ち
   - 職員が希望日程を選択
   - 面談担当者へ通知送信
   - （オプション）人事部承認が必要な場合は人事部へ通知

3. [confirmed] 本予約確定
   - 面談担当者が承認
   - 全関係者へ確定通知送信（メール・VoiceDrive）
   - カレンダー招待送信
   - InterviewBookingHistory.actionType = 'confirmed'

4. [completed] 面談実施完了
   - 面談担当者が完了報告
   - 面談記録を保存
   - 満足度フィードバック依頼
```

#### フロー2: 日程変更が発生した場合

```
1. [rescheduled] 日程変更
   - 職員または面談担当者が変更リクエスト
   - InterviewBookingHistory.previousStateに変更前情報保存
   - triggeredRematching = trueの場合、LLMが新候補生成

2. [pending_confirmation] 再承認待ち
   - 変更後の日程を再度承認プロセス
   - rescheduleCountをインクリメント
   - 関係者へ変更通知

3. [confirmed] 再確定
   - 全員が新日程を承認
   - 確定通知再送信
```

#### フロー3: キャンセル・不参加

```
1. [cancelled] キャンセル
   - 職員または面談担当者がキャンセル
   - actionReasonに理由記録（必須）
   - 関係者へキャンセル通知

2. [no_show] 不参加
   - 予約時間に職員が不参加
   - 面談担当者が不参加報告
   - フォローアップ面談を自動提案
```

### 承認権限の設定例

```json
// InterviewSchedulingAttempt.proposedSlots[0]
{
  "rank": 1,
  "date": "2025-10-15",
  "startTime": "10:00",
  "interviewerId": "INT_001",
  "matchScore": 0.95,
  "requiresApproval": {
    "interviewer": true,      // 面談担当者の承認必須
    "hr_department": false,   // 人事部承認不要（通常面談）
    "department_head": false  // 部署長承認不要
  },
  "autoConfirmIfNoResponse": false, // タイムアウト自動承認しない
  "responseDeadline": "2025-10-10T17:00:00Z"
}
```

### 実装による効果

✅ **仮予約→本予約の完全な状態管理**
- 7つの予約ステータスで全フローをカバー
- 仮予約時点では予定を仮押さえ、本予約確定後に正式確保
- 承認待ちタイムアウトの自動処理

✅ **実務で最も大変な日程調整を完全自動化**
- VoiceDriveシフトから自動制約生成
- ローカルLLM（Ollama等）で最適候補を3-5案提示
- 職員は選ぶだけ（調整作業ゼロ）

✅ **複雑な制約を自動解決**
- 夜勤明けは午後のみ、定例会議は避ける等
- ハード制約（絶対）とソフト制約（希望）を区別
- 面談担当者の専門性・過去実績も考慮

✅ **継続的学習による改善**
- 成功パターンを学習（「田中管理者×火曜午前×新人面談」は高評価）
- フィードバックから重み付け自動調整
- A/Bテストで最適パラメータ探索

✅ **完全な監査証跡**
- 「なぜこの日程になったか」を完全記録
- LLMの判断理由も保存
- 予約変更の影響分析
- 仮予約→承認待ち→本予約の全履歴追跡

✅ **将来の拡張性**
- 面談以外にも応用可能（研修、健康診断、採用面接）
- アルゴリズム・モデルの切り替えが容易
- 新しい制約タイプの追加も柔軟
- 多段階承認フローへの拡張が容易

**人事部が最も苦労する日程調整を、仮予約から本予約確定まで、AIが自動化しながら学習し続けます！**

---

## Section 25: システム管理・運用基盤（通知・監査ログ・バックアップ・コンプライアンス通報）

### 背景・目的

**ページURL**:
- [/admin/notifications](https://staff-medical-system-v2.vercel.app/admin/notifications)
- [/admin/audit-log](https://staff-medical-system-v2.vercel.app/admin/audit-log)
- [/admin/backup](https://staff-medical-system-v2.vercel.app/admin/backup)
- [/compliance](https://staff-medical-system-v2.vercel.app/compliance)

**実装確認内容**:
- 通知・アラートシステム（DB障害、API異常、MCP切断等）
- メール、Slack、VoiceDrive内通知への配信
- 監査ログ（全操作履歴の記録）
- バックアップ・リストア機能
- コンプライアンス窓口（ハラスメント・不正通報管理）

**現状の課題**:
- 通知ルール・配信履歴の永続化が不足
- 監査ログのフィルタリング・検索機能が未実装
- バックアップスケジュール・履歴の管理テーブルがない
- コンプライアンス通報の完全な証跡管理が不十分

### 追加が必要なテーブル（5つ）

#### 1. SystemNotificationRule（通知ルール設定）

```prisma
model SystemNotificationRule {
  id                    String    @id @default(cuid())
  ruleCode              String    @unique @map("rule_code")
  // db_connection_error, api_error_rate, mcp_connection_lost, etc.
  ruleName              String    @map("rule_name")
  // 「DB接続エラー」「API異常エラー率」等
  ruleCategory          String    @map("rule_category")
  // database, api, mcp, system, backup, integration

  // 監視条件
  condition             String    @db.Text @map("condition")
  // 「データベースへの接続が失敗した時」
  conditionExpression   Json?     @map("condition_expression")
  // {
  //   "type": "threshold",
  //   "metric": "api_error_rate",
  //   "operator": ">",
  //   "threshold": 10,
  //   "unit": "percent"
  // }

  // 重大度
  severity              String    @map("severity")
  // critical, high, medium, low

  // 通知先
  notifyByEmail         Boolean   @default(false) @map("notify_by_email")
  emailAddresses        Json?     @map("email_addresses")
  // ["admin@example.com", "hr@example.com"]
  notifyBySlack         Boolean   @default(false) @map("notify_by_slack")
  slackWebhookUrl       String?   @map("slack_webhook_url")
  notifyByVoiceDrive    Boolean   @default(false) @map("notify_by_voicedrive")
  voicedriveUserIds     Json?     @map("voicedrive_user_ids")
  // ["USER_001", "USER_002"]
  notifyBySMS           Boolean   @default(false) @map("notify_by_sms")
  smsPhoneNumbers       Json?     @map("sms_phone_numbers")

  // 通知抑制（同じアラートの連続送信防止）
  cooldownMinutes       Int       @default(0) @map("cooldown_minutes")
  // 0 = 毎回通知、5 = 5分間は再通知しない

  // 通知テンプレート
  notificationTemplate  String?   @db.Text @map("notification_template")
  // 「[緊急] {{systemName}}でDB接続エラーが発生しました。至急確認してください。」
  includeStackTrace     Boolean   @default(false) @map("include_stack_trace")
  includeSystemInfo     Boolean   @default(true) @map("include_system_info")

  // 自動アクション
  autoExecuteAction     Boolean   @default(false) @map("auto_execute_action")
  actionScript          String?   @db.Text @map("action_script")
  // 例: バックアップ失敗時に再試行スクリプトを実行

  // 有効化状態
  isEnabled             Boolean   @default(true) @map("is_enabled")
  enabledAt             DateTime? @map("enabled_at")
  disabledAt            DateTime? @map("disabled_at")
  disabledReason        String?   @db.Text @map("disabled_reason")

  // 統計情報
  totalTriggers         Int       @default(0) @map("total_triggers")
  totalNotifications    Int       @default(0) @map("total_notifications")
  lastTriggeredAt       DateTime? @map("last_triggered_at")
  avgResponseTime       Float?    @map("avg_response_time")
  // 通知送信にかかる平均時間（秒）

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  // リレーション
  notifications         SystemNotificationLog[]

  @@index([ruleCategory])
  @@index([severity])
  @@index([isEnabled])
  @@index([lastTriggeredAt])
  @@map("system_notification_rules")
}
```

#### 2. SystemNotificationLog（通知配信履歴）

```prisma
model SystemNotificationLog {
  id                    String    @id @default(cuid())
  ruleId                String    @map("rule_id")
  ruleCode              String    @map("rule_code")
  ruleName              String    @map("rule_name")

  // トリガー情報
  triggeredAt           DateTime  @default(now()) @map("triggered_at")
  triggerSource         String?   @map("trigger_source")
  // system_monitor, api_gateway, mcp_client, backup_scheduler
  triggerContext        Json?     @map("trigger_context")
  // {
  //   "errorCode": "ECONNREFUSED",
  //   "host": "lightsail-db.example.com",
  //   "port": 3306,
  //   "attemptCount": 3
  // }

  // 通知内容
  notificationTitle     String    @map("notification_title")
  notificationBody      String    @db.Text @map("notification_body")
  severity              String    @map("severity")

  // 配信状況
  sentToEmail           Boolean   @default(false) @map("sent_to_email")
  emailSentAt           DateTime? @map("email_sent_at")
  emailStatus           String?   @map("email_status")
  // sent, failed, bounced
  emailError            String?   @db.Text @map("email_error")

  sentToSlack           Boolean   @default(false) @map("sent_to_slack")
  slackSentAt           DateTime? @map("slack_sent_at")
  slackStatus           String?   @map("slack_status")
  slackMessageId        String?   @map("slack_message_id")

  sentToVoiceDrive      Boolean   @default(false) @map("sent_to_voicedrive")
  voicedriveSentAt      DateTime? @map("voicedrive_sent_at")
  voicedriveStatus      String?   @map("voicedrive_status")
  voicedriveNotificationId String? @map("voicedrive_notification_id")

  sentToSMS             Boolean   @default(false) @map("sent_to_sms")
  smsSentAt             DateTime? @map("sms_sent_at")
  smsStatus             String?   @map("sms_status")

  // 全体ステータス
  overallStatus         String    @default("pending") @map("overall_status")
  // pending, sent, partial_failure, failed
  totalRecipients       Int       @default(0) @map("total_recipients")
  successfulDeliveries  Int       @default(0) @map("successful_deliveries")
  failedDeliveries      Int       @default(0) @map("failed_deliveries")

  // 処理時間
  processingStartedAt   DateTime? @map("processing_started_at")
  processingCompletedAt DateTime? @map("processing_completed_at")
  processingDuration    Int?      @map("processing_duration")
  // ミリ秒

  // ユーザーアクション
  acknowledgedBy        String?   @map("acknowledged_by")
  acknowledgedAt        DateTime? @map("acknowledged_at")
  acknowledgeNote       String?   @db.Text @map("acknowledge_note")
  resolvedBy            String?   @map("resolved_by")
  resolvedAt            DateTime? @map("resolved_at")
  resolutionNote        String?   @db.Text @map("resolution_note")

  // 再通知抑制
  cooldownUntil         DateTime? @map("cooldown_until")
  suppressedCount       Int       @default(0) @map("suppressed_count")
  // クールダウン中に抑制された通知数

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")

  // リレーション
  rule                  SystemNotificationRule @relation(fields: [ruleId], references: [id])

  @@index([ruleId])
  @@index([triggeredAt])
  @@index([severity])
  @@index([overallStatus])
  @@index([acknowledgedBy])
  @@map("system_notification_logs")
}
```

#### 3. SystemAuditLog（監査ログ）

```prisma
model SystemAuditLog {
  id                    String    @id @default(cuid())

  // アクション情報
  action                String    @map("action")
  // CREATE, READ, UPDATE, DELETE, LOGIN, LOGOUT, EXPORT, IMPORT
  actionType            String    @map("action_type")
  // データ操作、認証、ファイル操作、設定変更、システム操作
  resourceType          String    @map("resource_type")
  // Employee, Department, Interview, EvaluationSheet, MasterData, etc.
  resourceId            String?   @map("resource_id")
  resourceName          String?   @map("resource_name")

  // 実行者情報
  userId                String    @map("user_id")
  userName              String    @map("user_name")
  userEmail             String?   @map("user_email")
  userRole              String?   @map("user_role")
  // admin, hr_manager, department_head, staff
  permissionLevel       Int?      @map("permission_level")

  // セッション情報
  sessionId             String?   @map("session_id")
  ipAddress             String?   @map("ip_address")
  userAgent             String?   @db.Text @map("user_agent")
  deviceType            String?   @map("device_type")
  // desktop, mobile, tablet

  // 操作内容
  operationDetails      Json?     @map("operation_details")
  // {
  //   "before": { "name": "山田太郎", "status": "active" },
  //   "after": { "name": "山田太郎", "status": "inactive" },
  //   "changedFields": ["status"]
  // }
  sqlQuery              String?   @db.Text @map("sql_query")
  // 実際に実行されたSQLクエリ（機密情報はマスク）
  affectedRows          Int?      @map("affected_rows")

  // 結果
  status                String    @default("success") @map("status")
  // success, failed, partial_success, unauthorized, forbidden
  errorMessage          String?   @db.Text @map("error_message")
  errorStackTrace       String?   @db.Text @map("error_stack_trace")

  // コンプライアンス
  sensitiveDataAccessed Boolean   @default(false) @map("sensitive_data_accessed")
  // 給与、健康情報、評価結果等へのアクセス
  gdprRelevant          Boolean   @default(false) @map("gdpr_relevant")
  dataExportPath        String?   @map("data_export_path")
  // エクスポートファイルのパス

  // セキュリティ
  suspiciousActivity    Boolean   @default(false) @map("suspicious_activity")
  securityFlags         Json?     @map("security_flags")
  // ["unusual_time", "unusual_location", "bulk_operation"]

  // タイムスタンプ
  occurredAt            DateTime  @default(now()) @map("occurred_at")
  processingTime        Int?      @map("processing_time")
  // ミリ秒

  // 改ざん防止（ハッシュチェーン）
  previousLogHash       String?   @map("previous_log_hash")
  currentLogHash        String    @map("current_log_hash")
  // SHA-256ハッシュ値

  // メタデータ
  facilityId            String?   @map("facility_id")
  departmentId          String?   @map("department_id")
  tags                  Json?     @map("tags")
  // ["critical", "compliance", "export"]

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([occurredAt])
  @@index([status])
  @@index([sensitiveDataAccessed])
  @@index([suspiciousActivity])
  @@map("system_audit_logs")
}
```

#### 4. SystemBackupHistory（バックアップ履歴）

```prisma
model SystemBackupHistory {
  id                    String    @id @default(cuid())

  // バックアップ情報
  backupType            String    @map("backup_type")
  // full, incremental, differential, snapshot
  backupMethod          String    @map("backup_method")
  // automatic, manual, scheduled
  scheduleName          String?   @map("schedule_name")
  // "daily_midnight", "weekly_sunday", "monthly_1st"

  // 実行情報
  startedAt             DateTime  @map("started_at")
  completedAt           DateTime? @map("completed_at")
  duration              Int?      @map("duration")
  // 秒数
  status                String    @default("in_progress") @map("status")
  // in_progress, completed, failed, partial_success, cancelled

  // データ範囲
  includedTables        Json?     @map("included_tables")
  // ["employees", "departments", "interviews", "evaluations"]
  excludedTables        Json?     @map("excluded_tables")
  totalTables           Int?      @map("total_tables")
  totalRows             Int?      @map("total_rows")

  // ファイル情報
  backupFilePath        String    @map("backup_file_path")
  backupFileName        String    @map("backup_file_name")
  backupFileSize        BigInt?   @map("backup_file_size")
  // バイト数
  compressionType       String?   @map("compression_type")
  // gzip, zip, none
  compressionRatio      Float?    @map("compression_ratio")

  // 暗号化
  isEncrypted           Boolean   @default(false) @map("is_encrypted")
  encryptionAlgorithm   String?   @map("encryption_algorithm")
  // AES-256-GCM, AES-128-CBC

  // 整合性チェック
  checksum              String?   @map("checksum")
  // SHA-256ハッシュ値
  checksumAlgorithm     String?   @map("checksum_algorithm")
  verificationStatus    String?   @map("verification_status")
  // verified, failed, not_verified

  // ストレージ情報
  storageType           String    @map("storage_type")
  // local, s3, azure_blob, google_cloud_storage
  storageLocation       String    @map("storage_location")
  storageRegion         String?   @map("storage_region")
  storageCost           Decimal?  @map("storage_cost") @db.Decimal(10, 4)

  // リテンション
  retentionDays         Int       @default(30) @map("retention_days")
  expiresAt             DateTime  @map("expires_at")
  isExpired             Boolean   @default(false) @map("is_expired")
  deletedAt             DateTime? @map("deleted_at")

  // エラー情報
  errorMessage          String?   @db.Text @map("error_message")
  errorDetails          Json?     @map("error_details")
  failedTables          Json?     @map("failed_tables")

  // リストア情報
  canRestore            Boolean   @default(true) @map("can_restore")
  lastRestoredAt        DateTime? @map("last_restored_at")
  restoreCount          Int       @default(0) @map("restore_count")

  // 実行者
  executedBy            String?   @map("executed_by")
  executedFrom          String?   @map("executed_from")
  // web_ui, cli, api, cron

  // メタデータ
  databaseVersion       String?   @map("database_version")
  applicationVersion    String?   @map("application_version")
  serverHostname        String?   @map("server_hostname")
  notes                 String?   @db.Text @map("notes")

  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([backupType])
  @@index([status])
  @@index([startedAt])
  @@index([expiresAt])
  @@index([canRestore])
  @@map("system_backup_history")
}
```

#### 5. ComplianceReportCase（コンプライアンス通報ケース）

```prisma
model ComplianceReportCase {
  id                    String    @id @default(cuid())
  caseNumber            String    @unique @map("case_number")
  // CASE-2025-001, CASE-2025-002, etc.

  // 通報情報
  reportType            String    @map("report_type")
  // harassment, fraud, safety_violation, discrimination, retaliation
  reportCategory        String    @map("report_category")
  // power_harassment, sexual_harassment, maternity_harassment, alcohol_harassment
  severity              String    @default("medium") @map("severity")
  // critical, high, medium, low

  // 通報者情報（匿名性保護）
  isAnonymous           Boolean   @default(false) @map("is_anonymous")
  disclosureLevel       String    @default("full_anonymous") @map("disclosure_level")
  // full_anonymous（完全匿名）, conditional（条件付き開示）, disclosed（実名開示）
  reporterEmployeeId    String?   @map("reporter_employee_id")
  // 非匿名の場合のみ記録
  reporterName          String?   @map("reporter_name")
  reporterDepartment    String?   @map("reporter_department")
  reporterFacility      String?   @map("reporter_facility")
  reporterContactMethod String?   @map("reporter_contact_method")
  // email, phone, voicedrive
  reporterContactInfo   String?   @map("reporter_contact_info")
  // 暗号化して保存

  // 被通報者情報
  subjectEmployeeId     String?   @map("subject_employee_id")
  subjectName           String?   @map("subject_name")
  subjectDepartment     String?   @map("subject_department")
  subjectFacility       String?   @map("subject_facility")
  subjectPosition       String?   @map("subject_position")

  // 通報内容
  incidentDate          DateTime? @map("incident_date")
  incidentLocation      String?   @map("incident_location")
  incidentDescription   String    @db.Text @map("incident_description")
  witnessNames          Json?     @map("witness_names")
  // ["証人A", "証人B"]
  supportingEvidence    Json?     @map("supporting_evidence")
  // [{ "type": "email", "path": "..." }, { "type": "recording", "path": "..." }]

  // VoiceDrive連携
  voicedriveReportId    String?   @map("voicedrive_report_id")
  voicedrivePostId      String?   @map("voicedrive_post_id")
  sourceSystem          String    @default("internal") @map("source_system")
  // internal, voicedrive, email, phone

  // ケース管理
  caseStatus            String    @default("received") @map("case_status")
  // received, triaging, under_review, investigating, escalated, action_taken, resolved, closed, rejected
  assignedTo            String?   @map("assigned_to")
  // 調査担当者のID
  assignedAt            DateTime? @map("assigned_at")

  // 優先度・期限
  priority              String    @default("medium") @map("priority")
  // urgent, high, medium, low
  dueDate               DateTime? @map("due_date")
  isOverdue             Boolean   @default(false) @map("is_overdue")

  // 調査進捗
  investigationStartedAt   DateTime? @map("investigation_started_at")
  investigationCompletedAt DateTime? @map("investigation_completed_at")
  investigationSummary     String?   @db.Text @map("investigation_summary")
  investigationFindings    Json?     @map("investigation_findings")
  // [
  //   { "finding": "ハラスメント行為が確認された", "evidence": "..." },
  //   { "finding": "再発防止策が必要", "recommendation": "..." }
  // ]

  // 対応措置
  actionTaken           String?   @db.Text @map("action_taken")
  disciplinaryAction    String?   @map("disciplinary_action")
  // none, verbal_warning, written_warning, suspension, termination
  preventiveMeasures    Json?     @map("preventive_measures")

  // 解決・クローズ
  resolutionDate        DateTime? @map("resolution_date")
  resolutionSummary     String?   @db.Text @map("resolution_summary")
  closedBy              String?   @map("closed_by")
  closedAt              DateTime? @map("closed_at")
  closeReason           String?   @map("close_reason")
  // resolved, rejected, withdrawn, duplicate

  // 通報者へのフィードバック
  feedbackProvided      Boolean   @default(false) @map("feedback_provided")
  feedbackDate          DateTime? @map("feedback_date")
  feedbackSummary       String?   @db.Text @map("feedback_summary")

  // セキュリティ・コンプライアンス
  accessRestricted      Boolean   @default(true) @map("access_restricted")
  // 人事部長・コンプライアンス担当のみアクセス可
  accessLog             Json?     @map("access_log")
  // [{ "userId": "HR_001", "accessedAt": "...", "action": "view" }]
  dataRetentionYears    Int       @default(7) @map("data_retention_years")
  // 法令により7年保管

  // 統計・レポート用
  responseDays          Int?      @map("response_days")
  // 初動までの日数
  resolutionDays        Int?      @map("resolution_days")
  // 解決までの日数
  wasSubstantiated      Boolean?  @map("was_substantiated")
  // 通報内容が事実と確認されたか

  // メタデータ
  reportedAt            DateTime  @default(now()) @map("reported_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([caseStatus])
  @@index([reportType])
  @@index([severity])
  @@index([assignedTo])
  @@index([reportedAt])
  @@index([dueDate])
  @@index([isOverdue])
  @@map("compliance_report_cases")
}
```

### 実装による効果

✅ **システム障害の即座検知と通知**
- DB接続エラー、API異常、MCP切断を自動検知
- 重大度に応じてメール・Slack・VoiceDriveへ自動配信
- クールダウン機能で通知スパム防止

✅ **完全な監査証跡**
- 全ての操作を記録（誰が、いつ、何を、どう変更したか）
- 機密情報アクセスの追跡
- ハッシュチェーンで改ざん検知

✅ **確実なバックアップ管理**
- 自動・手動バックアップの履歴管理
- ファイルサイズ・圧縮率・暗号化情報の記録
- リテンション期間の自動管理

✅ **コンプライアンス通報の厳格管理**
- 匿名通報の完全保護
- 調査進捗の透明な追跡
- 対応措置の記録と期限管理
- 法令準拠の7年間データ保管

✅ **将来の拡張性**
- 新しい通知チャンネルの追加が容易
- 監査ログのフィルタリング・検索機能の実装が可能
- バックアップスケジューラーとの連携が柔軟
- コンプライアンス統計レポートの自動生成

**システムの安定稼働と法令遵守を、完全なデータ管理で実現します！**

---

## Section 26: 基本マスターデータ管理（職種・役職・雇用形態・部署・人事ポリシー）

### 背景・目的

**ページURL**:
- [/admin/master-data](https://staff-medical-system-v2.vercel.app/admin/master-data)

**実装確認内容**:
- 17種類のマスターデータ管理ページ
- 職種・役職・雇用形態・部署の動的管理
- 人事ポリシー19項目の管理
- インポート・エクスポート機能
- 監査ログ記録

**現状の課題**:
- 職種・役職・雇用形態の動的管理テーブルが不足
- 部署マスターの詳細設計が不十分
- 人事ポリシー19項目の動的管理テーブルが不足
- マスターデータのバージョン管理が未実装

### 追加が必要なテーブル（5つ）

#### 26-1. ProfessionMaster（職種マスター）

**目的**: 職種の完全な動的管理。新しい職種の追加、資格要件、給与範囲、キャリアパスの設定を管理画面から実施可能に。

```prisma
model ProfessionMaster {
  id                    String    @id @default(cuid())
  professionCode        String    @unique @map("profession_code")
  // NURSE, PT, OT, ST, CARE_WORKER, ADMIN, etc.
  professionName        String    @map("profession_name")
  // 「看護師」「理学療法士」等
  professionCategory    String    @map("profession_category")
  // medical, rehabilitation, nursing_care, administrative, support

  // 資格要件
  requiredCertifications Json?    @map("required_certifications")
  // [
  //   { "certCode": "NURSE_LICENSE", "required": true, "name": "看護師免許" },
  //   { "certCode": "PT_LICENSE", "required": true, "name": "理学療法士免許" }
  // ]
  optionalCertifications Json?    @map("optional_certifications")

  // 職種固有設定
  allowNightShift       Boolean   @default(false) @map("allow_night_shift")
  defaultPermissionLevel Int?     @map("default_permission_level")
  defaultEvaluationCycle String?  @map("default_evaluation_cycle")
  // monthly, quarterly, semi_annual, annual

  // キャリアパス設定
  careerPathTemplateId  String?   @map("career_path_template_id")
  promotionLadder       Json?     @map("promotion_ladder")
  // [
  //   { "level": 1, "title": "新人看護師", "minExperience": 0 },
  //   { "level": 2, "title": "一般看護師", "minExperience": 1 },
  //   { "level": 3, "title": "リーダー看護師", "minExperience": 3 }
  // ]

  // 教育・研修設定
  requiredTrainings     Json?     @map("required_trainings")
  recommendedTrainings  Json?     @map("recommended_trainings")

  // 配置基準
  minStaffRatio         Float?    @map("min_staff_ratio")
  maxConsecutiveNights  Int?      @map("max_consecutive_nights")

  // 給与設定
  baseSalaryRange       Json?     @map("base_salary_range")
  // { "min": 250000, "max": 400000, "currency": "JPY" }
  allowanceTemplateId   String?   @map("allowance_template_id")

  // 面談設定
  defaultInterviewType  String?   @map("default_interview_type")
  interviewFrequency    String?   @map("interview_frequency")

  // 状態管理
  isActive              Boolean   @default(true) @map("is_active")
  displayOrder          Int       @default(0) @map("display_order")
  color                 String?   @map("color")
  iconName              String?   @map("icon_name")

  // メタデータ
  description           String?   @db.Text @map("description")
  notes                 String?   @db.Text @map("notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([professionCategory])
  @@index([isActive])
  @@index([displayOrder])
  @@map("profession_masters")
}
```

#### 26-2. PositionMaster（役職マスター）

**目的**: 役職の完全な動的管理。昇進要件、権限範囲、給与設定を柔軟に定義可能に。

```prisma
model PositionMaster {
  id                    String    @id @default(cuid())
  positionCode          String    @unique @map("position_code")
  // STAFF, LEADER, CHIEF, MANAGER, DIRECTOR, etc.
  positionName          String    @map("position_name")
  positionLevel         Int       @map("position_level")

  // 権限設定
  permissionLevelMin    Int       @map("permission_level_min")
  permissionLevelMax    Int       @map("permission_level_max")
  defaultPermissionLevel Int      @map("default_permission_level")

  // 管理職フラグ
  isManagement          Boolean   @default(false) @map("is_management")
  managementCategory    String?   @map("management_category")

  // 職種制限
  allowedProfessions    Json?     @map("allowed_professions")
  requiredProfessions   Json?     @map("required_professions")

  // 昇進要件
  minimumExperience     Int?      @map("minimum_experience")
  requiredEvaluation    String?   @map("required_evaluation")
  requiredTrainings     Json?     @map("required_trainings")

  // 給与設定
  positionAllowance     Int?      @map("position_allowance")
  salaryMultiplier      Float?    @map("salary_multiplier")

  // 責任範囲
  canApproveLeave       Boolean   @default(false) @map("can_approve_leave")
  canApproveExpense     Boolean   @default(false) @map("can_approve_expense")
  canConductInterview   Boolean   @default(false) @map("can_conduct_interview")
  canAccessSensitiveData Boolean  @default(false) @map("can_access_sensitive_data")
  maxApprovalAmount     Int?      @map("max_approval_amount")

  // 配下人数制限
  minSubordinates       Int?      @map("min_subordinates")
  maxSubordinates       Int?      @map("max_subordinates")

  // 表示設定
  isActive              Boolean   @default(true) @map("is_active")
  displayOrder          Int       @default(0) @map("display_order")
  badgeColor            String?   @map("badge_color")
  iconName              String?   @map("icon_name")

  // メタデータ
  description           String?   @db.Text @map("description")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([positionLevel])
  @@index([isManagement])
  @@index([isActive])
  @@index([displayOrder])
  @@map("position_masters")
}
```

#### 26-3. EmploymentTypeMaster（雇用形態マスター）

**目的**: 雇用形態の完全な動的管理。労働時間制限、福利厚生、契約期間の設定を柔軟に。

```prisma
model EmploymentTypeMaster {
  id                    String    @id @default(cuid())
  employmentTypeCode    String    @unique @map("employment_type_code")
  employmentTypeName    String    @map("employment_type_name")
  employmentCategory    String    @map("employment_category")

  // 労働時間制限
  standardWorkHoursPerWeek Int?   @map("standard_work_hours_per_week")
  maxWorkHoursPerWeek   Int?      @map("max_work_hours_per_week")
  maxWorkHoursPerMonth  Int?      @map("max_work_hours_per_month")
  maxWorkHoursPerYear   Int?      @map("max_work_hours_per_year")

  // 夜勤制限
  allowNightShift       Boolean   @default(true) @map("allow_night_shift")
  maxNightShiftsPerMonth Int?     @map("max_night_shifts_per_month")

  // 契約期間
  hasContractPeriod     Boolean   @default(false) @map("has_contract_period")
  defaultContractMonths Int?      @map("default_contract_months")
  maxRenewals           Int?      @map("max_renewals")

  // 福利厚生
  eligibleForBonus      Boolean   @default(true) @map("eligible_for_bonus")
  eligibleForRetirement Boolean   @default(true) @map("eligible_for_retirement")
  eligibleForHealthInsurance Boolean @default(true) @map("eligible_for_health_insurance")
  eligibleForPaidLeave  Boolean   @default(true) @map("eligible_for_paid_leave")
  paidLeaveDaysPerYear  Int?      @map("paid_leave_days_per_year")

  // キャリアコース制限
  allowedCareerCourses  Json?     @map("allowed_career_courses")
  defaultCareerCourse   String?   @map("default_career_course")

  // 給与計算
  salaryCalculationType String    @default("monthly") @map("salary_calculation_type")
  hourlyWageMin         Int?      @map("hourly_wage_min")
  hourlyWageMax         Int?      @map("hourly_wage_max")
  overtimeRate          Float?    @default(1.25) @map("overtime_rate")

  // 試用期間
  hasProbationPeriod    Boolean   @default(true) @map("has_probation_period")
  probationMonths       Int?      @default(3) @map("probation_months")
  probationEvaluationRequired Boolean @default(true) @map("probation_evaluation_required")

  // 昇進・昇格
  eligibleForPromotion  Boolean   @default(true) @map("eligible_for_promotion")
  maxPositionLevel      Int?      @map("max_position_level")

  // 表示設定
  isActive              Boolean   @default(true) @map("is_active")
  displayOrder          Int       @default(0) @map("display_order")
  badgeColor            String?   @map("badge_color")
  iconName              String?   @map("icon_name")

  // メタデータ
  description           String?   @db.Text @map("description")
  legalNotes            String?   @db.Text @map("legal_notes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([employmentCategory])
  @@index([isActive])
  @@index([displayOrder])
  @@map("employment_type_masters")
}
```

#### 26-4. DepartmentMaster（部署マスター詳細）

**目的**: 部署の完全な動的管理。階層構造、配置基準、業務特性、予算管理を詳細に設定可能に。

```prisma
model DepartmentMaster {
  id                    String    @id @default(cuid())
  departmentCode        String    @unique @map("department_code")
  departmentName        String    @map("department_name")
  departmentNameKana    String?   @map("department_name_kana")
  departmentType        String    @map("department_type")

  // 施設関連
  facilityId            String    @map("facility_id")
  facilityName          String    @map("facility_name")
  buildingName          String?   @map("building_name")
  floorNumber           Int?      @map("floor_number")

  // 階層構造
  parentDepartmentId    String?   @map("parent_department_id")
  hierarchyLevel        Int       @default(1) @map("hierarchy_level")
  fullPath              String?   @map("full_path")

  // 部署責任者
  headPositionId        String?   @map("head_position_id")
  currentHeadEmployeeId String?   @map("current_head_employee_id")

  // 配置基準
  requiredProfessions   Json?     @map("required_professions")
  currentStaffCount     Int       @default(0) @map("current_staff_count")
  targetStaffCount      Int?      @map("target_staff_count")
  minStaffCount         Int?      @map("min_staff_count")
  maxStaffCount         Int?      @map("max_staff_count")

  // 業務特性
  operatesNightShift    Boolean   @default(false) @map("operates_night_shift")
  operates24Hours       Boolean   @default(false) @map("operates_24_hours")
  operatingHoursStart   String?   @map("operating_hours_start")
  operatingHoursEnd     String?   @map("operating_hours_end")
  operatingDays         Json?     @map("operating_days")

  // 予算・コスト
  annualBudget          Decimal?  @map("annual_budget") @db.Decimal(12, 2)
  costCenterCode        String?   @map("cost_center_code")

  // 評価・目標
  departmentGoals       Json?     @map("department_goals")
  kpiDefinitions        Json?     @map("kpi_definitions")

  // 権限・アクセス制御
  accessLevel           Int       @default(1) @map("access_level")
  restrictedAccess      Boolean   @default(false) @map("restricted_access")

  // 表示設定
  isActive              Boolean   @default(true) @map("is_active")
  displayOrder          Int       @default(0) @map("display_order")
  color                 String?   @map("color")
  iconName              String?   @map("icon_name")

  // メタデータ
  description           String?   @db.Text @map("description")
  establishedDate       DateTime? @map("established_date")
  closedDate            DateTime? @map("closed_date")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([facilityId])
  @@index([departmentType])
  @@index([parentDepartmentId])
  @@index([isActive])
  @@index([displayOrder])
  @@map("department_masters")
}
```

#### 26-5. SpecialAccountMaster（特別アカウント権限マスター）

**目的**: アカウントレベル97-99の特別アカウント（健診室専用、産業医、フルアクセス開発者）のメタ情報・セキュリティ設定を管理。

**既存テーブルとの役割分担**:
- **access_control_master（既存実装済み）**: 「どの機能・ページにアクセスできるか」を管理
  - `minLevel: 1-99` で判定
  - `specialAuthority: boolean` で Level 97-98 を区別
- **SpecialAccountMaster（本テーブル）**: 「Level 97-99 の特性・制約・セキュリティ設定」を管理
  - MFA必須、IPホワイトリスト、セッションタイムアウト
  - 監査設定（全操作ログ記録、承認要求）
  - UI表示設定（バッジ色、バッジテキスト）
  - 機能別権限の詳細定義

**統合運用例**:
```typescript
// 1. access_control_master で機能アクセスチェック
const canAccess = await canAccessPage(userLevel, '/health/management')

// 2. SpecialAccountMaster でセキュリティ制約チェック
const accountConfig = await getSpecialAccountConfig(userLevel)
if (accountConfig.requiresMFA && !user.hasMFA) {
  throw new Error('MFA認証が必要です')
}
if (accountConfig.ipWhitelist && !isAllowedIP(user.ip, accountConfig.ipWhitelist)) {
  throw new Error('許可されていないIPアドレスです')
}
```

```prisma
model SpecialAccountMaster {
  id                    String    @id @default(cuid())

  // 特別アカウントレベル
  accountLevel          Int       @unique @map("account_level")
  // 97（健診室専用）, 98（産業医）, 99（フルアクセス開発者）
  accountName           String    @map("account_name")
  accountDescription    String    @db.Text @map("account_description")

  // 権限スコープ
  accessScope           String    @map("access_scope")
  // health_checkup_only（健診のみ）, occupational_health（産業保健）, full_system（全システム）
  canAccessAllFacilities Boolean  @default(false) @map("can_access_all_facilities")
  canAccessAllDepartments Boolean @default(false) @map("can_access_all_departments")

  // 機能別権限（詳細）
  permissions           Json      @map("permissions")
  // {
  //   "healthCheckup": { "read": true, "write": true, "delete": true },
  //   "stressCheck": { "read": true, "write": true, "delete": true },
  //   "occupationalDoctorInterview": { "read": true, "write": true, "delete": true },
  //   "employeeData": { "read": true, "write": false, "delete": false },
  //   "evaluations": { "read": false, "write": false, "delete": false },
  //   "interviews": { "read": false, "write": false, "delete": false },
  //   "systemSettings": { "read": false, "write": false, "delete": false },
  //   "masterData": { "read": false, "write": false, "delete": false },
  //   "developerTools": { "read": false, "write": false, "delete": false }
  // }

  // データアクセス制限
  canViewSensitiveData  Boolean   @default(false) @map("can_view_sensitive_data")
  // 機微情報（給与、評価、面談記録等）
  canEditMasterData     Boolean   @default(false) @map("can_edit_master_data")
  canDeleteRecords      Boolean   @default(false) @map("can_delete_records")
  canExportData         Boolean   @default(false) @map("can_export_data")

  // 特別権限（レベル99のみ）
  hasDeveloperAccess    Boolean   @default(false) @map("has_developer_access")
  // 開発者ツール、データベース直接操作、ログアクセス
  canModifySystemSettings Boolean @default(false) @map("can_modify_system_settings")
  canAccessAuditLogs    Boolean   @default(false) @map("can_access_audit_logs")
  canImpersonateUsers   Boolean   @default(false) @map("can_impersonate_users")

  // API/統合権限
  canUseAPIKeys         Boolean   @default(false) @map("can_use_api_keys")
  canManageIntegrations Boolean   @default(false) @map("can_manage_integrations")
  canAccessMCPServer    Boolean   @default(false) @map("can_access_mcp_server")

  // セキュリティ制約
  requiresMFA           Boolean   @default(true) @map("requires_mfa")
  // 多要素認証必須
  ipWhitelist           Json?     @map("ip_whitelist")
  // ["192.168.1.0/24", "10.0.0.0/8"]
  sessionTimeout        Int?      @map("session_timeout")
  // セッションタイムアウト（分）
  maxConcurrentSessions Int?      @map("max_concurrent_sessions")

  // 監査強化
  logAllActions         Boolean   @default(true) @map("log_all_actions")
  // 全操作をAuditLogに記録
  requireApprovalForCriticalActions Boolean @default(false) @map("require_approval_for_critical_actions")

  // 使用条件
  requiresJustification Boolean   @default(false) @map("requires_justification")
  // アクセス時に理由入力必須
  allowedUseCases       Json?     @map("allowed_use_cases")
  // ["健診データ入力", "ストレスチェック実施", "産業医面接記録"]

  // 期限管理
  hasExpirationDate     Boolean   @default(false) @map("has_expiration_date")
  defaultExpirationDays Int?      @map("default_expiration_days")
  // アカウント有効期限（日数）

  // 表示設定
  badgeColor            String?   @default("#FF6B6B") @map("badge_color")
  // 赤系統で目立たせる
  badgeText             String?   @map("badge_text")
  // "健診室", "産業医", "開発者"
  isVisible             Boolean   @default(true) @map("is_visible")

  // メタデータ
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")
  notes                 String?   @db.Text @map("notes")

  @@index([accountLevel])
  @@index([accessScope])
  @@index([isActive])
  @@map("special_account_masters")
}
```

**追加理由**:
- **Level 97（健診室専用）**: 健診データ・ストレスチェック結果の入力・閲覧のみ。給与・評価・面談記録は閲覧不可。
- **Level 98（産業医）**: 健診・ストレスチェック・産業医面接指導の完全アクセス。就業措置の記録・VoiceDrive連携。
- **Level 99（フルアクセス開発者）**: 全システム機能、マスターデータ編集、開発者ツール、監査ログアクセス、ユーザー偽装。

**セキュリティ考慮**:
- MFA必須
- IPホワイトリスト対応
- 全操作をAuditLogに記録
- セッションタイムアウト短縮可能

---

#### 26-6. HRPolicyMaster（人事ポリシーマスター）

**目的**: 19項目の人事ポリシーの動的管理。ポリシー変更の履歴管理、承認フロー、数値目標の追跡。

```prisma
model HRPolicyMaster {
  id                    String    @id @default(cuid())
  policyCode            String    @unique @map("policy_code")
  // A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S
  policyName            String    @map("policy_name")
  policyCategory        String    @map("policy_category")

  // ポリシー選択肢
  selectedOption        String    @map("selected_option")
  optionRationale       String?   @db.Text @map("option_rationale")

  // 詳細設定
  policyDetails         Json?     @map("policy_details")
  // {
  //   "workPurpose": "生活のため",
  //   "philosophicalBasis": "職員の経済的安定が患者ケアの質を向上させる",
  //   "practicalGuidelines": ["安定した給与支払い", "福利厚生の充実"],
  //   "metrics": { "targetSalaryIncrease": 3.0, "bonusMonths": 4.5 }
  // }

  // 数値目標
  targetMetrics         Json?     @map("target_metrics")
  currentMetrics        Json?     @map("current_metrics")

  // 実施ガイドライン
  implementationGuide   String?   @db.Text @map("implementation_guide")
  exampleScenarios      Json?     @map("example_scenarios")

  // 他ポリシーとの関連
  relatedPolicies       Json?     @map("related_policies")
  conflictingPolicies   Json?     @map("conflicting_policies")

  // 改定履歴
  versionNumber         Int       @default(1) @map("version_number")
  effectiveFrom         DateTime  @map("effective_from")
  effectiveTo           DateTime? @map("effective_to")
  revisionReason        String?   @db.Text @map("revision_reason")
  previousVersionId     String?   @map("previous_version_id")

  // 承認情報
  approvedBy            String?   @map("approved_by")
  approvedAt            DateTime? @map("approved_at")
  approvalStatus        String    @default("draft") @map("approval_status")
  // draft, pending_review, approved, rejected

  // 公開設定
  isPublic              Boolean   @default(true) @map("is_public")
  targetAudience        Json?     @map("target_audience")

  // メタデータ
  displayOrder          Int       @default(0) @map("display_order")
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  @@index([policyCategory])
  @@index([approvalStatus])
  @@index([isActive])
  @@index([effectiveFrom])
  @@index([displayOrder])
  @@map("hr_policy_masters")
}
```

### 実装による効果

✅ **基本マスターデータの完全な動的管理**
- 職種・役職・雇用形態・部署の追加・編集・削除が管理画面から可能
- コード変更によるデプロイ不要

✅ **柔軟な組織変更への対応**
- 新しい職種の追加（例: 医療事務、栄養士）
- 新しい役職の追加（例: 副主任、グループリーダー）
- 新しい雇用形態の追加（例: 業務委託、嘱託職員）

✅ **人事ポリシーの透明な管理**
- 19項目の人事ポリシーをデータベースで管理
- バージョン管理により変更履歴を完全追跡
- 承認フローにより適切なガバナンス

✅ **権限・給与・キャリアパスの自動連動**
- 職種マスター → デフォルト権限レベル
- 役職マスター → 役職手当、承認権限
- 雇用形態マスター → 給与計算方法、福利厚生

✅ **法令遵守の自動チェック**
- 雇用形態別の労働時間上限設定
- 契約更新回数の労働契約法対応
- 配置基準の自動チェック

✅ **将来の拡張性**
- 新しい職種・役職・雇用形態の追加が容易
- 人事ポリシーの改定履歴を完全保存
- マスターデータのインポート・エクスポート対応

✅ **特別アカウント（97-99）の完全対応**
- **Level 97（健診室専用）**: 健診データ・ストレスチェックのみアクセス
- **Level 98（産業医）**: 産業保健データ完全アクセス + VoiceDrive就業措置連携
- **Level 99（フルアクセス開発者）**: 全システム権限 + 開発者ツール + 監査ログ
- MFA必須、IPホワイトリスト、全操作ログ記録でセキュリティ強化

**システムの根幹を成す基本マスターデータを、完全に動的管理できます！**

---

## Section 26 完了

以上、Section 26「基本マスターデータ管理」として6テーブルを追加しました：
1. ProfessionMaster（職種マスター）
2. PositionMaster（役職マスター）
3. EmploymentTypeMaster（雇用形態マスター）
4. DepartmentMaster（部署マスター）
5. **SpecialAccountMaster（特別アカウント権限マスター - Level 97-99）**
6. HRPolicyMaster（人事ポリシーマスター）

---

## Section 27: 職員向け通知・お知らせ管理システム

### 背景・目的

**ページURL**:
- [/notifications](https://staff-medical-system-v2.vercel.app/notifications)

**実装確認内容**:
- お知らせ通知の作成・配信（5つのタブ：新規作成、配信履歴、テンプレート、配信分析、設定）
- カテゴリー管理（お知らせ、面談、研修、アンケート、その他）
- 配信対象選択（全職員、部署別、個別選択、役職別）
- 優先度管理（高・中・低）
- 配信スケジュール設定
- 開封率・クリック率・回答率の追跡
- 研修受付機能の統合

**現状の課題**:
- 職員向け通知のデータベーステーブルが不足
- Section 25（システム通知）はシステム障害検知用であり、職員向けお知らせとは別物
- 通知テンプレート管理テーブルが不足
- 配信履歴・開封追跡テーブルが不足
- 研修受付統合のデータ構造が不足

### 追加が必要なテーブル（5つ）

#### 27-1. StaffNotificationTemplate（通知テンプレート）

**目的**: よく使う通知のテンプレート化。定型文の管理、カテゴリー別テンプレート、承認フロー設定。

```prisma
model StaffNotificationTemplate {
  id                    String    @id @default(cuid())
  templateCode          String    @unique @map("template_code")
  // INTERVIEW_INVITE, TRAINING_REMINDER, SURVEY_REQUEST, etc.
  templateName          String    @map("template_name")
  // 「面談案内テンプレート」「研修リマインダー」等
  category              String    @map("category")
  // announcement, interview, training, survey, other

  // テンプレート内容
  titleTemplate         String    @map("title_template")
  // 「【{{priority}}】{{eventName}}のご案内」
  contentTemplate       String    @db.Text @map("content_template")
  // 本文テンプレート（プレースホルダー使用可能）

  // プレースホルダー定義
  placeholders          Json?     @map("placeholders")
  // [
  //   { "key": "{{employeeName}}", "description": "職員氏名", "required": true },
  //   { "key": "{{eventDate}}", "description": "イベント日時", "required": true },
  //   { "key": "{{eventName}}", "description": "イベント名", "required": true }
  // ]

  // デフォルト設定
  defaultPriority       String    @default("medium") @map("default_priority")
  // high, medium, low
  defaultTargetType     String?   @map("default_target_type")
  // all, departments, individuals, positions
  requireApproval       Boolean   @default(false) @map("require_approval")
  approverPositionLevel Int?      @map("approver_position_level")

  // 配信設定
  defaultScheduleType   String?   @map("default_schedule_type")
  // immediate, scheduled, recurring
  defaultSendTime       String?   @map("default_send_time")
  // "09:00"（デフォルト送信時刻）
  recurringPattern      String?   @map("recurring_pattern")
  // daily, weekly, monthly（定期配信パターン）

  // 添付ファイル設定
  allowAttachments      Boolean   @default(true) @map("allow_attachments")
  maxAttachmentSize     Int?      @map("max_attachment_size")
  // MB単位
  allowedFileTypes      Json?     @map("allowed_file_types")
  // ["pdf", "docx", "xlsx", "jpg", "png"]

  // アクション設定
  hasResponseForm       Boolean   @default(false) @map("has_response_form")
  // 回答フォームがあるか
  responseFormTemplate  Json?     @map("response_form_template")
  hasRegistrationForm   Boolean   @default(false) @map("has_registration_form")
  // 研修受付フォームがあるか
  registrationCapacity  Int?      @map("registration_capacity")

  // 統計情報
  usageCount            Int       @default(0) @map("usage_count")
  avgOpenRate           Float?    @map("avg_open_rate")
  avgClickRate          Float?    @map("avg_click_rate")
  avgResponseRate       Float?    @map("avg_response_rate")

  // 状態管理
  isActive              Boolean   @default(true) @map("is_active")
  isPublic              Boolean   @default(true) @map("is_public")
  // 全HR担当者が使用可能か
  createdBy             String?   @map("created_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([category])
  @@index([isActive])
  @@index([usageCount])
  @@map("staff_notification_templates")
}
```

#### 27-2. StaffNotification（通知本体）

**目的**: 配信する通知の本体データ。テンプレートから生成または個別作成。

```prisma
model StaffNotification {
  id                    String    @id @default(cuid())
  notificationNumber    String    @unique @map("notification_number")
  // NOTIF-2025-001

  // 基本情報
  title                 String    @map("title")
  content               String    @db.Text @map("content")
  category              String    @map("category")
  // announcement, interview, training, survey, other
  priority              String    @default("medium") @map("priority")
  // high, medium, low

  // テンプレート関連
  templateId            String?   @map("template_id")
  usedPlaceholders      Json?     @map("used_placeholders")
  // { "{{employeeName}}": "山田太郎", "{{eventDate}}": "2025-10-15" }

  // 配信対象
  targetType            String    @map("target_type")
  // all, departments, individuals, positions, custom
  targetDepartments     Json?     @map("target_departments")
  // ["看護部", "リハビリ部"]
  targetPositions       Json?     @map("target_positions")
  // ["看護師", "理学療法士"]
  targetIndividuals     Json?     @map("target_individuals")
  // ["EMP_001", "EMP_002"]
  targetConditions      Json?     @map("target_conditions")
  // { "experienceYears": { "min": 1, "max": 3 }, "evaluationRank": ["A+", "A"] }
  totalTargetCount      Int       @default(0) @map("total_target_count")

  // 配信状態
  status                String    @default("draft") @map("status")
  // draft, pending_approval, approved, rejected, scheduled, sending, delivered, failed, cancelled

  // 承認フロー
  requiresApproval      Boolean   @default(false) @map("requires_approval")
  approvalRequestedAt   DateTime? @map("approval_requested_at")
  approvedBy            String?   @map("approved_by")
  approvedAt            DateTime? @map("approved_at")
  rejectedBy            String?   @map("rejected_by")
  rejectedAt            DateTime? @map("rejected_at")
  rejectionReason       String?   @db.Text @map("rejection_reason")

  // スケジュール
  scheduledSendAt       DateTime? @map("scheduled_send_at")
  actualSentAt          DateTime? @map("actual_sent_at")
  isRecurring           Boolean   @default(false) @map("is_recurring")
  recurringPattern      String?   @map("recurring_pattern")
  nextScheduledAt       DateTime? @map("next_scheduled_at")

  // 添付ファイル
  attachments           Json?     @map("attachments")
  // [
  //   { "fileName": "案内.pdf", "fileSize": 1024000, "fileUrl": "...", "uploadedAt": "..." }
  // ]

  // アクション設定
  hasResponseForm       Boolean   @default(false) @map("has_response_form")
  responseFormSchema    Json?     @map("response_form_schema")
  responseDeadline      DateTime? @map("response_deadline")

  hasRegistrationForm   Boolean   @default(false) @map("has_registration_form")
  registrationDeadline  DateTime? @map("registration_deadline")
  registrationCapacity  Int?      @map("registration_capacity")
  currentRegistrations  Int       @default(0) @map("current_registrations")

  // 配信統計
  totalSent             Int       @default(0) @map("total_sent")
  totalDelivered        Int       @default(0) @map("total_delivered")
  totalFailed           Int       @default(0) @map("total_failed")
  totalOpened           Int       @default(0) @map("total_opened")
  totalClicked          Int       @default(0) @map("total_clicked")
  totalResponded        Int       @default(0) @map("total_responded")

  openRate              Float?    @map("open_rate")
  clickRate             Float?    @map("click_rate")
  responseRate          Float?    @map("response_rate")

  // エラー情報
  errorMessage          String?   @db.Text @map("error_message")
  failedRecipients      Json?     @map("failed_recipients")

  // メタデータ
  createdBy             String    @map("created_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  sentBy                String?   @map("sent_by")

  // リレーション
  deliveryLogs          StaffNotificationDelivery[]
  responses             StaffNotificationResponse[]
  registrations         StaffNotificationRegistration[]

  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([scheduledSendAt])
  @@index([createdBy])
  @@index([createdAt])
  @@map("staff_notifications")
}
```

#### 27-3. StaffNotificationDelivery（個別配信ログ）

**目的**: 各職員への配信状況を個別に追跡。開封・クリック・回答の完全な追跡。

```prisma
model StaffNotificationDelivery {
  id                    String    @id @default(cuid())
  notificationId        String    @map("notification_id")
  employeeId            String    @map("employee_id")
  employeeName          String    @map("employee_name")
  employeeDepartment    String?   @map("employee_department")
  employeePosition      String?   @map("employee_position")

  // 配信情報
  sentAt                DateTime  @map("sent_at")
  deliveryStatus        String    @default("sent") @map("delivery_status")
  // sent, delivered, failed, bounced
  deliveryChannel       String    @map("delivery_channel")
  // email, in_app, voicedrive, sms

  // 開封追跡
  isOpened              Boolean   @default(false) @map("is_opened")
  openedAt              DateTime? @map("opened_at")
  openCount             Int       @default(0) @map("open_count")
  firstOpenedAt         DateTime? @map("first_opened_at")
  lastOpenedAt          DateTime? @map("last_opened_at")
  openedFrom            String?   @map("opened_from")
  // web, mobile_app, email_client

  // クリック追跡
  isClicked             Boolean   @default(false) @map("is_clicked")
  clickedAt             DateTime? @map("clicked_at")
  clickCount            Int       @default(0) @map("click_count")
  clickedLinks          Json?     @map("clicked_links")
  // [{ "url": "...", "clickedAt": "...", "count": 3 }]

  // 回答追跡
  hasResponded          Boolean   @default(false) @map("has_responded")
  respondedAt           DateTime? @map("responded_at")

  // 既読・未読管理
  isRead                Boolean   @default(false) @map("is_read")
  readAt                DateTime? @map("read_at")
  isArchived            Boolean   @default(false) @map("is_archived")
  archivedAt            DateTime? @map("archived_at")

  // エラー情報
  failureReason         String?   @map("failure_reason")
  retryCount            Int       @default(0) @map("retry_count")
  lastRetryAt           DateTime? @map("last_retry_at")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // リレーション
  notification          StaffNotification @relation(fields: [notificationId], references: [id])

  @@index([notificationId])
  @@index([employeeId])
  @@index([isOpened])
  @@index([isRead])
  @@index([deliveryStatus])
  @@index([sentAt])
  @@map("staff_notification_deliveries")
}
```

#### 27-4. StaffNotificationResponse（通知への回答）

**目的**: アンケート・面談希望日等の回答データを保存。フォーム形式の回答を柔軟に管理。

```prisma
model StaffNotificationResponse {
  id                    String    @id @default(cuid())
  notificationId        String    @map("notification_id")
  employeeId            String    @map("employee_id")
  employeeName          String    @map("employee_name")
  employeeDepartment    String?   @map("employee_department")

  // 回答内容
  responseData          Json      @map("response_data")
  // {
  //   "interviewPreferredDates": ["2025-10-15", "2025-10-16"],
  //   "interviewPreferredTime": "午前",
  //   "comments": "特になし"
  // }

  // フォーム検証
  isComplete            Boolean   @default(true) @map("is_complete")
  validationErrors      Json?     @map("validation_errors")
  // [{ "field": "preferredDates", "error": "必須項目です" }]

  // 提出情報
  submittedAt           DateTime  @default(now()) @map("submitted_at")
  submittedFrom         String?   @map("submitted_from")
  // web, mobile_app
  ipAddress             String?   @map("ip_address")

  // 編集履歴
  isEdited              Boolean   @default(false) @map("is_edited")
  editCount             Int       @default(0) @map("edit_count")
  lastEditedAt          DateTime? @map("last_edited_at")
  editHistory           Json?     @map("edit_history")
  // [{ "editedAt": "...", "changedFields": ["preferredDates"], "previousValue": {...} }]

  // 処理状態
  processingStatus      String    @default("pending") @map("processing_status")
  // pending, processed, approved, rejected
  processedBy           String?   @map("processed_by")
  processedAt           DateTime? @map("processed_at")
  processingNote        String?   @db.Text @map("processing_note")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // リレーション
  notification          StaffNotification @relation(fields: [notificationId], references: [id])

  @@index([notificationId])
  @@index([employeeId])
  @@index([submittedAt])
  @@index([processingStatus])
  @@map("staff_notification_responses")
}
```

#### 27-5. StaffNotificationRegistration（研修等の受付）

**目的**: 研修通知に統合された受付機能。参加登録・出欠管理・キャンセル待ちの管理。

```prisma
model StaffNotificationRegistration {
  id                    String    @id @default(cuid())
  notificationId        String    @map("notification_id")
  employeeId            String    @map("employee_id")
  employeeName          String    @map("employee_name")
  employeeDepartment    String?   @map("employee_department")
  employeePosition      String?   @map("employee_position")

  // 登録情報
  registrationStatus    String    @default("registered") @map("registration_status")
  // registered, waitlisted, confirmed, attended, absent, cancelled
  registeredAt          DateTime  @default(now()) @map("registered_at")
  confirmedAt           DateTime? @map("confirmed_at")

  // 優先度・順番
  registrationNumber    Int       @map("registration_number")
  // 登録順（1, 2, 3...）
  priority              Int?      @map("priority")
  // 優先順位（必須研修は高優先度）
  isWaitlisted          Boolean   @default(false) @map("is_waitlisted")
  waitlistPosition      Int?      @map("waitlist_position")

  // 参加情報
  attendanceStatus      String?   @map("attendance_status")
  // attended, absent, partial, excused
  attendedAt            DateTime? @map("attended_at")
  checkInTime           DateTime? @map("check_in_time")
  checkOutTime          DateTime? @map("check_out_time")
  attendanceDuration    Int?      @map("attendance_duration")
  // 分単位

  // キャンセル情報
  isCancelled           Boolean   @default(false) @map("is_cancelled")
  cancelledAt           DateTime? @map("cancelled_at")
  cancellationReason    String?   @db.Text @map("cancellation_reason")
  cancelledBy           String?   @map("cancelled_by")
  // employee（本人）, admin（管理者）

  // 追加情報
  specialRequests       String?   @db.Text @map("special_requests")
  // アレルギー、配慮事項等
  notes                 String?   @db.Text @map("notes")
  adminNotes            String?   @db.Text @map("admin_notes")

  // 通知設定
  sendReminder          Boolean   @default(true) @map("send_reminder")
  reminderSentAt        DateTime? @map("reminder_sent_at")
  sendCancellationNotice Boolean  @default(true) @map("send_cancellation_notice")

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // リレーション
  notification          StaffNotification @relation(fields: [notificationId], references: [id])

  @@index([notificationId])
  @@index([employeeId])
  @@index([registrationStatus])
  @@index([registrationNumber])
  @@index([isWaitlisted])
  @@index([attendanceStatus])
  @@map("staff_notification_registrations")
}
```

### 実装による効果

✅ **職員向け通知の完全管理**
- お知らせ、面談案内、研修案内、アンケート等を一元管理
- テンプレート化により配信作業を効率化
- カテゴリー・優先度による整理

✅ **配信効果の完全追跡**
- 個別の開封率・クリック率・回答率を追跡
- どの職員が読んだか、回答したかを完全把握
- 未読者への自動リマインダー

✅ **柔軟な配信対象設定**
- 全職員、部署別、役職別、個別選択
- 条件指定（経験年数、評価ランク等）による絞り込み
- テストユーザーへの先行配信

✅ **研修受付機能の統合**
- 研修通知に受付フォームを統合
- 定員管理・キャンセル待ち管理
- 出欠管理・参加証明書発行

✅ **承認フロー・スケジュール配信**
- 重要通知は承認フロー設定
- 予約配信・定期配信（毎週月曜等）
- 最適送信時刻の自動提案

✅ **VoiceDrive連携（将来）**
- VoiceDriveへの通知同期
- VoiceDriveからの通知作成
- 統合された通知管理

**職員向け通知システムを完全にデータベース化し、配信効率と追跡精度を大幅に向上！**

---

## Section 28: 採用管理システム（人材パイプライン管理・見学者・応募者）

### 概要
統合採用管理システムで、見学者から応募者、内定者、入社までの一貫した人材パイプライン管理を実現します。重複チェック、人材プール、施設別採用管理、コンバージョン率分析などを含みます。

**ページURL**: https://staff-medical-system-v2.vercel.app/recruitment

**主要機能**:
- 人材パイプライン管理（見学者→応募者→内定者→入社→退職者プール）
- 見学予約管理（施設見学・職場体験）
- 応募者管理（書類選考・面接・評価）
- 求人票管理（複数施設・職種）
- 人材検索・重複チェック
- コンバージョン率分析
- 人材プール管理（将来候補・高評価）

### 不足DB項目

#### 1. TalentProfile（人材プロファイル統合管理）

```prisma
model TalentProfile {
  id                    String    @id @default(cuid())

  // 基本情報
  lastName              String    @map("last_name")
  firstName             String    @map("first_name")
  lastNameKana          String    @map("last_name_kana")
  firstNameKana         String    @map("first_name_kana")
  email                 String    @map("email")
  phone                 String    @map("phone")
  birthDate             String?   @map("birth_date")
  gender                String?   @map("gender")
  // 男性、女性、その他、回答しない
  address               String?   @db.Text @map("address")
  postalCode            String?   @map("postal_code")

  // 初回接触情報
  firstContactDate      String    @map("first_contact_date")
  lastContactDate       String?   @map("last_contact_date")
  source                String    @map("source")
  // 求人サイト、紹介、直接応募、ハローワーク、大学紹介、その他
  sourceDetails         String?   @db.Text @map("source_details")
  referredBy            String?   @map("referred_by")

  // 現在のステータス（人材パイプライン）
  currentStatus         String    @map("current_status")
  // visitor-inquiry（見学問合せ）, visitor-scheduled（見学予約済）, visitor-completed（見学完了）
  // applicant-submitted（応募書類提出）, applicant-screening（書類選考中）, applicant-interview（面接中）
  // offer-pending（内定保留）, offer-accepted（内定承諾）, offer-rejected（内定辞退）
  // employee-onboarding（入社手続中）, employee-active（在職中）
  // talent-pool（人材プール）, inactive（非アクティブ）, blacklisted（ブラックリスト）

  currentStage          String    @map("current_stage")
  // visitor, applicant, offer-holder, employee, inactive
  statusChangedAt       DateTime  @default(now()) @map("status_changed_at")

  // タグ・フラグ
  tags                  Json?     @map("tags")
  // ["新卒", "経験者", "高評価", "即戦力", "将来候補"]

  // 見学者情報（visitorステージの場合）
  visitorInfo           Json?     @map("visitor_info")
  // {
  //   scheduledVisitDate: "2024-02-01",
  //   interestedDepartments: ["看護部", "内科"],
  //   interestedPositions: ["看護師"],
  //   visitPurpose: "施設見学・職場体験",
  //   visitNotes: "..."
  // }

  // 応募者情報（applicantステージの場合）
  applicantInfo         Json?     @map("applicant_info")
  // {
  //   desiredPosition: "看護師",
  //   desiredSalary: { min: 400, max: 500 },
  //   availableStartDate: "2024-03-01",
  //   currentEmployment: "他院勤務中",
  //   documents: {
  //     resume: { fileName: "resume.pdf", uploadedAt: "2024-01-20", version: 1 },
  //     portfolio: { fileName: "portfolio.pdf", uploadedAt: "2024-01-21", version: 1 }
  //   },
  //   qualifications: ["正看護師", "認定看護師"],
  //   licenses: [],
  //   skills: [],
  //   experience: [
  //     {
  //       company: "A病院",
  //       position: "看護師",
  //       startDate: "2015-04-01",
  //       endDate: "2024-01-31",
  //       isCurrent: true,
  //       responsibilities: "病棟看護業務"
  //     }
  //   ],
  //   education: [
  //     {
  //       institution: "B看護専門学校",
  //       degree: "看護学",
  //       major: "看護",
  //       graduationDate: "2015-03"
  //     }
  //   ]
  // }

  // 内定者情報（offer-holderステージの場合）
  offerInfo             Json?     @map("offer_info")
  // {
  //   offerDate: "2024-02-15",
  //   offerPosition: "看護師",
  //   offerSalary: 450,
  //   expectedStartDate: "2024-04-01",
  //   offerLetter: { fileName: "offer.pdf", sentAt: "2024-02-15" },
  //   responseDeadline: "2024-03-01",
  //   acceptedAt: "2024-02-20",
  //   rejectedAt: null,
  //   rejectionReason: null
  // }

  // 職員情報（employeeステージの場合）
  employeeInfo          Json?     @map("employee_info")
  // {
  //   employeeId: "OH-NS-2024-001",
  //   startDate: "2024-04-01",
  //   facility: "小原病院",
  //   department: "看護部",
  //   position: "看護師",
  //   endDate: null,
  //   resignationDate: null,
  //   resignationReason: null
  // }

  // 人材プール情報（talent-poolステージの場合）
  talentPoolInfo        Json?     @map("talent_pool_info")
  // {
  //   addedDate: "2024-01-15",
  //   addedBy: "HR部長",
  //   category: "future-fit" | "high-quality" | "specialized",
  //   potentialPositions: ["理学療法士", "リハビリ主任"],
  //   recontactDate: "2024-04-01",
  //   priority: "high" | "medium" | "low",
  //   notes: "経験豊富で優秀だが、現在のポジションに空きなし。次期昇進候補として保持。"
  // }

  // 接触履歴
  contactHistory        Json?     @map("contact_history")
  // [
  //   {
  //     date: "2024-01-15",
  //     type: "email" | "phone" | "visit" | "interview",
  //     contactedBy: "人事担当者A",
  //     summary: "初回問合せ対応",
  //     nextAction: "見学日程調整"
  //   }
  // ]

  // フラグ
  flags                 Json?     @map("flags")
  // {
  //   isDuplicate: false,
  //   hasMultipleFacilityApplications: false,
  //   isPreviousEmployee: false,
  //   isBlacklisted: false
  // }

  // メタデータ
  metadata              Json?     @map("metadata")
  // {
  //   createdAt: "2024-01-15",
  //   createdBy: "admin",
  //   updatedAt: "2024-01-20",
  //   updatedBy: "admin",
  //   viewCount: 5,
  //   lastViewedAt: "2024-01-20",
  //   lastViewedBy: "admin"
  // }

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String    @map("created_by")

  @@map("talent_profiles")
  @@index([email])
  @@index([phone])
  @@index([currentStatus])
  @@index([currentStage])
  @@index([firstContactDate])
}
```

**追加理由**: 人材の一元管理。見学者→応募者→内定者→入社までの全ライフサイクルを1つのレコードで追跡。

---

#### 2. JobPosting（求人票管理）

```prisma
model JobPosting {
  id                    String    @id @default(cuid())

  // 基本情報
  title                 String    @map("title")
  jobNumber             String    @unique @map("job_number")
  // JOB-2024-OH-NS-001（施設コード・職種コード含む）

  // 配属情報
  facility              String    @map("facility")
  // obara-hospital, tachigami-hospital, espoir-tachigami, hojuan
  department            String    @map("department")
  workLocation          String    @map("work_location")

  // 雇用条件
  employmentType        String    @map("employment_type")
  // 正社員、契約社員、パート、アルバイト、派遣
  numberOfPositions     Int       @map("number_of_positions")

  // 給与
  salary                Json      @map("salary")
  // { min: 400, max: 600, unit: "万円/月", details: "賞与年2回" }
  benefits              Json?     @map("benefits")
  // ["社会保険完備", "退職金制度", "研修制度充実", "温泉施設利用可"]

  // 業務内容
  jobDescription        String    @db.Text @map("job_description")
  responsibilities      Json?     @map("responsibilities")
  // ["病棟看護業務", "患者ケア", "記録業務", "チーム医療連携"]

  // 応募資格
  requiredQualifications Json     @map("required_qualifications")
  // ["正看護師免許", "病棟経験3年以上"]
  desiredQualifications Json?     @map("desired_qualifications")
  // ["認定看護師資格", "管理経験"]
  requiredSkills        Json?     @map("required_skills")
  desiredSkills         Json?     @map("desired_skills")

  // 勤務条件
  workHours             String?   @map("work_hours")
  // "8:30-17:30（シフト制）"
  holidays              String?   @map("holidays")
  // "週休2日制（シフト制）"
  overtime              String?   @map("overtime")
  // "月平均10-15時間"

  // 選考プロセス
  selectionProcess      Json?     @map("selection_process")
  // [
  //   { step: 1, name: "書類選考", duration: "7日" },
  //   { step: 2, name: "一次面接", duration: "5日" },
  //   { step: 3, name: "二次面接", duration: "5日" },
  //   { step: 4, name: "最終面接", duration: "3日" }
  // ]

  // 公開状況
  status                String    @default("draft") @map("status")
  // draft（下書き）, active（公開中）, closed（募集終了）, filled（充足）
  postingDate           String?   @map("posting_date")
  closingDate           String?   @map("closing_date")
  filledDate            String?   @map("filled_date")

  // 公開チャネル
  publishChannels       Json?     @map("publish_channels")
  // ["自社サイト", "求人サイトA", "求人サイトB", "ハローワーク"]

  // 応募状況
  applicantCount        Int       @default(0) @map("applicant_count")
  interviewCount        Int       @default(0) @map("interview_count")
  offerCount            Int       @default(0) @map("offer_count")
  hireCount             Int       @default(0) @map("hire_count")

  // メタデータ
  createdBy             String    @map("created_by")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  approvedBy            String?   @map("approved_by")
  approvedAt            DateTime? @map("approved_at")

  createdAt             DateTime  @default(now()) @map("created_at")

  @@map("job_postings")
  @@index([facility])
  @@index([status])
  @@index([postingDate])
}
```

**追加理由**: 求人票の一元管理。複数施設・複数チャネルへの展開を管理。

---

#### 3. VisitReservation（見学予約管理）

```prisma
model VisitReservation {
  id                    String    @id @default(cuid())

  // 見学者情報
  talentId              String    @map("talent_id")
  reservationNumber     String    @unique @map("reservation_number")
  // VISIT-2024-OH-001

  // 予約日時
  scheduledDate         String    @map("scheduled_date")
  scheduledTime         String    @map("scheduled_time")
  duration              Int       @default(120) @map("duration")
  // 分単位（デフォルト2時間）

  // 見学先
  facility              String    @map("facility")
  departments           Json      @map("departments")
  // ["看護部", "内科", "リハビリテーション科"]

  // 見学タイプ
  visitType             String    @map("visit_type")
  // individual（個別）, group（グループ）, student-group（学生団体）
  groupSize             Int?      @map("group_size")

  // 担当者
  coordinator           Json?     @map("coordinator")
  // { id: "c1", name: "田中 美智子", department: "人事部" }
  guides                Json?     @map("guides")
  // [
  //   { id: "g1", name: "看護部長", department: "看護部", timeSlot: "14:00-15:00" }
  // ]

  // 見学内容
  agenda                Json?     @map("agenda")
  // [
  //   { time: "14:00", activity: "施設案内", location: "本館", responsible: "人事部" },
  //   { time: "14:30", activity: "看護部見学", location: "3階病棟", responsible: "看護部長" }
  // ]
  interestedPositions   Json?     @map("interested_positions")
  // ["看護師", "リハビリ職"]
  visitPurpose          String?   @db.Text @map("visit_purpose")

  // ステータス
  status                String    @default("requested") @map("status")
  // requested（予約申込）, confirmed（確定）, rescheduled（日程変更）,
  // completed（見学完了）, cancelled（キャンセル）, no-show（無断欠席）

  // キャンセル情報
  cancelledAt           DateTime? @map("cancelled_at")
  cancelledBy           String?   @map("cancelled_by")
  cancellationReason    String?   @db.Text @map("cancellation_reason")

  // 見学後フォロー
  completedAt           DateTime? @map("completed_at")
  feedback              Json?     @map("feedback")
  // {
  //   satisfaction: 5,
  //   comments: "とても良い雰囲気でした",
  //   likelyToApply: true,
  //   interestedPositions: ["看護師"]
  // }
  followUpActions       Json?     @map("follow_up_actions")
  // [
  //   { action: "応募案内送付", dueDate: "2024-02-05", status: "pending" }
  // ]

  // メタデータ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String    @map("created_by")

  @@map("visit_reservations")
  @@index([talentId])
  @@index([facility])
  @@index([scheduledDate])
  @@index([status])
}
```

**追加理由**: 見学予約の詳細管理。スケジュール調整、担当者割当、見学後フォローアップを管理。

---

#### 4. RecruitmentInterview（採用面接管理）

```prisma
model RecruitmentInterview {
  id                    String    @id @default(cuid())

  // 応募者・求人情報
  talentId              String    @map("talent_id")
  jobPostingId          String    @map("job_posting_id")
  interviewNumber       String    @unique @map("interview_number")
  // INT-2024-OH-NS-001

  // 面接タイプ
  interviewType         String    @map("interview_type")
  // first（一次）, second（二次）, final（最終）, casual（カジュアル）
  interviewRound        Int       @map("interview_round")

  // 日時・場所
  scheduledDate         String    @map("scheduled_date")
  scheduledTime         String    @map("scheduled_time")
  duration              Int       @default(60) @map("duration")
  location              String    @map("location")
  // "本館3F会議室A", "オンライン（Zoom）"
  isOnline              Boolean   @default(false) @map("is_online")
  meetingUrl            String?   @map("meeting_url")

  // 面接官
  interviewers          Json      @map("interviewers")
  // [
  //   { id: "int1", name: "人事部長", position: "部長", department: "人事部" },
  //   { id: "int2", name: "看護部長", position: "部長", department: "看護部" }
  // ]

  // 評価
  evaluations           Json?     @map("evaluations")
  // [
  //   {
  //     interviewerId: "int1",
  //     scores: {
  //       communication: 4,
  //       professionalism: 5,
  //       technicalSkills: 4,
  //       motivation: 5,
  //       cultureFit: 4
  //     },
  //     totalScore: 22,
  //     comments: "優秀な候補者。即戦力として期待できる。",
  //     recommendation: "strong-hire"
  //   }
  // ]

  overallScore          Int?      @map("overall_score")
  overallRecommendation String?   @map("overall_recommendation")
  // strong-hire（強く推薦）, hire（採用）, maybe（要検討）, no-hire（不採用）

  // ステータス
  status                String    @default("scheduled") @map("status")
  // scheduled（予定）, completed（完了）, rescheduled（再調整）,
  // cancelled（キャンセル）, no-show（欠席）

  // 次のステップ
  nextStep              String?   @map("next_step")
  // "二次面接へ進む", "最終面接へ進む", "内定", "不採用"
  nextInterviewId       String?   @map("next_interview_id")

  // キャンセル・変更情報
  rescheduledFrom       String?   @map("rescheduled_from")
  cancelledAt           DateTime? @map("cancelled_at")
  cancellationReason    String?   @db.Text @map("cancellation_reason")

  // メタデータ
  completedAt           DateTime? @map("completed_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String    @map("created_by")

  @@map("recruitment_interviews")
  @@index([talentId])
  @@index([jobPostingId])
  @@index([scheduledDate])
  @@index([status])
}
```

**追加理由**: 採用面接の詳細管理。複数面接官評価、スコアリング、次ステップ管理。

---

#### 5. TalentPipelineMetrics（人材パイプライン分析）

```prisma
model TalentPipelineMetrics {
  id                    String    @id @default(cuid())

  // 期間
  periodType            String    @map("period_type")
  // daily, weekly, monthly, quarterly, yearly
  periodStart           String    @map("period_start")
  periodEnd             String    @map("period_end")

  // 施設
  facility              String?   @map("facility")
  // null = 全施設

  // ステージ別人数
  stageDistribution     Json      @map("stage_distribution")
  // {
  //   visitors: 15,
  //   applicants: 25,
  //   offerHolders: 5,
  //   employees: 3,
  //   talentPool: 12,
  //   inactive: 8
  // }

  // コンバージョン率
  conversionRates       Json      @map("conversion_rates")
  // {
  //   visitorToApplicant: 65,    // 見学者→応募者 65%
  //   applicantToInterview: 80,   // 応募者→面接 80%
  //   interviewToOffer: 40,       // 面接→内定 40%
  //   offerToEmployee: 85         // 内定→入社 85%
  // }

  // 平均期間（日数）
  averageDuration       Json      @map("average_duration")
  // {
  //   visitToApplication: 7,      // 見学→応募 7日
  //   applicationToInterview: 5,  // 応募→面接 5日
  //   interviewToOffer: 10,       // 面接→内定 10日
  //   offerToEmployment: 14       // 内定→入社 14日
  // }

  // ソース別効果
  sourceEffectiveness   Json      @map("source_effectiveness")
  // [
  //   {
  //     source: "求人サイト",
  //     visitors: 30,
  //     applicants: 20,
  //     hires: 5,
  //     conversionRate: 25,
  //     averageQuality: 4
  //   }
  // ]

  // 施設別メトリクス
  facilityMetrics       Json?     @map("facility_metrics")
  // [
  //   {
  //     facility: "小原病院",
  //     activeVisitors: 8,
  //     activeApplicants: 12,
  //     pendingOffers: 3,
  //     monthlyHires: 2
  //   }
  // ]

  // 月次トレンド
  monthlyTrends         Json?     @map("monthly_trends")
  // [
  //   {
  //     month: "2024-01",
  //     visitors: 15,
  //     applications: 10,
  //     interviews: 8,
  //     offers: 3,
  //     hires: 2
  //   }
  // ]

  // 計算日時
  calculatedAt          DateTime  @default(now()) @map("calculated_at")

  @@map("talent_pipeline_metrics")
  @@index([periodType, periodStart])
  @@index([facility])
}
```

**追加理由**: 採用活動のKPI分析。コンバージョン率、平均期間、ソース別効果を定量評価。

---

### 実装メモ

1. **人材パイプライン管理の完全統合**
   - 見学者→応募者→内定者→入社のライフサイクルを1つのTalentProfileで管理
   - ステージ遷移時に履歴を自動記録
   - 重複チェック（メール・電話番号）で既存人材との照合

2. **見学予約システム**
   - スケジュール管理、担当者割当、見学後フォローアップ
   - 複数施設・複数部署の同時見学対応
   - 見学満足度調査と応募意向確認

3. **採用面接管理**
   - 複数面接官による多段階評価
   - スコアリングシステム（5段階評価 × 複数項目）
   - 次ステップ自動提案

4. **求人票管理**
   - 複数施設・複数職種の求人を一元管理
   - 公開チャネル管理（自社サイト、求人サイト、ハローワーク等）
   - 応募状況リアルタイム追跡

5. **人材プール管理**
   - 高評価だが現在ポジションなしの候補者を保持
   - 再接触日設定、優先度管理
   - 将来の欠員時に優先的にアプローチ

6. **分析・レポート**
   - コンバージョン率分析（各ステージ間の転換率）
   - ソース別効果測定（求人サイトA vs 紹介 vs 直接応募）
   - 施設別・職種別の採用状況可視化

---

### 統合ポイント

- **TalentProfile** ↔ **Employee**: 入社時に employeeInfo を更新し、従業員マスタと紐付け
- **VisitReservation** ↔ **TalentProfile**: 見学予約完了後、応募意向があれば applicant ステージへ自動遷移
- **RecruitmentInterview** ↔ **TalentProfile**: 面接評価完了後、内定判断に応じて offer-holder ステージへ遷移
- **JobPosting** ↔ **HRPolicyMaster**: 人事ポリシーマスタの採用方針と連動
- **TalentPipelineMetrics** ↔ **DashboardData**: ダッシュボードに採用KPIを表示

---

## Section 28 完了

以上、Section 28「採用管理システム（人材パイプライン管理・見学者・応募者）」として5テーブルを追加しました。

---

## Section 29: AI制御センター・LLM統合管理システム

### 概要
システム全体のAI機能（面談分析、レポート生成、スマートサジェスト、VoiceDrive通知等）を統合管理し、機能ON/OFF、モデル選択、プロンプト管理、利用状況分析を実現します。

**ページURL**: https://staff-medical-system-v2.vercel.app/admin/ai-settings

**主要機能**:
- AI機能ON/OFF管理（8機能：面談分析、要約、提案、評価コメント、レポート、ナビ、アクション、VoiceDrive通知）
- ローカルLLMモデル管理（Ollama、LlamaCpp）
- プロンプトテンプレート管理
- AI利用統計分析（利用率、処理件数、節約時間）
- モデルパフォーマンス比較

### 不足DB項目

#### 1. AIFeatureConfiguration（AI機能設定管理）

```prisma
model AIFeatureConfiguration {
  id                    String    @id @default(cuid())

  // 機能識別
  featureId             String    @unique @map("feature_id")
  // interview.analysis, interview.summary, interview.suggestion,
  // evaluation.comment, report.monthly, smartsuggest.navigation,
  // smartsuggest.action, voicedrive.notification

  featureName           String    @map("feature_name")
  featureCategory       String    @map("feature_category")
  // interview, evaluation, report, smartsuggest, voicedrive
  featureDescription    String    @db.Text @map("feature_description")

  // 有効化設定
  isEnabled             Boolean   @default(true) @map("is_enabled")
  enabledAt             DateTime? @map("enabled_at")
  enabledBy             String?   @map("enabled_by")
  disabledAt            DateTime? @map("disabled_at")
  disabledBy            String?   @map("disabled_by")

  // 利用対象
  availableForRoles     Json?     @map("available_for_roles")
  // ["admin", "hr", "manager", "staff"]
  availableForFacilities Json?    @map("available_for_facilities")
  // ["obara-hospital", "tachigami-hospital", "espoir-tachigami", "hojuan"]

  // モデル設定
  defaultModelId        String?   @map("default_model_id")
  fallbackModelId       String?   @map("fallback_model_id")
  allowModelSelection   Boolean   @default(false) @map("allow_model_selection")

  // プロンプト設定
  defaultPromptTemplateId String? @map("default_prompt_template_id")

  // パフォーマンス設定
  maxTokens             Int?      @map("max_tokens")
  temperature           Float?    @map("temperature")
  topP                  Float?    @map("top_p")
  timeout               Int?      @map("timeout")
  // 秒単位

  // レート制限
  rateLimit             Json?     @map("rate_limit")
  // {
  //   perUser: { requests: 100, period: "1h" },
  //   global: { requests: 1000, period: "1h" }
  // }

  // 利用統計
  usageStats            Json?     @map("usage_stats")
  // {
  //   totalRequests: 1234,
  //   successfulRequests: 1200,
  //   failedRequests: 34,
  //   averageResponseTime: 2.5,
  //   totalTokensUsed: 500000
  // }

  // メンテナンス情報
  maintenanceMode       Boolean   @default(false) @map("maintenance_mode")
  maintenanceMessage    String?   @db.Text @map("maintenance_message")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("ai_feature_configurations")
  @@index([featureCategory])
  @@index([isEnabled])
}
```

**追加理由**: AI機能の一元管理。機能ごとのON/OFF、モデル選択、パフォーマンス設定を管理。

---

#### 2. LLMModel（ローカルLLMモデル管理）

```prisma
model LLMModel {
  id                    String    @id @default(cuid())

  // モデル識別
  modelId               String    @unique @map("model_id")
  // ollama-llama3-8b, ollama-gemma-7b, llamacpp-mistral-7b
  modelName             String    @map("model_name")
  modelProvider         String    @map("model_provider")
  // ollama, llamacpp, openai-compatible

  // モデル仕様
  modelSize             String    @map("model_size")
  // 7B, 8B, 13B, 70B
  contextLength         Int       @map("context_length")
  // トークン数（例: 4096, 8192, 32768）
  modelType             String    @map("model_type")
  // chat, completion, embedding

  // 接続情報
  endpoint              String    @map("endpoint")
  // http://localhost:11434, http://localhost:8080
  apiKey                String?   @map("api_key")
  headers               Json?     @map("headers")
  // { "Authorization": "Bearer xxx" }

  // モデルステータス
  status                String    @default("inactive") @map("status")
  // active（稼働中）, inactive（停止中）, error（エラー）, loading（読込中）
  healthCheckUrl        String?   @map("health_check_url")
  lastHealthCheck       DateTime? @map("last_health_check")
  lastHealthStatus      String?   @map("last_health_status")

  // パフォーマンス情報
  averageResponseTime   Float?    @map("average_response_time")
  // 秒単位
  tokensPerSecond       Float?    @map("tokens_per_second")
  memoryUsage           Int?      @map("memory_usage")
  // MB単位

  // 利用統計
  totalRequests         Int       @default(0) @map("total_requests")
  successfulRequests    Int       @default(0) @map("successful_requests")
  failedRequests        Int       @default(0) @map("failed_requests")
  totalTokensGenerated  Int       @default(0) @map("total_tokens_generated")

  // 機能適性
  suitableFor           Json?     @map("suitable_for")
  // ["interview.analysis", "report.monthly", "evaluation.comment"]
  notSuitableFor        Json?     @map("not_suitable_for")

  // モデル説明
  description           String?   @db.Text @map("description")
  strengths             Json?     @map("strengths")
  // ["高速", "日本語対応", "論理的推論"]
  limitations           Json?     @map("limitations")
  // ["文脈理解が弱い", "長文生成に時間がかかる"]

  // バージョン管理
  modelVersion          String?   @map("model_version")
  lastUpdated           DateTime? @map("last_updated")
  updateNotes           String?   @db.Text @map("update_notes")

  // 優先度
  priority              Int       @default(0) @map("priority")
  // 高い数値ほど優先（自動選択時に使用）

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("llm_models")
  @@index([modelProvider])
  @@index([status])
  @@index([priority])
}
```

**追加理由**: ローカルLLMモデルの一元管理。Ollama、LlamaCppモデルの登録、ヘルスチェック、パフォーマンス追跡。

---

#### 3. PromptTemplate（プロンプトテンプレート管理）

```prisma
model PromptTemplate {
  id                    String    @id @default(cuid())

  // テンプレート識別
  templateId            String    @unique @map("template_id")
  // interview-analysis-v1, report-monthly-summary-v2
  templateName          String    @map("template_name")
  templateCategory      String    @map("template_category")
  // interview, evaluation, report, suggestion

  // プロンプト内容
  systemPrompt          String?   @db.Text @map("system_prompt")
  userPromptTemplate    String    @db.Text @map("user_prompt_template")
  // プレースホルダー: {{interviewText}}, {{staffName}}, {{period}}

  placeholders          Json?     @map("placeholders")
  // [
  //   { key: "{{interviewText}}", description: "面談内容", required: true },
  //   { key: "{{staffName}}", description: "職員名", required: true }
  // ]

  // 出力設定
  outputFormat          String?   @map("output_format")
  // json, markdown, plain-text
  outputSchema          Json?     @map("output_schema")
  // JSON Schemaでバリデーション
  expectedOutputLength  Int?      @map("expected_output_length")
  // トークン数

  // モデルパラメータ
  recommendedModel      String?   @map("recommended_model")
  temperature           Float?    @default(0.7) @map("temperature")
  maxTokens             Int?      @default(1000) @map("max_tokens")
  topP                  Float?    @default(0.9) @map("top_p")
  stopSequences         Json?     @map("stop_sequences")

  // バージョン管理
  version               Int       @default(1) @map("version")
  previousVersionId     String?   @map("previous_version_id")
  changeNotes           String?   @db.Text @map("change_notes")

  // 利用統計
  usageCount            Int       @default(0) @map("usage_count")
  averageSuccessRate    Float?    @map("average_success_rate")
  averageResponseTime   Float?    @map("average_response_time")
  userRating            Float?    @map("user_rating")
  // 1-5

  // ステータス
  status                String    @default("draft") @map("status")
  // draft（下書き）, active（利用中）, deprecated（非推奨）, archived（アーカイブ）
  isDefault             Boolean   @default(false) @map("is_default")

  // テスト結果
  testCases             Json?     @map("test_cases")
  // [
  //   {
  //     input: { ... },
  //     expectedOutput: "...",
  //     actualOutput: "...",
  //     passed: true
  //   }
  // ]

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String    @map("created_by")

  @@map("prompt_templates")
  @@index([templateCategory])
  @@index([status])
  @@index([version])
}
```

**追加理由**: プロンプトのバージョン管理。テンプレート化により一貫した出力品質を保証。

---

#### 4. AIRequestLog（AI利用ログ）

```prisma
model AIRequestLog {
  id                    String    @id @default(cuid())

  // リクエスト情報
  requestId             String    @unique @map("request_id")
  featureId             String    @map("feature_id")
  // 対応するAIFeatureConfiguration.featureId

  // ユーザー情報
  userId                String    @map("user_id")
  userRole              String    @map("user_role")
  facility              String?   @map("facility")

  // モデル情報
  modelId               String    @map("model_id")
  modelProvider         String    @map("model_provider")

  // プロンプト情報
  promptTemplateId      String?   @map("prompt_template_id")
  systemPrompt          String?   @db.Text @map("system_prompt")
  userPrompt            String    @db.Text @map("user_prompt")

  // 実行情報
  requestedAt           DateTime  @default(now()) @map("requested_at")
  completedAt           DateTime? @map("completed_at")
  responseTime          Float?    @map("response_time")
  // 秒単位

  // レスポンス情報
  response              String?   @db.Text @map("response")
  tokensUsed            Int?      @map("tokens_used")
  promptTokens          Int?      @map("prompt_tokens")
  completionTokens      Int?      @map("completion_tokens")

  // ステータス
  status                String    @map("status")
  // success, failed, timeout, rate-limited
  errorMessage          String?   @db.Text @map("error_message")
  errorCode             String?   @map("error_code")

  // パフォーマンス情報
  modelResponseTime     Float?    @map("model_response_time")
  totalProcessingTime   Float?    @map("total_processing_time")

  // ユーザーフィードバック
  userRating            Int?      @map("user_rating")
  // 1-5
  userFeedback          String?   @db.Text @map("user_feedback")
  wasHelpful            Boolean?  @map("was_helpful")

  // コスト情報（将来の外部API対応用）
  estimatedCost         Float?    @map("estimated_cost")
  costCurrency          String?   @default("JPY") @map("cost_currency")

  @@map("ai_request_logs")
  @@index([featureId])
  @@index([userId])
  @@index([modelId])
  @@index([requestedAt])
  @@index([status])
}
```

**追加理由**: AI利用の完全追跡。パフォーマンス分析、コスト計算、ユーザーフィードバック収集。

---

#### 5. AISystemMetrics（AI統合分析）

```prisma
model AISystemMetrics {
  id                    String    @id @default(cuid())

  // 期間
  periodType            String    @map("period_type")
  // daily, weekly, monthly
  periodStart           String    @map("period_start")
  periodEnd             String    @map("period_end")

  // 全体統計
  totalRequests         Int       @map("total_requests")
  successfulRequests    Int       @map("successful_requests")
  failedRequests        Int       @map("failed_requests")
  averageResponseTime   Float     @map("average_response_time")
  totalTokensUsed       Int       @map("total_tokens_used")

  // 利用率
  utilizationRate       Float     @map("utilization_rate")
  // 全機能のうち有効化されている機能の割合（%）
  activeFeatureCount    Int       @map("active_feature_count")
  totalFeatureCount     Int       @map("total_feature_count")

  // 機能別統計
  featureUsage          Json      @map("feature_usage")
  // {
  //   "interview.analysis": { requests: 234, successRate: 98.5 },
  //   "report.monthly": { requests: 45, successRate: 100 }
  // }

  // モデル別統計
  modelPerformance      Json      @map("model_performance")
  // {
  //   "ollama-llama3-8b": {
  //     requests: 500,
  //     avgResponseTime: 2.3,
  //     successRate: 99.2,
  //     tokensPerSecond: 45
  //   }
  // }

  // ユーザー満足度
  averageUserRating     Float?    @map("average_user_rating")
  positiveRatingCount   Int?      @map("positive_rating_count")
  negativeRatingCount   Int?      @map("negative_rating_count")

  // 節約時間推定
  estimatedTimeSaved    Float?    @map("estimated_time_saved")
  // 時間単位
  estimatedCostSaved    Float?    @map("estimated_cost_saved")
  // 金額（外部API利用時との比較）

  // エラー分析
  errorBreakdown        Json?     @map("error_breakdown")
  // {
  //   "timeout": 12,
  //   "model-unavailable": 8,
  //   "rate-limited": 5
  // }

  // トレンド
  requestTrend          Json?     @map("request_trend")
  // 日別リクエスト数
  popularFeatures       Json?     @map("popular_features")
  // 利用頻度TOP5

  calculatedAt          DateTime  @default(now()) @map("calculated_at")

  @@map("ai_system_metrics")
  @@index([periodType, periodStart])
}
```

**追加理由**: AI利用の統合分析。利用率、節約時間、コスト推定、トレンド分析を可視化。

---

### 実装メモ

1. **AI機能の一元管理**
   - 8つのAI機能をfeatureIdで識別（interview.analysis, interview.summary, interview.suggestion, evaluation.comment, report.monthly, smartsuggest.navigation, smartsuggest.action, voicedrive.notification）
   - 機能ごとにON/OFF、対象ロール、対象施設を設定
   - レート制限によるシステム負荷管理

2. **ローカルLLM管理**
   - Ollama、LlamaCppの複数モデルを登録
   - ヘルスチェックで稼働状況監視
   - パフォーマンス統計でモデル選択を最適化

3. **プロンプト管理**
   - バージョン管理でプロンプト改善を追跡
   - テストケースで出力品質を保証
   - プレースホルダーで動的プロンプト生成

4. **利用ログ追跡**
   - 全AI処理をログ記録
   - レスポンスタイム、トークン使用量、エラー情報を記録
   - ユーザーフィードバックで品質改善

5. **統合分析**
   - 利用率85%、処理件数1234件、節約時間456時間（UI表示）
   - 機能別・モデル別パフォーマンス比較
   - コスト推定（外部API利用時との比較）

---

### 統合ポイント

- **AIFeatureConfiguration** ↔ **InterviewSession**: 面談分析機能の有効化判定
- **LLMModel** ↔ **InterviewBooking**: ローカルLLMによる面談日程自動調整
- **PromptTemplate** ↔ **MonthlyReport**: レポート生成プロンプトのテンプレート適用
- **AIRequestLog** ↔ **AuditLog**: AI処理履歴を監査ログに統合
- **AISystemMetrics** ↔ **AdminDashboard**: AI利用統計をダッシュボードに表示

---

## Section 29 完了

以上、Section 29「AI制御センター・LLM統合管理システム」として5テーブルを追加しました。

---

# 更新履歴

- 2025-10-08 23:00: Section 26にSpecialAccountMaster追加（Level 97-99特別アカウント対応）、Section 18にVoiceDrive配信フィールド追加（ストレスチェック結果配信対応）
- 2025-10-08 22:30: Section 29「AI制御センター・LLM統合管理システム」追加
- 2025-10-08 22:00: Section 28「採用管理システム（人材パイプライン管理・見学者・応募者）」追加
- 2025-10-08 21:30: Section 27「職員向け通知・お知らせ管理システム」追加
- 2025-10-08 21:00: Section 26「基本マスターデータ管理（職種・役職・雇用形態・部署・人事ポリシー・特別アカウント）」追加（6テーブル）
- 2025-10-08 20:00: Section 25「システム管理・運用基盤（通知・監査ログ・バックアップ・コンプライアンス通報）」追加
- 2025-10-08 19:30: Section 24「面談日程調整・予約管理システム（ローカルLLM自動マッチング）」追加
- 2025-10-08 19:00: Section 23「面談制度統合管理システム（10種類面談・質問バンク）」追加
- 2025-10-08 18:30: Section 22「レポート・分析システム（100ページ超）」追加
- 2025-10-08 17:30: Section 21「ダッシュボード統合管理システム」追加
- 2025-10-08 17:00: Section 20「キャリアコース選択制度管理システム」追加
- 2025-10-08 16:30: Section 19「勤怠管理システム・VoiceDrive連携」追加
- 2025-10-08 15:45: Section 18「ストレスチェック・健康管理統合システム」追加
- 2025-10-08 14:20: Section 17「目標管理システム・等級制度・コンピテンシー評価」追加

---

**文書終了**

*本文書は随時更新されます。不足項目を発見次第、追記してください。*
