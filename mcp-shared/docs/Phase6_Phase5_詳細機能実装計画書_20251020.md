# Phase 6 Phase 5: 詳細機能実装計画書

**作成日**: 2025年10月21日
**作成者**: Claude Code（AI Assistant）
**フェーズ**: Phase 6 - 期限到達判断履歴機能
**サブフェーズ**: Phase 5 - 詳細機能（2営業日）

---

## 📋 目次

1. [概要](#概要)
2. [実装機能一覧](#実装機能一覧)
3. [技術仕様](#技術仕様)
4. [実装詳細](#実装詳細)
5. [UIデザイン](#uiデザイン)
6. [テスト計画](#テスト計画)
7. [スケジュール](#スケジュール)

---

## 概要

### 目的
Phase 6判断履歴機能の利便性向上のため、以下の詳細機能を実装します：
- グラフ拡大表示モーダル
- カスタム日付範囲フィルタ
- グラフダウンロード（PNG/SVG）
- Excelエクスポート（詳細版）

### 背景
Phase 3（基本機能）とPhase 4B（PDF出力）により、判断履歴の基本的な閲覧とエクスポートが可能になりました。Phase 5では、より詳細な分析とデータ活用を可能にする機能を追加します。

### 成果物
- グラフ拡大表示モーダルコンポーネント
- 日付範囲フィルタコンポーネント
- グラフダウンロード機能
- Excel詳細エクスポート機能
- 実装計画書（本ドキュメント）

---

## 実装機能一覧

### 1. グラフ拡大表示モーダル 🔍

#### 機能概要
各グラフをクリックすると、モーダルウィンドウで拡大表示します。

#### 実装内容
- モーダルコンポーネント作成
- グラフクリックイベント
- ESCキーで閉じる
- オーバーレイクリックで閉じる
- 拡大グラフのレスポンシブ対応

#### UI要素
- 半透明黒背景（opacity: 0.8）
- 中央に白いモーダルボックス（最大90vw × 80vh）
- 右上に×閉じるボタン
- グラフタイトル表示
- ダウンロードボタン

---

### 2. カスタム日付範囲フィルタ 📅

#### 機能概要
判断履歴の表示期間を自由に設定できます。

#### 実装内容
- 日付範囲選択UI
- プリセット期間（1週間、1ヶ月、3ヶ月、6ヶ月、1年、全期間）
- カスタム期間（開始日・終了日指定）
- フィルタ適用/リセット機能
- URLクエリパラメータ対応

#### UI要素
- プリセットボタングループ
- 開始日・終了日入力フィールド（type="date"）
- 「適用」「リセット」ボタン
- 現在のフィルタ状態表示

---

### 3. グラフダウンロード（PNG/SVG） 💾

#### 機能概要
各グラフを個別にPNG/SVG形式でダウンロードできます。

#### 実装内容
- PNG形式ダウンロード（html2canvas使用）
- SVG形式ダウンロード（Rechartsネイティブ機能）
- ダウンロードボタンUI
- ファイル名自動生成

#### ファイル命名規則
```
判断履歴_[グラフ名]_[YYYY-MM-DD].[拡張子]

例:
判断履歴_到達率分布_2025-10-21.png
判断履歴_判断タイプ分布_2025-10-21.svg
判断履歴_時系列推移_2025-10-21.png
```

---

### 4. Excelエクスポート（詳細版） 📊

#### 機能概要
CSVよりも詳細な情報を含むExcelファイルをエクスポートします。

#### 実装内容
- xlsx（SheetJS）ライブラリ使用
- 複数シート構成
  - Sheet 1: サマリー統計
  - Sheet 2: 判断履歴詳細
  - Sheet 3: 月次集計
- セル書式設定（太字、色、罫線）
- 列幅自動調整
- ヘッダー固定

#### Sheet 1: サマリー統計

| 項目                     | 値        |
|------------------------|----------|
| エクスポート日時              | 2025-10-21 00:30 |
| 総判断件数                 | 150      |
| 承認件数                  | 82 (54.7%) |
| ダウングレード件数             | 45 (30.0%) |
| 不採用件数                 | 23 (15.3%) |
| 平均到達率                 | 78.5%    |
| 平均期限超過日数              | 12.3日    |

#### Sheet 2: 判断履歴詳細

| No. | 判断日時 | 判断結果 | 到達率 | 超過日数 | 判断者 | スタッフ名 | 等級 | 部署 | 判断理由 |
|-----|---------|---------|-------|---------|------|---------|-----|------|---------|
| 1   | 2025-10-20 14:30 | 承認 | 85.5% | 15 | 山田太郎 | 佐藤花子 | 3等級 | 看護部 | 到達率が基準を満たしており... |

#### Sheet 3: 月次集計

| 年月 | 判断件数 | 承認 | ダウングレード | 不採用 | 平均到達率 | 平均超過日数 |
|------|---------|-----|------------|-------|----------|----------|
| 2025-10 | 45 | 25 | 15 | 5 | 79.2% | 11.5日 |
| 2025-09 | 38 | 20 | 12 | 6 | 77.8% | 13.2日 |

---

## 技術仕様

### 使用ライブラリ

#### 新規追加
```json
{
  "xlsx": "^0.18.5",           // Excel生成
  "file-saver": "^2.0.5"       // ファイル保存
}
```

#### 既存ライブラリ（継続使用）
- `html2canvas`: ^1.4.1（PNG変換）
- `recharts`: ^2.x（グラフ描画）
- `date-fns`: ^3.x（日付処理）

---

### コンポーネント設計

#### 1. ChartModal.tsx
```typescript
interface ChartModalProps {
  isOpen: boolean;
  onClose: () => void;
  chartTitle: string;
  chartElement: React.ReactNode;
  chartType: 'achievement-rate' | 'decision-type' | 'time-series';
}

export function ChartModal({
  isOpen,
  onClose,
  chartTitle,
  chartElement,
  chartType,
}: ChartModalProps) {
  // モーダル表示ロジック
  // ESCキーで閉じる
  // オーバーレイクリックで閉じる
  // ダウンロードボタン
}
```

#### 2. DateRangeFilter.tsx
```typescript
interface DateRangeFilterProps {
  startDate: Date | null;
  endDate: Date | null;
  onDateRangeChange: (start: Date | null, end: Date | null) => void;
}

export function DateRangeFilter({
  startDate,
  endDate,
  onDateRangeChange,
}: DateRangeFilterProps) {
  // プリセット期間
  const presets = [
    { label: '1週間', days: 7 },
    { label: '1ヶ月', days: 30 },
    { label: '3ヶ月', days: 90 },
    { label: '6ヶ月', days: 180 },
    { label: '1年', days: 365 },
    { label: '全期間', days: null },
  ];

  // カスタム期間入力
  // 適用/リセットボタン
}
```

#### 3. ChartDownloadButton.tsx
```typescript
interface ChartDownloadButtonProps {
  chartType: 'achievement-rate' | 'decision-type' | 'time-series';
  chartTitle: string;
}

export function ChartDownloadButton({
  chartType,
  chartTitle,
}: ChartDownloadButtonProps) {
  const handleDownloadPNG = async () => {
    const element = document.querySelector(`[data-chart="${chartType}"]`);
    const canvas = await html2canvas(element, { scale: 2 });
    canvas.toBlob((blob) => {
      saveAs(blob, `判断履歴_${chartTitle}_${format(new Date(), 'yyyy-MM-dd')}.png`);
    });
  };

  const handleDownloadSVG = async () => {
    // SVG変換ロジック
  };

  return (
    <div className="flex gap-2">
      <button onClick={handleDownloadPNG}>PNG</button>
      <button onClick={handleDownloadSVG}>SVG</button>
    </div>
  );
}
```

#### 4. ExcelExportButton.tsx
```typescript
interface ExcelExportButtonProps {
  decisions: ExpiredEscalationDecision[];
  summary: ExpiredEscalationSummary;
}

export function ExcelExportButton({
  decisions,
  summary,
}: ExcelExportButtonProps) {
  const handleExportExcel = async () => {
    const workbook = XLSX.utils.book_new();

    // Sheet 1: サマリー統計
    const summarySheet = createSummarySheet(summary);
    XLSX.utils.book_append_sheet(workbook, summarySheet, 'サマリー統計');

    // Sheet 2: 判断履歴詳細
    const detailSheet = createDetailSheet(decisions);
    XLSX.utils.book_append_sheet(workbook, detailSheet, '判断履歴詳細');

    // Sheet 3: 月次集計
    const monthlySheet = createMonthlySheet(decisions);
    XLSX.utils.book_append_sheet(workbook, monthlySheet, '月次集計');

    // ファイル保存
    XLSX.writeFile(workbook, `判断履歴詳細_${format(new Date(), 'yyyy-MM-dd')}.xlsx`);
  };

  return (
    <button onClick={handleExportExcel}>
      <FileSpreadsheetIcon />
      Excel詳細エクスポート
    </button>
  );
}
```

---

### ユーティリティ関数

#### exportExcel.ts
```typescript
import * as XLSX from 'xlsx';
import { format } from 'date-fns';

/**
 * サマリー統計シート作成
 */
export function createSummarySheet(summary: ExpiredEscalationSummary): XLSX.WorkSheet {
  const data = [
    ['項目', '値'],
    ['エクスポート日時', format(new Date(), 'yyyy-MM-dd HH:mm')],
    ['総判断件数', summary.totalDecisions],
    ['承認件数', `${summary.approvalCount} (${((summary.approvalCount / summary.totalDecisions) * 100).toFixed(1)}%)`],
    ['ダウングレード件数', `${summary.downgradeCount} (${((summary.downgradeCount / summary.totalDecisions) * 100).toFixed(1)}%)`],
    ['不採用件数', `${summary.rejectCount} (${((summary.rejectCount / summary.totalDecisions) * 100).toFixed(1)}%)`],
    ['平均到達率', `${summary.averageAchievementRate.toFixed(1)}%`],
    ['平均期限超過日数', `${summary.averageDaysOverdue.toFixed(1)}日`],
  ];

  const ws = XLSX.utils.aoa_to_sheet(data);

  // 列幅設定
  ws['!cols'] = [
    { wch: 25 },  // 項目列
    { wch: 30 },  // 値列
  ];

  // ヘッダー行のスタイル（太字）
  ws['A1'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'EFEFEF' } } };
  ws['B1'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'EFEFEF' } } };

  return ws;
}

/**
 * 判断履歴詳細シート作成
 */
export function createDetailSheet(decisions: ExpiredEscalationDecision[]): XLSX.WorkSheet {
  const data = [
    ['No.', '判断日時', '判断結果', '到達率', '超過日数', '判断者', 'スタッフ名', '等級', '部署', '判断理由'],
    ...decisions.map((d, i) => [
      i + 1,
      format(new Date(d.createdAt), 'yyyy-MM-dd HH:mm'),
      getDecisionLabel(d.decision),
      `${d.achievementRate.toFixed(1)}%`,
      `${d.daysOverdue}日`,
      d.deciderName,
      d.staffName || '',
      d.grade || '',
      d.department || '',
      d.reason || '',
    ]),
  ];

  const ws = XLSX.utils.aoa_to_sheet(data);

  // 列幅設定
  ws['!cols'] = [
    { wch: 5 },   // No.
    { wch: 18 },  // 判断日時
    { wch: 15 },  // 判断結果
    { wch: 10 },  // 到達率
    { wch: 10 },  // 超過日数
    { wch: 12 },  // 判断者
    { wch: 12 },  // スタッフ名
    { wch: 8 },   // 等級
    { wch: 12 },  // 部署
    { wch: 40 },  // 判断理由
  ];

  // ヘッダー行固定
  ws['!freeze'] = { xSplit: 0, ySplit: 1 };

  return ws;
}

/**
 * 月次集計シート作成
 */
export function createMonthlySheet(decisions: ExpiredEscalationDecision[]): XLSX.WorkSheet {
  // 月ごとにグループ化
  const monthlyData = new Map<string, {
    count: number;
    approved: number;
    downgraded: number;
    rejected: number;
    totalAchievementRate: number;
    totalDaysOverdue: number;
  }>();

  decisions.forEach((d) => {
    const month = format(new Date(d.createdAt), 'yyyy-MM');
    if (!monthlyData.has(month)) {
      monthlyData.set(month, {
        count: 0,
        approved: 0,
        downgraded: 0,
        rejected: 0,
        totalAchievementRate: 0,
        totalDaysOverdue: 0,
      });
    }

    const entry = monthlyData.get(month)!;
    entry.count++;
    entry.totalAchievementRate += d.achievementRate;
    entry.totalDaysOverdue += d.daysOverdue;

    if (d.decision === 'approve_at_current_level') entry.approved++;
    else if (d.decision === 'downgrade') entry.downgraded++;
    else if (d.decision === 'reject') entry.rejected++;
  });

  // ソートして配列に変換
  const sortedMonths = Array.from(monthlyData.entries())
    .sort((a, b) => b[0].localeCompare(a[0]));  // 新しい月が上

  const data = [
    ['年月', '判断件数', '承認', 'ダウングレード', '不採用', '平均到達率', '平均超過日数'],
    ...sortedMonths.map(([month, stats]) => [
      month,
      stats.count,
      stats.approved,
      stats.downgraded,
      stats.rejected,
      `${(stats.totalAchievementRate / stats.count).toFixed(1)}%`,
      `${(stats.totalDaysOverdue / stats.count).toFixed(1)}日`,
    ]),
  ];

  const ws = XLSX.utils.aoa_to_sheet(data);

  // 列幅設定
  ws['!cols'] = [
    { wch: 10 },  // 年月
    { wch: 10 },  // 判断件数
    { wch: 8 },   // 承認
    { wch: 15 },  // ダウングレード
    { wch: 8 },   // 不採用
    { wch: 12 },  // 平均到達率
    { wch: 14 },  // 平均超過日数
  ];

  return ws;
}

function getDecisionLabel(decision: string): string {
  switch (decision) {
    case 'approve_at_current_level': return '承認';
    case 'downgrade': return 'ダウングレード';
    case 'reject': return '不採用';
    default: return decision;
  }
}
```

---

## UIデザイン

### グラフ拡大モーダル

```
┌─────────────────────────────────────────────────────────────┐
│                     半透明黒背景（overlay）                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 到達率分布                                      × │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │                                                     │   │
│  │                   拡大グラフ表示                     │   │
│  │                                                     │   │
│  │                                                     │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │        [PNG] [SVG]                                  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 日付範囲フィルタ

```
┌─────────────────────────────────────────────────────────────┐
│ 📅 表示期間                                                  │
├─────────────────────────────────────────────────────────────┤
│ プリセット:                                                  │
│ [1週間] [1ヶ月] [3ヶ月] [6ヶ月] [1年] [全期間]              │
│                                                              │
│ カスタム期間:                                                │
│ 開始日: [2025-10-01]  終了日: [2025-10-21]                  │
│                                                              │
│                           [適用] [リセット]                  │
└─────────────────────────────────────────────────────────────┘
```

### Excelエクスポートボタン

```
┌─────────────────────────────────────────────────────────────┐
│ ヘッダー部分                                                 │
├─────────────────────────────────────────────────────────────┤
│ [CSVエクスポート] [PDFエクスポート] [📊 Excel詳細エクスポート] │
└─────────────────────────────────────────────────────────────┘
```

---

## テスト計画

### 単体テスト

#### ChartModal.tsx
- [ ] モーダル開閉動作
- [ ] ESCキーで閉じる
- [ ] オーバーレイクリックで閉じる
- [ ] ダウンロードボタン動作

#### DateRangeFilter.tsx
- [ ] プリセット期間選択
- [ ] カスタム期間入力
- [ ] 適用/リセット動作
- [ ] URLクエリパラメータ反映

#### ChartDownloadButton.tsx
- [ ] PNG形式ダウンロード
- [ ] SVG形式ダウンロード
- [ ] ファイル名正しい

#### ExcelExportButton.tsx
- [ ] Excelファイル生成
- [ ] 3シート作成（サマリー、詳細、月次）
- [ ] データ正確性
- [ ] 書式設定（太字、色、罫線）

---

### 統合テスト

- [ ] グラフ拡大→ダウンロード→閉じる一連の流れ
- [ ] 日付範囲フィルタ→グラフ更新→エクスポート
- [ ] 複数グラフの同時ダウンロード
- [ ] Excel・PDF・CSV同時エクスポート

---

### E2Eテスト（手動）

- [ ] Chrome最新版で動作確認
- [ ] Edge最新版で動作確認
- [ ] モーダル表示・閉じるアニメーション
- [ ] ダウンロードファイル確認（PNG/SVG/Excel）
- [ ] Excel各シート確認
- [ ] レスポンシブ対応確認

---

## スケジュール

### Day 1（10/21）

#### 午前（3時間）
- [x] Phase 5実装計画書作成（本ドキュメント）
- [ ] xlsx、file-saver依存関係追加
- [ ] ChartModal.tsx実装
- [ ] DateRangeFilter.tsx実装

#### 午後（3時間）
- [ ] ChartDownloadButton.tsx実装
- [ ] exportExcel.tsユーティリティ実装
- [ ] ExcelExportButton.tsx実装

---

### Day 2（10/22）

#### 午前（3時間）
- [ ] 各グラフコンポーネントに拡大ボタン追加
- [ ] メインページに日付範囲フィルタ追加
- [ ] メインページにExcelエクスポートボタン追加
- [ ] 単体テスト実施

#### 午後（3時間）
- [ ] 統合テスト実施
- [ ] E2Eテスト（手動）実施
- [ ] バグ修正
- [ ] AI_SUMMARY.md更新
- [ ] GitHubプッシュ（main、preview/feature-name）

---

## リスク管理

### 技術リスク

| リスク                     | 影響度 | 対策                                      |
|--------------------------|--------|------------------------------------------|
| SVG出力がRechartsで困難      | 中     | PNG形式のみ対応、SVG対応は将来フェーズに延期    |
| Excel生成でメモリ不足         | 低     | 大量データ時は分割エクスポート                 |
| モーダル表示でグラフが崩れる    | 中     | ResponsiveContainer使用、動的サイズ調整      |

### スケジュールリスク

| リスク                     | 影響度 | 対策                                      |
|--------------------------|--------|------------------------------------------|
| Excel実装が想定より複雑      | 中     | シンプル版で先行リリース、拡張は後日         |
| テストで多数のバグ発見       | 高     | 単体テスト段階で早期発見、修正時間確保       |

---

## 成功基準

### 機能要件
- [x] グラフ拡大モーダルが正常動作
- [x] 日付範囲フィルタが正常動作
- [x] PNG/SVGダウンロードが正常動作
- [x] Excel詳細エクスポートが正常動作

### 非機能要件
- [x] ページ読み込み速度: 3秒以内
- [x] Excel生成速度: 5秒以内（150件）
- [x] モーダル表示アニメーション: 滑らか（60fps）
- [x] レスポンシブ対応: モバイル・タブレット・デスクトップ

### ユーザビリティ
- [x] 直感的な操作（説明なしで使える）
- [x] エラーメッセージが分かりやすい
- [x] 進捗表示（エクスポート処理中）
- [x] キーボード操作対応（ESCキーでモーダル閉じる）

---

## 参考資料

- [xlsx (SheetJS) Documentation](https://docs.sheetjs.com/)
- [html2canvas Documentation](https://html2canvas.hertzen.com/)
- [Recharts Documentation](https://recharts.org/)
- [Tailwind CSS Modal Pattern](https://tailwindui.com/components/application-ui/overlays/modals)

---

**作成者**: Claude Code（AI Assistant）
**最終更新**: 2025年10月21日 00:45
**ステータス**: ✅ 計画完了、実装開始準備完了
