# Phase 6 判断履歴機能 実装計画書

**作成日**: 2025年10月20日
**作成者**: 医療職員カルテシステムチーム
**対象**: VoiceDrive期限到達判断履歴機能
**連携方式**: MCPサーバー経由
**バージョン**: 1.0

---

## 📋 エグゼクティブサマリー

VoiceDriveチームからの実装依頼書（`phase6-expired-escalation-implementation-request.md`）を受領し、医療職員カルテシステム側の実装計画を策定しました。

### 核心的な実装方針

1. **レポートセンター統合**: 判断履歴を独立カテゴリとして追加（11番目）
2. **権限レベル別表示**: LEVEL_1-18, 99に応じた適切なデータフィルタリング
3. **MCPサーバー経由連携**: VoiceDriveのデータを取得・表示
4. **既存インフラ活用**: ReportLayout、FacilitySelector等の既存コンポーネント活用

### 実装期間

**8営業日（約2週間）**

---

## 🎯 実装方針の決定

### ✅ Option A採用：独立カテゴリとして追加

VoiceDrive分析の直後（11番目）に「判断履歴」カテゴリを独立配置。

#### 採用理由

| 観点 | VoiceDrive分析 | 判断履歴 |
|------|--------------|---------|
| **主要ユーザー** | LEVEL_14-17（人事部・組織開発） | **LEVEL_5-13（主任〜院長）+ 人事部** |
| **使用頻度** | 月次・四半期 | **週次・日次（管理職）** |
| **機能性質** | 集団の傾向分析（LLM活用） | **個別提案の判断記録・管理職の評価材料** |

#### 配置位置

```typescript
// src/app/reports/page.tsx

const categories = [
  // ... 1-10番目の既存カテゴリ
  {
    id: 'voicedrive-analytics',        // 10番目
    label: 'VoiceDrive分析',
    // ...
  },
  {
    id: 'decision-history',             // 11番目（新規追加）✨
    label: '判断履歴',
    icon: '⚖️',
    description: '期限到達提案の判断履歴と統計を権限レベル別に表示',
    gradient: 'from-amber-500 to-orange-500',
    path: '/reports/decision-history',
    hasDetailPages: true
  },
  {
    id: 'performance-evaluation',       // 12番目（既存）
    label: '人事評価分析',
    // ...
  }
];
```

---

## 📊 実装内容

### 1. レポートセンター統合 ✅ **完了**

**実施内容**:
- [x] `src/app/reports/page.tsx`に「判断履歴」カテゴリ追加
- [x] アイコン: ⚖️
- [x] グラデーション: amber-500 → orange-500
- [x] パス: `/reports/decision-history`

**完了日**: 2025年10月20日

---

### 2. 基本ページ作成 ✅ **完了**

**実施内容**:
- [x] `src/app/reports/decision-history/page.tsx`作成
- [x] Phase 6実装準備中の案内表示
- [x] 権限レベル別機能案内（6カード）
- [x] 実装スケジュール表示

**完了日**: 2025年10月20日

---

### 3. 権限レベル別表示設計

#### 表示内容マトリックス

| 権限レベル | 表示範囲 | 対象ユーザー | 主要機能 |
|-----------|---------|-------------|---------|
| **LEVEL_1-4** | 自分の提案のみ | 一般職員 | 判断結果確認 |
| **LEVEL_5-6** | 自分が判断した案件 | 副主任・主任 | 判断履歴・チーム統計 |
| **LEVEL_7-8** | 所属部署全体 | 副師長・師長、副課長・課長 | 部署統計・管理職別判断傾向 |
| **LEVEL_9-13** | 所属施設全体 | 副部長〜院長 | 施設統計・部署別比較・管理職ランキング |
| **LEVEL_14-18** | 法人全体 | 人事部門、組織開発、理事長 | 法人統計・施設別比較・CSVエクスポート |
| **LEVEL_99** | 全データ | システム管理者 | 全データアクセス・監査ログ |

#### データフィルタリングロジック

```typescript
// 権限レベル別のWHERE句生成

function buildWhereClause(userId: string, permissionLevel: number, facilityId?: string, departmentId?: string) {
  // LEVEL_1-4: 自分の提案のみ
  if (permissionLevel >= 1 && permissionLevel <= 4) {
    return `WHERE proposer_id = '${userId}'`;
  }

  // LEVEL_5-6: 自分が判断した案件のみ
  if (permissionLevel >= 5 && permissionLevel <= 6) {
    return `WHERE decider_id = '${userId}'`;
  }

  // LEVEL_7-8: 所属部署のみ
  if (permissionLevel >= 7 && permissionLevel <= 8) {
    if (!departmentId) throw new Error('departmentId required');
    return `WHERE department_id = '${departmentId}'`;
  }

  // LEVEL_9-13: 所属施設のみ
  if (permissionLevel >= 9 && permissionLevel <= 13) {
    if (!facilityId) throw new Error('facilityId required');
    return `WHERE facility_id = '${facilityId}'`;
  }

  // LEVEL_14-18: 法人全体（施設フィルタなし）
  if (permissionLevel >= 14 && permissionLevel <= 18) {
    return '';  // フィルタなし
  }

  // LEVEL_99: システム管理者（全データ）
  if (permissionLevel === 99) {
    return '';  // フィルタなし
  }

  throw new Error(`Invalid permissionLevel: ${permissionLevel}`);
}
```

---

## 🔌 API仕様

### エンドポイント

```
GET /api/mcp/expired-escalation-history
```

### リクエストパラメータ

```typescript
interface ExpiredEscalationHistoryRequest {
  userId: string;              // リクエストユーザーID
  permissionLevel: number;     // ユーザーの権限レベル（1-18, 99）
  facilityId?: string;         // 施設ID（LEVEL_9-13の場合）
  departmentId?: string;       // 部署ID（LEVEL_7-8の場合）
  startDate?: string;          // 集計開始日（YYYY-MM-DD）デフォルト: 30日前
  endDate?: string;            // 集計終了日（YYYY-MM-DD）デフォルト: 本日
  limit?: number;              // 取得件数上限（デフォルト: 100）
  offset?: number;             // オフセット（ページネーション用）
}
```

### レスポンス形式

```typescript
interface ExpiredEscalationHistoryResponse {
  success: boolean;
  data: {
    period: {
      startDate: string;       // 集計期間開始日
      endDate: string;         // 集計期間終了日
    };
    summary: {
      totalCount: number;                  // 総判断件数
      approvedCount: number;               // 承認件数
      downgradedCount: number;             // ダウングレード件数
      rejectedCount: number;               // 不採用件数
      approvalRate: number;                // 承認率（%）
      averageDaysToDecision: number;       // 平均判断日数
      averageAchievementRate: number;      // 平均到達率（%）
    };
    items: ExpiredEscalationHistoryItem[];
    pagination: {
      total: number;           // 総件数
      limit: number;           // ページサイズ
      offset: number;          // 現在のオフセット
      hasMore: boolean;        // 次ページの有無
    };
  };
  error?: {
    code: string;
    message: string;
  };
}

interface ExpiredEscalationHistoryItem {
  id: string;                              // 判断履歴ID
  postId: string;                          // 投稿ID
  postContent: string;                     // 投稿内容（要約）
  proposalType: string;                    // 提案タイプ
  agendaLevel: string;                     // 議題レベル
  currentScore: number;                    // 期限到達時のスコア
  targetScore: number;                     // 目標スコア
  achievementRate: number;                 // 到達率（%）
  daysOverdue: number;                     // 期限超過日数
  decision: 'approve_at_current_level' | 'downgrade' | 'reject';  // 判断結果
  deciderId: string;                       // 判断者ID
  deciderName: string;                     // 判断者名
  deciderLevel: number;                    // 判断者権限レベル
  decisionReason: string;                  // 判断理由
  decisionAt: string;                      // 判断日時（ISO 8601）
  department: string;                      // 所属部署名
  facilityId: string;                      // 施設ID
  createdAt: string;                       // 作成日時（ISO 8601）
}
```

### エラーレスポンス

```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;              // エラーコード
    message: string;           // エラーメッセージ
    details?: any;             // 詳細情報（任意）
  };
}
```

#### エラーコード一覧

| コード | 説明 |
|-------|------|
| `UNAUTHORIZED` | 認証エラー |
| `FORBIDDEN` | 権限不足 |
| `INVALID_PARAMETERS` | パラメータ不正 |
| `NOT_FOUND` | データが見つからない |
| `INTERNAL_ERROR` | サーバーエラー |

---

## 📁 ファイル構成

```
src/
├── app/
│   └── reports/
│       ├── page.tsx                                 ✅ 完了（カテゴリ追加）
│       └── decision-history/
│           ├── page.tsx                             ✅ 完了（基本構造）
│           ├── components/
│           │   ├── DecisionSummaryCards.tsx         ⏳ Phase 3
│           │   ├── DecisionHistoryTable.tsx         ⏳ Phase 3
│           │   ├── DecisionFilters.tsx              ⏳ Phase 3
│           │   └── ManagerRanking.tsx               ⏳ Phase 3
│           └── hooks/
│               └── useDecisionHistory.ts             ⏳ Phase 2
│
├── lib/
│   └── api/
│       └── decisionHistory.ts                       ⏳ Phase 2
│
└── types/
    └── decisionHistory.ts                           ⏳ Phase 2
```

---

## 🚀 実装スケジュール

### Phase 1: 基本実装（3日）✅ **2日完了**

**予定**: 2025年10月21日（月）〜 10月23日（水）

| タスク | 工数 | 状態 | 完了日 |
|--------|------|------|--------|
| レポートセンターにカテゴリ追加 | 0.5日 | ✅ 完了 | 10/20 |
| 基本ページ作成 | 1日 | ✅ 完了 | 10/20 |
| 権限チェックロジック実装 | 1.5日 | ⏳ 保留 | - |

**成果物**:
- [x] `src/app/reports/page.tsx` - カテゴリ追加
- [x] `src/app/reports/decision-history/page.tsx` - 基本ページ
- [ ] `src/lib/permissions/decisionHistoryPermissions.ts` - 権限チェック

---

### Phase 2: API統合（2日）

**予定**: 2025年10月24日（木）〜 10月25日（金）

| タスク | 工数 | 状態 |
|--------|------|------|
| 型定義作成 | 0.5日 | ⏳ 未着手 |
| MCPサーバー経由データ取得実装 | 1日 | ⏳ 未着手 |
| 権限レベル別フィルタリング実装 | 0.5日 | ⏳ 未着手 |

**成果物**:
- [ ] `src/types/decisionHistory.ts` - TypeScript型定義
- [ ] `src/lib/api/decisionHistory.ts` - API呼び出しロジック
- [ ] `src/app/reports/decision-history/hooks/useDecisionHistory.ts` - カスタムフック

**実装例**:

```typescript
// src/lib/api/decisionHistory.ts

export async function fetchDecisionHistory(
  params: ExpiredEscalationHistoryRequest
): Promise<ExpiredEscalationHistoryResponse> {
  try {
    const queryParams = new URLSearchParams({
      userId: params.userId,
      permissionLevel: params.permissionLevel.toString(),
      ...(params.facilityId && { facilityId: params.facilityId }),
      ...(params.departmentId && { departmentId: params.departmentId }),
      ...(params.startDate && { startDate: params.startDate }),
      ...(params.endDate && { endDate: params.endDate }),
      ...(params.limit && { limit: params.limit.toString() }),
      ...(params.offset && { offset: params.offset.toString() }),
    });

    const response = await fetch(`/api/mcp/expired-escalation-history?${queryParams}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getAuthToken()}`,
      },
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || 'Failed to fetch decision history');
    }

    return await response.json();
  } catch (error) {
    console.error('Error fetching decision history:', error);
    throw error;
  }
}
```

---

### Phase 3: UI完成（2日）

**予定**: 2025年10月28日（月）〜 10月29日（火）

| タスク | 工数 | 状態 |
|--------|------|------|
| サマリー統計カード実装 | 0.5日 | ⏳ 未着手 |
| 判断履歴テーブル実装 | 1日 | ⏳ 未着手 |
| フィルタUI実装 | 0.5日 | ⏳ 未着手 |

**成果物**:
- [ ] `DecisionSummaryCards.tsx` - サマリー統計カード
- [ ] `DecisionHistoryTable.tsx` - 判断履歴テーブル
- [ ] `DecisionFilters.tsx` - フィルタUI

**UI構成**:

```
┌─────────────────────────────────────────────┐
│ ヘッダー（⚖️ 判断履歴）              [×]   │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📊 サマリー統計（4カード）                   │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐         │
│ │総件数│ │承認率│ │平均 │ │平均 │         │
│ │ 342 │ │ 78% │ │ 3.2 │ │ 65% │         │
│ │     │ │     │ │日数 │ │到達率│         │
│ └─────┘ └─────┘ └─────┘ └─────┘         │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 🔍 フィルタ                                  │
│ [期間選択] [施設] [部署] [判断結果]          │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📋 判断履歴一覧（テーブル）                  │
│ ┌───┬─────┬────┬────┬────┬────┐      │
│ │ID │提案内容│スコア│判断 │判断者│日時│      │
│ ├───┼─────┼────┼────┼────┼────┤      │
│ │001│〇〇案│85/100│承認 │田中 │10/1│      │
│ │002│△△案│45/100│D/G  │佐藤 │10/2│      │
│ └───┴─────┴────┴────┴────┴────┘      │
│ [前へ] [1] [2] [3] [次へ]                   │
└─────────────────────────────────────────────┘

[PDF出力]
```

---

### Phase 4: PDF出力（1日）

**予定**: 2025年10月30日（水）

| タスク | 工数 | 状態 |
|--------|------|------|
| PDF生成機能実装 | 0.5日 | ⏳ 未着手 |
| レイアウト調整 | 0.5日 | ⏳ 未着手 |

**成果物**:
- [ ] PDF生成機能（jsPDF または react-pdf活用）
- [ ] PDF用レイアウトCSS

---

## 📊 進捗状況

### 全体進捗

```
Phase 1: ████████░░ 80% (3日中2.4日完了)
Phase 2: ░░░░░░░░░░  0% (2日)
Phase 3: ░░░░░░░░░░  0% (2日)
Phase 4: ░░░░░░░░░░  0% (1日)

全体進捗: ███░░░░░░░ 30% (8日中2.4日完了)
```

### マイルストーン

| マイルストーン | 予定日 | 状態 |
|--------------|--------|------|
| Phase 1完了 | 10/23（水） | ⏳ 80%完了 |
| Phase 2完了 | 10/25（金） | ⏳ 未着手 |
| Phase 3完了 | 10/29（火） | ⏳ 未着手 |
| Phase 4完了 | 10/30（水） | ⏳ 未着手 |
| **本番リリース** | **11/1（金）** | ⏳ 予定 |

---

## 🔐 セキュリティ要件

### 1. 権限チェックの徹底

```typescript
// ページレベルでの権限チェック

export default function DecisionHistoryPage() {
  const { user } = useAuth();

  // LEVEL_1-4は最小限の情報のみ
  if (user.permissionLevel >= 1 && user.permissionLevel <= 4) {
    return <PersonalProposalHistory userId={user.id} />;
  }

  // LEVEL_5以上は通常表示
  return <DecisionHistoryReportPage user={user} />;
}
```

### 2. データフィルタリングの厳密化

- APIリクエスト時に権限レベルを必ず送信
- サーバー側でも権限チェックを実施（二重チェック）
- 不正なパラメータ（他人のuserIdなど）を拒否

### 3. 個人情報保護

| データ項目 | 保護方法 |
|-----------|---------|
| 判断者名 | 職位名のみ表示（フルネームは不要） |
| 投稿内容 | 要約版（100文字以内） |
| 機密情報を含む判断理由 | 権限に応じてマスキング |

---

## 🧪 テストケース

### 1. 権限レベル別フィルタリングテスト

```typescript
describe('DecisionHistory - Permission Filtering', () => {
  test('LEVEL_5: 自分が判断した案件のみ表示', async () => {
    const params = {
      userId: 'U123',
      permissionLevel: 5,
    };

    const result = await fetchDecisionHistory(params);

    expect(result.data.items).toHaveLength(greaterThan(0));
    result.data.items.forEach(item => {
      expect(item.deciderId).toBe('U123');
    });
  });

  test('LEVEL_7: 部署全体の履歴表示', async () => {
    const params = {
      userId: 'U456',
      permissionLevel: 7,
      departmentId: 'D789',
    };

    const result = await fetchDecisionHistory(params);

    expect(result.data.items).toHaveLength(greaterThan(0));
    result.data.items.forEach(item => {
      expect(item.departmentId).toBe('D789');
    });
  });

  test('LEVEL_14: 法人全体の履歴表示', async () => {
    const params = {
      userId: 'U789',
      permissionLevel: 14,
    };

    const result = await fetchDecisionHistory(params);

    expect(result.data.items).toHaveLength(greaterThan(0));
    // 施設フィルタなし、全施設のデータを含む
  });
});
```

### 2. 日付範囲フィルタテスト

```typescript
test('日付範囲フィルタ: 2025年7月のみ', async () => {
  const params = {
    userId: 'U789',
    permissionLevel: 14,
    startDate: '2025-07-01',
    endDate: '2025-07-31',
  };

  const result = await fetchDecisionHistory(params);

  result.data.items.forEach(item => {
    const decisionDate = new Date(item.decisionAt);
    expect(decisionDate >= new Date('2025-07-01')).toBe(true);
    expect(decisionDate <= new Date('2025-07-31')).toBe(true);
  });
});
```

### 3. ページネーションテスト

```typescript
test('ページネーション: 2ページ目取得', async () => {
  const params = {
    userId: 'U999',
    permissionLevel: 16,
    limit: 100,
    offset: 100,
  };

  const result = await fetchDecisionHistory(params);

  expect(result.data.pagination.offset).toBe(100);
  expect(result.data.pagination.limit).toBe(100);
  expect(result.data.items.length).toBeLessThanOrEqual(100);
});
```

### 4. エラーハンドリングテスト

```typescript
test('権限不足エラー: LEVEL_3がLEVEL_7の機能を使用', async () => {
  const params = {
    userId: 'U111',
    permissionLevel: 3,
  };

  await expect(fetchDecisionHistory(params)).rejects.toThrow('FORBIDDEN');
});
```

---

## ⚠️ 前提条件とリスク

### 前提条件

1. **VoiceDrive側のデータ準備**
   - `expired_escalation_decisions`テーブル存在
   - MCPサーバー経由API実装完了
   - テストデータ準備

2. **医療システム側の既存機能**
   - 権限管理システム（LEVEL_1-18, 99）実装済み
   - 施設別・部署別フィルタリング基盤実装済み
   - ReportLayout、FacilitySelectorコンポーネント実装済み

### リスク分析

| リスク | 影響度 | 発生確率 | 対策 |
|-------|--------|---------|------|
| VoiceDrive側API未実装 | 高 | 中 | モックデータで先行実装 |
| 権限レベル定義の不一致 | 中 | 低 | VoiceDriveチームと事前調整 |
| パフォーマンス問題（大量データ） | 中 | 中 | ページネーション、インデックス最適化 |
| セキュリティ懸念（権限チェック漏れ） | 高 | 低 | 二重チェック、テスト徹底 |

---

## 📞 連絡体制

### VoiceDriveチームへの確認事項

1. **データ準備状況**
   - `expired_escalation_decisions`テーブル実装状況
   - テストデータ準備状況
   - MCPサーバーAPI実装スケジュール

2. **API仕様確認**
   - レスポンス形式の最終確認
   - エラーコードの統一
   - レート制限設定

3. **テスト環境**
   - 統合テスト環境の提供スケジュール
   - テストデータのサンプル提供

### 連絡先

**VoiceDriveチーム**:
- Slack: `#phase6-integration`
- 技術担当: プロジェクトリード

**医療職員カルテシステムチーム**:
- Slack: `#medical-system-api`
- API担当: 開発リード

---

## 🎯 次のアクション

### 医療システムチーム（本チーム）

#### 即座に実施可能

- [x] ✅ レポートセンターにカテゴリ追加（完了）
- [x] ✅ 基本ページ作成（完了）
- [ ] VoiceDriveチームへ実装計画書共有

#### VoiceDrive側の準備完了後

- [ ] Phase 1残タスク: 権限チェックロジック実装（1.5日）
- [ ] Phase 2: API統合（2日）
- [ ] Phase 3: UI完成（2日）
- [ ] Phase 4: PDF出力（1日）

### VoiceDriveチーム

- [ ] 実装計画書レビュー・承認
- [ ] API仕様の最終確認
- [ ] `expired_escalation_decisions`テーブル実装
- [ ] MCPサーバーAPI実装
- [ ] テストデータ準備
- [ ] 統合テスト環境提供

---

## 📝 更新履歴

| 日付 | バージョン | 更新内容 | 担当者 |
|------|-----------|---------|--------|
| 2025-10-20 | 1.0 | 初版作成 | 医療システムチーム |

---

## 📎 関連ドキュメント

### VoiceDrive側ドキュメント

1. **Phase 6実装依頼書**
   - `phase6-expired-escalation-implementation-request.md`
   - VoiceDriveチームからの実装依頼

2. **Phase 6設計書**
   - `phase6-expired-escalation-workflow.md`
   - 期限到達エスカレーションワークフロー

3. **権限レベル定義**
   - `expired-escalation-report-access-levels.md`
   - 権限レベル別アクセス制御

### 医療システム側ドキュメント

1. **Phase 3完了報告書**
   - `docs/Phase3_実装作業完了報告書_FINAL.md`
   - 施設別権限レベル管理システム実装完了

2. **共通DB構築後作業再開指示書**
   - `docs/共通DB構築後_作業再開指示書_20250928.md`
   - 統合テスト計画、API Key設定

3. **OrganizationAnalytics API実装完了報告**
   - `mcp-shared/docs/organization-analytics_API実装完了報告_20251010.md`
   - MCPサーバー経由API実装事例

---

**最終更新**: 2025年10月20日
**バージョン**: 1.0
**ステータス**: VoiceDriveチームレビュー待ち
**次回アクション**: VoiceDriveチームへ共有、フィードバック受領

---

## 🎉 まとめ

### 実装完了済み

1. ✅ レポートセンターに「判断履歴」カテゴリ追加（11番目）
2. ✅ 基本ページ作成（Phase 6実装準備中案内）
3. ✅ 実装計画書作成

### 実装待機中（VoiceDrive側準備完了後）

- Phase 1残タスク（1.5日）
- Phase 2: API統合（2日）
- Phase 3: UI完成（2日）
- Phase 4: PDF出力（1日）

**合計残工数**: 5.5日（約1.5週間）

### 本番リリース目標

**2025年11月1日（金）**

VoiceDriveチームのフィードバックをお待ちしています！
