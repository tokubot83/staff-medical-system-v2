# 仕様調整ミーティング議事録

**日時**: 2025年10月9日（水） 14:00-15:00 JST
**場所**: Zoom
**議題**: VoiceDriveボイス分析機能 統合テスト準備

---

## 参加者

### VoiceDrive開発チーム
- VoiceDriveプロジェクトリード
- バックエンド開発担当
- フロントエンド開発担当

### 職員カルテシステム開発チーム
- 職員カルテプロジェクトリード
- バックエンド開発担当（Analytics API連携担当）
- ローカルLLM開発担当

---

## 1. 確認事項の最終確認

### 1.1 実装完了報告の確認

**VoiceDrive側**:
- ✅ 集計APIエンドポイント実装完了
- ✅ データ受信APIエンドポイント実装完了
- ✅ IPホワイトリスト実装完了
- ✅ 監査ログ + 異常検知実装完了
- ✅ 過去6ヶ月制限、3ヶ月/回制限実装完了

**職員カルテ側**:
- ✅ すべての回答書作成完了
- ✅ API仕様、セキュリティ、スケジュールに合意

**結論**: 両チームの実装・準備が完璧に整っていることを確認

---

## 2. API仕様の詳細確認

### 2.1 エンドポイント仕様の最終確認

**GET /api/v1/analytics/aggregated-stats**:
- ✅ バリデーション: startDate, endDate必須、過去6ヶ月、最大90日
- ✅ レート制限: 100リクエスト/時間
- ✅ 認証: JWT + IPホワイトリスト

**POST /api/v1/analytics/group-data**:
- ✅ sentimentAnalysis, topicAnalysisはオプショナル
- ✅ レート制限: 10リクエスト/時間
- ✅ HMAC署名検証: オプション（開発環境では無効化可能）

**結論**: API仕様は完全に合意済み、変更なし

### 2.2 エラーレスポンスの確認

VoiceDrive側が実装したエラーレスポンス（DATE_TOO_OLD, DATE_RANGE_TOO_LONG等）を確認し、職員カルテ側で適切にハンドリングすることを確認。

---

## 3. 実装スケジュールの調整

### 3.1 統合テスト期間の確定

```
11月上旬〜中旬（4週間）: 統合テスト期間
├─ Week 1（11/4-11/10）: 基本統計API実装
├─ Week 2（11/11-11/17）: ローカルLLM分析実装
├─ Week 3（11/18-11/24）: 日次バッチ送信実装
└─ Week 4（11/25-12/1）: 統合テスト実施

12/2-12/4: テストデータ送信（3日間）
12/5（木）02:00: 初回本番データ送信
12/5（木）09:00: 両チーム合同結果確認ミーティング
```

**合意**: 上記スケジュールで進行

### 3.2 段階的な統合テストの提案（職員カルテ側）

**背景**: ローカルLLM環境の構築に時間がかかる可能性

**提案**:
```
Phase 1（11/4-11/17）: 基本統計のみ
  - sentimentAnalysis, topicAnalysisはundefinedで送信
  - VoiceDrive側で正常に受信できることを確認

Phase 2（11/18-12/1）: LLM分析を追加
  - 完全なデータで再テスト
  - 感情分析精度90-95%の達成を確認
```

**VoiceDrive側の回答**: ✅ 了承。段階的なテストで問題なし。

---

## 4. セキュリティ・認証の確認

### 4.1 認証情報の交換

#### JWT認証トークン

**VoiceDrive側から提供**:
```
開発/テスト環境用:
JWT_TOKEN=vd_test_20251009_xxxxxxxxxxxxx
有効期限: 2026年12月31日

ステージング環境用:
JWT_TOKEN=（11月中旬に提供）

本番環境用:
JWT_TOKEN=（12月上旬に提供）
```

#### HMAC共有シークレット

**両チーム合意**:
```
開発/テスト環境用:
HMAC_SECRET=test_voicedrive_analytics_secret_2025

ステージング環境用:
HMAC_SECRET=（11月中旬に1Passwordで共有）

本番環境用:
HMAC_SECRET=（12月上旬に1Passwordで共有）
```

**交換方法**: 1Password共有Vault（セキュア）

#### APIエンドポイントURL

**VoiceDrive側**:
```
開発環境: http://localhost:4000
ステージング: https://staging.voicedrive.ohara-hospital.jp
本番環境: https://voicedrive.ohara-hospital.jp
```

### 4.2 IPホワイトリスト設定

#### Phase 1: 開発環境（10/10〜）

**職員カルテ側から提供**:
```
IP: 127.0.0.1, ::1
Domain: http://localhost:3002
```

**VoiceDrive側の対応**: ✅ 環境変数に設定済み

#### Phase 2: ステージング環境（11月中旬〜）

**職員カルテ側から提供**:
```
IP: 確定次第通知（11月中旬予定）
Domain: 確定次第通知（11月中旬予定）
```

**VoiceDrive側の対応**: 通知後、即座に設定

#### Phase 3: 本番環境（12月上旬）

**職員カルテ側から提供**:
```
IP: 確定次第通知（12月上旬予定）
Domain: 確定次第通知（12月上旬予定）
```

**VoiceDrive側の対応**: 通知後、即座に設定

### 4.3 CORS設定

**VoiceDrive側のCORS設定に追加**:
```javascript
origin: [
  // 既存
  'http://localhost:3000',
  'http://localhost:3001',
  'https://voicedrive.ohara-hospital.jp',
  'https://staging.voicedrive.ohara-hospital.jp',

  // 追加（職員カルテシステム）
  'http://localhost:3002',  // 開発環境（即座に追加）
  // ステージング・本番は確定次第追加
]
```

**VoiceDrive側の対応**: ✅ 設定完了

---

## 5. 統合テスト環境の詳細確認

### 5.1 VoiceDriveステージング環境

**URL**: https://staging.voicedrive.ohara-hospital.jp
**API Base**: https://staging.voicedrive.ohara-hospital.jp/api/v1/analytics

**環境構成**:
- AWS Lightsail
- PostgreSQL 14
- Node.js 20
- IPホワイトリスト設定済み（開発環境のみ）

**アクセス方法**: 職員カルテ側から直接HTTPSリクエスト

### 5.2 テストデータの準備

**VoiceDrive側**:
- ✅ 10月分の投稿データあり（稼働開始月）
- ✅ 11月分のデータは随時蓄積中
- ✅ テスト用ダミーデータは不要（実データで検証）

**職員カルテ側**:
- 実データを取得して分析
- K-匿名性チェック（K≥5）を実施

### 5.3 監査ログの確認方法

**VoiceDrive側**:
- 監査ログはPostgreSQLのAuditLogテーブルに記録
- 職員カルテ側からの直接アクセスは不可
- 必要に応じてVoiceDrive側で確認・共有

**確認方法**:
```sql
-- VoiceDrive側で実行
SELECT * FROM AuditLog
WHERE action LIKE 'ANALYTICS_%'
ORDER BY createdAt DESC
LIMIT 100;
```

**Slack共有**: エラー発生時はログをSlackで共有

---

## 6. 初回データ送信の検証計画

### 6.1 テストデータ送信（12/2-12/4）

#### 12/2（月）02:00 - 第1回テスト

**送信内容**:
- 期間: 2025年11月1日〜11月7日（1週間分）
- 基本統計のみ（LLM分析なし）

**確認項目**:
- ✅ VoiceDrive集計API接続成功
- ✅ K-匿名性チェック通過
- ✅ VoiceDrive受信API送信成功（200 OK）
- ✅ 監査ログ記録確認

**エラー時の対応**: Slack `#voicedrive-analytics-integration` で即座に連絡

#### 12/3（火）02:00 - 第2回テスト

**送信内容**:
- 期間: 2025年11月8日〜11月14日（1週間分）
- 基本統計 + 感情分析（LLM分析あり）

**確認項目**:
- ✅ ローカルLLM分析完了
- ✅ sentimentAnalysisを含むデータ送信成功
- ✅ VoiceDrive側で感情分析データを正常受信

#### 12/4（水）02:00 - 第3回テスト

**送信内容**:
- 期間: 2025年11月15日〜11月21日（1週間分）
- 完全データ（基本統計 + 感情分析 + トピック分析）

**確認項目**:
- ✅ topicAnalysisを含むデータ送信成功
- ✅ レート制限動作確認
- ✅ 完全なデータフローの動作確認

### 6.2 エラー発生時の連絡フロー

```
エラー検知
  ↓ 即座
Slack通知（#voicedrive-analytics-integration）
  ↓ 5分以内
担当者確認・ログ収集
  ↓ 15分以内
原因分析・対応方針決定
  ↓ 30分以内
修正・リトライ実行
```

**エスカレーション**:
- 30分経過: プロジェクトリードに連絡
- 1時間経過: 両チーム緊急ミーティング

### 6.3 成功確認の基準

**最低限の成功基準**:
1. ✅ VoiceDrive集計API呼び出し成功（200 OK）
2. ✅ VoiceDrive受信API送信成功（200 OK）
3. ✅ 監査ログに正常記録
4. ✅ エラー発生なし（または軽微なエラーのみ）

**理想的な成功基準**:
1. ✅ 上記 + K-匿名性チェック通過
2. ✅ LLM分析完了（感情分析精度90%以上）
3. ✅ トピック分析完了（TOP 20キーワード抽出）
4. ✅ 処理時間30分以内

---

## 7. 本番リリース時の手順確認

### 7.1 12/5（木）02:00 初回本番データ送信

**待機体制**:
```
01:50 - 両チームSlack待機開始（#voicedrive-analytics-integration）
02:00 - バッチ処理開始（職員カルテ側）
02:05 - VoiceDrive同意データ取得完了確認
02:10 - VoiceDrive集計API呼び出し完了確認
02:25 - ローカルLLM分析完了確認
02:30 - VoiceDrive受信API送信完了確認
02:35 - 監査ログ確認（VoiceDrive側）
02:40 - 成功確認・Slack報告
```

**送信内容**:
- 期間: 2025年11月1日〜11月30日（1ヶ月分）
- 完全データ（基本統計 + 感情分析 + トピック分析）

### 7.2 09:00 両チーム合同結果確認ミーティング

**確認項目**:
- 処理時間の確認（目標: 30分以内）
- データの正確性確認
- エラーの有無確認
- 監査ログの確認
- K-匿名性チェック結果の確認

**成功時**: 日次運用開始（翌日から毎日深夜2:00自動実行）

**問題発生時**: 原因分析、修正、再テスト日程調整

---

## 8. 開発環境の異常検知設定の調整

### 8.1 職員カルテ側からの懸念

**背景**: 開発中は頻繁にテストリクエストを送信する可能性がある

**懸念**: 異常検知（200リクエスト/時間）に引っかかる可能性

### 8.2 VoiceDrive側の対応

**開発環境（〜11月末）**:
```
異常検知の閾値を緩和:
- 警告: 500リクエスト/時間（通常: 200）
- 自動ブロック: 1000リクエスト/時間（通常: 400）
- 管理者通知: 無効化（ログのみ記録）
```

**ステージング環境（11月中旬〜12月上旬）**:
```
通常の閾値:
- 警告: 200リクエスト/時間
- 自動ブロック: 400リクエスト/時間
- 管理者通知: Slack通知（#voicedrive-dev）
```

**本番環境（12月5日〜）**:
```
厳格な閾値:
- 警告: 200リクエスト/時間
- 自動ブロック: 400リクエスト/時間
- 管理者通知: Slack通知 + メール通知
```

**合意**: ✅ 上記の段階的な設定で進行

---

## 9. 過去データの取得範囲の確認

### 9.1 職員カルテ側からの質問

**Q**: VoiceDriveは10月から稼働開始。12/5の初回本番データ送信時、10月分のデータも取得できますか？

### 9.2 VoiceDrive側の回答

**A**: ✅ 10月分も取得可能

**データ状況**:
- 10月分: 約250投稿（VoiceDrive稼働開始月）
- 11月分: 約350投稿（見込み）
- 合計: 約600投稿

**初回データ送信の範囲**:
```
期間: 2025年10月1日〜2025年11月30日（2ヶ月分）
方法: 2回のAPIリクエスト
  1. GET /api/v1/analytics/aggregated-stats?startDate=2025-10-01&endDate=2025-10-31
  2. GET /api/v1/analytics/aggregated-stats?startDate=2025-11-01&endDate=2025-11-30
```

**合意**: ✅ 初回は10月+11月の2ヶ月分を送信

---

## 10. 連絡体制の最終確認

### 10.1 通常連絡

**Slack**: `#voicedrive-analytics-integration`（新規チャンネル作成）
- 作成日: 2025年10月9日
- メンバー: 両チームの開発担当者全員

**Email**:
- VoiceDrive側: voicedrive-dev@example.com
- 職員カルテ側: staff-card-dev@example.com

**MCPサーバー**: `mcp-shared/docs/`
- 議事録、報告書、仕様書の共有

### 10.2 緊急連絡（本番障害時）

**VoiceDrive側**:
- 緊急連絡先: VoiceDriveプロジェクトリード（電話番号）
- 対応時間: 24時間365日（12/5本番リリース後）
- SLA: 重大障害30分以内、その他2時間以内

**職員カルテシステム側**:
- 緊急連絡先: 職員カルテプロジェクトリード（電話番号）
- 対応時間: 24時間365日（12/5本番リリース後）
- SLA: 重大障害30分以内、その他2時間以内

**エスカレーションフロー**:
```
Level 1: バッチ処理エラー（リトライ実行、最大3回）
  ↓ 3回失敗
Level 2: Slack通知 + 開発チーム対応
  ↓ 1時間経過
Level 3: 電話連絡 + プロジェクトリード対応
  ↓ 2時間経過
Level 4: 両チーム合同緊急ミーティング
```

---

## 11. 今後のアクション

### 11.1 短期（10/10-10/15）

#### VoiceDrive側
- [x] 開発環境の異常検知設定を緩和
- [x] CORS設定に`http://localhost:3002`を追加
- [x] Slackチャンネル`#voicedrive-analytics-integration`を作成
- [ ] 1Passwordで認証情報を共有

#### 職員カルテシステム側
- [ ] 認証情報を設定（.env.voicedrive.test）
- [ ] VoiceDriveAnalyticsClient実装開始
- [ ] 開発環境での接続テスト

### 11.2 中期（10/16-11/3）

#### VoiceDrive側
- [ ] ステージング環境の構築完了
- [ ] テストデータの確認（10月分、11月分）

#### 職員カルテシステム側
- [ ] VoiceDriveAnalyticsClient実装完了
- [ ] 統合テストスクリプト作成
- [ ] ローカルLLM環境構築開始

### 11.3 長期（11月〜12月）

#### 両チーム合同
- [ ] 11/4-12/1: 統合テスト実施（4週間）
- [ ] 12/2-12/4: テストデータ送信（3日間）
- [ ] 12/5 02:00: 初回本番データ送信
- [ ] 12/5 09:00: 両チーム合同結果確認ミーティング

---

## 12. 決定事項サマリー

| 項目 | 決定内容 |
|------|---------|
| **統合テスト開始** | 2025年11月4日 |
| **段階的テスト** | Phase 1: 基本統計のみ、Phase 2: LLM分析追加 |
| **JWT認証トークン** | 開発/テスト用を即座に提供 |
| **HMAC共有シークレット** | 開発/テスト用を合意、本番用は12月上旬 |
| **IPホワイトリスト** | Phase 1: 127.0.0.1, ::1（開発環境） |
| **CORS設定** | `http://localhost:3002`を追加 |
| **異常検知閾値** | 開発環境: 500/1000、本番: 200/400 |
| **過去データ範囲** | 初回は10月+11月の2ヶ月分 |
| **テストデータ送信** | 12/2-12/4（3日間） |
| **本番リリース** | 12/5（木）02:00 |
| **連絡体制** | Slackチャンネル`#voicedrive-analytics-integration` |

---

## 13. 次回ミーティング

**予定**: 11月25日（月） 14:00-15:00 JST
**議題**: 統合テスト結果の確認、本番リリース準備

---

**議事録作成**: 職員カルテシステム開発チーム
**承認**: VoiceDrive開発チーム、職員カルテシステム開発チーム
**作成日**: 2025年10月9日
