# Phase 5-3 完了報告書への返信

**作成日時**: 2025年10月1日
**作成者**: 医療職員管理システム開発チーム
**宛先**: VoiceDriveシステム開発チーム
**件名**: Phase 5-3「キャリア選択ステーション」実装完了のご報告を受領しました

---

## 🎉 Phase 5-3 実装完了、おめでとうございます！

VoiceDriveチームの皆様

Phase 5-3「キャリア選択ステーション」の実装完了報告書を拝受いたしました。
**わずか1日での素早い実装、誠にありがとうございます！**

マイキャリア情報画面の実装、型定義の作成、サイドバー統合、ルーティング設定など、すべての項目が完璧に仕上がっており、大変感謝しております。

本返信書では、貴チームからいただいた確認事項への回答、医療システム側の準備状況、今後の連携方針についてお伝えいたします。

---

## ✅ 医療システム側の実装完了報告

VoiceDriveチームの迅速な対応を受け、医療システム側でも以下を実装いたしました：

### 1. Webhook通知エンドポイントの実装

**ファイル**: `src/app/api/career-course/notify-voicedrive/route.ts`

**機能**:
- 人事部が申請を承認/却下した際、VoiceDrive側に自動通知
- リトライ機構搭載（最大3回、指数バックオフ）
- 内部API認証によるセキュリティ確保

**Webhook送信仕様**:
```typescript
// 承認時
{
  type: 'course_change_approved',
  staffId: 'OH-NS-2021-001',
  requestId: 'req-003',
  approvedCourse: 'A',
  effectiveDate: '2026-04-01',
  reviewComment: '管理職候補として適性を認めます。'
}

// 却下時
{
  type: 'course_change_rejected',
  staffId: 'OH-NS-2021-001',
  requestId: 'req-003',
  rejectionReason: '現在の勤務状況から、来年度の変更が望ましいと判断しました。',
  reviewComment: '再度、2027年4月での変更申請をご検討ください。'
}
```

### 2. API仕様書の作成

**ファイル**: `docs/Phase5_API仕様書_VoiceDrive連携.md`

**内容**:
- 全4エンドポイントの詳細仕様
- 認証方式の説明
- エラーレスポンス形式
- TypeScript型定義
- 環境変数設定ガイド
- Webhook通知仕様

この仕様書を本返信書に添付しておりますので、ぜひご確認ください。

---

## 📝 確認事項への回答

### 質問1: 認証方式

**✅ 回答**:

**VoiceDrive → 医療システム**:
- VoiceDriveの既存JWT認証をそのまま使用してください
- リクエストヘッダー: `Authorization: Bearer <VoiceDrive_JWT_Token>`
- 医療システム側でトークンを検証します

**医療システム → VoiceDrive (Webhook)**:
- API Key認証を使用します
- リクエストヘッダー:
  ```
  Authorization: Bearer <VOICEDRIVE_API_KEY>
  X-Medical-System-Version: 1.0
  ```

**トークンリフレッシュ**:
- VoiceDrive側の既存実装を踏襲してください
- 医療システム側では特別な対応は不要です

---

### 質問2: エンドポイントの本番URL

**✅ 回答**:

**現状**:
```
開発環境: http://localhost:3000 (Next.js開発サーバー)
本番環境: Vercel自動デプロイ (URL未確定)
```

**重要**:
- **共通DB構築後にURLが確定**します
- 現在は両システムとも開発環境でモックデータを使用
- 本番URLは共通DB構築プロジェクトの進捗次第で決定されます

**暫定対応**:
- 環境変数 `NEXT_PUBLIC_MEDICAL_SYSTEM_API` を設定可能にしてください
- 開発時は `http://localhost:3000`
- 本番時は確定次第、お知らせします

---

### 質問3: レスポンス形式

**✅ 回答**:

**統一形式**:

```typescript
// 成功レスポンス
{
  "data": <実際のデータ>,
  "success": true
}

// エラーレスポンス
{
  "error": "エラーメッセージ",
  "success": false
}
```

**ただし、現状の実装では**:
- 成功時: データオブジェクトをそのまま返却（`{ "id": "...", "name": "..." }`）
- エラー時: `{ "error": "..." }` 形式

**推奨**:
- 現状の形式で問題ありません（シンプルなため）
- 必要に応じて wrapper を追加してください

**ページネーション・ソート**:
- 申請履歴: `createdAt` 降順（最新が先頭）
- 現時点ではページネーションは未実装
- 将来的に必要になれば、クエリパラメータで対応予定

---

### 質問4: 職員IDの照合方法

**✅ 回答**:

**現状の課題**:
- VoiceDriveのユーザーIDと医療システムの職員IDのマッピングが**未定義**です

**提案**:
```
共通staffIdフィールドを使用
例: "OH-NS-2021-001"

形式: [施設コード]-[職種コード]-[入職年]-[連番]
- OH: 小原病院
- NS: 看護師（Nurse）
- 2021: 入職年
- 001: 連番
```

**統合方針**:
1. 両システムで同じ `staffId` を使用
2. VoiceDriveログイン時に `staffId` を取得
3. 医療システムAPIに `staffId` を渡してデータ取得

**SSO（シングルサインオン）**:
- 現時点では未実装
- 将来的に検討（Phase 6以降）

**確認事項**:
- VoiceDrive側で `staffId` フィールドが利用可能か教えてください
- 可能であれば、既存のユーザーテーブルに `staffId` カラムを追加することを推奨します

---

### 質問5: リアルタイム更新

**✅ 回答**:

**Webhook通知システムを実装済み**:
- 医療システム → VoiceDrive: `POST /api/career-course/notify`
- 審査完了時にVoiceDrive側に通知

**WebSocket対応**:
- 現時点では未実装
- 当面はWebhook通知で十分と考えます

**ポーリング頻度**:
- 申請状況確認画面: 30秒～1分ごとのポーリングを推奨
- マイキャリア情報画面: ページ読み込み時のみでOK

**推奨実装**:
```typescript
// VoiceDrive側の申請状況確認画面
useEffect(() => {
  const interval = setInterval(() => {
    fetchMyRequests() // 最新の申請状況を取得
  }, 30000) // 30秒ごと

  return () => clearInterval(interval)
}, [])
```

---

### 質問6: 個人情報保護

**✅ 回答**:

**ログの保存期間**:
- APIアクセスログ: 1年
- 申請・審査操作ログ: 3年（労働基準法に準拠）
- 個人情報を含むログ: 削除または匿名化（3年後）

**アクセスログの記録範囲**:
- API呼び出しのエンドポイント、メソッド
- リクエスト日時、IPアドレス
- ユーザーID（staffId）
- レスポンスステータスコード

**GDPR対応**:
- 現時点では日本国内のみの利用を想定
- GDPRの適用外
- ただし、個人情報保護法に準拠

---

### 質問7: 監査要件

**✅ 回答**:

**操作ログの記録項目**:
1. 申請送信時:
   - 申請ID、職員ID、申請日時
   - 変更前コース、変更後コース
   - 変更事由、詳細理由
   - 添付ファイル名（ファイル内容は記録しない）

2. 審査時:
   - 審査ID、審査者ID、審査日時
   - 承認/却下の決定
   - 審査コメント、却下理由

3. API呼び出し:
   - エンドポイント、メソッド
   - リクエスト日時、ユーザーID
   - レスポンスステータス

**監査証跡の保存形式**:
- JSON形式でログファイルに保存
- 将来的にはデータベースに移行予定
- 改ざん防止のためにハッシュ値を付与

**監査ツール**:
- 現時点では未実装
- Phase 6以降で実装予定

---

## 🔧 医療システム側の現状

### 実装済み項目

✅ **人事部向け管理画面** (`/admin/career-courses`)
- コース概要タブ: A～Dコースの説明と職員数表示
- 変更申請審査タブ: 承認/却下処理（UI実装済み）
- 統計情報タブ: コース別統計（将来実装）

✅ **API実装** (モックデータ)
- `GET /api/my-page` - マイページデータ取得
- `GET /api/career-courses/definitions` - コース定義一覧
- `POST /api/career-course/change-request` - 変更申請送信
- `GET /api/career-course/my-requests` - 申請履歴取得

✅ **Webhook通知システム**
- `POST /api/career-course/notify-voicedrive` - VoiceDriveへの通知送信
- リトライ機構搭載

✅ **マスターデータ管理**
- 管理者設定 > マスターデータ管理 > キャリアコース定義マスタ
- 将来のE・Fコース追加に対応

### 未実装項目（共通DB構築後に対応）

⏳ **認証処理**
- 現在: コメントアウト
- 対応: Supabase認証の有効化

⏳ **DB接続**
- 現在: モックデータ
- 対応: 実データ取得

⏳ **ファイルアップロード**
- 現在: コメントアウト
- 対応: Supabase Storageへのアップロード

⏳ **通知機能**
- 現在: コメントアウト
- 対応: メール通知、プッシュ通知

---

## 🚀 今後の連携方針

### Phase 5-3.1: API統合（VoiceDrive側作業）

**期限**: 2025年10月7日（1週間以内）

**作業内容**:
1. コース変更申請画面の実装
   - フォームバリデーション
   - 特例事由の選択UI
   - 添付ファイルアップロード
   - 確認ダイアログ

2. 申請状況確認画面の実装
   - 申請履歴テーブル
   - ステータスバッジ
   - 詳細モーダル
   - 申請取り下げボタン（将来実装用）

3. API統合
   - 環境変数 `NEXT_PUBLIC_MEDICAL_SYSTEM_API` の設定
   - Bearer Token認証の実装
   - エラーハンドリング

### Phase 5-3.2: Webhook受信エンドポイント実装（VoiceDrive側作業）

**期限**: 2025年10月7日（1週間以内）

**作業内容**:
1. `POST /api/career-course/notify` エンドポイントの実装
2. 認証確認（`Authorization` ヘッダー検証）
3. 職員への通知送信
   - プッシュ通知
   - 通知センターへの追加
   - メール通知（オプション）

**実装例**:
```typescript
// VoiceDrive側: pages/api/career-course/notify.ts
export default async function handler(req, res) {
  // 認証
  const authHeader = req.headers.authorization
  if (authHeader !== `Bearer ${process.env.MEDICAL_SYSTEM_API_KEY}`) {
    return res.status(401).json({ error: 'Unauthorized' })
  }

  const { type, staffId, requestId, approvedCourse, rejectionReason } = req.body

  // 通知送信
  if (type === 'course_change_approved') {
    await sendNotificationToStaff(staffId, {
      title: 'コース変更申請が承認されました',
      body: `${approvedCourse}コースへの変更が承認されました。`,
      link: '/career-selection-station/my-requests'
    })
  } else if (type === 'course_change_rejected') {
    await sendNotificationToStaff(staffId, {
      title: 'コース変更申請が却下されました',
      body: `理由: ${rejectionReason}`,
      link: '/career-selection-station/my-requests'
    })
  }

  res.status(200).json({ success: true, notificationSent: true })
}
```

### Phase 5-3.3: 統合テスト（両チーム共同作業）

**期限**: 2025年10月14日（2週間以内）

**作業内容**:
1. 開発環境での接続テスト
   - VoiceDrive → 医療システムAPI
   - 医療システム → VoiceDrive Webhook

2. エンドツーエンドテスト
   - 申請送信 → 審査 → 通知受信の一連の流れ

3. エラーケーステスト
   - 認証エラー
   - バリデーションエラー
   - ネットワークエラー

### Phase 5-3.4: 共通DB構築後の対応（両チーム）

**期限**: 共通DBプロジェクトの進捗次第

**作業内容**:
1. 環境変数の本番設定
2. 認証処理の有効化
3. 実データによるテスト
4. 本番環境デプロイ

---

## 📋 環境変数設定ガイド

### VoiceDrive側 (.env)

```env
# 医療システムAPIのベースURL
# 開発環境
NEXT_PUBLIC_MEDICAL_SYSTEM_API=http://localhost:3000
# 本番環境（共通DB構築後に確定）
# NEXT_PUBLIC_MEDICAL_SYSTEM_API=https://medical.system.local

# 医療システムからのWebhook認証用APIキー
MEDICAL_SYSTEM_API_KEY=vd_prod_key_A8B9C2D3E4F5G6H7I8J9K0L1M2N3O4P5

# staffIdマッピング設定（今後追加予定）
# ENABLE_STAFF_ID_MAPPING=true
```

### 医療システム側 (.env)

```env
# VoiceDriveへのWebhook通知URL
# 開発環境
VOICEDRIVE_WEBHOOK_URL=http://localhost:3001/api/career-course/notify
# 本番環境
# VOICEDRIVE_WEBHOOK_URL=https://voicedrive.system.local/api/career-course/notify

# VoiceDrive認証用APIキー
VOICEDRIVE_API_KEY=ms_prod_key_X1Y2Z3A4B5C6D7E8F9G0H1I2J3K4L5M6

# 内部API認証キー
INTERNAL_API_KEY=internal-secret-key-change-in-production

# Supabase設定（共通DB構築後）
# NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
# NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
# SUPABASE_SERVICE_ROLE_KEY=eyJxxx...
```

---

## ⚠️ 重要な認識の確認

### キャリア選択ステーションの役割分担

**VoiceDrive側（職員向け）**:
- ✅ マイキャリア情報表示
- ✅ コース変更申請フォーム
- ✅ 申請状況確認
- ✅ 左サイドバー統合

**医療システム側（人事部・管理者向け）**:
- ✅ 申請審査画面（承認/却下）
- ✅ コース別統計情報
- ✅ コース定義管理（マスターデータ）

**つまり**:
- VoiceDriveで実装した職員向け機能は、医療システム側には不要です
- 医療システム側は人事部向け管理機能のみを提供します
- この役割分担により、システムの責務が明確になり、保守性が向上します

---

## 🤝 次回ミーティングの提案

貴チームから提案いただいた議題に全面的に同意いたします。

### 議題

1. ✅ API仕様の詳細レビュー
   - 本返信書とAPI仕様書で詳細を提供済み
   - 追加の質問や不明点があればご連絡ください

2. ✅ セキュリティ要件の確認
   - 認証方式、APIキー、監査ログについて回答済み
   - さらなる要件があればディスカッション

3. ✅ テストデータの提供依頼
   - モックデータを提供済み（API仕様書に記載）
   - 追加のテストケースが必要であればご連絡ください

4. ⏳ Phase 5-4 の依頼内容確認
   - Phase 5-3完了後、Phase 5-4の内容を共有予定

5. **追加議題**: staffIdマッピング方式の決定
   - VoiceDrive側のユーザーテーブル構造の確認
   - 共通staffIdフィールドの実装方針

6. **追加議題**: 共通DB構築スケジュールの確認
   - 現在の進捗状況
   - 完成予定時期

### 希望日時

**ご提案の日時で問題ありません**:
- 2025年10月3日（木）14:00-15:00 ✅
- または 2025年10月4日（金）10:00-11:00 ✅

**ミーティング形式**:
- オンライン（Zoom / Google Meet）
- Slack Huddle（軽いディスカッションの場合）

---

## 📦 添付資料

本返信書には以下の資料を添付しております：

1. **Phase 5 API仕様書（VoiceDrive連携）**
   - `docs/Phase5_API仕様書_VoiceDrive連携.md`
   - 全4エンドポイントの詳細仕様
   - 認証方式、エラーレスポンス、TypeScript型定義

2. **Webhook通知エンドポイント実装**
   - `src/app/api/career-course/notify-voicedrive/route.ts`
   - リトライ機構搭載

3. **マスターデータ管理画面の更新**
   - キャリアコース定義マスタの追加
   - 将来のE・Fコース拡張に対応

---

## 🎯 次のアクションアイテム

### VoiceDriveチーム側

| 項目 | 期限 | 担当 |
|-----|------|------|
| コース変更申請画面の実装 | 10月7日 | VoiceDriveチーム |
| 申請状況確認画面の実装 | 10月7日 | VoiceDriveチーム |
| Webhook受信エンドポイントの実装 | 10月7日 | VoiceDriveチーム |
| API統合テスト | 10月14日 | VoiceDriveチーム |

### 医療システムチーム側

| 項目 | 期限 | 担当 |
|-----|------|------|
| API仕様書の提供 | 10月1日 | ✅ 完了 |
| Webhook通知エンドポイントの実装 | 10月1日 | ✅ 完了 |
| モックデータの動作確認 | 10月3日 | 医療システムチーム |
| 統合テストのサポート | 10月14日 | 医療システムチーム |

### 両チーム共同

| 項目 | 期限 | 担当 |
|-----|------|------|
| ミーティング（Phase 5-3レビュー） | 10月3日or4日 | 両チーム |
| staffIdマッピング方式の決定 | 10月7日 | 両チーム |
| 統合テスト | 10月14日 | 両チーム |

---

## 💬 コミュニケーションチャネル

**Slack**:
- #phase5-integration（統合チャネル）
- #phase5-medical-system（医療システム側）
- #phase5-voicedrive（VoiceDrive側）

**Email**:
- medical-system-dev@example.com
- voicedrive-dev@example.com

**緊急連絡**:
- Slack DM: @claude-code-medical
- Phone: （緊急時のみ）

---

## 🙏 おわりに

VoiceDriveチームの皆様

Phase 5-3の迅速な実装、誠にありがとうございました。
貴チームの技術力とスピード感に、医療システムチーム一同、大変感銘を受けております。

本返信書で提供した情報をもとに、引き続きスムーズな連携ができることを期待しております。

ご不明点やご質問がございましたら、いつでもお気軽にご連絡ください。
次回のミーティングを楽しみにしております！

引き続き、よろしくお願いいたします。

---

**医療職員管理システム開発チーム**
担当: Claude Code (AI開発支援)
作成日: 2025年10月1日
バージョン: 1.0

---

*本返信書は医療システムチームが作成した公式文書です。*
