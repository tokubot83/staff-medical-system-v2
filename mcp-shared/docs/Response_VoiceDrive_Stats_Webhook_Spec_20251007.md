# Re: VoiceDrive統計情報Webhook送信仕様書

**作成日：2025年10月7日**
**作成者：職員カルテシステム開発チーム**
**宛先：VoiceDrive開発チーム様**

---

## 1. 仕様書受領の確認

詳細な仕様書（`VoiceDrive統計情報Webhook送信仕様書 v1.0.0`）をご送付いただき、誠にありがとうございます。

### 1.1 仕様書の評価

| 評価項目 | 評価 | コメント |
|---------|------|---------|
| **完成度** | ⭐⭐⭐⭐⭐ | 必要な情報が全て網羅されています |
| **実装可能性** | ⭐⭐⭐⭐⭐ | Next.js API Routeの実装例が完璧です |
| **セキュリティ** | ⭐⭐⭐⭐⭐ | HMAC-SHA256署名検証、HTTPS必須など十分な対策 |
| **保守性** | ⭐⭐⭐⭐⭐ | バージョニング、エラーハンドリングが明確 |

### 1.2 特に評価できる点

- ✅ **実装例が具体的**：そのままコピーして使えるレベル
- ✅ **署名検証の実装**：セキュリティ対策が万全
- ✅ **エラーハンドリング**：リトライポリシーが明確
- ✅ **テスト手順**：ngrokを使った検証方法が記載
- ✅ **DB設計例**：スキーマ例まで提供

---

## 2. 現状報告

### 2.1 実装状況

| 機能カテゴリ | 実装状況 | 備考 |
|------------|---------|------|
| **人事お知らせ送信** | ❌ 未実装 | Phase 7で計画中 |
| **統計受信Webhook** | ❌ 未実装 | Phase 7で送信機能と同時実装予定 |
| **評価通知送信** | ✅ 実装済み | `VoiceDriveNotificationService.ts` |
| **面談申込受信** | ✅ 実装済み | `voicedriveIntegrationService.ts` |

### 2.2 統合の方向性

当システムでは以下の理解で進めております：

#### 受信するデータ
- ✅ **統計情報のみ**（配信数、アクション数、完了数）
- ✅ 部門別集計データ
- ❌ メッセージの双方向やり取りは不要
- ❌ 個別の応答内容は不要

#### データフロー
```
[職員カルテシステム]
    ↓ お知らせ送信
[VoiceDrive]
    ↓ 職員が閲覧・アクション
    ↓ 統計集計
    ↓ Webhook送信（統計のみ）
[職員カルテシステム]
    ↓ DB保存
    ↓ ダッシュボード表示
```

---

## 3. 実装計画

### 3.1 Phase 7: 人事お知らせ機能統合

**実装予定時期**：Phase 6完了後（共通DB構築後）

#### 実装スコープ（約1週間）

| No | タスク | 工数 | 担当 |
|----|--------|------|------|
| 1 | 人事お知らせ送信機能 | 2-3日 | 職員カルテチーム |
| 2 | **統計受信Webhook** | 1日 | 職員カルテチーム |
| 3 | 配信効果測定ダッシュボード | 2日 | 職員カルテチーム |
| 4 | 統合テスト | 1日 | 両チーム合同 |

#### タスク2の詳細（統計受信Webhook）

**実装内容**：
- `src/app/api/voicedrive/stats/route.ts` 作成
- HMAC-SHA256署名検証実装
- DB保存処理（`announcement_stats`テーブル）
- エラーハンドリング＋ログ記録

**使用する仕様**：
- ✅ 今回ご提供いただいた仕様書をそのまま使用
- ✅ 実装例のコードをベースに構築

---

## 4. 技術的確認事項

### 4.1 お知らせ送信時のペイロード仕様

人事お知らせを送信する際のペイロード仕様書もご提供いただけますでしょうか？

**必要な情報**：
- エンドポイントURL
- リクエストフォーマット
- 認証方式
- カテゴリ別の設定項目
- アクションボタンの設定方法

### 4.2 テスト環境

統合テスト実施時には以下を予定しております：

**ローカル開発環境**：
- ngrokでWebhookエンドポイントを公開
- VoiceDrive側からテストペイロード送信

**検証項目**：
- [ ] 署名検証の動作確認
- [ ] リアルタイム統計の受信確認
- [ ] バッチ統計の受信確認
- [ ] エラーハンドリングの確認
- [ ] DB保存の確認

**テスト用Webhook URL**：
- Phase 7開始時に共有させていただきます

### 4.3 環境変数

以下の環境変数を設定予定です：

```bash
# .env.production
VOICEDRIVE_WEBHOOK_SECRET=<共有秘密鍵>
VOICEDRIVE_API_TOKEN=<認証トークン>
```

共有秘密鍵とAPIトークンは実装開始時にセキュアな方法で共有いただけますでしょうか？

---

## 5. 質問事項

### 5.1 人事お知らせUI変更について

先日ご連絡いただいた「人事お知らせUI変更」について：

**確認事項**：
- ✅ `requireResponse: false` + `autoTrackResponse: true` の仕様を前提に実装
- ✅ アクションボタンクリック時の自動応答記録を想定
- ✅ ページビュートラッキングは将来的に検討

この理解で問題ございませんでしょうか？

### 5.2 統合の優先度

人事お知らせ統合の優先度についてご教示ください：

**質問**：
1. Phase 7での実装で問題ないでしょうか？
2. より早期の実装が必要な場合はご連絡ください

### 5.3 IPホワイトリスト

本番環境では、VoiceDriveサーバーのIPアドレスをホワイトリストに登録予定です。

**ご提供いただきたい情報**：
- Production環境のIPアドレスリスト
- Staging環境のIPアドレスリスト（テスト用）

---

## 6. 次のステップ

### 6.1 短期アクション（今週中）

- [x] 仕様書を `mcp-shared/specs/` に保存
- [x] 本返信文を作成・送信
- [ ] Phase 7実装計画を作成
- [ ] VoiceDriveチームからのフィードバック待ち

### 6.2 中期アクション（Phase 7開始時）

- [ ] お知らせ送信ペイロード仕様書の受領
- [ ] 開発環境でのWebhook実装
- [ ] ngrokを使ったローカルテスト
- [ ] VoiceDriveチームと統合テスト実施

### 6.3 長期アクション（Phase 7完了後）

- [ ] 本番環境デプロイ
- [ ] モニタリング設定
- [ ] 運用手順書の作成

---

## 7. まとめ

### 7.1 受領確認

✅ VoiceDrive統計情報Webhook送信仕様書 v1.0.0 を受領しました
✅ 仕様書は `mcp-shared/specs/voicedrive-stats-webhook-spec-v1.0.0.md` に保存
✅ Phase 7で実装予定（約1週間の工数）

### 7.2 対応方針

- **統計受信Webhook**：ご提供の仕様書をベースに実装
- **セキュリティ**：HMAC-SHA256署名検証を実装
- **テスト**：ngrokを使った統合テストを実施

### 7.3 お願い事項

1. お知らせ送信時のペイロード仕様書のご提供
2. 共有秘密鍵・APIトークンの共有（実装開始時）
3. Production/StagingのIPアドレスリストの共有

---

## 8. 添付ファイル

- `mcp-shared/specs/voicedrive-stats-webhook-spec-v1.0.0.md`（保存済み）
- `mcp-shared/docs/Response_VoiceDrive_Stats_Webhook_Spec_20251007.md`（本ドキュメント）

---

**引き続きよろしくお願いいたします。**

職員カルテシステム開発チーム
2025年10月7日

---

## 連絡先

- **Slack**: #phase2-integration
- **MCPサーバー**: `mcp-shared/docs/`
- **担当者**: 職員カルテシステム開発チーム
