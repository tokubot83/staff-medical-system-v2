# フィードバック面談連携 統合テスト計画書

**作成日**: 2025年10月3日
**テスト責任者**: 医療システムチーム & VoiceDriveチーム
**対象機能**: 評価結果フィードバック面談予約機能
**テスト環境**: 開発環境・ステージング環境

---

## 📋 テスト概要

### 目的
VoiceDrive側の評価ステーションページから送信されるフィードバック面談予約リクエストが、医療システム側で正しく受信・表示・処理されることを検証する。

### テスト範囲
1. **VoiceDrive → 医療システム**: API送信・受信
2. **医療システム**: 初回受付待ち表示
3. **医療システム → VoiceDrive**: AI最適化3案送信
4. **VoiceDrive → 医療システム**: 職員選択・本予約確定
5. **エラーハンドリング**: 異常系処理

---

## 🎯 テストケース

### ケース1: 夏季評価フィードバック（異議申立期限間近・緊急）

#### 1.1 テストデータ
```json
{
  "staffId": "OH-NS-2020-010",
  "staffName": "高橋 由美",
  "department": "外来看護部",
  "position": "看護師",
  "type": "support",
  "supportCategory": "feedback",
  "supportTopic": "夏季評価結果フィードバック",
  "scheduledDate": "2025-10-10",
  "scheduledTime": "14:00",
  "preferredDates": [
    "2025-10-10",
    "2025-10-11",
    "2025-10-12"
  ],
  "urgency": "urgent",
  "evaluationDetails": {
    "evaluationId": "EVAL-2024-SUMMER-010",
    "evaluationType": "summer_provisional",
    "facilityGrade": "B",
    "corporateGrade": "C",
    "totalPoints": 18.5,
    "appealDeadline": "2025-10-13",
    "appealable": true
  },
  "notes": "評価結果について詳しく説明を受けたい。特に組織貢献度の評価基準について確認したい。",
  "duration": 45,
  "source": "voicedrive",
  "createdBy": "職員本人"
}
```

#### 1.2 テスト手順
1. **VoiceDrive側**: 上記データをPOST `/api/interviews/reservations`
2. **医療システム側**: レスポンス確認
3. **医療システム側**: 予約管理ページを開く
4. **確認項目**:
   - [ ] 初回受付待ちカラムに表示される
   - [ ] 職員名「高橋 由美」が表示される
   - [ ] 緊急バッジ（🚨 緊急）が表示される
   - [ ] 評価情報カードが表示される
   - [ ] 施設内評価: B が表示される
   - [ ] 法人内評価: C が表示される
   - [ ] 組織貢献度: 18.5点 が表示される
   - [ ] 異議申立期限: 2025/10/13 が赤字で表示される
   - [ ] 「期限まで1週間未満」の警告が表示される
   - [ ] 希望日程が3件表示される

#### 1.3 期待結果
- HTTPステータス: `201 Created`
- レスポンスボディ:
```json
{
  "success": true,
  "data": {
    "id": "RES-xxxxxxxxxx",
    "message": "Reservation created successfully"
  }
}
```

---

### ケース2: 冬季評価フィードバック（期限に余裕・中優先度）

#### 2.1 テストデータ
```json
{
  "staffId": "TG-PT-2019-007",
  "staffName": "伊藤 健太",
  "department": "リハビリテーション科",
  "position": "理学療法士",
  "type": "support",
  "supportCategory": "feedback",
  "supportTopic": "冬季評価のフィードバック",
  "scheduledDate": "2025-10-20",
  "scheduledTime": "10:00",
  "preferredDates": [
    "2025-10-20",
    "2025-10-21"
  ],
  "urgency": "medium",
  "evaluationDetails": {
    "evaluationId": "EVAL-2024-WINTER-007",
    "evaluationType": "winter_provisional",
    "facilityGrade": "S",
    "corporateGrade": "S",
    "totalPoints": 24.8,
    "appealDeadline": "2025-11-10",
    "appealable": false
  },
  "notes": "今後のキャリアについても相談したい",
  "duration": 60,
  "source": "voicedrive"
}
```

#### 2.2 確認項目
- [ ] 中優先度バッジ（📋 中）が表示される
- [ ] 評価種別「冬季（暫定）」が表示される
- [ ] 施設内評価: S が紫色で表示される
- [ ] 法人内評価: S が紫色で表示される
- [ ] 異議申立期限の警告が表示されない（期限まで1ヶ月以上）
- [ ] 希望日程が2件表示される

#### 2.3 期待結果
- HTTPステータス: `201 Created`
- 緊急度に関わらず正常に受信・表示される

---

### ケース3: 年間確定評価フィードバック（異議申立不可）

#### 3.1 テストデータ
```json
{
  "staffId": "OH-DR-2018-003",
  "staffName": "田中 一郎",
  "department": "内科",
  "position": "医師",
  "type": "support",
  "supportCategory": "feedback",
  "supportTopic": "年間総合評価のフィードバック",
  "scheduledDate": "2025-04-05",
  "scheduledTime": "15:00",
  "preferredDates": [
    "2025-04-05"
  ],
  "urgency": "low",
  "evaluationDetails": {
    "evaluationId": "EVAL-2024-ANNUAL-003",
    "evaluationType": "annual_final",
    "facilityGrade": "A",
    "corporateGrade": "A",
    "totalPoints": 22.0,
    "appealable": false
  },
  "notes": "次年度の目標設定について相談したい",
  "source": "voicedrive"
}
```

#### 3.2 確認項目
- [ ] 評価種別「年間（確定）」が表示される
- [ ] 異議申立期限が表示されない
- [ ] `appealable: false` の場合、異議申立関連の警告が表示されない

---

### ケース4: 必須フィールド欠損エラー

#### 4.1 テストデータ
```json
{
  "staffId": "OH-NS-2020-010",
  "staffName": "高橋 由美",
  "type": "support",
  "supportCategory": "feedback",
  "scheduledDate": "2025-10-10",
  "scheduledTime": "14:00"
  // evaluationDetails が欠落
}
```

#### 4.2 期待結果
- HTTPステータス: `400 Bad Request`
- エラーメッセージが返される
- 医療システム側でデータが保存されない

---

### ケース5: 評価情報の型不正

#### 5.1 テストデータ
```json
{
  "staffId": "OH-NS-2020-010",
  "staffName": "高橋 由美",
  "type": "support",
  "supportCategory": "feedback",
  "scheduledDate": "2025-10-10",
  "scheduledTime": "14:00",
  "evaluationDetails": {
    "evaluationId": "EVAL-2024-SUMMER-010",
    "evaluationType": "invalid_type",  // 不正な値
    "facilityGrade": "B",
    "totalPoints": "not_a_number"  // 文字列（数値を期待）
  }
}
```

#### 5.2 期待結果
- バリデーションエラー または 正常受信後の警告表示
- データの整合性が保たれる

---

### ケース6: フルフロー統合テスト（仮予約→本予約確定）

#### 6.1 テストシナリオ
1. **VoiceDrive側**: フィードバック面談予約送信
2. **医療システム側**: 初回受付待ちに表示される
3. **医療システム側**: 「詳細処理」ボタンクリック
4. **医療システム側**: AI最適化で3案生成
5. **医療システム側**: 3案をVoiceDriveへ送信
6. **VoiceDrive側**: 職員が第2案を選択
7. **VoiceDrive側**: 選択結果を医療システムへ送信
8. **医療システム側**: 本予約確定・カレンダー表示

#### 6.2 確認項目
- [ ] 各ステップでデータが正しく伝達される
- [ ] ステータスが適切に遷移する（pending → proposals → awaiting → confirmed）
- [ ] 確定後、カレンダーに面談予定が表示される
- [ ] 評価情報が全フロー通じて保持される

---

## 🔧 テスト環境セットアップ

### 医療システム側
1. 開発環境起動: `npm run dev`
2. 予約管理ページを開く: `http://localhost:3000/interviews?tab=station`
3. ブラウザのコンソールを開いてエラー監視

### VoiceDrive側
1. 評価ステーションページを開く
2. テスト用評価データを準備
3. ネットワークタブでAPI送信を監視

---

## 📊 テスト結果記録シート

| ケース | 実施日 | 結果 | 備考 |
|--------|--------|------|------|
| ケース1: 夏季評価（緊急） | / | ⬜ PASS ⬜ FAIL | |
| ケース2: 冬季評価（中） | / | ⬜ PASS ⬜ FAIL | |
| ケース3: 年間評価（確定） | / | ⬜ PASS ⬜ FAIL | |
| ケース4: 必須欠損エラー | / | ⬜ PASS ⬜ FAIL | |
| ケース5: 型不正エラー | / | ⬜ PASS ⬜ FAIL | |
| ケース6: フルフロー | / | ⬜ PASS ⬜ FAIL | |

---

## 🐛 バグ報告フォーマット

バグを発見した場合は、以下の形式で `mcp-shared/docs/` に報告ファイルを作成してください。

```markdown
# バグ報告: [簡潔なタイトル]

**発見日**: YYYY-MM-DD
**報告者**: [チーム名]
**重要度**: 🔴 高 / 🟡 中 / 🟢 低

## 再現手順
1.
2.
3.

## 期待される動作


## 実際の動作


## スクリーンショット
（あれば添付）

## 環境情報
- OS:
- ブラウザ:
- API URL:
```

---

## ✅ テスト完了条件

### 最低条件
- [ ] ケース1-3が全てPASS
- [ ] ケース4がエラーハンドリング正常

### 理想条件
- [ ] ケース1-6が全てPASS
- [ ] 性能テスト: レスポンスタイム < 2秒
- [ ] UI/UX: 評価情報が見やすく表示される
- [ ] ドキュメント: 両チームで仕様を相互確認

---

## 📅 テストスケジュール

| 日程 | 作業内容 | 担当 |
|-----|---------|-----|
| 10/8 10:00-12:00 | ケース1-3 実施 | 両チーム合同 |
| 10/8 13:00-15:00 | ケース4-5 実施 | 両チーム合同 |
| 10/8 15:00-17:00 | ケース6 フルフロー | 両チーム合同 |
| 10/9 | バグ修正・調整 | 各チーム |
| 10/9 15:00 | 再テスト | 両チーム合同 |
| 10/10 | 本番デプロイ | 両チーム合同 |

---

## 🔗 関連ドキュメント

- **実装依頼書**: `mcp-shared/docs/フィードバック面談連携実装依頼書_20251003.md`
- **API仕様**: `src/app/api/interviews/reservations/route.ts`
- **型定義**: `src/components/interview/UnifiedInterviewDashboard.tsx`

---

## 📞 テスト時の連絡体制

### 医療システム側担当
- 予約管理画面の確認
- API受信処理の監視
- データベース確認

### VoiceDrive側担当
- 評価ステーションページの動作確認
- API送信処理の監視
- 職員選択フローの確認

### 連絡方法
- **リアルタイム**: Slack/Teams（推奨）
- **非同期**: mcp-shared/経由でファイル共有

---

**テスト成功を祈念しております！**

**医療システムチーム & VoiceDriveチーム一同**
