# コンプライアンス通報受付確認通知 統合テスト計画書

**発信**: 医療システムチーム
**宛先**: VoiceDriveチーム
**日時**: 2025年10月3日
**テスト予定日**: 2025年10月8日（火）
**重要度**: 🔴 **必須実施**

---

## 📋 テスト概要

### 目的
VoiceDriveから受信したコンプライアンス通報について、医療システムから通報者への受付確認通知が正しく配信され、通報ユーザーに適切に表示されることを検証する。

### テスト範囲
1. 医療システム → VoiceDrive への Webhook 送信
2. VoiceDrive での Webhook 受信・検証
3. 通報ユーザーへの通知配信
4. 通報ユーザー画面での表示確認
5. エラーハンドリング・リトライ処理

### 前提条件
- VoiceDrive側のWebhook受信エンドポイント実装完了
- VoiceDrive側の通報者向けUI実装完了
- 両システムのテスト環境準備完了

---

## 🧪 テストケース

### テストケース1: 重大案件（Critical）の受付確認通知

**目的**: 最高緊急度の通報に対する受付確認通知の動作確認

**テストデータ**:
```json
{
  "version": "1.0",
  "source": "voicedrive",
  "metadata": {
    "reportId": "VD-TEST-CRITICAL-001",
    "anonymousId": "ANON-TEST-001",
    "severity": "critical",
    "requiresImmediateAction": true,
    "category": "ハラスメント"
  },
  "payload": {
    "encrypted": "test_encrypted_data",
    "iv": "test_iv",
    "authTag": "test_auth_tag"
  },
  "checksum": "test_checksum"
}
```

**期待される動作**:

1. **医療システム側**:
   - ✅ 通報受信成功
   - ✅ ケース番号生成: `MED-2025-XXXX`
   - ✅ 受付確認通知生成
   - ✅ VoiceDriveへWebhook送信
   - ✅ 監査ログ記録

2. **VoiceDrive側**:
   - ✅ Webhook受信成功
   - ✅ 署名検証成功
   - ✅ データベース保存
   - ✅ 通報ユーザーへプッシュ通知配信
   - ✅ 通知センターに表示

3. **通報者画面**:
   - ✅ 赤背景のアラート表示
   - ✅ 「【緊急】通報を受け付けました」メッセージ
   - ✅ ケース番号表示: `MED-2025-XXXX`
   - ✅ 対応時間表示: "1時間以内"
   - ✅ 匿名性保護メッセージ表示
   - ✅ プッシュ通知受信

**判定基準**: 全項目が✅であること

---

### テストケース2: 高優先度（High）の受付確認通知

**目的**: 高優先度通報の受付確認通知動作確認

**テストデータ**:
```json
{
  "metadata": {
    "reportId": "VD-TEST-HIGH-002",
    "anonymousId": "ANON-TEST-002",
    "severity": "high",
    "requiresImmediateAction": false,
    "category": "診療報酬不正"
  }
}
```

**期待される動作**:
1. 医療システム: 受付確認通知送信成功
2. VoiceDrive: Webhook受信・処理成功
3. 通報者画面:
   - ✅ オレンジ背景のアラート表示
   - ✅ 「通報を受け付けました」メッセージ
   - ✅ 対応時間表示: "当日中"
   - ✅ プッシュ通知受信

**判定基準**: 全項目が✅、Critical と表示スタイルが異なること

---

### テストケース3: 中優先度（Medium）の受付確認通知

**テストデータ**:
```json
{
  "metadata": {
    "reportId": "VD-TEST-MEDIUM-003",
    "anonymousId": "ANON-TEST-003",
    "severity": "medium",
    "category": "労働条件違反"
  }
}
```

**期待される動作**:
- 黄色背景のアラート表示
- 対応時間: "3営業日以内"
- 通常通知（プッシュなし）

---

### テストケース4: 低優先度（Low）の受付確認通知

**テストデータ**:
```json
{
  "metadata": {
    "reportId": "VD-TEST-LOW-004",
    "anonymousId": "ANON-TEST-004",
    "severity": "low",
    "category": "その他"
  }
}
```

**期待される動作**:
- 緑背景のアラート表示
- 対応時間: "1週間以内"
- 通常通知（プッシュなし）

---

### テストケース5: Webhook署名検証エラー

**目的**: セキュリティ検証の動作確認

**テストデータ**:
- 不正な署名を含むWebhookリクエスト

**期待される動作**:
1. VoiceDrive側でWebhook受信拒否
2. エラーレスポンス返却:
   ```json
   {
     "success": false,
     "error": {
       "code": "INVALID_SIGNATURE",
       "message": "Webhook signature verification failed"
     }
   }
   ```
3. 医療システム側でエラーログ記録
4. リトライキューに登録

**判定基準**: 不正なWebhookが拒否されること

---

### テストケース6: VoiceDriveエンドポイント到達不可

**目的**: ネットワークエラー時のリトライ処理確認

**シミュレーション方法**:
- VoiceDriveのWebhookエンドポイントを一時的に停止

**期待される動作**:
1. 医療システム側:
   - ✅ 送信エラー検知
   - ✅ エラーログ記録
   - ✅ リトライキューに登録
   - ✅ 通報受付自体は成功
2. リトライ処理:
   - ✅ 1回目: 5秒後
   - ✅ 2回目: 15秒後（指数バックオフ）
   - ✅ 3回目: 45秒後
3. VoiceDrive復旧後:
   - ✅ リトライ成功
   - ✅ 通報者に通知配信

**判定基準**: 通報受付が成功し、リトライで最終的に通知が届くこと

---

### テストケース7: データ形式エラー

**目的**: バリデーションエラー時の動作確認

**テストデータ**:
```json
{
  "reportId": "VD-TEST-INVALID-007",
  "caseNumber": "", // 必須項目が空
  "anonymousId": "ANON-TEST-007"
}
```

**期待される動作**:
1. VoiceDrive側でバリデーションエラー検知
2. エラーレスポンス返却:
   ```json
   {
     "success": false,
     "error": {
       "code": "VALIDATION_ERROR",
       "message": "Invalid notification data",
       "field": "caseNumber"
     }
   }
   ```
3. 医療システム側でエラーログ記録

---

### テストケース8: タイムアウト処理

**目的**: タイムアウト時の動作確認

**シミュレーション方法**:
- VoiceDriveのWebhookエンドポイントで遅延レスポンス（30秒以上）

**期待される動作**:
1. 医療システム側:
   - ✅ タイムアウト検知（30秒）
   - ✅ エラーログ記録
   - ✅ リトライキューに登録
2. 次回リトライで成功

---

### テストケース9: 連続通報の処理

**目的**: 複数の通報を短時間に受信した場合の動作確認

**テストデータ**:
- 5件の通報を10秒間隔で送信（異なるseverity）

**期待される動作**:
1. 医療システム側:
   - ✅ 5件すべて正常受信
   - ✅ 5件すべて受付確認通知送信
   - ✅ ケース番号が重複しない
2. VoiceDrive側:
   - ✅ 5件すべて正常受信
   - ✅ 通報者に5件すべて通知配信
3. 通報者画面:
   - ✅ 5件すべて表示
   - ✅ 緊急度順にソート

**判定基準**: すべての通報が正しく処理され、順序正しく表示されること

---

### テストケース10: 匿名IDでのステータス確認

**目的**: 通報者が進捗確認できることの検証

**操作手順**:
1. テストケース1で生成された匿名ID `ANON-TEST-001` を使用
2. ステータス確認APIを呼び出し:
   ```
   GET /api/v3/compliance/receive?anonymousId=ANON-TEST-001
   ```

**期待される動作**:
```json
{
  "success": true,
  "anonymousId": "ANON-TEST-001",
  "caseNumber": "MED-2025-XXXX",
  "currentStatus": {
    "code": "investigating",
    "label": "調査中",
    "description": "担当者による調査が進行中です",
    "since": "2025-10-08T10:00:00.000Z"
  },
  "history": [
    {
      "status": "received",
      "timestamp": "2025-10-08T10:00:00.000Z",
      "note": "通報を受信しました"
    },
    {
      "status": "investigating",
      "timestamp": "2025-10-08T10:30:00.000Z",
      "note": "調査を開始しました"
    }
  ],
  "nextSteps": "担当者による聞き取り調査を実施中です。"
}
```

**判定基準**: 正しい進捗情報が返却されること

---

## 📊 テスト実施手順

### 準備フェーズ（テスト前日 10月7日）

**医療システムチーム**:
1. テスト環境のセットアップ
2. テストデータの準備
3. Webhook送信ログの監視設定
4. 環境変数の設定確認:
   ```
   VOICEDRIVE_ACKNOWLEDGEMENT_WEBHOOK_URL=https://test.voicedrive.example.com/api/webhook/compliance/acknowledgement
   VOICEDRIVE_WEBHOOK_SECRET=test-shared-secret-key
   ```

**VoiceDriveチーム**:
1. Webhookエンドポイントのデプロイ（テスト環境）
2. 通報者向けUIのデプロイ（テスト環境）
3. Webhook受信ログの監視設定
4. テストユーザーアカウントの準備

**両チーム共通**:
- 通信確認
- 認証情報の共有
- テストスケジュールの最終確認

---

### 実施フェーズ（テスト当日 10月8日）

**10:00-10:30 環境確認**
- ネットワーク疎通確認
- 認証情報確認
- ログ監視ツール起動

**10:30-11:30 正常系テスト（TC1-4）**
- テストケース1: Critical案件（15分）
- テストケース2: High案件（15分）
- テストケース3: Medium案件（15分）
- テストケース4: Low案件（15分）

**11:30-12:00 休憩・中間レビュー**
- 正常系テスト結果の確認
- 問題があれば対策検討

**13:00-14:00 異常系テスト（TC5-8）**
- テストケース5: 署名検証エラー（15分）
- テストケース6: エンドポイント到達不可（15分）
- テストケース7: データ形式エラー（15分）
- テストケース8: タイムアウト処理（15分）

**14:00-14:30 性能テスト（TC9）**
- テストケース9: 連続通報処理（30分）

**14:30-15:00 機能テスト（TC10）**
- テストケース10: ステータス確認（30分）

**15:00-15:30 総合レビュー**
- 全テスト結果の確認
- 問題点の洗い出し
- 対応方針の決定

---

## 🎯 成功基準

### 必須項目（すべて満たす必要あり）
- ✅ 正常系テスト（TC1-4）: 100%成功
- ✅ セキュリティテスト（TC5）: 不正アクセス拒否
- ✅ リトライ処理（TC6）: 最終的に成功
- ✅ バリデーション（TC7）: エラー正常検知
- ✅ 性能テスト（TC9）: 5件すべて成功

### 推奨項目（問題があれば改善）
- ⚡ 通知配信速度: 3秒以内
- ⚡ Webhook応答時間: 1秒以内
- ⚡ UI表示遅延: 2秒以内

### NGケース（再テスト必要）
- ❌ 正常系テストが1件でも失敗
- ❌ 通報者に通知が届かない
- ❌ 不正なWebhookが受理される
- ❌ リトライ処理が機能しない

---

## 📋 テスト結果記録フォーマット

```markdown
## テストケース1: 重大案件（Critical）の受付確認通知

**実施日時**: 2025-10-08 10:30
**実施者**: 医療システムチーム / VoiceDriveチーム
**結果**: ✅ 成功 / ❌ 失敗

### 詳細
- 医療システム側:
  - ケース番号: MED-2025-0001
  - Webhook送信: ✅ 成功
  - 送信時刻: 10:30:01
  - レスポンス時間: 0.8秒

- VoiceDrive側:
  - Webhook受信: ✅ 成功
  - 署名検証: ✅ 成功
  - 通知配信: ✅ 成功
  - 配信時刻: 10:30:02

- 通報者画面:
  - 表示確認: ✅ 成功
  - スタイル: ✅ 赤背景
  - プッシュ通知: ✅ 受信

### 備考
特になし

### スクリーンショット
[添付]
```

---

## 🐛 問題発生時の対応

### Level 1: 軽微な問題
**例**: UI表示の微調整が必要
**対応**: テスト後に修正、再テスト不要

### Level 2: 中程度の問題
**例**: 一部のテストケースが失敗
**対応**: 当日中に修正、該当テストケースのみ再実施

### Level 3: 重大な問題
**例**: 通知が一切届かない
**対応**: テスト中断、原因調査後、別日に再テスト

---

## 📞 テスト当日の連絡体制

### 医療システムチーム
- 主担当: システム開発チーム
- 連絡方法: MCP共有フォルダ、Slack（設定済みの場合）

### VoiceDriveチーム
- 主担当: 開発部
- 連絡方法: MCP共有フォルダ、Slack（設定済みの場合）

### 緊急連絡
- 重大な問題が発生した場合は、mcp-shared/に緊急ファイルを作成

---

## 📎 関連ドキュメント

- `コンプライアンス通報受付確認通知_API仕様書_20251003.md`
- `Medical_System_Implementation_Completion_Report_20250924.md`

---

## ✅ 事前確認チェックリスト

### 医療システムチーム
- [ ] テスト環境の準備完了
- [ ] 環境変数の設定完了
- [ ] テストデータの準備完了
- [ ] ログ監視ツールの設定完了
- [ ] VoiceDriveチームとの連絡手段確認

### VoiceDriveチーム
- [ ] Webhookエンドポイント実装完了
- [ ] 通報者向けUI実装完了
- [ ] テスト環境へのデプロイ完了
- [ ] テストユーザーアカウント準備完了
- [ ] 医療システムチームとの連絡手段確認

---

**🚨 重要**: テスト実施前に、必ず両チームで事前確認会議を実施してください。

---

*本テスト計画書は2025年10月3日に医療システムチームにより作成されました。*
