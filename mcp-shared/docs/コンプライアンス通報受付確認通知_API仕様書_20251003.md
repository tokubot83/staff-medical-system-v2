# コンプライアンス通報受付確認通知 API仕様書

**発信**: 医療システムチーム
**宛先**: VoiceDriveチーム
**日時**: 2025年10月3日
**重要度**: 🔴 **緊急・実装依頼**
**件名**: 通報者への受付確認通知機能の実装依頼

---

## 📋 エグゼクティブサマリー

医療システム側で、VoiceDriveから受信したコンプライアンス通報について、**通報者への受付確認通知機能**を実装完了しました。

VoiceDriveチームには、この受付確認通知を受信し、**通報ユーザーに表示する機能**の実装をお願いします。

---

## 🎯 実装の目的

### なぜ必要か
1. **通報者の心理的安全性**: 「通報が届いたか」「無視されていないか」の不安を解消
2. **法的・制度的要請**: 公益通報者保護法の趣旨に基づく適切な対応
3. **実務的メリット**: 進捗確認手段の提供、重複通報の防止
4. **ベストプラクティス**: 大手企業のコンプライアンス窓口では標準実装

### 通報者への価値
- ✅ 「通報が受理された」という安心感
- ✅ ケース番号・匿名IDによる進捗確認手段
- ✅ 対応完了までの見通し（期限・流れ）
- ✅ 匿名性保護の確認

---

## 🔧 医療システム側の実装内容

### 1. 新規エンドポイント（医療システム → VoiceDrive）

**Webhook URL**:
```
POST /api/webhook/compliance/acknowledgement
```

**実装ファイル**:
- `src/app/api/v3/compliance/receive/route.ts` (医療システム)
- `src/types/complianceMaster.ts` (型定義)

### 2. 送信タイミング
通報受信直後（データベース保存後、緊急通知送信後）

### 3. 送信データ構造

```typescript
interface AcknowledgementNotification {
  reportId: string;           // VoiceDriveのレポートID
  caseNumber: string;         // 医療システムのケース番号 (例: MED-2025-0001)
  anonymousId: string;        // 匿名ID (例: ANON-5678)
  receivedAt: string;         // 受付日時（ISO 8601形式）
  category: string;           // 通報カテゴリ (例: "ハラスメント")
  severity: 'critical' | 'high' | 'medium' | 'low';
  message: string;            // 通報者へのメッセージ
  nextSteps: {
    description: string;      // 今後の流れの説明
    estimatedResponseTime: {
      value: number;          // 数値 (例: 1, 3, 7)
      unit: 'hours' | 'days'; // 単位
    };
    deadlineForAdditionalInfo?: string; // 追加情報提供期限（ISO 8601）
  };
  anonymityProtection: {
    level: 'full' | 'conditional' | 'partial';
    message: string;          // 匿名性保護の説明
  };
  trackingInfo: {
    statusCheckUrl?: string;  // ステータス確認URL
    contactMethod?: string;   // 連絡方法の説明
  };
}
```

### 4. 実際の送信例

#### 🔴 重大案件（Critical）の場合
```json
{
  "reportId": "VD-2025-1234",
  "caseNumber": "MED-2025-0001",
  "anonymousId": "ANON-5678",
  "receivedAt": "2025-10-03T10:30:00.000Z",
  "category": "ハラスメント",
  "severity": "critical",
  "message": "【緊急】通報を受け付けました。重大案件として直ちに対応を開始します。",
  "nextSteps": {
    "description": "1時間以内に担当者に通知し、緊急対応を開始します。24時間以内に初期調査結果をお知らせします。",
    "estimatedResponseTime": {
      "value": 1,
      "unit": "hours"
    },
    "deadlineForAdditionalInfo": "2025-10-04T10:30:00.000Z"
  },
  "anonymityProtection": {
    "level": "full",
    "message": "あなたの匿名性は厳格に保護されます。通報者の特定につながる情報は暗号化され、限定された担当者のみがアクセス可能です。"
  },
  "trackingInfo": {
    "statusCheckUrl": "/api/v3/compliance/receive?anonymousId=ANON-5678",
    "contactMethod": "匿名IDを使用して、いつでもケースの進捗状況を確認できます。"
  }
}
```

#### 🟠 高優先度（High）の場合
```json
{
  "reportId": "VD-2025-1235",
  "caseNumber": "MED-2025-0002",
  "anonymousId": "ANON-5679",
  "receivedAt": "2025-10-03T09:15:00.000Z",
  "category": "診療報酬不正",
  "severity": "high",
  "message": "通報を受け付けました。優先案件として速やかに対応いたします。",
  "nextSteps": {
    "description": "当日中に担当者に通知し、調査を開始します。3営業日以内に初期調査結果をお知らせします。",
    "estimatedResponseTime": {
      "value": 24,
      "unit": "hours"
    },
    "deadlineForAdditionalInfo": "2025-10-04T09:15:00.000Z"
  },
  "anonymityProtection": {
    "level": "full",
    "message": "あなたの匿名性は厳格に保護されます。通報者の特定につながる情報は暗号化され、限定された担当者のみがアクセス可能です。"
  },
  "trackingInfo": {
    "statusCheckUrl": "/api/v3/compliance/receive?anonymousId=ANON-5679",
    "contactMethod": "匿名IDを使用して、いつでもケースの進捗状況を確認できます。"
  }
}
```

#### 🟡 中優先度（Medium）の場合
```json
{
  "severity": "medium",
  "message": "通報を受け付けました。担当者を割り当て、調査を開始いたします。",
  "nextSteps": {
    "description": "3営業日以内に担当者を割り当て、調査を開始します。1週間以内に初期調査結果をお知らせします。",
    "estimatedResponseTime": {
      "value": 3,
      "unit": "days"
    }
  }
  // その他のフィールドは同様
}
```

#### 🟢 低優先度（Low）の場合
```json
{
  "severity": "low",
  "message": "通報を受け付けました。内容を確認し、適切に対応いたします。",
  "nextSteps": {
    "description": "1週間以内に内容を確認し、必要に応じて調査を開始します。進捗は適宜お知らせします。",
    "estimatedResponseTime": {
      "value": 7,
      "unit": "days"
    }
  }
  // その他のフィールドは同様
}
```

---

## 🚀 VoiceDriveチームへの実装依頼

### 1. Webhook受信エンドポイントの作成

**推奨エンドポイント**:
```
POST /api/webhook/compliance/acknowledgement
```

**必須処理**:
1. 医療システムからのWebhook署名検証（HMAC-SHA256）
2. 受信データのバリデーション
3. データベースへの保存
4. 通報ユーザーへの通知配信

### 2. 通報者向けUI実装

#### 2.1 受付確認通知の表示

**表示場所**: VoiceDrive通知センター、通報管理画面

**表示内容**:
```
━━━━━━━━━━━━━━━━━━━━━━
✅ 通報を受け付けました

ケース番号: MED-2025-0001
匿名ID: ANON-5678
受付日時: 2025年10月3日 10:30

【今後の流れ】
1時間以内に担当者に通知し、緊急対応を開始します。
24時間以内に初期調査結果をお知らせします。

【匿名性保護について】
あなたの匿名性は厳格に保護されます。
通報者の特定につながる情報は暗号化され、
限定された担当者のみがアクセス可能です。

【進捗確認】
匿名ID「ANON-5678」を使用して、
いつでもケースの進捗状況を確認できます。
━━━━━━━━━━━━━━━━━━━━━━
```

#### 2.2 緊急度別の表示スタイル

- **Critical**: 🔴 赤背景、アニメーション付き、プッシュ通知
- **High**: 🟠 オレンジ背景、プッシュ通知
- **Medium**: 🟡 黄色背景、通常通知
- **Low**: 🟢 緑背景、通常通知

#### 2.3 ステータス確認機能

通報者が匿名IDを使用してケース進捗を確認できる画面：
```typescript
// 既存のステータス確認APIを活用
GET /api/v3/compliance/receive?anonymousId=ANON-5678
```

### 3. プッシュ通知実装

**重大案件・高優先度の場合**:
- モバイルアプリ: プッシュ通知
- Webアプリ: ブラウザ通知
- 音声通知: 「通報を受け付けました」

### 4. データ保存要件

**保存データ**:
- 受付確認通知の全データ
- 通報者への通知送信履歴
- 既読/未読状態

**保存期間**:
- 案件クローズ後2年間（公益通報者保護法準拠）

---

## 🔐 セキュリティ仕様

### 1. Webhook署名検証

**検証方法**:
```typescript
const signature = request.headers['x-webhook-secret'];
const payload = JSON.stringify(request.body);
const expectedSignature = crypto
  .createHmac('sha256', WEBHOOK_SECRET)
  .update(payload)
  .digest('hex');

if (signature !== expectedSignature) {
  throw new Error('Invalid webhook signature');
}
```

**環境変数**:
```
VOICEDRIVE_WEBHOOK_SECRET=shared-secret-key
```

### 2. 匿名性保護

- 匿名IDは暗号化された形式で保存
- 通報者の個人情報は一切含まない
- アクセスログの厳格な記録

### 3. データ暗号化

- 通信: TLS 1.3
- 保存: AES-256-GCM
- ハッシュ: SHA-512

---

## 📊 エラーハンドリング

### 医療システム側の動作

**Webhook送信失敗時**:
- エラーログ記録
- リトライキューに登録（3回まで、指数バックオフ）
- ただし、**通報受付自体は成功として扱う**

**理由**:
受付確認通知の送信失敗は、通報受付の成功を妨げない。
後でリトライして通知するため、通報者保護が優先。

### VoiceDrive側で推奨される実装

**受信失敗時**:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid notification data",
    "field": "caseNumber"
  }
}
```

**正常受信時**:
```json
{
  "success": true,
  "notificationId": "NOTIF-12345",
  "deliveredToUser": true,
  "timestamp": "2025-10-03T10:30:01.000Z"
}
```

---

## 🧪 テストケース

### 統合テスト実施項目

1. **正常系テスト**
   - Critical案件の受付確認通知
   - High案件の受付確認通知
   - Medium案件の受付確認通知
   - Low案件の受付確認通知

2. **異常系テスト**
   - Webhook署名不正
   - データ形式不正
   - ネットワークエラー時のリトライ
   - タイムアウト処理

3. **表示テスト**
   - 通報者画面での通知表示
   - 緊急度別のスタイル確認
   - プッシュ通知動作確認
   - 既読/未読状態管理

---

## 📅 実装スケジュール提案

| フェーズ | 作業内容 | 期間 | 担当 |
|---------|---------|------|------|
| **Phase 1** | VoiceDrive側Webhook受信実装 | 2日 | VoiceDrive |
| **Phase 2** | 通報者向けUI実装 | 2日 | VoiceDrive |
| **Phase 3** | 統合テスト準備 | 1日 | 両チーム |
| **Phase 4** | 統合テスト実施 | 1日 | 両チーム |
| **Phase 5** | 本番環境デプロイ | 1日 | 両チーム |

**推奨開始日**: 2025年10月4日（金）
**統合テスト予定**: 2025年10月8日（火）

---

## 🤝 連携・サポート

### 医療システムチームからの提供

✅ **完了済み**:
- 型定義ファイル: `src/types/complianceMaster.ts`
- 実装済みAPI: `src/app/api/v3/compliance/receive/route.ts`
- サンプルデータ（次ページ参照）

📋 **今後提供予定**:
- 統合テストシナリオ
- テストデータセット
- モックサーバー（開発用）

### VoiceDriveチームへのお願い

1. **実装開始可否の返信** （10月4日まで）
2. **技術的な質問・不明点の共有** （随時）
3. **実装完了予定日の連絡** （開始後）
4. **統合テスト日程の調整** （実装完了後）

---

## 📞 問い合わせ先

**医療システムチーム**
- MCP共有フォルダ: `mcp-shared/docs/`
- 緊急連絡: このファイルへの返信

**対応時間**: 平日 9:00-18:00

---

## 📎 関連ドキュメント

- `コンプライアンス通報受付確認通知_統合テスト計画書_20251003.md`（次に作成予定）
- `Medical_System_Implementation_Completion_Report_20250924.md`（既存）

---

**🚨 重要**: この機能は通報者保護の観点から重要です。早期の実装開始をお願いいたします。

---

*本仕様書は2025年10月3日に医療システムチームにより作成されました。*
