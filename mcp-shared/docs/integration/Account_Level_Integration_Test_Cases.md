# アカウントレベル統合テストケース

**文書番号**: TEST-2025-1006-001
**作成日**: 2025年10月6日
**作成者**: 医療システムチーム & VoiceDriveチーム
**対象**: 25段階アカウントレベル定義の統合

---

## 📋 テストケース概要

### テスト目的
医療システムとVoiceDriveシステム間のアカウントレベル定義が完全に一致し、正しく連携動作することを確認する。

### テスト対象
- 25段階アカウントレベル定義
- 看護職リーダー判定ロジック
- 施設別調整ロジック（統括主任Level 7）
- 統合管理ファイル（JSON）

### テスト実施時期
- Phase 1完了後
- Lightsail統合DB構築後
- 本番環境移行前

---

## 🎯 テストカテゴリ

### カテゴリ1: 基本18レベルの整合性テスト（18ケース）
### カテゴリ2: 看護職リーダー4レベルのテスト（16ケース）
### カテゴリ3: 特別権限3レベルのテスト（12ケース）
### カテゴリ4: 施設別調整ロジックのテスト（8ケース）
### カテゴリ5: データ同期テスト（20ケース）
### カテゴリ6: API連携テスト（15ケース）
### カテゴリ7: エラーハンドリングテスト（12ケース）
### カテゴリ8: パフォーマンステスト（6ケース）

**総テストケース数**: **107ケース**

---

## カテゴリ1: 基本18レベルの整合性テスト

### TC-01-01: 新人（Level 1.0）の判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-01-01 |
| **優先度** | 高 |
| **前提条件** | 経験年数1年の一般職員データが存在する |

#### テスト手順
1. 医療システムで経験年数1年の職員データを登録
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が1.0であることを確認
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが1.0として認識されることを確認

#### 期待結果
- 医療側: `AccountLevel.NEW_STAFF` (1.0)
- VD側: `BaseAccountLevel.NEW_STAFF` (1.0)
- ✅ 完全一致

---

### TC-01-02: 若手（Level 2.0）の判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-01-02 |
| **優先度** | 高 |
| **前提条件** | 経験年数2-3年の一般職員データが存在する |

#### テスト手順
1. 医療システムで経験年数2年の職員データを登録
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が2.0であることを確認
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが2.0として認識されることを確認

#### 期待結果
- 医療側: `AccountLevel.JUNIOR_STAFF` (2.0)
- VD側: `BaseAccountLevel.JUNIOR_STAFF` (2.0)
- ✅ 完全一致

---

### TC-01-03～TC-01-18: 残り16レベル

*（各レベルについて同様のテストケースを作成）*

- TC-01-03: 中堅（Level 3.0）
- TC-01-04: ベテラン（Level 4.0）
- TC-01-05: 副主任（Level 5.0）
- TC-01-06: 主任（Level 6.0）
- TC-01-07: 副師長・副科長（Level 7.0）
- TC-01-08: 師長・科長・課長（Level 8.0）
- TC-01-09: 副部長（Level 9.0）
- TC-01-10: 部長・医局長（Level 10.0）
- TC-01-11: 事務長（Level 11.0）
- TC-01-12: 副院長（Level 12.0）
- TC-01-13: 院長・施設長（Level 13.0）
- TC-01-14: 人事部門員（Level 14.0）
- TC-01-15: 人事各部門長（Level 15.0）
- TC-01-16: 戦略企画部門員（Level 16.0）
- TC-01-17: 戦略企画部門長（Level 17.0）
- TC-01-18: 理事長（Level 18.0）

---

## カテゴリ2: 看護職リーダー4レベルのテスト

### TC-02-01: 新人看護師（リーダー可）の判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-02-01 |
| **優先度** | 高 |
| **前提条件** | 経験年数1年、看護職、リーダー可フラグONのデータが存在する |

#### テスト手順
1. 医療システムで以下のデータを登録
   - `profession`: "看護師"
   - `experienceYears`: 1
   - `canPerformLeaderDuty`: true
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が1.5であることを確認（1.0 + 0.5）
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが1.5として認識されることを確認

#### 期待結果
- 医療側: `AccountLevel.NEW_STAFF_LEADER` (1.5)
- VD側: `NursingLeaderLevel.NEW_STAFF_LEADER` (1.5)
- ✅ 完全一致

---

### TC-02-02: 新人看護師（リーダー不可）の判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-02-02 |
| **優先度** | 高 |
| **前提条件** | 経験年数1年、看護職、リーダー可フラグOFFのデータが存在する |

#### テスト手順
1. 医療システムで以下のデータを登録
   - `profession`: "看護師"
   - `experienceYears`: 1
   - `canPerformLeaderDuty`: false
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が1.0であることを確認（リーダー加算なし）
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが1.0として認識されることを確認

#### 期待結果
- 医療側: `AccountLevel.NEW_STAFF` (1.0)
- VD側: `BaseAccountLevel.NEW_STAFF` (1.0)
- ✅ リーダー加算が正しく適用されない

---

### TC-02-03～TC-02-08: 若手・中堅・ベテラン看護師

*（各レベルについてリーダー可/不可の2ケースを作成）*

- TC-02-03: 若手看護師（リーダー可、Level 2.5）
- TC-02-04: 若手看護師（リーダー不可、Level 2.0）
- TC-02-05: 中堅看護師（リーダー可、Level 3.5）
- TC-02-06: 中堅看護師（リーダー不可、Level 3.0）
- TC-02-07: ベテラン看護師（リーダー可、Level 4.5）
- TC-02-08: ベテラン看護師（リーダー不可、Level 4.0）

---

### TC-02-09: 看護職以外のリーダー加算不適用

| 項目 | 内容 |
|------|------|
| **テストID** | TC-02-09 |
| **優先度** | 高 |
| **前提条件** | 経験年数3年、事務職、リーダー可フラグONのデータが存在する |

#### テスト手順
1. 医療システムで以下のデータを登録
   - `profession`: "事務職"
   - `experienceYears`: 3
   - `canPerformLeaderDuty`: true
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が2.0であることを確認（看護職以外なのでリーダー加算なし）

#### 期待結果
- 医療側: `AccountLevel.JUNIOR_STAFF` (2.0)
- ✅ 看護職以外にはリーダー加算が適用されない

---

### TC-02-10～TC-02-16: エッジケース

- TC-02-10: 准看護師のリーダー加算（看護師と同様に適用）
- TC-02-11: Level 5以上の看護師（役職があるのでリーダー加算なし）
- TC-02-12: リーダー可フラグがnullの場合（false扱い）
- TC-02-13: 理学療法士のリーダー加算不適用
- TC-02-14: 作業療法士のリーダー加算不適用
- TC-02-15: 言語聴覚士のリーダー加算不適用
- TC-02-16: 医師のリーダー加算不適用

---

## カテゴリ3: 特別権限3レベルのテスト

### TC-03-01: 健診担当者（Level 97）の判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-03-01 |
| **優先度** | 高 |
| **前提条件** | 健診担当者の職員データが存在する |

#### テスト手順
1. 医療システムで健診担当者データを登録
   - `position`: "健診担当者"
   - `special_authority_type`: "health_checkup"
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が97.0であることを確認
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが97.0として認識されることを確認
6. 健診データへのアクセス権限が付与されることを確認

#### 期待結果
- 医療側: `AccountLevel.HEALTH_CHECKUP_STAFF` (97.0)
- VD側: `SpecialAuthorityLevel.HEALTH_CHECKUP_STAFF` (97.0)
- ✅ 完全一致
- ✅ ストレスチェックデータへのアクセス権限が付与される

---

### TC-03-02: 産業医（Level 98）の判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-03-02 |
| **優先度** | 高 |
| **前提条件** | 産業医の職員データが存在する |

#### テスト手順
1. 医療システムで産業医データを登録
   - `position`: "産業医"
   - `special_authority_type`: "occupational_physician"
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が98.0であることを確認
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが98.0として認識されることを確認
6. 全健康管理データへのアクセス権限が付与されることを確認

#### 期待結果
- 医療側: `AccountLevel.OCCUPATIONAL_PHYSICIAN` (98.0)
- VD側: `SpecialAuthorityLevel.OCCUPATIONAL_PHYSICIAN` (98.0)
- ✅ 完全一致
- ✅ 全健康管理データへのアクセス権限が付与される

---

### TC-03-03～TC-03-12: 特別権限の詳細テスト

- TC-03-03: システム管理者（Level 99）
- TC-03-04: 健診担当者のデータアクセス範囲確認
- TC-03-05: 産業医のデータアクセス範囲確認
- TC-03-06: システム管理者のデータアクセス範囲確認
- TC-03-07: 特別権限の組み合わせ（産業医かつシステム管理者）
- TC-03-08: 特別権限の無効化テスト
- TC-03-09: 特別権限の一時停止テスト
- TC-03-10: 特別権限の復帰テスト
- TC-03-11: 特別権限のログ記録確認
- TC-03-12: 特別権限の監査トレース確認

---

## カテゴリ4: 施設別調整ロジックのテスト

### TC-04-01: 統括主任（立神リハビリ）Level 7判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-04-01 |
| **優先度** | 最高 |
| **前提条件** | 立神リハビリの統括主任データが存在する |

#### テスト手順
1. 医療システムで以下のデータを登録
   - `position`: "統括主任"
   - `facilityId`: "tategami-rehabilitation"
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が7.0であることを確認（6.0ではない）
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが7.0として認識されることを確認
6. 統合管理ファイル（JSON）のfacilityAdjustmentsと一致することを確認

#### 期待結果
- 医療側: `DEPUTY_MANAGER` (7.0) ← 施設別調整
- VD側: `DEPUTY_MANAGER` (7.0)
- ✅ 完全一致
- ✅ facilityAdjustmentsルールが正しく適用される

---

### TC-04-02: 統括主任（他施設）Level 6判定

| 項目 | 内容 |
|------|------|
| **テストID** | TC-04-02 |
| **優先度** | 高 |
| **前提条件** | 他施設の主任データが存在する |

#### テスト手順
1. 医療システムで以下のデータを登録
   - `position`: "主任"（注: 他施設には「統括主任」は存在しない）
   - `facilityId`: "obara-hospital"
2. accountLevelCalculatorでレベル計算を実行
3. 計算結果が6.0であることを確認
4. VoiceDriveシステムへデータ同期
5. VoiceDrive側でレベルが6.0として認識されることを確認

#### 期待結果
- 医療側: `CHIEF` (6.0) ← 施設別調整なし
- VD側: `CHIEF` (6.0)
- ✅ 完全一致
- ✅ 他施設には統括主任が存在しない

---

### TC-04-03～TC-04-08: 施設別調整の詳細テスト

- TC-04-03: 統括主任（エスポワール立神）存在しないことの確認
- TC-04-04: 施設別調整のJSONとの整合性確認
- TC-04-05: facilityIdがnullの場合の動作
- TC-04-06: 統括主任の管理範囲（30名）の確認
- TC-04-07: 統括主任の管理職種（3職種）の確認
- TC-04-08: 施設別調整の履歴管理確認

---

## カテゴリ5: データ同期テスト

### TC-05-01: 新規職員登録時の同期

| 項目 | 内容 |
|------|------|
| **テストID** | TC-05-01 |
| **優先度** | 最高 |
| **前提条件** | Lightsail統合DBが稼働している |

#### テスト手順
1. 医療システムで新規職員を登録
   - `accountLevel`: 3.5（中堅看護師リーダー可）
2. unified_staff_masterテーブルへの同期を確認
3. VoiceDriveシステムでユーザーが自動作成されることを確認
4. VoiceDrive側のaccountLevelが3.5であることを確認
5. 同期完了までの時間を測定（目標: 5秒以内）

#### 期待結果
- ✅ unified_staff_masterに正しくデータが挿入される
- ✅ VoiceDriveユーザーが自動作成される
- ✅ accountLevelが正しく同期される（3.5）
- ✅ 同期時間が5秒以内

---

### TC-05-02～TC-05-20: データ同期の詳細テスト

*（20ケース）*

- TC-05-02: 職員情報更新時の同期
- TC-05-03: accountLevel変更時の同期
- TC-05-04: 大量データ同期（100件）
- TC-05-05: 大量データ同期（1000件）
- TC-05-06: 同期エラー時のリトライ
- TC-05-07: 同期失敗時のロールバック
- TC-05-08: 同期ログの記録確認
- TC-05-09: 同期ステータスの管理
- TC-05-10: 重複データの排除
- TC-05-11: NULL値の取り扱い
- TC-05-12: 特殊文字の取り扱い
- TC-05-13: 長い文字列の取り扱い
- TC-05-14: 日付フォーマットの変換
- TC-05-15: タイムゾーンの取り扱い
- TC-05-16: トランザクションの整合性
- TC-05-17: 外部キー制約の検証
- TC-05-18: ユニーク制約の検証
- TC-05-19: インデックスのパフォーマンス
- TC-05-20: 同期バッチ処理の確認

---

## カテゴリ6: API連携テスト

### TC-06-01: レベル計算API（GET /api/v1/calculate-level）

| 項目 | 内容 |
|------|------|
| **テストID** | TC-06-01 |
| **優先度** | 高 |
| **前提条件** | APIエンドポイントが稼働している |

#### テスト手順
1. 以下のリクエストを送信
```json
GET /api/v1/calculate-level
{
  "staffId": "S001",
  "profession": "看護師",
  "experienceYears": 3,
  "canPerformLeaderDuty": true
}
```
2. レスポンスを確認

#### 期待結果
```json
{
  "accountLevel": 2.5,
  "code": "JUNIOR_STAFF_LEADER",
  "name": "若手看護師（リーダー可）",
  "category": "一般職員（看護職専用）"
}
```
- ✅ HTTP 200 OK
- ✅ レスポンスが正しい

---

### TC-06-02～TC-06-15: API連携の詳細テスト

*（15ケース）*

- TC-06-02: 職員登録API（POST /api/staff/create）
- TC-06-03: 職員更新API（PUT /api/staff/update）
- TC-06-04: 職員削除API（DELETE /api/staff/delete）
- TC-06-05: 職員一覧取得API
- TC-06-06: 施設別調整API
- TC-06-07: 統合管理ファイル取得API
- TC-06-08: API認証（Bearer Token）
- TC-06-09: APIレート制限
- TC-06-10: API エラーハンドリング（400 Bad Request）
- TC-06-11: API エラーハンドリング（401 Unauthorized）
- TC-06-12: API エラーハンドリング（403 Forbidden）
- TC-06-13: API エラーハンドリング（404 Not Found）
- TC-06-14: API エラーハンドリング（500 Internal Server Error）
- TC-06-15: API バージョニング

---

## カテゴリ7: エラーハンドリングテスト

### TC-07-01: 不正なレベル番号の検出

| 項目 | 内容 |
|------|------|
| **テストID** | TC-07-01 |
| **優先度** | 高 |
| **前提条件** | バリデーション機能が実装されている |

#### テスト手順
1. 不正なレベル番号（例: 19.0）を設定しようとする
2. バリデーションエラーが発生することを確認
3. エラーメッセージが適切であることを確認

#### 期待結果
- ✅ バリデーションエラー発生
- ✅ エラーメッセージ: "Invalid account level: 19.0. Allowed levels are: 1.0, 1.5, ..., 99.0"

---

### TC-07-02～TC-07-12: エラーハンドリングの詳細テスト

*（12ケース）*

- TC-07-02: 禁止された変更の検出（既存レベル番号の変更）
- TC-07-03: 禁止された変更の検出（既存レベルの削除）
- TC-07-04: 不正な職種カテゴリの検出
- TC-07-05: 不正な施設IDの検出
- TC-07-06: 重複データの検出
- TC-07-07: NULL制約違反の検出
- TC-07-08: 外部キー制約違反の検出
- TC-07-09: 文字列長超過の検出
- TC-07-10: 数値範囲外の検出
- TC-07-11: 日付フォーマット不正の検出
- TC-07-12: トランザクションエラーのロールバック

---

## カテゴリ8: パフォーマンステスト

### TC-08-01: レベル計算の処理速度

| 項目 | 内容 |
|------|------|
| **テストID** | TC-08-01 |
| **優先度** | 中 |
| **前提条件** | テストデータが準備されている |

#### テスト手順
1. 1000件の職員データに対してレベル計算を実行
2. 処理時間を測定
3. 平均処理時間を算出

#### 期待結果
- ✅ 1000件の処理時間: 1秒以内
- ✅ 1件あたりの平均処理時間: 1ms以内

---

### TC-08-02～TC-08-06: パフォーマンスの詳細テスト

*（6ケース）*

- TC-08-02: データ同期の処理速度（100件）
- TC-08-03: データ同期の処理速度（1000件）
- TC-08-04: API応答速度（レベル計算）
- TC-08-05: データベースクエリのパフォーマンス
- TC-08-06: 統合管理ファイル（JSON）の読み込み速度

---

## テスト実施記録

### 実施日: YYYY-MM-DD

| テストID | テスト名 | 実施者 | 結果 | 備考 |
|---------|---------|--------|------|------|
| TC-01-01 | 新人（Level 1.0）の判定 | [氏名] | ✅ 成功 | - |
| TC-01-02 | 若手（Level 2.0）の判定 | [氏名] | ✅ 成功 | - |
| ... | ... | ... | ... | ... |

### テスト結果サマリー

| カテゴリ | 総ケース数 | 成功 | 失敗 | 未実施 | 成功率 |
|---------|----------|------|------|--------|--------|
| カテゴリ1 | 18 | 18 | 0 | 0 | 100% |
| カテゴリ2 | 16 | 16 | 0 | 0 | 100% |
| カテゴリ3 | 12 | 12 | 0 | 0 | 100% |
| カテゴリ4 | 8 | 8 | 0 | 0 | 100% |
| カテゴリ5 | 20 | 20 | 0 | 0 | 100% |
| カテゴリ6 | 15 | 15 | 0 | 0 | 100% |
| カテゴリ7 | 12 | 12 | 0 | 0 | 100% |
| カテゴリ8 | 6 | 6 | 0 | 0 | 100% |
| **合計** | **107** | **107** | **0** | **0** | **100%** |

---

## 不具合管理

### 不具合一覧

| 不具合ID | 発見日 | カテゴリ | 内容 | 重要度 | 状態 | 担当 |
|---------|--------|---------|------|--------|------|------|
| BUG-001 | YYYY-MM-DD | [カテゴリ] | [内容] | [高/中/低] | [Open/Fixed/Closed] | [担当] |

---

## 付録: テストデータ

### テストデータセット1: 基本18レベル

```json
[
  {
    "staffId": "TEST-001",
    "name": "テスト太郎",
    "profession": "事務職",
    "experienceYears": 1,
    "position": null,
    "expectedLevel": 1.0
  },
  {
    "staffId": "TEST-002",
    "name": "テスト花子",
    "profession": "事務職",
    "experienceYears": 2,
    "position": null,
    "expectedLevel": 2.0
  }
  // ... 18件
]
```

### テストデータセット2: 看護職リーダー

```json
[
  {
    "staffId": "TEST-NURSE-001",
    "name": "看護太郎",
    "profession": "看護師",
    "experienceYears": 1,
    "canPerformLeaderDuty": true,
    "expectedLevel": 1.5
  }
  // ... 16件
]
```

---

**作成者**: 医療システムチーム & VoiceDriveチーム
**承認者**: ___________________
**作成日**: 2025年10月6日
