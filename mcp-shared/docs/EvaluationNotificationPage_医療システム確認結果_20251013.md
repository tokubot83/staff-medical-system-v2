# EvaluationNotificationPage 医療システム確認結果書

**文書番号**: MEDICAL-RESPONSE-2025-1013-004
**作成日**: 2025年10月13日
**作成者**: 医療システムチーム
**宛先**: VoiceDriveチーム
**件名**: EvaluationNotificationPage要件分析への確認結果

---

## 📌 エグゼクティブサマリー

VoiceDriveチームから提供された以下の文書を分析しました：
- **VD-MASTER-2025-1013-004**: EvaluationNotificationPage 暫定マスターリスト

**結論**: 医療システムチームは**全面的に協力可能**です。医療システム側の新規実装は**極めて軽微**であり、スケジュール通りの実装に問題はありません。

---

## ✅ 1. 確認結果サマリー

| 分析項目 | 医療システム関与 | VoiceDrive実装 | 医療システム評価 |
|---------|----------------|---------------|----------------|
| **マスターデータ管理** | ❌ 不要 | ✅ 全6種類 | ✅ 適切な分離 |
| **新規API実装** | ✅ 2件のみ | ✅ Webhook実装 | ✅ 実装可能 |
| **データベース変更** | ❌ 不要 | ✅ VoiceDrive側 | ✅ 適切な分離 |
| **Webhook送信** | ✅ 実装必要 | ✅ 受信実装 | ✅ 問題なし |
| **既存データ連携** | ✅ 評価データ | ✅ 利用 | ✅ 十分対応 |

**総合評価**: ✅ **全面協力可能・スケジュール問題なし**

---

## 🎯 2. 医療システム実装範囲の確認

### 2.1 新規実装が必要な項目

#### API-11: 評価結果開示Webhook（医療システム → VoiceDrive）

**エンドポイント**:
```
POST /api/voicedrive/webhooks/evaluation-disclosed
```

**送信タイミング**: 評価結果が開示された時（評価者が開示処理を実行した時）

**リクエストボディ**:
```json
{
  "webhookId": "webhook_eval_disclosed_001",
  "timestamp": "2025-10-13T14:30:00+09:00",
  "eventType": "evaluation.disclosed",
  "data": {
    "evaluationId": "eval-2025-001",
    "employeeId": "EMP-2024-001",
    "evaluationPeriod": "2025年度上期",
    "evaluationPeriodId": "period-2025-h1",
    "disclosedAt": "2025-10-13T14:30:00+09:00",
    "appealDeadline": "2025-10-27T23:59:59+09:00",
    "overallScore": 85.5,
    "overallGrade": "A",
    "facilityScore": 88.0,
    "facilityGrade": "A",
    "corporateScore": 82.0,
    "corporateGrade": "B+",
    "evaluatorId": "EMP-2020-100",
    "evaluatorName": "鈴木部長"
  }
}
```

**実装工数**: 2～3時間（Phase 3～19の既存Webhook送信機構を流用）

**実装予定日**: 評価通知システム実装時

**ステータス**: ✅ **実装承認**

---

#### API-12: 異議申立受理通知Webhook（医療システム → VoiceDrive）

**エンドポイント**:
```
POST /api/voicedrive/webhooks/appeal-submitted
```

**送信タイミング**: 職員が異議申立を提出した時

**リクエストボディ**:
```json
{
  "webhookId": "webhook_appeal_submitted_001",
  "timestamp": "2025-10-20T10:15:00+09:00",
  "eventType": "appeal.submitted",
  "data": {
    "appealId": "appeal-2025-001",
    "evaluationId": "eval-2025-001",
    "employeeId": "EMP-2024-001",
    "submittedAt": "2025-10-20T10:15:00+09:00",
    "appealReason": "自己評価とのギャップについて説明を求めます",
    "appealCategory": "score_inquiry",
    "notificationId": "notif_eval_001"
  }
}
```

**実装工数**: 2～3時間（Phase 3～19の既存Webhook送信機構を流用）

**実装予定日**: 評価通知システム実装時

**ステータス**: ✅ **実装承認**

---

### 2.2 既存データで対応可能な項目

VoiceDriveが必要とする以下の情報は、**医療システムの既存Evaluationテーブル**で対応可能です：

| 必要情報 | 既存データ | 提供状況 |
|---------|-----------|---------|
| 評価ID | `Evaluation.id` | ✅ 提供済み |
| 職員ID | `Evaluation.employeeId` | ✅ 提供済み |
| 評価期間 | `Evaluation.evaluationPeriod` | ✅ 提供済み |
| 総合スコア | `Evaluation.finalScore` | ✅ 提供済み |
| 評価グレード | `Evaluation.overallGrade` | ✅ 提供済み |
| 開示日時 | `Evaluation.disclosedAt` | ✅ 提供済み |
| 異議申立期限 | `Evaluation.appealDeadline` | ✅ 提供済み |

**確認事項**: これらのフィールドで不足している情報があれば、ご連絡ください。

---

### 2.3 Webhook受信エンドポイント（VoiceDrive → 医療システム）

医療システムは、VoiceDriveからの以下のWebhookを受信する必要があります：

| Webhook | エンドポイント | 対応状況 |
|---------|--------------|---------|
| API-13: 通知配信完了 | `POST /api/medical/evaluations/notify-delivery-status` | ✅ 対応可能 |
| API-14: 通知既読確認 | `POST /api/medical/evaluations/notify-read-status` | ✅ 対応可能 |

**実装工数**: 各1～2時間（既存のWebhook受信機構で対応）

**実装予定日**: 評価通知システム実装時

**ステータス**: ✅ **実装承認**

---

## 🔄 3. マスターデータ管理の確認

### 3.1 VoiceDrive独自管理マスター（医療システム実装不要）

以下の6種類のマスターは**全てVoiceDrive独自管理**であり、医療システムチームの実装は**不要**です：

| マスター名 | データ数 | 管理方法 | 医療システム作業 |
|-----------|---------|---------|----------------|
| 1. 通知ステータスマスター | 5種類 | コード定義 | ❌ 不要 |
| 2. 異議申立ステータスマスター | 4種類 | コード定義 | ❌ 不要 |
| 3. 評価グレードマスター | 7段階+5段階 | コード定義 | ⚠️ 確認事項あり |
| 4. 通知テンプレートマスター | 4種類 | コード定義 | ❌ 不要 |
| 5. 通知優先度マスター | 4段階 | コード定義 | ❌ 不要 |
| 6. 配信方法マスター | 4種類 | コード定義 | ❌ 不要 |

**医療システムチームの評価**: ✅ **適切な責任分離**

VoiceDriveが通知システムに特化したマスターを独自管理することで、両チームの責任範囲が明確になり、保守性が向上します。

---

### 3.2 評価グレードマスターに関する確認事項

VoiceDriveの「評価グレードマスター」は、医療システムの評価グレード定義と**同期**する必要があります。

#### 現在の医療システムのグレード定義

**総合評価グレード（7段階）**:
```typescript
// 医療システム（src/types/evaluation.ts）
export type OverallGrade = 'S' | 'A+' | 'A' | 'B+' | 'B' | 'C' | 'D';

// スコア範囲（Phase 4で定義済み）
const gradeScoreRanges = {
  S: { min: 95, max: 100 },
  'A+': { min: 90, max: 94 },
  A: { min: 80, max: 89 },
  'B+': { min: 70, max: 79 },
  B: { min: 60, max: 69 },
  C: { min: 50, max: 59 },
  D: { min: 0, max: 49 }
};
```

**施設内・法人内評価グレード（5段階）**:
```typescript
// 医療システム（src/types/evaluation.ts）
export type RelativeGrade = 'S' | 'A' | 'B' | 'C' | 'D';

// 相対評価の定義（Phase 4で定義済み）
const relativeGradeRanges = {
  S: '上位5%',
  A: '上位20%',
  B: '上位50%',
  C: '上位80%',
  D: '下位20%'
};
```

#### 確認事項

**質問3.1**: VoiceDriveの評価グレードマスターは、上記の医療システムの定義と**完全に一致**していますか？

- **選択肢A**: 完全に一致している
- **選択肢B**: 一部相違がある（相違点を明記してください）
- **選択肢C**: VoiceDrive独自の定義を使用する

**医療システムチームの推奨**: **選択肢A（完全一致）**

**理由**:
- 評価グレードは医療システムで計算・決定される
- VoiceDriveは通知時に表示するだけ
- 不一致があると職員の混乱を招く

---

## 🔄 4. データ同期戦略

### 4.1 評価結果の同期フロー

```
医療システム                           VoiceDrive
    |                                      |
    | (1) 評価者が評価結果を開示            |
    |------------------------------------->|
    |   POST /api/voicedrive/webhooks/    |
    |        evaluation-disclosed         |
    |                                      |
    |                    (2) 通知を生成・送信
    |                                      |
    |<-------------------------------------|
    |   POST /api/medical/evaluations/    |
    |        notify-delivery-status       |
    | (3) 配信状況を記録                    |
    |                                      |
    |                      (4) 職員が通知を既読
    |                                      |
    |<-------------------------------------|
    |   POST /api/medical/evaluations/    |
    |        notify-read-status           |
    | (5) 既読状況を記録                    |
```

### 4.2 異議申立の同期フロー

```
VoiceDrive                            医療システム
    |                                      |
    | (1) 職員が異議申立を提出              |
    |------------------------------------->|
    |   POST /api/voicedrive/webhooks/    |
    |        appeal-submitted             |
    |                                      |
    |                    (2) 異議申立を記録
    |                                      |
    |<-------------------------------------|
    |   POST /api/voicedrive/webhooks/    |
    |        appeal-status-updated        |
    | (3) ステータス更新を表示              |
    |                                      |
    |                    (4) 人事部門が回答作成
    |                                      |
    |<-------------------------------------|
    |   POST /api/voicedrive/webhooks/    |
    |        appeal-response-available    |
    | (5) 回答通知を送信                    |
```

### 4.3 データ整合性の確保

| 同期項目 | 同期方向 | 同期方法 | 頻度 | 責任チーム |
|---------|---------|---------|------|----------|
| 評価結果開示 | 医療システム → VoiceDrive | Webhook | リアルタイム | 医療システム |
| 通知配信状況 | VoiceDrive → 医療システム | Webhook | リアルタイム | VoiceDrive |
| 異議申立提出 | VoiceDrive → 医療システム | Webhook | リアルタイム | VoiceDrive |
| 異議申立回答 | 医療システム → VoiceDrive | Webhook | リアルタイム | 医療システム |

**データ整合性の保証**:
- Webhook送信時に一意なIDを付与（`webhookId`）
- リトライ機構（最大3回、指数バックオフ）
- 配信失敗時のアラート通知

---

## 📊 5. 実装工数見積もり

### 5.1 医療システム側の実装工数

| 実装項目 | 工数 | 優先度 | 担当 |
|---------|------|--------|------|
| API-11: 評価結果開示Webhook送信 | 2～3時間 | 高 | バックエンド |
| API-12: 異議申立受理Webhook送信 | 2～3時間 | 高 | バックエンド |
| API-13: 通知配信完了Webhook受信 | 1～2時間 | 中 | バックエンド |
| API-14: 通知既読Webhook受信 | 1～2時間 | 中 | バックエンド |
| Evaluationテーブル拡張（通知フラグ） | 1時間 | 低 | バックエンド |
| 統合テスト | 2～3時間 | 高 | QA |
| **合計** | **9～14時間** | - | - |

### 5.2 VoiceDrive側の実装工数（参考）

| 実装項目 | 工数 | 優先度 |
|---------|------|--------|
| EvaluationNotificationテーブル作成 | 2時間 | 高 |
| NotificationSettingsテーブル作成 | 2時間 | 高 |
| Webhook受信エンドポイント（2件） | 4時間 | 高 |
| 通知送信サービス（メール・プッシュ） | 12時間 | 高 |
| 通知画面実装 | 8時間 | 高 |
| 異議申立画面実装 | 6時間 | 高 |
| リマインダー機能 | 4時間 | 中 |
| 統合テスト | 4時間 | 高 |
| **合計** | **42時間** | - |

---

## 🚀 6. 実装スケジュール提案

### Phase 1（基本通知機能）: 2025-11-14 ～ 2025-11-27（14日間）

#### 医療システム側作業
- **2025-11-14～15**: API-11（評価結果開示Webhook）実装
- **2025-11-16～17**: API-12（異議申立受理Webhook）実装
- **2025-11-18～19**: Webhook送信テスト（VoiceDriveの受信確認）

#### VoiceDrive側作業
- **2025-11-14～15**: テーブル作成、Webhook受信実装
- **2025-11-16～20**: 通知送信サービス実装
- **2025-11-21～25**: 通知画面実装
- **2025-11-26～27**: 統合テスト

#### Phase 1完了基準
- ✅ 評価結果開示時に通知が送信される
- ✅ 職員が通知を確認できる
- ✅ 異議申立を提出できる

---

### Phase 2（配信状況追跡）: 2025-11-28 ～ 2025-12-04（7日間）

#### 医療システム側作業
- **2025-11-28～29**: API-13（通知配信完了Webhook）受信実装
- **2025-11-30～12-01**: API-14（通知既読Webhook）受信実装
- **2025-12-02～03**: Evaluationテーブル拡張（通知フラグ）

#### VoiceDrive側作業
- **2025-11-28～12-01**: Webhook送信実装（配信・既読）
- **2025-12-02～03**: 配信状況表示画面実装
- **2025-12-04**: 統合テスト

#### Phase 2完了基準
- ✅ 通知の配信状況を追跡できる
- ✅ 職員の既読状況を確認できる

---

### Phase 3（リマインダー・管理機能）: 2025-12-05 ～ 2025-12-11（7日間）

#### VoiceDrive側作業
- **2025-12-05～07**: リマインダー機能実装
- **2025-12-08～10**: 管理者向け統計画面実装
- **2025-12-11**: 最終統合テスト

#### Phase 3完了基準
- ✅ 締切前にリマインダーが送信される
- ✅ 通知配信統計を確認できる

---

## ❓ 7. VoiceDriveチームへの確認事項

### 7.1 評価グレードマスターの同期

**質問**: VoiceDriveの評価グレードマスターは、医療システムの定義と完全に一致していますか？

- **選択肢A**: 完全に一致している
- **選択肢B**: 一部相違がある（相違点を明記してください）
- **選択肢C**: VoiceDrive独自の定義を使用する

**医療システムチームの推奨**: **選択肢A**

---

### 7.2 Webhook認証方式

**質問**: 評価通知Webhookの認証方式はどのようにしますか？

- **選択肢A**: Bearer Token認証（Phase 3～20と統一、JWT）
- **選択肢B**: HMAC署名認証（Webhook専用）
- **選択肢C**: API Key認証

**医療システムチームの推奨**: **選択肢A（Bearer Token認証）**

**理由**:
- Phase 3～20で統一された認証方式
- 既存の実装を流用可能
- 実装コストが最小

---

### 7.3 通知配信失敗時の処理

**質問**: 通知配信に失敗した場合、医療システム側で再送処理を行いますか？

- **選択肢A**: 医療システムが自動再送（リトライ機構）
- **選択肢B**: VoiceDriveが再送リクエストを送信
- **選択肢C**: 手動で再送（管理者操作）

**医療システムチームの推奨**: **選択肢A（医療システムが自動再送）**

**理由**:
- Phase 3～19で実装済みのリトライ機構を流用
- 配信成功率の向上
- 運用負荷の削減

---

### 7.4 異議申立データの管理

**質問**: 異議申立のデータは、どちらのシステムで管理しますか？

- **選択肢A**: 医療システムで管理（VoiceDriveは表示のみ）
- **選択肢B**: VoiceDriveで管理（医療システムと同期）
- **選択肢C**: 両システムで独立管理

**医療システムチームの推奨**: **選択肢A（医療システムで管理）**

**理由**:
- 異議申立は評価データの一部
- 医療システムに既存のAppealテーブルがある
- シングルソースオブトゥルース

---

### 7.5 通知の多言語対応

**質問**: 通知テンプレートは多言語対応が必要ですか？

- **選択肢A**: 日本語のみ（現時点）
- **選択肢B**: 英語も対応
- **選択肢C**: 英語・中国語・ベトナム語対応

**医療システムチームの推奨**: **選択肢A（日本語のみ）**

**理由**:
- 初期リリースは日本語のみで十分
- 多言語対応は Phase 4以降で検討
- 実装コストの削減

---

## 📝 8. 医療システムチームの最終判断

### 8.1 実装可否

**判断**: ✅ **実装可能・全面協力**

**理由**:
1. 医療システム側の実装は極めて軽微（9～14時間）
2. 既存のWebhook送信機構を流用可能
3. データベース変更は不要
4. スケジュールに十分余裕がある

---

### 8.2 スケジュール承認

**判断**: ✅ **スケジュール承認**

提案されたスケジュール（2025-11-14 ～ 2025-12-11）に問題はありません。

**医療システム側の準備完了予定日**: 2025-11-14

---

### 8.3 リスク評価

| リスク | 影響度 | 発生確率 | 対策 |
|-------|--------|---------|------|
| Webhook配信失敗 | 中 | 低 | リトライ機構実装済み |
| グレード定義の不一致 | 高 | 低 | 事前に定義を確認 |
| 異議申立データの二重管理 | 中 | 中 | 選択肢Aで回避 |
| 通知送信遅延 | 低 | 低 | 優先度マスターで制御 |

**総合リスク評価**: 🟢 **低リスク**

---

## 🎯 9. 次のアクション

### 医療システムチーム
- [ ] 2025-10-14: VoiceDriveからの回答書確認待機
- [ ] 2025-10-20: 5つの確認事項への回答確認
- [ ] 2025-11-01: Phase 1開発準備開始
- [ ] 2025-11-14: API-11・API-12実装開始

### VoiceDriveチーム
- [ ] 2025-10-14: 本確認結果書のレビュー
- [ ] 2025-10-15: 5つの確認事項への回答書作成
- [ ] 2025-11-01: Phase 1開発準備開始
- [ ] 2025-11-14: Webhook受信実装開始

---

## 📞 連絡先

**医療システムチーム**
- Slack: #medical-system-integration
- 担当: システム開発チーム

**VoiceDriveチーム**
- Slack: #voicedrive-integration
- 担当: システム開発チーム

---

**文書終了**

最終更新: 2025年10月13日
バージョン: 1.0
次回レビュー: VoiceDriveチームの回答書受領時
