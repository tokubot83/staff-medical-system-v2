# Phase 2 顔写真統合 - 構成変更のお知らせ

**文書番号**: MED-NOTICE-PHASE2-2025-1021-001
**発信日**: 2025年10月21日
**発信元**: 医療職員カルテシステム開発チーム
**宛先**: VoiceDriveチーム
**件名**: Phase 2顔写真統合 - CloudFrontからLightsail Public Folderへの構成変更

---

## 📋 エグゼクティブサマリー

VoiceDriveチーム様

いつもお世話になっております。医療職員カルテシステム開発チームです。

Phase 2顔写真統合について、**コスト最適化と運用簡素化**のため、当初予定していた**CloudFront CDN構成からLightsail Public Folder構成に変更**することをご報告いたします。

---

## 🔄 構成変更の概要

### 旧構成（当初の提案）

```
AWS S3バケット
  ↓
CloudFront CDN
  ↓
VoiceDriveシステム（画像表示）
```

**コスト**: ¥272/月（S3 + CloudFront）

### 新構成（変更後）

```
Lightsail 80ドルプラン
  └── public/employees/ フォルダ（Next.js標準機能）
       ↓
     VoiceDriveシステム（画像表示）
```

**コスト**: ¥0/月（Lightsailプラン内で完結）

---

## 💡 変更理由

### 1. コスト削減

| 項目 | 旧構成 | 新構成 | 削減額 |
|------|--------|--------|--------|
| S3ストレージ | ¥150/月 | ¥0 | ¥150 |
| CloudFront | ¥122/月 | ¥0 | ¥122 |
| **合計** | **¥272/月** | **¥0** | **¥272/月** |

**年間削減額**: ¥3,264

### 2. 運用簡素化

- ✅ AWS Management Console不要（設定作業3時間削減）
- ✅ CloudFront Distribution管理不要
- ✅ S3バケットポリシー設定不要
- ✅ OAC（Origin Access Control）設定不要

### 3. 十分なパフォーマンス

**利用条件**:
- 日本国内のみ
- 社内500名規模

**パフォーマンス試算**:
- 月間転送量: 30GB/月
- Lightsail転送枠: 5-7TB/月
- **使用率: 0.6%**（十分余裕あり）

---

## 📝 VoiceDrive側への影響

### ✅ 良いお知らせ

**実装への影響はほぼありません！**

VoiceDrive側で既に実装済みの以下の機能は**そのまま使用可能**です：
- ✅ Prismaスキーマ（`profilePhotoUrl`, `profilePhotoUpdatedAt`）
- ✅ Webhook署名検証ミドルウェア
- ✅ Webhookハンドラー
- ✅ PhotoAvatarコンポーネント

### 🔧 必要な変更（軽微）

#### 変更1: 画像URL形式のみ変更

**旧URL形式**:
```typescript
profilePhotoUrl: "https://d2k8x5j9m1n4p7.cloudfront.net/employees/EMP-2024-001.jpg"
```

**新URL形式**:
```typescript
profilePhotoUrl: "https://medical-system.example.com/employees/EMP-2024-001.jpg"
```

**変更内容**: ドメイン部分のみ（`/employees/{staffId}.jpg` は同じ）

#### 変更2: CORS設定不要

CloudFrontを使用しないため、CORS設定の依頼は**不要**となります。

---

## 📊 技術仕様（新構成）

### 画像配信方式

**Next.js Public Folder**（Next.js標準機能）

```
staff-medical-system/
├── public/
│   └── employees/          ← 職員顔写真を配置
│       ├── EMP-2024-001.jpg
│       ├── EMP-2024-002.jpg
│       └── ... (500枚)
└── src/
```

### URL構造

```
ベースURL: https://medical-system.example.com
画像パス: /employees/{staffId}.jpg

完全なURL例:
https://medical-system.example.com/employees/EMP-2024-001.jpg
https://medical-system.example.com/employees/EMP-2024-002.jpg
```

### 画像仕様（変更なし）

| 項目 | 仕様 |
|------|------|
| サイズ | 400x400ピクセル |
| 形式 | JPEG |
| 品質 | 85% |
| ファイルサイズ | 200KB以下（推奨） |
| ファイル命名 | `{staffId}.jpg` |

---

## 🔒 セキュリティ

### 現在の設定

- **公開アクセス**: `public/employees/` フォルダは誰でもアクセス可能
- **理由**: シンプルさと高速性を優先

### 将来の強化（オプション）

DB構築後、Next.js API Routeで認証を追加可能：

```typescript
// 認証付きURL（将来）
GET /api/employees/EMP-2024-001/photo
  → セッション認証チェック → 画像返却
```

**社内500名規模では現在の設定で十分**と判断しています。

---

## 📅 スケジュール変更

### 旧スケジュール（CloudFront構成）

| 日付 | 作業内容 | ステータス |
|------|---------|----------|
| 10/21 | Webhook Secret生成・共有 | ✅ 完了 |
| 10/24 | CloudFront Distribution作成 | ❌ **キャンセル** |
| 10/25 | テスト用URL共有 | ❌ **キャンセル** |
| 10/30 | 調整会議 | ❌ **キャンセル** |
| 11/4-11/8 | Week 1実装 | → DB構築後 |

### 新スケジュール（Lightsail Public Folder）

| 日付 | 作業内容 | ステータス |
|------|---------|----------|
| 10/21 | `public/employees/` フォルダ作成 | ✅ 完了 |
| 10/21 | `.gitignore` 設定追加 | ✅ 完了 |
| 10/21 | 実装ガイド作成 | ✅ 完了 |
| 10/21 | VoiceDriveチームへ通知 | 🔧 **本文書** |
| **DB構築後** | Webhook実装 | ⏳ 予定 |
| **DB構築後** | 統合テスト | ⏳ 予定 |
| **DB構築後** | 本番リリース | ⏳ 予定 |

---

## 🎯 VoiceDriveチームへのお願い

### 1. URL形式変更の確認

新しいURL形式（`https://medical-system.example.com/employees/{staffId}.jpg`）で問題ないか、ご確認ください。

### 2. 調整会議のキャンセル

10/30（水）15:00の調整会議は**不要**となりました。申し訳ございません。

### 3. 今後のスケジュール確認

DB構築後にWebhook実装・統合テストを実施する予定です。具体的な日程は、DB構築の見通しが立ち次第、改めてご連絡いたします。

---

## 💰 コスト試算（修正版）

### 医療システム側コスト

#### 開発費

| 作業項目 | 工数 | 単価 | 小計 |
|---------|------|------|------|
| ~~CloudFront設定~~ | ~~1日~~ | - | ~~¥40,000~~ |
| Public Folder設定 | **0.5時間** | ¥40,000/日 | **¥2,500** |
| 共通DBテーブル拡張 | 0.5日 | ¥40,000/日 | ¥20,000 |
| Webhook実装（3種類） | 2.5日 | ¥40,000/日 | ¥100,000 |
| リトライ機構実装 | 1日 | ¥40,000/日 | ¥40,000 |
| 統合テスト | 1日 | ¥40,000/日 | ¥40,000 |
| 本番移行作業 | 1日 | ¥40,000/日 | ¥40,000 |
| **医療側合計** | **6.5日** | - | **¥242,500** |

**削減額**: ¥280,000 → ¥242,500（**¥37,500削減**）

#### 運用費（月額）

| 項目 | 旧構成 | 新構成 | 削減額 |
|------|--------|--------|--------|
| S3 + CloudFront | ¥272/月 | ¥0 | ¥272/月 |
| Lightsail 80ドル | $80（¥12,000） | $80（¥12,000） | ¥0 |
| **合計** | **¥12,272/月** | **¥12,000/月** | **¥272/月** |

**年間削減額**: ¥272 × 12ヶ月 = **¥3,264/年**

### プロジェクト全体コスト

| チーム | 開発費（旧） | 開発費（新） | 削減額 |
|--------|------------|------------|--------|
| 医療システム | ¥280,000 | **¥242,500** | ¥37,500 |
| VoiceDrive | ¥550,000 | **¥550,000** | ¥0 |
| **合計** | **¥830,000** | **¥792,500** | **¥37,500** |

**運用費**: ¥272/月 → **¥0/月**（年間¥3,264削減）

---

## 📞 問い合わせ先

本変更について、ご不明点やご懸念がございましたら、お気軽にお問い合わせください。

**連絡先**:
- Slack: `#phase2-photo-integration`
- Email: medical-team@example.com
- 担当: 医療システムチームリーダー

---

## ✅ 変更のメリット（まとめ）

| 観点 | メリット |
|------|---------|
| **コスト** | 開発費¥37,500削減、運用費¥272/月削減 |
| **運用** | AWS Management Console不要、設定作業3時間削減 |
| **セキュリティ** | Lightsail単一環境で管理が簡単 |
| **パフォーマンス** | 日本国内500名規模には十分 |
| **実装** | Next.js標準機能、追加ライブラリ不要 |

---

## 📚 関連ドキュメント

1. **実装ガイド**（医療システム側）
   - `docs/Phase2_Lightsail_Public_Folder_Setup_Guide.md`
   - 詳細な実装手順、トラブルシューティング

2. **旧CloudFront設定手順書**（参考・不使用）
   - `docs/Phase2_CloudFront_Setup_Guide.md`
   - キャンセルされた構成の詳細

3. **Webhook送信ユーティリティ**（既存）
   - `src/lib/webhooks/phase2-photo-webhook.ts`
   - DB構築後に使用予定

---

VoiceDriveチーム様

今回の構成変更により、コスト削減と運用簡素化を実現しつつ、日本国内500名規模の利用には十分なパフォーマンスを確保できると確信しております。

VoiceDrive側の実装への影響は軽微（URL形式のみ変更）ですが、ご不明点がございましたら、いつでもお問い合わせください。

引き続き、よろしくお願い申し上げます。

---

**発信元**: 医療職員カルテシステム開発チーム
**プロジェクトリーダー**: [氏名]
**バックエンドエンジニア**: [氏名]

**連絡先**:
- Slack: `#phase2-photo-integration`
- Email: medical-team@example.com

**発信日**: 2025年10月21日

---

**END OF DOCUMENT**
