# Phase 6 Phase 3 グラフ表示機能 実装計画書

**作成日**: 2025年10月20日（日）21:30
**バージョン**: 1.0.0
**担当**: 医療職員管理システム開発チーム
**対象**: Phase 6 期限到達判断履歴機能 - Phase 3

---

## 1. Phase 3 実装概要

### 1.1 目的
Phase 2で実装したデータ表示機能に、視覚的なグラフ表示機能を追加し、LEVEL_14-18の管理者が判断履歴の傾向を直感的に把握できるようにする。

### 1.2 実装スコープ
- ✅ **到達率分布グラフ**（棒グラフ）
- ✅ **判断タイプ分布グラフ**（円グラフ）
- ✅ **時系列推移グラフ**（折れ線グラフ）
- ✅ **レスポンシブデザイン**（モバイル対応）

### 1.3 使用技術
- **グラフライブラリ**: Recharts 2.x
- **UI**: Tailwind CSS
- **言語**: TypeScript
- **フレームワーク**: Next.js 14（App Router）

---

## 2. グラフ仕様

### 2.1 到達率分布グラフ（Bar Chart）

#### 目的
到達率の分布を視覚化し、どの到達率範囲で判断が多いかを把握する。

#### 表示内容
| 到達率範囲 | カウント |
|-----------|---------|
| 0-50% | 2件 |
| 51-100% | 2件 |
| 101-150% | 1件 |
| 151-200% | 1件 |
| 201-300% | 1件 |
| 301-500% | 2件 |
| 501%+ | 1件 |

#### UI仕様
- **グラフタイプ**: 縦棒グラフ
- **X軸**: 到達率範囲
- **Y軸**: 件数
- **色**: グラデーション（低：赤 → 高：緑）
- **ツールチップ**: ホバー時に詳細表示

#### データ構造
```typescript
interface AchievementRateDistribution {
  range: string;          // "0-50%"
  count: number;          // 2
  percentage: number;     // 20.0
  color: string;          // "#ef4444"
}
```

---

### 2.2 判断タイプ分布グラフ（Pie Chart）

#### 目的
承認・ダウングレード・不採用の割合を視覚化する。

#### 表示内容
| 判断タイプ | 件数 | 割合 |
|-----------|------|------|
| 承認 | 6件 | 60% |
| ダウングレード | 2件 | 20% |
| 不採用 | 2件 | 20% |

#### UI仕様
- **グラフタイプ**: ドーナツ型円グラフ
- **色**:
  - 承認: `#10b981` (緑)
  - ダウングレード: `#f59e0b` (オレンジ)
  - 不採用: `#ef4444` (赤)
- **ラベル**: パーセンテージ表示
- **凡例**: 下部に配置

#### データ構造
```typescript
interface DecisionTypeDistribution {
  name: string;           // "承認"
  value: number;          // 6
  percentage: number;     // 60.0
  color: string;          // "#10b981"
}
```

---

### 2.3 時系列推移グラフ（Line Chart）

#### 目的
日別の判断件数推移を視覚化し、傾向を把握する。

#### 表示内容
| 日付 | 承認 | ダウングレード | 不採用 |
|------|------|---------------|--------|
| 9/20 | 1 | 1 | 1 |
| 9/24 | 0 | 1 | 0 |
| 9/26 | 1 | 0 | 0 |
| 9/30 | 1 | 0 | 0 |
| 10/5 | 1 | 0 | 1 |
| 10/12 | 1 | 0 | 0 |
| 10/15 | 1 | 0 | 0 |

#### UI仕様
- **グラフタイプ**: 3本の折れ線グラフ
- **X軸**: 日付（MM/DD形式）
- **Y軸**: 件数
- **色**:
  - 承認: `#10b981` (緑)
  - ダウングレード: `#f59e0b` (オレンジ)
  - 不採用: `#ef4444` (赤)
- **凡例**: 上部に配置
- **グリッド**: 表示

#### データ構造
```typescript
interface TimeSeriesData {
  date: string;           // "9/20"
  approved: number;       // 1
  downgraded: number;     // 1
  rejected: number;       // 1
  total: number;          // 3
}
```

---

## 3. コンポーネント設計

### 3.1 ファイル構成
```
src/app/reports/decision-history/
├── components/
│   ├── AchievementRateChart.tsx        - 到達率分布グラフ
│   ├── DecisionTypeChart.tsx           - 判断タイプ分布グラフ
│   ├── TimeSeriesChart.tsx             - 時系列推移グラフ
│   └── ChartsContainer.tsx             - グラフ統合コンテナ
├── hooks/
│   ├── useDecisionHistory.ts           - ✅ Phase 2で実装済み
│   └── useChartData.ts                 - グラフデータ生成フック
└── page.tsx                            - メインページ
```

### 3.2 コンポーネント詳細

#### 3.2.1 AchievementRateChart.tsx
```typescript
interface AchievementRateChartProps {
  data: ExpiredEscalationDecision[];
}

export function AchievementRateChart({ data }: AchievementRateChartProps) {
  const chartData = useMemo(() => {
    // 到達率範囲別に集計
    return calculateAchievementRateDistribution(data);
  }, [data]);

  return (
    <div className="bg-white p-6 rounded-lg shadow">
      <h3 className="text-lg font-semibold mb-4">到達率分布</h3>
      <ResponsiveContainer width="100%" height={300}>
        <BarChart data={chartData}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="range" />
          <YAxis />
          <Tooltip />
          <Bar dataKey="count" fill="#3b82f6" />
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
}
```

#### 3.2.2 DecisionTypeChart.tsx
```typescript
interface DecisionTypeChartProps {
  summary: ExpiredEscalationSummary;
}

export function DecisionTypeChart({ summary }: DecisionTypeChartProps) {
  const chartData = useMemo(() => {
    return [
      { name: '承認', value: summary.approvalCount, color: '#10b981' },
      { name: 'ダウングレード', value: summary.downgradeCount, color: '#f59e0b' },
      { name: '不採用', value: summary.rejectCount, color: '#ef4444' },
    ];
  }, [summary]);

  return (
    <div className="bg-white p-6 rounded-lg shadow">
      <h3 className="text-lg font-semibold mb-4">判断タイプ分布</h3>
      <ResponsiveContainer width="100%" height={300}>
        <PieChart>
          <Pie
            data={chartData}
            cx="50%"
            cy="50%"
            innerRadius={60}
            outerRadius={100}
            dataKey="value"
            label
          >
            {chartData.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={entry.color} />
            ))}
          </Pie>
          <Tooltip />
          <Legend />
        </PieChart>
      </ResponsiveContainer>
    </div>
  );
}
```

#### 3.2.3 TimeSeriesChart.tsx
```typescript
interface TimeSeriesChartProps {
  data: ExpiredEscalationDecision[];
}

export function TimeSeriesChart({ data }: TimeSeriesChartProps) {
  const chartData = useMemo(() => {
    // 日別に集計
    return calculateTimeSeriesData(data);
  }, [data]);

  return (
    <div className="bg-white p-6 rounded-lg shadow">
      <h3 className="text-lg font-semibold mb-4">判断推移（日別）</h3>
      <ResponsiveContainer width="100%" height={300}>
        <LineChart data={chartData}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis dataKey="date" />
          <YAxis />
          <Tooltip />
          <Legend />
          <Line type="monotone" dataKey="approved" stroke="#10b981" name="承認" />
          <Line type="monotone" dataKey="downgraded" stroke="#f59e0b" name="ダウングレード" />
          <Line type="monotone" dataKey="rejected" stroke="#ef4444" name="不採用" />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
```

#### 3.2.4 ChartsContainer.tsx
```typescript
interface ChartsContainerProps {
  decisions: ExpiredEscalationDecision[];
  summary: ExpiredEscalationSummary;
}

export function ChartsContainer({ decisions, summary }: ChartsContainerProps) {
  return (
    <div className="space-y-6 mt-8">
      {/* 2カラムレイアウト */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <AchievementRateChart data={decisions} />
        <DecisionTypeChart summary={summary} />
      </div>

      {/* 1カラムレイアウト */}
      <TimeSeriesChart data={decisions} />
    </div>
  );
}
```

---

## 4. ユーティリティ関数

### 4.1 useChartData.ts
```typescript
export function useChartData(decisions: ExpiredEscalationDecision[]) {
  // 到達率分布計算
  const achievementRateDistribution = useMemo(() => {
    const ranges = [
      { min: 0, max: 50, label: '0-50%' },
      { min: 51, max: 100, label: '51-100%' },
      { min: 101, max: 150, label: '101-150%' },
      { min: 151, max: 200, label: '151-200%' },
      { min: 201, max: 300, label: '201-300%' },
      { min: 301, max: 500, label: '301-500%' },
      { min: 501, max: 10000, label: '501%+' },
    ];

    return ranges.map((range) => {
      const count = decisions.filter(
        (d) => d.achievementRate >= range.min && d.achievementRate <= range.max
      ).length;

      return {
        range: range.label,
        count,
        percentage: (count / decisions.length) * 100,
      };
    });
  }, [decisions]);

  // 時系列データ計算
  const timeSeriesData = useMemo(() => {
    const dateMap = new Map<string, { approved: number; downgraded: number; rejected: number }>();

    decisions.forEach((d) => {
      const date = format(new Date(d.createdAt), 'M/d');
      if (!dateMap.has(date)) {
        dateMap.set(date, { approved: 0, downgraded: 0, rejected: 0 });
      }

      const entry = dateMap.get(date)!;
      if (d.decision === 'approve_at_current_level') entry.approved++;
      else if (d.decision === 'downgrade') entry.downgraded++;
      else if (d.decision === 'reject') entry.rejected++;
    });

    return Array.from(dateMap.entries())
      .map(([date, counts]) => ({
        date,
        ...counts,
        total: counts.approved + counts.downgraded + counts.rejected,
      }))
      .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  }, [decisions]);

  return {
    achievementRateDistribution,
    timeSeriesData,
  };
}
```

---

## 5. 実装スケジュール

### 5.1 Phase 3タイムライン（1.5営業日）

| 時間 | タスク | 担当 | 完了条件 |
|------|--------|------|---------|
| **10/20 21:30-22:00** | Recharts依存関係インストール | 開発チーム | package.json更新 |
| **10/20 22:00-22:30** | 到達率分布グラフ実装 | 開発チーム | AchievementRateChart.tsx完成 |
| **10/20 22:30-23:00** | 判断タイプ分布円グラフ実装 | 開発チーム | DecisionTypeChart.tsx完成 |
| **10/20 23:00-23:30** | 時系列推移グラフ実装 | 開発チーム | TimeSeriesChart.tsx完成 |
| **10/20 23:30-24:00** | グラフ統合UI実装 | 開発チーム | ChartsContainer.tsx完成 |
| **10/21 09:00-10:00** | レスポンシブデザイン調整 | 開発チーム | モバイル表示確認 |
| **10/21 10:00-11:00** | 動作確認・テスト | QA | 全グラフ正常表示 |
| **10/21 11:00** | GitHubプッシュ | 開発チーム | main/preview両方 |

---

## 6. 依存関係

### 6.1 追加パッケージ
```json
{
  "dependencies": {
    "recharts": "^2.10.3",
    "date-fns": "^3.0.0"  // ← 既存（Phase 2で追加済みの可能性）
  },
  "devDependencies": {
    "@types/recharts": "^1.8.29"
  }
}
```

### 6.2 インストールコマンド
```bash
npm install recharts date-fns
npm install -D @types/recharts
```

---

## 7. テストケース

### 7.1 グラフ表示テスト

| # | テストケース | 期待結果 |
|---|-------------|---------|
| 1 | 到達率分布グラフの表示 | 7つの範囲が正しく表示される |
| 2 | 判断タイプ円グラフの表示 | 承認60%、ダウングレード20%、不採用20%が表示される |
| 3 | 時系列推移グラフの表示 | 7日間のデータが正しく表示される |
| 4 | フィルタ適用時のグラフ更新 | フィルタ変更時にグラフが即座に更新される |
| 5 | モバイル表示 | 375px幅で正しく表示される |
| 6 | ツールチップ表示 | ホバー時に詳細情報が表示される |

### 7.2 データ精度テスト

| # | テストケース | 期待結果 |
|---|-------------|---------|
| 1 | 到達率範囲の正確性 | 各範囲に正しい件数が分類される |
| 2 | 判断タイプの合計 | 承認6 + ダウングレード2 + 不採用2 = 10 |
| 3 | 時系列データの日付順 | 古い順に並んでいる |
| 4 | パーセンテージ計算 | 合計が100%になる |

---

## 8. UI/UXガイドライン

### 8.1 色設計

#### 到達率分布グラフ
- **0-50%**: `#ef4444` (赤) - 低到達率
- **51-100%**: `#f59e0b` (オレンジ) - 中到達率
- **101-150%**: `#10b981` (緑) - 高到達率
- **151%+**: `#3b82f6` (青) - 超過達成

#### 判断タイプ
- **承認**: `#10b981` (緑)
- **ダウングレード**: `#f59e0b` (オレンジ)
- **不採用**: `#ef4444` (赤)

### 8.2 アクセシビリティ
- **コントラスト比**: WCAG AA基準準拠（4.5:1以上）
- **スクリーンリーダー**: aria-label追加
- **キーボード操作**: タブ移動対応

---

## 9. パフォーマンス最適化

### 9.1 メモ化
```typescript
const chartData = useMemo(() => {
  // 重い計算はメモ化
  return calculateChartData(decisions);
}, [decisions]);
```

### 9.2 レンダリング最適化
- `React.memo` でコンポーネントをメモ化
- `useMemo` でデータ計算をメモ化
- `useCallback` でイベントハンドラをメモ化

---

## 10. 既知の制限事項

### 10.1 データ件数
- **最小**: 1件以上（0件の場合は「データなし」表示）
- **最大**: 1000件まで（それ以上はページネーション推奨）

### 10.2 ブラウザ対応
- **推奨**: Chrome 90+, Firefox 88+, Safari 14+
- **非対応**: IE11（Next.js 14がIE非対応のため）

---

## 11. 次のフェーズ

### 11.1 Phase 4: エクスポート機能（予定）
- CSVエクスポート（0.5日）
- Excelエクスポート（0.5日）
- PDFエクスポート（1日、オプション）

### 11.2 Phase 5: 詳細機能（オプション）
- グラフ拡大表示モーダル
- カスタム日付範囲フィルタ
- グラフダウンロード（PNG/SVG）

---

## 12. 関連ドキュメント

- `Phase6_判断履歴機能_実装計画書_20251020.md` - 全体実装計画
- `Phase6_実装準備完了通知_20251020.md` - Phase 1完了報告
- `Phase6_Phase2_API統合実装報告_20251020.md` - Phase 2完了報告
- `mcp-shared/logs/phase6-test-data-20251020.json` - テストデータ

---

**Phase 3実装計画書 v1.0.0**
**作成日**: 2025年10月20日（日）21:30
**医療職員管理システム開発チーム**
