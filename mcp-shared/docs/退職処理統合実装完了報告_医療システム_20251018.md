# 退職処理統合実装完了報告 - 医療システム側

**文書番号**: MED-COMPLETE-RET-2025-1018-001
**作成日**: 2025年10月18日
**送信元**: 医療職員管理システムチーム
**送信先**: VoiceDriveチーム（職員カルテシステム）
**件名**: Phase 2（退職処理・緊急アカウント停止）実装完了のご報告

---

## 📋 実装完了サマリー

VoiceDriveチームの皆様

お疲れ様です。医療システムチームです。

Phase 2（退職処理・緊急アカウント停止統合）の医療システム側実装が完了しましたので、ご報告いたします。

---

## ✅ 実装完了項目

| # | 実装項目 | ファイル/エンドポイント | 状態 |
|---|---------|----------------------|------|
| 1 | Prismaスキーマ更新 | `prisma/schema.prisma` | ✅ 完了 |
| 2 | employee_account_status_history テーブル追加 | Prisma model | ✅ 完了 |
| 3 | ヘルスチェックAPI | `GET /api/health/status` | ✅ 完了 |
| 4 | Webhook受信（緊急停止） | `POST /api/webhooks/voicedrive-emergency-deactivation` | ✅ 完了 |
| 5 | Webhook受信（退職処理） | `POST /api/webhooks/voicedrive-retirement-process` | ✅ 完了 |
| 6 | Webhook送信ユーティリティ | `src/lib/webhookSender.ts` | ✅ 完了 |
| 7 | 承認サービス | `src/services/EmergencyDeactivationApprovalService.ts` | ✅ 完了 |
| 8 | 承認API | `POST /api/admin/emergency-deactivation/[id]/approve` | ✅ 完了 |
| 9 | 却下API | `POST /api/admin/emergency-deactivation/[id]/reject` | ✅ 完了 |
| 10 | 承認待ち一覧API | `GET /api/admin/emergency-deactivation/pending` | ✅ 完了 |

---

## 🔗 実装したエンドポイント一覧

### 1. ヘルスチェックAPI

**エンドポイント**: `GET /api/health/status`

**URL**: `https://medical-system.example.com/api/health/status`

**認証**: 不要

**レスポンス例**:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-18T10:30:00Z",
  "services": {
    "database": "healthy",
    "api": "healthy"
  }
}
```

**用途**: VoiceDrive Phase 3の自動同期機能で5分ごとに呼び出し

**実装ファイル**: [src/app/api/health/status/route.ts](src/app/api/health/status/route.ts:1)

---

### 2. Webhook受信エンドポイント（2つ）

#### Webhook 1: 緊急アカウント停止通知

**エンドポイント**: `POST /api/webhooks/voicedrive-emergency-deactivation`

**URL**: `https://medical-system.example.com/api/webhooks/voicedrive-emergency-deactivation`

**認証**: HMAC-SHA256署名検証

**リクエストヘッダー**:
```
Content-Type: application/json
X-VoiceDrive-Signature: <HMAC-SHA256署名>
X-VoiceDrive-Timestamp: <ISO 8601タイムスタンプ>
X-VoiceDrive-Source: voicedrive-system
```

**リクエストボディ例**:
```json
{
  "event": "account.emergency_deactivation",
  "timestamp": "2025-10-18T15:30:00Z",
  "source": "voicedrive",
  "data": {
    "deactivationId": "deact_abc123xyz",
    "targetEmployeeId": "EMP2024001",
    "targetUserName": "山田 花子",
    "executedBy": "user_admin",
    "executorEmployeeId": "EMP2020001",
    "executorName": "人事部長",
    "executorLevel": 15,
    "reason": "緊急退職",
    "timestamp": "2025-10-18T15:30:00Z",
    "isEmergency": true
  }
}
```

**処理内容**:
1. HMAC署名検証（5秒以内にレスポンス）
2. バックグラウンドで以下を実行:
   - 冪等性チェック（`voicedriveDeactivationId`で重複確認）
   - `Employee.status` → `'inactive'` に更新
   - `employee_account_status_history` に履歴記録

**実装ファイル**: [src/app/api/webhooks/voicedrive-emergency-deactivation/route.ts](src/app/api/webhooks/voicedrive-emergency-deactivation/route.ts:1)

---

#### Webhook 2: 退職処理通知

**エンドポイント**: `POST /api/webhooks/voicedrive-retirement-process`

**URL**: `https://medical-system.example.com/api/webhooks/voicedrive-retirement-process`

**認証**: HMAC-SHA256署名検証

**リクエストボディ例**（プロセス開始）:
```json
{
  "event": "retirement.process_started",
  "timestamp": "2025-10-18T15:35:00Z",
  "source": "voicedrive",
  "data": {
    "processId": "ret_xyz789",
    "employeeId": "EMP2024001",
    "employeeName": "山田 花子",
    "startedBy": "user_admin",
    "startedByName": "人事部長",
    "timestamp": "2025-10-18T15:35:00Z"
  }
}
```

**リクエストボディ例**（ステップ完了）:
```json
{
  "event": "retirement.step_completed",
  "timestamp": "2025-10-18T15:36:00Z",
  "source": "voicedrive",
  "data": {
    "processId": "ret_xyz789",
    "step": 1,
    "stepName": "account_deactivation",
    "completedAt": "2025-10-18T15:36:00Z"
  }
}
```

**リクエストボディ例**（プロセス完了）:
```json
{
  "event": "retirement.process_completed",
  "timestamp": "2025-10-18T15:40:00Z",
  "source": "voicedrive",
  "data": {
    "processId": "ret_xyz789",
    "employeeId": "EMP2024001",
    "completedAt": "2025-10-18T15:40:00Z"
  }
}
```

**処理内容**:
- `retirement.process_started` → 履歴記録（`status='retiring'`）
- `retirement.step_completed` → ログ出力のみ
- `retirement.process_completed` → `Employee.status='retired'`、履歴更新

**実装ファイル**: [src/app/api/webhooks/voicedrive-retirement-process/route.ts](src/app/api/webhooks/voicedrive-retirement-process/route.ts:1)

---

### 3. 事後承認API（3つ）

#### API 1: 承認実行

**エンドポイント**: `POST /api/admin/emergency-deactivation/[historyId]/approve`

**認証**: Level 14-17（人事部門）のみ

**リクエストボディ**:
```json
{
  "approvedBy": "EMP-HR-001",
  "approvedByName": "人事部長",
  "approvalComment": "承認します"
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "Emergency deactivation approved successfully"
}
```

**処理内容**:
1. `employee_account_status_history` の `approvedBy`, `approvedAt` を更新
2. VoiceDriveへWebhook送信（`account.status_changed` イベント）

**実装ファイル**: [src/app/api/admin/emergency-deactivation/[historyId]/approve/route.ts](src/app/api/admin/emergency-deactivation/[historyId]/approve/route.ts:1)

---

#### API 2: 却下（復元）

**エンドポイント**: `POST /api/admin/emergency-deactivation/[historyId]/reject`

**認証**: Level 14-17（人事部門）のみ

**リクエストボディ**:
```json
{
  "rejectedBy": "EMP-HR-001",
  "rejectedByName": "人事部長",
  "rejectionReason": "誤操作のため復元"
}
```

**処理内容**:
1. `Employee.status` を元の状態に戻す
2. 却下履歴を新規作成
3. VoiceDriveへWebhook送信（復元通知）

**実装ファイル**: [src/app/api/admin/emergency-deactivation/[historyId]/reject/route.ts](src/app/api/admin/emergency-deactivation/[historyId]/reject/route.ts:1)

---

#### API 3: 承認待ち一覧取得

**エンドポイント**: `GET /api/admin/emergency-deactivation/pending`

**認証**: Level 14-17（人事部門）のみ

**レスポンス例**:
```json
{
  "success": true,
  "count": 2,
  "data": [
    {
      "id": "hist_001",
      "employeeId": "EMP2024001",
      "voicedriveDeactivationId": "deact_abc123",
      "changedAt": "2025-10-18T15:30:00Z",
      "reason": "緊急退職",
      "isEmergencyChange": true,
      "approvalRequired": true,
      "approvedAt": null
    }
  ]
}
```

**実装ファイル**: [src/app/api/admin/emergency-deactivation/pending/route.ts](src/app/api/admin/emergency-deactivation/pending/route.ts:1)

---

## 🛠️ 実装したユーティリティ・サービス

### 1. Webhook署名検証ユーティリティ

**ファイル**: [src/lib/webhookVerifier.ts](src/lib/webhookVerifier.ts:1)

**機能**:
- `verifyWebhookSignature()` - HMAC-SHA256署名検証
- `verifyTimestamp()` - タイムスタンプ検証（リプレイ攻撃防止、デフォルト5分）

**使用例**:
```typescript
const isValid = verifyWebhookSignature(
  rawBody,
  signature,
  timestamp,
  process.env.VOICEDRIVE_WEBHOOK_SECRET
);
```

---

### 2. Webhook送信ユーティリティ

**ファイル**: [src/lib/webhookSender.ts](src/lib/webhookSender.ts:1)

**機能**:
- `generateWebhookSignature()` - HMAC-SHA256署名生成
- `sendWebhookToVoiceDrive()` - VoiceDriveへWebhook送信

**使用例**:
```typescript
await sendWebhookToVoiceDrive(
  `${voicedriveUrl}/api/webhook/staff-system/status-change`,
  'account.status_changed',
  { employeeId, previousStatus, newStatus, ... },
  process.env.VOICEDRIVE_WEBHOOK_SECRET
);
```

---

### 3. 承認サービス

**ファイル**: [src/services/EmergencyDeactivationApprovalService.ts](src/services/EmergencyDeactivationApprovalService.ts:1)

**機能**:
- `approveEmergencyDeactivation()` - 緊急処理の事後承認
- `rejectEmergencyDeactivation()` - 緊急処理の却下（復元）
- `getPendingEmergencyDeactivations()` - 承認待ち一覧取得

---

## 📊 データベーススキーマ

### employee_account_status_history テーブル

**Prismaモデル**: [prisma/schema.prisma:636-689](prisma/schema.prisma:636-689)

**主要カラム**:

| カラム名 | 型 | 説明 |
|---------|---|------|
| `id` | String | 主キー（cuid） |
| `employeeId` | String | 対象職員ID |
| `previousStatus` | String? | 変更前ステータス |
| `newStatus` | String | 変更後ステータス |
| `sourceSystem` | String | 変更元システム（'staff_medical_system' \| 'voicedrive_emergency'） |
| `isEmergencyChange` | Boolean | 緊急変更フラグ |
| `voicedriveDeactivationId` | String? | VoiceDrive EmergencyDeactivation.id |
| `voicedriveRetirementProcessId` | String? | VoiceDrive RetirementProcess.id |
| `changedBy` | String? | 変更実行者ID |
| `changedByName` | String? | 変更実行者名 |
| `approvalRequired` | Boolean | 承認が必要か（事後承認用） |
| `approvedBy` | String? | 承認者ID |
| `approvedByName` | String? | 承認者名 |
| `approvedAt` | DateTime? | 承認日時 |
| `reason` | String? | 変更理由 |
| `changedAt` | DateTime | 変更日時 |
| `syncedFromVoicedriveAt` | DateTime? | VoiceDriveから同期された日時 |

**インデックス**:
- `employeeId`
- `sourceSystem`
- `isEmergencyChange`
- `voicedriveDeactivationId`
- `changedAt`
- `approvedBy`

---

## 🔐 セキュリティ実装

### 1. HMAC-SHA256署名検証

**実装箇所**: 全Webhook受信エンドポイント

**検証ロジック**:
```typescript
const expectedSignature = crypto
  .createHmac('sha256', secret)
  .update(`${timestamp}.${payload}`)
  .digest('hex');

// タイミング攻撃防止
crypto.timingSafeEqual(
  Buffer.from(signature),
  Buffer.from(expectedSignature)
);
```

---

### 2. タイムスタンプ検証（リプレイ攻撃防止）

**有効期限**: 5分

**検証ロジック**:
```typescript
const webhookTime = new Date(timestamp).getTime();
const now = Date.now();
const age = now - webhookTime;

// 未来のタイムスタンプまたは5分以上古いタイムスタンプを拒否
return age >= 0 && age <= 5 * 60 * 1000;
```

---

### 3. 冪等性保証

**実装箇所**: Webhook受信エンドポイント

**チェックロジック**:
```typescript
const existing = await prisma.employeeAccountStatusHistory.findFirst({
  where: { voicedriveDeactivationId: deactivationId }
});

if (existing) {
  console.log('Already processed:', deactivationId);
  return; // 二重処理を回避
}
```

---

## 🧪 テスト状況

### ⚠️ 未実施項目

| # | テスト項目 | 理由 |
|---|----------|------|
| 1 | マイグレーション実行 | MySQLサーバー未起動 |
| 2 | 統合テスト | VoiceDriveチームとの調整待ち |
| 3 | Webhook送受信テスト | 統合テスト時に実施予定 |

---

## 📅 次のステップ

### 医療システムチーム

1. **即座に実施**:
   - [x] 実装完了報告書作成 ✅
   - [ ] MySQLサーバー起動
   - [ ] Prismaマイグレーション実行
   - [ ] テストデータ投入（`mcp-shared/docs/TestData_EmergencyRetirement_20251018.sql`）

2. **VoiceDriveチームからの共有待ち**:
   - [ ] Webhookシークレット受領（ステージング環境、本番環境）
   - [ ] 統合テスト手順書受領
   - [ ] 統合テスト準備会議（10/28予定）

3. **統合テスト（10/31-11/2予定）**:
   - [ ] Webhook送受信確認
   - [ ] 冪等性確認
   - [ ] エラーハンドリング確認
   - [ ] セキュリティ確認（署名検証、タイムスタンプ検証）

---

### VoiceDriveチーム

1. **環境変数共有**:
   - [ ] `VOICEDRIVE_WEBHOOK_SECRET` 生成・共有（ステージング、本番）
   - [ ] ステージング環境URL共有

2. **Phase 3実装**（10/25-10/31予定）:
   - [ ] SyncQueueワーカー実装
   - [ ] ヘルスチェック機能実装（5分ごとに医療システムの `/api/health/status` を呼び出し）
   - [ ] 自動同期機能実装

3. **統合テスト準備**:
   - [ ] 統合テスト手順書作成
   - [ ] テストシナリオ作成
   - [ ] 統合テスト準備会議（10/28）

---

## 🔧 環境変数設定（医療システム側）

### .env ファイルに追加が必要な環境変数

```bash
# VoiceDrive Webhook シークレット（VoiceDriveチームから受領）
VOICEDRIVE_WEBHOOK_SECRET=<VoiceDriveチームから共有される秘密鍵>

# VoiceDrive Webhook URL（VoiceDriveチームから受領）
VOICEDRIVE_WEBHOOK_URL=<https://voicedrive-staging.example.com または本番URL>
```

**共有予定日**: 2025年10月24日（VoiceDriveチームから）

---

## 📎 関連ドキュメント

### 医療システム側ドキュメント

1. **質問・確認書**
   [mcp-shared/docs/医療システムからVoiceDriveへ_退職処理関連質問書_20251018.md](mcp-shared/docs/医療システムからVoiceDriveへ_退職処理関連質問書_20251018.md)

2. **テストデータSQL**
   [mcp-shared/docs/TestData_EmergencyRetirement_20251018.sql](mcp-shared/docs/TestData_EmergencyRetirement_20251018.sql)

3. **テーブル定義SQL**
   [mcp-shared/docs/EmployeeAccountStatusHistory_TableDefinition_20251018.sql](mcp-shared/docs/EmployeeAccountStatusHistory_TableDefinition_20251018.sql)

---

### VoiceDriveチーム側ドキュメント

1. **VoiceDriveチームからの回答書**
   受領日: 2025年10月18日
   文書番号: ANS-2025-1018-001

2. **Phase 2実装完了報告書**（VoiceDrive側）
   [mcp-shared/docs/Phase2_Webhook連携実装完了_20251018.md](mcp-shared/docs/Phase2_Webhook連携実装完了_20251018.md)

3. **マスタープラン**
   [mcp-shared/docs/EmergencyAccountDeactivation_Master_Plan_VoiceDrive_20251010.md](mcp-shared/docs/EmergencyAccountDeactivation_Master_Plan_VoiceDrive_20251010.md)

---

## 💬 連絡先

ご不明点、ご質問等ございましたら、以下までお気軽にお問い合わせください：

- **医療システムチーム**: medical-team@example.com
- **担当者**: 医療システム開発担当
- **Slackチャンネル**: `#medical-system-voicedrive-integration`
- **MCP共有フォルダ**: `mcp-shared/docs/`

---

## 🙏 謝辞

VoiceDrive開発チーム様

日頃よりVoiceDrive開発にご協力いただき、誠にありがとうございます。

Phase 2実装が完了し、統合テストに向けて準備が整いました。両チームの緊密な連携により、医療現場の業務継続性を支える重要な機能が実現できると確信しております。

統合テスト（10/31-11/2予定）に向けて、引き続きご協力をお願いいたします。

---

**医療職員管理システムチーム**
**作成日**: 2025年10月18日
**文書番号**: MED-COMPLETE-RET-2025-1018-001

---

**以上、よろしくお願いいたします。**
