# ProjectApproval マスタープラン更新提案

**文書番号**: MED-PLAN-2025-1011-001
**作成日**: 2025年10月11日
**差出人**: 医療職員管理システムチーム
**宛先**: VoiceDriveチーム
**件名**: ProjectApproval（プロジェクト承認）実装計画の提案

---

## 📋 概要

ProjectApproval（プロジェクト承認）ページのDB要件分析および医療システム確認を完了しました。

**結論**: **医療システム側の追加実装は不要**です。VoiceDrive内部データのみで完結します。

**参照ドキュメント**:
- [project-approval_DB要件分析_20251011.md](./project-approval_DB要件分析_20251011.md) - DB設計詳細
- [project-approval_医療システム確認結果_20251011.md](./project-approval_医療システム確認結果_20251011.md) - 確認結果

---

## ✅ 医療システム確認結果サマリー

### 医療システム側の対応
- ❌ **新規API実装**: 不要
- ❌ **新規テーブル作成**: 不要
- ❌ **既存API拡張**: 不要
- ✅ **既存データの利用**: User.permissionLevel（権限レベル）のみ使用（既存キャッシュ済み）

### データ責任分担

| 項目 | VoiceDrive | 医療システム |
|------|-----------|------------|
| プロジェクト投稿（Post） | ✅ 100% | ❌ なし |
| 投票データ（Vote） | ✅ 100% | ❌ なし |
| スコア計算 | ✅ 100% | ❌ なし |
| プロジェクトレベル判定 | ✅ 100% | ❌ なし |
| 承認履歴（ProjectApproval） | ✅ 100% | ❌ なし |
| 職員権限レベル | キャッシュのみ | ✅ マスタ管理 |

---

## 🎯 VoiceDrive側実装要件サマリー

### 新規テーブル（1個）

**ProjectApproval（プロジェクト承認履歴）**
- プロジェクト承認・却下・保留の履歴記録
- 承認者情報のスナップショット保存
- 緊急介入フラグ管理

### 既存テーブル拡張（1個）

**Post（プロジェクトステータス拡張）**
- `approvalStatus`: 承認ステータス（pending/approved/rejected/on_hold/team_formation）
- `approvedAt`, `approvedBy`: 承認日時・承認者
- `rejectedAt`, `rejectedBy`, `rejectionReason`: 却下情報

### 複合インデックス（2個）

1. `Post`: `@@index([approvalStatus, createdAt])` - 承認待ちプロジェクト取得用
2. `ProjectApproval`: `@@index([postId, createdAt])` - 承認履歴時系列取得用

### API実装（6個）

1. **POST /api/project-approval/approve** - プロジェクト承認
2. **POST /api/project-approval/reject** - プロジェクト却下
3. **POST /api/project-approval/hold** - プロジェクト保留
4. **POST /api/project-approval/emergency-override** - 緊急介入（上位者専用）
5. **GET /api/project-approval/approvable** - 承認可能なプロジェクト一覧取得
6. **GET /api/project-approval/history/:postId** - プロジェクト承認履歴取得

---

## 📅 実装スケジュール提案

### Phase 1: DB・サービス層実装（2日間）

**Day 1**: 10/11金（予定）
- [x] DB要件分析書作成 ✅
- [x] 医療システム確認結果作成 ✅
- [ ] ProjectApprovalテーブル追加（Prisma schema更新）
- [ ] Post拡張フィールド追加（approvalStatus等）
- [ ] マイグレーション実行
- [ ] ProjectApprovalService 実装
  - approveProject()
  - rejectProject()
  - holdProject()
  - emergencyOverride()
  - getApprovableProjects()
- [ ] ユニットテスト作成（20ケース以上）

**Day 2**: 10/14月（予定）
- [ ] API実装（6エンドポイント）
- [ ] APIテスト（15ケース以上）

**成果物**:
- ✅ DB実装完了
- ✅ サービス層実装完了
- ✅ API実装完了
- ✅ ユニットテスト合格
- ✅ API統合テスト合格

---

### Phase 2: フロントエンド統合（1日間）

**Day 3**: 10/15火（予定）
- [ ] ProjectApprovalPage.tsx 修正
  - デモデータ削除（`getDemoPosts()` → API呼び出し）
- [ ] useProjectApproval() カスタムフック作成
- [ ] エラーハンドリング実装
- [ ] 確認ダイアログ実装（却下理由入力、緊急介入警告）
- [ ] 通知・トースト実装

**成果物**:
- ✅ フロントエンド実装完了
- ✅ API統合完了
- ✅ エラーハンドリング完了

---

### Phase 3: テスト・デプロイ（1日間）

**Day 4**: 10/16水（予定）
- [ ] 統合テスト（E2E）
  - 承認フロー
  - 却下フロー
  - 緊急介入フロー
  - 権限チェック
  - プロジェクトレベル別表示
- [ ] 監査ログ確認
  - PROJECT_APPROVED（severity: high）
  - PROJECT_REJECTED（severity: medium）
  - PROJECT_EMERGENCY_OVERRIDE（severity: critical）
- [ ] パフォーマンステスト
  - 承認可能プロジェクト一覧取得: < 500ms
  - プロジェクト承認処理: < 300ms
- [ ] 本番デプロイ

**成果物**:
- ✅ E2Eテスト合格
- ✅ 監査ログ動作確認
- ✅ パフォーマンス基準達成
- ✅ 本番デプロイ完了

---

## 🎯 実装優先度

### 🔴 最高優先度（必須）
1. **ProjectApprovalテーブル作成** - 承認履歴記録の基盤
2. **Post拡張フィールド追加** - 承認ステータス管理
3. **複合インデックス追加** - パフォーマンス最適化
4. **ProjectApprovalService実装** - ビジネスロジック実装
5. **API実装** - フロントエンドとの連携
6. **権限チェックロジック** - セキュリティ確保
7. **監査ログ記録** - コンプライアンス対応

### 🟠 高優先度（推奨）
1. **useProjectApprovalフック** - フロントエンド統合
2. **確認ダイアログ** - UX向上
3. **エラーハンドリング** - 堅牢性向上
4. **パフォーマンステスト** - 品質保証

### 🟡 中優先度（将来拡張）
1. **高度なフィルタリング** - 日付範囲、ソート順指定
2. **プロジェクトタグ別集計** - 統計情報強化
3. **アクティビティタイムライン** - 時系列追跡

---

## 🔍 主要機能詳細

### プロジェクトレベル判定

| プロジェクトレベル | スコア範囲 | 承認者権限レベル | 承認者役職 | 説明 |
|------------------|-----------|----------------|-----------|------|
| PENDING | 0-99点 | 6 | 主任 | アイデア検討中 |
| TEAM | 100-199点 | 8 | 師長・科長 | チームプロジェクト（5-15名） |
| DEPARTMENT | 200-399点 | 10 | 部長・医局長 | 部署プロジェクト（15-30名） |
| FACILITY | 400-799点 | 11 | 事務長 | 施設プロジェクト（30-60名） |
| ORGANIZATION | 800点以上 | 13 | 院長・施設長 | 法人プロジェクト（60名以上） |
| STRATEGIC | 戦略指定 | 18 | 理事長 | 戦略プロジェクト（理事長承認） |

**⚠️ 2025-10-11更新**: 組織階層に合わせて承認者レベルを調整（VoiceDrive側変更）

### スコア計算ロジック

投票重み付け：
- 強く賛成 (`strongly-support`): +2
- 賛成 (`support`): +1
- 中立 (`neutral`): 0
- 反対 (`oppose`): -1
- 強く反対 (`strongly-oppose`): -2

### 権限ベース承認ロジック

**承認者（Approver）**:
- `userLevel === responsibility.targetPermissionLevel`
- プロジェクト開始を承認できる
- バッジ: "✅ 承認者"

**上位監督者（Supervisor）**:
- `userLevel > responsibility.targetPermissionLevel && (userLevel - targetLevel) <= 2`
- アドバイス可能、緊急介入可能
- バッジ: "👁️ 上位者（閲覧・アドバイス）"

---

## 📊 テスト要件サマリー

### ユニットテスト（20ケース以上）

**ProjectApprovalService**:
- ✅ 承認処理（5ケース）
- ✅ 却下処理（5ケース）
- ✅ 保留処理（3ケース）
- ✅ 緊急介入（4ケース）
- ✅ スコア計算（3ケース）

### API統合テスト（15ケース以上）

**6エンドポイント**:
- ✅ 正常系テスト（6ケース）
- ✅ 異常系テスト（6ケース）
- ✅ 権限チェックテスト（3ケース）

### E2Eテスト（5シナリオ以上）

- ✅ 承認フロー
- ✅ 却下フロー（理由入力含む）
- ✅ 緊急介入フロー（警告ダイアログ含む）
- ✅ 権限チェック（各レベル）
- ✅ プロジェクトレベル別表示

---

## ⚠️ リスク・注意事項

### 1. パフォーマンスリスク（優先度: 🟠 高）

**リスク**: 複合インデックス未追加の場合、データ増加に伴いクエリ速度が著しく低下

**対策**:
- ✅ 必ず複合インデックスを追加してから実装開始
- ✅ 実装後にEXPLAIN ANALYZEで実行計画確認
- ✅ 本番環境でパフォーマンス監視設定

### 2. 権限チェック漏れリスク（優先度: 🔴 最高）

**リスク**: 権限チェックが不十分で、権限外のユーザーがプロジェクトを承認できてしまう

**対策**:
- ✅ 全てのAPI呼び出しで権限チェックを実施
- ✅ フロントエンドとバックエンドの両方で権限チェック
- ✅ 各権限レベルでの徹底テスト

### 3. 監査ログ欠損リスク（優先度: 🟠 高）

**リスク**: 承認・却下・緊急介入の監査ログが記録されない

**対策**:
- ✅ 全てのアクションで監査ログを記録
- ✅ トランザクション内で監査ログも記録
- ✅ 監査ログ記録の統合テスト

### 4. データ整合性リスク（優先度: 🟠 高）

**リスク**: Post更新とProjectApproval作成が同時に成功/失敗しない

**対策**:
- ✅ 必ずトランザクション処理を使用
- ✅ トランザクション失敗時のロールバック確認
- ✅ データ整合性のテスト

---

## 📄 関連ドキュメント

### DB設計・要件定義
1. [project-approval_DB要件分析_20251011.md](./project-approval_DB要件分析_20251011.md) - DB設計詳細
2. [project-approval_医療システム確認結果_20251011.md](./project-approval_医療システム確認結果_20251011.md) - 確認結果

### 暫定マスターリスト
3. 暫定マスターリスト（ユーザー提供）- 実装タスクリスト

### 医療システム
4. [共通DB構築後_作業再開指示書_20250928.md](../../docs/共通DB構築後_作業再開指示書_20250928.md) - 医療システム側マスタープラン

---

## 💡 VoiceDriveチームへのお願い

### 1. 実装スケジュールの確認
提案した4日間の実装スケジュールに問題がないか、ご確認ください。

### 2. DB設計の承認
ProjectApprovalテーブル設計とPost拡張フィールド設計をご承認ください。

### 3. 権限ベース承認ロジックの確認
プロジェクトレベル判定基準と権限判定パターンに問題がないか、ご確認ください。

### 4. 監査ログ重要度の確認
各アクションの`severity`設定が適切か、ご確認ください。

---

## ✅ 次のアクション

### VoiceDriveチーム側
1. **10/11（金）**: 実装計画の確認・承認
2. **10/11（金）**: DB設計の確認・承認
3. **10/12（土）**: 実装開始（承認後）
4. **10/16（水）**: 本番デプロイ

### 医療システムチーム側
1. **10/11（金）**: VoiceDriveチームからの承認待ち
2. **承認後**: 実装支援（必要に応じて）
3. **統合テスト時**: 権限レベルデータの提供（既存キャッシュ）

---

## 📞 連絡先

### VoiceDriveチーム
- **MCPサーバー共有フォルダ**: `mcp-shared/docs/`
- **質問対応**: プロジェクト関連質問書形式

### 医療システムチーム
- **MCPサーバー共有フォルダ**: `mcp-shared/docs/`
- **質問対応**: 平日 9:00-18:00

---

## 🎊 まとめ

### 完了した作業
1. ✅ DB要件分析完了
2. ✅ 医療システム確認完了（実装不要を確認）
3. ✅ 実装計画の明確化
4. ✅ テスト要件の整理
5. ✅ リスク分析・対策提案

### これにより実現できること
- ✅ VoiceDrive単独で実装可能
- ✅ 医療システム側の追加作業なし
- ✅ 4日間で実装完了可能
- ✅ 監査ログによるコンプライアンス対応

### 次のマイルストーン
- **10/11（金）**: VoiceDriveチームの承認待ち
- **10/12（土）**: 実装開始（承認後）
- **10/16（水）**: 本番デプロイ予定

---

**文書終了**

最終更新: 2025年10月11日
バージョン: 1.0
次回アクション: VoiceDriveチームからの実装計画承認（10/11）
