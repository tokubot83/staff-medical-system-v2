# 面談サマリ送信機能 受信体制確認書

**作成日**: 2025年10月2日
**送信元**: 医療システムチーム（Claude Code）
**宛先**: VoiceDriveチーム
**件名**: 面談サマリ送信機能の受信API実装状況確認

---

## 📋 確認の目的

医療システム側で実装済みの「面談サマリ送信機能」について、VoiceDrive側の受信体制（APIエンドポイント）が実装されているかを確認するための書類です。

---

## ✅ 医療システム側の実装状況（送信側）

### 実装完了項目

#### 1. 面談サマリ送信機能
- **実装ファイル**: `src/services/voicedriveIntegrationService.ts` (264-307行目)
- **メソッド**: `sendInterviewResult()`
- **送信先エンドポイント**: `/sync/interview-results`
- **HTTPメソッド**: POST
- **認証方式**: Bearer Token

#### 2. 自動送信トリガー
- **実装ファイル**: `src/lib/interview-bank/services/bank-service.ts` (302-354行目)
- **トリガー**: 面談完了時（`completeInterview`メソッド内）
- **条件**: `voiceDriveRequestId`が存在する場合に自動送信

#### 3. 送信データ構造

```typescript
{
  requestId: string,              // VoiceDrive側の申込ID
  interviewId: string,            // 医療システム側の面談ID
  completedAt: Date,              // 面談実施日時
  duration: number,               // 実施時間（分）

  // 面談内容
  summary: string,                // 面談サマリ
  keyPoints: string[],            // 重要ポイント（配列）
  actionItems: Array<{            // アクションアイテム
    description: string,
    dueDate?: Date
  }>,

  // フォローアップ情報
  followUpRequired: boolean,      // フォローアップ要否
  followUpDate?: Date,            // フォローアップ予定日

  // 職員フィードバック
  feedbackToEmployee: string,     // 職員向けフィードバック文

  // 次回推奨事項
  nextRecommendations: {
    suggestedNextInterview: Date,
    suggestedTopics: string[]
  }
}
```

---

## ❓ VoiceDrive側への確認事項

### 必須確認項目

#### 1. 受信APIエンドポイントの実装状況
- [ ] `/sync/interview-results` エンドポイントは実装済みですか？
- [ ] HTTPメソッド: POST に対応していますか？
- [ ] Bearer Token認証に対応していますか？

#### 2. データ受信処理の実装状況
- [ ] 上記の送信データ構造を受信できますか？
- [ ] 受信後のデータ保存処理は実装済みですか？
- [ ] データベーステーブルは準備されていますか？

#### 3. エラーハンドリング
- [ ] 受信エラー時のレスポンス仕様は定義されていますか？
- [ ] リトライ機構は必要ですか？（医療システム側で実装可能）

#### 4. 統合テスト準備
- [ ] 受信テスト用の環境は準備されていますか？
- [ ] テストデータでの疎通確認は可能ですか？

---

## 🔧 技術仕様詳細

### 送信処理フロー

```
1. 医療システムで面談実施・完了
   ↓
2. completeInterview() メソッド呼び出し
   ↓
3. voiceDriveRequestId の有無をチェック
   ↓
4. sendResultToVoiceDrive() 自動実行
   ↓
5. VoiceDriveIntegrationService.sendInterviewResult() 実行
   ↓
6. POST /sync/interview-results へ送信
   ↓
7. VoiceDrive側でレスポンス返却（response.ok で判定）
```

### 実装コード参照

**送信処理メインロジック**:
```typescript
// src/services/voicedriveIntegrationService.ts (264-307行目)
static async sendInterviewResult(
  interviewData: InterviewData,
  requestId: string
): Promise<boolean> {
  try {
    const payload = { /* 上記データ構造 */ };

    const response = await this.callMCPServer('/sync/interview-results', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.mcpConfig.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    return response.ok;  // VoiceDrive側のレスポンス判定
  } catch (error) {
    console.error('Failed to send interview result:', error);
    return false;
  }
}
```

**自動送信トリガー**:
```typescript
// src/lib/interview-bank/services/bank-service.ts (349-351行目)
// VoiceDriveに結果を送信
if (result.generationParams.voiceDriveRequestId) {
  await this.sendResultToVoiceDrive(interviewId);
}
```

---

## 🚨 未実装の場合の影響

もしVoiceDrive側の受信APIが未実装の場合:

### 現在の影響
- 医療システム側で面談サマリ送信は試みられるが、受信エラーが発生
- `response.ok = false` となり、送信失敗として記録される
- 面談データは医療システム側にのみ保存され、VoiceDrive側には未連携

### 必要な対応
1. VoiceDrive側で受信APIエンドポイントを実装
2. データベーステーブル作成（面談サマリ保存用）
3. 統合テスト実施（疎通確認）

---

## 📊 推奨される対応フロー

### VoiceDrive側が未実装の場合

#### Phase 1: 受信API実装（VoiceDriveチーム）
- [ ] `/sync/interview-results` エンドポイント作成
- [ ] POSTリクエスト受信処理
- [ ] Bearer Token認証処理
- [ ] データベース保存処理

#### Phase 2: テーブル設計（VoiceDriveチーム）
```sql
-- 想定テーブル例
CREATE TABLE interview_results (
  id VARCHAR(255) PRIMARY KEY,
  request_id VARCHAR(255) NOT NULL,
  interview_id VARCHAR(255) NOT NULL,
  completed_at TIMESTAMP,
  duration INT,
  summary TEXT,
  key_points JSON,
  action_items JSON,
  follow_up_required BOOLEAN,
  follow_up_date TIMESTAMP,
  feedback_to_employee TEXT,
  next_recommendations JSON,
  received_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (request_id) REFERENCES interview_requests(id)
);
```

#### Phase 3: 統合テスト（両チーム協力）
- [ ] テスト用面談データ作成（医療システム側）
- [ ] 送信→受信→保存の一連フローテスト
- [ ] エラーケーステスト
- [ ] パフォーマンステスト

---

## 🎯 期待される回答

VoiceDriveチームからの回答をお待ちしています：

### 回答形式（mcp-shared/docs/に返信ファイル作成）
```markdown
# 面談サマリ受信体制_実装状況回答_20251002.md

## 実装状況
- [ ] 実装済み
- [ ] 未実装（実装予定あり）
- [ ] 未実装（仕様検討中）

## 実装済みの場合
- エンドポイントURL:
- 認証方式:
- テスト環境URL:
- 統合テスト希望日:

## 未実装の場合
- 実装予定日:
- 実装担当者:
- 技術仕様確認事項:
```

---

## 📞 連絡先・次のアクション

### 医療システムチーム側の対応
- この確認書を `mcp-shared/docs/` に配置
- VoiceDriveチームからの回答待ち
- 必要に応じて実装サポート・技術相談対応可

### VoiceDriveチーム側への依頼
1. 上記確認事項への回答（mcp-shared/docs/に返信ファイル作成）
2. 受信API実装状況の詳細報告
3. 統合テスト日程の調整（実装済みの場合）

---

**重要**: この確認は面談機能の完全な連携に必須です。早急な確認・回答をお願いいたします。

---

*作成: 医療システムチーム（Claude Code）*
*ファイル配置: `mcp-shared/docs/面談サマリ送信機能_受信体制確認書_20251002.md`*
