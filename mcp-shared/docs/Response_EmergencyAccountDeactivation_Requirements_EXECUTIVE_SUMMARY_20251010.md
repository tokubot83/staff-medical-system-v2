# アカウント緊急無効化機能 連携要件確認書（エグゼクティブサマリー）

**文書番号**: RES-2025-1010-001-ES
**作成日**: 2025年10月10日
**送信元**: VoiceDriveチーム（職員カルテシステム）
**送信先**: 医療職員管理システムチーム
**回答期限**: 2025年10月24日（2週間以内）

---

## 📋 30秒サマリー

**目的**: 医療システム障害時の業務継続性確保
**機能**: 人事部門（レベル14-17）によるアカウント緊急停止
**依頼**: Webhook連携実装（3件）+ 仕様確認（3件）
**期間**: 実装 1-2週間、統合テスト 1週間、本番リリース 4週間後

---

## 🔗 医療システムチームへの依頼内容（3件）

### 依頼1: Webhook受信エンドポイント実装

**URL**: `POST /api/webhooks/voicedrive-emergency-deactivation`

**処理内容**:
```typescript
// 1. HMAC-SHA256署名検証
// 2. Employee.accountStatus を 'inactive' に更新
// 3. 確認Webhookを VoiceDrive に送信
```

**所要時間**: 2-3日

**詳細**: 添付資料セクション3.1参照

---

### 依頼2: 確認Webhook送信実装

**URL**: `POST https://voicedrive.ai/api/webhooks/account-deactivation-confirmed`

**処理内容**:
```typescript
// アカウント停止処理完了後、VoiceDriveに確認通知を送信
```

**所要時間**: 1-2日

**詳細**: 添付資料セクション3.2参照

---

### 依頼3: ヘルスチェックAPI実装

**URL**: `GET /api/health/status`

**レスポンス例**:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-10T15:30:00Z"
}
```

**所要時間**: 1日

**詳細**: 添付資料セクション3.3参照

---

## ❓ 確認事項（3件）

### 確認1: アカウント無効化の処理方針

VoiceDriveから緊急停止通知を受けた場合、どの処理を行いますか？

**選択肢**:

| Option | 処理内容 | VoiceDrive推奨 |
|--------|---------|---------------|
| **A** | `accountStatus`のみ更新<br>（`isRetired`は手動確認後） | 🟢 推奨 |
| **B** | `accountStatus` + `isRetired` 両方更新 | - |
| **C** | カスタム処理 | - |

**推奨理由（Option A）**: 緊急停止≠退職を明確化、誤停止時の復旧が容易

---

### 確認2: Webhookリトライポリシー

**VoiceDrive側の方針**:
- リトライ回数: 3回
- リトライ間隔: 1分、5分、15分
- タイムアウト: 30秒
- 失敗時: キューに蓄積、医療システム復旧後に自動送信

**質問**: 医療システム側のリトライ方針はどうしますか？

---

### 確認3: HMAC署名仕様

**VoiceDrive側の実装**:
- アルゴリズム: HMAC-SHA256
- シークレットキー管理: 環境変数（AWS Secrets Manager）

**質問**:
1. HMAC-SHA256で問題ありませんか？
2. シークレットキーの共有方法は？
   - [ ] Slackで暗号化して送信
   - [ ] AWS Secrets Manager経由
   - [ ] その他（              ）

---

## 📅 スケジュール

| Week | VoiceDrive | 医療システム | マイルストーン |
|------|-----------|-------------|--------------|
| **Week 1**<br>10/11-10/17 | Phase 1実装<br>（DB移行） | 🔴 確認事項回答<br>（10/17まで） | 仕様確定 |
| **Week 2**<br>10/18-10/24 | Phase 2準備 | 🔴 依頼1-3実装 | Webhook実装完了 |
| **Week 3**<br>10/25-10/31 | Phase 2-3実装 | 統合テスト協力 | 統合テスト合格 |
| **Week 4**<br>11/1-11/7 | 統合テスト・リリース | 本番デプロイ | 本番リリース |

---

## 📊 データフロー（概要）

```
VoiceDrive                    医療システム
    │                              │
    │ ①緊急停止実行                 │
    │                              │
    │ ②Webhook送信                 │
    ├─────────────────────────────>│
    │  POST /api/webhooks/         │
    │  voicedrive-emergency-       │
    │  deactivation                │
    │                              │
    │                         ③Employee更新
    │                         ④履歴記録
    │                              │
    │ ⑤確認Webhook受信              │
    │<─────────────────────────────┤
    │  POST /api/webhooks/         │
    │  account-deactivation-       │
    │  confirmed                   │
    │                              │
    │ ⑥同期完了                     │
    │                              │
```

**医療システム障害時**: VoiceDrive側でキューに蓄積 → ヘルスチェック（5分ごと）→ 復旧検知 → 自動同期

---

## 📝 回答用テンプレート

以下をコピーしてご回答ください（**回答期限: 2025年10月24日**）：

```markdown
---
## 医療システムチームからの回答

**回答者**: ___________
**回答日**: ___________

### 🔴 依頼内容への回答

**依頼1: Webhook受信エンドポイント実装**
- [ ] 実装可能
- [ ] 実装不可（理由: _________________）
- 実装担当者: ___________
- 完了予定日: ___/___/___

**依頼2: 確認Webhook送信実装**
- [ ] 実装可能
- [ ] 実装不可（理由: _________________）
- 実装担当者: ___________
- 完了予定日: ___/___/___

**依頼3: ヘルスチェックAPI実装**
- [ ] 実装可能
- [ ] 実装不可（理由: _________________）
- 実装担当者: ___________
- 完了予定日: ___/___/___

---

### ❓ 確認事項への回答

**確認1: アカウント無効化の処理方針**
- [ ] Option A: accountStatusのみ更新（VoiceDrive推奨）
- [ ] Option B: accountStatusとisRetired両方更新
- [ ] Option C: カスタム処理（詳細: _________________）

**確認2: Webhookリトライポリシー**
- リトライ回数: ___回
- リトライ間隔: _________________
- タイムアウト: ___秒

**確認3: HMAC署名仕様**
- [ ] HMAC-SHA256で問題なし
- [ ] 別のアルゴリズム希望（_________________）
- シークレットキー共有方法:
  - [ ] Slackで暗号化
  - [ ] AWS Secrets Manager
  - [ ] その他（_________________）

---

### 追加の質問・懸念事項
_________________________________________________________________
_________________________________________________________________

---

### 統合テスト協力可否
- [ ] ステージング環境でのテスト協力可能
- [ ] ステージング環境URL: _________________
- テスト実施可能日: ___/___/___

---
```

---

## 📞 連絡先

### VoiceDriveチーム
**Slack**: `#voicedrive-medical-system-integration`
**Email**: voicedrive-dev@example.com
**MCP共有フォルダ**: `mcp-shared/docs/`
**緊急連絡**: DM（24時間対応）

### 医療システムチーム（ご記入ください）
**プロジェクトリード**: ___________
**技術リード**: ___________
**緊急連絡先**: ___________

---

## 📎 添付資料

本エグゼクティブサマリーは要点のみを記載しています。技術詳細は以下の添付資料をご参照ください：

### 詳細版ドキュメント（37KB）
**ファイル**: `Response_EmergencyAccountDeactivation_Requirements_20251010.md`

**内容**:
- セクション1: プロジェクト背景
- セクション2: 利用シーン詳細
- セクション3: 依頼内容の技術仕様（3.1-3.3）
  - 3.1: Webhook受信エンドポイント実装（ペイロード仕様、実装例）
  - 3.2: 確認Webhook送信実装（実装例、エラーハンドリング）
  - 3.3: ヘルスチェックAPI実装（レスポンス仕様、使用例）
- セクション4: 確認事項の詳細説明
- セクション5: データフロー図
- セクション6: DB実装詳細（VoiceDrive側）
- セクション7: 推奨DB実装（医療システム側）
- セクション8: リスク分析と対策
- セクション9: よくある質問（FAQ）
- セクション10: テスト計画
- セクション11: 非機能要件

### その他参考資料
1. **VoiceDrive側マスタープラン**（52KB）
   `EmergencyAccountDeactivation_Master_Plan_VoiceDrive_20251010.md`

2. **schema.prisma更新提案書**（25KB）
   `Schema_Update_Proposal_EmergencyAccountDeactivation_20251010.md`

3. **成果物サマリー**（20KB）
   `Deliverables_Summary_EmergencyAccountDeactivation_20251010.md`

---

## ✅ 次のステップ

### 医療システムチーム様
1. **今週中（10/17まで）**: 確認事項（1-3）にご回答
2. **2週間以内（10/24まで）**: 依頼内容（1-3）の実装可否・スケジュール確定
3. **Week 2（10/18-24）**: 依頼1-3の実装開始
4. **Week 3（10/25-31）**: 統合テスト協力

### VoiceDriveチーム
1. **今週中（10/11-17）**: Phase 1実装（DB移行）
2. **Week 2（10/18-24）**: Phase 2準備（Webhook実装）
3. **Week 3（10/25-31）**: Phase 2-3実装（自動同期）
4. **Week 4（11/1-7）**: 統合テスト・本番リリース

---

## 🙏 謝辞

日頃より医療職員管理システムの開発にご尽力いただき、誠にありがとうございます。

本件は医療現場の業務継続性に直結する重要な機能です。貴チームのご協力により、より安全で信頼性の高いシステムを実現できると確信しております。

**回答期限**: 2025年10月24日（2週間以内）
**確認事項のみ**: 2025年10月17日（1週間以内）

ご不明点がございましたら、いつでもお気軽にお問い合わせください。

引き続きよろしくお願いいたします。

---

**VoiceDriveチーム（職員カルテシステム）**
**作成日**: 2025年10月10日
**文書番号**: RES-2025-1010-001-ES

---

**本文書はエグゼクティブサマリー版です。技術詳細は添付資料をご参照ください。**
