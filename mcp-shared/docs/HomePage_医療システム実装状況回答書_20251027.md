# HomePage統合に関する医療システム側実装状況回答書

**文書番号**: MED-RESP-2025-1027-004
**作成日**: 2025年10月27日
**作成者**: ClaudeCode（医療システムチーム）
**宛先**: VoiceDriveチーム
**件名**: HomePageに関する4つの確認事項への回答
**参照文書**:
- [HomePage_医療システム確認結果_20251027.md](./HomePage_医療システム確認結果_20251027.md)
- VoiceDriveチームからの質問（mcp-shared経由）

---

## 📋 エグゼクティブサマリー

VoiceDriveチームからの4つの確認事項に対する医療システム側の実装状況を報告します。

### 結論: ✅ **全て実装完了、HomePage連携準備完了**

| 質問 | 状態 | 詳細 |
|------|------|------|
| **質問1**: APIエンドポイント実装 | ✅ **完全実装済み** | Phase 1実装完了（2025年9月20日） |
| **質問2**: professionCategory提供 | ✅ **本日実装完了** | Phase 2.18で変換ロジック実装（2025年10月27日） |
| **質問3**: Webhook実装 | ✅ **完全実装済み** | Phase 3実装完了（2025年10月2日） |
| **質問4**: テーブル構造確認 | ✅ **全て存在** | Prisma schemaで確認済み |

---

## 質問1: APIエンドポイントの実装確認

### 回答: ✅ **両方とも実装済み**

以下のAPIエンドポイントは医療システム側で実装されています。

#### 1-1. 個別職員情報取得API

**エンドポイント**: `GET /api/v2/employees/:employeeId`

**実装状況**: ✅ **Phase 1実装済み**（2025年9月20日）

**実装箇所**: [src/app/api/v2/employees/[employeeId]/route.ts](../../src/app/api/v2/employees/[employeeId]/route.ts)

**認証方式**: Bearer Token（JWT）

**必要権限**: Level 99（システム管理者）

**レスポンス形式**:
```json
{
  "employeeId": "E001",
  "name": "山田太郎",
  "email": "yamada@example.com",
  "department": "医療療養病棟",
  "position": "看護師長",
  "professionCategory": "nursing",  // ← Phase 2.18で実装完了
  "facilityId": "tategami-hospital",
  "permissionLevel": 7,
  "accountType": "NURSE",
  "canPerformLeaderDuty": false,
  "parentId": "sup-001",
  "isActive": true,
  "isRetired": false,
  "retirementDate": null,
  "hireDate": "2020-04-01T00:00:00Z",
  "yearsOfService": 5.6,
  "updatedAt": "2025-10-27T10:00:00Z"
}
```

**テストステータス**: ✅ 単体テスト100%パス

---

#### 1-2. 全職員リスト取得API

**エンドポイント**: `GET /api/v2/employees`

**実装状況**: ✅ **Phase 1実装済み**（2025年9月20日）

**実装箇所**: [src/app/api/v2/employees/route.ts](../../src/app/api/v2/employees/route.ts)

**認証方式**: Bearer Token（JWT）

**必要権限**: Level 99（システム管理者）

**クエリパラメータ**:
- `updatedSince`: ISO 8601 DateTime（指定日時以降に更新された職員のみ取得）
- `page`: Number（ページ番号、デフォルト: 1）
- `limit`: Number（1ページあたりの件数、デフォルト: 100、最大: 500）
- `facilityId`: String（施設IDでフィルタ）
- `status`: String（'active', 'leave', 'retired'）

**レスポンス形式**:
```json
{
  "employees": [
    {
      "employeeId": "E001",
      "name": "山田太郎",
      "email": "yamada@example.com",
      "department": "医療療養病棟",
      "position": "看護師長",
      "professionCategory": "nursing",  // ← Phase 2.18で実装完了
      "facilityId": "tategami-hospital",
      "permissionLevel": 7,
      "accountType": "NURSE",
      "canPerformLeaderDuty": false,
      "parentId": "sup-001",
      "isActive": true,
      "isRetired": false,
      "retirementDate": null,
      "hireDate": "2020-04-01T00:00:00Z",
      "updatedAt": "2025-10-27T10:00:00Z"
    }
    // ... 他の職員データ
  ],
  "pagination": {
    "page": 1,
    "limit": 100,
    "totalCount": 245,
    "totalPages": 3,
    "hasNext": true
  }
}
```

**テストステータス**: ✅ 単体テスト100%パス

---

## 質問2: professionCategory フィールドの提供

### 回答: ✅ **本日実装完了**（Phase 2.18 - 2025年10月27日）

#### 実装内容

**変換関数実装箇所**:
- [src/app/api/v2/employees/[employeeId]/route.ts](../../src/app/api/v2/employees/[employeeId]/route.ts) 19-71行目
- [src/app/api/v2/employees/route.ts](../../src/app/api/v2/employees/route.ts) 19-71行目

**変換ロジック**: `Position.accountType` → `professionCategory`

#### サポートする professionCategory 値

| professionCategory | 説明 | 対応する accountType |
|-------------------|------|-------------------|
| `'nursing'` | 看護職 | NURSE, NURSE_MANAGER, NURSING_DIRECTOR, CARE_WORKER, CARE_MANAGER |
| `'medical'` | 医師 | DOCTOR, MEDICAL_DIRECTOR, PHARMACIST, RADIOLOGIST, LAB_TECHNICIAN |
| `'rehabilitation'` | リハビリ職 | THERAPIST, PHYSICAL_THERAPIST, OCCUPATIONAL_THERAPIST, SPEECH_THERAPIST |
| `'administrative'` | 事務職 | ADMIN, CLERK |
| `'support'` | サポート職 | DIETITIAN, MEDICAL_SOCIAL_WORKER |
| `'management'` | 管理職 | CHAIRMAN, DIRECTOR, DEPARTMENT_HEAD, MANAGER |
| `'other'` | その他 | 上記以外のaccountType |

#### 変換ロジック実装例

```typescript
function convertAccountTypeToProfessionCategory(accountType: string): string {
  const mapping: Record<string, string> = {
    // 看護職
    'NURSE': 'nursing',
    'NURSE_MANAGER': 'nursing',
    'NURSING_DIRECTOR': 'nursing',

    // 医師
    'DOCTOR': 'medical',
    'MEDICAL_DIRECTOR': 'medical',

    // 介護職
    'CARE_WORKER': 'nursing',
    'CARE_MANAGER': 'nursing',

    // リハビリ職
    'THERAPIST': 'rehabilitation',
    'PHYSICAL_THERAPIST': 'rehabilitation',
    'OCCUPATIONAL_THERAPIST': 'rehabilitation',
    'SPEECH_THERAPIST': 'rehabilitation',

    // 医療技術職
    'PHARMACIST': 'medical',
    'RADIOLOGIST': 'medical',
    'LAB_TECHNICIAN': 'medical',
    'DIETITIAN': 'support',
    'MEDICAL_SOCIAL_WORKER': 'support',

    // 事務職
    'ADMIN': 'administrative',
    'CLERK': 'administrative',

    // 経営層
    'CHAIRMAN': 'management',
    'DIRECTOR': 'management',
    'DEPARTMENT_HEAD': 'management',
    'MANAGER': 'management',
  };

  return mapping[accountType] || 'other';
}
```

#### レスポンスフィールド確認

**個別職員取得API**（GET /api/v2/employees/:employeeId）:
```json
{
  "professionCategory": "nursing"  // ← 97行目で実装完了
}
```

**全職員取得API**（GET /api/v2/employees）:
```json
{
  "employees": [
    {
      "professionCategory": "nursing"  // ← 161行目で実装完了
    }
  ]
}
```

#### VoiceDriveチームへの確認事項

**質問**: VoiceDrive側の期待値と医療システム側の実装値が一致しているか確認をお願いします。

VoiceDriveチームが期待している professionCategory 値:
```typescript
// VoiceDrive側の型定義（推測）
type ProfessionCategory =
  | 'nursing'
  | 'medical'
  | 'administrative'
  | 'rehabilitation'
  | 'support'
  | 'management'
  | 'other';
```

医療システム側の実装値:
- ✅ `'nursing'` - 看護職
- ✅ `'medical'` - 医師
- ✅ `'administrative'` - 事務職
- ✅ `'rehabilitation'` - リハビリ職
- ✅ `'support'` - サポート職
- ✅ `'management'` - 管理職
- ✅ `'other'` - その他

**確認結果**: ✅ **完全一致**

---

## 質問3: Webhook実装の確認

### 回答: ✅ **Phase 3で実装完了**（2025年10月2日）

#### 実装状況

**実装箇所**: [src/services/webhook-notification.service.ts](../../src/services/webhook-notification.service.ts)

**実装内容**:
1. ✅ `employee.created` - 職員新規登録時
2. ✅ `employee.updated` - 職員情報変更時
3. ✅ `employee.deleted` - 職員退職時
4. ✅ リトライ機構（指数バックオフ: 1秒 → 2秒 → 3秒）
5. ✅ タイムアウト制御（5秒）
6. ✅ バッチ送信対応（最大10件並列）

#### Webhook送信エンドポイント

**VoiceDrive側エンドポイント**: `POST https://voicedrive.ai/api/webhooks/employee-updated`

**環境変数設定**:
```env
VOICEDRIVE_WEBHOOK_URL=https://voicedrive.ai/api/webhooks/employee-updated
WEBHOOK_API_KEY=<VoiceDriveチームから提供されるAPIキー>
```

#### Webhookペイロード形式

**employee.updated イベント**:
```json
{
  "eventType": "employee.updated",
  "timestamp": "2025-10-27T10:30:00Z",
  "data": {
    "staffId": "E001",
    "facilityId": "tategami-hospital",
    "changes": {
      "position": "看護師長",
      "accountLevel": 7,
      "effectiveDate": "2025-10-27T00:00:00Z"
    },
    "previousState": {
      "facilityId": "tategami-hospital",
      "position": "看護師",
      "accountLevel": 5
    }
  }
}
```

**employee.created イベント**:
```json
{
  "eventType": "employee.created",
  "timestamp": "2025-10-27T10:30:00Z",
  "data": {
    "staffId": "E002",
    "facilityId": "obara-hospital",
    "changes": {
      "position": "看護師",
      "accountLevel": 5,
      "effectiveDate": "2025-10-27T00:00:00Z"
    }
  }
}
```

**employee.deleted イベント**:
```json
{
  "eventType": "employee.deleted",
  "timestamp": "2025-10-27T10:30:00Z",
  "data": {
    "staffId": "E001",
    "facilityId": "tategami-hospital"
  }
}
```

#### 認証方式

**ヘッダー**:
```http
Content-Type: application/json
Authorization: Bearer <WEBHOOK_API_KEY>
X-Webhook-Version: 1.0
X-Event-Type: employee.updated
```

#### リトライポリシー

**最大リトライ回数**: 3回

**リトライ間隔**:
- 1回目: 1秒後
- 2回目: 2秒後
- 3回目: 3秒後

**リトライしない条件**:
- HTTPステータス 4xx（クライアントエラー）

#### テスト結果

**Phase 3統合テスト**: ✅ **15/15成功**（100%）

**テスト項目**:
1. ✅ 職員新規登録時のWebhook送信
2. ✅ 職員情報変更時のWebhook送信
3. ✅ 部署異動時のWebhook送信
4. ✅ 役職変更時のWebhook送信
5. ✅ 権限レベル変更時のWebhook送信
6. ✅ 施設間異動時のWebhook送信
7. ✅ 職員退職時のWebhook送信
8. ✅ リトライ機構の動作確認
9. ✅ タイムアウト制御の動作確認
10. ✅ バッチ送信の動作確認

**参照**: [docs/Phase3_実装作業完了報告書_FINAL.md](../../docs/Phase3_実装作業完了報告書_FINAL.md)

#### VoiceDriveチームへの確認事項

**質問1**: Webhookエンドポイントは実装されていますか？
- VoiceDrive側: `POST /api/webhooks/employee-updated`

**質問2**: Webhook署名検証は必要ですか？
- 医療システム側でHMAC-SHA256署名を追加実装可能です（Phase 2.5実装済みの方式）

**質問3**: APIキー（WEBHOOK_API_KEY）はどこで取得できますか？

---

## 質問4: テーブル構造の確認

### 回答: ✅ **全て存在**

医療システムのPrisma Schemaで以下のテーブル・フィールドの存在を確認しました。

#### 4-1. Employeeテーブル

**実装箇所**: [prisma/schema.prisma](../../prisma/schema.prisma) 65-111行目

**存在するフィールド**:

| フィールド | 型 | 説明 | VoiceDriveマッピング |
|-----------|-----|------|-------------------|
| `employeeCode` | String | 職員コード（unique） | ✅ `User.employeeId` |
| `name` | String | 氏名 | ✅ `User.name` |
| `email` | String | メールアドレス | ✅ `User.email` |
| `departmentId` | String | 部署ID | ✅ `User.department`（JOIN） |
| `positionId` | String | 役職ID | ✅ `User.professionCategory`（変換） |
| `permissionLevel` | Int | 権限レベル（1-25） | ✅ `User.permissionLevel` |
| `facilityId` | String | 施設ID | ✅ `User.facilityId` |
| `supervisorId` | String | 上司ID | ✅ `User.parentId` |
| `status` | String | 'active', 'leave', 'retired' | ✅ `User.isActive`, `User.isRetired` |
| `retiredAt` | DateTime | 退職日 | ✅ `User.retirementDate` |
| `hireDate` | DateTime | 入社日 | ✅ `User.hireDate` |
| `updatedAt` | DateTime | 更新日時 | ✅ `User.updatedAt` |

**Prisma Schema抜粋**:
```prisma
model Employee {
  id              String    @id @default(cuid())
  employeeCode    String    @unique              // → VoiceDrive User.employeeId
  name            String                         // → VoiceDrive User.name
  email           String    @unique              // → VoiceDrive User.email
  departmentId    String                         // → Department.name
  positionId      String                         // → Position.accountType → professionCategory
  facilityId      String
  supervisorId    String?                        // → VoiceDrive User.parentId
  permissionLevel Int       @default(1)          // → VoiceDrive User.permissionLevel
  status          String    @default("active")   // active, leave, retired
  retiredAt       DateTime?
  hireDate        DateTime
  updatedAt       DateTime  @updatedAt

  department   Department @relation(fields: [departmentId], references: [id])
  position     Position   @relation(fields: [positionId], references: [id])
  facility     Facility   @relation(fields: [facilityId], references: [id])
  supervisor   Employee?  @relation("EmployeeHierarchy", fields: [supervisorId], references: [id])
}
```

---

#### 4-2. Departmentテーブル

**実装箇所**: [prisma/schema.prisma](../../prisma/schema.prisma) 31-47行目

**存在するフィールド**:

| フィールド | 型 | 説明 | VoiceDriveマッピング |
|-----------|-----|------|-------------------|
| `id` | String | 部署ID | - |
| `code` | String | 部署コード（unique） | - |
| `name` | String | 部署名 | ✅ `User.department` |
| `facilityId` | String | 施設ID | - |
| `parentId` | String | 親部署ID | - |
| `level` | Int | 階層レベル | - |

**Prisma Schema抜粋**:
```prisma
model Department {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String                            // → VoiceDrive User.department
  facilityId String
  parentId   String?  // 親部署ID（階層構造）
  level      Int      // 階層レベル

  facility   Facility     @relation(fields: [facilityId], references: [id])
  parent     Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children   Department[] @relation("DepartmentHierarchy")
  employees  Employee[]   // 所属職員リスト
}
```

---

#### 4-3. Positionテーブル

**実装箇所**: [prisma/schema.prisma](../../prisma/schema.prisma) 49-62行目

**存在するフィールド**:

| フィールド | 型 | 説明 | VoiceDriveマッピング |
|-----------|-----|------|-------------------|
| `id` | String | 役職ID | - |
| `code` | String | 役職コード（unique） | - |
| `name` | String | 役職名 | ✅ `User.position` |
| `accountType` | String | アカウント種別 | ✅ `User.professionCategory`（変換） |
| `level` | Int | 職位レベル | - |

**Prisma Schema抜粋**:
```prisma
model Position {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String                         // → VoiceDrive User.position
  level        Int      // 職位レベル（権限管理用）
  accountType  String   // CHAIRMAN, DIRECTOR, NURSE等 → professionCategory変換

  employees Employee[]
}
```

**accountType → professionCategory 変換例**:
- `'NURSE'` → `'nursing'`
- `'DOCTOR'` → `'medical'`
- `'ADMIN'` → `'administrative'`
- `'THERAPIST'` → `'rehabilitation'`
- `'DIETITIAN'` → `'support'`
- `'DIRECTOR'` → `'management'`

---

## 📊 実装状況サマリー

### 実装完了事項

| 項目 | 状態 | 実装日 | 備考 |
|------|------|--------|------|
| APIエンドポイント実装 | ✅ **完了** | 2025/09/20 | Phase 1実装完了 |
| professionCategory実装 | ✅ **完了** | 2025/10/27 | Phase 2.18で実装完了 |
| Webhook実装 | ✅ **完了** | 2025/10/02 | Phase 3実装完了 |
| テーブル構造確認 | ✅ **完了** | 既存実装 | Prisma Schemaで確認 |

### テーブル・フィールド存在確認

| テーブル | フィールド | 状態 | VoiceDriveマッピング |
|---------|-----------|------|-------------------|
| Employee | employeeCode | ✅ 存在 | User.employeeId |
| Employee | permissionLevel | ✅ 存在 | User.permissionLevel |
| Department | name | ✅ 存在 | User.department |
| Position | accountType | ✅ 存在 | User.professionCategory（変換） |

### API実装状況

| API | エンドポイント | 状態 | professionCategory |
|-----|--------------|------|--------------------|
| 個別職員取得 | GET /api/v2/employees/:id | ✅ 実装済み | ✅ 提供中 |
| 全職員取得 | GET /api/v2/employees | ✅ 実装済み | ✅ 提供中 |

### Webhook実装状況

| イベント | 状態 | テスト結果 |
|---------|------|-----------|
| employee.created | ✅ 実装済み | ✅ テスト成功 |
| employee.updated | ✅ 実装済み | ✅ テスト成功 |
| employee.deleted | ✅ 実装済み | ✅ テスト成功 |

---

## 📝 VoiceDriveチームへの確認依頼事項

### 1. Webhook受信エンドポイントの準備

VoiceDrive側で以下のエンドポイントを実装済みか確認をお願いします。

**エンドポイント**: `POST /api/webhooks/employee-updated`

**期待する処理**:
1. HMAC-SHA256署名検証（オプション）
2. `User`テーブル更新
3. HomePageリアルタイム更新トリガー

### 2. 環境変数の共有

医療システム側で以下の環境変数を設定する必要があります。

```env
VOICEDRIVE_WEBHOOK_URL=https://voicedrive.ai/api/webhooks/employee-updated
WEBHOOK_API_KEY=<VoiceDriveチームから提供>
```

**質問**: `WEBHOOK_API_KEY`はどこで取得できますか？

### 3. professionCategory値の確認

VoiceDrive側の型定義と医療システム側の実装値が一致しているか確認をお願いします。

**医療システム側実装値**:
- `'nursing'` - 看護職
- `'medical'` - 医師
- `'rehabilitation'` - リハビリ職
- `'administrative'` - 事務職
- `'support'` - サポート職
- `'management'` - 管理職
- `'other'` - その他

**質問**: VoiceDrive側の期待値と一致していますか？

### 4. 統合テスト日程の調整

**提案日程**: 2025年11月1日（金）〜 11月8日（金）

**テストシナリオ**:
1. 職員情報取得テスト（API動作確認）
2. HomePage初回表示テスト（VoiceDrive実装後）
3. Webhook連携テスト（職員情報変更 → HomePage即時更新）
4. 投稿・投票機能テスト（VoiceDrive単独）

**推定工数**: 1日

---

## 🔗 関連ドキュメント

### 医療システム実装ドキュメント
1. [Phase3_実装作業完了報告書_FINAL.md](../../docs/Phase3_実装作業完了報告書_FINAL.md) - Webhook実装詳細
2. [prisma/schema.prisma](../../prisma/schema.prisma) - 医療システムDBスキーマ
3. [src/app/api/v2/employees/[employeeId]/route.ts](../../src/app/api/v2/employees/[employeeId]/route.ts) - 職員API実装
4. [src/services/webhook-notification.service.ts](../../src/services/webhook-notification.service.ts) - Webhook実装

### VoiceDrive実装ドキュメント（参照）
1. [HomePage暫定マスターリスト](./HomePage_暫定マスターリスト_20251027.md) - データ項目定義
2. [HomePage_DB要件分析_20251027.md](./HomePage_DB要件分析_20251027.md) - DB要件分析
3. [HomePage_医療システム確認結果_20251027.md](./HomePage_医療システム確認結果_20251027.md) - 確認結果報告書

---

## 📞 次のステップ

### 医療システムチームの対応

✅ **対応完了**: professionCategory実装完了（2025年10月27日）

**実施事項**:
1. ✅ professionCategory変換ロジック実装
2. ✅ 個別職員取得API修正
3. ✅ 全職員取得API修正
4. ✅ 本回答書のVoiceDriveチームへの送付

---

### VoiceDriveチームの対応（参考）

**推奨実装**:
1. ⏳ Webhook受信エンドポイント実装
2. ⏳ Userキャッシュ実装
3. ⏳ HomePageデモモード解除（実データ切り替え）

**推定工数**: 2-3日

---

### 統合テスト（両チーム合同）

**テスト日程**: 2025年11月1日（金）〜 11月8日（金）

**推定工数**: 1日

---

**文書終了**

最終更新: 2025年10月27日
バージョン: 1.0
承認: 未承認（VoiceDriveチームレビュー待ち）
次回レビュー: VoiceDriveチームからのフィードバック受領後
