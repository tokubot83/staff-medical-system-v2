# フィードバック面談連携実装依頼書

**作成日**: 2025年10月3日
**送信元**: 医療職員管理システムチーム
**送信先**: VoiceDriveチーム
**優先度**: 高
**対象**: フィードバック面談予約機能の実装

---

## 📋 概要

評価結果通知後の**フィードバック面談予約機能**の連携実装をお願いします。

医療システム側では既に受信機能の実装が完了しており、VoiceDrive側で評価ステーションページからの予約送信機能を実装いただくことで、フィードバック面談の予約フローが完成します。

---

## 🎯 目的

1. **職員の権利保護**: 評価結果に関する説明を受ける機会の確保
2. **異議申立サポート**: 期限内に面談を実施し、適切な対応を提供
3. **双方向コミュニケーション**: 評価→フィードバック面談→改善のPDCAサイクル確立

---

## 🔄 連携フロー

```
【VoiceDrive側】
1. 評価結果を職員に通知・表示
2. 評価ステーションページに「フィードバック面談予約」ボタンを設置
3. 職員がボタンをクリック → 予約フォーム表示
4. 評価情報を自動セット + 希望日程を入力
5. 医療システムAPIへ予約リクエスト送信

【医療システム側】 ← 実装済み ✅
6. 予約リクエスト受信（初回受付待ち表示）
7. AI最適化で3案生成 → VoiceDriveへ送信
8. 職員が選択 → 本予約確定
```

---

## 🛠️ VoiceDrive側で実装いただきたい内容

### 1. 評価ステーションページの拡張

#### 1.1 UI追加
```tsx
// 評価結果表示カードに追加
<Button
  variant="primary"
  onClick={handleFeedbackInterviewBooking}
  disabled={!evaluation.appealable}
>
  📅 フィードバック面談を予約
</Button>
```

#### 1.2 予約フォーム
- **自動セット項目**:
  - 職員ID・名前・部署・職位
  - 評価ID・評価種別・評価結果
  - 異議申立期限
- **職員入力項目**:
  - 希望日程（最大3つ）
  - 相談内容（任意）

---

### 2. API送信仕様

#### エンドポイント
```
POST /api/interviews/reservations
```

#### リクエストボディ（JSON）
```json
{
  "staffId": "OH-NS-2020-010",
  "staffName": "高橋 由美",
  "department": "外来看護部",
  "position": "看護師",
  "type": "support",
  "supportCategory": "feedback",
  "supportTopic": "夏季評価結果フィードバック",

  // 希望日程
  "scheduledDate": "2025-09-22",
  "scheduledTime": "14:00",
  "preferredDates": [
    "2025-09-22",
    "2025-09-23",
    "2025-09-24"
  ],

  // 緊急度（異議申立期限に応じて自動設定）
  "urgency": "high",  // urgent | high | medium | low

  // 評価情報（重要）
  "evaluationDetails": {
    "evaluationId": "EVAL-2024-SUMMER-010",
    "evaluationType": "summer_provisional",  // summer_provisional | winter_provisional | annual_final
    "facilityGrade": "A",
    "corporateGrade": "B",
    "totalPoints": 21.5,
    "appealDeadline": "2025-09-25",  // ISO 8601形式
    "appealable": true
  },

  // その他
  "notes": "夏季評価結果について詳しくお話を伺いたい",
  "duration": 45,  // 面談時間（分）
  "source": "voicedrive",
  "createdBy": "職員本人"
}
```

#### 必須フィールド
| フィールド | 型 | 説明 |
|----------|---|------|
| `staffId` | string | 職員ID |
| `staffName` | string | 職員名 |
| `department` | string | 部署 |
| `position` | string | 職位 |
| `type` | string | 固定値: `"support"` |
| `supportCategory` | string | 固定値: `"feedback"` |
| `scheduledDate` | string | 第一希望日（YYYY-MM-DD） |
| `scheduledTime` | string | 第一希望時間（HH:mm） |
| `evaluationDetails` | object | 評価情報（必須） |

---

### 3. 緊急度の自動判定ロジック（推奨）

```typescript
function calculateUrgency(appealDeadline: Date): string {
  const daysUntilDeadline = Math.ceil(
    (appealDeadline.getTime() - Date.now()) / (1000 * 60 * 60 * 24)
  );

  if (daysUntilDeadline <= 3) return 'urgent';   // 3日以内
  if (daysUntilDeadline <= 7) return 'high';     // 1週間以内
  if (daysUntilDeadline <= 14) return 'medium';  // 2週間以内
  return 'low';
}
```

---

### 4. エラーハンドリング

#### 4.1 送信前バリデーション
- [ ] 評価IDが存在するか
- [ ] 異議申立期限が過ぎていないか（過ぎている場合は警告）
- [ ] 希望日程が未来の日付か
- [ ] 必須フィールドが全て入力されているか

#### 4.2 送信後の処理
```typescript
// 成功時（201 Created）
{
  "success": true,
  "data": {
    "id": "RES-1234567890",
    "message": "フィードバック面談の予約を受け付けました"
  }
}

// 失敗時（400 Bad Request）
{
  "success": false,
  "error": "Missing required field: evaluationDetails"
}
```

---

## 📊 医療システム側の実装状況（参考）

### ✅ 完了済み

1. **型定義拡張**
   - `ProvisionalReservation`に`evaluationDetails`フィールド追加
   - `UnifiedInterviewReservation`に同様のフィールド追加

2. **UI実装**
   - 初回受付待ちカラムに評価情報表示エリア追加
   - 評価種別・施設内評価・法人内評価・組織貢献度点数の表示
   - 異議申立期限の警告表示（期限まで1週間未満で赤字表示）

3. **API受信処理**
   - `/api/interviews/reservations` POST メソッド拡張
   - `evaluationDetails`を受け取り、データベースに保存

4. **テストデータ**
   - フィードバック面談の仮予約モックデータ2件追加
   - 夏季評価（期限間近）と冬季評価（期限に余裕）のパターン

---

## 🧪 統合テスト項目

### テストケース1: 夏季評価フィードバック（異議申立期限間近）
```json
{
  "evaluationType": "summer_provisional",
  "facilityGrade": "B",
  "appealDeadline": "2025-09-25",  // 3日後
  "urgency": "urgent"
}
```
- **期待結果**: 医療システムで赤色の緊急マークと期限警告が表示される

### テストケース2: 冬季評価フィードバック（期限に余裕）
```json
{
  "evaluationType": "winter_provisional",
  "facilityGrade": "S",
  "appealDeadline": "2025-10-20",  // 2週間後
  "urgency": "medium"
}
```
- **期待結果**: 医療システムで通常の優先度表示

### テストケース3: 年間確定評価フィードバック
```json
{
  "evaluationType": "annual_final",
  "appealable": false
}
```
- **期待結果**: 異議申立期限の表示なし

### テストケース4: 必須フィールド欠損エラー
```json
{
  "evaluationDetails": null  // 評価情報なし
}
```
- **期待結果**: 400 Bad Request

---

## 📅 スケジュール提案

| 日程 | 作業内容 | 担当 |
|-----|---------|-----|
| 10/4-10/6 | VoiceDrive側実装 | VoiceDriveチーム |
| 10/7 | 開発環境での単体テスト | VoiceDriveチーム |
| 10/8 | 統合テスト（4ケース） | 両チーム合同 |
| 10/9 | 修正・調整 | 両チーム |
| 10/10 | 本番環境デプロイ | 両チーム合同 |

---

## 🔗 関連ドキュメント

- **評価通知実装ガイド**: `mcp-shared/docs/VoiceDrive_Notification_Implementation_Guide.md`
- **面談予約API仕様**: `src/app/api/interviews/reservations/route.ts`
- **型定義**: `src/components/interview/UnifiedInterviewDashboard.tsx` (line 33-71, 120-172)

---

## 📞 連絡先

**医療システム側担当**: 予約管理システム開発チーム
**質問・相談**: `mcp-shared/` フォルダに質問ファイルを作成してください

---

## ✅ チェックリスト

### VoiceDriveチーム実装前確認
- [ ] 評価ステーションページの現状UI確認
- [ ] 評価データの保持方法確認
- [ ] 職員情報の取得方法確認

### VoiceDriveチーム実装中
- [ ] 予約ボタンUI実装
- [ ] 予約フォーム実装
- [ ] API送信処理実装
- [ ] エラーハンドリング実装
- [ ] 緊急度自動判定実装

### 統合テスト前
- [ ] 開発環境での単体テスト完了
- [ ] テストデータ準備完了
- [ ] 医療システム側の受信確認環境準備完了

---

## 🚀 期待される効果

1. **職員満足度向上**: 評価結果を直接説明する機会の提供
2. **異議申立対応の効率化**: 期限管理と優先度付けによる適切な対応
3. **透明性の確保**: 評価→フィードバック→改善の一連のフロー可視化
4. **法令遵守**: 労働基準法に基づく適切な評価制度の運用

---

**ご不明点がございましたら、mcp-shared/経由でお気軽にお問い合わせください。**

**医療職員管理システムチーム一同**
