# Phase 5-3 共通DB構築後の作業提案書

**作成日**: 2025年10月1日
**提案者**: 医療職員管理システム開発チーム
**宛先**: VoiceDriveシステム開発チーム
**件名**: Phase 5-3完了後の共通DB構築待ち作業について

---

## 📋 目次

1. [現状の確認](#1-現状の確認)
2. [共通DB構築後の作業内容](#2-共通db構築後の作業内容)
3. [医療システム側の作業](#3-医療システム側の作業)
4. [VoiceDrive側の作業](#4-voicedrive側の作業)
5. [両チーム合同作業](#5-両チーム合同作業)
6. [作業スケジュール案](#6-作業スケジュール案)
7. [リスクと対策](#7-リスクと対策)
8. [Phase 5-4への移行について](#8-phase-5-4への移行について)

---

## 1. 現状の確認

### 1.1 Phase 5-3の達成状況

✅ **完了済み項目**:
- API統合（4エンドポイント）
- 認証機能（Bearer Token）
- バリデーション機能
- エラーハンドリング
- Webhook通知機構（医療システム側）
- リアルタイム更新機能（VoiceDrive側）
- 統合テスト（77.8%成功）

⏸️ **共通DB構築待ち項目**:
- 実データベース接続
- 本番認証システム（Supabase Auth）
- ファイルアップロード（Supabase Storage）
- 実データでのE2Eテスト

### 1.2 現在の制限事項

| 項目 | 現状 | 共通DB構築後 |
|------|------|-------------|
| データソース | モックデータ | 実データベース |
| 認証方式 | 環境変数APIキー | Supabase Auth |
| ファイル保存 | 未実装 | Supabase Storage |
| Webhook通知 | 送信のみ実装 | 完全な双方向通信 |

---

## 2. 共通DB構築後の作業内容

### 2.1 作業の全体像

```
共通DB構築完了
    ↓
[Phase 5-3.4] 実データベース統合
    ↓
[Phase 5-3.5] 本番認証システム統合
    ↓
[Phase 5-3.6] ファイルアップロード実装
    ↓
[Phase 5-3.7] 実データでの統合テスト
    ↓
Phase 5-3 完全完了 🎉
    ↓
[Phase 5-4] 次期機能開発へ移行
```

### 2.2 想定作業期間

| フェーズ | 期間 | 担当 |
|---------|------|------|
| Phase 5-3.4: DB統合 | 2-3日 | 両チーム |
| Phase 5-3.5: 認証統合 | 1-2日 | 両チーム |
| Phase 5-3.6: ファイル実装 | 2-3日 | 両チーム |
| Phase 5-3.7: 実データテスト | 1-2日 | 両チーム |
| **合計** | **6-10日** | - |

---

## 3. 医療システム側の作業

### 3.1 Phase 5-3.4: 実データベース統合

#### 3.1.1 環境変数の本番設定

**現在**（.env.local）:
```env
# モックデータ用の設定
VOICEDRIVE_API_KEY=ms_prod_key_X1Y2Z3A4B5C6D7E8F9G0H1I2J3K4L5M6
MEDICAL_SYSTEM_API_KEY=vd_prod_key_A8B9C2D3E4F5G6H7I8J9K0L1M2N3O4P5
```

**共通DB構築後**（.env.production）:
```env
# 実データベース設定
DATABASE_URL=postgresql://user:pass@db.medical-system.local:5432/medical_staff_system
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# キャリアコーステーブル
CAREER_COURSES_TABLE=staff_career_courses
COURSE_DEFINITIONS_TABLE=career_course_definitions
CHANGE_REQUESTS_TABLE=career_course_change_requests
```

#### 3.1.2 Supabase接続の有効化

**作業内容**:
1. `src/app/api/my-page/route.ts` のコメントアウトを解除
2. `src/app/api/career-courses/definitions/route.ts` のコメントアウトを解除
3. `src/app/api/career-course/change-request/route.ts` のコメントアウトを解除
4. `src/app/api/career-course/my-requests/route.ts` のコメントアウトを解除

**例**（my-page/route.ts）:
```typescript
export async function GET(request: NextRequest) {
  try {
    // 認証チェック（開発環境用）
    const authHeader = request.headers.get('authorization')
    const expectedToken = process.env.MEDICAL_SYSTEM_API_KEY

    if (authHeader !== `Bearer ${expectedToken}`) {
      return NextResponse.json({ error: '認証が必要です' }, { status: 401 })
    }

    // ✅ 以下のコメントを解除
    const supabase = createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: '認証が必要です' }, { status: 401 })
    }

    const { data: staffData, error: dbError } = await supabase
      .from('staff')
      .select(`
        *,
        careerCourse:staff_career_courses!staff_career_courses_staff_id_fkey(*)
      `)
      .eq('id', user.id)
      .single()

    if (dbError) throw dbError

    // モックデータの削除
    // const mockData = { ... } // ← 削除

    return NextResponse.json(staffData, { status: 200 })
  } catch (error) {
    console.error('マイページデータ取得エラー:', error)
    return NextResponse.json(
      { error: 'データ取得に失敗しました' },
      { status: 500 }
    )
  }
}
```

#### 3.1.3 データベーススキーマの確認

**必要なテーブル**:
```sql
-- 職員テーブル（既存）
staff (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  position TEXT,
  department TEXT,
  facility TEXT,
  ...
)

-- キャリアコース定義テーブル（新規）
career_course_definitions (
  id TEXT PRIMARY KEY,
  course_code TEXT NOT NULL, -- A, B, C, D
  course_name TEXT NOT NULL,
  description TEXT,
  base_salary_multiplier DECIMAL(3,2),
  is_active BOOLEAN DEFAULT true,
  display_order INTEGER,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)

-- 職員キャリアコーステーブル（新規）
staff_career_courses (
  id TEXT PRIMARY KEY,
  staff_id TEXT REFERENCES staff(id),
  course_code TEXT NOT NULL,
  effective_from DATE NOT NULL,
  effective_to DATE,
  next_change_available_date DATE,
  approval_status TEXT, -- approved, pending, rejected
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)

-- コース変更申請テーブル（新規）
career_course_change_requests (
  id TEXT PRIMARY KEY,
  staff_id TEXT REFERENCES staff(id),
  current_course_code TEXT,
  requested_course_code TEXT NOT NULL,
  change_reason TEXT NOT NULL,
  reason_detail TEXT,
  requested_effective_date DATE NOT NULL,
  attachments TEXT[], -- ファイルパスの配列
  approval_status TEXT DEFAULT 'pending',
  approved_by TEXT,
  approved_at TIMESTAMP,
  rejection_reason TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)
```

### 3.2 Phase 5-3.5: 本番認証システム統合

#### 3.2.1 Supabase Authの有効化

**作業内容**:
1. 環境変数APIキー認証を削除
2. Supabase Auth JWTトークン認証に切り替え
3. VoiceDrive側にトークン生成ロジックを実装

**変更例**:
```typescript
// Before: 環境変数ベースの認証
const authHeader = request.headers.get('authorization')
const expectedToken = process.env.MEDICAL_SYSTEM_API_KEY

if (authHeader !== `Bearer ${expectedToken}`) {
  return NextResponse.json({ error: '認証が必要です' }, { status: 401 })
}

// After: Supabase Auth認証
const supabase = createClient()
const { data: { user }, error: authError } = await supabase.auth.getUser()

if (authError || !user) {
  return NextResponse.json({ error: '認証が必要です' }, { status: 401 })
}
```

### 3.3 Phase 5-3.6: ファイルアップロード実装

#### 3.3.1 Supabase Storageの設定

**バケット構成**:
```
career-course-attachments/
  ├── {staff_id}/
  │   ├── {request_id}/
  │   │   ├── 証明書_20251001.pdf
  │   │   ├── 診断書_20251001.pdf
  │   │   └── ...
```

**ポリシー**:
- 職員は自分のフォルダのみアップロード可能
- 人事部は全フォルダ閲覧可能
- ファイルサイズ上限: 10MB

#### 3.3.2 ファイルアップロード処理の実装

```typescript
// src/app/api/career-course/change-request/route.ts

// コメントアウトを解除
const uploadedFiles: string[] = []
if (attachments && attachments.length > 0) {
  for (const file of attachments) {
    const { data, error } = await supabase.storage
      .from('career-course-attachments')
      .upload(`${user.id}/${Date.now()}_${file.name}`, file.data, {
        contentType: file.type
      })
    if (error) throw error
    uploadedFiles.push(data.path)
  }
}
```

---

## 4. VoiceDrive側の作業

### 4.1 Phase 5-3.4: 実データベース統合

#### 4.1.1 環境変数の更新

**現在**（.env）:
```env
NEXT_PUBLIC_MEDICAL_SYSTEM_API=http://localhost:3000
MEDICAL_SYSTEM_API_KEY=vd_prod_key_A8B9C2D3E4F5G6H7I8J9K0L1M2N3O4P5
```

**共通DB構築後**（.env.production）:
```env
NEXT_PUBLIC_MEDICAL_SYSTEM_API=https://api.medical-system.local
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 4.1.2 API呼び出しの更新

**作業内容**:
- モックデータフォールバックの削除
- エラーハンドリングの強化
- 本番エンドポイントへの切り替え

**例**（careerCourseService.ts）:
```typescript
export async function getMyPageData(): Promise<StaffInfo> {
  try {
    const response = await fetch(`${API_BASE_URL}/api/my-page`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`, // ← Supabase Authトークン
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new CareerCourseAPIError(
        `API error: ${response.status}`,
        response.status,
        await response.json()
      );
    }

    const data = await response.json();

    // ✅ モックデータフォールバックを削除
    // if (!data) {
    //   return MOCK_STAFF_INFO; // ← 削除
    // }

    return data;
  } catch (error) {
    console.error('マイページデータ取得エラー:', error);
    throw error; // ✅ エラーを再スロー（フォールバックしない）
  }
}
```

### 4.2 Phase 5-3.5: 本番認証システム統合

#### 4.2.1 Supabase Auth統合

**作業内容**:
1. Supabase Clientの初期化
2. ログイン処理の実装
3. セッション管理の実装
4. トークンリフレッシュの実装

**実装例**:
```typescript
// src/lib/supabase.ts（新規作成）
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = import.meta.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

// トークン取得
export async function getAuthToken(): Promise<string | null> {
  const { data: { session } } = await supabase.auth.getSession();
  return session?.access_token || null;
}
```

**careerCourseService.ts の更新**:
```typescript
import { getAuthToken } from '@/lib/supabase';

export async function getMyPageData(): Promise<StaffInfo> {
  const token = await getAuthToken();

  if (!token) {
    throw new CareerCourseAPIError('認証が必要です', 401);
  }

  const response = await fetch(`${API_BASE_URL}/api/my-page`, {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
  });

  // ...
}
```

### 4.3 Phase 5-3.6: ファイルアップロード実装

#### 4.3.1 ファイル選択UIの実装

**ChangeRequestPage.tsx の更新**:
```typescript
const [selectedFiles, setSelectedFiles] = useState<File[]>([]);

const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
  const files = Array.from(event.target.files || []);

  // ファイルサイズチェック（10MB上限）
  const validFiles = files.filter(file => {
    if (file.size > 10 * 1024 * 1024) {
      alert(`${file.name} は10MBを超えています`);
      return false;
    }
    return true;
  });

  setSelectedFiles(validFiles);
};

// JSX
<input
  type="file"
  multiple
  accept=".pdf,.jpg,.jpeg,.png"
  onChange={handleFileSelect}
  className="..."
/>
```

#### 4.3.2 ファイル送信処理の実装

**careerCourseService.ts の更新**:
```typescript
export async function submitChangeRequest(
  params: SubmitChangeRequestParams
): Promise<SubmitResponse> {
  const formData = new FormData();

  // 申請データを追加
  formData.append('currentCourseCode', params.currentCourseCode);
  formData.append('requestedCourseCode', params.requestedCourseCode);
  formData.append('changeReason', params.changeReason);
  // ...

  // ファイルを追加
  if (params.files) {
    params.files.forEach((file, index) => {
      formData.append(`attachments[${index}]`, file);
    });
  }

  const token = await getAuthToken();
  const response = await fetch(`${API_BASE_URL}/api/career-course/change-request`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
    },
    body: formData, // ✅ JSON → FormData
  });

  // ...
}
```

---

## 5. 両チーム合同作業

### 5.1 Phase 5-3.7: 実データでの統合テスト

#### 5.1.1 テストデータの準備

**医療システム側**:
```sql
-- テスト用職員データ
INSERT INTO staff (id, name, position, department, facility) VALUES
('TEST-001', 'テスト 太郎', '看護師', '3階病棟', '小原病院');

-- テスト用コース定義データ
INSERT INTO career_course_definitions (id, course_code, course_name, base_salary_multiplier) VALUES
('def-a', 'A', 'Aコース（全面協力型）', 1.2),
('def-b', 'B', 'Bコース（施設内協力型）', 1.1),
('def-c', 'C', 'Cコース（専門職型）', 1.0),
('def-d', 'D', 'Dコース（時短・制約あり型）', 0.9);

-- テスト用キャリアコースデータ
INSERT INTO staff_career_courses (id, staff_id, course_code, effective_from, next_change_available_date, approval_status) VALUES
('cc-001', 'TEST-001', 'B', '2025-04-01', '2026-03-01', 'approved');
```

#### 5.1.2 統合テストの実施

**テスト項目**:
1. ✅ 実データでのマイページ表示
2. ✅ 実データでのコース定義一覧表示
3. ✅ 実データでの申請送信
4. ✅ 実データでの申請履歴表示
5. ✅ ファイルアップロード
6. ✅ Webhook通知（実データ更新）
7. ✅ リアルタイム更新

**テスト手順**:
```bash
# 医療システム側
cd C:\projects\staff-medical-system
npm run test:integration:production

# VoiceDrive側
cd C:\projects\voicedrive
npm run test:e2e:production
```

#### 5.1.3 パフォーマンステスト

**目標**:
| API | モックデータ | 実データ | 目標 |
|-----|-------------|---------|------|
| GET /api/my-page | 35ms | ? | < 200ms |
| GET /api/career-courses/definitions | 31ms | ? | < 200ms |
| POST /api/career-course/change-request | 34ms | ? | < 500ms |
| GET /api/career-course/my-requests | 41ms | ? | < 300ms |

---

## 6. 作業スケジュール案

### 6.1 共通DB構築完了直後のスケジュール

```
Day 1: 環境構築・DB接続確認
  - 08:00-09:00: 環境変数設定（両チーム）
  - 09:00-11:00: DB接続確認（医療システム側）
  - 11:00-12:00: API動作確認（VoiceDrive側）
  - 13:00-15:00: データ移行・初期データ投入
  - 15:00-17:00: 接続テスト

Day 2: Supabase Auth統合
  - 09:00-11:00: 認証処理実装（医療システム側）
  - 11:00-13:00: トークン取得実装（VoiceDrive側）
  - 14:00-16:00: 認証テスト
  - 16:00-17:00: エラーハンドリング確認

Day 3: ファイルアップロード実装（前半）
  - 09:00-11:00: Storageバケット作成（医療システム側）
  - 11:00-13:00: アップロード処理実装（医療システム側）
  - 14:00-16:00: UI実装（VoiceDrive側）
  - 16:00-17:00: 単体テスト

Day 4: ファイルアップロード実装（後半）
  - 09:00-11:00: 統合テスト
  - 11:00-13:00: エラーケーステスト
  - 14:00-16:00: パフォーマンステスト
  - 16:00-17:00: 修正対応

Day 5-6: 実データでの統合テスト
  - Day 5 AM: テストデータ準備
  - Day 5 PM: API統合テスト
  - Day 6 AM: E2Eテスト
  - Day 6 PM: 最終確認・レポート作成

Day 7: バッファ日（予備日）
```

### 6.2 マイルストーン

| 日付 | マイルストーン | 成果物 |
|------|---------------|--------|
| Day 1終了時 | DB接続完了 | 接続確認レポート |
| Day 2終了時 | 認証統合完了 | 認証テストレポート |
| Day 4終了時 | ファイル機能完了 | ファイルテストレポート |
| Day 6終了時 | 統合テスト完了 | 最終統合テストレポート |

---

## 7. リスクと対策

### 7.1 技術的リスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| DB接続エラー | 中 | 高 | 接続テスト環境を事前準備 |
| 認証トークンエラー | 中 | 高 | Supabase Auth ドキュメント熟読 |
| ファイルアップロード失敗 | 低 | 中 | エラーログ詳細化 |
| パフォーマンス低下 | 低 | 中 | インデックス最適化 |

### 7.2 スケジュールリスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| DB構築遅延 | 中 | 高 | 他プロジェクトとの調整 |
| 予期せぬバグ | 中 | 中 | バッファ日を1日確保 |
| 仕様変更 | 低 | 高 | 早期の仕様確定 |

### 7.3 コミュニケーションリスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| チーム間連携不足 | 低 | 中 | 毎日15分の朝会 |
| ドキュメント不足 | 低 | 中 | 作業完了時に都度ドキュメント化 |

---

## 8. Phase 5-4への移行について

### 8.1 Phase 5-3完全完了後の状態

✅ **達成される状態**:
- 実データベース接続が完了
- 本番認証システムが動作
- ファイルアップロードが動作
- 全機能が本番環境で動作
- 統合テスト100%成功

### 8.2 Phase 5-4の候補機能

**医療システムチームからの提案**:

#### 8.2.1 人事部機能の強化

1. **承認ワークフロー機能**
   - 複数段階承認（直属上司 → 人事部長 → 理事長）
   - 承認期限アラート
   - 承認依頼通知

2. **申請管理ダッシュボード**
   - 申請件数の統計グラフ
   - 承認待ち件数のリアルタイム表示
   - コース別の申請傾向分析

3. **コース定義管理機能**
   - E/Fコースの追加
   - コース定義の編集・無効化
   - 給与係数のシミュレーション

#### 8.2.2 職員機能の強化

1. **コース変更シミュレーション**
   - コース変更による給与変動の試算
   - 次回変更可能日の計算
   - 過去の変更履歴グラフ

2. **申請テンプレート機能**
   - よく使う理由のテンプレート保存
   - 過去の申請内容の再利用
   - 申請下書き保存

3. **通知機能の強化**
   - メール通知
   - LINE通知（オプション）
   - 申請状況の週次サマリー

#### 8.2.3 分析・レポート機能

1. **人事データ分析**
   - コース別の職員分布
   - 年齢層別のコース傾向
   - 施設別のコース比率

2. **給与シミュレーション**
   - コース変更による総人件費の変動予測
   - 部署別の給与分布
   - 昇給シミュレーション

3. **レポート自動生成**
   - 月次申請サマリーレポート
   - 四半期コース変更レポート
   - 年次人事データレポート

### 8.3 Phase 5-4のスコープ決定プロセス

**提案**:
1. 医療システムチームが候補機能リストを作成
2. VoiceDriveチームと優先順位を協議
3. 実装工数の見積もり
4. Phase 5-4のスコープを確定
5. 開発スケジュールの策定

**協議の場**:
- Slack: #phase5-planning
- ビデオ会議: 週1回（毎週金曜日15:00-16:00）
- ドキュメント: MCP共有フォルダ

---

## 9. まとめ

### 9.1 共通DB構築後の作業サマリー

**期間**: 6-10日（バッファ含む）

**作業内容**:
1. ✅ 実データベース統合（2-3日）
2. ✅ 本番認証システム統合（1-2日）
3. ✅ ファイルアップロード実装（2-3日）
4. ✅ 実データでの統合テスト（1-2日）

**成果物**:
- 実データベース接続済みシステム
- 本番認証システム統合済みシステム
- ファイルアップロード機能
- 統合テストレポート（100%成功）

### 9.2 Phase 5-4への移行

**提案する候補機能**:
- 人事部機能の強化（承認ワークフロー、ダッシュボード）
- 職員機能の強化（シミュレーション、テンプレート）
- 分析・レポート機能（データ分析、自動レポート）

**協議方法**:
- 優先順位の協議
- 実装工数の見積もり
- スコープの確定

### 9.3 連絡先

**医療システムチーム**:
- Slack: #phase5-medical-system
- Email: medical-system-dev@example.com
- 担当: Claude Code (AI開発支援)

**VoiceDriveチーム**:
- Slack: #phase5-voicedrive
- Email: voicedrive-dev@example.com
- 担当: Claude Code (AI開発支援)

**Phase 5-4 企画チャネル**:
- Slack: #phase5-4-planning

---

## 付録A: チェックリスト

### A.1 共通DB構築前の確認事項

**医療システム側**:
- [ ] Supabaseプロジェクトの作成
- [ ] データベーススキーマの設計完了
- [ ] 環境変数の準備
- [ ] テストデータの準備
- [ ] ドキュメントの整備

**VoiceDrive側**:
- [ ] Supabase Clientの準備
- [ ] 環境変数の準備
- [ ] モックデータの削除計画
- [ ] エラーハンドリングの強化計画

### A.2 共通DB構築後の確認事項

**Day 1終了時**:
- [ ] DB接続成功
- [ ] 初期データ投入完了
- [ ] API動作確認完了

**Day 2終了時**:
- [ ] 認証処理実装完了
- [ ] トークン取得成功
- [ ] 認証テスト完了

**Day 4終了時**:
- [ ] ファイルアップロード実装完了
- [ ] ファイルダウンロード実装完了
- [ ] ファイルテスト完了

**Day 6終了時**:
- [ ] 実データでの統合テスト完了
- [ ] パフォーマンステスト完了
- [ ] 最終レポート作成完了

---

**医療職員管理システム開発チーム**
作成日: 2025年10月1日
最終更新: 2025年10月1日 16:00
バージョン: 1.0

*Phase 5-3の統合テスト完了、おめでとうございます！引き続き、共通DB構築後の作業とPhase 5-4でもよろしくお願いいたします。🎉*
