# Phase 5-3 共通DB構築後の作業計画（最終版）

**作成日**: 2025年10月1日
**承認者**: VoiceDriveシステム開発チーム & 医療職員管理システム開発チーム
**ステータス**: 最終確定版
**実施予定**: 共通DB構築完了後

---

## 📋 目次

1. [作業計画の確定](#1-作業計画の確定)
2. [7日間の詳細スケジュール](#2-7日間の詳細スケジュール)
3. [両チームの役割分担](#3-両チームの役割分担)
4. [技術的な実装詳細](#4-技術的な実装詳細)
5. [リスク管理](#5-リスク管理)
6. [Phase 5-4への移行](#6-phase-5-4への移行)

---

## 1. 作業計画の確定

### 1.1 VoiceDriveチームからの承認

✅ **全面的に賛同** を確認しました

**承認された作業フロー**:
1. ✅ Phase 5-3.4: 実データベース統合（2-3日）
2. ✅ Phase 5-3.5: 本番認証システム統合（1-2日）
3. ✅ Phase 5-3.6: ファイルアップロード実装（2-3日）
4. ✅ Phase 5-3.7: 実データでの統合テスト（1-2日）

**合計期間**: 6-10日（バッファ含む）

### 1.2 両チームの準備状況

#### 医療システム側
- ✅ APIエンドポイント実装完了（モックデータ動作中）
- ✅ Webhook通知機構実装完了
- ✅ 統合テスト完了（77.8%成功）
- ⏸️ Supabase接続はコメントアウト状態（DB構築後に有効化）

#### VoiceDrive側
- ✅ API呼び出しロジック実装完了
- ✅ エラーハンドリング実装完了
- ✅ WebhookTestPanel実装完了
- ⏸️ Supabase Auth統合待ち
- ⏸️ ファイルアップロード実装待ち

---

## 2. 7日間の詳細スケジュール

### Day 1: 環境構築・DB接続確認

**作業時間**: 09:00-17:00（8時間）

#### 医療システム側の作業

**09:00-11:00: Supabase環境構築**
```bash
# 1. Supabaseプロジェクト作成
# 2. データベーススキーマ作成
# 3. ストレージバケット作成
```

**テーブル作成SQL**:
```sql
-- コース定義テーブル
CREATE TABLE career_course_definitions (
  id TEXT PRIMARY KEY,
  course_code TEXT NOT NULL UNIQUE,
  course_name TEXT NOT NULL,
  description TEXT,
  department_transfer_available BOOLEAN,
  facility_transfer_available TEXT,
  relocation_required BOOLEAN,
  night_shift_available TEXT,
  management_track BOOLEAN,
  base_salary_multiplier DECIMAL(3,2),
  is_active BOOLEAN DEFAULT true,
  display_order INTEGER,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 職員キャリアコーステーブル
CREATE TABLE staff_career_courses (
  id TEXT PRIMARY KEY,
  staff_id TEXT REFERENCES staff(id),
  course_code TEXT NOT NULL,
  effective_from DATE NOT NULL,
  effective_to DATE,
  next_change_available_date DATE,
  special_change_reason TEXT,
  special_change_note TEXT,
  approval_status TEXT,
  approved_by TEXT,
  approved_at TIMESTAMP,
  rejection_reason TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- コース変更申請テーブル
CREATE TABLE career_course_change_requests (
  id TEXT PRIMARY KEY,
  staff_id TEXT REFERENCES staff(id),
  current_course_code TEXT,
  requested_course_code TEXT NOT NULL,
  change_reason TEXT NOT NULL,
  reason_detail TEXT,
  requested_effective_date DATE NOT NULL,
  attachments TEXT[],
  approval_status TEXT DEFAULT 'pending',
  approved_by TEXT,
  approved_at TIMESTAMP,
  rejection_reason TEXT,
  review_comment TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- インデックス作成
CREATE INDEX idx_staff_career_courses_staff_id ON staff_career_courses(staff_id);
CREATE INDEX idx_staff_career_courses_approval_status ON staff_career_courses(approval_status);
CREATE INDEX idx_change_requests_staff_id ON career_course_change_requests(staff_id);
CREATE INDEX idx_change_requests_status ON career_course_change_requests(approval_status);
```

**11:00-12:00: 環境変数設定**

**医療システム側** (.env.production):
```env
# Supabase設定
DATABASE_URL=postgresql://user:pass@db.medical-system.local:5432/medical_staff_system
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# VoiceDrive連携
VOICEDRIVE_WEBHOOK_URL=https://voicedrive.medical-system.local/api/career-course/notify
VOICEDRIVE_API_KEY=ms_prod_key_X1Y2Z3A4B5C6D7E8F9G0H1I2J3K4L5M6
MEDICAL_SYSTEM_API_KEY=vd_prod_key_A8B9C2D3E4F5G6H7I8J9K0L1M2N3O4P5
INTERNAL_API_KEY=production_internal_key_CHANGE_ME

# 本番環境設定
NODE_ENV=production
ENABLE_API_LOGGING=true
```

**13:00-15:00: コメントアウト解除**

4つのAPIエンドポイントのコメントを解除:
- `/src/app/api/my-page/route.ts`
- `/src/app/api/career-courses/definitions/route.ts`
- `/src/app/api/career-course/change-request/route.ts`
- `/src/app/api/career-course/my-requests/route.ts`

**15:00-17:00: DB接続テスト**
```bash
# テストデータ投入
npm run db:seed

# API動作確認
curl https://api.medical-system.local/api/career-courses/definitions
```

#### VoiceDrive側の作業

**09:00-11:00: 環境変数設定**

**VoiceDrive側** (.env.production):
```env
NODE_ENV=production

# 医療システムAPI
NEXT_PUBLIC_MEDICAL_SYSTEM_API=https://api.medical-system.local

# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**11:00-13:00: API接続確認**

医療システムAPIへの接続テスト実施

**14:00-17:00: エラーハンドリング強化**

モックデータフォールバックを削除し、エラーを再スローする処理に変更

#### マイルストーン
- [ ] Supabaseプロジェクト作成完了
- [ ] テーブル作成完了
- [ ] 初期データ投入完了
- [ ] 医療システム側API動作確認
- [ ] VoiceDrive側接続確認

---

### Day 2: Supabase Auth統合

**作業時間**: 09:00-17:00（8時間）

#### 医療システム側の作業

**09:00-11:00: 認証処理の調整**

環境変数APIキー認証からSupabase Auth認証への切り替え

**11:00-13:00: トークン検証処理の実装**

JWTトークンの検証とユーザー情報の取得

**14:00-17:00: 認証エラーのテスト**

無効なトークン、期限切れトークンのエラーハンドリング確認

#### VoiceDrive側の作業

**09:00-11:00: Supabase Clientの初期化**

`src/lib/supabase.ts` の作成と実装

**11:00-13:00: getAuthToken()の実装**

セッションからアクセストークンを取得する関数の実装

**14:00-16:00: 全API呼び出しにトークン追加**

`careerCourseService.ts` の修正

**16:00-17:00: 認証テスト**

ログイン → API呼び出し → ログアウトの一連の流れをテスト

#### マイルストーン
- [ ] Supabase Auth統合完了
- [ ] トークン取得・管理機能実装完了
- [ ] 全APIでトークン認証動作確認
- [ ] 認証エラーハンドリング確認

---

### Day 3: ファイルアップロード実装（前半）

**作業時間**: 09:00-17:00（8時間）

#### 医療システム側の作業

**09:00-11:00: Storageバケット作成**

Supabase Storageに `career-course-attachments` バケット作成

**ポリシー設定**:
```sql
-- アップロードポリシー
CREATE POLICY "職員は自分のフォルダにアップロード可能"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'career-course-attachments'
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- 閲覧ポリシー
CREATE POLICY "人事部は全ファイル閲覧可能"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'career-course-attachments'
  AND (
    (storage.foldername(name))[1] = auth.uid()::text
    OR auth.jwt()->>'role' = 'hr_admin'
  )
);
```

**11:00-13:00: アップロード処理の実装**

`/src/app/api/career-course/change-request/route.ts` のコメントアウト解除

**14:00-17:00: ファイル保存テスト**

FormDataの受信とSupabase Storageへの保存をテスト

#### VoiceDrive側の作業

**09:00-11:00: ファイル選択UIの実装**

`ChangeRequestPage.tsx` にファイル選択機能を追加

**11:00-13:00: バリデーション実装**

- ファイルサイズチェック（10MB上限）
- ファイル形式チェック（PDF, JPG, PNG）
- 特例変更時の添付ファイル必須チェック

**14:00-16:00: アップロード進捗表示**

プログレスバーの実装

**16:00-17:00: 単体テスト**

ファイル選択、削除、バリデーションのテスト

#### マイルストーン
- [ ] Storageバケット作成・ポリシー設定完了
- [ ] ファイル選択UI実装完了
- [ ] バリデーション実装完了

---

### Day 4: ファイルアップロード実装（後半）

**作業時間**: 09:00-17:00（8時間）

#### 医療システム側の作業

**09:00-12:00: ファイルダウンロード機能実装**

人事部がアップロードされたファイルを閲覧する機能

**13:00-17:00: エラーケーステスト**

- ファイルサイズ超過
- 不正なファイル形式
- ストレージ容量不足
- ネットワークエラー

#### VoiceDrive側の作業

**09:00-11:00: FormData送信処理の実装**

`careerCourseService.ts` の `submitChangeRequest()` 修正

**11:00-13:00: 統合テスト**

ファイル選択 → バリデーション → アップロード → 申請送信の一連の流れ

**14:00-16:00: パフォーマンステスト**

- 大容量ファイル（10MB）のアップロード
- 複数ファイル同時アップロード
- アップロード中断とリトライ

**16:00-17:00: 修正対応**

発見されたバグの修正

#### マイルストーン
- [ ] ファイルアップロード機能完全実装
- [ ] エラーケーステスト完了
- [ ] パフォーマンステスト完了

---

### Day 5: 実データでの統合テスト（前半）

**作業時間**: 09:00-17:00（8時間）

#### 両チーム合同作業

**09:00-11:00: テストデータ準備**

```sql
-- テスト用職員データ
INSERT INTO staff (id, name, position, department, facility, email) VALUES
('TEST-001', 'テスト 太郎', '看護師', '3階病棟', '小原病院', 'test01@example.com'),
('TEST-002', 'テスト 花子', '理学療法士', 'リハビリ科', '立神病院', 'test02@example.com');

-- テスト用コース定義データ
INSERT INTO career_course_definitions (id, course_code, course_name, base_salary_multiplier, is_active, display_order) VALUES
('def-a', 'A', 'Aコース（全面協力型）', 1.2, true, 1),
('def-b', 'B', 'Bコース（施設内協力型）', 1.1, true, 2),
('def-c', 'C', 'Cコース（専門職型）', 1.0, true, 3),
('def-d', 'D', 'Dコース（時短・制約あり型）', 0.9, true, 4);

-- テスト用キャリアコースデータ
INSERT INTO staff_career_courses (id, staff_id, course_code, effective_from, next_change_available_date, approval_status) VALUES
('cc-001', 'TEST-001', 'B', '2025-04-01', '2026-03-01', 'approved'),
('cc-002', 'TEST-002', 'C', '2025-04-01', '2026-03-01', 'approved');
```

**11:00-13:00: API統合テスト**

| テストケース | 期待結果 | 実測値 | 判定 |
|------------|---------|--------|------|
| GET /api/my-page | 200 OK, 実データ返却 | - | - |
| GET /api/career-courses/definitions | 200 OK, 4件返却 | - | - |
| POST /api/career-course/change-request | 201 Created | - | - |
| GET /api/career-course/my-requests | 200 OK, 申請履歴返却 | - | - |

**14:00-17:00: E2Eテスト（前半）**

1. VoiceDriveでログイン
2. キャリア選択ステーション表示
3. マイページデータ表示確認
4. コース定義一覧表示確認

#### マイルストーン
- [ ] テストデータ準備完了
- [ ] API統合テスト4件完了
- [ ] E2E基本フロー動作確認

---

### Day 6: 実データでの統合テスト（後半）

**作業時間**: 09:00-17:00（8時間）

#### 両チーム合同作業

**09:00-12:00: E2Eテスト（後半）**

5. コース変更申請フォーム入力
6. ファイル添付
7. 申請送信
8. 申請履歴確認

**13:00-15:00: Webhook通知テスト**

医療システム側でWebhook通知を手動送信し、VoiceDrive側で受信確認

**15:00-16:00: パフォーマンステスト**

| API | 目標 | 実測値 | 判定 |
|-----|------|--------|------|
| GET /api/my-page | < 200ms | - | - |
| GET /api/career-courses/definitions | < 200ms | - | - |
| POST /api/career-course/change-request | < 500ms | - | - |
| GET /api/career-course/my-requests | < 300ms | - | - |

**16:00-17:00: 最終確認・レポート作成**

- 全テストケース実行完了
- 発見されたバグの記録
- パフォーマンス測定結果の記録
- 最終統合テストレポートの作成

#### マイルストーン
- [ ] E2Eテスト全工程完了
- [ ] Webhook通知動作確認
- [ ] パフォーマンステスト完了
- [ ] 最終レポート作成完了

---

### Day 7: バッファ日（予備日）

**作業時間**: 必要に応じて09:00-17:00

#### 用途

- 前日までに発見されたバグの修正
- パフォーマンス改善
- ドキュメント整備
- 次期フェーズ（Phase 5-4）の企画会議

---

## 3. 両チームの役割分担

### 3.1 医療システム側の責任範囲

- ✅ Supabaseプロジェクトの作成・管理
- ✅ データベーススキーマの設計・作成
- ✅ Storageバケットの作成・ポリシー設定
- ✅ APIエンドポイントの実装・テスト
- ✅ Webhook送信処理の実装
- ✅ 環境変数の管理（本番用）
- ✅ テストデータの準備

### 3.2 VoiceDrive側の責任範囲

- ✅ フロントエンドUIの実装
- ✅ Supabase Authの統合
- ✅ API呼び出しロジックの実装
- ✅ ファイルアップロード機能の実装
- ✅ エラーハンドリングの実装
- ✅ E2Eテストの実施
- ✅ ユーザビリティテスト

### 3.3 両チーム合同作業

- ✅ 統合テストの実施
- ✅ パフォーマンステスト
- ✅ 不具合の修正
- ✅ ドキュメント作成

---

## 4. 技術的な実装詳細

### 4.1 医療システム側の実装ポイント

#### Supabase接続の有効化

```typescript
// src/app/api/my-page/route.ts
export async function GET(request: NextRequest) {
  try {
    // 認証チェック
    const supabase = createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json({ error: '認証が必要です' }, { status: 401 })
    }

    // データベースクエリ
    const { data: staffData, error: dbError } = await supabase
      .from('staff')
      .select(`
        *,
        careerCourse:staff_career_courses!staff_career_courses_staff_id_fkey(*)
      `)
      .eq('id', user.id)
      .single()

    if (dbError) throw dbError

    return NextResponse.json(staffData, { status: 200 })
  } catch (error) {
    console.error('マイページデータ取得エラー:', error)
    return NextResponse.json(
      { error: 'データ取得に失敗しました' },
      { status: 500 }
    )
  }
}
```

### 4.2 VoiceDrive側の実装ポイント

#### Supabase Clientの初期化

```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

export async function getAuthToken(): Promise<string | null> {
  const { data: { session } } = await supabase.auth.getSession();
  return session?.access_token || null;
}
```

#### ファイルアップロードの実装

```typescript
// src/services/careerCourseService.ts
export async function submitChangeRequest(params: SubmitChangeRequestParams): Promise<SubmitResponse> {
  const token = await getAuthToken();

  const formData = new FormData();
  formData.append('currentCourseCode', params.currentCourseCode);
  formData.append('requestedCourseCode', params.requestedCourseCode);
  formData.append('changeReason', params.changeReason);
  formData.append('reasonDetail', params.reasonDetail);
  formData.append('requestedEffectiveDate', params.requestedEffectiveDate);

  if (params.files) {
    params.files.forEach((file, index) => {
      formData.append(`attachments[${index}]`, file);
    });
  }

  const response = await fetch(`${API_BASE_URL}/api/career-course/change-request`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
    },
    body: formData,
  });

  return response.json();
}
```

---

## 5. リスク管理

### 5.1 技術的リスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| DB接続エラー | 中 | 高 | 接続テスト環境を事前準備 |
| 認証トークンエラー | 中 | 高 | Supabase Auth ドキュメント熟読、テスト環境で事前確認 |
| ファイルアップロード失敗 | 低 | 中 | エラーログ詳細化、リトライ機構実装 |
| パフォーマンス低下 | 低 | 中 | インデックス最適化、クエリチューニング |
| CORS問題（VoiceDrive） | 中 | 高 | 開発環境でのCORS設定確認、プロキシ設定 |
| ブラウザキャッシュ問題 | 低 | 低 | ハードリロード手順の共有 |

### 5.2 スケジュールリスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| DB構築遅延 | 中 | 高 | 他プロジェクトとの調整、優先度の明確化 |
| 予期せぬバグ | 中 | 中 | Day 7をバッファ日として確保 |
| 仕様変更 | 低 | 高 | 早期の仕様確定、変更管理プロセス |

### 5.3 コミュニケーションリスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| チーム間連携不足 | 低 | 中 | 毎日15分の朝会（09:00-09:15） |
| ドキュメント不足 | 低 | 中 | 作業完了時に都度ドキュメント化 |
| 作業の重複・漏れ | 低 | 中 | チェックリストの活用、Slack進捗共有 |

---

## 6. Phase 5-4への移行

### 6.1 VoiceDriveチームからの優先度フィードバック

#### 優先度★★★（最高）

1. **コース変更シミュレーション**
   - 実装工数: 中（2-3日）
   - ユーザー価値: 非常に高い

2. **申請テンプレート機能**
   - 実装工数: 小（1-2日）
   - ユーザビリティ向上

#### 優先度★★（高）

3. **承認ワークフロー（複数段階）**
   - 実装工数: 大（5-7日）
   - 人事部の必須機能

4. **通知機能の強化（メール）**
   - 実装工数: 中（3-4日）
   - ユーザー体験向上

#### 優先度★（中）

5. **申請管理ダッシュボード**
   - 実装工数: 中（3-4日）
   - 人事部の分析機能

6. **データ分析・レポート**
   - 実装工数: 大（5-7日）
   - 経営層向け機能

### 6.2 Phase 5-4のスコープ提案

**Sprint 1（2週間）**: 高優先度機能
- コース変更シミュレーション
- 申請テンプレート機能

**Sprint 2（2週間）**: 人事部機能強化
- 承認ワークフロー
- 通知機能の強化

**Sprint 3（2週間）**: 分析・ダッシュボード
- 申請管理ダッシュボード
- データ分析基盤

**合計**: 6週間

### 6.3 協議の場

- ✅ Slack: #phase5-4-planning
- ✅ ビデオ会議: 毎週金曜日15:00-16:00
- ✅ ドキュメント: MCP共有フォルダ

---

## 7. チェックリスト

### 7.1 Day 1終了時チェックリスト

**医療システム側**:
- [ ] Supabaseプロジェクト作成
- [ ] テーブル作成完了
- [ ] インデックス作成完了
- [ ] 初期データ投入完了
- [ ] 環境変数設定完了
- [ ] コメントアウト解除完了
- [ ] API動作確認完了

**VoiceDrive側**:
- [ ] 環境変数設定完了
- [ ] API接続確認完了
- [ ] エラーハンドリング強化完了
- [ ] モックデータフォールバック削除完了

### 7.2 Day 2終了時チェックリスト

**医療システム側**:
- [ ] Supabase Auth認証切り替え完了
- [ ] トークン検証処理実装完了
- [ ] 認証エラーテスト完了

**VoiceDrive側**:
- [ ] Supabase Client初期化完了
- [ ] getAuthToken()実装完了
- [ ] 全API呼び出しにトークン追加完了
- [ ] 認証テスト完了

### 7.3 Day 4終了時チェックリスト

**医療システム側**:
- [ ] Storageバケット作成完了
- [ ] ポリシー設定完了
- [ ] アップロード処理実装完了
- [ ] ダウンロード機能実装完了
- [ ] エラーケーステスト完了

**VoiceDrive側**:
- [ ] ファイル選択UI実装完了
- [ ] バリデーション実装完了
- [ ] FormData送信処理実装完了
- [ ] アップロード進捗表示実装完了
- [ ] 統合テスト完了
- [ ] パフォーマンステスト完了

### 7.4 Day 6終了時チェックリスト

**両チーム**:
- [ ] テストデータ準備完了
- [ ] API統合テスト4件完了
- [ ] E2Eテスト全工程完了
- [ ] Webhook通知動作確認完了
- [ ] パフォーマンステスト完了
- [ ] 最終統合テストレポート作成完了
- [ ] Phase 5-3完全完了 🎉

---

## 8. 連絡先

**医療システムチーム**:
- Slack: #phase5-medical-system
- Email: medical-system-dev@example.com
- 担当: Claude Code (AI開発支援)

**VoiceDriveチーム**:
- Slack: #phase5-voicedrive
- Email: voicedrive-dev@example.com
- 担当: Claude Code (AI開発支援)

**Phase 5-3.4～5-3.7 専用チャネル**:
- Slack: #phase5-3-db-integration

**Phase 5-4 企画チャネル**:
- Slack: #phase5-4-planning

---

**VoiceDriveシステム開発チーム & 医療職員管理システム開発チーム**
作成日: 2025年10月1日
最終更新: 2025年10月1日 17:00
バージョン: 1.0（最終確定版）
ステータス: 両チーム承認済み

---

*Phase 5-3の統合テスト完了、おめでとうございます！共通DB構築後、この作業計画に従って実装を進めましょう。両チームの協力により、Phase 5-3の完全完了とPhase 5-4への円滑な移行を実現します。🎉*
