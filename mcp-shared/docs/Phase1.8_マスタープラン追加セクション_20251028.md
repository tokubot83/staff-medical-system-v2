# Phase 1.8: DB構築とAPI実装【マスタープラン追加セクション】

**このセクションを lightsail-integration-master-plan-20251005-updated.md の 1786行目（Phase 2の直前）に挿入してください**

---

## Phase 1.8: DB構築とAPI実装【新規追加】🆕

**優先度**: 🔴 **最高優先**（Phase 2以降の全機能の前提条件）
**担当**: 医療システムチーム
**推定工数**: **8-10日**（DB構築5-7日 + API実装1日 + テスト2日）
**実施期間**: 2025年11月5日～11月18日（予定）
**追加日**: 2025年10月28日

### 1.8.1 Phase概要

**医療システムの本番データベースを構築し、全APIエンドポイントをDB接続に切り替える**

現在、医療システムは以下の状態です：
- ✅ Prisma schema.prisma完成（770行、全テーブル定義済み）
- ✅ APIエンドポイント実装済み（モックデータで動作中）
- ✅ Prisma DBレイヤー部分実装（`InterviewReservationDb`等）
- ⚠️ **DBサーバー未構築**（モックデータ使用中）
- ⚠️ **API-DB接続未完了**（TODOコメント状態）

このPhaseで、**DB構築→API接続→統合テスト**を完了させ、**Phase 2以降の全機能の基盤**を確立します。

### 1.8.2 実装背景

#### ❌ **現状の課題（モックデータの限界）**

```typescript
// 現在のAPI実装（例: 面談予約API）
let reservations: UnifiedInterviewReservation[] = [
  // ハードコードされたモックデータ
  { id: 'REGULAR-001', staffName: '田中 花子', ... }
];

export async function GET(request: NextRequest) {
  // メモリ上のデータを返すだけ
  return NextResponse.json({ data: reservations });
}
```

**問題点**:
- ❌ データ永続化なし（サーバー再起動で消失）
- ❌ トランザクション管理なし
- ❌ データ整合性なし
- ❌ スケーラビリティなし
- ❌ VoiceDriveとのデータ連携不可

#### ✅ **DB構築後の理想状態**

```typescript
// DB接続後のAPI実装
import { InterviewReservationDb } from '@/lib/database/interviewReservationDb';

export async function GET(request: NextRequest) {
  const data = await InterviewReservationDb.findMany(filters);
  return NextResponse.json({ success: true, data });
}
```

**改善点**:
- ✅ データ永続化（MySQL）
- ✅ トランザクション管理（Prisma）
- ✅ データ整合性保証（外部キー制約）
- ✅ スケーラビリティ（500名→5000名対応可能）
- ✅ VoiceDriveとのデータ連携（Webhook、API経由）

### 1.8.3 実装範囲

| 項目 | 内容 | 工数 |
|------|------|------|
| **DB構築** | MySQL本番環境構築、テーブル作成、マスターデータ投入 | 5-7日 |
| **API実装** | モックデータをPrisma接続に切り替え | 1日 |
| **統合テスト** | 全API動作確認、パフォーマンステスト | 2日 |
| **合計** | - | **8-10日** |

### 1.8.4 DB構築計画（Week 1-8）

**詳細**: [Phase1.8_DB構築とAPI実装_20251028.md](./Phase1.8_DB構築とAPI実装_20251028.md)

#### **Week 1（1-2日）: 環境準備・マスターデータ構築**
- AWS Lightsail MySQL申請・設定
- `prisma migrate dev`実行（全テーブル作成）
- 施設・部署・職位マスターデータ投入（3施設、30部署、11職位）

#### **Week 2（2-3日）: 職員基本情報構築**
- 事務局提供データのクレンジング
- 職員データ投入（500名）
- データ検証（重複チェック等）

#### **Week 3-4（2-3日）: コア機能DB構築**
- キャリアコース選択制度（A～Dコース）
- 面談予約システム
- 面談記録管理

#### **Week 5-6（1-2日）: 機能別順次構築**
- 人事評価システム
- 健康管理システム
- 研修管理システム

#### **Week 7-8（1日）: 統合・最適化**
- 全機能の統合テスト
- パフォーマンスチューニング
- バックアップ・リストア確認
- VoiceDrive連携テスト

### 1.8.5 API実装計画（1日）

#### **面談予約API接続（2時間）**
**修正ファイル（4ファイル）**:
- `src/app/api/interviews/reservations/route.ts`
- `src/app/api/interviews/reservations/[id]/route.ts`
- `src/app/api/interviews/reservations/bulk/route.ts`
- `src/app/api/interviews/reservations/stats/route.ts`

#### **他のAPI接続（6時間）**
**必要な作業**:
1. Prisma DBレイヤー作成（4時間）
   - `evaluationDb.ts` - 評価管理
   - `healthDb.ts` - 健康管理
   - `trainingDb.ts` - 研修管理
   - `careerCourseDb.ts` - キャリアコース

2. APIルート接続（2時間）
   - モックデータ部分をPrisma呼び出しに変更

### 1.8.6 成功判定基準

#### **DB構築成功判定**
| 判定項目 | 判定基準 |
|---------|---------|
| 全テーブルが作成されている | Prisma schema通り |
| マスターデータが投入されている | 施設3件、部署30件、職位11件 |
| 職員データが投入されている | 500名 |
| データ整合性が保証されている | 外部キー制約エラーなし |
| バックアップが取得できる | 毎日自動バックアップ稼働 |

#### **API実装成功判定**
| 判定項目 | 判定基準 |
|---------|---------|
| 全APIがDB接続済み | モックデータ削除完了 |
| CRUD操作が正常動作 | CREATE/READ/UPDATE/DELETE成功 |
| エラーハンドリングが正常 | 適切なエラーレスポンス |
| パフォーマンス基準達成 | 応答時間 < 1秒 |
| VoiceDrive連携成功 | Webhook送信成功 |

#### **統合テスト成功判定**
| 判定項目 | 判定基準 |
|---------|---------|
| 全API動作確認完了 | 30エンドポイント以上 |
| データ整合性テスト合格 | トランザクション正常動作 |
| 負荷テスト合格 | 500名同時アクセス正常 |
| VoiceDrive連携テスト合格 | Webhook/API正常動作 |
| セキュリティ監査合格 | SQL Injection対策等 |

### 1.8.7 次Phaseへの影響

**このPhase 1.8は、以下の全Phaseの前提条件です：**

| Phase | 依存内容 | 優先度 |
|-------|---------|--------|
| **Phase 2: 認証システム統合** | 職員マスターDB必須 | 🔴 最高 |
| **Phase 2.5: 顔写真統合** | 職員マスターDB必須 | 🔴 高 |
| **Phase 7: PersonalStation** | 面談・評価データDB必須 | 🔴 高 |
| **Phase 11: InterviewStation** | 面談予約DB必須 | 🔴 高 |
| **Phase 14: HealthStation** | 健康管理DB必須 | 🔴 高 |
| **Phase 18.5: ExecutiveDashboard** | 全データDB必須 | 🟡 中 |

**結論**: **Phase 1.8完了なしには、Phase 2以降の全実装が不可能**

### 1.8.8 VoiceDriveチームへの影響

**DB構築完了後、VoiceDriveチームができること：**

1. ✅ **職員情報API呼び出し**
   - `GET /api/v2/employees/:id`
   - `GET /api/v2/employees`
   - 実データが返却される

2. ✅ **Webhook送信**
   - 面談予約作成Webhook
   - 職員情報更新Webhook
   - 実データがDB保存される

3. ✅ **データ連携テスト**
   - VoiceDrive→医療システム（API呼び出し）
   - 医療システム→VoiceDrive（Webhook送信）

### 1.8.9 実装タイムライン

#### **推奨スケジュール（14営業日 = 約3週間）**

```
Week 1  (Day 1-2):   環境準備・マスターデータ構築
Week 2  (Day 3-5):   職員基本情報構築（500名）
Week 3-4 (Day 6-8):  コア機能DB構築（面談・評価）
Week 5-6 (Day 9-10): 機能別DB構築（健康・研修）
Week 7-8 (Day 11):   統合・最適化
API実装  (Day 12):   全API接続（8時間）
統合テスト (Day 13-14): 全API動作確認・VoiceDrive連携テスト

開始予定: 2025年11月5日（火）
完了予定: 2025年11月25日（月）
```

#### **短縮版スケジュール（7営業日 = 約1.5週間）**

最小限の機能で先行リリース：

```
Day 1:   環境準備・マスターデータ構築
Day 2-3: 職員基本情報構築（500名）
Day 4:   面談予約DB構築
Day 5:   API実装（面談予約のみ）
Day 6:   統合テスト（面談予約のみ）
Day 7:   VoiceDrive連携テスト

開始予定: 2025年11月5日（火）
完了予定: 2025年11月13日（水）

⏩ Phase 2開始可能（認証システム統合）
```

**後日追加**:
- 評価・健康・研修DB（追加3-4日）

### 1.8.10 次のアクション

#### **即時実行項目（今週中：10/28-11/1）**

| No. | アクション | 担当 | 期限 | 工数 |
|-----|-----------|------|------|------|
| 1 | AWS Lightsail MySQL申請 | 医療チーム | 10/29 | 2時間 |
| 2 | `.env`ファイル設定 | 医療チーム | 10/29 | 1時間 |
| 3 | 事務局へ職員情報提供依頼送付 | 医療チーム | 10/28 | 1時間 |
| 4 | VoiceDriveチームへDB構築開始通知 | 医療チーム | 10/28 | 0.5時間 |
| 5 | Prisma Migrate準備 | 医療チーム | 11/1 | 2時間 |
| 6 | バックアップ体制構築 | 医療チーム | 11/1 | 2時間 |

#### **DB構築開始判定会議（11/4開催予定）**

**参加者**:
- 医療システムチーム
- VoiceDriveチーム
- 事務局責任者

**議題**:
1. 構築開始前チェックリスト10項目の確認
2. 職員情報提供データの確認
3. VoiceDriveチームとDB統合方針の最終確認
4. Week 1開始の可否判断

**判定基準**:
- ✅ 構築開始前チェックリスト10項目が全て✅
- ✅ 事務局からの職員情報提供が完了
- ✅ VoiceDriveチームとのDB統合方針が合意
- ✅ データベースサーバーが準備完了

**構築開始日**: 2025年11月5日（火）（判定会議で承認された場合）

### 1.8.11 関連ドキュメント

| No. | ドキュメント名 | 説明 |
|-----|--------------|------|
| 1 | [Phase1.8_DB構築とAPI実装_20251028.md](./Phase1.8_DB構築とAPI実装_20251028.md) | **本Phaseの詳細計画書** |
| 2 | [DB構築前確認書_最終版_20251002.md](./DB構築前確認書_最終版_20251002.md) | DB構築の詳細計画（Week 1-8） |
| 3 | [prisma/schema.prisma](../../prisma/schema.prisma) | 完全なPrismaスキーマ定義（770行） |
| 4 | [src/lib/database/interviewReservationDb.ts](../../src/lib/database/interviewReservationDb.ts) | Prisma DBレイヤーの参考実装 |
| 5 | [src/app/api/interviews/reservations/route.ts](../../src/app/api/interviews/reservations/route.ts) | 現在のモックAPI実装 |

### 1.8.12 リスク管理

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| データ投入時の重複エラー | 高 | 中 | 事前にデータクレンジング、UNIQUE制約設定 |
| 事務局からのデータ提供遅延 | 中 | 高 | サンプルデータで先行構築、後から実データ投入 |
| VoiceDrive連携不具合 | 中 | 中 | API連携を最後のPhaseに配置、独立動作を優先 |
| パフォーマンス問題 | 低 | 中 | インデックス最適化、クエリチューニング |
| データベースサーバー障害 | 低 | 高 | 毎日バックアップ、冗長化構成（将来） |
| 個人情報漏洩 | 低 | 最高 | アクセス制限、暗号化、監査ログ |

### 1.8.13 ロールバック手順

- **レベル1**: 軽微な問題 → 該当レコードのみ修正
- **レベル2**: テーブル単位の問題 → バックアップから該当テーブルのみ復元
- **レベル3**: Week全体の問題 → Week開始時のバックアップから全復元
- **レベル4**: データベース全体の問題 → データベース再構築

詳細は [Phase1.8_DB構築とAPI実装_20251028.md](./Phase1.8_DB構築とAPI実装_20251028.md) を参照。

---

**Phase 1.8追加日**: 2025年10月28日
**マスタープラン更新**: Version 2.58 → 2.59（Phase 1.8追加）

---
