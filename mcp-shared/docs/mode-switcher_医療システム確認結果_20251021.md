# システムモード管理ページ 医療システム確認結果

**文書番号**: MED-RES-2025-1021-006
**作成日**: 2025年10月21日
**最終更新**: 2025年10月21日
**作成者**: 医療職員管理システムチーム
**対象文書**: API-LIST-2025-1021-005（VoiceDrive暫定マスターリスト）

---

## 📋 エグゼクティブサマリー

### VoiceDriveからの分析内容
- **対象ページ**: システムモード管理ページ (`/mode-switcher`)
- **機能**: 議題モード⇄プロジェクト化モードの切り替え管理（レベル99専用）
- **VoiceDrive側の結論**: SystemConfigテーブル追加が必要

### 医療システム側の確認結果

| 項目 | 確認結果 | 詳細 |
|------|---------|------|
| **医療システム対応** | ❌ **不要** | VoiceDrive独自機能のため |
| **DB変更** | ❌ **不要** | 医療システムDBは変更不要 |
| **API提供** | ❌ **不要** | 新規API開発不要 |
| **既存API影響** | ❌ **なし** | 既存API変更不要 |
| **質問事項** | ❌ **なし** | VoiceDrive内部で完結 |

---

## 1. 機能概要の確認

### 1.1 システムモード管理ページとは

VoiceDriveが提供する最高権限者（レベル99）専用の管理ページで、システム全体の動作モードを切り替えます。

**2つのモード**:

#### 議題モード（AGENDA_MODE）
- **目的**: 委員会活性化・声を上げる文化の醸成
- **主要機能**:
  - 委員会への議題提出
  - 投票スコープ管理
  - 主承認者機能

#### プロジェクト化モード（PROJECT_MODE）
- **目的**: チーム編成・組織一体感の向上
- **主要機能**:
  - 自動チーム編成
  - プロジェクト進捗管理
  - チーム一体感醸成

### 1.2 データ管理責任の確認

VoiceDriveの分析書より：

> **データ管理責任**: VoiceDrive 100%
>
> システムモード設定はVoiceDrive独自機能であり、医療システムは関与しない。

**医療システム確認**: ✅ 正しい

システムモード設定は、VoiceDriveの内部動作を制御するものであり、**VoiceDriveが100%責任を持つべきデータ**です。

---

## 2. 医療システム側の対応必要性分析

### 2.1 DB変更の必要性

| 項目 | 必要性 | 理由 |
|------|-------|------|
| **新規テーブル追加** | ❌ **不要** | システムモードは医療システムDBに存在しない |
| **既存テーブル変更** | ❌ **不要** | 医療システムDBに関連テーブルなし |
| **schema.prisma更新** | ❌ **不要** | 医療システムの変更なし |

#### 確認結果の根拠

**医療システムDBの現状**:
- システムモード関連のテーブルは存在しない
- SystemConfig、AuditLog等のモデルは存在しない
- 議題モード・プロジェクトモード関連のモデルは存在しない

**医療システムが管理するのは**:
- 職員マスタ (Employee)
- 部署マスタ (Department)
- 施設マスタ (Facility)
- 役職マスタ (Position)
- 面談記録 (Interview)

**結論**: システムモード設定はVoiceDriveの独自機能であり、医療システム側のDB変更は**一切不要**

---

### 2.2 API提供の必要性

#### 新規API開発の必要性

| API種別 | 必要性 | 理由 |
|---------|-------|------|
| システムモード取得 | ❌ **不要** | VoiceDrive内部で完結 |
| システムモード変更 | ❌ **不要** | VoiceDrive内部で完結 |
| 移行準備統計取得 | ❌ **不要** | VoiceDrive内部で完結 |
| モード変更履歴取得 | ❌ **不要** | VoiceDrive内部で完結 |

#### 既存API変更の必要性

| 既存API | 変更必要性 | 理由 |
|---------|----------|------|
| 職員情報取得API | ❌ **不要** | 総職員数は既にキャッシュ済み |
| 部署情報取得API | ❌ **不要** | VoiceDriveで使用しない |
| 権限レベルAPI | ❌ **不要** | 権限情報は既にキャッシュ済み |

#### 確認結果の根拠

VoiceDriveは、医療システムの職員情報を既にUserテーブルにキャッシュしています：

```typescript
// VoiceDriveのUserテーブル（キャッシュ済み）
{
  id: "USER-001",
  name: "山田 太郎",
  permissionLevel: 99,
  lastLoginAt: "2025-10-20T10:00:00Z"
}
```

移行準備統計の計算に必要な以下のデータも、VoiceDrive内部で保持済みです：

1. **月間投稿数**: VoiceDrive Postテーブルから集計
2. **委員会提出数**: VoiceDrive Postテーブル（score >= 100）から集計
3. **アクティブユーザー数**: VoiceDrive Userテーブル（lastLoginAt）から集計
4. **総職員数**: VoiceDrive Userテーブルから集計

したがって、医療システムからの新規API提供は**一切不要**です。

---

### 2.3 データフロー確認

#### VoiceDrive側のデータフロー（モード切り替え）

```
レベル99ユーザー → VoiceDrive UI → VoiceDrive API → VoiceDrive DB
                                                        ↓
                                           SystemConfig テーブル
                                           - mode: AGENDA_MODE / PROJECT_MODE
                                           - enabledAt
                                           - enabledBy
                                                        ↓
                                           AuditLog テーブル
                                           - action: SYSTEM_MODE_CHANGED
                                           - details: 変更前後のモード
```

**医療システムの関与**: ❌ **一切なし**

#### VoiceDrive側のデータフロー（移行準備統計）

```
VoiceDrive UI → VoiceDrive API → VoiceDrive DB
                                  ↓
                      Post テーブル（月間投稿数、委員会提出数）
                      User テーブル（アクティブユーザー数、総職員数）
                                  ↓
                      統計計算（移行準備判定）
```

**医療システムの関与**: ❌ **一切なし**

---

## 3. VoiceDrive側の実装計画確認

### 3.1 VoiceDrive側で実装する内容

VoiceDriveの暫定マスターリスト（API-LIST-2025-1021-005）より確認：

#### Phase 1: DB・基本API実装（2.5日）

**実装内容**:
1. `SystemConfig` テーブル追加（VoiceDrive DB）
2. User Relation追加
3. AuditLog確認・修正
4. マイグレーション実行
5. GET `/api/system/mode` API実装（モード取得）
6. PUT `/api/system/mode` API実装（モード変更）

**予定工数**: 2.5日

#### Phase 2: 統計API・フロントエンド実装（3.5日）

**実装内容**:
1. GET `/api/system/mode/migration-stats` API実装（移行準備統計）
2. systemModeService修正
3. useSystemMode フック実装
4. useMigrationStats フック実装
5. ModeSwitcherPage修正

**予定工数**: 3.5日

#### Phase 3: 履歴機能（オプション、1.5日）

**実装内容**:
1. GET `/api/system/mode/history` API実装（モード変更履歴）
2. 履歴表示UI実装

**予定工数**: 1.5日

#### Phase 4: インデックス最適化・テスト（1日）

**実装内容**:
1. Postテーブルインデックス最適化
2. Userテーブルインデックス最適化
3. 統合テスト実施

**予定工数**: 1日

**総工数**: 約8日（Phase 1-2のみで6日）

**医療システム確認**: ✅ すべてVoiceDrive内部で完結しており、問題なし

---

### 3.2 テーブル設計の確認

#### SystemConfigテーブル（VoiceDrive新規追加）

**主要フィールド**:
- `configKey`: String (unique) - "system_mode"
- `configValue`: Json - `{"mode": "AGENDA_MODE", "enabledAt": "...", ...}`
- `category`: String - "system"
- `description`: String? - 設定の説明
- `updatedBy`: String - 更新者ID（VoiceDriveのUserテーブル参照）

**医療システム確認**:
- ✅ VoiceDrive DBのテーブルとして適切
- ✅ 医療システムDBとの整合性問題なし
- ✅ 更新者情報は `updatedBy`（ユーザーID）でVoiceDriveのUserテーブルを参照
- ✅ 医療システムへの外部参照なし

#### AuditLogテーブル（VoiceDrive既存）

**使用目的**: モード変更操作の監査記録

**記録内容**:
- `action`: "SYSTEM_MODE_CHANGED"
- `details`: `{"previousMode": "AGENDA_MODE", "newMode": "PROJECT_MODE", ...}`
- `severity`: "high"

**医療システム確認**:
- ✅ VoiceDrive既存テーブルの活用として適切
- ✅ 医療システムDBとの整合性問題なし

---

## 4. セキュリティ・権限の確認

### 4.1 アクセス制御

VoiceDrive側のアクセス制御設計:

| 操作 | 必要権限レベル | 備考 |
|------|--------------|------|
| モード切り替え | permissionLevel === 99 | システム管理者のみ |
| 移行準備統計閲覧 | permissionLevel === 99 | システム管理者のみ |
| 履歴閲覧 | permissionLevel === 99 | システム管理者のみ |

**医療システム確認**:
- ✅ 最高権限（レベル99）のみに限定されており、適切
- ✅ 医療システムの権限設計と干渉なし

### 4.2 モード変更の影響範囲

**議題モード → プロジェクトモード**:
- 議題提出機能が無効化
- プロジェクトチーム編成が有効化
- 既存の議題データは保持（非表示）

**プロジェクトモード → 議題モード**:
- プロジェクトチーム編成が無効化
- 議題提出機能が有効化
- 既存のプロジェクトデータは保持（非表示）

**医療システム確認**:
- ✅ VoiceDrive内部のUI/機能切り替えのみ
- ✅ 医療システムへの影響なし

---

## 5. 移行準備統計の確認

### 5.1 統計項目

VoiceDrive側で算出する統計項目:

| 項目 | 計算方法 | データソース |
|------|---------|-------------|
| **月間投稿数** | 直近1ヶ月の投稿数 | VoiceDrive Postテーブル |
| **委員会提出数** | 直近1ヶ月でスコア100点以上の投稿数 | VoiceDrive Postテーブル |
| **アクティブユーザー数** | 直近1ヶ月でログインしたユーザー数 | VoiceDrive Userテーブル |
| **総職員数** | ユーザー総数 | VoiceDrive Userテーブル |
| **参加率** | アクティブユーザー数 ÷ 総職員数 × 100 | 算出 |

**医療システム確認**:
- ✅ すべてVoiceDrive内部データで算出可能
- ✅ 医療システムからのデータ取得不要

### 5.2 移行準備の閾値

VoiceDrive側の設計:

| 項目 | 閾値 | 重要度 |
|------|------|--------|
| **月間投稿数** | 30件以上 | 40% |
| **委員会提出数** | 10件以上 | 30% |
| **参加率** | 60%以上 | 30% |

**総合進捗率** = 月間投稿数進捗 × 0.4 + 委員会提出数進捗 × 0.3 + 参加率進捗 × 0.3

**医療システム確認**:
- ✅ VoiceDrive独自の閾値設定として適切
- ✅ 医療システム側で管理する必要なし

---

## 6. 医療システム側の確認事項

### 6.1 質問事項

**確認結果**: ❌ **質問なし**

理由:
- システムモード管理はVoiceDrive独自機能
- 医療システムは一切関与しない
- VoiceDrive内部で完結するため、質問・確認事項なし

### 6.2 懸念事項

**確認結果**: ❌ **懸念なし**

理由:
- VoiceDrive側のDB設計は適切
- 医療システムとの整合性問題なし
- データ管理責任分界点に沿った設計
- 権限制御（レベル99のみ）が適切

---

## 7. まとめ

### 7.1 医療システム側の対応サマリー

| 項目 | 対応 |
|------|------|
| **DB変更** | ❌ 不要 |
| **新規API開発** | ❌ 不要 |
| **既存API変更** | ❌ 不要 |
| **schema.prisma更新** | ❌ 不要 |
| **マイグレーション** | ❌ 不要 |
| **テスト実施** | ❌ 不要 |
| **ドキュメント作成** | ✅ 本文書のみ |

**総工数**: 0日（本確認作業のみ）

### 7.2 VoiceDrive側への回答

| 質問事項 | 回答 |
|---------|------|
| **医療システムDB変更は必要か？** | ❌ 不要です |
| **医療システムAPI開発は必要か？** | ❌ 不要です |
| **医療システム側で確認・質問はあるか？** | ❌ ありません |

### 7.3 承認事項

**医療システムチームの承認**:

✅ VoiceDrive側の実装計画を**承認**します

**承認理由**:
1. ✅ データ管理責任分界点に沿った設計
2. ✅ 医療システムDBとの整合性問題なし
3. ✅ VoiceDrive内部で完結する機能
4. ✅ 移行準備統計はVoiceDriveデータのみで算出可能
5. ✅ 権限制御（レベル99のみ）が適切
6. ✅ 監査ログ（AuditLog）による変更履歴記録が適切

---

## 8. VoiceDrive側の次のステップ

### 8.1 実装フェーズ

VoiceDrive側で以下を実施：

1. ✅ DB要件分析完了
2. ✅ 暫定マスターリスト作成完了
3. ✅ **医療システム確認完了**（本文書）
4. ⏳ schema.prisma更新 - `SystemConfig`モデル追加
5. ⏳ User Relation追加
6. ⏳ マイグレーション実行
7. ⏳ Phase 1: DB・基本API実装（2.5日）
8. ⏳ Phase 2: 統計API・フロントエンド実装（3.5日）
9. ⏳ Phase 3: 履歴機能実装（オプション、1.5日）
10. ⏳ Phase 4: インデックス最適化・テスト（1日）

### 8.2 医療システム側の対応

**対応**: ❌ **なし**

理由:
- VoiceDrive独自機能のため、医療システム側の対応は一切不要
- VoiceDrive側の実装完了を待つのみ

---

## 9. 参照文書

### 9.1 VoiceDriveからの文書

| 文書番号 | タイトル | 受領日 |
|---------|---------|--------|
| API-LIST-2025-1021-005 | システムモード管理ページ 暫定マスターリスト | 2025-10-21 |

### 9.2 医療システム側の文書

| 文書番号 | タイトル | 作成日 |
|---------|---------|--------|
| MED-RES-2025-1021-006 | システムモード管理ページ 医療システム確認結果（本文書） | 2025-10-21 |

### 9.3 関連文書

| 文書番号 | タイトル | 参照箇所 |
|---------|---------|---------|
| データ管理責任分界点定義書 | データ管理責任分界点定義書_20251008.md | VoiceDrive独自機能の定義 |
| MED-RES-2025-1021-005 | 投票設定変更履歴ページ 医療システム確認結果 | 同様のVoiceDrive独自機能 |

---

## 10. 感謝とエール

VoiceDriveチームの皆様

システムモード管理ページの詳細な分析・設計、誠にありがとうございます。

特に以下の点について感謝申し上げます：

1. **明確な責任分界**: データ管理責任を明確に定義
2. **詳細なDB設計**: SystemConfigテーブル設計が具体的
3. **完全な実装計画**: Phase 1-4の段階的実装計画
4. **セキュリティ配慮**: レベル99のみの厳格なアクセス制御
5. **監査対応**: AuditLogによる変更履歴記録

医療システム側としては、VoiceDrive側の実装を**全面的に承認**します。

システムモード管理機能の実装、応援しています！

---

**医療職員管理システムチーム一同**

2025年10月21日

---

**改訂履歴**

| 版 | 日付 | 変更内容 | 作成者 |
|----|------|---------|--------|
| 1.0 | 2025-10-21 | 初版作成 | 医療システムチーム |

---

**文書終了**
