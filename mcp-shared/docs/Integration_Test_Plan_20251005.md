# VoiceDrive連携 統合テスト計画書

**文書番号**: TEST-PLAN-2025-1005-001
**作成日**: 2025年10月5日
**作成者**: 医療職員管理システム（職員カルテ）開発チーム
**テスト期間**: 2025年10月7日（月）〜10月11日（金）
**対象システム**: VoiceDrive ⇔ 職員カルテシステム 連携機能

---

## 📋 エグゼクティブサマリー

VoiceDriveデータ分析同意システムと職員カルテシステムの統合を検証するため、5日間の統合テストを実施します。

本テストでは、プライバシー保護要件（K-匿名性、匿名投稿保護、データ削除権等）の完全な遵守を最優先事項として検証します。

---

## 目次

1. [テスト概要](#1-テスト概要)
2. [テスト環境](#2-テスト環境)
3. [テストシナリオ](#3-テストシナリオ)
4. [テストデータ仕様](#4-テストデータ仕様)
5. [テストスケジュール](#5-テストスケジュール)
6. [合格基準](#6-合格基準)
7. [リスク管理](#7-リスク管理)
8. [役割分担](#8-役割分担)

---

## 1. テスト概要

### 1.1 テスト目的

| 目的 | 詳細 |
|------|------|
| **データ連携の検証** | VoiceDrive DataConsentテーブルへの職員カルテ側アクセス確認 |
| **プライバシー保護の確認** | K-匿名性、匿名投稿保護、同意管理の適切性検証 |
| **パフォーマンス確認** | 大量データでのレスポンスタイム測定 |
| **削除処理の検証** | データ削除リクエスト〜完了までのフロー確認 |
| **権限制御の確認** | 権限レベル別アクセス制御の適切性検証 |

### 1.2 テスト対象範囲

#### ✅ テスト対象（In Scope）

- VoiceDrive側: DataConsentモデル、同意取得フロー、削除リクエスト機能
- 職員カルテ側: DataConsent参照、K-匿名性チェック、削除処理バッチ
- 連携機能: データベース接続、同意状態の双方向確認
- セキュリティ: アクセス制御、RLS、監査ログ

#### ❌ テスト対象外（Out of Scope）

- VoiceDrive分析ページのUI実装（Phase 2以降）
- 個人フィードバック機能（Phase 2）
- センチメント分析・高度分析機能（Phase 3）
- 本番環境でのテスト（ステージング環境のみ）

### 1.3 成功の定義

**全6シナリオが合格基準を満たし、クリティカルな不具合がゼロであること**

---

## 2. テスト環境

### 2.1 環境構成

#### VoiceDrive側

```yaml
環境: ステージング
URL: https://staging.voicedrive.example.com
データベース: PostgreSQL 14.x
接続情報:
  Host: voicedrive-staging-db.example.com
  Port: 5432
  Database: voicedrive_staging
  Schema: voicedrive_shared
```

#### 職員カルテシステム側

```yaml
環境: ステージング
URL: https://staging.staff-medical.example.com
データベース: PostgreSQL 14.x
接続情報:
  Host: voicedrive-staging-db.example.com  # 共通DB
  Port: 5432
  Database: voicedrive_staging
  Schema: voicedrive_shared  # VoiceDriveスキーマに接続
```

### 2.2 環境構築手順

#### Step 1: VoiceDrive側準備（10/6完了予定）

```bash
# 1. ステージング環境起動
cd voicedrive
npm run staging

# 2. データベースマイグレーション確認
npx prisma migrate status

# 3. テストデータ投入
npm run seed:test-users

# 4. Prisma Studioで確認
npx prisma studio
```

#### Step 2: 職員カルテ側準備（10/6完了予定）

```bash
# 1. VoiceDrive DBへの接続設定
# .env.staging
VOICEDRIVE_DATABASE_URL="postgresql://user:pass@voicedrive-staging-db.example.com:5432/voicedrive_staging?schema=voicedrive_shared"

# 2. 接続テスト
npm run test:voicedrive-connection

# 3. K-匿名性チェック機能デプロイ
npm run deploy:staging

# 4. 削除処理バッチ確認
npm run test:deletion-batch
```

#### Step 3: 相互接続確認（10/7午前）

```sql
-- 職員カルテ側から実行
SELECT COUNT(*) FROM voicedrive_shared."DataConsent";
-- 期待結果: テストユーザー数（例: 50件）

-- VoiceDrive側から実行
SELECT userId, analyticsConsent FROM voicedrive_shared."DataConsent" LIMIT 5;
-- 期待結果: テストデータが正しく表示される
```

### 2.3 テストツール

| ツール | 用途 |
|--------|------|
| **Prisma Studio** | データベース状態の可視化・確認 |
| **Postman** | API呼び出しテスト |
| **pgAdmin** | SQL実行・パフォーマンス測定 |
| **Slack** | リアルタイム連絡 (#voicedrive-staffcard-integration) |
| **Notion/Google Sheets** | テスト結果記録 |

---

## 3. テストシナリオ

### シナリオ1: 新規ユーザーの同意取得フロー

**目的**: 初回投稿時の同意取得〜データ連携の一連の流れを確認

**前提条件**:
- テストユーザーA（user_test_001）が存在
- DataConsentレコードが存在しない状態

**テスト手順**:

| Step | 操作 | 実施者 | 期待結果 |
|------|------|--------|---------|
| 1 | VoiceDrive: user_test_001でログイン | VoiceDriveチーム | ログイン成功 |
| 2 | VoiceDrive: アイデアボイス投稿画面を開く | VoiceDriveチーム | 投稿フォーム表示 |
| 3 | VoiceDrive: 投稿内容を入力して送信 | VoiceDriveチーム | **同意モーダルが自動表示** |
| 4 | VoiceDrive: 「同意して投稿する」を選択 | VoiceDriveチーム | モーダル閉じる、投稿成功 |
| 5 | VoiceDrive DB: DataConsentテーブル確認 | 両チーム | `analyticsConsent=true, analyticsConsentDate=現在時刻` |
| 6 | 職員カルテ: DataConsent取得API実行 | 職員カルテチーム | user_test_001の同意状態が`true` |
| 7 | 職員カルテ: VoiceDrive分析で該当ユーザーを含める | 職員カルテチーム | 分析対象に含まれる |

**判定基準**:
- ✅ 同意モーダルが初回のみ表示される
- ✅ 同意状態がDBに正しく保存される
- ✅ 職員カルテ側から同意状態を取得できる
- ✅ 同意日時が正確に記録される

**テストデータ**:
```json
{
  "userId": "user_test_001",
  "userName": "テスト太郎",
  "department": "外科部門",
  "jobCategory": "医師",
  "postContent": "テスト投稿: 業務改善の提案"
}
```

---

### シナリオ2: 同意拒否後の投稿フロー

**目的**: 同意しなくても投稿が可能であることを確認

**前提条件**:
- テストユーザーB（user_test_002）が存在
- DataConsentレコードが存在しない状態

**テスト手順**:

| Step | 操作 | 実施者 | 期待結果 |
|------|------|--------|---------|
| 1 | VoiceDrive: user_test_002でログイン | VoiceDriveチーム | ログイン成功 |
| 2 | VoiceDrive: アイデアボイス投稿 | VoiceDriveチーム | 同意モーダル表示 |
| 3 | VoiceDrive: 「同意せずに投稿する」を選択 | VoiceDriveチーム | モーダル閉じる、**投稿成功** |
| 4 | VoiceDrive DB: DataConsentテーブル確認 | 両チーム | `analyticsConsent=false` |
| 5 | 職員カルテ: 同意状態確認 | 職員カルテチーム | `analyticsConsent=false` |
| 6 | 職員カルテ: VoiceDrive分析実行 | 職員カルテチーム | user_test_002は**分析対象外** |
| 7 | VoiceDrive: 同じユーザーで2回目投稿 | VoiceDriveチーム | **モーダル表示されず**投稿成功 |

**判定基準**:
- ✅ 同意拒否でも投稿が完了する
- ✅ 分析対象外としてマークされる
- ✅ 2回目以降はモーダルが表示されない
- ✅ 心理的安全性が損なわれていない

---

### シナリオ3: K-匿名性チェック機能

**目的**: 5名未満のグループで分析が拒否されることを確認

**前提条件**:
- テストユーザー10名が存在
- うち5名が同意済み（user_test_003〜007）
- うち5名が同意なし（user_test_008〜012）
- 全員が「リハビリ部門・30代・理学療法士」

**テスト手順**:

| Step | 操作 | 実施者 | 期待結果 |
|------|------|--------|---------|
| 1 | 職員カルテ: フィルタ設定（リハビリ部門・30代・理学療法士・同意あり） | 職員カルテチーム | フィルタ適用 |
| 2 | 職員カルテ: 該当ユーザー数確認 | 職員カルテチーム | 5名（user_test_003〜007） |
| 3 | 職員カルテ: K-匿名性チェック実行 | 職員カルテチーム | ✅ チェック通過（5名 >= 5名） |
| 4 | 職員カルテ: VoiceDrive分析実行 | 職員カルテチーム | 分析結果が表示される |
| 5 | 職員カルテ: フィルタ変更（30代 → 20代） | 職員カルテチーム | フィルタ適用 |
| 6 | 職員カルテ: 該当ユーザー数確認 | 職員カルテチーム | 4名 |
| 7 | 職員カルテ: K-匿名性チェック実行 | 職員カルテチーム | ❌ チェック失敗（4名 < 5名） |
| 8 | 職員カルテ: 分析実行 | 職員カルテチーム | **エラー表示**「K-匿名性要件未達」 |

**判定基準**:
- ✅ 5名以上で分析が実行される
- ✅ 5名未満で分析が拒否される
- ✅ ユーザーフレンドリーなエラーメッセージが表示される

**期待エラーメッセージ**:
```
🔒 データ保護のため表示できません

この条件では対象者が5名未満のため、プライバシー保護の観点から分析結果を表示できません。

より広い範囲（部署・職種・期間等）で再度お試しください。
```

---

### シナリオ4: 同意取り消しフロー

**目的**: 同意取り消し後、分析対象から除外されることを確認

**前提条件**:
- テストユーザーC（user_test_013）が存在
- 同意済み状態（`analyticsConsent=true`）

**テスト手順**:

| Step | 操作 | 実施者 | 期待結果 |
|------|------|--------|---------|
| 1 | 職員カルテ: user_test_013を含む分析実行 | 職員カルテチーム | 分析結果に含まれる |
| 2 | VoiceDrive: user_test_013でログイン | VoiceDriveチーム | ログイン成功 |
| 3 | VoiceDrive: 設定 > プライバシー設定を開く | VoiceDriveチーム | 同意管理セクション表示 |
| 4 | VoiceDrive: 現在の設定を確認 | VoiceDriveチーム | 「分析に同意する ✅」表示 |
| 5 | VoiceDrive: 「同意を取り消す」ボタンをクリック | VoiceDriveチーム | 確認ダイアログ表示 |
| 6 | VoiceDrive: 取り消しを確定 | VoiceDriveチーム | 「同意を取り消しました」メッセージ |
| 7 | VoiceDrive DB: DataConsentテーブル確認 | 両チーム | `analyticsConsent=false, revokeDate=現在時刻` |
| 8 | 職員カルテ: 同意状態を再取得 | 職員カルテチーム | `analyticsConsent=false` |
| 9 | 職員カルテ: 同じ条件で分析再実行 | 職員カルテチーム | user_test_013は**除外される** |

**判定基準**:
- ✅ 取り消し日時が正確に記録される
- ✅ 職員カルテ側で即座に反映される（リアルタイム性）
- ✅ 取り消し後のデータが分析対象外になる

---

### シナリオ5: データ削除リクエストフロー

**目的**: データ削除リクエスト〜完了までの一連の流れを確認

**前提条件**:
- テストユーザーD（user_test_014）が存在
- 同意済み状態、投稿データあり（5件）

**テスト手順**:

| Step | 操作 | 実施者 | 期待結果 |
|------|------|--------|---------|
| 1 | VoiceDrive: user_test_014でログイン | VoiceDriveチーム | ログイン成功 |
| 2 | VoiceDrive: 設定 > プライバシー設定を開く | VoiceDriveチーム | 同意管理セクション表示 |
| 3 | VoiceDrive: 「過去データの削除をリクエスト」クリック | VoiceDriveチーム | 確認ダイアログ表示 |
| 4 | VoiceDrive: 削除リクエスト確定 | VoiceDriveチーム | 「削除リクエストを受け付けました」 |
| 5 | VoiceDrive DB: DataConsentテーブル確認 | 両チーム | `dataDeletionRequested=true, dataDeletionRequestedAt=現在時刻` |
| 6 | 職員カルテ: 削除リクエスト一覧取得 | 職員カルテチーム | user_test_014のリクエストが表示 |
| 7 | 職員カルテ: 削除処理バッチ手動実行 | 職員カルテチーム | バッチ処理開始 |
| 8 | 職員カルテ: VoiceDriveデータを論理削除 | 職員カルテチーム | 投稿5件が`is_deleted=true` |
| 9 | 職員カルテ: VoiceDrive削除完了API呼び出し | 職員カルテチーム | API呼び出し成功 |
| 10 | VoiceDrive: 削除完了API受信 | VoiceDriveチーム | `dataDeletionCompletedAt=現在時刻` |
| 11 | VoiceDrive: ユーザーへ通知 | VoiceDriveチーム | 「データ削除が完了しました」通知 |
| 12 | 職員カルテ: 分析実行 | 職員カルテチーム | user_test_014のデータは含まれない |

**判定基準**:
- ✅ 削除リクエストが正しく記録される
- ✅ 職員カルテ側で削除処理が実行される
- ✅ VoiceDrive側に削除完了が通知される
- ✅ 削除後のデータが分析対象外になる
- ✅ 法令上の保存義務があるデータは保持される

**削除完了API仕様（VoiceDrive側実装必須）**:
```typescript
POST /api/consent/deletion-completed
Content-Type: application/json

{
  "userId": "user_test_014",
  "deletedAt": "2025-10-09T14:30:00Z",
  "deletedItemCount": 5
}

Response:
{
  "success": true,
  "message": "削除完了を記録しました"
}
```

---

### シナリオ6: パフォーマンステスト

**目的**: 大量ユーザーでのレスポンスタイム測定

**前提条件**:
- テストユーザー1,000名が存在
- 全員が同意済み状態

**テスト手順**:

| Step | 操作 | 実施者 | 期待結果 |
|------|------|--------|---------|
| 1 | 職員カルテ: 全施設・全部署で同意状態一括取得 | 職員カルテチーム | クエリ実行 |
| 2 | 測定: レスポンスタイム記録 | 職員カルテチーム | **< 2秒** |
| 3 | 職員カルテ: 特定部署（100名）で分析実行 | 職員カルテチーム | クエリ実行 |
| 4 | 測定: レスポンスタイム記録 | 職員カルテチーム | **< 3秒** |
| 5 | pgAdmin: EXPLAIN ANALYZE実行 | 両チーム | インデックスが効いているか確認 |
| 6 | 測定: 同時アクセス10ユーザー | 職員カルテチーム | レスポンス劣化なし |

**判定基準**:
- ✅ 1,000名の同意状態取得が2秒以内
- ✅ 100名の分析実行が3秒以内
- ✅ インデックスが適切に機能している
- ✅ 同時アクセスでパフォーマンス劣化なし

**計測SQL**:
```sql
-- パフォーマンステスト用クエリ
EXPLAIN ANALYZE
SELECT
  dc.userId,
  dc.analyticsConsent,
  dc.analyticsConsentDate
FROM voicedrive_shared."DataConsent" dc
WHERE dc.analyticsConsent = true
  AND dc.revokeDate IS NULL
  AND dc.dataDeletionRequested = false;
```

**期待実行計画**:
```
Index Scan using DataConsent_analyticsConsent_idx
  (actual time=0.015..1.234 rows=1000 loops=1)
Planning Time: 0.123 ms
Execution Time: 1.456 ms  ← 2秒以内であること
```

---

## 4. テストデータ仕様

### 4.1 テストユーザー構成

| ユーザーID | 氏名 | 部署 | 職種 | 年代 | 同意状態 | 投稿数 | 用途 |
|-----------|------|------|------|------|---------|--------|------|
| user_test_001 | テスト太郎 | 外科部門 | 医師 | 40代 | - | 0 | シナリオ1 |
| user_test_002 | テスト花子 | 内科部門 | 看護師 | 30代 | - | 0 | シナリオ2 |
| user_test_003-007 | テスト1-5 | リハビリ | 理学療法士 | 30代 | 同意 | 各3件 | シナリオ3 |
| user_test_008-012 | テスト6-10 | リハビリ | 理学療法士 | 30代 | 拒否 | 各2件 | シナリオ3 |
| user_test_013 | テスト次郎 | 外科部門 | 医師 | 50代 | 同意 | 10件 | シナリオ4 |
| user_test_014 | テスト桃子 | 看護部門 | 看護師 | 20代 | 同意 | 5件 | シナリオ5 |
| user_test_015-1014 | 大量ユーザー | 各部署 | 各職種 | 各年代 | 同意 | 各5件 | シナリオ6 |

### 4.2 投稿データサンプル

```json
{
  "posts": [
    {
      "postId": "post_001",
      "userId": "user_test_003",
      "content": "手術室の動線改善を提案します",
      "category": "業務改善",
      "anonymousFlag": false,
      "createdAt": "2025-09-15T10:00:00Z"
    },
    {
      "postId": "post_002",
      "userId": "user_test_004",
      "content": "夜勤手当の見直しを希望します",
      "category": "福利厚生",
      "anonymousFlag": true,
      "createdAt": "2025-09-20T14:30:00Z"
    }
  ]
}
```

### 4.3 テストデータ投入スクリプト

**VoiceDrive側**:
```typescript
// seed/test-users.ts
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

async function seedTestUsers() {
  // シナリオ1-2用ユーザー
  await prisma.user.createMany({
    data: [
      { id: 'user_test_001', name: 'テスト太郎', department: '外科部門', jobCategory: '医師' },
      { id: 'user_test_002', name: 'テスト花子', department: '内科部門', jobCategory: '看護師' }
    ]
  });

  // シナリオ3用ユーザー（10名）
  for (let i = 3; i <= 12; i++) {
    await prisma.user.create({
      data: {
        id: `user_test_${String(i).padStart(3, '0')}`,
        name: `テスト${i-2}`,
        department: 'リハビリ部門',
        jobCategory: '理学療法士',
        ageGroup: '30代'
      }
    });

    // 同意状態の設定（003-007は同意、008-012は拒否）
    if (i <= 7) {
      await prisma.dataConsent.create({
        data: {
          userId: `user_test_${String(i).padStart(3, '0')}`,
          analyticsConsent: true,
          analyticsConsentDate: new Date()
        }
      });
    } else {
      await prisma.dataConsent.create({
        data: {
          userId: `user_test_${String(i).padStart(3, '0')}`,
          analyticsConsent: false
        }
      });
    }
  }

  // シナリオ4-5用ユーザー
  // ... 省略

  console.log('✅ テストデータ投入完了');
}

seedTestUsers();
```

**実行コマンド**:
```bash
npm run seed:test-users
```

---

## 5. テストスケジュール

### 5.1 5日間の詳細スケジュール

#### Day 1: 10/7（月）環境構築・接続確認

| 時間 | 内容 | 担当 | 成果物 |
|------|------|------|--------|
| **09:00-10:00** | キックオフミーティング（オンライン） | 両チーム全員 | 役割分担確定 |
| **10:00-12:00** | 環境構築 | 両チーム技術者 | テスト環境稼働 |
| | - VoiceDrive: ステージング環境起動 | VoiceDriveチーム | |
| | - 職員カルテ: VoiceDrive DB接続設定 | 職員カルテチーム | |
| **13:00-15:00** | 接続確認 | 両チーム技術者 | 接続成功確認 |
| | - DataConsentテーブルへのアクセステスト | 職員カルテチーム | |
| | - テストデータ投入 | VoiceDriveチーム | |
| **15:00-17:00** | 動作確認・問題対応 | 両チーム技術者 | 環境構築完了報告 |
| **17:00-17:30** | Day 1振り返りミーティング | 両チーム全員 | 翌日スケジュール確定 |

#### Day 2: 10/8（火）シナリオ1-2テスト

| 時間 | 内容 | 担当 | 成果物 |
|------|------|------|--------|
| **09:00-09:15** | 朝会（進捗確認） | 両チーム全員 | 本日のゴール確認 |
| **09:15-11:00** | シナリオ1実行 | 両チーム技術者 | テスト結果記録 |
| | - 新規ユーザーの同意取得フロー | | |
| **11:00-12:00** | シナリオ1結果レビュー | 両チーム全員 | 合否判定 |
| **13:00-15:00** | シナリオ2実行 | 両チーム技術者 | テスト結果記録 |
| | - 同意拒否後の投稿フロー | | |
| **15:00-16:00** | シナリオ2結果レビュー | 両チーム全員 | 合否判定 |
| **16:00-17:00** | 不具合対応（あれば） | 両チーム技術者 | 修正完了 |
| **17:00-17:30** | Day 2振り返りミーティング | 両チーム全員 | 翌日スケジュール確定 |

#### Day 3: 10/9（水）シナリオ3-4テスト

| 時間 | 内容 | 担当 | 成果物 |
|------|------|------|--------|
| **09:00-09:15** | 朝会（進捗確認） | 両チーム全員 | 本日のゴール確認 |
| **09:15-11:30** | シナリオ3実行 | 両チーム技術者 | テスト結果記録 |
| | - K-匿名性チェック機能 | 職員カルテチーム主導 | |
| **11:30-12:00** | シナリオ3結果レビュー | 両チーム全員 | 合否判定 |
| **13:00-15:30** | シナリオ4実行 | 両チーム技術者 | テスト結果記録 |
| | - 同意取り消しフロー | VoiceDriveチーム主導 | |
| **15:30-16:00** | シナリオ4結果レビュー | 両チーム全員 | 合否判定 |
| **16:00-17:00** | 不具合対応（あれば） | 両チーム技術者 | 修正完了 |
| **17:00-17:30** | Day 3振り返りミーティング | 両チーム全員 | 翌日スケジュール確定 |

#### Day 4: 10/10（木）シナリオ5-6テスト・不具合修正

| 時間 | 内容 | 担当 | 成果物 |
|------|------|------|--------|
| **09:00-09:15** | 朝会（進捗確認） | 両チーム全員 | 本日のゴール確認 |
| **09:15-11:30** | シナリオ5実行 | 両チーム技術者 | テスト結果記録 |
| | - データ削除リクエストフロー | 職員カルテチーム主導 | |
| **11:30-12:00** | シナリオ5結果レビュー | 両チーム全員 | 合否判定 |
| **13:00-14:30** | シナリオ6実行 | 職員カルテチーム | テスト結果記録 |
| | - パフォーマンステスト | | |
| **14:30-15:00** | シナリオ6結果レビュー | 両チーム全員 | 合否判定 |
| **15:00-17:00** | 不具合の集中対応 | 両チーム技術者 | 全不具合修正完了 |
| **17:00-17:30** | Day 4振り返りミーティング | 両チーム全員 | 最終日の準備確認 |

#### Day 5: 10/11（金）再テスト・最終確認・報告書作成

| 時間 | 内容 | 担当 | 成果物 |
|------|------|------|--------|
| **09:00-09:15** | 朝会（進捗確認） | 両チーム全員 | 本日のゴール確認 |
| **09:15-11:00** | 修正箇所の再テスト | 両チーム技術者 | 再テスト結果記録 |
| **11:00-12:00** | 全シナリオの最終確認 | 両チーム全員 | 最終合否判定 |
| **13:00-15:00** | 統合テスト報告書作成 | 両チームリード | 報告書ドラフト |
| **15:00-16:00** | 報告書レビュー・修正 | 両チーム全員 | 報告書最終版 |
| **16:00-17:00** | クロージングミーティング | 両チーム全員 | 今後のアクション確定 |
| **17:00-17:30** | 打ち上げ・振り返り | 両チーム全員 | プロジェクト完了 |

### 5.2 マイルストーン

| マイルストーン | 期限 | 完了条件 |
|--------------|------|---------|
| **テスト環境構築完了** | 10/7 17:00 | 両システムが相互接続できる |
| **シナリオ1-2完了** | 10/8 17:00 | 同意取得フローが正常動作 |
| **シナリオ3-4完了** | 10/9 17:00 | K-匿名性・取り消しが正常動作 |
| **シナリオ5-6完了** | 10/10 15:00 | 削除処理・パフォーマンスが合格 |
| **全不具合修正完了** | 10/10 17:00 | クリティカルな不具合ゼロ |
| **報告書作成完了** | 10/11 16:00 | 報告書最終版が承認される |
| **統合テスト完了** | 10/11 17:00 | 全シナリオ合格 |

---

## 6. 合格基準

### 6.1 シナリオ別合格基準

| シナリオ | 必須条件（1つでも×なら不合格） | 推奨条件（×でも条件付き合格） |
|---------|----------------------------|--------------------------|
| **シナリオ1** | ・同意モーダル表示<br>・同意状態がDB保存<br>・職員カルテ側で取得可能 | ・UI/UXの改善提案 |
| **シナリオ2** | ・同意拒否でも投稿可能<br>・分析対象外にマーク<br>・2回目以降モーダル非表示 | ・エラーハンドリング強化 |
| **シナリオ3** | ・5名以上で分析実行<br>・5名未満で分析拒否<br>・適切なエラーメッセージ | ・パフォーマンス改善 |
| **シナリオ4** | ・取り消し日時記録<br>・職員カルテ側で即座に反映<br>・分析対象から除外 | ・UI改善 |
| **シナリオ5** | ・削除リクエスト記録<br>・職員カルテ側で削除実行<br>・VoiceDrive側に通知<br>・削除完了日時記録 | ・削除処理の高速化 |
| **シナリオ6** | ・1,000名取得 < 2秒<br>・100名分析 < 3秒<br>・インデックス効果確認 | ・同時アクセス対応強化 |

### 6.2 不具合の重要度分類

| 重要度 | 定義 | 対応方針 |
|--------|------|---------|
| **Critical** | システム停止、データ損失、セキュリティ侵害 | **即座に修正（必須）** |
| **High** | 主要機能が使用不可、プライバシー侵害のリスク | **テスト期間中に修正（必須）** |
| **Medium** | 一部機能の不具合、回避策あり | **本番リリース前に修正** |
| **Low** | UI/UXの軽微な問題、パフォーマンス軽微な劣化 | **将来的に改善** |

### 6.3 最終合否判定

**合格条件**:
```
✅ 全6シナリオの必須条件をすべて満たす
✅ Critical/High不具合がゼロ
✅ Medium不具合が3件以下
✅ 両チームリードが承認
```

**不合格条件**:
```
❌ 1つでもシナリオの必須条件を満たさない
❌ Critical/High不具合が1件でも残存
❌ プライバシー保護要件の違反
```

---

## 7. リスク管理

### 7.1 想定リスクと対策

| リスク | 発生確率 | 影響度 | 予防策 | 発生時対応 |
|--------|---------|--------|--------|-----------|
| **DB接続エラー** | 中 | 高 | 事前接続テスト、冗長設定 | 即座にDB管理者へエスカレーション |
| **K-匿名性チェック漏れ** | 低 | 極高 | 全クエリで強制チェック | 即座にテスト中断、修正後再開 |
| **削除処理の失敗** | 中 | 高 | 削除前バックアップ、ロールバック準備 | バックアップから復旧、原因調査 |
| **パフォーマンス劣化** | 中 | 中 | インデックス最適化、キャッシュ | チューニング、必要に応じてスケールアップ |
| **テストデータ不足** | 低 | 中 | 事前にデータ投入スクリプト準備 | 追加スクリプト実行 |
| **環境構築の遅延** | 中 | 中 | 10/6までに環境準備完了 | スケジュール調整、優先順位変更 |
| **コミュニケーション不全** | 低 | 中 | Slack常時接続、定期ミーティング | エスカレーションフロー発動 |

### 7.2 緊急時対応フロー

```
問題発生
  ↓
【Step 1】Slackで即時報告（5分以内）
  - チャンネル: #voicedrive-staffcard-integration
  - 報告内容: 問題の概要、影響範囲、再現手順
  ↓
【Step 2】両チーム技術者で対応（30分以内）
  - 原因調査
  - 暫定対応の実施
  ↓
【Step 3】30分以内に解決しない場合
  - 両チームリードへエスカレーション
  - 対策会議を緊急招集
  ↓
【Step 4】1時間以内に解決しない場合
  - テスト一時中断
  - スケジュール再調整
  - 必要に応じて追加リソース投入
```

### 7.3 エスカレーション連絡先

| 役割 | 担当者 | 連絡方法 | 対応時間 |
|------|--------|---------|---------|
| **VoiceDrive技術リード** | [担当者名] | Slack DM / 携帯 | 9:00-19:00 |
| **職員カルテ技術リード** | [担当者名] | Slack DM / 携帯 | 9:00-19:00 |
| **VoiceDriveリード** | [担当者名] | Slack DM / 携帯 | 9:00-18:00 |
| **職員カルテリード** | [担当者名] | Slack DM / 携帯 | 9:00-18:00 |
| **DB管理者** | [担当者名] | Slack DM / 携帯 | 24時間対応可 |

---

## 8. 役割分担

### 8.1 VoiceDriveチームの役割

| 役割 | 担当者 | 責任範囲 |
|------|--------|---------|
| **テストリード** | [担当者名] | VoiceDrive側の全体統括 |
| **環境構築担当** | [担当者名] | ステージング環境準備、テストデータ投入 |
| **同意フロー担当** | [担当者名] | シナリオ1-2-4の実行 |
| **削除処理担当** | [担当者名] | シナリオ5の実行、削除完了API実装 |
| **データ確認担当** | [担当者名] | DataConsentテーブルの状態確認 |

### 8.2 職員カルテチームの役割

| 役割 | 担当者 | 責任範囲 |
|------|--------|---------|
| **テストリード** | [担当者名] | 職員カルテ側の全体統括 |
| **環境構築担当** | [担当者名] | VoiceDrive DB接続設定 |
| **K-匿名性担当** | [担当者名] | シナリオ3の実行、K-匿名性チェック実装 |
| **削除処理担当** | [担当者名] | シナリオ5の実行、削除バッチ実装 |
| **パフォーマンス担当** | [担当者名] | シナリオ6の実行、SQL最適化 |

### 8.3 共通役割

| 役割 | 担当者 | 責任範囲 |
|------|--------|---------|
| **プロジェクトマネージャー** | 両チームリード | 全体進捗管理、意思決定 |
| **記録係** | [担当者名] | テスト結果の記録、報告書作成 |
| **Slack管理者** | [担当者名] | チャンネル管理、情報共有促進 |

---

## 9. テスト結果記録

### 9.1 テスト結果記録シート

**記録ツール**: Google Sheets または Notion

**記録項目**:
```
【基本情報】
- シナリオ番号
- テスト日時
- 実施者
- 環境（ステージング/本番）

【実行結果】
- 実行ステップ番号
- 期待結果
- 実際の結果
- 合否（Pass/Fail）
- スクリーンショット（必要に応じて）

【不具合情報（Failの場合）】
- 不具合ID
- 重要度（Critical/High/Medium/Low）
- 不具合内容
- 再現手順
- 影響範囲
- 原因（判明している場合）
- 対応方針
- 対応者
- 対応期限
```

### 9.2 報告書フォーマット

**統合テスト完了報告書**（10/11作成）

```markdown
# VoiceDrive連携 統合テスト完了報告書

## 1. テスト概要
- テスト期間: 2025/10/7 - 10/11
- 参加者: [両チームメンバー名]
- 実施シナリオ数: 6

## 2. テスト結果サマリー
- 合格シナリオ: X/6
- 不合格シナリオ: Y/6
- 検出不具合数: Z件
  - Critical: A件
  - High: B件
  - Medium: C件
  - Low: D件

## 3. シナリオ別結果
[各シナリオの詳細結果]

## 4. 検出不具合一覧
[不具合の詳細]

## 5. 総合評価
- 合否判定: 合格 / 不合格
- 次のステップ: [具体的なアクション]

## 6. 所見・提言
[両チームからのコメント]
```

---

## 10. 次のステップ

### 10.1 統合テスト完了後のアクション

**合格の場合**:
```
1. 統合テスト完了報告書を両チーム経営層に提出
2. 本番リリース計画の策定
3. ユーザートレーニング資料の作成
4. 本番環境へのデプロイ準備
```

**不合格の場合**:
```
1. 不具合修正計画の策定
2. 再テストスケジュールの調整
3. 必要に応じて追加リソースの投入
4. リリーススケジュールの見直し
```

### 10.2 本番リリース計画（仮）

| フェーズ | 期間 | 内容 |
|---------|------|------|
| **Phase 1** | 10/14-10/18 | 不具合修正・最終調整 |
| **Phase 2** | 10/21-10/25 | 本番環境デプロイ・検証 |
| **Phase 3** | 10/28-11/1 | パイロット運用（1施設のみ） |
| **Phase 4** | 11/4-11/8 | フィードバック反映 |
| **Phase 5** | 11/11以降 | 全施設ロールアウト |

---

## 11. 添付資料

1. **テストデータ投入スクリプト** (`seed/test-users.ts`)
2. **環境構築手順書** (`docs/environment-setup.md`)
3. **削除完了API仕様書** (`docs/deletion-api-spec.md`)
4. **テスト結果記録シート** (Google Sheets)
5. **不具合管理表** (Notion)

---

## 12. 承認

### 承認者

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| **VoiceDriveチームリード** | [氏名] | 2025/10/  | |
| **職員カルテチームリード** | [氏名] | 2025/10/  | |
| **プロジェクトマネージャー** | [氏名] | 2025/10/  | |

---

**文書管理情報**
- **作成日**: 2025年10月5日
- **バージョン**: 1.0
- **作成者**: 医療職員管理システム（職員カルテ）開発チーム
- **次回更新**: テスト開始時（10/7）、テスト完了時（10/11）

---

**変更履歴**

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025/10/5 | 1.0 | 初版作成 | 職員カルテチーム |
| 2025/10/7 | 1.1 | テスト開始時更新予定 | |
| 2025/10/11 | 2.0 | テスト完了版作成予定 | |
